<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>תיקונים נדרשים - ירון כיוף - שמאות וייעוץ</title>
   <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <style>
    body {
      font-family: sans-serif;
      background: #f3f6fb;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 30px;
    }
    .container {
      max-width: 500px;
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      width: 100%;
      text-align: center;
      position: relative;
    }
    .logo img {
      width: 120px;
      opacity: 0.9;
      margin-bottom: 15px;
    }
    .title { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
    .subtitle { font-size: 18px; color: #666; margin-bottom: 20px; }
    h2 { font-size: 20px; color: #007bff; margin-bottom: 15px; }
    textarea {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      margin-bottom: 10px;
      resize: vertical;
      font-family: sans-serif;
    }
  button {
    margin-top: 15px;
    width: 100%;
    padding: 12px;
    font-size: 16px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }

  .btn-vehiclePopup {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    text-align: right;
    margin-bottom: 10px;
  }
    .btn-secondary {
      background-color: #6c757d;
      margin-top: 10px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .top-bar button {
      width: 48%;
      background-color: #6c757d;
    }
    .logout-btn {
      background-color: #dc3545 !important;
    }
    .footer { margin-top: 30px; font-size: 12px; color: #999; }
    
    #vehiclePopup {
      background: #f1f1f1;
      padding: 10px;
      border-radius: 10px;
      margin: 10px 0;
      display: none;
      font-size: 14px;
      text-align: right;
    }
    
    /* Mobile CSS Optimizations */
    @media (max-width: 768px) {
      body {
        padding: 15px;
        font-size: 16px; /* Prevent zoom on iOS */
      }
      
      .container {
        max-width: 100%;
        padding: 20px 15px;
        margin: 0;
        border-radius: 10px;
      }
      
      .title {
        font-size: 20px;
        margin-bottom: 8px;
      }
      
      .subtitle {
        font-size: 16px;
        margin-bottom: 15px;
      }
      
      h2 {
        font-size: 18px;
        margin-bottom: 15px;
        line-height: 1.3;
      }
      
      .logo img {
        width: 100px;
        margin-bottom: 10px;
      }
      
      /* Mobile-optimized repair rows */
      .repair-row {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        border: 1px solid #e9ecef;
      }
      
      .repair-name,
      .repair-cost,
      .repair-desc {
        width: 100% !important;
        padding: 15px !important;
        font-size: 16px !important;
        border-radius: 8px !important;
        border: 2px solid #ddd !important;
        background-color: #fff !important;
        box-sizing: border-box !important;
        margin-bottom: 10px !important;
        margin-left: 0 !important;
      }
      
      .repair-name:focus,
      .repair-cost:focus,
      .repair-desc:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
      }
      
      /* Textarea specific styling */
      .repair-desc {
        min-height: 100px !important;
        resize: vertical !important;
        font-family: inherit !important;
      }
      
      /* Larger touch targets for mobile */
      button {
        width: 100%;
        padding: 15px 20px;
        font-size: 16px;
        margin-top: 15px;
        border-radius: 10px;
        min-height: 50px;
        touch-action: manipulation;
        box-sizing: border-box;
      }
      
      .btn-secondary {
        background: #28a745;
        color: white;
        border: none;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .btn-secondary:active {
        transform: translateY(1px);
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      }
      
      /* Mobile form styling */
      form {
        margin-top: 20px;
      }
      
      #fixesList {
        margin-bottom: 20px;
      }
      
      /* Better spacing on mobile */
      .container > * {
        margin-bottom: 15px;
      }
      
      /* Footer mobile styling */
      .footer {
        font-size: 11px;
        margin-top: 25px;
        text-align: center;
      }
      
      /* Alert text mobile styling */
      .container > div[style*="color: red"] {
        font-size: 14px;
        line-height: 1.4;
        padding: 10px;
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      
      .container {
        padding: 15px 10px;
      }
      
      .title {
        font-size: 18px;
      }
      
      .subtitle {
        font-size: 14px;
      }
      
      h2 {
        font-size: 16px;
      }
      
      .logo img {
        width: 80px;
      }
      
      .repair-row {
        padding: 12px;
        gap: 12px;
      }
      
      .repair-name,
      .repair-cost,
      .repair-desc {
        padding: 12px !important;
        font-size: 16px !important;
      }
      
      .repair-desc {
        min-height: 80px !important;
      }
      
      button {
        padding: 12px 16px;
        font-size: 15px;
        min-height: 45px;
      }
    }
 </style>
</head>
<body>
  <div class="container">
    <div class="logo"><img src="https://carmelcayouf.com/wp-content/uploads/2025/04/logo-yaron.webp" alt="Logo"/></div>
    <div class="title">ירון כיוף - שמאות וייעוץ</div>
    <div class="subtitle">שמאי רכב והערכת נזקי רכוש</div>
    <h2 id="pageTitle">רכב מס. ...: תיקונים נדרשים</h2>
    <div style="color: red; font-weight: bold; margin-bottom: 15px;">
 לזמן שמאי לאחר פירוקים ולפני צבע
 
  <!-- Removed navigation buttons when in wizard -->

    <form id="fixesForm">
      <div id="fixesList">
        <div class="repair-row">
          <input type="text" class="repair-name" placeholder="שם התיקון" required style="width: 45%; margin-bottom: 10px; margin-left: 10px;">
          <input type="number" class="repair-cost" placeholder="עלות (₪)" min="0" step="0.01" style="width: 45%; margin-bottom: 10px;">
          <textarea class="repair-desc" placeholder="תיאור מפורט של התיקון" required style="width: 100%; margin-bottom: 15px;"></textarea>
        </div>
      </div>

      <button type="button" class="btn-secondary" onclick="addRepairRow()">הוסף תיקון</button>
    </form>

    <div class="footer">@2025 Carmel Cayouf. All rights reserved. SmartVal Pro System by Eval ©</div>
  </div>

  <script>
    // Get data from helper instead of legacy storage  
    let globalHelper = {};
    try { globalHelper = JSON.parse(sessionStorage.getItem("helper") || '{}'); } catch(e){}
    const plate = globalHelper.meta?.plate || globalHelper.vehicle?.plate || '';
    const owner = globalHelper.stakeholders?.owner?.name || '';
    const date = globalHelper.case_info?.inspection_date || globalHelper.meta?.date || '';

    if (!plate || !owner || !date) {
      alert("שגיאה: חסר מידע קריטי. חזרה לעמוד הראשי.");
      window.location.href = "index.html";
    }

    document.getElementById("pageTitle").innerText = `רכב מס. ${plate}: תיקונים נדרשים`;

    function logout() {
      sessionStorage.clear();
      window.location.href = "index.html";
    }

    function addRepairRow() {
      const div = document.createElement("div");
      div.className = "repair-row";
      div.innerHTML = `
        <input type="text" class="repair-name" placeholder="שם התיקון" required style="width: 45%; margin-bottom: 10px; margin-left: 10px;">
        <input type="number" class="repair-cost" placeholder="עלות (₪)" min="0" step="0.01" style="width: 45%; margin-bottom: 10px;">
        <textarea class="repair-desc" placeholder="תיאור מפורט של התיקון" required style="width: 100%; margin-bottom: 15px;"></textarea>
      `;
      document.getElementById("fixesList").appendChild(div);
    }

    // Save repairs data to helper without navigation
    function saveRepairsData() {
      const repairs = [];

      document.querySelectorAll("#fixesList .repair-row").forEach(row => {
        const name = row.querySelector(".repair-name").value.trim();
        const cost = parseFloat(row.querySelector(".repair-cost").value) || 0;
        const desc = row.querySelector(".repair-desc").value.trim();
        
        if (name && desc) {
          repairs.push({ 
            name: name, 
            cost: cost,
            description: desc 
          });
        }
      });

      console.log('💾 Saving repairs data to helper...');
      
      // Send data to parent wizard if in iframe
      if (window.parent !== window) {
        const repairsData = {
          type: 'moduleData',
          module: 'repairs',
          data: {
            repairs: repairs
          }
        };
        window.parent.postMessage(repairsData, '*');
        console.log('📤 Repairs data sent to parent wizard:', repairsData);
      }
      
      try {
        // Get current helper data
        let helper = {};
        try {
          helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        } catch (e) {
          console.warn('Failed to parse helper from sessionStorage, using empty object');
          helper = {};
        }
        
        // ARCHITECTURAL FIX: Only save repairs data if there's an active damage center
        // This prevents orphaned data accumulation in damage_assessment
        
        const activeCenterId = helper.damage_assessment?.current_center_id || 
                              helper.damage_centers?.current_center_id ||
                              sessionStorage.getItem('active_damage_center_id');
                              
        if (!activeCenterId) {
          console.log('⚠️ No active damage center - repairs data will not be saved to prevent orphaned data');
          console.log('📝 Repairs items:', repairs);
          
          // Store in temporary session storage for potential recovery
          sessionStorage.setItem('pending_repairs_data', JSON.stringify({
            repairs: repairs,
            timestamp: new Date().toISOString(),
            source: 'repairs_required_module'
          }));
          
          alert('⚠️ לא ניתן לשמור נתוני תיקונים ללא מוקד נזק פעיל. אנא צור/ערוך מוקד נזק תחילה.');
          return;
        }
        
        console.log('✅ Active damage center detected:', activeCenterId);
        console.log('💾 Saving repairs data to active damage center instead of global assessment');
        
        // Save repairs data to specific damage center, not global assessment
        helper.damage_assessment = helper.damage_assessment || {};
        helper.damage_assessment.centers = helper.damage_assessment.centers || [];
        
        // Find the active center
        let activeCenter = helper.damage_assessment.centers.find(center => 
          center.id === activeCenterId || center.current_center_id === activeCenterId
        );
        
        if (!activeCenter) {
          console.log('❌ Active center not found in centers array, repairs data not saved');
          alert('שגיאה: לא נמצא מוקד נזק פעיל');
          return;
        }
        
        // Save repairs items directly to the active damage center
        activeCenter.repairs_items = activeCenter.repairs_items || [];
        
        // Replace all repairs items in this center with current data
        activeCenter.repairs_items = repairs.map(repair => ({
          ...repair,
          center_id: activeCenterId,
          updated_at: new Date().toISOString(),
          source: 'repairs_required_module'
        }));
        
        activeCenter.repairs_updated_at = new Date().toISOString();
        
        console.log(`✅ Saved ${repairs.length} repairs items to damage center ${activeCenterId}`);
        
        // DO NOT save to global damage_assessment - this prevents orphaned data
        
        // Update meta information
        helper.meta = helper.meta || {};
        helper.meta.last_updated = new Date().toISOString();
        
        // Save to session storage
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        console.log('✅ Repairs data saved to helper:', helper.damage_assessment.repairs);
        
        // Show save confirmation
        const saveBtn = document.querySelector('.save-btn');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = '✅ נשמר';
        saveBtn.style.background = '#155724';
        
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.style.background = '#28a745';
        }, 2000);
        
        // Trigger helper update broadcast if available
        if (typeof window.broadcastHelperUpdate === 'function') {
          window.broadcastHelperUpdate(['damage_assessment'], 'repairs_required_module');
        }
        
      } catch (error) {
        console.error('❌ Failed to save repairs data to helper:', error);
        
        // Enhanced error feedback
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
          background: #fee2e2;
          border: 2px solid #ef4444;
          color: #dc2626;
          padding: 12px;
          border-radius: 8px;
          margin: 10px 0;
          font-weight: bold;
          text-align: center;
        `;
        errorDiv.textContent = '❌ שגיאה בשמירת הנתונים. אנא בדוק את הנתונים ונסה שוב.';
        
        const container = document.querySelector('.container');
        container.insertBefore(errorDiv, container.querySelector('.footer'));
        
        // Auto-remove error message after 5 seconds
        setTimeout(() => errorDiv.remove(), 5000);
      }
    }

    // Auto-send data to parent wizard when repairs change (for wizard mode)
    function autoSendRepairsData() {
      if (window.parent !== window) {
        const repairs = [];

        document.querySelectorAll("#fixesList .repair-row").forEach(row => {
          const name = row.querySelector(".repair-name").value.trim();
          const cost = parseFloat(row.querySelector(".repair-cost").value) || 0;
          const desc = row.querySelector(".repair-desc").value.trim();
          
          if (name && desc) {
            repairs.push({ 
              name: name, 
              cost: cost,
              description: desc 
            });
          }
        });

        const repairsData = {
          type: 'moduleData',
          module: 'repairs',
          data: {
            repairs: repairs
          }
        };
        window.parent.postMessage(repairsData, '*');
        console.log('📤 Repairs data auto-sent to parent wizard:', repairsData);
      }
    }

    // Auto-send when repairs data changes
    document.addEventListener('change', autoSendRepairsData);
    document.addEventListener('input', autoSendRepairsData);
    
    // Calculate and display totals
    function calculateRepairsTotals() {
      const repairs = [];
      
      document.querySelectorAll("#fixesList .repair-row").forEach(row => {
        const nameInput = row.querySelector('.repair-name');
        const costInput = row.querySelector('.repair-cost');
        const descInput = row.querySelector('.repair-desc');
        
        const name = nameInput ? nameInput.value.trim() : '';
        const cost = costInput ? parseFloat(costInput.value) || 0 : 0;
        const description = descInput ? descInput.value.trim() : '';
        
        if (name && description && cost > 0) {
          repairs.push({ 
            name: name, 
            cost: cost,
            description: description
          });
        }
      });
      
      const total = repairs.reduce((sum, repair) => sum + repair.cost, 0);
      
      // Display total in the page
      let totalDisplay = document.getElementById('repairsTotal');
      if (!totalDisplay) {
        totalDisplay = document.createElement('div');
        totalDisplay.id = 'repairsTotal';
        totalDisplay.style.cssText = 'background: #fff3e0; padding: 15px; margin: 20px 0; border-radius: 8px; font-weight: bold; text-align: center; border: 2px solid #ff9800;';
        document.querySelector('.container').insertBefore(totalDisplay, document.querySelector('.footer'));
      }
      
      // ✅ FIXED: Use proper VAT calculation instead of hardcoded 1.17
      const vatPercentage = 17; // Default VAT percentage  
      const vatMultiplier = 1 + (vatPercentage / 100);
      
      // SESSION 41: Round totals to whole numbers (no decimals)
      const roundedTotal = Math.round(total);
      const roundedTotalWithVat = Math.round(total * vatMultiplier);
      
      totalDisplay.innerHTML = `
        <div style="font-size: 18px; color: #e65100; margin-bottom: 5px;">סיכום תיקונים</div>
        <div style="font-size: 24px; color: #bf360c;">₪${roundedTotal.toLocaleString()}</div>
        <div style="font-size: 14px; color: #424242;">כולל מע"מ (${vatPercentage}%): ₪${roundedTotalWithVat.toLocaleString()}</div>
      `;
      
      return { repairs, total };
    }
    
    // Auto-calculate when data changes
    document.addEventListener('change', calculateRepairsTotals);
    document.addEventListener('input', calculateRepairsTotals);
  </script>
<script src="car-details-floating.js"></script>

</body>
</html>
