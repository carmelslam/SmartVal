<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>תיקונים נדרשים - ירון כיוף</title>
   <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <style>
    body {
      font-family: sans-serif;
      background: #f3f6fb;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 30px;
    }
    .container {
      max-width: 500px;
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      width: 100%;
      text-align: center;
      position: relative;
    }
    .logo img {
      width: 120px;
      opacity: 0.9;
      margin-bottom: 15px;
    }
    .title { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
    .subtitle { font-size: 18px; color: #666; margin-bottom: 20px; }
    h2 { font-size: 20px; color: #007bff; margin-bottom: 15px; }
    textarea {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      margin-bottom: 10px;
      resize: vertical;
      font-family: sans-serif;
    }
  button {
    margin-top: 15px;
    width: 100%;
    padding: 12px;
    font-size: 16px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }

  .btn-vehiclePopup {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    text-align: right;
    margin-bottom: 10px;
  }
    .btn-secondary {
      background-color: #6c757d;
      margin-top: 10px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .top-bar button {
      width: 48%;
      background-color: #6c757d;
    }
    .logout-btn {
      background-color: #dc3545 !important;
    }
    .footer { margin-top: 30px; font-size: 12px; color: #999; }
 #vehiclePopup {
      background: #f1f1f1;
      padding: 10px;
      border-radius: 10px;
      margin: 10px 0;
      display: none;
      font-size: 14px;
      text-align: right;
    }

 </style>
</head>
<body>
  <div class="container">
    <div class="logo"><img src="https://carmelcayouf.com/wp-content/uploads/2025/04/logo-yaron.webp" alt="Logo"/></div>
    <div class="title">ירון כיוף שמאות - פורטל</div>
    <div class="subtitle">שמאי רכב והערכת נזקי רכוש</div>
    <h2 id="pageTitle">רכב מס. ...: תיקונים נדרשים</h2>
    <div style="color: red; font-weight: bold; margin-bottom: 15px;">
 לזמן שמאי לאחר פירוקים ולפני צבע
 
  <button onclick="toggleVehicle()">פרטי הרכב</button>
       <div id="vehiclePopup"></div>
</div>

   <div class="top-bar">
      <button onclick="window.location.href='selection.html'">עמוד הבית</button>
      <button class="logout-btn" onclick="logout()">התנתק</button>
    </div>

    <form id="fixesForm">
      <div id="fixesList">
        <div class="repair-row">
          <input type="text" class="repair-name" placeholder="שם התיקון" required style="width: 45%; margin-bottom: 10px; margin-left: 10px;">
          <input type="number" class="repair-cost" placeholder="עלות (₪)" min="0" step="0.01" style="width: 45%; margin-bottom: 10px;">
          <textarea class="repair-desc" placeholder="תיאור מפורט של התיקון" required style="width: 100%; margin-bottom: 15px;"></textarea>
        </div>
      </div>

      <button type="button" class="btn-secondary" onclick="addRepairRow()">הוסף תיקון</button>
      <button type="button" class="save-btn" onclick="saveRepairsData()" style="background-color: #28a745; margin-top: 10px;">שמור נתונים</button>
      <button type="submit">המשך</button>
    </form>

    <div class="footer">All rights reserved © Carmel Cayouf</div>
  </div>

  <script>
    // Get data from helper instead of legacy storage  
    let globalHelper = {};
    try { globalHelper = JSON.parse(sessionStorage.getItem("helper") || '{}'); } catch(e){}
    const plate = globalHelper.meta?.plate || globalHelper.vehicle?.plate || '';
    const owner = globalHelper.stakeholders?.owner?.name || '';
    const date = globalHelper.case_info?.inspection_date || globalHelper.meta?.date || '';

    if (!plate || !owner || !date) {
      alert("שגיאה: חסר מידע קריטי. חזרה לעמוד הראשי.");
      window.location.href = "index.html";
    }

    document.getElementById("pageTitle").innerText = `רכב מס. ${plate}: תיקונים נדרשים`;

    function logout() {
      sessionStorage.clear();
      window.location.href = "index.html";
    }

    function addRepairRow() {
      const div = document.createElement("div");
      div.className = "repair-row";
      div.innerHTML = `
        <input type="text" class="repair-name" placeholder="שם התיקון" required style="width: 45%; margin-bottom: 10px; margin-left: 10px;">
        <input type="number" class="repair-cost" placeholder="עלות (₪)" min="0" step="0.01" style="width: 45%; margin-bottom: 10px;">
        <textarea class="repair-desc" placeholder="תיאור מפורט של התיקון" required style="width: 100%; margin-bottom: 15px;"></textarea>
      `;
      document.getElementById("fixesList").appendChild(div);
    }

    // Save repairs data to helper without navigation
    function saveRepairsData() {
      const repairs = [];

      document.querySelectorAll("#fixesList .repair-row").forEach(row => {
        const name = row.querySelector(".repair-name").value.trim();
        const cost = parseFloat(row.querySelector(".repair-cost").value) || 0;
        const desc = row.querySelector(".repair-desc").value.trim();
        
        if (name && desc) {
          repairs.push({ 
            name: name, 
            cost: cost,
            description: desc 
          });
        }
      });

      console.log('💾 Saving repairs data to helper...');
      
      // Send data to parent wizard if in iframe
      if (window.parent !== window) {
        const repairsData = {
          type: 'moduleData',
          module: 'repairs',
          data: {
            repairs: repairs
          }
        };
        window.parent.postMessage(repairsData, '*');
        console.log('📤 Repairs data sent to parent wizard:', repairsData);
      }
      
      try {
        // Get current helper data
        let helper = {};
        try {
          helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        } catch (e) {
          console.warn('Failed to parse helper from sessionStorage, using empty object');
          helper = {};
        }
        
        // Initialize damage_assessment structure if needed
        helper.damage_assessment = helper.damage_assessment || {};
        helper.damage_assessment.repairs = helper.damage_assessment.repairs || {};
        
        // Store repairs data in proper helper structure
        helper.damage_assessment.repairs = {
          repairs_items: repairs,
          updated_at: new Date().toISOString(),
          updated_by: 'repairs_required_module'
        };
        
        // Update meta information
        helper.meta = helper.meta || {};
        helper.meta.last_updated = new Date().toISOString();
        
        // Save to session storage
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        console.log('✅ Repairs data saved to helper:', helper.damage_assessment.repairs);
        
        // Show save confirmation
        const saveBtn = document.querySelector('.save-btn');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = '✅ נשמר';
        saveBtn.style.background = '#155724';
        
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.style.background = '#28a745';
        }, 2000);
        
        // Trigger helper update broadcast if available
        if (typeof window.broadcastHelperUpdate === 'function') {
          window.broadcastHelperUpdate(['damage_assessment'], 'repairs_required_module');
        }
        
      } catch (error) {
        console.error('❌ Failed to save repairs data to helper:', error);
        alert('שגיאה בשמירת הנתונים');
      }
    }

    document.getElementById("fixesForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const repairs = [];

      document.querySelectorAll("#fixesList .repair-row").forEach(row => {
        const name = row.querySelector(".repair-name").value.trim();
        const cost = parseFloat(row.querySelector(".repair-cost").value) || 0;
        const desc = row.querySelector(".repair-desc").value.trim();
        
        if (name && desc) {
          repairs.push({ 
            name: name, 
            cost: cost,
            description: desc 
          });
        }
      });

      // Send data to parent wizard if in iframe
      if (window.parent !== window) {
        const repairsData = {
          type: 'moduleData',
          module: 'repairs',
          data: {
            repairs: repairs
          }
        };
        window.parent.postMessage(repairsData, '*');
        console.log('📤 Repairs data sent to parent wizard:', repairsData);
      }
      
      // ✅ FIXED: Save repairs to damage_centers structure with ACTUAL DATA
      console.log('🔄 Updating helper with repairs data AND damage centers...');
      
      try {
        // Get current helper data
        let helper = {};
        try {
          helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        } catch (e) {
          console.warn('Failed to parse helper from sessionStorage, using empty object');
          helper = {};
        }
        
        // Initialize damage_assessment structure if needed
        helper.damage_assessment = helper.damage_assessment || {};
        helper.damage_assessment.repairs = helper.damage_assessment.repairs || {};
        
        // Store repairs data in legacy damage_assessment structure
        helper.damage_assessment.repairs = {
          repairs_items: repairs,
          updated_at: new Date().toISOString(),
          updated_by: 'repairs_required_module'
        };
        
        // ✅ CRITICAL: Also save to damage_centers structure with REAL DATA
        if (!helper.damage_centers) {
          helper.damage_centers = {
            centers: [],
            current_center_id: null,
            active_center_count: 0,
            totals: { all_centers_subtotal: 0, all_centers_vat: 0, all_centers_total: 0 }
          };
        }
        
        // Find or create current damage center
        let currentCenterId = helper.damage_centers.current_center_id;
        if (!currentCenterId) {
          currentCenterId = `center_${Date.now()}`;
          helper.damage_centers.current_center_id = currentCenterId;
          helper.damage_centers.active_center_count = 1;
        }
        
        let currentCenter = helper.damage_centers.centers.find(c => c.id === currentCenterId);
        if (!currentCenter) {
          currentCenter = {
            id: currentCenterId,
            number: helper.damage_centers.active_center_count,
            location: 'מיקום לא צוין',
            description: 'תיאור לא צוין',
            work_items: [],
            parts_items: [],
            repairs_items: [],
            subtotals: { works: 0, parts: 0, repairs: 0, subtotal_without_vat: 0, vat_amount: 0, total_with_vat: 0 },
            takana389: 'לא צוין',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
            status: 'active'
          };
          helper.damage_centers.centers.push(currentCenter);
        }
        
        // ✅ POPULATE WITH ACTUAL REPAIRS ITEMS AND COSTS
        currentCenter.repairs_items = repairs.map((repair, index) => ({
          id: `repair_${Date.now()}_${index}`,
          name: repair.name,
          description: repair.description || '',
          cost: parseFloat(repair.cost) || 0,
          category: 'תיקון כללי',
          priority: 'רגיל',
          added_at: new Date().toISOString(),
          source: 'manual_entry'
        }));
        
        // ✅ CALCULATE REAL SUBTOTALS
        const repairsTotal = currentCenter.repairs_items.reduce((sum, item) => sum + (item.cost || 0), 0);
        currentCenter.subtotals.repairs = repairsTotal;
        
        // Recalculate center totals
        const subtotalWithoutVat = currentCenter.subtotals.works + currentCenter.subtotals.parts + currentCenter.subtotals.repairs;
        const vatAmount = subtotalWithoutVat * 0.18;
        currentCenter.subtotals.subtotal_without_vat = subtotalWithoutVat;
        currentCenter.subtotals.vat_amount = vatAmount;
        currentCenter.subtotals.total_with_vat = subtotalWithoutVat + vatAmount;
        currentCenter.updated_at = new Date().toISOString();
        
        // ✅ UPDATE GLOBAL TOTALS WITH REAL NUMBERS
        const globalSubtotal = helper.damage_centers.centers.reduce((sum, center) => sum + (center.subtotals.subtotal_without_vat || 0), 0);
        const globalVat = helper.damage_centers.centers.reduce((sum, center) => sum + (center.subtotals.vat_amount || 0), 0);
        helper.damage_centers.totals = {
          all_centers_subtotal: globalSubtotal,
          all_centers_vat: globalVat,
          all_centers_total: globalSubtotal + globalVat,
          last_calculated: new Date().toISOString()
        };
        
        // Update meta information
        helper.meta = helper.meta || {};
        helper.meta.last_updated = new Date().toISOString();
        
        // Save to session storage
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        console.log('✅ Helper updated successfully with repairs data:', helper.damage_assessment.repairs);
        console.log('✅ Damage centers updated with repairs:', currentCenter.repairs_items);
        
        // Trigger helper update broadcast if available
        if (typeof window.broadcastHelperUpdate === 'function') {
          window.broadcastHelperUpdate(['damage_assessment', 'damage_centers'], 'repairs_required_module');
        }
        
      } catch (error) {
        console.error('❌ Failed to update helper with repairs data:', error);
        alert('שגיאה בשמירת תיקוני הרכב');
        return;
      }
      
      window.location.href = "general-comments.html";
    });
  </script>
<script src="car-details-floating.js"></script>

</body>
</html>
