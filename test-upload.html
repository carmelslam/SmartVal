<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test File Upload - Phase 7</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .upload-area { border: 2px dashed #ccc; padding: 20px; text-align: center; margin: 20px 0; }
        .progress-bar { width: 100%; height: 20px; background-color: #f0f0f0; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background-color: #4CAF50; width: 0%; transition: width 0.3s; }
        .result { margin: 20px 0; padding: 15px; border-radius: 5px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        select, input { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>üß™ Phase 7 File Upload Test</h1>
    
    <div class="upload-area">
        <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.gif,.webp,.doc,.docx,.xls,.xlsx,.txt,.csv">
        <br><br>
        
        <label for="categorySelect">Category:</label>
        <select id="categorySelect">
            <option value="invoice">Invoice</option>
            <option value="report">Report</option>
            <option value="image">Image</option>
            <option value="document">Document</option>
        </select>
        
        <br><br>
        
        <label for="caseIdInput">Case ID (optional - will use test case if empty):</label>
        <input type="text" id="caseIdInput" placeholder="Enter case ID or leave empty for test">
        
        <br><br>
        
        <button id="uploadBtn" onclick="testUpload()">Upload File</button>
    </div>
    
    <div class="progress-bar" id="progressBar" style="display: none;">
        <div class="progress-fill" id="progressFill"></div>
    </div>
    
    <div id="result"></div>
    
    <div id="debug" style="background: #f5f5f5; padding: 15px; margin: 20px 0; border-radius: 5px; font-family: monospace; font-size: 12px;"></div>

    <!-- Include Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Include your file upload service -->
    <script type="module">
        // Import the file upload service
        import('./lib/fileUploadService.js').then(module => {
            window.fileUploadService = module.fileUploadService || module.default;
            console.log('File upload service loaded:', window.fileUploadService);
        }).catch(error => {
            console.error('Failed to load file upload service:', error);
            document.getElementById('debug').innerHTML = `
                <strong>Error loading file upload service:</strong><br>
                ${error.message}<br><br>
                Make sure lib/fileUploadService.js exists and is properly exported.
            `;
        });

        // Test function
        window.testUpload = async function() {
            const fileInput = document.getElementById('fileInput');
            const categorySelect = document.getElementById('categorySelect');
            const caseIdInput = document.getElementById('caseIdInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const result = document.getElementById('result');
            const debug = document.getElementById('debug');
            
            // Clear previous results
            result.innerHTML = '';
            debug.innerHTML = '';
            
            // Check if file is selected
            if (!fileInput.files[0]) {
                result.innerHTML = '<div class="error">Please select a file first!</div>';
                return;
            }
            
            // Check if service is loaded
            if (!window.fileUploadService) {
                result.innerHTML = '<div class="error">File upload service not loaded. Check console for errors.</div>';
                return;
            }
            
            const file = fileInput.files[0];
            const category = categorySelect.value;
            let caseId = caseIdInput.value.trim();
            
            // Use test case ID if none provided (must be valid UUID)
            if (!caseId) {
                caseId = crypto.randomUUID(); // Generate proper UUID
                debug.innerHTML += `Using test case ID: ${caseId}<br>`;
            }
            
            // Disable upload button
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            progressBar.style.display = 'block';
            
            try {
                debug.innerHTML += `Starting upload...<br>`;
                debug.innerHTML += `File: ${file.name} (${file.size} bytes)<br>`;
                debug.innerHTML += `Category: ${category}<br>`;
                debug.innerHTML += `Case ID: ${caseId}<br><br>`;
                
                // Test upload
                const uploadResult = await window.fileUploadService.uploadToSupabase(file, {
                    caseId: caseId,
                    category: category,
                    onProgress: (percentage) => {
                        progressFill.style.width = percentage + '%';
                        debug.innerHTML += `Upload progress: ${percentage}%<br>`;
                    }
                });
                
                debug.innerHTML += `Upload completed!<br>`;
                debug.innerHTML += `Result: ${JSON.stringify(uploadResult, null, 2)}<br>`;
                
                if (uploadResult.success) {
                    result.innerHTML = `
                        <div class="success">
                            <strong>‚úÖ Upload Successful!</strong><br>
                            <strong>Document ID:</strong> ${uploadResult.document_id}<br>
                            <strong>Storage Path:</strong> ${uploadResult.storage_path}<br>
                            <strong>Bucket:</strong> ${uploadResult.bucket_name}<br>
                            <strong>File Size:</strong> ${uploadResult.size_bytes} bytes
                        </div>
                    `;
                    
                    // Test getting signed URL
                    try {
                        debug.innerHTML += `<br>Testing signed URL generation...<br>`;
                        const urlResult = await window.fileUploadService.getSignedUrl(uploadResult.document_id);
                        if (urlResult.success) {
                            result.innerHTML += `
                                <div class="success" style="margin-top: 10px;">
                                    <strong>‚úÖ Signed URL Generated!</strong><br>
                                    <a href="${urlResult.signed_url}" target="_blank">View File</a><br>
                                    <small>URL expires: ${urlResult.expires_at}</small>
                                </div>
                            `;
                            debug.innerHTML += `Signed URL: ${urlResult.signed_url}<br>`;
                        } else {
                            debug.innerHTML += `Signed URL Error: ${urlResult.error}<br>`;
                        }
                    } catch (urlError) {
                        debug.innerHTML += `Signed URL Exception: ${urlError.message}<br>`;
                    }
                    
                } else {
                    result.innerHTML = `
                        <div class="error">
                            <strong>‚ùå Upload Failed!</strong><br>
                            <strong>Error:</strong> ${uploadResult.error}<br>
                            <strong>Details:</strong> ${JSON.stringify(uploadResult.details || 'No details', null, 2)}
                        </div>
                    `;
                }
                
            } catch (error) {
                debug.innerHTML += `Exception: ${error.message}<br>`;
                result.innerHTML = `
                    <div class="error">
                        <strong>‚ùå Upload Exception!</strong><br>
                        <strong>Error:</strong> ${error.message}<br>
                        <strong>Stack:</strong> <pre>${error.stack}</pre>
                    </div>
                `;
            } finally {
                // Re-enable upload button
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload File';
                progressBar.style.display = 'none';
                progressFill.style.width = '0%';
            }
        };
    </script>
</body>
</html>