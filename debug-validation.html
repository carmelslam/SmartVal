<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Validation Structure</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
            direction: rtl;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #6f42c1;
            text-align: center;
        }
        .debug-section {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .debug-section h2 {
            color: #17a2b8;
            margin-top: 0;
        }
        pre {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.5;
            border: 1px solid #333;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            margin: 2px;
        }
        .status-valid {
            background: #28a745;
            color: white;
        }
        .status-invalid {
            background: #dc3545;
            color: white;
        }
        .status-partial {
            background: #ffc107;
            color: black;
        }
        button {
            background: #6f42c1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #5a35a3;
        }
        .input-section {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #444;
            background: #1a1a1a;
            color: #e0e0e0;
            border-radius: 4px;
            font-size: 16px;
        }
        .validation-result {
            margin: 10px 0;
            padding: 10px;
            background: #333;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ×›×œ×™ ××‘×—×•×Ÿ ××‘× ×” × ×ª×•× ×™× - SmartVal</h1>
        
        <div class="input-section">
            <h2>×˜×¢×Ÿ × ×ª×•× ×™ Helper</h2>
            <p>×”×¢×ª×§ ××ª × ×ª×•× ×™ ×”-Helper ××”×“×¤×“×¤×Ÿ (window.helper) ××• ××”××¡×“ × ×ª×•× ×™×</p>
            <textarea id="helperInput" style="width: 100%; height: 200px; padding: 10px; border: 1px solid #444; background: #1a1a1a; color: #e0e0e0; border-radius: 4px; font-family: monospace;" placeholder="×”×“×‘×§ ×›××Ÿ ××ª × ×ª×•× ×™ ×”-Helper ×‘×¤×•×¨××˜ JSON..."></textarea>
            <button onclick="analyzeHelper()">ğŸ” × ×ª×— ××‘× ×” × ×ª×•× ×™×</button>
            <button onclick="loadFromWindow()">ğŸ“¥ ×˜×¢×Ÿ ×-window.helper</button>
            <button onclick="loadSampleData()">ğŸ“‹ ×˜×¢×Ÿ × ×ª×•× ×™× ×œ×“×•×’××”</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        function loadFromWindow() {
            if (window.helper) {
                document.getElementById('helperInput').value = JSON.stringify(window.helper, null, 2);
                analyzeHelper();
            } else {
                alert('×œ× × ××¦× window.helper ×‘×“×£ ×–×”');
            }
        }

        function loadSampleData() {
            // Sample data with various validation states
            const sampleHelper = {
                plate: "12345678",
                case_info: {
                    plate: "12345678",
                    vehicle_make: "×˜×•×™×•×˜×”",
                    vehicle_model: "×§×•×¨×•×œ×”",
                    vehicle_year: "2020",
                    owner_name: "×™×©×¨××œ ×™×©×¨××œ×™",
                    insurance_company: "×”×¤× ×™×§×¡",
                    agent_name: "××©×” ×›×”×Ÿ",
                    inspection_date: "2025-01-15"
                },
                vehicle: {
                    plate: "12345678",
                    make: "×˜×•×™×•×˜×”",
                    model: "×§×•×¨×•×œ×”",
                    year: 2020
                },
                levi_summary: {
                    report_date: "2025-01-10",
                    depreciation: 15,
                    market_value: 120000
                },
                damage_assessment: {
                    centers: [
                        { name: "×—×–×™×ª", parts: 5, labor_hours: 3 }
                    ],
                    totals: {
                        total_parts: 5,
                        total_labor: 8,
                        total_cost: 15000
                    }
                },
                expertise: {
                    expert_name: "×“\"×¨ ×“×•×“ ×œ×•×™",
                    report_date: "2025-01-12",
                    findings: "× ×–×§ ×‘×™× ×•× ×™ ×œ×—×–×™×ª ×”×¨×›×‘"
                },
                estimate: {
                    totals: {
                        parts_total: 8000,
                        labor_total: 3000,
                        other_total: 1000,
                        grand_total: 12000
                    },
                    validation: {
                        validated_at: "2025-01-13T10:00:00Z"
                    }
                },
                validation_progress: {
                    vehicle: true,
                    damage: true,
                    expertise: false,
                    fees: false
                },
                depreciation: {
                    globalDep1: 15,
                    globalDep2: 10
                },
                meta: {
                    created_at: "2025-01-01",
                    updated_at: "2025-01-15"
                }
            };
            
            document.getElementById('helperInput').value = JSON.stringify(sampleHelper, null, 2);
            analyzeHelper();
        }

        function analyzeHelper() {
            const input = document.getElementById('helperInput').value;
            if (!input.trim()) {
                alert('×× × ×”×“×‘×§ × ×ª×•× ×™ Helper ×ª×—×™×œ×”');
                return;
            }

            let helper;
            try {
                helper = JSON.parse(input);
            } catch (e) {
                alert('×©×’×™××” ×‘×¤×¢× ×•×— JSON: ' + e.message);
                return;
            }

            // Check if data is wrapped
            if (helper && helper.helper_data) {
                console.log('ğŸ”§ Unwrapping helper_data structure');
                helper = helper.helper_data;
            }

            const results = document.getElementById('results');
            results.innerHTML = '';

            // Analyze structure
            analyzeStructure(helper, results);
            
            // Test validation functions
            testValidationFunctions(helper, results);
            
            // Show data paths
            showDataPaths(helper, results);
            
            // Show validation recommendations
            showRecommendations(helper, results);
        }

        function analyzeStructure(helper, container) {
            const section = createSection('××‘× ×” × ×ª×•× ×™× ×›×œ×œ×™');
            
            const structure = {
                '××¤×ª×—×•×ª ×¨××©×™×™×': Object.keys(helper || {}),
                '×”×× ×™×© helper_data wrapper?': !!(helper && helper.helper_data),
                '×”×× ×™×© × ×ª×•× ×™ ×¨×›×‘?': !!(helper.vehicle || helper.car_details || helper.case_info),
                '×”×× ×™×© × ×ª×•× ×™ ×œ×•×™?': !!(helper.levi_summary || helper.levi_data || helper.expertise?.levi_report),
                '×”×× ×™×© ×”×¢×¨×›×ª × ×–×§×™×?': !!(helper.damage_assessment || helper.damages),
                '×”×× ×™×© ××•××“×Ÿ?': !!(helper.estimate || helper.initial_estimate),
                '×”×× ×™×© validation_progress?': !!(helper.validation_progress),
                '×”×× ×™×© meta data?': !!(helper.meta || helper.metadata)
            };

            section.innerHTML += '<pre>' + JSON.stringify(structure, null, 2) + '</pre>';
            container.appendChild(section);
        }

        function testValidationFunctions(helper, container) {
            const section = createSection('×‘×“×™×§×ª ×¤×•× ×§×¦×™×•×ª ××™××•×ª');
            
            // Copy validation functions from admin.html
            const validationTests = [
                {
                    name: '×¤×¨×˜×™ ×¨×›×‘',
                    check: () => {
                        const hasPlate = !!(helper.vehicle?.plate || helper.car_details?.plate || helper.case_info?.plate);
                        const hasMake = !!(helper.vehicle?.make || helper.car_details?.manufacturer || helper.case_info?.vehicle_make);
                        const hasModel = !!(helper.vehicle?.model || helper.car_details?.model || helper.case_info?.vehicle_model);
                        const hasYear = !!(helper.vehicle?.year || helper.car_details?.year || helper.case_info?.vehicle_year);
                        
                        return {
                            validated: hasPlate && hasMake && hasModel && hasYear,
                            details: {
                                '××¡×¤×¨ ×¨×›×‘': hasPlate ? 'âœ…' : 'âŒ',
                                '×™×¦×¨×Ÿ': hasMake ? 'âœ…' : 'âŒ',
                                '×“×’×': hasModel ? 'âœ…' : 'âŒ',
                                '×©× ×”': hasYear ? 'âœ…' : 'âŒ'
                            },
                            paths: {
                                plate: findDataPath(helper, ['vehicle.plate', 'car_details.plate', 'case_info.plate']),
                                make: findDataPath(helper, ['vehicle.make', 'car_details.manufacturer', 'case_info.vehicle_make']),
                                model: findDataPath(helper, ['vehicle.model', 'car_details.model', 'case_info.vehicle_model']),
                                year: findDataPath(helper, ['vehicle.year', 'car_details.year', 'case_info.vehicle_year'])
                            }
                        };
                    }
                },
                {
                    name: '× ×ª×•× ×™ ×œ×•×™ ×™×¦×—×§',
                    check: () => {
                        const hasLevi = !!(helper.levi_summary && Object.keys(helper.levi_summary).length > 0);
                        const started = !!(helper.levi_summary || helper.levi_data || helper.leviData || helper.expertise?.levi_report);
                        
                        return {
                            validated: hasLevi,
                            started: started,
                            details: {
                                'levi_summary': helper.levi_summary ? 'âœ…' : 'âŒ',
                                'levi_data': helper.levi_data ? 'âœ…' : 'âŒ',
                                'leviData': helper.leviData ? 'âœ…' : 'âŒ',
                                'expertise.levi_report': helper.expertise?.levi_report ? 'âœ…' : 'âŒ'
                            },
                            data: helper.levi_summary || helper.levi_data || helper.leviData || {}
                        };
                    }
                },
                {
                    name: '×”×¢×¨×›×ª × ×–×§×™×',
                    check: () => {
                        const damageValidated = helper.validation_progress?.damage === true;
                        const hasData = !!(helper.damage_assessment?.centers?.length || helper.damage_centers?.length);
                        
                        return {
                            validated: damageValidated,
                            started: hasData,
                            details: {
                                'validation_progress.damage': damageValidated ? 'âœ…' : 'âŒ',
                                'damage_assessment.centers': helper.damage_assessment?.centers?.length ? `âœ… (${helper.damage_assessment.centers.length})` : 'âŒ',
                                'damage_centers': helper.damage_centers?.length ? `âœ… (${helper.damage_centers.length})` : 'âŒ'
                            }
                        };
                    }
                },
                {
                    name: '××§×¡×¤×¨×˜×™×–×”',
                    check: () => {
                        const hasExpertise = !!(helper.expertise && Object.keys(helper.expertise).length > 0);
                        const hasValidation = !!(helper.expertise?.validation?.validated_at || helper.expertise_summary);
                        const validated = hasExpertise && (hasValidation || helper.expertise?.summary);
                        
                        return {
                            validated: validated,
                            hasData: hasExpertise,
                            hasValidation: hasValidation,
                            details: {
                                'expertise exists': hasExpertise ? 'âœ…' : 'âŒ',
                                'expertise.validation.validated_at': helper.expertise?.validation?.validated_at ? 'âœ…' : 'âŒ',
                                'expertise_summary': helper.expertise_summary ? 'âœ…' : 'âŒ',
                                'expertise.summary': helper.expertise?.summary ? 'âœ…' : 'âŒ'
                            },
                            data: helper.expertise || {}
                        };
                    }
                },
                {
                    name: '××•××“×Ÿ ×¨××©×•× ×™',
                    check: () => {
                        const hasEstimate = !!(helper.estimate?.validation?.validated_at || (helper.estimate && helper.estimate.totals));
                        const started = !!(helper.estimate || helper.initial_estimate || helper.estimate_totals);
                        
                        return {
                            validated: hasEstimate,
                            started: started,
                            details: {
                                'estimate.validation.validated_at': helper.estimate?.validation?.validated_at ? 'âœ…' : 'âŒ',
                                'estimate.totals': helper.estimate?.totals ? 'âœ…' : 'âŒ',
                                'initial_estimate': helper.initial_estimate ? 'âœ…' : 'âŒ',
                                'estimate_totals': helper.estimate_totals ? 'âœ…' : 'âŒ'
                            },
                            totals: helper.estimate?.totals || helper.estimate_totals || {}
                        };
                    }
                }
            ];

            validationTests.forEach(test => {
                const result = test.check();
                const div = document.createElement('div');
                div.className = 'validation-result';
                
                let statusBadge = '';
                if (result.validated) {
                    statusBadge = '<span class="status-badge status-valid">âœ… ×××•××ª</span>';
                } else if (result.started || result.hasData) {
                    statusBadge = '<span class="status-badge status-partial">ğŸ”„ ×‘×ª×”×œ×™×š</span>';
                } else {
                    statusBadge = '<span class="status-badge status-invalid">âŒ ×œ× ×”×ª×—×™×œ</span>';
                }
                
                div.innerHTML = `
                    <h3>${test.name} ${statusBadge}</h3>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;
                
                section.appendChild(div);
            });
            
            container.appendChild(section);
        }

        function showDataPaths(helper, container) {
            const section = createSection('× ×ª×™×‘×™ × ×ª×•× ×™× ×©× ××¦××•');
            
            const paths = {
                'Vehicle Data': findAllPaths(helper, 'plate'),
                'Levi Data': findAllPaths(helper, 'levi'),
                'Damage Data': findAllPaths(helper, 'damage'),
                'Estimate Data': findAllPaths(helper, 'estimate'),
                'Validation Data': findAllPaths(helper, 'validation')
            };
            
            section.innerHTML += '<pre>' + JSON.stringify(paths, null, 2) + '</pre>';
            container.appendChild(section);
        }

        function showRecommendations(helper, container) {
            const section = createSection('×”××œ×¦×•×ª ×œ×ª×™×§×•×Ÿ');
            
            const recommendations = [];
            
            // Check vehicle data
            if (!helper.vehicle?.plate && helper.case_info?.plate) {
                recommendations.push('× ×ª×•× ×™ ×”×¨×›×‘ × ××¦××™× ×‘-case_info ×‘××§×•× ×‘-vehicle - ×•×•×“× ×©×”×¤×•× ×§×¦×™×•×ª ×‘×•×“×§×•×ª ××ª ×©× ×™ ×”××™×§×•××™×');
            }
            
            // Check Levi data
            if (!helper.levi_summary && (helper.levi_data || helper.leviData)) {
                recommendations.push('× ×ª×•× ×™ ×œ×•×™ × ××¦××™× ×‘-levi_data/leviData ×‘××§×•× ×‘-levi_summary - ×¢×“×›×Ÿ ××ª ×”×‘×“×™×§×•×ª');
            }
            
            // Check validation structure
            if (!helper.validation_progress) {
                recommendations.push('×—×¡×¨ validation_progress - ×–×” ×”×©×“×” ×”×¢×™×§×¨×™ ×œ×‘×“×™×§×ª ××™××•×ª×™×');
            }
            
            // Check expertise
            if (helper.expertise && !helper.expertise.validation && !helper.expertise.summary) {
                recommendations.push('× ×ª×•× ×™ expertise ×§×™×™××™× ××š ×œ×œ× validation ××• summary - ×‘×“×•×§ ×× ×™×© ×©×“×•×ª ××—×¨×™× ×œ××™××•×ª');
            }
            
            if (recommendations.length === 0) {
                recommendations.push('×”××‘× ×” × ×¨××” ×ª×§×™×Ÿ - ×•×•×“× ×©×”×“×¤×“×¤×Ÿ ×˜×•×¢×Ÿ ××ª ×”×’×¨×¡×” ×”××¢×•×“×›× ×ª ×©×œ ×”×§×•×“');
            }
            
            const ul = document.createElement('ul');
            recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.textContent = rec;
                ul.appendChild(li);
            });
            
            section.appendChild(ul);
            container.appendChild(section);
        }

        function createSection(title) {
            const section = document.createElement('div');
            section.className = 'debug-section';
            const h2 = document.createElement('h2');
            h2.textContent = title;
            section.appendChild(h2);
            return section;
        }

        function findDataPath(obj, paths) {
            for (let path of paths) {
                const parts = path.split('.');
                let current = obj;
                let found = true;
                
                for (let part of parts) {
                    if (current && current[part] !== undefined) {
                        current = current[part];
                    } else {
                        found = false;
                        break;
                    }
                }
                
                if (found && current) {
                    return { path: path, value: current };
                }
            }
            return null;
        }

        function findAllPaths(obj, keyword, currentPath = '', results = []) {
            if (!obj || typeof obj !== 'object') return results;
            
            for (let key in obj) {
                const newPath = currentPath ? `${currentPath}.${key}` : key;
                
                if (key.toLowerCase().includes(keyword.toLowerCase())) {
                    results.push({
                        path: newPath,
                        value: obj[key]
                    });
                }
                
                if (typeof obj[key] === 'object' && obj[key] !== null) {
                    findAllPaths(obj[key], keyword, newPath, results);
                }
            }
            
            return results;
        }
    </script>
</body>
</html>