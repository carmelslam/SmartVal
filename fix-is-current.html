<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>תיקון is_current</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f5f5f5; text-align: right; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .result { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 4px; border: 1px solid #ddd; white-space: pre-line; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 PHASE 4: Fix is_current Flags for ALL Cases</h1>
        
        <button onclick="checkAllCurrentStatus()">🔍 בדוק כל ה-is_current flags</button>
        <button onclick="fixAllCurrentStatus()">✅ תקן ALL is_current flags</button>
        <button onclick="verifyFix()">🧪 אמת שהתיקון עבד</button>
        
        <div id="results"></div>
    </div>

    <script type="module">
        import { supabase } from './lib/supabaseClient.js';
        
        window.checkAllCurrentStatus = async function() {
            addResult('🔧 PHASE 4: בודק כל ה-is_current flags...', 'info');
            try {
                const result = await supabase
                    .from('case_helper')
                    .select('id, case_id, helper_name, version, is_current, updated_at')
                    .order('updated_at', { ascending: false });
                
                if (result.error) {
                    addResult(`❌ שגיאה: ${result.error.message}`, 'error');
                    return;
                }
                
                if (!result.data || result.data.length === 0) {
                    addResult(`❌ לא נמצאו helpers`, 'error');
                    return;
                }
                
                // Group by case_id
                const groupedByCaseId = {};
                result.data.forEach(helper => {
                    if (!groupedByCaseId[helper.case_id]) {
                        groupedByCaseId[helper.case_id] = [];
                    }
                    groupedByCaseId[helper.case_id].push(helper);
                });
                
                let statusReport = `✅ נמצאו ${result.data.length} helpers ב-${Object.keys(groupedByCaseId).length} cases:\n\n`;
                
                Object.keys(groupedByCaseId).forEach(caseId => {
                    const helpers = groupedByCaseId[caseId];
                    const currentHelpers = helpers.filter(h => h.is_current);
                    
                    statusReport += `Case ${caseId.substring(0, 8)}...:\n`;
                    statusReport += `  Total helpers: ${helpers.length}\n`;
                    statusReport += `  Current helpers: ${currentHelpers.length}\n`;
                    
                    if (currentHelpers.length !== 1) {
                        statusReport += `  ❌ PROBLEM: Should have exactly 1 current helper\n`;
                    } else {
                        statusReport += `  ✅ OK: Exactly 1 current helper\n`;
                    }
                    statusReport += '\n';
                });
                
                addResult(statusReport, 'success');
                
            } catch (error) {
                addResult(`❌ שגיאה: ${error.message}`, 'error');
            }
        };
        
        window.fixAllCurrentStatus = async function() {
            if (!confirm('האם אתה בטוח שתרצה לתקן את כל ה-is_current flags?\n\nזה יגדיר רק את הגרסה האחרונה של כל case כ-current.')) {
                return;
            }
            
            addResult('🔧 PHASE 4: מתקן ALL is_current flags...', 'info');
            try {
                // Step 1: Get all helpers and set each to false individually
                addResult('Step 1: Setting all helpers to is_current = false...', 'info');
                
                const getAllResult = await supabase
                    .from('case_helper')
                    .select('id');
                
                if (getAllResult.error) {
                    addResult(`❌ שגיאה בשליפת helpers: ${getAllResult.error.message}`, 'error');
                    return;
                }
                
                // Set each helper to is_current = false individually
                let updatedCount = 0;
                for (const helper of getAllResult.data) {
                    const updateResult = await supabase
                        .from('case_helper')
                        .update({ is_current: false })
                        .eq('id', helper.id);
                    
                    if (!updateResult.error) {
                        updatedCount++;
                    }
                }
                
                addResult(`✅ Set ${updatedCount} helpers to is_current = false`, 'success');
                
                // Step 2: Get all helpers grouped by case_id
                const getGroupedResult = await supabase
                    .from('case_helper')
                    .select('id, case_id, helper_name, version, updated_at')
                    .order('case_id, updated_at', { ascending: false });
                
                if (getGroupedResult.error) {
                    addResult(`❌ שגיאה בשליפת helpers: ${getGroupedResult.error.message}`, 'error');
                    return;
                }
                
                // Group by case_id and find latest for each
                const groupedByCaseId = {};
                getGroupedResult.data.forEach(helper => {
                    if (!groupedByCaseId[helper.case_id]) {
                        groupedByCaseId[helper.case_id] = [];
                    }
                    groupedByCaseId[helper.case_id].push(helper);
                });
                
                addResult(`Step 2: Setting latest helper per case to is_current = true...`, 'info');
                let fixedCases = 0;
                
                // Set latest helper for each case to is_current = true
                for (const caseId of Object.keys(groupedByCaseId)) {
                    const helpers = groupedByCaseId[caseId];
                    const latestHelper = helpers[0]; // First is latest due to desc order
                    
                    const setCurrentResult = await supabase
                        .from('case_helper')
                        .update({ is_current: true })
                        .eq('id', latestHelper.id);
                    
                    if (setCurrentResult.error) {
                        addResult(`❌ שגיאה case ${caseId}: ${setCurrentResult.error.message}`, 'error');
                    } else {
                        fixedCases++;
                        addResult(`✅ Case ${caseId.substring(0, 8)}: Set ${latestHelper.helper_name} as current`, 'success');
                    }
                }
                
                addResult(`🎉 PHASE 4: Successfully fixed ${fixedCases} cases!`, 'success');
                addResult('✅ Now historical versions should show 5 buttons and current versions show 2 buttons', 'success');
                
            } catch (error) {
                addResult(`❌ שגיאה: ${error.message}`, 'error');
            }
        };
        
        window.verifyFix = async function() {
            addResult('Step 3: Verifying the fix...', 'info');
            
            try {
                const result = await supabase
                    .from('case_helper')
                    .select('id, case_id, helper_name, is_current, updated_at')
                    .order('updated_at', { ascending: false });
                
                if (result.error) {
                    addResult(`❌ שגיאה: ${result.error.message}`, 'error');
                    return;
                }
                
                const groupedByCaseId = {};
                result.data.forEach(helper => {
                    if (!groupedByCaseId[helper.case_id]) {
                        groupedByCaseId[helper.case_id] = [];
                    }
                    groupedByCaseId[helper.case_id].push(helper);
                });
                
                let verificationResults = 'Verification Results:\n';
                let allGood = true;
                
                Object.keys(groupedByCaseId).forEach(caseId => {
                    const helpers = groupedByCaseId[caseId];
                    const currentHelpers = helpers.filter(h => h.is_current);
                    
                    verificationResults += `Case ${caseId.substring(0, 8)}: ${helpers.length} helpers, ${currentHelpers.length} current\n`;
                    
                    if (currentHelpers.length !== 1) {
                        verificationResults += `  ❌ ERROR: Should have exactly 1 current helper\n`;
                        allGood = false;
                    } else {
                        verificationResults += `  ✅ OK: Exactly 1 current helper\n`;
                    }
                });
                
                addResult(verificationResults, allGood ? 'success' : 'error');
                
                if (allGood) {
                    addResult('🎉 PHASE 4 is_current fix verified successfully!', 'success');
                    addResult('You can now test the admin version management - historical versions should show 5 buttons', 'success');
                } else {
                    addResult('❌ Verification failed - manual check needed', 'error');
                }
                
            } catch (error) {
                addResult(`❌ Verification error: ${error.message}`, 'error');
            }
        };
        
        function addResult(text, type) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = text;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }
        
        // Auto-run check when page loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                addResult('🔧 PHASE 4: Auto-checking is_current status...', 'info');
                checkAllCurrentStatus();
            }, 1000);
        });
    </script>
</body>
</html>