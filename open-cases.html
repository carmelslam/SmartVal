<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>פתיחת תיק חדש</title>
  <link rel="icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" type="image/webp" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Assistant&display=swap" />
  <style>
    body {
      font-family: 'Assistant', sans-serif;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: #f3f6fb;
      padding: 30px;
    }
    .container {
      max-width: 480px;
      background: white;
      padding: 40px 30px;
      border-radius: 16px;
      text-align: center;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      width: 100%;
    }
    .logo {
      margin-bottom: 20px;
    }
    .logo img {
      width: 120px;
      opacity: 0.8;
    }
    .title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .subtitle {
      font-size: 18px;
      color: #666;
      margin-bottom: 20px;
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border-radius: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    .footer {
      margin-top: 30px;
      font-size: 12px;
      color: #999;
    }
    .error {
      color: red;
      text-align: center;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .success {
      color: green;
      text-align: center;
      font-size: 14px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo" />
    </div>
    <div class="title">ירון כיוף - פתיחת תיק חדש</div>
    <div class="subtitle">שמאות והערכת נזקי רכב ורכוש</div>
    <div id="err" class="error"></div>
    <div id="feedback" class="success" style="display:none;"></div>

    <input id="plate" type="text" placeholder="מספר רכב" />
    <input id="owner" type="text" placeholder="שם בעל הרכב" />
    <input id="date" type="date" />
    <input id="location" type="text" placeholder="מקום בדיקה" />

    <button id="submitBtn">פתח תיק</button>
    
    <!-- Return button -->
    <button onclick="window.location.href='selection.html'" style="background: #6c757d; color: white; width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 10px; font-size: 16px; cursor: pointer;">חזור לדף הבחירה</button>
    
    <!-- Debug button -->
    <button onclick="window.location.href='helper-debug-test.html'" style="background: #ffc107; color: black; width: 100%; padding: 8px; margin-top: 5px; border: none; border-radius: 10px; font-size: 14px; cursor: pointer;">🔧 דף בדיקות מערכת</button>
    
    <!-- Test floating screen button -->
    <button onclick="testFloatingScreen()" style="background: #17a2b8; color: white; width: 100%; padding: 8px; margin-top: 5px; border: none; border-radius: 10px; font-size: 14px; cursor: pointer;">📱 בדיקת מסך צף</button>
    
    <!-- Direct Make.com data test -->
    <button onclick="populateFloatingWithMakeData()" style="background: #dc3545; color: white; width: 100%; padding: 8px; margin-top: 5px; border: none; border-radius: 10px; font-size: 14px; cursor: pointer;">🚗 בדיקת נתוני Make.com</button>
    
    <!-- Success message and continue button (hidden initially) -->
    <div id="successSection" style="display: none; margin-top: 20px;">
      <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 15px; margin-bottom: 15px; color: #155724;">
        🚘 תיק נפתח בהצלחה ✅
      </div>
      <button id="continueBtn" style="background: #28a745; width: 100%;">המשך למילוי פרטים כלליים</button>
    </div>

    <div class="footer">All Rights Reserved @ Carmel Cayouf </div>
  </div>

  <script type="module">
    import { sendToWebhook } from './webhook.js';
    import { encryptPassword, decryptPassword } from './auth.js';
    import './make-webhook-simulator.js';
    
    // Initialize page
    document.getElementById("date").value = new Date().toISOString().split("T")[0];

    const encryptedPassword = sessionStorage.getItem("auth");
    if (!encryptedPassword) {
      alert("גישה חסומה. התחבר קודם דרך הדף הראשי.");
      window.location.href = "index.html";
    }

    // Handle async password decryption properly
    let password = null;
    (async () => {
      try {
        password = await decryptPassword(encryptedPassword);
        console.log('✅ Password decrypted successfully');
        
        // Store password for prefill system
        sessionStorage.setItem('prefillPassword', password);
        console.log('🔑 Password stored for prefill system');
        
      } catch (error) {
        console.error('❌ Password decryption failed:', error);
        alert("שגיאה בפענוח הסיסמה");
        window.location.href = "index.html";
      }
    })();

    document.getElementById("submitBtn").addEventListener("click", async function () {
      const plate = document.getElementById("plate").value.trim();
      const owner = document.getElementById("owner").value.trim();
      const date = document.getElementById("date").value.trim();
      const location = document.getElementById("location").value.trim();

      if (!plate || !owner || !date || !location) {
        document.getElementById("err").innerText = "נא למלא את כל השדות";
        return;
      }

      // Ensure password is available
      if (!password) {
        try {
          password = await decryptPassword(encryptedPassword);
        } catch (error) {
          document.getElementById("err").innerText = "שגיאה בפענוח הסיסמה";
          return;
        }
      }

      const payload = {
        plate,
        owner,
        date,
        location,
        password
      };

      try {
        document.getElementById("err").innerText = "";
        document.getElementById("feedback").style.display = "none";
        
        // Show loading state
        document.getElementById("submitBtn").disabled = true;
        document.getElementById("submitBtn").innerText = "שולח בקשה...";
        
        // Send webhook and wait for response
        console.log('🌐 Sending case data to Make.com webhook...');
        const webhookResponse = await sendToWebhook('OPEN_CASE_UI', payload);
        console.log('📥 Make.com webhook response:', webhookResponse);
        console.log('📥 Make.com response type:', typeof webhookResponse);
        console.log('📥 Make.com response stringified:', JSON.stringify(webhookResponse, null, 2));
        
        const encryptedPassword = await encryptPassword(payload.password);
        const encryptedPayload = JSON.stringify({
          ...payload,
          password: encryptedPassword
        });
        sessionStorage.setItem("carData", encryptedPayload);
        
        document.getElementById("feedback").innerText = "הבקשה נשלחה בהצלחה";
        document.getElementById("feedback").style.display = "block";
        
        // ENHANCED: Process webhook response for car data
        console.log('📋 Processing webhook response for car details...');
        
        // Store ANY webhook response for debugging
        sessionStorage.setItem('lastWebhookResponse', JSON.stringify(webhookResponse));
        
        // Store the original payload data immediately with office code
        const initialCaseData = {
          plate: payload.plate,
          owner: payload.owner,
          date: payload.date,
          location: payload.location,
          case_id: `YC-${payload.plate}-${new Date().getFullYear()}`,
          data_source: 'make_com_webhook',
          webhook_response: webhookResponse,
          // Add office code if available in webhook response
          office_code: webhookResponse?.office_code || webhookResponse?.['קוד משרד התחבורה'] || ''
        };
        
        sessionStorage.setItem('makeCarData', JSON.stringify(initialCaseData));
        
        // Also update helper immediately with basic data
        if (typeof window.updateHelper === 'function') {
          try {
            window.updateHelper('car_details', initialCaseData);
            window.updateHelper('vehicle', initialCaseData);
            window.updateHelper('meta', {
              plate: initialCaseData.plate,
              case_id: initialCaseData.case_id,
              owner_name: initialCaseData.owner
            });
            console.log('✅ Helper updated with initial case data');
          } catch (error) {
            console.log('❌ Helper update failed:', error);
          }
        }
        
        // Always show floating screen with at least the basic data
        console.log('🚗 Showing floating screen with received data...');
        showCarDetailsFloating({
          plate: payload.plate,
          owner: payload.owner,
          date: payload.date,
          location: payload.location,
          manufacturer: 'טוען מבסיס נתונים...',
          model: 'טוען מבסיס נתונים...',
          data_source: 'make_com_immediate'
        });
        
        // Process specific response types
        if (webhookResponse && typeof webhookResponse === 'object') {
          // Check if response contains car details
          if (webhookResponse.car_details || webhookResponse.vehicle_data || webhookResponse.vehicle) {
            const carDetailsFromWebhook = webhookResponse.car_details || webhookResponse.vehicle_data || webhookResponse.vehicle;
            console.log('🚗 Car details found in webhook response:', carDetailsFromWebhook);
            
            // Store rich car data from Make.com
            sessionStorage.setItem('makeCarData', JSON.stringify(carDetailsFromWebhook));
            
            // Update helper immediately
            if (typeof window.updateHelper === 'function') {
              window.updateHelper('car_details', carDetailsFromWebhook);
              window.updateHelper('vehicle', carDetailsFromWebhook);
              window.updateHelper('meta', { 
                plate: carDetailsFromWebhook.plate || payload.plate,
                owner_name: carDetailsFromWebhook.owner || payload.owner
              });
            }
            
            // Refresh floating screen with rich data
            setTimeout(() => showCarDetailsFloating(carDetailsFromWebhook), 500);
          }
          
          // Check if response contains Hebrew text body (like from your screenshot)
          else if (webhookResponse.Body && typeof webhookResponse.Body === 'string' && 
                   webhookResponse.Body.includes('פרטי רכב')) {
            console.log('🚗 Hebrew MOT data found in webhook Body, parsing...');
            const parsedCarData = parseHebrewMOTResponse(webhookResponse.Body, payload);
            sessionStorage.setItem('makeCarData', JSON.stringify(parsedCarData));
            setTimeout(() => showCarDetailsFloating(parsedCarData), 500);
          }
          
          // Check for direct car data in response
          else if (webhookResponse.plate || webhookResponse.manufacturer) {
            console.log('🚗 Car data found directly in webhook response:', webhookResponse);
            sessionStorage.setItem('makeCarData', JSON.stringify(webhookResponse));
            setTimeout(() => showCarDetailsFloating(webhookResponse), 500);
          }
          
          // Check any string fields in the response for Hebrew data
          else {
            console.log('🔍 Searching for Hebrew data in webhook response fields...');
            for (const [key, value] of Object.entries(webhookResponse)) {
              if (typeof value === 'string' && value.includes('פרטי רכב')) {
                console.log(`🚗 Hebrew MOT data found in ${key}, parsing...`);
                const parsedCarData = parseHebrewMOTResponse(value, payload);
                sessionStorage.setItem('makeCarData', JSON.stringify(parsedCarData));
                setTimeout(() => showCarDetailsFloating(parsedCarData), 500);
                break;
              }
            }
          }
        } 
        
        // Check for Hebrew MOT response as string
        else if (typeof webhookResponse === 'string' && webhookResponse.includes('פרטי רכב')) {
          console.log('🚗 Hebrew MOT data found in string response, parsing...');
          const parsedCarData = parseHebrewMOTResponse(webhookResponse, payload);
          sessionStorage.setItem('makeCarData', JSON.stringify(parsedCarData));
          setTimeout(() => showCarDetailsFloating(parsedCarData), 500);
        }
        
        // Wait for additional data to arrive
        console.log('⏳ Setting up continuous data checking...');
        setTimeout(() => {
          checkForIncomingCarData();
        }, 3000);
        
        // Check every 5 seconds for up to 30 seconds
        let checkCount = 0;
        const checkInterval = setInterval(() => {
          checkCount++;
          checkForIncomingCarData();
          
          if (checkCount >= 6) { // 6 * 5 = 30 seconds
            clearInterval(checkInterval);
            console.log('🔍 Stopped checking for car data after 30 seconds');
          }
        }, 5000);
        
        // Show success message and continue button
        showSuccessAndContinue();

      } catch (err) {
        document.getElementById("err").innerText = "שגיאה בשליחה: " + err.message;
        document.getElementById("feedback").style.display = "none";
        
        // Reset button state on error
        document.getElementById("submitBtn").disabled = false;
        document.getElementById("submitBtn").innerText = "פתח תיק";
      }
    });

    function showSuccessAndContinue() {
      // Hide the form and show success section
      document.getElementById("submitBtn").style.display = "none";
      document.getElementById("successSection").style.display = "block";
      
      // Add continue button functionality
      document.getElementById("continueBtn").addEventListener("click", function() {
        window.location.href = "general_info.html";
      });
    }

    // Show car details floating screen
    function showCarDetailsFloating(carData) {
      console.log('🚗 Showing car details floating screen with data:', carData);
      
      // Update helper with rich car data
      if (typeof window.updateHelper === 'function') {
        window.updateHelper('car_details', carData);
        window.updateHelper('vehicle', carData);
        
        // Also update meta with basic info
        window.updateHelper('meta', {
          plate: carData.plate,
          case_id: carData.case_id,
          owner_name: carData.owner
        });
      }
      
      // Show floating screen immediately if available
      if (typeof window.showCarDetails === 'function') {
        window.showCarDetails();
      } else if (typeof window.toggleCarDetails === 'function') {
        window.toggleCarDetails();
      }
      
      // Also trigger any refresh functions that may exist
      if (typeof window.refreshCarData === 'function') {
        setTimeout(() => {
          window.refreshCarData();
        }, 100);
      }
    }

    // Parse Hebrew MOT response from Make.com
    function parseHebrewMOTResponse(responseText, originalPayload) {
      console.log('🔍 Parsing Hebrew MOT response:', responseText);
      
      const carData = {
        // Basic data from original payload
        plate: originalPayload.plate,
        owner: originalPayload.owner,
        date: originalPayload.date,
        location: originalPayload.location,
        case_id: `YC-${originalPayload.plate}-${new Date().getFullYear()}`,
        
        // Default values to be extracted
        manufacturer: '',
        model: '',
        year: '',
        chassis: '',
        engine_volume: '',
        fuel_type: '',
        model_code: '',
        engine_model: '',
        drive_type: '',
        office_code: '',
        
        // Meta
        data_source: 'mot_database',
        make_com_processed: true,
        processing_timestamp: new Date().toISOString()
      };
      
      try {
        // Extract plate number (פרטי רכב)
        const plateMatch = responseText.match(/פרטי רכב[:\s]*(\d+)/);
        if (plateMatch) carData.plate = plateMatch[1];
        
        // Extract manufacturer (שם היצרן)
        const manufacturerMatch = responseText.match(/שם היצרן[:\s]*([^\n\r]+)/);
        if (manufacturerMatch) carData.manufacturer = manufacturerMatch[1].trim();
        
        // Extract model (דגם)
        const modelMatch = responseText.match(/דגם[:\s]*([^\n\r]+)/);
        if (modelMatch) carData.model = modelMatch[1].trim();
        
        // Extract model type (סוג דגם)
        const modelTypeMatch = responseText.match(/סוג דגם[:\s]*([^\n\r]+)/);
        if (modelTypeMatch) carData.model_type = modelTypeMatch[1].trim();
        
        // Extract vehicle type (סוג רכב)
        const vehicleTypeMatch = responseText.match(/סוג רכב[:\s]*([^\n\r]+)/);
        if (vehicleTypeMatch) carData.vehicle_type = vehicleTypeMatch[1].trim();
        
        // Extract year (שנת ייצור)
        const yearMatch = responseText.match(/שנת ייצור[:\s]*(\d{2}\/\d{4})/);
        if (yearMatch) {
          const yearFull = yearMatch[1];
          carData.production_date = yearFull;
          carData.year = yearFull.split('/')[1]; // Extract year from MM/YYYY
        }
        
        // Extract chassis (מספר שלדה)
        const chassisMatch = responseText.match(/מספר שלדה[:\s]*([A-Z0-9]+)/);
        if (chassisMatch) carData.chassis = chassisMatch[1];
        
        // Extract owner name (שם בעל הרכב)
        const ownerMatch = responseText.match(/שם בעל הרכב[:\s]*([^\n\r]+)/);
        if (ownerMatch) carData.owner = ownerMatch[1].trim();
        
        // Extract ownership type (סוג בעלות)
        const ownershipMatch = responseText.match(/סוג בעלות[:\s]*([^\n\r]+)/);
        if (ownershipMatch) carData.ownership_type = ownershipMatch[1].trim();
        
        // Extract engine volume (נפח מנוע)
        const engineVolumeMatch = responseText.match(/נפח מנוע[:\s]*(\d+)/);
        if (engineVolumeMatch) carData.engine_volume = engineVolumeMatch[1];
        
        // Extract fuel type (סוג דלק)
        const fuelTypeMatch = responseText.match(/סוג דלק[:\s]*([^\n\r]+)/);
        if (fuelTypeMatch) carData.fuel_type = fuelTypeMatch[1].trim();
        
        // Extract model code (קוד דגם רכב)
        const modelCodeMatch = responseText.match(/קוד דגם רכב[:\s]*([^\n\r]+)/);
        if (modelCodeMatch) carData.model_code = modelCodeMatch[1].trim();
        
        // Extract engine model (דגם מנוע)
        const engineModelMatch = responseText.match(/דגם מנוע[:\s]*([^\n\r]+)/);
        if (engineModelMatch) carData.engine_model = engineModelMatch[1].trim();
        
        // Extract drive type (הנעה)
        const driveTypeMatch = responseText.match(/הנעה[:\s]*([^\n\r]+)/);
        if (driveTypeMatch) carData.drive_type = driveTypeMatch[1].trim();
        
        // Extract location (מיקום)
        const locationMatch = responseText.match(/מיקום[:\s]*([^\n\r]+)/);
        if (locationMatch) carData.location = locationMatch[1].trim();
        
        // Extract office code (קוד משרד התחבורה)
        const officeCodeMatch = responseText.match(/קוד משרד התחבורה[:\s]*([^\n\r]+)/);
        if (officeCodeMatch) carData.office_code = officeCodeMatch[1].trim();
        
        console.log('✅ Parsed Hebrew MOT data:', carData);
        return carData;
        
      } catch (error) {
        console.error('❌ Error parsing Hebrew MOT response:', error);
        return carData; // Return basic data even if parsing fails
      }
    }

    // Check for incoming car data
    function checkForIncomingCarData() {
      console.log('🔍 Checking for incoming car data...');
      
      // Check Make.com car data
      const makeCarData = sessionStorage.getItem('makeCarData');
      if (makeCarData) {
        try {
          const carData = JSON.parse(makeCarData);
          console.log('📋 Found Make.com car data:', carData);
          showCarDetailsFloating(carData);
          return true;
        } catch (e) {
          console.error('Error parsing Make.com car data:', e);
        }
      }
      
      // Check general car data
      const carData = sessionStorage.getItem('carData');
      if (carData) {
        try {
          const data = JSON.parse(carData);
          // Check if this is rich data (has manufacturer, model, etc.) vs basic form data
          if (data.manufacturer || data.model || data.chassis) {
            console.log('📋 Found rich car data:', data);
            showCarDetailsFloating(data);
            return true;
          } else {
            console.log('⚠️ Found only basic form data, waiting for rich data from Make.com');
          }
        } catch (e) {
          console.error('Error parsing car data:', e);
        }
      }
      
      return false;
    }

    // Test floating screen function
    window.testFloatingScreen = function() {
      console.log('🔍 Testing floating screen functionality...');
      
      // Create test data
      const testData = {
        plate: '5785269',
        manufacturer: 'ביואיק',
        model: 'LUCERNE',
        year: '2009',
        owner: 'כרמל כיוף',
        chassis: '1G4HD57258U196450',
        engine_volume: '3791',
        fuel_type: 'בנזין',
        model_type: 'סדאן',
        location: 'UMI חיפה'
      };
      
      // Store test data
      sessionStorage.setItem('makeCarData', JSON.stringify(testData));
      console.log('✅ Test data stored in makeCarData');
      
      // Check if floating screen functions exist
      console.log('🔍 Checking floating screen functions:');
      console.log('- toggleCarDetails:', typeof window.toggleCarDetails);
      console.log('- showCarDetails:', typeof window.showCarDetails);
      console.log('- refreshCarData:', typeof window.refreshCarData);
      
      // Try to show floating screen
      if (typeof window.toggleCarDetails === 'function') {
        console.log('🚀 Opening floating screen via toggleCarDetails...');
        window.toggleCarDetails();
      } else if (typeof window.showCarDetails === 'function') {
        console.log('🚀 Opening floating screen via showCarDetails...');
        window.showCarDetails();
      } else {
        console.log('❌ No floating screen functions available');
        alert('❌ מסך צף לא זמין - קובץ car-details-floating.js לא נטען');
        return;
      }
      
      // Refresh after a delay
      setTimeout(() => {
        if (typeof window.refreshCarData === 'function') {
          console.log('🔄 Refreshing floating screen data...');
          window.refreshCarData();
        }
      }, 1000);
      
      console.log('✅ Floating screen test complete');
    };

    // Function to manually populate floating screen with Make.com data
    window.populateFloatingWithMakeData = function() {
      console.log('🔍 Manually populating floating screen with Make.com data...');
      
      // Create exact Make.com data structure from the screenshot
      const makeComData = {
        plate: '5785269',
        manufacturer: 'ביואיק', 
        model: 'LUCERNE',
        model_type: 'סדאן',
        year: '2009',
        production_date: '05/2009',
        chassis: '1G4HD57258U196450',
        engine_volume: '3791',
        fuel_type: 'בנזין',
        model_code: 'HD572',
        engine_model: '428',
        drive_type: '4X2',
        office_code: '156-11',
        owner: 'כרמל כיוף',
        location: 'UMI חיפה',
        date: new Date().toISOString().split('T')[0],
        case_id: 'YC-5785269-2025',
        data_source: 'make_com_manual_test'
      };
      
      console.log('📋 Make.com data structure:', makeComData);
      
      // Store in sessionStorage with multiple keys
      sessionStorage.setItem('makeCarData', JSON.stringify(makeComData));
      sessionStorage.setItem('carData', JSON.stringify(makeComData));
      
      // Update helper directly if available
      if (typeof window.updateHelper === 'function') {
        try {
          window.updateHelper('car_details', makeComData);
          window.updateHelper('vehicle', makeComData);
          window.updateHelper('meta', {
            plate: makeComData.plate,
            owner_name: makeComData.owner,
            case_id: `YC-${makeComData.plate}-2025`
          });
          console.log('✅ Helper updated with Make.com data');
        } catch (error) {
          console.log('❌ Helper update failed:', error);
        }
      }
      
      // Force refresh floating screen if available
      if (typeof window.refreshCarData === 'function') {
        setTimeout(() => {
          window.refreshCarData();
          console.log('🔄 Floating screen refreshed');
        }, 500);
      }
      
      // Show floating screen
      if (typeof window.toggleCarDetails === 'function') {
        window.toggleCarDetails();
      }
      
      console.log('✅ Make.com data population complete');
    };
  </script>
  <script src="assistant-floating.js"></script>
  <script src="car-details-floating.js"></script>
</body>
</html>
