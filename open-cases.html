<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×¤×ª×™×—×ª ×ª×™×§ ×—×“×©</title>
  <link rel="icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" type="image/webp" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Assistant&display=swap" />
  <style>
    body {
      font-family: 'Assistant', sans-serif;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: #f3f6fb;
      padding: 30px;
    }
    .container {
      max-width: 480px;
      background: white;
      padding: 40px 30px;
      border-radius: 16px;
      text-align: center;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      width: 100%;
    }
    .logo {
      margin-bottom: 20px;
    }
    .logo img {
      width: 120px;
      opacity: 0.8;
    }
    .title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .subtitle {
      font-size: 18px;
      color: #666;
      margin-bottom: 20px;
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border-radius: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    .footer {
      margin-top: 30px;
      font-size: 12px;
      color: #999;
    }
    .error {
      color: red;
      text-align: center;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .success {
      color: green;
      text-align: center;
      font-size: 14px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo" />
    </div>
    <div class="title">×™×¨×•×Ÿ ×›×™×•×£ - ×¤×ª×™×—×ª ×ª×™×§ ×—×“×©</div>
    <div class="subtitle">×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</div>
    <div id="err" class="error"></div>
    <div id="feedback" class="success" style="display:none;"></div>

    <input id="plate" type="text" placeholder="××¡×¤×¨ ×¨×›×‘" />
    <input id="owner" type="text" placeholder="×©× ×‘×¢×œ ×”×¨×›×‘" />
    <input id="date" type="date" />
    <input id="location" type="text" placeholder="××§×•× ×‘×“×™×§×”" />

    <button id="submitBtn">×¤×ª×— ×ª×™×§</button>
    
    <!-- Return button -->
    <button onclick="window.location.href='selection.html'" style="background: #6c757d; color: white; width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 10px; font-size: 16px; cursor: pointer;">×—×–×•×¨ ×œ×“×£ ×”×‘×—×™×¨×”</button>
    
    <!-- Debug button -->
    <button onclick="window.location.href='helper-debug-test.html'" style="background: #ffc107; color: black; width: 100%; padding: 8px; margin-top: 5px; border: none; border-radius: 10px; font-size: 14px; cursor: pointer;">ğŸ”§ ×“×£ ×‘×“×™×§×•×ª ××¢×¨×›×ª</button>
    
    <!-- Test floating screen button -->
    <button onclick="testFloatingScreen()" style="background: #17a2b8; color: white; width: 100%; padding: 8px; margin-top: 5px; border: none; border-radius: 10px; font-size: 14px; cursor: pointer;">ğŸ“± ×‘×“×™×§×ª ××¡×š ×¦×£</button>
    
    <!-- Direct Make.com data test -->
    <button onclick="populateFloatingWithMakeData()" style="background: #dc3545; color: white; width: 100%; padding: 8px; margin-top: 5px; border: none; border-radius: 10px; font-size: 14px; cursor: pointer;">ğŸš— ×‘×“×™×§×ª × ×ª×•× ×™ Make.com</button>
    
    <!-- SessionStorage debugging buttons -->
    <button onclick="debugSessionStorage()" style="background: #6f42c1; color: white; width: 100%; padding: 8px; margin-top: 5px; border: none; border-radius: 10px; font-size: 14px; cursor: pointer;">ğŸ” ×‘×“×™×§×ª SessionStorage</button>
    
    <button onclick="populateSessionStorageWithScreenshotData()" style="background: #fd7e14; color: white; width: 100%; padding: 8px; margin-top: 5px; border: none; border-radius: 10px; font-size: 14px; cursor: pointer;">ğŸ“¸ ××™×œ×•×™ × ×ª×•× ×™ ×¦×™×œ×•× ××¡×š</button>
    
    <button onclick="validateSessionStorageData()" style="background: #20c997; color: white; width: 100%; padding: 8px; margin-top: 5px; border: none; border-radius: 10px; font-size: 14px; cursor: pointer;">âœ… ××™××•×ª ×©×œ××•×ª × ×ª×•× ×™×</button>
    
    <!-- Success message and continue button (hidden initially) -->
    <div id="successSection" style="display: none; margin-top: 20px;">
      <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 15px; margin-bottom: 15px; color: #155724;">
        ğŸš˜ ×ª×™×§ × ×¤×ª×— ×‘×”×¦×œ×—×” âœ…
      </div>
      <button id="continueBtn" style="background: #28a745; width: 100%;">×”××©×š ×œ××™×œ×•×™ ×¤×¨×˜×™× ×›×œ×œ×™×™×</button>
    </div>

    <div class="footer">All Rights Reserved @ Carmel Cayouf </div>
  </div>

  <script type="module">
    import { sendToWebhook } from './webhook.js';
    import { encryptPassword, decryptPassword } from './auth.js';
    import './make-webhook-simulator.js';
    
    // Initialize page
    document.getElementById("date").value = new Date().toISOString().split("T")[0];

    const encryptedPassword = sessionStorage.getItem("auth");
    if (!encryptedPassword) {
      alert("×’×™×©×” ×—×¡×•××”. ×”×ª×—×‘×¨ ×§×•×“× ×“×¨×š ×”×“×£ ×”×¨××©×™.");
      window.location.href = "index.html";
    }

    // Handle async password decryption properly
    let password = null;
    (async () => {
      try {
        password = await decryptPassword(encryptedPassword);
        console.log('âœ… Password decrypted successfully');
        
        // Store password for prefill system
        sessionStorage.setItem('prefillPassword', password);
        console.log('ğŸ”‘ Password stored for prefill system');
        
      } catch (error) {
        console.error('âŒ Password decryption failed:', error);
        alert("×©×’×™××” ×‘×¤×¢× ×•×— ×”×¡×™×¡××”");
        window.location.href = "index.html";
      }
    })();

    document.getElementById("submitBtn").addEventListener("click", async function () {
      const plate = document.getElementById("plate").value.trim();
      const owner = document.getElementById("owner").value.trim();
      const date = document.getElementById("date").value.trim();
      const location = document.getElementById("location").value.trim();

      if (!plate || !owner || !date || !location) {
        document.getElementById("err").innerText = "× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª";
        return;
      }

      // Ensure password is available
      if (!password) {
        try {
          password = await decryptPassword(encryptedPassword);
        } catch (error) {
          document.getElementById("err").innerText = "×©×’×™××” ×‘×¤×¢× ×•×— ×”×¡×™×¡××”";
          return;
        }
      }

      const payload = {
        plate,
        owner,
        date,
        location,
        password
      };

      try {
        document.getElementById("err").innerText = "";
        document.getElementById("feedback").style.display = "none";
        
        // Show loading state
        document.getElementById("submitBtn").disabled = true;
        document.getElementById("submitBtn").innerText = "×©×•×œ×— ×‘×§×©×”...";
        
        // Send webhook and wait for response
        console.log('ğŸŒ Sending case data to Make.com webhook...');
        const webhookResponse = await sendToWebhook('OPEN_CASE_UI', payload);
        console.log('ğŸ“¥ Make.com webhook response:', webhookResponse);
        console.log('ğŸ“¥ Make.com response type:', typeof webhookResponse);
        console.log('ğŸ“¥ Make.com response stringified:', JSON.stringify(webhookResponse, null, 2));
        
        const encryptedPassword = await encryptPassword(payload.password);
        const encryptedPayload = JSON.stringify({
          ...payload,
          password: encryptedPassword
        });
        sessionStorage.setItem("carData", encryptedPayload);
        
        document.getElementById("feedback").innerText = "×”×‘×§×©×” × ×©×œ×—×” ×‘×”×¦×œ×—×”";
        document.getElementById("feedback").style.display = "block";
        
        // ENHANCED: Process webhook response for car data
        console.log('ğŸ“‹ Processing webhook response for car details...');
        
        // Store ANY webhook response for debugging
        sessionStorage.setItem('lastWebhookResponse', JSON.stringify(webhookResponse));
        
        // ENHANCED: Store the original payload data immediately with office code
        const initialCaseData = {
          plate: payload.plate,
          owner: payload.owner,
          date: payload.date,
          location: payload.location,
          case_id: `YC-${payload.plate}-${new Date().getFullYear()}`,
          data_source: 'make_com_webhook',
          webhook_response: webhookResponse,
          // Add office code if available in webhook response
          office_code: webhookResponse?.office_code || webhookResponse?.['×§×•×“ ××©×¨×“ ×”×ª×—×‘×•×¨×”'] || '',
          processing_timestamp: new Date().toISOString()
        };
        
        // Store with comprehensive logging
        sessionStorage.setItem('makeCarData', JSON.stringify(initialCaseData));
        console.log('ğŸ’¾ Initial case data stored in makeCarData:', initialCaseData);
        
        // Also update helper immediately with basic data
        if (typeof window.updateHelper === 'function') {
          try {
            window.updateHelper('car_details', initialCaseData);
            window.updateHelper('vehicle', initialCaseData);
            window.updateHelper('meta', {
              plate: initialCaseData.plate,
              case_id: initialCaseData.case_id,
              owner_name: initialCaseData.owner
            });
            console.log('âœ… Helper updated with initial case data');
          } catch (error) {
            console.log('âŒ Helper update failed:', error);
          }
        }
        
        // Always show floating screen with at least the basic data
        console.log('ğŸš— Showing floating screen with received data...');
        showCarDetailsFloating({
          plate: payload.plate,
          owner: payload.owner,
          date: payload.date,
          location: payload.location,
          manufacturer: '×˜×•×¢×Ÿ ××‘×¡×™×¡ × ×ª×•× ×™×...',
          model: '×˜×•×¢×Ÿ ××‘×¡×™×¡ × ×ª×•× ×™×...',
          data_source: 'make_com_immediate'
        });
        
        // Process specific response types
        if (webhookResponse && typeof webhookResponse === 'object') {
          // Check if response contains car details
          if (webhookResponse.car_details || webhookResponse.vehicle_data || webhookResponse.vehicle) {
            const carDetailsFromWebhook = webhookResponse.car_details || webhookResponse.vehicle_data || webhookResponse.vehicle;
            console.log('ğŸš— Car details found in webhook response:', carDetailsFromWebhook);
            
            // Store rich car data from Make.com
            sessionStorage.setItem('makeCarData', JSON.stringify(carDetailsFromWebhook));
            
            // Update helper immediately
            if (typeof window.updateHelper === 'function') {
              window.updateHelper('car_details', carDetailsFromWebhook);
              window.updateHelper('vehicle', carDetailsFromWebhook);
              window.updateHelper('meta', { 
                plate: carDetailsFromWebhook.plate || payload.plate,
                owner_name: carDetailsFromWebhook.owner || payload.owner
              });
            }
            
            // Refresh floating screen with rich data
            setTimeout(() => showCarDetailsFloating(carDetailsFromWebhook), 500);
          }
          
          // Check if response contains Hebrew text body (like from your screenshot)
          else if (webhookResponse.Body && typeof webhookResponse.Body === 'string' && 
                   webhookResponse.Body.includes('×¤×¨×˜×™ ×¨×›×‘')) {
            console.log('ğŸš— Hebrew MOT data found in webhook Body, parsing...');
            const parsedCarData = parseHebrewMOTResponse(webhookResponse.Body, payload);
            
            // ENHANCED: Store with comprehensive logging and validation
            sessionStorage.setItem('makeCarData', JSON.stringify(parsedCarData));
            console.log('ğŸ’¾ Hebrew MOT data stored in makeCarData:', parsedCarData);
            
            // Also store in helper immediately
            if (typeof window.updateHelper === 'function') {
              window.updateHelper('vehicle', parsedCarData);
              window.updateHelper('car_details', parsedCarData);
              console.log('âœ… Helper updated with Hebrew MOT data');
            }
            
            setTimeout(() => showCarDetailsFloating(parsedCarData), 500);
          }
          
          // Check for direct car data in response
          else if (webhookResponse.plate || webhookResponse.manufacturer) {
            console.log('ğŸš— Car data found directly in webhook response:', webhookResponse);
            sessionStorage.setItem('makeCarData', JSON.stringify(webhookResponse));
            setTimeout(() => showCarDetailsFloating(webhookResponse), 500);
          }
          
          // Check any string fields in the response for Hebrew data
          else {
            console.log('ğŸ” Searching for Hebrew data in webhook response fields...');
            for (const [key, value] of Object.entries(webhookResponse)) {
              if (typeof value === 'string' && value.includes('×¤×¨×˜×™ ×¨×›×‘')) {
                console.log(`ğŸš— Hebrew MOT data found in ${key}, parsing...`);
                const parsedCarData = parseHebrewMOTResponse(value, payload);
                sessionStorage.setItem('makeCarData', JSON.stringify(parsedCarData));
                setTimeout(() => showCarDetailsFloating(parsedCarData), 500);
                break;
              }
            }
          }
        } 
        
        // Check for Hebrew MOT response as string
        else if (typeof webhookResponse === 'string' && webhookResponse.includes('×¤×¨×˜×™ ×¨×›×‘')) {
          console.log('ğŸš— Hebrew MOT data found in string response, parsing...');
          const parsedCarData = parseHebrewMOTResponse(webhookResponse, payload);
          sessionStorage.setItem('makeCarData', JSON.stringify(parsedCarData));
          setTimeout(() => showCarDetailsFloating(parsedCarData), 500);
        }
        
        // Wait for additional data to arrive
        console.log('â³ Setting up continuous data checking...');
        setTimeout(() => {
          checkForIncomingCarData();
        }, 3000);
        
        // Check every 5 seconds for up to 30 seconds
        let checkCount = 0;
        const checkInterval = setInterval(() => {
          checkCount++;
          checkForIncomingCarData();
          
          if (checkCount >= 6) { // 6 * 5 = 30 seconds
            clearInterval(checkInterval);
            console.log('ğŸ” Stopped checking for car data after 30 seconds');
          }
        }, 5000);
        
        // Show success message and continue button
        showSuccessAndContinue();

      } catch (err) {
        document.getElementById("err").innerText = "×©×’×™××” ×‘×©×œ×™×—×”: " + err.message;
        document.getElementById("feedback").style.display = "none";
        
        // Reset button state on error
        document.getElementById("submitBtn").disabled = false;
        document.getElementById("submitBtn").innerText = "×¤×ª×— ×ª×™×§";
      }
    });

    function showSuccessAndContinue() {
      // Hide the form and show success section
      document.getElementById("submitBtn").style.display = "none";
      document.getElementById("successSection").style.display = "block";
      
      // Add continue button functionality
      document.getElementById("continueBtn").addEventListener("click", function() {
        window.location.href = "general_info.html";
      });
    }

    // Show car details floating screen
    function showCarDetailsFloating(carData) {
      console.log('ğŸš— Showing car details floating screen with data:', carData);
      
      // Update helper with rich car data
      if (typeof window.updateHelper === 'function') {
        window.updateHelper('car_details', carData);
        window.updateHelper('vehicle', carData);
        
        // Also update meta with basic info
        window.updateHelper('meta', {
          plate: carData.plate,
          case_id: carData.case_id,
          owner_name: carData.owner
        });
      }
      
      // Show floating screen immediately if available
      if (typeof window.showCarDetails === 'function') {
        window.showCarDetails();
      } else if (typeof window.toggleCarDetails === 'function') {
        window.toggleCarDetails();
      }
      
      // Also trigger any refresh functions that may exist
      if (typeof window.refreshCarData === 'function') {
        setTimeout(() => {
          window.refreshCarData();
        }, 100);
      }
    }

    // ENHANCED: Parse Hebrew MOT response from Make.com with comprehensive field mapping
    function parseHebrewMOTResponse(responseText, originalPayload) {
      console.log('ğŸ” Parsing Hebrew MOT response:', responseText);
      console.log('ğŸ“ Response length:', responseText.length);
      
      const carData = {
        // Basic data from original payload
        plate: originalPayload.plate,
        owner: originalPayload.owner,
        date: originalPayload.date,
        location: originalPayload.location,
        case_id: `YC-${originalPayload.plate}-${new Date().getFullYear()}`,
        
        // Default values to be extracted (English keys)
        manufacturer: '',
        model: '',
        year: '',
        chassis: '',
        engine_volume: '',
        fuel_type: '',
        model_code: '',
        engine_model: '',
        drive_type: '',
        office_code: '',
        model_type: '',
        vehicle_type: '',
        ownership_type: '',
        production_date: '',
        
        // Hebrew field equivalents for compatibility
        ×™×¦×¨×Ÿ: '',
        ×“×’×: '',
        '×©× ×ª ×™×™×¦×•×¨': '',
        '××¡×¤×¨ ×©×œ×“×”': '',
        '× ×¤×— ×× ×•×¢': '',
        '×¡×•×’ ×“×œ×§': '',
        '×§×•×“ ×“×’× ×¨×›×‘': '',
        '×“×’× ×× ×•×¢': '',
        ×”× ×¢×”: '',
        '×§×•×“ ××©×¨×“ ×”×ª×—×‘×•×¨×”': '',
        '×¡×•×’ ×“×’×': '',
        '×¡×•×’ ×¨×›×‘': '',
        '×¡×•×’ ×‘×¢×œ×•×ª': '',
        
        // Meta
        data_source: 'mot_database',
        make_com_processed: true,
        processing_timestamp: new Date().toISOString(),
        raw_response: responseText // Store original for debugging
      };
      
      try {
        // Extract plate number (×¤×¨×˜×™ ×¨×›×‘)
        const plateMatch = responseText.match(/×¤×¨×˜×™ ×¨×›×‘[:\s]*(\d+)/);
        if (plateMatch) carData.plate = plateMatch[1];
        
        // Enhanced field extraction with dual assignment (English + Hebrew keys)
        const fieldMappings = [
          // [Hebrew pattern, English key, Hebrew key]
          [/×©× ×”×™×¦×¨×Ÿ[:\s]*([^\n\r]+)/, 'manufacturer', '×™×¦×¨×Ÿ'],
          [/×“×’×[:\s]*([^\n\r]+)/, 'model', '×“×’×'],
          [/×¡×•×’ ×“×’×[:\s]*([^\n\r]+)/, 'model_type', '×¡×•×’ ×“×’×'],
          [/×¡×•×’ ×¨×›×‘[:\s]*([^\n\r]+)/, 'vehicle_type', '×¡×•×’ ×¨×›×‘'],
          [/×©× ×ª ×™×™×¦×•×¨[:\s]*([^\n\r]+)/, 'production_date', '×©× ×ª ×™×™×¦×•×¨'],
          [/××¡×¤×¨ ×©×œ×“×”[:\s]*([A-Z0-9]+)/, 'chassis', '××¡×¤×¨ ×©×œ×“×”'],
          [/×©× ×‘×¢×œ ×”×¨×›×‘[:\s]*([^\n\r]+)/, 'owner', null],
          [/×¡×•×’ ×‘×¢×œ×•×ª[:\s]*([^\n\r]+)/, 'ownership_type', '×¡×•×’ ×‘×¢×œ×•×ª'],
          [/× ×¤×— ×× ×•×¢[:\s]*(\d+)/, 'engine_volume', '× ×¤×— ×× ×•×¢'],
          [/×¡×•×’ ×“×œ×§[:\s]*([^\n\r]+)/, 'fuel_type', '×¡×•×’ ×“×œ×§'],
          [/×“×’× ×× ×•×¢[:\s]*([^\n\r]+)/, 'engine_model', '×“×’× ×× ×•×¢'],
          [/×”× ×¢×”[:\s]*([^\n\r]+)/, 'drive_type', '×”× ×¢×”'],
          [/××™×§×•×[:\s]*([^\n\r]+)/, 'location', null],
          [/×§×•×“ ××©×¨×“ ×”×ª×—×‘×•×¨×”[:\s]*([^\n\r]+)/, 'office_code', '×§×•×“ ××©×¨×“ ×”×ª×—×‘×•×¨×”'],
          // Handle both possible model code patterns
          [/(?:×§×•×“ ×“×’× ×¨×›×‘|××¡×¤×¨ ×“×’× ×”×¨×›×‘)[:\s]*([^\n\r]+)/, 'model_code', '××¡×¤×¨ ×“×’× ×”×¨×›×‘']
        ];
        
        // Apply all field mappings
        fieldMappings.forEach(([pattern, englishKey, hebrewKey]) => {
          const match = responseText.match(pattern);
          if (match && match[1]) {
            const value = match[1].trim();
            carData[englishKey] = value;
            if (hebrewKey) {
              carData[hebrewKey] = value;
            }
            
            // Special handling for model code - also set as universal_code
            if (englishKey === 'model_code') {
              carData.universal_code = value;
              carData['×§×•×“ ×“×’× ×¨×›×‘'] = value; // Also set alternative Hebrew key
            }
          }
        });
        
        // Extract year from production_date if needed
        if (carData.production_date && carData.production_date.includes('/')) {
          carData.year = carData.production_date.split('/')[1];
        }
        
        console.log('âœ… Parsed Hebrew MOT data with enhanced field mapping:', carData);
        console.log('ğŸ“Š Extracted fields count:', Object.keys(carData).filter(key => carData[key] && carData[key] !== '').length);
        return carData;
        
      } catch (error) {
        console.error('âŒ Error parsing Hebrew MOT response:', error);
        return carData; // Return basic data even if parsing fails
      }
    }

    // Check for incoming car data
    function checkForIncomingCarData() {
      console.log('ğŸ” Checking for incoming car data...');
      
      // Check Make.com car data
      const makeCarData = sessionStorage.getItem('makeCarData');
      if (makeCarData) {
        try {
          const carData = JSON.parse(makeCarData);
          console.log('ğŸ“‹ Found Make.com car data:', carData);
          showCarDetailsFloating(carData);
          return true;
        } catch (e) {
          console.error('Error parsing Make.com car data:', e);
        }
      }
      
      // Check general car data
      const carData = sessionStorage.getItem('carData');
      if (carData) {
        try {
          const data = JSON.parse(carData);
          // Check if this is rich data (has manufacturer, model, etc.) vs basic form data
          if (data.manufacturer || data.model || data.chassis) {
            console.log('ğŸ“‹ Found rich car data:', data);
            showCarDetailsFloating(data);
            return true;
          } else {
            console.log('âš ï¸ Found only basic form data, waiting for rich data from Make.com');
          }
        } catch (e) {
          console.error('Error parsing car data:', e);
        }
      }
      
      return false;
    }

    // Test floating screen function
    window.testFloatingScreen = function() {
      console.log('ğŸ” Testing floating screen functionality...');
      
      // Create test data
      const testData = {
        plate: '5785269',
        manufacturer: '×‘×™×•××™×§',
        model: 'LUCERNE',
        year: '2009',
        owner: '×›×¨××œ ×›×™×•×£',
        chassis: '1G4HD57258U196450',
        engine_volume: '3791',
        fuel_type: '×‘× ×–×™×Ÿ',
        model_type: '×¡×“××Ÿ',
        location: 'UMI ×—×™×¤×”'
      };
      
      // Store test data
      sessionStorage.setItem('makeCarData', JSON.stringify(testData));
      console.log('âœ… Test data stored in makeCarData');
      
      // Check if floating screen functions exist
      console.log('ğŸ” Checking floating screen functions:');
      console.log('- toggleCarDetails:', typeof window.toggleCarDetails);
      console.log('- showCarDetails:', typeof window.showCarDetails);
      console.log('- refreshCarData:', typeof window.refreshCarData);
      
      // Try to show floating screen
      if (typeof window.toggleCarDetails === 'function') {
        console.log('ğŸš€ Opening floating screen via toggleCarDetails...');
        window.toggleCarDetails();
      } else if (typeof window.showCarDetails === 'function') {
        console.log('ğŸš€ Opening floating screen via showCarDetails...');
        window.showCarDetails();
      } else {
        console.log('âŒ No floating screen functions available');
        alert('âŒ ××¡×š ×¦×£ ×œ× ×–××™×Ÿ - ×§×•×‘×¥ car-details-floating.js ×œ× × ×˜×¢×Ÿ');
        return;
      }
      
      // Refresh after a delay
      setTimeout(() => {
        if (typeof window.refreshCarData === 'function') {
          console.log('ğŸ”„ Refreshing floating screen data...');
          window.refreshCarData();
        }
      }, 1000);
      
      console.log('âœ… Floating screen test complete');
    };

    // Function to manually populate floating screen with Make.com data
    window.populateFloatingWithMakeData = function() {
      console.log('ğŸ” Manually populating floating screen with Make.com data...');
      
      // Create exact Make.com data structure from the screenshot
      const makeComData = {
        plate: '5785269',
        manufacturer: '×‘×™×•××™×§', 
        model: 'LUCERNE',
        model_type: '×¡×“××Ÿ',
        year: '2009',
        production_date: '05/2009',
        chassis: '1G4HD57258U196450',
        engine_volume: '3791',
        fuel_type: '×‘× ×–×™×Ÿ',
        model_code: 'HD572',
        '××¡×¤×¨ ×“×’× ×”×¨×›×‘': 'HD572', // From Make.com - universal code field
        universal_code: 'HD572', // This is universal, not Levi-specific
        engine_model: '428',
        drive_type: '4X2',
        office_code: '156-11',
        owner: '×›×¨××œ ×›×™×•×£',
        location: 'UMI ×—×™×¤×”',
        date: new Date().toISOString().split('T')[0],
        case_id: 'YC-5785269-2025',
        data_source: 'make_com_manual_test'
      };
      
      console.log('ğŸ“‹ Make.com data structure:', makeComData);
      
      // Store in sessionStorage with multiple keys
      sessionStorage.setItem('makeCarData', JSON.stringify(makeComData));
      sessionStorage.setItem('carData', JSON.stringify(makeComData));
      
      // Update helper directly if available
      if (typeof window.updateHelper === 'function') {
        try {
          window.updateHelper('car_details', makeComData);
          window.updateHelper('vehicle', makeComData);
          window.updateHelper('meta', {
            plate: makeComData.plate,
            owner_name: makeComData.owner,
            case_id: `YC-${makeComData.plate}-2025`
          });
          console.log('âœ… Helper updated with Make.com data');
        } catch (error) {
          console.log('âŒ Helper update failed:', error);
        }
      }
      
      // Force refresh floating screen if available
      if (typeof window.refreshCarData === 'function') {
        setTimeout(() => {
          window.refreshCarData();
          console.log('ğŸ”„ Floating screen refreshed');
        }, 500);
      }
      
      // Show floating screen
      if (typeof window.toggleCarDetails === 'function') {
        window.toggleCarDetails();
      }
      
      console.log('âœ… Make.com data population complete');
    };
  </script>
  <script src="assistant-floating.js"></script>
  <script src="car-details-floating.js"></script>
  <script src="sessionStorage-debug.js"></script>
</body>
</html>
