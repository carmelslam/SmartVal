<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Cloudinary Fetch Diagnosis</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      direction: rtl;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 2px solid #ccc;
      border-radius: 5px;
      background: #f9f9f9;
    }
    .test-section h3 {
      margin-top: 0;
      color: #333;
    }
    button {
      background: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #0056b3;
    }
    .result {
      margin-top: 15px;
      padding: 15px;
      border-radius: 5px;
      direction: ltr;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 12px;
    }
    .success {
      background: #d4edda;
      border: 2px solid #28a745;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      border: 2px solid #dc3545;
      color: #721c24;
    }
    .warning {
      background: #fff3cd;
      border: 2px solid #ffc107;
      color: #856404;
    }
    .info {
      background: #d1ecf1;
      border: 2px solid #17a2b8;
      color: #0c5460;
    }
    img {
      max-width: 100%;
      margin-top: 10px;
      border: 2px solid #ddd;
    }
    .url-display {
      background: #fff;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 3px;
      word-break: break-all;
      margin: 10px 0;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <h1>ğŸ” ××‘×—×•×Ÿ ×‘×¢×™×™×ª Cloudinary Fetch</h1>
  <p><strong>××˜×¨×”:</strong> ×œ×–×”×•×ª ×œ××” Cloudinary ××—×–×™×¨ 401 Unauthorized</p>

  <!-- Test 1: Known public image -->
  <div class="test-section">
    <h3>Test 1: ×‘×“×™×§×ª Fetch ××ª××•× ×” ×¦×™×‘×•×¨×™×ª ×™×“×•×¢×”</h3>
    <p>×‘×•×“×§ ×× Cloudinary Fetch ×¢×•×‘×“ ×‘×›×œ×œ ×¢× ×ª××•× ×” ×¦×™×‘×•×¨×™×ª ×™×“×•×¢×” (Unsplash)</p>
    <button onclick="testPublicImageFetch()">ğŸ§ª ×‘×“×•×§ Fetch ×-Unsplash</button>
    <div id="test1Result"></div>
  </div>

  <!-- Test 2: Direct Supabase access -->
  <div class="test-section">
    <h3>Test 2: ×’×™×©×” ×™×©×™×¨×” ×œ-Supabase (×œ×œ× Cloudinary)</h3>
    <p>×‘×•×“×§ ×× ×”×ª××•× ×” ×‘-Supabase × ×’×™×©×” ×œ×œ× ×”×’×‘×œ×•×ª CORS</p>
    <button onclick="testDirectSupabaseAccess()">ğŸ”— ×‘×“×•×§ ×’×™×©×” ×™×©×™×¨×”</button>
    <div id="test2Result"></div>
  </div>

  <!-- Test 3: Cloudinary account type check -->
  <div class="test-section">
    <h3>Test 3: ×‘×“×™×§×ª ×”×’×“×¨×•×ª Cloudinary</h3>
    <p>×‘×•×“×§ ×× ×—×©×‘×•×Ÿ Cloudinary ××•×’×“×¨ × ×›×•×Ÿ</p>
    <button onclick="testCloudinaryConfig()">âš™ï¸ ×‘×“×•×§ ×”×’×“×¨×•×ª</button>
    <div id="test3Result"></div>
  </div>

  <!-- Test 4: Alternative - Use signed URLs -->
  <div class="test-section">
    <h3>Test 4: ×¤×ª×¨×•×Ÿ ×—×œ×•×¤×™ - Signed URLs</h3>
    <p>×× Fetch ×œ× ×¢×•×‘×“, ××¤×©×¨ ×œ×”×©×ª××© ×‘-Signed URLs ×-Supabase</p>
    <button onclick="testSignedUrlApproach()">ğŸ” ×‘×“×•×§ Signed URL</button>
    <div id="test4Result"></div>
  </div>

  <script type="module">
    const CLOUDINARY_CONFIG = {
      cloudName: 'dwl9x9acl',
      fetchBaseUrl: 'https://res.cloudinary.com/dwl9x9acl/image/fetch/'
    };

    const SUPABASE_URL = 'https://nvqrptokmwdhvpiufrad.supabase.co/storage/v1/object/public/originals/case-c52af5d6-3b78-47b8-88a2-d2553ee3e1af/damage/20251121_152321_10B46889-5D09-4593-B544-801735454E96_1_105_c.jpeg';

    // Test 1: Fetch from known public source
    window.testPublicImageFetch = async function() {
      const resultDiv = document.getElementById('test1Result');
      resultDiv.className = 'result info';
      resultDiv.textContent = '×‘×•×“×§...';

      try {
        // Use a known public image from Unsplash
        const publicImageUrl = 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4';
        const transformations = 'w_400,h_300,c_fill';
        const encodedUrl = encodeURIComponent(publicImageUrl);
        const cloudinaryUrl = `${CLOUDINARY_CONFIG.fetchBaseUrl}${transformations}/${encodedUrl}`;

        console.log('ğŸ§ª Testing with public image:', cloudinaryUrl);

        const response = await fetch(cloudinaryUrl, { method: 'HEAD' });

        if (response.ok) {
          resultDiv.className = 'result success';
          resultDiv.innerHTML = `
âœ… Cloudinary Fetch ×¢×•×‘×“ ×ª×§×™×Ÿ!

×–×” ××•××¨ ×©×”×—×©×‘×•×Ÿ ×©×œ×š ×ª×•××š ×‘-Fetch.
×”×‘×¢×™×” ×”×™× ×¡×¤×¦×™×¤×™×ª ×œ×“×•××™×™×Ÿ ×©×œ Supabase.

Test URL:
<div class="url-display">${cloudinaryUrl}</div>

Status: ${response.status} ${response.statusText}

<a href="${cloudinaryUrl}" target="_blank">ğŸ”— ×¤×ª×— ×ª××•× ×”</a>

<img src="${cloudinaryUrl}" alt="Test Image">

âœ… ×”××¡×§× ×”: Cloudinary Fetch ×¤×¢×™×œ, ××‘×œ ×“×•××™×™×Ÿ Supabase ×¢×“×™×™×Ÿ ×—×¡×•×.
          `;
        } else {
          resultDiv.className = 'result error';
          resultDiv.innerHTML = `
âŒ Cloudinary Fetch ×œ× ×¢×•×‘×“ ×‘×›×œ×œ!

Status: ${response.status} ${response.statusText}

×–×” ××•××¨ ×©××—×ª ××”××¤×©×¨×•×™×•×ª:
1. ×—×©×‘×•×Ÿ Cloudinary Free ×œ× ×ª×•××š ×‘-Fetch
2. Fetch ×œ× ××•×¤×¢×œ ×‘×”×’×“×¨×•×ª
3. ×¦×¨×™×š ×—×©×‘×•×Ÿ ×‘×ª×©×œ×•×

×¤×ª×¨×•×Ÿ ××¤×©×¨×™:
â†’ ×¢×‘×•×¨ ×œ-Test 4 ×œ×¤×ª×¨×•×Ÿ ×—×œ×•×¤×™ ×¢× Signed URLs
          `;
        }
      } catch (error) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = `
âŒ ×©×’×™××”: ${error.message}

×–×” ×¢×©×•×™ ×œ×”×¦×‘×™×¢ ×¢×œ ×‘×¢×™×™×ª ×¨×©×ª ××• ×”×’×“×¨×•×ª CORS.
        `;
      }
    };

    // Test 2: Direct Supabase access
    window.testDirectSupabaseAccess = async function() {
      const resultDiv = document.getElementById('test2Result');
      resultDiv.className = 'result info';
      resultDiv.textContent = '×‘×•×“×§ ×’×™×©×” ×œ-Supabase...';

      try {
        const response = await fetch(SUPABASE_URL);

        if (response.ok) {
          const blob = await response.blob();
          const objectUrl = URL.createObjectURL(blob);

          resultDiv.className = 'result success';
          resultDiv.innerHTML = `
âœ… Supabase × ×’×™×© ×œ×—×œ×•×˜×™×Ÿ!

URL: ${SUPABASE_URL}
Status: ${response.status} ${response.statusText}
Content-Type: ${response.headers.get('content-type')}
Size: ${(blob.size / 1024).toFixed(2)} KB

CORS Headers:
- Access-Control-Allow-Origin: ${response.headers.get('access-control-allow-origin') || '×œ× ×§×™×™×'}

<img src="${objectUrl}" alt="Supabase Image">

âœ… ×”××¡×§× ×”: Supabase ×ª×§×™×Ÿ, ×”×‘×¢×™×” ×”×™× ×‘×”×’×“×¨×•×ª Cloudinary.
          `;
        } else {
          resultDiv.className = 'result error';
          resultDiv.innerHTML = `
âŒ ×œ× ××¦×œ×™×— ×œ×’×©×ª ×œ-Supabase!

Status: ${response.status} ${response.statusText}

×‘×“×•×§:
1. ×”×× ×”-bucket 'originals' public?
2. ×”×× ×”×¤×•×œ×™×¡×™×•×ª ×‘××§×•×?
          `;
        }
      } catch (error) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = `
âŒ ×©×’×™××”: ${error.message}

×™×™×ª×›×Ÿ ×‘×¢×™×™×ª CORS ××• ×¨×©×ª.
        `;
      }
    };

    // Test 3: Check Cloudinary configuration
    window.testCloudinaryConfig = function() {
      const resultDiv = document.getElementById('test3Result');

      resultDiv.className = 'result warning';
      resultDiv.innerHTML = `
âš™ï¸ ×‘×“×™×§×ª ×”×’×“×¨×•×ª Cloudinary

Cloud Name: ${CLOUDINARY_CONFIG.cloudName}
Fetch Base URL: ${CLOUDINARY_CONFIG.fetchBaseUrl}

ğŸ“‹ ×¨×©×™××ª ×‘×“×™×§×•×ª ×©×¦×¨×™×š ×œ×¢×©×•×ª ×‘-Cloudinary Dashboard:

1ï¸âƒ£ Settings â†’ Security â†’ Allowed fetch domains
   âœ“ ×”×•×¡×£: nvqrptokmwdhvpiufrad.supabase.co
   âœ“ ××•: * (allow all - ×œ× ××•××œ×¥ ×œ×¤×¨×•×“×§×©×Ÿ)

2ï¸âƒ£ Settings â†’ Upload â†’ Auto Upload Mapping
   âœ“ ×‘×“×•×§ ×× ×¦×¨×™×š ×œ×”×•×¡×™×£ mapping

3ï¸âƒ£ Account Details
   âœ“ ×‘×“×•×§ ××™×–×” ×ª×•×›× ×™×ª ×™×© ×œ×š (Free/Plus/Advanced)
   âœ“ Fetch feature ×–××™×Ÿ ×¨×§ ×‘×ª×•×›× ×™×•×ª ××¡×•×™××•×ª

4ï¸âƒ£ Settings â†’ Security â†’ Fetch images
   âœ“ ×•×•×“× ×©×”××¤×©×¨×•×ª ××¡×•×× ×ª

âš ï¸ ×œ××—×¨ ×©×™× ×•×™×™× ×‘×”×’×“×¨×•×ª, ×”××ª×Ÿ 2-3 ×“×§×•×ª ×œ×¢×“×›×•×Ÿ.

×× ×¢×“×™×™×Ÿ ×œ× ×¢×•×‘×“ ××—×¨×™ ×›×œ ×”×‘×“×™×§×•×ª:
â†’ ×¢×‘×•×¨ ×œ-Test 4 ×œ×¤×ª×¨×•×Ÿ ×—×œ×•×¤×™
      `;
    };

    // Test 4: Alternative approach with signed URLs
    window.testSignedUrlApproach = function() {
      const resultDiv = document.getElementById('test4Result');

      resultDiv.className = 'result info';
      resultDiv.innerHTML = `
ğŸ” ×¤×ª×¨×•×Ÿ ×—×œ×•×¤×™: Signed URLs (××•××œ×¥!)

×× Cloudinary Fetch ×œ× ×¢×•×‘×“, ×™×© ×©×ª×™ ××¤×©×¨×•×™×•×ª:

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Œ ××¤×©×¨×•×ª 1: Upload ×™×©×™×¨×•×ª ×œ-Cloudinary (××•××œ×¥!)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

×‘××§×•× Fetch, Upload ××ª ×”×ª××•× ×” ×œ-Cloudinary ×‘×–××Ÿ ×”×”×¢×œ××”:

1. ××©×ª××© ××¢×œ×” â†’ Supabase + Cloudinary (×‘××§×‘×™×œ)
2. ×©×•××¨ ××ª ×©× ×™ ×”-URLs ×‘×“××˜××‘×™×™×¡
3. ×¢×•×‘×“ ×¢× Cloudinary URL ×™×©×™×¨×•×ª (×œ× Fetch)

×™×ª×¨×•× ×•×ª:
âœ… ×œ× ×ª×œ×•×™ ×‘-Fetch permissions
âœ… ×˜×¨× ×¡×¤×•×¨××¦×™×•×ª ××”×™×¨×•×ª ×™×•×ª×¨
âœ… ×¢×•×‘×“ ×‘×›×œ ×ª×•×›× ×™×ª Cloudinary

×—×¡×¨×•× ×•×ª:
âŒ ×ª××•× ×•×ª ×××•×—×¡× ×•×ª ×‘×©× ×™ ××§×•××•×ª
âŒ ××©×ª××© quota ×©×œ Cloudinary

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Œ ××¤×©×¨×•×ª 2: Signed URLs ××¨×•×›×•×ª ×-Supabase
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

×× ×¨×•×¦×” ×œ×©××•×¨ ×¨×§ ×‘-Supabase:

1. ×œ×™×¦×•×¨ Signed URL ×¢× expiry ××¨×•×š (1 ×©× ×”)
2. ×œ×”×©×ª××© ×‘×• ×‘-Cloudinary Fetch
3. ×œ×¢×“×›×Ÿ URL ×‘×“××˜××‘×™×™×¡ ×œ×¤× ×™ ×©×¤×’

×™×ª×¨×•× ×•×ª:
âœ… ×ª××•× ×” ×××•×—×¡× ×ª ×¨×§ ×‘-Supabase
âœ… ×¤×—×•×ª × ×™×”×•×œ

×—×¡×¨×•× ×•×ª:
âŒ URLs ×¤×’×™× ×•×™×© ×œ×—×“×© ××•×ª×
âŒ ×¢×“×™×™×Ÿ ×ª×œ×•×™ ×‘-Cloudinary Fetch

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’¡ ×”××œ×™×¥: ××¤×©×¨×•×ª 1 (Upload ×™×©×™×¨×•×ª ×œ-Cloudinary)

×¨×•×¦×” ×©××¢×–×•×¨ ×œ×š ×œ×©× ×•×ª ××ª ×”×§×•×“ ×œ×¢×‘×•×“×” ×¢× Upload ×™×©×™×¨×•×ª?
      `;
    };
  </script>
</body>
</html>
