<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>מוקד נזק - תהליך מלא</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: sans-serif; background: #f8fafc; margin: 0; }
    .container { max-width: 500px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 0 10px #0001; padding: 32px; }
    h2 { margin-top: 0; }
    .actions { margin-top: 24px; display: flex; gap: 12px; }
    button { padding: 10px 18px; border-radius: 8px; border: none; font-size: 16px; cursor: pointer; }
    .add { background: #007bff; color: #fff; }
    .next { background: #28a745; color: #fff; }
    .finish { background: #dc3545; color: #fff; }
    .row { display: flex; gap: 10px; margin-bottom: 10px; }
    .row input, .row select { flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
    .suggestions { position: absolute; background: #fff; border: 1px solid #ccc; z-index: 1000; max-height: 150px; overflow-y: auto; right: 0; left: 0; top: 100%; }
    .suggestions div { padding: 8px; cursor: pointer; }
    .suggestions div:hover { background: #f0f0f0; }
  </style>
  <script src="webhook.js"></script>
</head>
<body>
<div class="container">
  <h2 id="step-title"></h2>
  <form id="bulkForm" onsubmit="return false;">
    <div id="bulk-content"></div>
    <div class="actions">
      <button class="add" type="button" id="addBtn">הוסף</button>
      <button class="next" type="button" id="nextBtn">המשך</button>
      <button class="finish" type="button" id="finishBtn" style="display:none">סיים מוקד נזק</button>
    </div>
  </form>
</div>
<script>
const steps = [
  { key: "description", title: "תיאור מוקד נזק", placeholder: "הזן תיאור...", type: "text" },
  { key: "works", title: "עבודות נדרשות", placeholder: "הזן עבודה...", type: "text" },
  { key: "parts", title: "חלקים נדרשים", placeholder: "שם החלק", type: "part" },
  { key: "repairs", title: "תיקונים נדרשים", placeholder: "הזן תיקון...", type: "text" }
];
let currentStep = 0;
let currentCenter = { description: [], works: [], parts: [], repairs: [] };
let damageCenters = [];

function renderStep() {
  document.getElementById('step-title').innerText = steps[currentStep].title;
  let html = `<div id="items-list"></div>`;
  document.getElementById('bulk-content').innerHTML = html;
  renderRows();
  document.getElementById('addBtn').style.display = '';
  document.getElementById('nextBtn').style.display = (currentStep < steps.length - 1) ? '' : 'none';
  document.getElementById('finishBtn').style.display = (currentStep === steps.length - 1) ? '' : 'none';
}

function renderRows() {
  const key = steps[currentStep].key;
  const items = currentCenter[key];
  const list = document.getElementById('items-list');
  list.innerHTML = '';
  items.forEach((val, idx) => {
    let row = document.createElement('div');
    row.className = 'row';
    if (steps[currentStep].type === "part") {
      row.innerHTML = `
        <div style="flex:2;position:relative;">
          <input type="text" value="${val.name||''}" placeholder="שם החלק" oninput="suggestPart(this,${idx})"/>
          <div class="suggestions"></div>
        </div>
        <input type="text" value="${val.desc||''}" placeholder="תיאור"/>
        <select>
          <option value="">מקור</option>
          <option value="חליפי/מקורי">חליפי/מקורי</option>
          <option value="חליפי/משומש">חליפי/משומש</option>
          <option value="חדש מקורי">חדש מקורי</option>
          <option value="חליפי">חליפי</option>
          <option value="משומש">משומש</option>
          <option value="ריק">ריק</option>
        </select>
        <button type="button" onclick="removeRow(${idx})">✕</button>
      `;
      setTimeout(() => {
        row.querySelector("select").value = val.source || "";
        row.querySelector("select").onchange = e => { currentCenter.parts[idx].source = e.target.value; };
        row.querySelectorAll("input")[0].oninput = e => { currentCenter.parts[idx].name = e.target.value; };
        row.querySelectorAll("input")[1].oninput = e => { currentCenter.parts[idx].desc = e.target.value; };
      }, 0);
    } else {
      row.innerHTML = `
        <input type="text" value="${val}" placeholder="${steps[currentStep].placeholder}"/>
        <button type="button" onclick="removeRow(${idx})">✕</button>
      `;
      setTimeout(() => {
        row.querySelector("input").oninput = e => { currentCenter[key][idx] = e.target.value; };
      }, 0);
    }
    list.appendChild(row);
  });
}

window.removeRow = function(idx) {
  const key = steps[currentStep].key;
  currentCenter[key].splice(idx, 1);
  renderRows();
};

document.getElementById('addBtn').onclick = function() {
  const key = steps[currentStep].key;
  if (steps[currentStep].type === "part") {
    currentCenter.parts.push({ name: "", desc: "", source: "" });
  } else {
    currentCenter[key].push("");
  }
  renderRows();
};

document.getElementById('nextBtn').onclick = function() {
  currentStep++;
  renderStep();
};

document.getElementById('finishBtn').onclick = function() {
  // Validate at least one item per bulk
  for (let s of steps) {
    if (!currentCenter[s.key] || currentCenter[s.key].length === 0) {
      alert("יש למלא לפחות שדה אחד בכל מקטע.");
      return;
    }
  }
  damageCenters.push(JSON.parse(JSON.stringify(currentCenter)));
  // Save to helper
  let helper = {};
  try { helper = JSON.parse(sessionStorage.getItem("helper") || '{}'); } catch(e){}
  helper.damage_sections = damageCenters;
  sessionStorage.setItem("helper", JSON.stringify(helper));
  if (confirm("להוסיף מוקד נזק נוסף?")) {
    currentCenter = { description: [], works: [], parts: [], repairs: [] };
    currentStep = 0;
    renderStep();
  } else {
    window.location.href = "expertise-summary.html";
  }
};

// Initial row for each bulk
function ensureInitialRow() {
  const key = steps[currentStep].key;
  if (currentCenter[key].length === 0) {
    if (steps[currentStep].type === "part") {
      currentCenter.parts.push({ name: "", desc: "", source: "" });
    } else {
      currentCenter[key].push("");
    }
  }
}
function stepInit() {
  ensureInitialRow();
  renderStep();
}
window.onload = stepInit;

// --- Parts Suggestion Integration ---
window.suggestPart = function(input, idx) {
  const query = input.value.trim();
  let helper = {};
  try { helper = JSON.parse(sessionStorage.getItem("helper") || '{}'); } catch(e){}
  const car = helper.car_details || {};
  const plate = car.plate || '';
  const manufacturer = car.manufacturer || '';
  const model = car.model || '';
  const year = car.year || '';
  if (!plate || !manufacturer || !model || !year) return;
  const row = input.closest(".row");
  const box = row.querySelector(".suggestions");
  box.innerHTML = "";
  if (query.length < 2) return;
  fetch(window.webhooks.partsSuggest, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ plate, manufacturer, model, year, query })
  })
  .then(res => res.json())
  .then(data => {
    if (!Array.isArray(data)) return;
    data.forEach(suggestion => {
      const item = document.createElement("div");
      item.textContent = suggestion.name || suggestion;
      item.onclick = () => {
        input.value = suggestion.name || suggestion;
        currentCenter.parts[idx].name = suggestion.name || suggestion;
        box.innerHTML = "";
      };
      box.appendChild(item);
    });
  });
};
</script>
</body>
</html>
