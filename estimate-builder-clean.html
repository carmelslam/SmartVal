<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>אומדן נזקי רכב - ירון כיוף</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" type="image/webp">
  <style>
    /* Base Styles - Exact copy from original */
    body {
      font-family: sans-serif;
      background: #f3f6fb;
      margin: 0;
      min-height: 100vh;
      padding: 0;
      padding-top: 90px;
      overflow-x: hidden;
    }
    
    .container {
      width: 100%;
      max-width: 820px;
      min-width: 320px;
      background: #fff;
      padding: 32px 24px 24px 24px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.08);
      margin: 32px auto 32px auto;
      box-sizing: border-box;
    }
    
    .logo {
      display: flex;
      justify-content: center;
      margin-bottom: 8px;
    }
    
    .logo img {
      width: 112px;
      height: auto;
      display: block;
    }
    
    .title { 
      font-size: 27px; 
      font-weight: bold; 
      text-align: center; 
      margin-bottom: 2px; 
      font-weight: 900;
    }
    
    .subtitle { 
      font-size: 23px; 
      color: #666; 
      text-align: center; 
      margin-bottom: 10px;
    }
    
    h1, h2 { 
      color: #1e3a8a; 
      font-size: 25px; 
      text-align: center; 
      margin: 15px 0 8px 0; 
      font-weight: 600;
    }
    
    h3 { 
      color: #1e3a8a; 
      font-size: 22px; 
      margin: 22px 0 12px 0; 
      text-align: right; 
      font-weight: 900;
    }
    
    .form-section {
      width: 100%;
      max-width: 100%;
      margin-bottom: 20px;
      background: #fafbfe;
      border-radius: 12px;
      padding: 17px 15px 12px 15px;
      box-sizing: border-box;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      overflow: hidden;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px 18px;
      width: 100%;
    }
    
    @media (max-width: 600px) {
      .form-grid { 
        grid-template-columns: 1fr; 
      }
      .container {
        width: 98vw;
        max-width: 98vw;
        min-width: 0;
        padding: 14px 2vw 20px 2vw;
      }
    }
    
    label {
      font-size: 18px;
      margin-bottom: 4px;
      display: block;
      text-align: right;
    }
    
    input, select, textarea {
      width: 100%;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 0px;
      padding: 8px 9px;
      box-sizing: border-box;
      text-align: right !important;
      background: #f9f9f9;
      transition: border .15s;
      outline: none;
    }
    
    input:focus, select:focus, textarea:focus {
      border-color: #3b82f6;
    }
    
    input[type="radio"] {
      width: auto;
      margin-left: 10px;
      margin-right: 5px;
    }
    
    .readonly-box {
      background: #f4f6fa;
      border-radius: 6px;
      border: 1px solid #eee;
      padding: 7px 8px;
      min-height: 20px;
      font-size: 16px;
      color: #333;
      text-align: right !important;
    }
    
    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      display: block;
    }
    
    .collapsible-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 1px solid #dee2e6;
      border-radius: 8px;
      text-align: right;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 10px;
    }
    
    .collapsible-btn:hover {
      background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    }

    /* Floating Screens Styling */
    .floating-toggles-top {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 8px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .toggle-square {
      width: 80px;
      height: 70px;
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: white;
      text-align: center;
      border: 2px solid transparent;
    }

    .toggle-square:hover {
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .toggle-square.active {
      border-color: #fbbf24;
      background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
    }

    .toggle-square span:first-child {
      font-size: 24px;
      margin-bottom: 4px;
    }

    .toggle-square span:last-child {
      font-size: 12px;
    }
    
    /* Depreciation Styles */
    #depreciationBulkTable {
      margin-top: 15px;
    }

    #depreciationBulkTable .dep-row {
      display: grid;
      grid-template-columns: 1fr 1fr 120px 120px 80px;
      gap: 14px;
      margin-bottom: 10px;
      align-items: center;
      position: relative;
      padding-bottom: 10px;
    }

    #depreciationBulkTable .dep-row::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: #e5e7eb;
    }

    #depreciationBulkTable .dep-row > div::before {
      font-weight: bold;
      font-size: 12px;
      margin-bottom: 4px;
    }

    #depreciationBulkTable .dep-row > div:nth-child(1)::before {
      content: "החלק הניזוק:";
    }

    #depreciationBulkTable .dep-row > div:nth-child(2)::before {
      content: "מהות התיקון:";
    }

    #depreciationBulkTable .dep-row > div:nth-child(3)::before {
      content: "% ירידת ערך:";
    }

    #depreciationBulkTable .dep-row > div:nth-child(4)::before {
      content: "ערך ב-₪:";
    }

    #depreciationBulkTable .dep-row > div:nth-child(5)::before {
      content: "פעולות:";
    }

    @media (max-width: 600px) {
      #depreciationBulkTable .dep-row {
        grid-template-columns: 1fr;
        gap: 8px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 10px;
      }
      
      #depreciationBulkTable .dep-row > div::before {
        display: block;
      }
    }
    
    /* Damage Center Styles */
    .damage-center-card {
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .damage-center-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e5e7eb;
    }

    .damage-center-header h4 {
      margin: 0;
      color: #1e3a8a;
      font-size: 18px;
    }

    /* Summary Styles */
    .summary-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    @media (max-width: 768px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Floating PDF Styles */
    .floating-pdf-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .floating-pdf-container {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 1200px;
      height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .floating-pdf-header {
      background: #1e3a8a;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    
    .floating-pdf-header h3 {
      margin: 0;
      font-size: 18px;
      color: white;
    }
    
    .floating-pdf-controls {
      display: flex;
      gap: 10px;
    }
    
    .floating-pdf-content {
      flex: 1;
      padding: 0;
      overflow: hidden;
    }

    /* PIP Styles */
    .pip-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 320px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      z-index: 10000;
      display: none;
    }

    .pip-header {
      background: #1e3a8a;
      color: white;
      padding: 10px 15px;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: move;
    }

    .pip-content {
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
    }

    /* Adjustment Row Styles */
    .adjustment-row {
      display: grid;
      grid-template-columns: 2fr 100px 100px 120px 80px;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
    }

    .adjustment-row input,
    .adjustment-row select {
      background: white;
    }

    /* Success/Error Messages */
    .section-message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      z-index: 9999;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }

    .section-message.success {
      background: #10b981;
      color: white;
    }

    .section-message.error {
      background: #ef4444;
      color: white;
    }

    /* Action Buttons Container */
    .action-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }

    .action-buttons .btn {
      padding: 12px 20px;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .action-buttons .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .action-buttons .btn-primary:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .action-buttons .btn-secondary {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    }

    .action-buttons .btn-secondary:hover {
      background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
    }

    .action-buttons .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .action-buttons .btn-success:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
  </style>
</head>
<body>
  <!-- Floating Toggles -->
  <div class="floating-toggles-top">
    <div class="toggle-square" onclick="toggleFloatingScreen('levi')">
      <span>📄</span>
      <span>לוי יצחק</span>
    </div>
    <div class="toggle-square" onclick="toggleFloatingScreen('carDetails')">
      <span>🚗</span>
      <span>פרטי רכב</span>
    </div>
    <div class="toggle-square" onclick="toggleFloatingScreen('parts')">
      <span>🔧</span>
      <span>חלקים</span>
    </div>
    <div class="toggle-square" onclick="toggleFloatingScreen('invoice')">
      <span>📋</span>
      <span>חשבונית</span>
    </div>
  </div>

  <div class="container">
    <div class="logo"><img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo"></div>
    <div class="title">ירון כיוף שמאות - פורטל</div>
    <div class="subtitle">שמאות והערכת נזקי רכב ורכוש</div>
    
    <h1>בניית אומדן נזקי רכב</h1>
    <h2 id="pageTitle">רכב מס. ...</h2>

    <!-- Estimate Type Section -->
    <div class="form-section" id="estimate-type">
      <h3>סוג האומדן</h3>
      <div>
        <label>
          <input type="radio" name="estimate-type" value="אובדן_להלכה" checked> אומדן ראשוני - אובדן להלכה
        </label>
        <label>
          <input type="radio" name="estimate-type" value="טוטלוס"> אומדן ראשוני - טוטלוס
        </label>
      </div>
    </div>

    <!-- Vehicle Data Section -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('vehicleData')">נתוני רכב (הצג/הסתר)</button>
      <div id="vehicleData" style="display:none;">
        <div class="form-grid">
          <div><label>מספר רכב:</label><input type="text" id="carPlate" onchange="updateHelperFromField(event);" /></div>
          <div><label>תוצרת:</label><input type="text" id="carManufacturer" onchange="updateHelperFromField(event);" /></div>
          <div><label>דגם:</label><input type="text" id="carModel" onchange="updateHelperFromField(event);" /></div>
          <div><label>שנת ייצור:</label><input type="text" id="carYear" onchange="updateHelperFromField(event);" /></div>
          <div><label>קוד דגם:</label><input type="text" id="carModelCode" onchange="updateHelperFromField(event);" /></div>
          <div><label>מחיר בסיס:</label><input type="text" id="carBasePrice" onchange="updateHelperFromField(event);" /></div>
          <div><label>ערך השוק של הרכב:</label><input type="text" id="carMarketValue" onchange="updateHelperFromField(event);" /></div>
          <div><label>תאריך הפקה:</label><input type="date" id="carReportDate" onchange="updateHelperFromField(event);" /></div>
        </div>
      </div>
    </div>

    <!-- Contact Data Section -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('contactData')">נתוני התקשרות (הצג/הסתר)</button>
      <div id="contactData" style="display:none;">
        <div class="form-grid">
          <div><label>שם בעל הרכב:</label><input type="text" id="ownerName" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>כתובת בעל הרכב:</label><input type="text" id="ownerAddress" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>טלפון בעל הרכב:</label><input type="text" id="ownerPhone" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>חברת ביטוח:</label><input type="text" id="insuranceCompany" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>אימייל חברת ביטוח:</label><input type="text" id="insuranceEmail" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>סוכן ביטוח:</label><input type="text" id="insuranceAgent" onchange="updateHelperFromContactField(this); triggerFloatingScreenRefresh();" /></div>
          <div><label>טלפון סוכן ביטוח:</label><input type="text" id="agentPhone" onchange="updateHelperFromContactField(this); triggerFloatingScreenRefresh();" /></div>
          <div><label>אימייל סוכן ביטוח:</label><input type="text" id="agentEmail" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>שם מוסך:</label><input type="text" id="garageName" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>טלפון מוסך:</label><input type="text" id="garagePhone" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>אימייל מוסך:</label><input type="text" id="garageEmail" onchange="updateHelperFromContactField(this);" /></div>
        </div>
      </div>
    </div>

    <!-- Damage Centers Summary Section -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('damageCentersSummary')">סיכום מוקדי נזק (הצג/הסתר)</button>
      <div id="damageCentersSummary" style="display:none;">
        <h3>סיכום מוקדי נזק (ניתן לעריכה)</h3>
        <div id="damageCentersContainer"></div>
        <button type="button" class="btn btn-secondary" onclick="addNewDamageCenter()">+ הוסף מוקד נזק חדש</button>
        <button type="button" class="btn btn-primary" onclick="saveDamageCenterChangesWithFeedback()">שמור שינויים במוקדי נזק</button>
      </div>
    </div>

    <!-- Gross Market Value Section -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('grossCalc')">ערך הרכב הגולמי - מאפיינים ועליה לכביש בלבד (הצג/הסתר)</button>
      <div id="grossCalc" style="display:none;">
        <div class="form-grid">
          <div><label>ערך הרכב ע"פ מחירון כולל מע"מ:</label><input type="text" id="basicPrice" placeholder="₪" onchange="updateHelperFromField(event); updateGrossMarketValueCalculation(); updateHelperFromAdjustments();" /></div>
          <div></div>
        </div>
        
        <h4>תוספות מאפיינים</h4>
        <div id="featuresAdjustmentsList"></div>
        <button type="button" class="btn btn-secondary" onclick="addFeatureAdjustment()">+ הוסף מאפיין</button>
        
        <h4>עליה לכביש</h4>
        <div id="registrationAdjustmentsList"></div>
        <button type="button" class="btn btn-secondary" onclick="addRegistrationAdjustment()">+ הוסף עליה לכביש</button>
        
        <div class="summary-grid" style="margin-top: 20px; background: #f0f9ff; padding: 15px; border-radius: 8px;">
          <div>
            <label>ערך גולמי מצטבר:</label>
            <input type="text" id="grossMarketValueField" readonly style="background: white; font-weight: bold;">
          </div>
          <div>
            <label>עדכון ידני של ערך גולמי:</label>
            <input type="text" id="manualGrossValue" placeholder="הכנס ערך ידני" onchange="updateGrossPercentageFromGrossValue()">
          </div>
        </div>
      </div>
    </div>

    <!-- Gross Damage Percentage Section -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('grossPercentageResult')">אחוז הנזק הגולמי - בסיס הרכב בלבד (הצג/הסתר)</button>
      <div id="grossPercentageResult" style="display:none;">
        <div class="form-grid">
          <div>
            <label>סה"כ עלות נזק מוערכת:</label>
            <input type="text" id="totalDamageCost" readonly />
          </div>
          <div>
            <label>ערך הרכב הגולמי:</label>
            <input type="text" id="grossValueDisplay" readonly />
          </div>
          <div>
            <label>אחוז הנזק הגולמי:</label>
            <input type="text" id="grossDamagePercentage" readonly style="font-weight: bold; font-size: 18px; color: #1e3a8a;" />
          </div>
        </div>
      </div>
    </div>

    <!-- Full Market Value Section -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('fullMarketValue')">ערך השוק המלא - כולל גורמי שימוש (הצג/הסתר)</button>
      <div id="fullMarketValue" style="display:none;">
        <h4>התאמות נוספות (גורמי שימוש)</h4>
        <div id="allAdjustmentsList"></div>
        <button type="button" class="btn btn-secondary" onclick="autoPopulateMarketAdjustments()">טען התאמות מדוח לוי</button>
        <button type="button" class="btn btn-secondary" onclick="addFullMarketAdjustment()">+ הוסף התאמה ידנית</button>
        
        <div class="summary-grid" style="margin-top: 20px; background: #f0f9ff; padding: 15px; border-radius: 8px;">
          <div>
            <label>ערך השוק המלא:</label>
            <input type="text" id="fullMarketValueField" readonly style="background: white; font-weight: bold;">
          </div>
          <div>
            <label>סה"כ התאמות:</label>
            <input type="text" id="totalAdjustmentsValue" readonly />
          </div>
        </div>
      </div>
    </div>

    <!-- Depreciation Section -->
    <div class="form-section" id="depreciationSection">
      <button class="collapsible-btn" type="button" onclick="toggleSection('depreciationContent')">חישוב ירידת ערך לפי מוקדי נזק (הצג/הסתר)</button>
      <div id="depreciationContent" style="display:none;">
        <h3>חישוב ירידת ערך לפי מוקדי נזק</h3>
        <div id="depreciationBulkTable"></div>
        <button type="button" class="btn btn-secondary" onclick="addDepField()">+ הוסף שורה</button>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px;">
          <div>
            <label>ירידת ערך כוללת (%):</label>
            <input type="number" id="globalDep1" placeholder="0" onchange="updateGlobalDepreciationCalculation();" />
          </div>
          <div>
            <label>ירידת ערך כוללת (₪):</label>
            <input type="text" id="globalDepValue" readonly />
          </div>
        </div>
        
        <div style="margin-top:14px;">
          <label>ימי מוסך משוערים:</label>
          <input type="number" id="garageDays" placeholder="מספר ימי עבודה" style="width: 200px;" onchange="updateHelperDepreciationField(this, 'work_days_impact');" />
        </div>
        
        <button type="button" class="btn btn-success" onclick="saveDepreciationData()">שמור נתוני ירידת ערך</button>
      </div>
    </div>

    <!-- Claims Data Section -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('priceData')">נתוני תביעה (הצג/הסתר)</button>
      <div id="priceData" style="display:none;">
        <h3>נתוני תביעה</h3>
        <div class="form-grid">
          <div>
            <label>סה"כ תביעה:</label>
            <input type="text" id="totalClaim" readonly />
          </div>
          <div>
            <label>תביעה מאושרת:</label>
            <input type="text" id="authorizedClaim" placeholder="₪" onchange="updateClaimsDataFromField(this, 'authorized_claim');" />
          </div>
          <div>
            <label>ירידת ערך:</label>
            <input type="text" id="depreciationClaim" placeholder="₪" onchange="updateClaimsDataFromField(this, 'depreciation');" />
          </div>
          <div>
            <label>הפרש תביעה:</label>
            <input type="text" id="claimDifference" placeholder="₪" onchange="updateClaimsDataFromField(this, 'claim_difference');" />
          </div>
        </div>
      </div>
    </div>

    <!-- Summary Section -->
    <div class="form-section" style="background: linear-gradient(135deg, #ff8c00 0%, #ff7300 100%); color: white; border-radius: 12px; padding: 20px;">
      <h3 style="color: white; text-align: center; font-size: 24px; margin-bottom: 20px;">סיכום אומדן</h3>
      <div class="summary-grid">
        <div style="text-align: center;">
          <label style="color: #ffe4b5; font-size: 14px;">שווי רכב:</label>
          <div id="sumMarketValue" style="font-size: 28px; font-weight: bold;">₪0</div>
        </div>
        <div style="text-align: center;">
          <label style="color: #ffe4b5; font-size: 14px;">סה״כ תביעה:</label>
          <div id="sumClaim" style="font-size: 28px; font-weight: bold;">₪0</div>
        </div>
        <div style="text-align: center;">
          <label style="color: #ffe4b5; font-size: 14px;">מע״מ:</label>
          <div id="sumVAT" style="font-size: 28px; font-weight: bold;">₪0</div>
        </div>
        <div style="text-align: center;">
          <label style="color: #ffe4b5; font-size: 14px;">סה״כ כולל מע״מ:</label>
          <div id="sumTotalClaim" style="font-size: 28px; font-weight: bold;">₪0</div>
        </div>
        <div style="text-align: center;">
          <label style="color: #ffe4b5; font-size: 14px;">ירידת ערך:</label>
          <div id="depCompensation" style="font-size: 28px; font-weight: bold;">₪0</div>
        </div>
        <div style="text-align: center;">
          <label style="color: #ffe4b5; font-size: 14px;">אחוז הנזק:</label>
          <div id="damagePercentage" style="font-size: 28px; font-weight: bold;">0%</div>
        </div>
      </div>
    </div>

    <!-- Additional Notes Section -->
    <div class="form-section">
      <h3>הערות נוספות לאומדן</h3>
      <textarea id="additional-notes" rows="4" placeholder="הכנס הערות נוספות כאן..." onchange="updateHelperFromField(event);"></textarea>
    </div>

    <!-- Legal Text Section -->
    <div class="form-section" id="legal-text">
      <h3>טקסט משפטי לאומדן</h3>
      <select id="legal-text-selector" onchange="loadLegalTextFromVault();">
        <option value="">בחר טקסט משפטי...</option>
      </select>
      <textarea id="legal-text-content" rows="6" placeholder="הטקסט המשפטי יוטען כאן..." onchange="updateHelperFromField(event);"></textarea>
      <button type="button" class="btn btn-secondary" onclick="resetLegalText()">איפוס טקסט</button>
    </div>

    <!-- Attachments Section -->
    <div class="form-section" id="attachments-section">
      <h3>רשימת נספחים</h3>
      <select id="attachments-selector" onchange="loadAttachmentsFromVault();">
        <option value="">בחר רשימת נספחים...</option>
      </select>
      <textarea id="attachments-list" rows="4" placeholder="רשימת הנספחים תוטען כאן..." onchange="updateHelperFromField(event);"></textarea>
      <button type="button" class="btn btn-secondary" onclick="resetAttachments()">איפוס נספחים</button>
    </div>

    <!-- VAT Settings Section -->
    <div class="form-section" id="vat-settings" style="background: #fff3cd; border-left: 4px solid #ffc107;">
      <h3>הגדרות מע"מ</h3>
      <div class="form-grid">
        <div>
          <label>אחוז מע"מ נוכחי:</label>
          <input type="text" id="current-vat-rate" readonly style="font-weight: bold;" />
        </div>
        <div>
          <label>עדכון ידני (למקרים חריגים):</label>
          <input type="number" id="manual-vat-rate" placeholder="17" min="0" max="100" step="0.1" />
          <button type="button" class="btn btn-secondary" onclick="updateVatRateEstimate()">עדכן</button>
        </div>
      </div>
      <div style="margin-top: 10px; font-size: 14px; color: #856404;">
        <strong>הערה:</strong> שינוי אחוז המע"מ ישפיע על כל החישובים בדף זה.
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button type="button" class="btn btn-primary" onclick="saveEstimate()">💾 שמור אומדן</button>
      <button type="button" class="btn btn-secondary" onclick="previewEstimate()">👁️ תצוגה מקדימה</button>
      <button type="button" class="btn btn-success" onclick="generateEstimate()">📄 הפק אומדן סופי</button>
    </div>
  </div>

  <!-- Floating PDF Viewer (hidden by default) -->
  <div id="floatingPdfViewer" style="display: none;">
    <div class="floating-pdf-overlay" onclick="if(event.target === this) document.getElementById('floatingPdfViewer').style.display='none';">
      <div class="floating-pdf-container">
        <div class="floating-pdf-header">
          <h3 id="floatingPdfTitle">מסמך</h3>
          <div class="floating-pdf-controls">
            <button type="button" class="btn" onclick="document.querySelector('.floating-pdf-content').classList.toggle('minimized')">_</button>
            <button type="button" class="btn" id="closePdfBtn" onclick="document.getElementById('floatingPdfViewer').style.display='none';">✕</button>
          </div>
        </div>
        <div class="floating-pdf-content" id="floatingPdfContent">
          <iframe src="" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- PIP Container (hidden by default) -->
  <div id="pip-container" class="pip-container">
    <div class="pip-header">
      <span>תצוגה מקדימה - אומדן</span>
      <div>
        <button onclick="document.getElementById('pip-content').classList.toggle('minimized')" style="background: none; border: none; color: white; cursor: pointer;">_</button>
        <button onclick="document.getElementById('pip-container').style.display='none'" style="background: none; border: none; color: white; cursor: pointer;">✕</button>
      </div>
    </div>
    <div class="pip-content" id="pip-content">
      <!-- Preview content will be loaded here -->
    </div>
  </div>

  <!-- Load external scripts -->
  <script type="module" src="auth.js"></script>
  <script src="helper.js" type="module"></script>
  <script src="internal-browser.js"></script>
  <script src="levi-floating.js"></script>
  <script src="car-details-floating.js"></script>
  <script src="parts-search-results-floating.js"></script>
  <script src="invoice-details-floating.js"></script>
  
  <script>
    // Global state object to avoid conflicts
    const EstimateBuilderState = {
      isUpdating: false,
      autoSaveTimeout: null,
      damageCenters: [],
      adjustments: {
        features: [],
        registration: [],
        allAdjustments: []
      },
      depreciation: {
        items: [],
        global: {}
      }
    };

    // Single DOMContentLoaded handler
    document.addEventListener('DOMContentLoaded', function() {
      initializeEstimateBuilder();
    });

    // Main initialization function
    function initializeEstimateBuilder() {
      console.log('🚀 Initializing Estimate Builder (Clean Version)');
      
      // Load data from helper
      loadDataFromHelper();
      
      // Add event listeners
      addEventListeners();
      
      // Initialize button states
      initializeButtonStates();
      
      // Setup auto-save
      setupAutoSave();
      
      // Initialize floating screens
      initializeFloatingScreens();
      
      console.log('✅ Estimate Builder initialized successfully');
    }

    // Toggle section visibility
    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        section.style.display = section.style.display === 'none' ? 'block' : 'none';
      }
    }

    // Toggle floating screen
    window.toggleFloatingScreen = function(screenType) {
      console.log('🔄 Toggle floating screen:', screenType);
      
      // Implementation will depend on floating screen modules
      if (typeof window.toggleFloatingScreenOriginal === 'function') {
        window.toggleFloatingScreenOriginal(screenType);
      }
    };

    // Load data from helper
    function loadDataFromHelper() {
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        if (!helper || Object.keys(helper).length === 0) {
          console.log('⚠️ No helper data found');
          return;
        }

        console.log('📊 Loading data from helper');

        // Load vehicle data
        loadVehicleData(helper);
        
        // Load contact data
        loadContactData(helper);
        
        // Load damage centers
        loadDamageCenters(helper);
        
        // Load adjustments
        loadAdjustments(helper);
        
        // Load depreciation
        loadDepreciation(helper);
        
        // Load claims data
        loadClaimsData(helper);
        
        // Load additional notes
        loadAdditionalNotes(helper);
        
        // Update page title
        updatePageTitle(helper);

      } catch (error) {
        console.error('❌ Error loading helper data:', error);
      }
    }

    // Load vehicle data
    function loadVehicleData(helper) {
      const fields = {
        'carPlate': helper.car_details?.plate || helper.vehicle?.plate || '',
        'carManufacturer': helper.car_details?.manufacturer || '',
        'carModel': helper.car_details?.model || '',
        'carYear': helper.car_details?.year || '',
        'carModelCode': helper.car_details?.model_code || '',
        'carBasePrice': helper.valuation?.base_price || helper.car_details?.base_price || '',
        'carMarketValue': helper.vehicle?.market_value || helper.calculations?.full_market_value || '',
        'carReportDate': helper.car_details?.report_date || ''
      };

      Object.entries(fields).forEach(([fieldId, value]) => {
        const field = document.getElementById(fieldId);
        if (field && value) {
          field.value = value;
        }
      });
    }

    // Load contact data
    function loadContactData(helper) {
      const fields = {
        'ownerName': helper.stakeholders?.owner?.name || helper.client?.name || '',
        'ownerAddress': helper.stakeholders?.owner?.address || helper.client?.address || '',
        'ownerPhone': helper.stakeholders?.owner?.phone || helper.client?.phone || '',
        'insuranceCompany': helper.stakeholders?.insurance?.company || helper.client?.insurance_company || '',
        'insuranceEmail': helper.stakeholders?.insurance?.email || helper.client?.insurance_email || '',
        'insuranceAgent': helper.stakeholders?.insurance?.agent?.name || helper.client?.insurance_agent || '',
        'agentPhone': helper.stakeholders?.insurance?.agent?.phone || helper.client?.insurance_agent_phone || '',
        'agentEmail': helper.stakeholders?.insurance?.agent?.email || helper.client?.insurance_agent_email || '',
        'garageName': helper.car_details?.garageName || '',
        'garagePhone': helper.car_details?.garagePhone || '',
        'garageEmail': helper.car_details?.garageEmail || ''
      };

      Object.entries(fields).forEach(([fieldId, value]) => {
        const field = document.getElementById(fieldId);
        if (field && value) {
          field.value = value;
        }
      });
    }

    // Update helper from field
    function updateHelperFromField(event) {
      if (EstimateBuilderState.isUpdating) return;
      
      try {
        EstimateBuilderState.isUpdating = true;
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        const fieldId = event.target.id;
        const value = event.target.value;
        
        console.log(`📝 Updating field: ${fieldId} = "${value}"`);
        
        // Update helper based on field
        // This is a simplified version - expand as needed
        switch(fieldId) {
          case 'carPlate':
            if (!helper.car_details) helper.car_details = {};
            helper.car_details.plate = value;
            break;
          case 'carManufacturer':
            if (!helper.car_details) helper.car_details = {};
            helper.car_details.manufacturer = value;
            break;
          // Add more cases as needed
        }
        
        // Save to session storage
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        // Update window.helper if exists
        if (window.helper) {
          window.helper = helper;
        }
        
      } catch (error) {
        console.error('❌ Error updating helper:', error);
      } finally {
        EstimateBuilderState.isUpdating = false;
      }
    }

    // Update helper from contact field
    function updateHelperFromContactField(element) {
      // Similar to updateHelperFromField but for contact fields
      const event = { target: element };
      updateHelperFromField(event);
    }

    // Add event listeners
    function addEventListeners() {
      // Estimate type change
      document.querySelectorAll('input[name="estimate-type"]').forEach(radio => {
        radio.addEventListener('change', updateEstimateType);
      });

      // Add more event listeners as needed
    }

    // Update estimate type
    function updateEstimateType() {
      const selectedType = document.querySelector('input[name="estimate-type"]:checked')?.value;
      console.log('📋 Estimate type changed:', selectedType);
      
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        if (!helper.estimate) helper.estimate = {};
        helper.estimate.type = selectedType;
        sessionStorage.setItem('helper', JSON.stringify(helper));
      } catch (error) {
        console.error('❌ Error updating estimate type:', error);
      }
    }

    // Save estimate
    window.saveEstimate = function() {
      console.log('💾 Saving estimate...');
      
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        // Collect all form data
        const estimateData = {
          type: document.querySelector('input[name="estimate-type"]:checked')?.value,
          vehicle: collectVehicleData(),
          contact: collectContactData(),
          damageCenters: EstimateBuilderState.damageCenters,
          adjustments: EstimateBuilderState.adjustments,
          depreciation: EstimateBuilderState.depreciation,
          notes: document.getElementById('additional-notes')?.value || '',
          legalText: document.getElementById('legal-text-content')?.value || '',
          attachments: document.getElementById('attachments-list')?.value || ''
        };
        
        // Save to helper.estimate
        helper.estimate = estimateData;
        helper.estimate.savedAt = new Date().toISOString();
        
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        // Show success message
        showMessage('אומדן נשמר בהצלחה', 'success');
        
      } catch (error) {
        console.error('❌ Error saving estimate:', error);
        showMessage('שגיאה בשמירת האומדן', 'error');
      }
    };

    // Preview estimate
    window.previewEstimate = function() {
      console.log('👁️ Preview estimate');
      saveEstimate();
      // Implementation depends on preview requirements
      showEstimatePreviewPip();
    };

    // Generate estimate
    window.generateEstimate = function() {
      console.log('📄 Generate estimate');
      saveEstimate();
      // Navigate to validation page
      window.location.href = 'estimate-validation.html';
    };

    // Show message
    function showMessage(message, type = 'info') {
      const messageDiv = document.createElement('div');
      messageDiv.className = `section-message ${type}`;
      messageDiv.textContent = message;
      document.body.appendChild(messageDiv);
      
      setTimeout(() => {
        messageDiv.remove();
      }, 3000);
    }

    // Initialize button states
    function initializeButtonStates() {
      // Add any specific button initialization here
    }

    // Setup auto-save
    function setupAutoSave() {
      // Auto-save every 30 seconds if there are changes
      setInterval(() => {
        if (EstimateBuilderState.hasChanges) {
          saveEstimate();
          EstimateBuilderState.hasChanges = false;
        }
      }, 30000);
    }

    // Initialize floating screens
    function initializeFloatingScreens() {
      // This will be handled by the floating screen modules
      console.log('🖼️ Floating screens ready');
    }

    // Update page title
    function updatePageTitle(helper) {
      const plate = helper.meta?.plate || helper.car_details?.plate || '...';
      document.getElementById('pageTitle').textContent = `רכב מס. ${plate}`;
    }

    // Placeholder functions for features - implement as needed
    function addFeatureAdjustment() {
      console.log('➕ Add feature adjustment');
      // Implementation here
    }

    function addRegistrationAdjustment() {
      console.log('➕ Add registration adjustment');
      // Implementation here
    }

    function addFullMarketAdjustment() {
      console.log('➕ Add full market adjustment');
      // Implementation here
    }

    function addNewDamageCenter() {
      console.log('➕ Add new damage center');
      // Implementation here
    }

    function addDepField() {
      console.log('➕ Add depreciation field');
      // Implementation here
    }

    function updateGrossMarketValueCalculation() {
      console.log('📊 Update gross market value');
      // Implementation here
    }

    function updateHelperFromAdjustments() {
      console.log('📊 Update helper from adjustments');
      // Implementation here
    }

    function saveDamageCenterChangesWithFeedback() {
      console.log('💾 Save damage center changes');
      // Implementation here
    }

    function saveDepreciationData() {
      console.log('💾 Save depreciation data');
      // Implementation here
    }

    function updateHelperDepreciationField(element, field) {
      console.log('📝 Update depreciation field:', field);
      // Implementation here
    }

    function updateClaimsDataFromField(element, field) {
      console.log('📝 Update claims field:', field);
      // Implementation here
    }

    function updateGrossPercentageFromGrossValue() {
      console.log('📊 Update gross percentage');
      // Implementation here
    }

    function updateGlobalDepreciationCalculation() {
      console.log('📊 Update global depreciation');
      // Implementation here
    }

    function triggerFloatingScreenRefresh() {
      console.log('🔄 Trigger floating screen refresh');
      // Implementation here
    }

    function autoPopulateMarketAdjustments() {
      console.log('🔄 Auto populate market adjustments');
      // Implementation here
    }

    function loadLegalTextFromVault() {
      console.log('📄 Load legal text');
      // Implementation here
    }

    function resetLegalText() {
      document.getElementById('legal-text-content').value = '';
    }

    function loadAttachmentsFromVault() {
      console.log('📎 Load attachments');
      // Implementation here
    }

    function resetAttachments() {
      document.getElementById('attachments-list').value = '';
    }

    function updateVatRateEstimate() {
      console.log('💰 Update VAT rate');
      // Implementation here
    }

    function showEstimatePreviewPip() {
      console.log('🖼️ Show PIP preview');
      const pip = document.getElementById('pip-container');
      if (pip) {
        pip.style.display = 'block';
      }
    }

    // Placeholder loader functions
    function loadDamageCenters(helper) {
      console.log('🏗️ Load damage centers');
      // Implementation here
    }

    function loadAdjustments(helper) {
      console.log('📊 Load adjustments');
      // Implementation here
    }

    function loadDepreciation(helper) {
      console.log('📉 Load depreciation');
      // Implementation here
    }

    function loadClaimsData(helper) {
      console.log('💰 Load claims data');
      // Implementation here
    }

    function loadAdditionalNotes(helper) {
      const notes = helper.estimate?.notes || '';
      const notesField = document.getElementById('additional-notes');
      if (notesField && notes) {
        notesField.value = notes;
      }
    }

    function collectVehicleData() {
      return {
        plate: document.getElementById('carPlate')?.value || '',
        manufacturer: document.getElementById('carManufacturer')?.value || '',
        model: document.getElementById('carModel')?.value || '',
        year: document.getElementById('carYear')?.value || '',
        modelCode: document.getElementById('carModelCode')?.value || '',
        basePrice: document.getElementById('carBasePrice')?.value || '',
        marketValue: document.getElementById('carMarketValue')?.value || '',
        reportDate: document.getElementById('carReportDate')?.value || ''
      };
    }

    function collectContactData() {
      return {
        ownerName: document.getElementById('ownerName')?.value || '',
        ownerAddress: document.getElementById('ownerAddress')?.value || '',
        ownerPhone: document.getElementById('ownerPhone')?.value || '',
        insuranceCompany: document.getElementById('insuranceCompany')?.value || '',
        insuranceEmail: document.getElementById('insuranceEmail')?.value || '',
        insuranceAgent: document.getElementById('insuranceAgent')?.value || '',
        agentPhone: document.getElementById('agentPhone')?.value || '',
        agentEmail: document.getElementById('agentEmail')?.value || '',
        garageName: document.getElementById('garageName')?.value || '',
        garagePhone: document.getElementById('garagePhone')?.value || '',
        garageEmail: document.getElementById('garageEmail')?.value || ''
      };
    }
  </script>
</body>
</html>