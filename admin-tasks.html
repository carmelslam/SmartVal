<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>◊†◊ô◊î◊ï◊ú ◊û◊©◊ô◊û◊ï◊™ - ◊ô◊®◊ï◊ü ◊õ◊ô◊ï◊£ - ◊©◊û◊ê◊ï◊™ ◊ï◊ô◊ô◊¢◊ï◊•</title>
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans Hebrew', Arial, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      direction: rtl;
      line-height: 1.6;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #003366 0%, #004c99 100%);
      padding: 1rem 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      color: white;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo {
      width: 50px;
      height: 50px;
      object-fit: contain;
      background: white;
      border-radius: 8px;
      padding: 5px;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .badge {
      background: #ff6b35;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
      position: absolute;
      top: -5px;
      left: -5px;
    }

    .icon-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      position: relative;
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      border: 1px solid #3a3a3a;
      transition: all 0.3s;
      cursor: pointer;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
      border-color: #003366;
    }

    .stat-label {
      color: #999;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 0.5rem;
    }

    .stat-change {
      font-size: 0.85rem;
      color: #10B981;
    }

    .stat-change.negative {
      color: #EF4444;
    }

    .toolbar {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
      border: 1px solid #3a3a3a;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Noto Sans Hebrew', Arial, sans-serif;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #ff6b35 0%, #ff8556 100%);
      color: white;
      box-shadow: 0 4px 6px rgba(255, 107, 53, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(255, 107, 53, 0.4);
    }

    .btn-secondary {
      background: #3a3a3a;
      color: #e0e0e0;
      border: 1px solid #4a4a4a;
    }

    .btn-secondary:hover {
      background: #4a4a4a;
    }

    .search-box {
      flex: 1;
      min-width: 250px;
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      border: 1px solid #4a4a4a;
      border-radius: 8px;
      background: #1a1a1a;
      color: #e0e0e0;
      font-family: 'Noto Sans Hebrew', Arial, sans-serif;
      font-size: 1rem;
    }

    .search-box::before {
      content: "üîç";
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .task-card {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      border-right: 4px solid #3a3a3a;
      transition: all 0.3s;
      cursor: pointer;
    }

    .task-card:hover {
      transform: translateX(-5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    /* Task State Styling */
    .task-card.state-pending {
      border-right: 4px solid #9CA3AF;
      background: linear-gradient(135deg, #2a2a2a 0%, #252525 100%);
    }

    .task-card.state-in_progress {
      border-right: 4px solid #3B82F6;
      background: linear-gradient(135deg, #1e2a3a 0%, #2a3544 100%);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
      animation: pulse-blue 3s ease-in-out infinite;
    }

    .task-card.state-awaiting_response {
      border-right: 4px solid #F59E0B;
      background: linear-gradient(135deg, #3a2e1a 0%, #443520 100%);
    }

    .task-card.state-completed {
      border-right: 4px solid #10B981;
      background: linear-gradient(135deg, #1a2e2a 0%, #253a30 100%);
      opacity: 0.95;
    }

    .task-card.state-verified {
      border-right: 4px solid #22C55E;
      background: linear-gradient(135deg, #1a2e2a 0%, #254a35 100%);
      opacity: 0.95;
    }

    .task-card.state-completed .task-title::before,
    .task-card.state-verified .task-title::before {
      content: '‚úì ';
      color: #10B981;
      font-weight: bold;
      margin-left: 0.5rem;
    }

    .task-card.state-cancelled {
      border-right: 4px solid #EF4444;
      background: linear-gradient(135deg, #2a2a2a 0%, #252525 100%);
      opacity: 0.7;
    }

    .task-card.overdue {
      animation: pulse-red 3s ease-in-out infinite;
    }

    @keyframes pulse-blue {
      0%, 100% {
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
      }
      50% {
        box-shadow: 0 0 35px rgba(59, 130, 246, 0.4);
      }
    }

    @keyframes pulse-red {
      0%, 100% {
        box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
      }
      50% {
        box-shadow: 0 0 35px rgba(239, 68, 68, 0.5);
      }
    }

    .task-card.high {
      border-right-color: #F59E0B;
    }

    .task-card.urgent {
      border-right-color: #EF4444;
    }

    .task-card.medium {
      border-right-color: #3B82F6;
    }

    .task-card.low {
      border-right-color: #10B981;
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }

    .task-title {
      font-weight: 600;
      color: #fff;
      font-size: 1rem;
    }

    .priority-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .priority-badge.high {
      background: rgba(245, 158, 11, 0.2);
      color: #F59E0B;
    }

    .priority-badge.urgent {
      background: rgba(239, 68, 68, 0.2);
      color: #EF4444;
    }

    .priority-badge.medium {
      background: rgba(59, 130, 246, 0.2);
      color: #3B82F6;
    }

    .priority-badge.low {
      background: rgba(16, 185, 129, 0.2);
      color: #10B981;
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-badge.status-pending {
      background: rgba(156, 163, 175, 0.2);
      color: #9CA3AF;
    }

    .status-badge.status-in_progress {
      background: rgba(59, 130, 246, 0.2);
      color: #3B82F6;
    }

    .status-badge.status-awaiting_response {
      background: rgba(245, 158, 11, 0.2);
      color: #F59E0B;
    }

    .status-badge.status-completed {
      background: rgba(16, 185, 129, 0.2);
      color: #10B981;
    }

    .status-badge.status-verified {
      background: rgba(34, 197, 94, 0.2);
      color: #22C55E;
    }

    .status-badge.status-cancelled {
      background: rgba(239, 68, 68, 0.2);
      color: #EF4444;
    }

    .task-meta {
      display: flex;
      gap: 1rem;
      font-size: 0.85rem;
      color: #999;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }

    .task-stats {
      display: flex;
      gap: 1rem;
      font-size: 0.85rem;
      color: #999;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.open {
      display: flex;
    }

    .modal-content {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid #3a3a3a;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-header h2 {
      color: #fff;
      font-size: 1.5rem;
    }

    .close-btn {
      background: none;
      border: none;
      color: #999;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      color: #fff;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: #e0e0e0;
      font-weight: 500;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #4a4a4a;
      border-radius: 8px;
      background: #1a1a1a;
      color: #e0e0e0;
      font-family: 'Noto Sans Hebrew', Arial, sans-serif;
      font-size: 1rem;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #999;
    }

    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #999;
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .footer {
      text-align: center;
      padding: 2rem;
      color: #666;
      border-top: 1px solid #3a3a3a;
      margin-top: 3rem;
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      .header {
        padding: 1rem;
      }

      .header h1 {
        font-size: 1.2rem;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }

      .stat-value {
        font-size: 2rem;
      }

      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }

      .search-box {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo" class="logo">
      <span>◊ô◊®◊ï◊ü ◊õ◊ô◊ï◊£ - ◊©◊û◊ê◊ï◊™ ◊ï◊ô◊ô◊¢◊ï◊• - ◊†◊ô◊î◊ï◊ú ◊û◊©◊ô◊û◊ï◊™</span>
    </h1>
    <div class="header-actions">
      <div class="icon-btn" id="notificationsBtn">
        üîî
        <div class="badge" id="notificationCount" style="display: none;">0</div>
      </div>
      <div class="icon-btn" onclick="window.location.href='admin.html'">
        üè†
      </div>
      <div class="icon-btn" onclick="window.location.href='selection.html'">
        üë§
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Statistics Section -->
    <div class="section-title">üìä ◊°◊ò◊ò◊ô◊°◊ò◊ô◊ß◊î ◊õ◊ú◊ú◊ô◊™</div>
    <div class="stats-grid">
      <div class="stat-card" onclick="filterByStatus('active')">
        <div class="stat-label">◊û◊©◊ô◊û◊ï◊™ ◊§◊¢◊ô◊ú◊ï◊™</div>
        <div class="stat-value" id="activeCount">0</div>
        <div class="stat-change" id="activeChange">◊ò◊ï◊¢◊ü...</div>
      </div>
      <div class="stat-card" onclick="filterByStatus('pending')">
        <div class="stat-label">◊û◊û◊™◊ô◊†◊ï◊™ ◊ú◊™◊í◊ï◊ë◊î</div>
        <div class="stat-value" id="pendingCount">0</div>
        <div class="stat-change" id="pendingChange">◊ò◊ï◊¢◊ü...</div>
      </div>
      <div class="stat-card" onclick="filterByStatus('completed')">
        <div class="stat-label">◊î◊ï◊©◊ú◊û◊ï ◊î◊ô◊ï◊ù</div>
        <div class="stat-value" id="completedCount">0</div>
        <div class="stat-change" id="completedChange">◊ò◊ï◊¢◊ü...</div>
      </div>
      <div class="stat-card" onclick="filterByStatus('overdue')">
        <div class="stat-label">◊ê◊ô◊ó◊ï◊® ◊ë◊ô◊¶◊ï◊¢</div>
        <div class="stat-value" id="overdueCount">0</div>
        <div class="stat-change negative" id="overdueChange">◊ò◊ï◊¢◊ü...</div>
      </div>
    </div>

    <!-- Enhanced Analytics Dashboard -->
    <div class="section-title" style="margin-top: 2rem;">üìà ◊ú◊ï◊ó ◊ë◊ß◊®◊î ◊û◊™◊ß◊ì◊ù</div>
    <div style="background: #2a2a2a; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">

      <!-- Overall Fulfillment -->
      <div style="margin-bottom: 2rem;">
        <h3 style="color: #fff; font-size: 1.1rem; margin-bottom: 1rem;">üìä ◊ê◊ó◊ï◊ñ ◊î◊©◊ú◊û◊î ◊õ◊ú◊ú◊ô</h3>
        <div style="display: flex; align-items: center; gap: 1rem;">
          <div style="flex: 1;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
              <span style="color: #9CA3AF;">◊°◊î"◊õ ◊û◊©◊ô◊û◊ï◊™: <span id="totalTasksCount">0</span></span>
              <span style="color: #10B981; font-weight: bold; font-size: 1.2rem;"><span id="fulfillmentRate">0</span>%</span>
            </div>
            <div style="background: rgba(255,255,255,0.1); height: 24px; border-radius: 12px; overflow: hidden;">
              <div id="fulfillmentBar" style="background: linear-gradient(90deg, #10B981, #22C55E); height: 100%; width: 0%; transition: width 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.85rem;"></div>
            </div>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;">
          <div style="background: rgba(59, 130, 246, 0.1); padding: 0.75rem; border-radius: 8px;">
            <div style="color: #9CA3AF; font-size: 0.85rem;">◊ë◊ë◊ô◊¶◊ï◊¢</div>
            <div style="color: #3B82F6; font-size: 1.5rem; font-weight: bold;" id="inProgressCount">0</div>
          </div>
          <div style="background: rgba(16, 185, 129, 0.1); padding: 0.75rem; border-radius: 8px;">
            <div style="color: #9CA3AF; font-size: 0.85rem;">◊î◊ï◊©◊ú◊û◊ï</div>
            <div style="color: #10B981; font-size: 1.5rem; font-weight: bold;" id="completedTasksCount">0</div>
          </div>
          <div style="background: rgba(239, 68, 68, 0.1); padding: 0.75rem; border-radius: 8px;">
            <div style="color: #9CA3AF; font-size: 0.85rem;">◊ë◊ê◊ô◊ó◊ï◊®</div>
            <div style="color: #EF4444; font-size: 1.5rem; font-weight: bold;" id="overdueTasksCount">0</div>
          </div>
        </div>
      </div>

      <!-- Per User Statistics -->
      <div style="margin-bottom: 2rem;">
        <h3 style="color: #fff; font-size: 1.1rem; margin-bottom: 1rem;">üë• ◊ë◊ô◊¶◊ï◊¢◊ô◊ù ◊ú◊§◊ô ◊û◊©◊™◊û◊©</h3>
        <div id="userStatsContainer" style="display: flex; flex-direction: column; gap: 1rem;">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>

      <!-- Filters -->
      <div style="border-top: 1px solid #3a3a3a; padding-top: 1.5rem;">
        <h3 style="color: #fff; font-size: 1.1rem; margin-bottom: 1rem;">üîç ◊°◊ô◊†◊ï◊ü ◊°◊ò◊ò◊ô◊°◊ò◊ô◊ß◊ï◊™</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
          <div>
            <label style="color: #9CA3AF; font-size: 0.85rem; display: block; margin-bottom: 0.5rem;">◊û◊©◊™◊û◊©</label>
            <select id="statsUserFilter" onchange="updateDashboardStats()" style="width: 100%; padding: 0.5rem; border-radius: 6px; background: #1a1a1a; color: #e0e0e0; border: 1px solid #4a4a4a;">
              <option value="">◊õ◊ú ◊î◊û◊©◊™◊û◊©◊ô◊ù</option>
            </select>
          </div>
          <div>
            <label style="color: #9CA3AF; font-size: 0.85rem; display: block; margin-bottom: 0.5rem;">◊°◊ï◊í ◊û◊©◊ô◊û◊î</label>
            <select id="statsTypeFilter" onchange="updateDashboardStats()" style="width: 100%; padding: 0.5rem; border-radius: 6px; background: #1a1a1a; color: #e0e0e0; border: 1px solid #4a4a4a;">
              <option value="">◊õ◊ú ◊î◊°◊ï◊í◊ô◊ù</option>
              <option value="case_action">◊§◊¢◊ï◊ú◊î ◊ë◊™◊ô◊ß</option>
              <option value="document_request">◊ë◊ß◊©◊™ ◊û◊°◊û◊ö</option>
              <option value="review_request">◊ë◊ß◊©◊™ ◊ë◊ô◊ß◊ï◊®◊™</option>
              <option value="data_correction">◊™◊ô◊ß◊ï◊ü ◊†◊™◊ï◊†◊ô◊ù</option>
              <option value="follow_up">◊û◊¢◊ß◊ë</option>
              <option value="custom">◊ê◊ó◊®</option>
            </select>
          </div>
          <div>
            <label style="color: #9CA3AF; font-size: 0.85rem; display: block; margin-bottom: 0.5rem;">◊¢◊ì◊ô◊§◊ï◊™</label>
            <select id="statsPriorityFilter" onchange="updateDashboardStats()" style="width: 100%; padding: 0.5rem; border-radius: 6px; background: #1a1a1a; color: #e0e0e0; border: 1px solid #4a4a4a;">
              <option value="">◊õ◊ú ◊î◊¢◊ì◊ô◊§◊ï◊ô◊ï◊™</option>
              <option value="urgent">◊ì◊ó◊ï◊£</option>
              <option value="high">◊í◊ë◊ï◊î</option>
              <option value="medium">◊ë◊ô◊†◊ï◊†◊ô</option>
              <option value="low">◊†◊û◊ï◊ö</option>
            </select>
          </div>
        </div>
      </div>

    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <button class="btn btn-primary" onclick="openNewTaskModal()">‚ûï ◊û◊©◊ô◊û◊î ◊ó◊ì◊©◊î</button>
      <button class="btn btn-secondary" onclick="openNewThreadModal()">üßµ ◊©◊®◊©◊ï◊® ◊ó◊ì◊©</button>
      <button class="btn btn-secondary" onclick="openArchiveModal()">üì¶ ◊ê◊®◊õ◊ô◊ï◊ü (<span id="archiveCountToolbar">0</span>)</button>
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="◊ó◊ô◊§◊ï◊© ◊û◊©◊ô◊û◊ï◊™..." oninput="searchTasks()">
      </div>
      <select class="btn btn-secondary" id="priorityFilter" onchange="filterTasks()">
        <option value="">◊õ◊ú ◊î◊¢◊ì◊ô◊§◊ï◊ô◊ï◊™</option>
        <option value="urgent">◊ì◊ó◊ï◊£</option>
        <option value="high">◊í◊ë◊ï◊î</option>
        <option value="medium">◊ë◊ô◊†◊ï◊†◊ô</option>
        <option value="low">◊†◊û◊ï◊ö</option>
      </select>
      <select class="btn btn-secondary" id="statusFilter" onchange="filterTasks()">
        <option value="">◊õ◊ú ◊î◊°◊ò◊ò◊ï◊°◊ô◊ù</option>
        <option value="pending">◊û◊û◊™◊ô◊†◊î</option>
        <option value="in_progress">◊ë◊ë◊ô◊¶◊ï◊¢</option>
        <option value="awaiting_response">◊û◊û◊™◊ô◊†◊î ◊ú◊™◊©◊ï◊ë◊î</option>
        <option value="completed">◊î◊ï◊©◊ú◊û◊î</option>
        <option value="verified">◊ê◊ï◊©◊®◊î</option>
      </select>
    </div>

    <!-- Tasks Section -->
    <div class="section-title">üìã ◊û◊©◊ô◊û◊ï◊™ ◊ê◊ó◊®◊ï◊†◊ï◊™</div>
    <div id="tasksContainer">
      <div class="loading">◊ò◊ï◊¢◊ü ◊û◊©◊ô◊û◊ï◊™</div>
    </div>
  </div>

  <!-- New Task Modal -->
  <div id="newTaskModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚ûï ◊û◊©◊ô◊û◊î ◊ó◊ì◊©◊î</h2>
        <button class="close-btn" onclick="closeNewTaskModal()">‚úï</button>
      </div>
      <form id="newTaskForm" onsubmit="createTask(event)">
        <div class="form-group">
          <label for="taskTitle">◊õ◊ï◊™◊®◊™ ◊î◊û◊©◊ô◊û◊î *</label>
          <input type="text" id="taskTitle" required>
        </div>
        <div class="form-group">
          <label for="taskDescription">◊™◊ô◊ê◊ï◊®</label>
          <textarea id="taskDescription"></textarea>
        </div>
        <div class="form-group">
          <label for="taskType">◊°◊ï◊í ◊û◊©◊ô◊û◊î</label>
          <select id="taskType">
            <option value="custom">◊õ◊ú◊ú◊ô◊™</option>
            <option value="case_action">◊§◊¢◊ï◊ú◊î ◊ë◊™◊ô◊ß</option>
            <option value="document_request">◊ë◊ß◊©◊™ ◊û◊°◊û◊ö</option>
            <option value="review_request">◊ë◊ß◊©◊™ ◊°◊ß◊ô◊®◊î</option>
            <option value="data_correction">◊™◊ô◊ß◊ï◊ü ◊†◊™◊ï◊†◊ô◊ù</option>
            <option value="follow_up">◊û◊¢◊ß◊ë</option>
          </select>
        </div>
        <div class="form-group">
          <label for="assignedTo">◊î◊ß◊¶◊î ◊ú- *</label>
          <select id="assignedTo" required>
            <option value="">◊ë◊ó◊® ◊û◊©◊™◊û◊©...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="taskPriority">◊¢◊ì◊ô◊§◊ï◊™</label>
          <select id="taskPriority">
            <option value="low">◊†◊û◊ï◊õ◊î</option>
            <option value="medium" selected>◊ë◊ô◊†◊ï◊†◊ô◊™</option>
            <option value="high">◊í◊ë◊ï◊î◊î</option>
            <option value="urgent">◊ì◊ó◊ï◊§◊î</option>
          </select>
        </div>
        <div class="form-group">
          <label for="dueDate">◊™◊ê◊®◊ô◊ö ◊ô◊¢◊ì</label>
          <input type="date" id="dueDate">
        </div>
        <div class="form-group">
          <label for="filingCaseId">◊û◊°◊§◊® ◊™◊ô◊ß (◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô)</label>
          <select id="filingCaseId" onchange="onCaseSelected()">
            <option value="">◊ë◊ó◊® ◊™◊ô◊ß...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="plateDropdown">◊û◊°◊§◊® ◊®◊ô◊©◊ï◊ô (◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô)</label>
          <select id="plateDropdown" onchange="onPlateDropdownChange()">
            <option value="">◊ë◊ó◊® ◊û◊°◊§◊® ◊®◊ô◊©◊ï◊ô...</option>
            <option value="__manual__">◊î◊ñ◊†◊î ◊ô◊ì◊†◊ô◊™</option>
          </select>
        </div>
        <div class="form-group" id="plateManualGroup" style="display: none;">
          <label for="plateManual">◊î◊ñ◊ü ◊û◊°◊§◊® ◊®◊ô◊©◊ï◊ô ◊ô◊ì◊†◊ô◊™</label>
          <input type="text" id="plateManual" placeholder="12-345-67">
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
          <button type="submit" class="btn btn-primary" style="flex: 1;">‚úÖ ◊¶◊ï◊® ◊û◊©◊ô◊û◊î</button>
          <button type="button" class="btn btn-secondary" onclick="closeNewTaskModal()">◊ë◊ô◊ò◊ï◊ú</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Task Modal -->
  <div id="editTaskModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚úèÔ∏è ◊¢◊®◊ï◊ö ◊û◊©◊ô◊û◊î</h2>
        <button class="close-btn" onclick="closeEditTaskModal()">‚úï</button>
      </div>
      <form onsubmit="saveTaskEdits(event)">
        <div class="form-group">
          <label for="editTaskTitle">◊õ◊ï◊™◊®◊™ ◊î◊û◊©◊ô◊û◊î *</label>
          <input type="text" id="editTaskTitle" required placeholder="◊î◊ñ◊ü ◊õ◊ï◊™◊®◊™ ◊ú◊û◊©◊ô◊û◊î...">
        </div>
        <div class="form-group">
          <label for="editTaskDescription">◊™◊ô◊ê◊ï◊® ◊î◊û◊©◊ô◊û◊î</label>
          <textarea id="editTaskDescription" rows="4" placeholder="◊î◊ñ◊ü ◊™◊ô◊ê◊ï◊® ◊û◊§◊ï◊®◊ò..."></textarea>
        </div>
        <div class="form-group">
          <label for="editTaskType">◊°◊ï◊í ◊î◊û◊©◊ô◊û◊î</label>
          <select id="editTaskType">
            <option value="case_action">◊§◊¢◊ï◊ú◊î ◊ë◊™◊ô◊ß</option>
            <option value="document_request">◊ë◊ß◊©◊™ ◊û◊°◊û◊ö</option>
            <option value="review_request">◊ë◊ß◊©◊™ ◊ë◊ô◊ß◊ï◊®◊™</option>
            <option value="data_correction">◊™◊ô◊ß◊ï◊ü ◊†◊™◊ï◊†◊ô◊ù</option>
            <option value="follow_up">◊û◊¢◊ß◊ë</option>
            <option value="custom">◊ê◊ó◊®</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editAssignedTo">◊î◊ß◊¶◊î ◊ú *</label>
          <select id="editAssignedTo" required>
            <option value="">◊ë◊ó◊® ◊û◊©◊™◊û◊©...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editTaskPriority">◊¢◊ì◊ô◊§◊ï◊™</label>
          <select id="editTaskPriority">
            <option value="low">◊†◊û◊ï◊õ◊î</option>
            <option value="medium">◊ë◊ô◊†◊ï◊†◊ô◊™</option>
            <option value="high">◊í◊ë◊ï◊î◊î</option>
            <option value="urgent">◊ì◊ó◊ï◊£</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editDueDate">◊™◊ê◊®◊ô◊ö ◊ô◊¢◊ì</label>
          <input type="date" id="editDueDate">
        </div>
        <div class="form-group">
          <label for="editFilingCaseId">◊û◊°◊§◊® ◊™◊ô◊ß (◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô)</label>
          <select id="editFilingCaseId">
            <option value="">◊ë◊ó◊® ◊™◊ô◊ß...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editPlate">◊û◊°◊§◊® ◊®◊ô◊©◊ï◊ô (◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô)</label>
          <input type="text" id="editPlate" placeholder="12-345-67">
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
          <button type="submit" class="btn btn-primary" style="flex: 1;">üíæ ◊©◊û◊ï◊® ◊©◊ô◊†◊ï◊ô◊ô◊ù</button>
          <button type="button" class="btn btn-secondary" onclick="closeEditTaskModal()">◊ë◊ô◊ò◊ï◊ú</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Archive Modal -->
  <div id="archiveModal" class="modal">
    <div class="modal-content" style="max-width: 1200px;">
      <div class="modal-header">
        <h2>üì¶ ◊ê◊®◊õ◊ô◊ï◊ü ◊û◊©◊ô◊û◊ï◊™ (<span id="archiveCount">0</span>)</h2>
        <button class="close-btn" onclick="closeArchiveModal()">‚úï</button>
      </div>

      <div style="margin-bottom: 1.5rem;">
        <div class="search-box">
          <input type="text" id="archiveSearchInput" placeholder="üîç ◊ó◊ô◊§◊ï◊© ◊ë◊ê◊®◊õ◊ô◊ï◊ü..." oninput="searchArchivedTasks()">
        </div>
      </div>

      <div id="archivedTasksContainer" style="max-height: 600px; overflow-y: auto;">
        <div class="loading">◊ò◊ï◊¢◊ü ◊û◊©◊ô◊û◊ï◊™ ◊û◊ê◊ï◊®◊õ◊ë◊ï◊™...</div>
      </div>

      <div style="text-align: center; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #3a3a3a;">
        <button type="button" class="btn btn-secondary" onclick="closeArchiveModal()">◊°◊í◊ï◊®</button>
      </div>
    </div>
  </div>

  <div class="footer">
    ¬©2025 Carmel Cayouf. All rights reserved. SmartVal Pro System by Evalix
  </div>

  <script type="module">
    import { supabase } from './lib/supabaseClient.js';

    // Global state
    let allTasks = [];
    let allUsers = [];
    let currentUser = null;

    // Initialize
    async function init() {
      try {
        // Get current user
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          window.location.href = 'index.html';
          return;
        }

        // Get user profile
        const { data: profile } = await supabase
          .from('profiles')
          .select('*')
          .eq('user_id', user.id)
          .single();

        currentUser = profile;
        console.log('Current user:', currentUser);

        // Check access - only admin and developer can access this page
        if (profile.role !== 'admin' && profile.role !== 'developer') {
          alert('‚õî ◊ê◊ô◊ü ◊ú◊ö ◊î◊®◊©◊ê◊î ◊ú◊í◊©◊™ ◊ú◊ì◊£ ◊ñ◊î\n\n◊®◊ß ◊û◊†◊î◊ú◊ô◊ù ◊ï◊û◊§◊™◊ó◊ô◊ù ◊ô◊õ◊ï◊ú◊ô◊ù ◊ú◊†◊î◊ú ◊û◊©◊ô◊û◊ï◊™.');
          window.location.href = 'user-tasks.html';
          return;
        }

        // Load users for assignment dropdown
        await loadUsers();

        // Load cases and plates for dropdowns
        await populateCaseDropdown();
        await populatePlateDropdown();

        // Load tasks
        await loadTasks();

        // Update stats
        await updateStats();

        // Update archive count
        await updateArchiveCount();

        // Set up real-time subscriptions
        setupRealtime();

      } catch (error) {
        console.error('Initialization error:', error);
        showError('◊©◊í◊ô◊ê◊î ◊ë◊ò◊¢◊ô◊†◊™ ◊î◊†◊™◊ï◊†◊ô◊ù');
      }
    }

    // Load all users for assignment dropdown
    async function loadUsers() {
      try {
        const { data, error } = await supabase
          .from('profiles')
          .select('user_id, name, role')
          .order('name');

        if (error) throw error;

        allUsers = data || [];
        populateUserDropdown();

      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    function populateUserDropdown() {
      const select = document.getElementById('assignedTo');
      select.innerHTML = '<option value="">◊ë◊ó◊® ◊û◊©◊™◊û◊©...</option>';

      allUsers.forEach(user => {
        const option = document.createElement('option');
        option.value = user.user_id;
        option.textContent = `${user.name} (${getRoleLabel(user.role)})`;
        select.appendChild(option);
      });
    }

    function getRoleLabel(role) {
      const labels = {
        admin: '◊û◊†◊î◊ú',
        developer: '◊û◊§◊™◊ó',
        assistant: '◊¢◊ï◊ñ◊®',
        assessor: '◊©◊û◊ê◊ô',
        viewer: '◊¶◊ï◊§◊î'
      };
      return labels[role] || role;
    }

    // Load cases for dropdown
    async function loadCases() {
      try {
        const { data, error } = await supabase
          .from('cases')
          .select('id, filing_case_id, plate')
          .order('filing_case_id', { ascending: false })
          .limit(100);

        if (error) throw error;

        return data || [];
      } catch (error) {
        console.error('Error loading cases:', error);
        return [];
      }
    }

    // Populate case dropdown
    async function populateCaseDropdown() {
      const cases = await loadCases();
      const select = document.getElementById('filingCaseId');
      select.innerHTML = '<option value="">◊ë◊ó◊® ◊™◊ô◊ß...</option>';

      cases.forEach(c => {
        const option = document.createElement('option');
        option.value = c.filing_case_id;
        option.setAttribute('data-uuid', c.id);
        option.setAttribute('data-plate', c.plate || '');
        option.textContent = `${c.filing_case_id}${c.plate ? ' - ' + c.plate : ''}`;
        select.appendChild(option);
      });
    }

    // Populate plate dropdown
    async function populatePlateDropdown() {
      const cases = await loadCases();
      const select = document.getElementById('plateDropdown');
      select.innerHTML = '<option value="">◊ë◊ó◊® ◊û◊°◊§◊® ◊®◊ô◊©◊ï◊ô...</option><option value="__manual__">◊î◊ñ◊†◊î ◊ô◊ì◊†◊ô◊™</option>';

      // Get unique plates
      const uniquePlates = [...new Set(cases.map(c => c.plate).filter(p => p))];

      uniquePlates.forEach(plate => {
        const option = document.createElement('option');
        option.value = plate;
        option.textContent = plate;
        select.appendChild(option);
      });
    }

    // When case is selected, auto-fill plate
    window.onCaseSelected = function() {
      const select = document.getElementById('filingCaseId');
      const selectedOption = select.options[select.selectedIndex];
      const plate = selectedOption.getAttribute('data-plate');

      if (plate) {
        const plateDropdown = document.getElementById('plateDropdown');
        // Try to select the plate in dropdown
        for (let i = 0; i < plateDropdown.options.length; i++) {
          if (plateDropdown.options[i].value === plate) {
            plateDropdown.selectedIndex = i;
            break;
          }
        }
      }
    };

    // When plate dropdown changes
    window.onPlateDropdownChange = function() {
      const dropdown = document.getElementById('plateDropdown');
      const manualGroup = document.getElementById('plateManualGroup');
      const manualInput = document.getElementById('plateManual');

      if (dropdown.value === '__manual__') {
        manualGroup.style.display = 'block';
        manualInput.required = true;
      } else {
        manualGroup.style.display = 'none';
        manualInput.required = false;
        manualInput.value = '';
      }
    };

    // Load tasks
    async function loadTasks(includeArchived = false) {
      try {
        // Get tasks (exclude archived by default)
        let query = supabase
          .from('tasks')
          .select('*')
          .order('created_at', { ascending: false });

        // Filter archived tasks unless viewing archive
        if (!includeArchived) {
          query = query.or('archived.is.null,archived.eq.false');
        }

        query = query.limit(50);

        const { data: tasks, error: tasksError } = await query;

        if (tasksError) throw tasksError;

        // Get all profiles (for joining)
        const { data: profiles, error: profilesError } = await supabase
          .from('profiles')
          .select('user_id, name, role');

        if (profilesError) throw profilesError;

        // Create a lookup map for profiles
        const profileMap = {};
        (profiles || []).forEach(profile => {
          profileMap[profile.user_id] = profile;
        });

        // Join tasks with profile data
        allTasks = (tasks || []).map(task => ({
          ...task,
          assigned_to_profile: profileMap[task.assigned_to] || null,
          assigned_by_profile: profileMap[task.assigned_by] || null
        }));

        renderTasks(allTasks);

      } catch (error) {
        console.error('Error loading tasks:', error);
        showError('◊©◊í◊ô◊ê◊î ◊ë◊ò◊¢◊ô◊†◊™ ◊î◊û◊©◊ô◊û◊ï◊™');
      }
    }

    function renderTasks(tasks) {
      const container = document.getElementById('tasksContainer');

      if (!tasks || tasks.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìù</div>
            <h3>◊ê◊ô◊ü ◊û◊©◊ô◊û◊ï◊™ ◊ú◊î◊¶◊í◊î</h3>
            <p>◊ú◊ó◊• ◊¢◊ú "◊û◊©◊ô◊û◊î ◊ó◊ì◊©◊î" ◊õ◊ì◊ô ◊ú◊î◊™◊ó◊ô◊ú</p>
          </div>
        `;
        return;
      }

      container.innerHTML = tasks.map(task => {
        const isOverdue = task.due_date && new Date(task.due_date) < new Date() && task.status !== 'completed' && task.status !== 'verified';
        const progressPercent = task.completion_percentage || 0;
        const stateClass = `state-${task.status}`;
        const overdueClass = isOverdue ? 'overdue' : '';

        return `
        <div class="task-card ${task.priority} ${stateClass} ${overdueClass}" onclick="openTaskDetail('${task.id}')">
          <div class="task-header">
            <div class="task-title">
              ${escapeHtml(task.title)}
              ${isOverdue ? '<span style="color: #ff4444; margin-right: 8px;">‚ö†Ô∏è ◊ë◊ê◊ô◊ó◊ï◊®</span>' : ''}
            </div>
            <span class="priority-badge ${task.priority}">
              ${getPriorityIcon(task.priority)} ${getPriorityLabel(task.priority)}
            </span>
          </div>

          <div class="task-meta">
            <span>üë§ ◊î◊ï◊ß◊¶◊î ◊ú: <strong>${task.assigned_to_profile?.name || '◊ú◊ê ◊ô◊ì◊ï◊¢'}</strong></span>
            <span>üë§ ◊î◊ï◊ß◊¶◊î ◊¢◊ú ◊ô◊ì◊ô: <strong>${task.assigned_by_profile?.name || '◊ú◊ê ◊ô◊ì◊ï◊¢'}</strong></span>
          </div>

          <div class="task-meta">
            <span>üìÖ ${formatDate(task.due_date) || '◊ú◊ú◊ê ◊û◊ï◊¢◊ì'}</span>
            <span class="status-badge status-${task.status}">üìä ${getStatusLabel(task.status)}</span>
            ${task.plate ? `<span>üöó ${task.plate}</span>` : ''}
          </div>

          <div class="task-stats">
            <div style="flex: 1;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                <span style="font-size: 0.85rem;">◊î◊™◊ß◊ì◊û◊ï◊™:</span>
                <span style="font-size: 0.85rem; font-weight: 600;">${progressPercent}%</span>
              </div>
              <div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                <div style="background: linear-gradient(90deg, #4CAF50, #8BC34A); height: 100%; width: ${progressPercent}%; transition: width 0.3s;"></div>
              </div>
            </div>
            <span style="margin-right: 16px;">üïê ${formatRelativeTime(task.created_at)}</span>
          </div>

          <div class="task-actions" style="margin-top: 12px; display: flex; gap: 8px; justify-content: flex-start;" onclick="event.stopPropagation()">
            <button class="btn-edit" onclick="openEditTaskModal('${task.id}')" style="background: #3B82F6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
              ‚úèÔ∏è ◊¢◊®◊ï◊ö
            </button>
            ${(task.status === 'completed' || task.status === 'verified') && !task.archived ? `
              <button class="btn-archive" onclick="archiveTask('${task.id}')" style="background: #6B7280; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                üì¶ ◊î◊¢◊ë◊® ◊ú◊ê◊®◊õ◊ô◊ï◊ü
              </button>
            ` : ''}
            ${task.archived ? `
              <button class="btn-restore" onclick="restoreTask('${task.id}')" style="background: #10B981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                ‚Ü©Ô∏è ◊©◊ó◊ñ◊®
              </button>
            ` : ''}
          </div>
        </div>
      `;
      }).join('');
    }

    // Update statistics
    async function updateStats() {
      try {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // Active tasks (in_progress)
        const activeCount = allTasks.filter(t => t.status === 'in_progress').length;
        document.getElementById('activeCount').textContent = activeCount;

        // Pending tasks (pending or awaiting_response)
        const pendingCount = allTasks.filter(t =>
          t.status === 'pending' || t.status === 'awaiting_response'
        ).length;
        document.getElementById('pendingCount').textContent = pendingCount;

        // Completed today
        const completedToday = allTasks.filter(t => {
          if (!t.completed_at) return false;
          const completedDate = new Date(t.completed_at);
          return completedDate >= today;
        }).length;
        document.getElementById('completedCount').textContent = completedToday;

        // Overdue tasks
        const now = new Date();
        const overdueCount = allTasks.filter(t => {
          if (!t.due_date || t.status === 'completed' || t.status === 'verified') return false;
          return new Date(t.due_date) < now;
        }).length;
        document.getElementById('overdueCount').textContent = overdueCount;

        // Update change indicators (mock for now)
        document.getElementById('activeChange').textContent = `‚Üë +${Math.floor(Math.random() * 5)} ◊î◊ó◊ï◊ì◊©`;
        document.getElementById('pendingChange').textContent = `‚Üì -${Math.floor(Math.random() * 3)} ◊î◊©◊ë◊ï◊¢`;
        document.getElementById('completedChange').textContent = `‚Üë +${completedToday} ◊î◊ô◊ï◊ù`;
        document.getElementById('overdueChange').textContent = overdueCount > 0 ? '‚ö†Ô∏è ◊ì◊ï◊®◊© ◊ò◊ô◊§◊ï◊ú' : '‚úÖ ◊î◊õ◊ú ◊ë◊°◊ì◊®';

      } catch (error) {
        console.error('Error updating stats:', error);
      }

      // Also update dashboard stats
      updateDashboardStats();
    }

    // Enhanced Dashboard Statistics
    function updateDashboardStats() {
      try {
        // Get filter values
        const userFilter = document.getElementById('statsUserFilter').value;
        const typeFilter = document.getElementById('statsTypeFilter').value;
        const priorityFilter = document.getElementById('statsPriorityFilter').value;

        // Filter tasks based on selections
        let filteredTasks = allTasks.filter(t => !t.archived); // Exclude archived

        if (userFilter) filteredTasks = filteredTasks.filter(t => t.assigned_to === userFilter);
        if (typeFilter) filteredTasks = filteredTasks.filter(t => t.task_type === typeFilter);
        if (priorityFilter) filteredTasks = filteredTasks.filter(t => t.priority === priorityFilter);

        // Calculate overall metrics
        const totalTasks = filteredTasks.length;
        const completedTasks = filteredTasks.filter(t => t.status === 'completed' || t.status === 'verified').length;
        const inProgressTasks = filteredTasks.filter(t => t.status === 'in_progress').length;
        const overdueTasks = filteredTasks.filter(t => {
          if (!t.due_date || t.status === 'completed' || t.status === 'verified') return false;
          return new Date(t.due_date) < new Date();
        }).length;

        const fulfillmentRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

        // Update overall metrics
        document.getElementById('totalTasksCount').textContent = totalTasks;
        document.getElementById('fulfillmentRate').textContent = fulfillmentRate;
        document.getElementById('fulfillmentBar').style.width = `${fulfillmentRate}%`;
        document.getElementById('fulfillmentBar').textContent = fulfillmentRate > 10 ? `${fulfillmentRate}%` : '';
        document.getElementById('inProgressCount').textContent = inProgressTasks;
        document.getElementById('completedTasksCount').textContent = completedTasks;
        document.getElementById('overdueTasksCount').textContent = overdueTasks;

        // Calculate per-user statistics
        const userStats = {};
        filteredTasks.forEach(task => {
          const userId = task.assigned_to;
          if (!userStats[userId]) {
            userStats[userId] = {
              name: task.assigned_to_profile?.name || '◊ú◊ê ◊ô◊ì◊ï◊¢',
              total: 0,
              completed: 0,
              inProgress: 0,
              overdue: 0
            };
          }
          userStats[userId].total++;
          if (task.status === 'completed' || task.status === 'verified') {
            userStats[userId].completed++;
          }
          if (task.status === 'in_progress') {
            userStats[userId].inProgress++;
          }
          if (task.due_date && new Date(task.due_date) < new Date() && task.status !== 'completed' && task.status !== 'verified') {
            userStats[userId].overdue++;
          }
        });

        // Render per-user statistics
        const userStatsContainer = document.getElementById('userStatsContainer');
        const userStatsList = Object.values(userStats).sort((a, b) => b.total - a.total);

        if (userStatsList.length === 0) {
          userStatsContainer.innerHTML = '<div style="color: #666; text-align: center; padding: 1rem;">◊ê◊ô◊ü ◊†◊™◊ï◊†◊ô◊ù ◊ú◊î◊¶◊í◊î</div>';
        } else {
          userStatsContainer.innerHTML = userStatsList.map(user => {
            const completionRate = user.total > 0 ? Math.round((user.completed / user.total) * 100) : 0;
            return `
              <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                  <div>
                    <div style="color: #fff; font-weight: 600;">${user.name}</div>
                    <div style="color: #9CA3AF; font-size: 0.85rem;">◊°◊î"◊õ: ${user.total} | ◊î◊ï◊©◊ú◊û◊ï: ${user.completed} | ◊ë◊ë◊ô◊¶◊ï◊¢: ${user.inProgress}${user.overdue > 0 ? ` | <span style="color: #EF4444;">◊ë◊ê◊ô◊ó◊ï◊®: ${user.overdue}</span>` : ''}</div>
                  </div>
                  <div style="color: ${completionRate >= 80 ? '#10B981' : completionRate >= 50 ? '#F59E0B' : '#EF4444'}; font-size: 1.5rem; font-weight: bold;">
                    ${completionRate}%
                  </div>
                </div>
                <div style="background: rgba(255,255,255,0.1); height: 12px; border-radius: 6px; overflow: hidden;">
                  <div style="background: linear-gradient(90deg, ${completionRate >= 80 ? '#10B981, #22C55E' : completionRate >= 50 ? '#F59E0B, #FBBF24' : '#EF4444, #F87171'}); height: 100%; width: ${completionRate}%; transition: width 0.5s;"></div>
                </div>
              </div>
            `;
          }).join('');
        }

        // Populate user filter dropdown if empty
        const statsUserFilter = document.getElementById('statsUserFilter');
        if (statsUserFilter.options.length === 1) {
          allUsers.forEach(user => {
            const option = document.createElement('option');
            option.value = user.user_id;
            option.textContent = user.name;
            statsUserFilter.appendChild(option);
          });
        }

      } catch (error) {
        console.error('Error updating dashboard stats:', error);
      }
    }

    // Real-time subscriptions
    function setupRealtime() {
      supabase
        .channel('tasks-changes')
        .on('postgres_changes',
          { event: '*', schema: 'public', table: 'tasks' },
          (payload) => {
            console.log('Task changed:', payload);
            loadTasks();
            updateStats();
          }
        )
        .subscribe();
    }

    // Modal functions
    window.openNewTaskModal = function() {
      document.getElementById('newTaskModal').classList.add('open');
    };

    window.closeNewTaskModal = function() {
      document.getElementById('newTaskModal').classList.remove('open');
      document.getElementById('newTaskForm').reset();
    };

    // Edit Task Functions
    let currentEditingTaskId = null;

    window.openEditTaskModal = async function(taskId) {
      try {
        // Find task in allTasks array
        const task = allTasks.find(t => t.id === taskId);
        if (!task) {
          alert('◊û◊©◊ô◊û◊î ◊ú◊ê ◊†◊û◊¶◊ê◊î');
          return;
        }

        currentEditingTaskId = taskId;

        // Pre-fill form
        document.getElementById('editTaskTitle').value = task.title || '';
        document.getElementById('editTaskDescription').value = task.description || '';
        document.getElementById('editTaskType').value = task.task_type || 'custom';
        document.getElementById('editTaskPriority').value = task.priority || 'medium';
        document.getElementById('editDueDate').value = task.due_date ? task.due_date.split('T')[0] : '';
        document.getElementById('editPlate').value = task.plate || '';

        // Populate user dropdown if not already done
        if (document.getElementById('editAssignedTo').options.length <= 1) {
          const select = document.getElementById('editAssignedTo');
          allUsers.forEach(user => {
            const option = document.createElement('option');
            option.value = user.user_id;
            option.textContent = `${user.name} (${getRoleLabel(user.role)})`;
            select.appendChild(option);
          });
        }

        // Set assigned user
        document.getElementById('editAssignedTo').value = task.assigned_to || '';

        // Populate case dropdown if needed
        await populateEditCaseDropdown();
        if (task.case_id) {
          // Try to find and select the case
          const caseSelect = document.getElementById('editFilingCaseId');
          for (let i = 0; i < caseSelect.options.length; i++) {
            if (caseSelect.options[i].getAttribute('data-uuid') === task.case_id) {
              caseSelect.selectedIndex = i;
              break;
            }
          }
        }

        // Show modal
        document.getElementById('editTaskModal').classList.add('open');

      } catch (error) {
        console.error('Error opening edit modal:', error);
        alert('◊©◊í◊ô◊ê◊î ◊ë◊ò◊¢◊ô◊†◊™ ◊§◊®◊ò◊ô ◊î◊û◊©◊ô◊û◊î');
      }
    };

    window.closeEditTaskModal = function() {
      document.getElementById('editTaskModal').classList.remove('open');
      currentEditingTaskId = null;
    };

    window.saveTaskEdits = async function(event) {
      event.preventDefault();

      if (!currentEditingTaskId) {
        alert('◊©◊í◊ô◊ê◊î: ◊ú◊ê ◊†◊ë◊ó◊®◊î ◊û◊©◊ô◊û◊î ◊ú◊¢◊®◊ô◊õ◊î');
        return;
      }

      try {
        const updates = {
          title: document.getElementById('editTaskTitle').value,
          description: document.getElementById('editTaskDescription').value,
          task_type: document.getElementById('editTaskType').value,
          assigned_to: document.getElementById('editAssignedTo').value,
          priority: document.getElementById('editTaskPriority').value,
          due_date: document.getElementById('editDueDate').value || null,
          plate: document.getElementById('editPlate').value || null,
          updated_at: new Date().toISOString()
        };

        // Get case_id from selected option
        const caseSelect = document.getElementById('editFilingCaseId');
        const selectedCaseOption = caseSelect.options[caseSelect.selectedIndex];
        if (selectedCaseOption && selectedCaseOption.value) {
          updates.case_id = selectedCaseOption.getAttribute('data-uuid') || null;
        } else {
          updates.case_id = null;
        }

        const { error } = await supabase
          .from('tasks')
          .update(updates)
          .eq('id', currentEditingTaskId);

        if (error) throw error;

        alert('‚úÖ ◊î◊û◊©◊ô◊û◊î ◊¢◊ï◊ì◊õ◊†◊î ◊ë◊î◊¶◊ú◊ó◊î!');
        closeEditTaskModal();
        await loadTasks();
        await updateStats();

      } catch (error) {
        console.error('Error updating task:', error);
        alert('‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊¢◊ì◊õ◊ï◊ü ◊î◊û◊©◊ô◊û◊î: ' + error.message);
      }
    };

    async function populateEditCaseDropdown() {
      const cases = await loadCases();
      const select = document.getElementById('editFilingCaseId');
      select.innerHTML = '<option value="">◊ë◊ó◊® ◊™◊ô◊ß...</option>';
      cases.forEach(c => {
        const option = document.createElement('option');
        option.value = c.filing_case_id;
        option.setAttribute('data-uuid', c.id);
        option.textContent = `${c.filing_case_id}${c.plate ? ' - ' + c.plate : ''}`;
        select.appendChild(option);
      });
    }

    window.openNewThreadModal = function() {
      alert('◊ô◊¶◊ô◊®◊™ ◊©◊®◊©◊ï◊® ◊ó◊ì◊© - ◊ë◊§◊ô◊™◊ï◊ó');
    };

    // Create new task
    window.createTask = async function(event) {
      event.preventDefault();

      try {
        // Get case_id (UUID) from the selected option
        const caseSelect = document.getElementById('filingCaseId');
        const selectedCaseOption = caseSelect.options[caseSelect.selectedIndex];
        const caseId = selectedCaseOption.getAttribute('data-uuid') || null;

        // Get plate - either from dropdown or manual input
        const plateDropdown = document.getElementById('plateDropdown');
        let plate = null;
        if (plateDropdown.value === '__manual__') {
          plate = document.getElementById('plateManual').value || null;
        } else if (plateDropdown.value) {
          plate = plateDropdown.value;
        }

        const formData = {
          title: document.getElementById('taskTitle').value,
          description: document.getElementById('taskDescription').value,
          task_type: document.getElementById('taskType').value,
          assigned_to: document.getElementById('assignedTo').value,
          assigned_by: currentUser.user_id,
          priority: document.getElementById('taskPriority').value,
          due_date: document.getElementById('dueDate').value || null,
          case_id: caseId,
          plate: plate,
          status: 'pending',
          completion_percentage: 0
        };

        const { data, error } = await supabase
          .from('tasks')
          .insert([formData])
          .select()
          .single();

        if (error) throw error;

        console.log('Task created:', data);
        alert('‚úÖ ◊î◊û◊©◊ô◊û◊î ◊†◊ï◊¶◊®◊î ◊ë◊î◊¶◊ú◊ó◊î!');
        closeNewTaskModal();
        await loadTasks();
        await updateStats();

      } catch (error) {
        console.error('Error creating task:', error);
        alert('‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊ô◊¶◊ô◊®◊™ ◊î◊û◊©◊ô◊û◊î: ' + error.message);
      }
    };

    // Archive and Restore Functions
    window.archiveTask = async function(taskId) {
      if (!confirm('◊î◊ê◊ù ◊ê◊™◊î ◊ë◊ò◊ï◊ó ◊©◊ë◊®◊¶◊ï◊†◊ö ◊ú◊î◊¢◊ë◊ô◊® ◊û◊©◊ô◊û◊î ◊ñ◊ï ◊ú◊ê◊®◊õ◊ô◊ï◊ü?\n\n◊™◊ï◊õ◊ú ◊ú◊©◊ó◊ñ◊® ◊ê◊ï◊™◊î ◊ë◊õ◊ú ◊¢◊™.')) {
        return;
      }

      try {
        const { error } = await supabase
          .from('tasks')
          .update({
            archived: true,
            archived_at: new Date().toISOString(),
            archived_by: currentUser.user_id
          })
          .eq('id', taskId);

        if (error) throw error;

        alert('‚úÖ ◊î◊û◊©◊ô◊û◊î ◊î◊ï◊¢◊ë◊®◊î ◊ú◊ê◊®◊õ◊ô◊ï◊ü ◊ë◊î◊¶◊ú◊ó◊î');
        await loadTasks();
        await updateStats();

      } catch (error) {
        console.error('Error archiving task:', error);
        alert('‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊î◊¢◊ë◊®◊î ◊ú◊ê◊®◊õ◊ô◊ï◊ü: ' + error.message);
      }
    };

    window.restoreTask = async function(taskId) {
      try {
        const { error } = await supabase
          .from('tasks')
          .update({
            archived: false,
            archived_at: null,
            archived_by: null
          })
          .eq('id', taskId);

        if (error) throw error;

        alert('‚úÖ ◊î◊û◊©◊ô◊û◊î ◊©◊ï◊ó◊ñ◊®◊î ◊û◊î◊ê◊®◊õ◊ô◊ï◊ü');
        await loadArchivedTasks(); // Refresh archive view
        await loadTasks(); // Refresh main task list
        await updateStats();

      } catch (error) {
        console.error('Error restoring task:', error);
        alert('‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊©◊ó◊ñ◊ï◊® ◊î◊û◊©◊ô◊û◊î: ' + error.message);
      }
    };

    // Archive Modal Functions
    let archivedTasks = [];

    window.openArchiveModal = async function() {
      document.getElementById('archiveModal').classList.add('open');
      await loadArchivedTasks();
    };

    window.closeArchiveModal = function() {
      document.getElementById('archiveModal').classList.remove('open');
      document.getElementById('archiveSearchInput').value = '';
    };

    async function loadArchivedTasks() {
      try {
        const { data: tasks, error } = await supabase
          .from('tasks')
          .select('*')
          .eq('archived', true)
          .order('archived_at', { ascending: false });

        if (error) throw error;

        // Fetch profiles for name lookups
        const { data: profiles } = await supabase
          .from('profiles')
          .select('user_id, name, role');

        const profileMap = {};
        (profiles || []).forEach(p => {
          profileMap[p.user_id] = p;
        });

        // Add profile data to tasks
        archivedTasks = (tasks || []).map(task => ({
          ...task,
          assigned_to_profile: profileMap[task.assigned_to],
          assigned_by_profile: profileMap[task.assigned_by],
          archived_by_profile: profileMap[task.archived_by]
        }));

        // Update counts
        const count = archivedTasks.length;
        document.getElementById('archiveCount').textContent = count;
        document.getElementById('archiveCountToolbar').textContent = count;

        renderArchivedTasks(archivedTasks);

      } catch (error) {
        console.error('Error loading archived tasks:', error);
        document.getElementById('archivedTasksContainer').innerHTML =
          '<div style="text-align: center; padding: 2rem; color: #EF4444;">◊©◊í◊ô◊ê◊î ◊ë◊ò◊¢◊ô◊†◊™ ◊û◊©◊ô◊û◊ï◊™ ◊û◊ê◊ï◊®◊õ◊ë◊ï◊™</div>';
      }
    }

    function renderArchivedTasks(tasks) {
      const container = document.getElementById('archivedTasksContainer');

      if (!tasks || tasks.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #9CA3AF;">◊ê◊ô◊ü ◊û◊©◊ô◊û◊ï◊™ ◊ë◊ê◊®◊õ◊ô◊ï◊ü</div>';
        return;
      }

      container.innerHTML = tasks.map(task => {
        const assignedToName = task.assigned_to_profile?.name || '◊ú◊ê ◊ô◊ì◊ï◊¢';
        const assignedByName = task.assigned_by_profile?.name || '◊ú◊ê ◊ô◊ì◊ï◊¢';
        const archivedByName = task.archived_by_profile?.name || '◊ú◊ê ◊ô◊ì◊ï◊¢';
        const archivedAt = task.archived_at ? new Date(task.archived_at).toLocaleDateString('he-IL') : '';

        const priorityColors = {
          urgent: '#EF4444',
          high: '#F59E0B',
          medium: '#3B82F6',
          low: '#9CA3AF'
        };

        const priorityLabels = {
          urgent: '◊ì◊ó◊ï◊£',
          high: '◊í◊ë◊ï◊î',
          medium: '◊ë◊ô◊†◊ï◊†◊ô',
          low: '◊†◊û◊ï◊ö'
        };

        const statusLabels = {
          pending: '◊û◊û◊™◊ô◊†◊î',
          in_progress: '◊ë◊ë◊ô◊¶◊ï◊¢',
          awaiting_response: '◊û◊û◊™◊ô◊†◊î ◊ú◊™◊©◊ï◊ë◊î',
          completed: '◊î◊ï◊©◊ú◊û◊î',
          verified: '◊ê◊ï◊©◊®◊î',
          cancelled: '◊ë◊ï◊ò◊ú◊î'
        };

        return `
          <div class="task-card" style="margin-bottom: 1rem; opacity: 0.8;">
            <div class="task-header">
              <div class="task-title">
                ${task.title}
                <span class="priority-badge" style="background: ${priorityColors[task.priority] || '#9CA3AF'};">
                  ${priorityLabels[task.priority] || task.priority}
                </span>
              </div>
              <div class="task-meta">
                <span style="color: #10B981;">‚úì ${statusLabels[task.status] || task.status}</span>
              </div>
            </div>

            ${task.description ? `<div style="color: #9CA3AF; margin: 0.5rem 0; font-size: 0.9rem;">${task.description}</div>` : ''}

            <div style="display: flex; gap: 1rem; margin-top: 0.75rem; flex-wrap: wrap; font-size: 0.85rem; color: #9CA3AF;">
              <div>üë§ ◊î◊ï◊ß◊¶◊î ◊ú: <strong style="color: #fff;">${assignedToName}</strong></div>
              <div>üì§ ◊î◊ï◊ß◊¶◊î ◊¢"◊ô: <strong style="color: #fff;">${assignedByName}</strong></div>
              ${task.plate ? `<div>üöó ${task.plate}</div>` : ''}
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 0.75rem; font-size: 0.85rem; color: #9CA3AF; border-top: 1px solid #3a3a3a; padding-top: 0.75rem;">
              <div>üì¶ ◊î◊ï◊¢◊ë◊® ◊ú◊ê◊®◊õ◊ô◊ï◊ü ◊ë-${archivedAt} ◊¢"◊ô ${archivedByName}</div>
            </div>

            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
              <button class="btn btn-sm" onclick="restoreTask('${task.id}')"
                style="background: #10B981; padding: 0.4rem 1rem; font-size: 0.85rem;">
                ‚Ü©Ô∏è ◊©◊ó◊ñ◊® ◊û◊ê◊®◊õ◊ô◊ï◊ü
              </button>
              <button class="btn btn-sm" onclick="openTaskDetail('${task.id}')"
                style="background: #3B82F6; padding: 0.4rem 1rem; font-size: 0.85rem;">
                üëÅÔ∏è ◊¶◊§◊î
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    window.searchArchivedTasks = function() {
      const search = document.getElementById('archiveSearchInput').value.toLowerCase();

      if (!search) {
        renderArchivedTasks(archivedTasks);
        return;
      }

      const filtered = archivedTasks.filter(task =>
        task.title.toLowerCase().includes(search) ||
        (task.description && task.description.toLowerCase().includes(search)) ||
        (task.assigned_to_profile?.name && task.assigned_to_profile.name.toLowerCase().includes(search)) ||
        (task.plate && task.plate.includes(search))
      );

      renderArchivedTasks(filtered);
    };

    // Update archive count when loading tasks
    async function updateArchiveCount() {
      try {
        const { count, error } = await supabase
          .from('tasks')
          .select('*', { count: 'exact', head: true })
          .eq('archived', true);

        if (!error && count !== null) {
          document.getElementById('archiveCountToolbar').textContent = count;
        }
      } catch (error) {
        console.error('Error updating archive count:', error);
      }
    }

    // Filter and search functions
    window.filterByStatus = function(status) {
      const statusFilter = document.getElementById('statusFilter');
      statusFilter.value = status === 'active' ? 'in_progress' :
                          status === 'overdue' ? '' : status;
      filterTasks();
    };

    window.filterTasks = function() {
      const priority = document.getElementById('priorityFilter').value;
      const status = document.getElementById('statusFilter').value;
      const search = document.getElementById('searchInput').value.toLowerCase();

      let filtered = allTasks;

      if (priority) {
        filtered = filtered.filter(t => t.priority === priority);
      }

      if (status) {
        filtered = filtered.filter(t => t.status === status);
      }

      if (search) {
        filtered = filtered.filter(t =>
          t.title.toLowerCase().includes(search) ||
          (t.description && t.description.toLowerCase().includes(search)) ||
          (t.plate && t.plate.includes(search))
        );
      }

      renderTasks(filtered);
    };

    window.searchTasks = function() {
      filterTasks();
    };

    window.openTaskDetail = function(taskId) {
      window.location.href = `task-detail.html?id=${taskId}`;
    };

    // Utility functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getPriorityIcon(priority) {
      const icons = {
        low: 'üü¢',
        medium: 'üîµ',
        high: '‚ö†Ô∏è',
        urgent: 'üî¥'
      };
      return icons[priority] || '‚ö™';
    }

    function getPriorityLabel(priority) {
      const labels = {
        low: '◊†◊û◊ï◊ö',
        medium: '◊ë◊ô◊†◊ï◊†◊ô',
        high: '◊í◊ë◊ï◊î',
        urgent: '◊ì◊ó◊ï◊£'
      };
      return labels[priority] || priority;
    }

    function getStatusLabel(status) {
      const labels = {
        pending: '◊û◊û◊™◊ô◊†◊î',
        in_progress: '◊ë◊ë◊ô◊¶◊ï◊¢',
        awaiting_response: '◊û◊û◊™◊ô◊†◊î ◊ú◊™◊©◊ï◊ë◊î',
        completed: '◊î◊ï◊©◊ú◊û◊î',
        verified: '◊ê◊ï◊©◊®◊î',
        cancelled: '◊ë◊ï◊ò◊ú◊î'
      };
      return labels[status] || status;
    }

    function formatDate(dateString) {
      if (!dateString) return null;
      const date = new Date(dateString);
      return date.toLocaleDateString('he-IL', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatRelativeTime(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return '◊¢◊õ◊©◊ô◊ï';
      if (diffMins < 60) return `◊ú◊§◊†◊ô ${diffMins} ◊ì◊ß◊ï◊™`;
      if (diffHours < 24) return `◊ú◊§◊†◊ô ${diffHours} ◊©◊¢◊ï◊™`;
      return `◊ú◊§◊†◊ô ${diffDays} ◊ô◊û◊ô◊ù`;
    }

    function showError(message) {
      const container = document.getElementById('tasksContainer');
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">‚ùå</div>
          <h3>${message}</h3>
        </div>
      `;
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
