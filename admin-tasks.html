<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>× ×™×”×•×œ ××©×™××•×ª - ×™×¨×•×Ÿ ×›×™×•×£ - ×©×××•×ª ×•×™×™×¢×•×¥</title>
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans Hebrew', Arial, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      direction: rtl;
      line-height: 1.6;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #003366 0%, #004c99 100%);
      padding: 1rem 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      color: white;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo {
      width: 50px;
      height: 50px;
      object-fit: contain;
      background: white;
      border-radius: 8px;
      padding: 5px;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .badge {
      background: #ff6b35;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
      position: absolute;
      top: -5px;
      left: -5px;
    }

    .icon-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      position: relative;
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      border: 1px solid #3a3a3a;
      transition: all 0.3s;
      cursor: pointer;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
      border-color: #003366;
    }

    .stat-label {
      color: #999;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 0.5rem;
    }

    .stat-change {
      font-size: 0.85rem;
      color: #10B981;
    }

    .stat-change.negative {
      color: #EF4444;
    }

    .toolbar {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
      border: 1px solid #3a3a3a;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Noto Sans Hebrew', Arial, sans-serif;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #ff6b35 0%, #ff8556 100%);
      color: white;
      box-shadow: 0 4px 6px rgba(255, 107, 53, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(255, 107, 53, 0.4);
    }

    .btn-secondary {
      background: #3a3a3a;
      color: #e0e0e0;
      border: 1px solid #4a4a4a;
    }

    .btn-secondary:hover {
      background: #4a4a4a;
    }

    .search-box {
      flex: 1;
      min-width: 250px;
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      border: 1px solid #4a4a4a;
      border-radius: 8px;
      background: #1a1a1a;
      color: #e0e0e0;
      font-family: 'Noto Sans Hebrew', Arial, sans-serif;
      font-size: 1rem;
    }

    .search-box::before {
      content: "ğŸ”";
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .task-card {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      border-right: 4px solid #3a3a3a;
      transition: all 0.3s;
      cursor: pointer;
    }

    .task-card:hover {
      transform: translateX(-5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    /* Task State Styling */
    .task-card.state-pending {
      border-right: 4px solid #9CA3AF;
      background: linear-gradient(135deg, #2a2a2a 0%, #252525 100%);
    }

    .task-card.state-in_progress {
      border-right: 4px solid #3B82F6;
      background: linear-gradient(135deg, #1e2a3a 0%, #2a3544 100%);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
      animation: pulse-blue 3s ease-in-out infinite;
    }

    .task-card.state-awaiting_response {
      border-right: 4px solid #F59E0B;
      background: linear-gradient(135deg, #3a2e1a 0%, #443520 100%);
    }

    .task-card.state-completed {
      border-right: 4px solid #10B981;
      background: linear-gradient(135deg, #1a2e2a 0%, #253a30 100%);
      opacity: 0.95;
    }

    .task-card.state-verified {
      border-right: 4px solid #22C55E;
      background: linear-gradient(135deg, #1a2e2a 0%, #254a35 100%);
      opacity: 0.95;
    }

    .task-card.state-completed .task-title::before,
    .task-card.state-verified .task-title::before {
      content: 'âœ“ ';
      color: #10B981;
      font-weight: bold;
      margin-left: 0.5rem;
    }

    .task-card.state-cancelled {
      border-right: 4px solid #EF4444;
      background: linear-gradient(135deg, #2a2a2a 0%, #252525 100%);
      opacity: 0.7;
    }

    .task-card.overdue {
      animation: pulse-red 3s ease-in-out infinite;
    }

    @keyframes pulse-blue {
      0%, 100% {
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
      }
      50% {
        box-shadow: 0 0 35px rgba(59, 130, 246, 0.4);
      }
    }

    @keyframes pulse-red {
      0%, 100% {
        box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
      }
      50% {
        box-shadow: 0 0 35px rgba(239, 68, 68, 0.5);
      }
    }

    .task-card.high {
      border-right-color: #F59E0B;
    }

    .task-card.urgent {
      border-right-color: #EF4444;
    }

    .task-card.medium {
      border-right-color: #3B82F6;
    }

    .task-card.low {
      border-right-color: #10B981;
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }

    .task-title {
      font-weight: 600;
      color: #fff;
      font-size: 1rem;
    }

    .priority-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .priority-badge.high {
      background: rgba(245, 158, 11, 0.2);
      color: #F59E0B;
    }

    .priority-badge.urgent {
      background: rgba(239, 68, 68, 0.2);
      color: #EF4444;
    }

    .priority-badge.medium {
      background: rgba(59, 130, 246, 0.2);
      color: #3B82F6;
    }

    .priority-badge.low {
      background: rgba(16, 185, 129, 0.2);
      color: #10B981;
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-badge.status-pending {
      background: rgba(156, 163, 175, 0.2);
      color: #9CA3AF;
    }

    .status-badge.status-in_progress {
      background: rgba(59, 130, 246, 0.2);
      color: #3B82F6;
    }

    .status-badge.status-awaiting_response {
      background: rgba(245, 158, 11, 0.2);
      color: #F59E0B;
    }

    .status-badge.status-completed {
      background: rgba(16, 185, 129, 0.2);
      color: #10B981;
    }

    .status-badge.status-verified {
      background: rgba(34, 197, 94, 0.2);
      color: #22C55E;
    }

    .status-badge.status-cancelled {
      background: rgba(239, 68, 68, 0.2);
      color: #EF4444;
    }

    .task-meta {
      display: flex;
      gap: 1rem;
      font-size: 0.85rem;
      color: #999;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }

    .task-stats {
      display: flex;
      gap: 1rem;
      font-size: 0.85rem;
      color: #999;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.open {
      display: flex;
    }

    .modal-content {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid #3a3a3a;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-header h2 {
      color: #fff;
      font-size: 1.5rem;
    }

    .close-btn {
      background: none;
      border: none;
      color: #999;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      color: #fff;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: #e0e0e0;
      font-weight: 500;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #4a4a4a;
      border-radius: 8px;
      background: #1a1a1a;
      color: #e0e0e0;
      font-family: 'Noto Sans Hebrew', Arial, sans-serif;
      font-size: 1rem;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* Multi-select dropdown styles */
    .multi-select-container {
      position: relative;
      width: 100%;
    }

    .multi-select-header {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #4a4a4a;
      border-radius: 8px;
      background: #1a1a1a;
      color: #e0e0e0;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }

    .multi-select-header:hover {
      border-color: #003366;
    }

    .dropdown-arrow {
      font-size: 0.8rem;
      transition: transform 0.2s;
    }

    .multi-select-header.open .dropdown-arrow {
      transform: rotate(180deg);
    }

    .multi-select-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 0.25rem;
      background: #2a2a2a;
      border: 1px solid #4a4a4a;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 100;
      max-height: 300px;
      overflow-y: auto;
    }

    .multi-select-search {
      padding: 0.75rem;
      border-bottom: 1px solid #4a4a4a;
    }

    .multi-select-search input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #4a4a4a;
      border-radius: 6px;
      background: #1a1a1a;
      color: #e0e0e0;
      font-size: 0.9rem;
    }

    .multi-select-options {
      max-height: 200px;
      overflow-y: auto;
    }

    .multi-select-option {
      padding: 0.75rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transition: background 0.2s;
    }

    .multi-select-option:hover {
      background: #3a3a3a;
    }

    .multi-select-option input[type="checkbox"] {
      width: auto;
      margin: 0;
      cursor: pointer;
    }

    .multi-select-option.primary {
      background: #003366;
    }

    .multi-select-option.primary:hover {
      background: #004c99;
    }

    .user-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      margin: 0.125rem;
      background: #003366;
      color: white;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .user-badge.primary {
      background: #0066cc;
      font-weight: 600;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #999;
    }

    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #999;
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .footer {
      text-align: center;
      padding: 2rem;
      color: #666;
      border-top: 1px solid #3a3a3a;
      margin-top: 3rem;
    }

    @media (max-width: 768px) {
      .container {
        padding: 0.75rem;
      }

      .header {
        padding: 0.75rem 1rem;
        flex-wrap: wrap;
      }

      .header h1 {
        font-size: 1rem;
        gap: 0.5rem;
      }

      .logo {
        width: 35px;
        height: 35px;
      }

      .header-actions {
        gap: 0.5rem;
      }

      .icon-btn {
        width: 36px;
        height: 36px;
        font-size: 1.2rem;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
      }

      .stat-card {
        padding: 1rem;
      }

      .stat-value {
        font-size: 1.75rem;
      }

      .stat-label {
        font-size: 0.8rem;
      }

      .section-title {
        font-size: 1.1rem;
        margin-bottom: 0.75rem;
      }

      .toolbar {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
        padding: 1rem;
      }

      .btn {
        padding: 0.875rem 1.25rem;
        font-size: 0.95rem;
        min-height: 48px;
        justify-content: center;
      }

      .search-box {
        width: 100%;
      }

      .search-box input {
        padding: 0.875rem 1rem 0.875rem: 2.75rem;
        font-size: 16px; /* Prevents iOS zoom */
      }

      /* Modal improvements for mobile */
      .modal-content {
        width: 95%;
        max-width: 95%;
        margin: 1rem;
        max-height: 90vh;
        overflow-y: auto;
        padding: 1rem;
      }

      .modal-header h2 {
        font-size: 1.2rem;
      }

      .form-group {
        margin-bottom: 1.25rem;
      }

      .form-group label {
        font-size: 0.9rem;
        margin-bottom: 0.4rem;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        padding: 0.875rem;
        font-size: 16px; /* Prevents iOS zoom */
        min-height: 48px;
      }

      .form-group textarea {
        min-height: 100px;
      }

      /* Multi-select dropdown mobile */
      .multi-select-header {
        padding: 0.875rem;
        font-size: 16px;
        min-height: 48px;
      }

      .multi-select-option {
        padding: 1rem 0.875rem;
        min-height: 48px;
      }

      /* Task cards mobile */
      .task-card {
        padding: 1rem;
        margin-bottom: 0.75rem;
      }

      .task-title {
        font-size: 0.95rem;
        margin-bottom: 0.5rem;
      }

      .task-meta {
        flex-direction: column;
        gap: 0.5rem;
        font-size: 0.8rem;
      }

      .task-stats {
        flex-direction: column;
        gap: 0.5rem;
      }

      .task-actions {
        flex-wrap: wrap;
      }

      .task-actions button {
        flex: 1;
        min-width: 100px;
        min-height: 44px;
      }

      .priority-badge,
      .status-badge {
        padding: 0.3rem 0.65rem;
        font-size: 0.7rem;
      }

      /* Date picker mobile improvements */
      .form-group input[type="date"] {
        min-height: 48px;
        font-size: 16px;
      }

      /* Quick date buttons */
      .form-group button {
        padding: 0.75rem;
        min-height: 44px;
        font-size: 0.85rem;
      }

      /* Recurring options mobile */
      #recurringOptions {
        padding: 0.875rem;
      }

      /* Child tasks mobile */
      .child-task-item {
        padding: 0.875rem !important;
      }

      /* Template section mobile */
      .multi-select-container {
        font-size: 16px;
      }

      /* Dashboard stats mobile */
      div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
        gap: 0.75rem;
      }

      /* Better touch targets */
      button,
      .btn,
      select,
      input[type="checkbox"],
      input[type="radio"] {
        cursor: pointer;
      }

      input[type="checkbox"],
      input[type="radio"] {
        min-width: 20px;
        min-height: 20px;
      }

      /* Hide long text on mobile */
      .header h1 span {
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      /* Scrollable tables */
      .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo" class="logo">
      <span>×™×¨×•×Ÿ ×›×™×•×£ - ×©×××•×ª ×•×™×™×¢×•×¥ - × ×™×”×•×œ ××©×™××•×ª</span>
    </h1>
    <div class="header-actions">
      <div class="icon-btn" onclick="window.location.href='selection.html'">
        ğŸ 
      </div>
      <div class="icon-btn" onclick="window.location.href='admin.html'">
        ğŸ‘¤
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Statistics Section -->
    <div class="section-title">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×” ×›×œ×œ×™×ª</div>
    <div class="stats-grid">
      <div class="stat-card" onclick="filterByStatus('active')">
        <div class="stat-label">××©×™××•×ª ×¤×¢×™×œ×•×ª</div>
        <div class="stat-value" id="activeCount">0</div>
        <div class="stat-change" id="activeChange">×˜×•×¢×Ÿ...</div>
      </div>
      <div class="stat-card" onclick="filterByStatus('pending')">
        <div class="stat-label">×××ª×™× ×•×ª ×œ×ª×’×•×‘×”</div>
        <div class="stat-value" id="pendingCount">0</div>
        <div class="stat-change" id="pendingChange">×˜×•×¢×Ÿ...</div>
      </div>
      <div class="stat-card" onclick="filterByStatus('completed')">
        <div class="stat-label">×”×•×©×œ××• ×”×™×•×</div>
        <div class="stat-value" id="completedCount">0</div>
        <div class="stat-change" id="completedChange">×˜×•×¢×Ÿ...</div>
      </div>
      <div class="stat-card" onclick="filterByStatus('overdue')">
        <div class="stat-label">××™×—×•×¨ ×‘×™×¦×•×¢</div>
        <div class="stat-value" id="overdueCount">0</div>
        <div class="stat-change negative" id="overdueChange">×˜×•×¢×Ÿ...</div>
      </div>
    </div>

    <!-- Enhanced Analytics Dashboard -->
    <div class="section-title" style="margin-top: 2rem;">ğŸ“ˆ ×œ×•×— ×‘×§×¨×” ××ª×§×“×</div>
    <div style="background: #2a2a2a; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">

      <!-- Overall Fulfillment -->
      <div style="margin-bottom: 2rem;">
        <h3 style="color: #fff; font-size: 1.1rem; margin-bottom: 1rem;">ğŸ“Š ××—×•×– ×”×©×œ××” ×›×œ×œ×™</h3>
        <div style="display: flex; align-items: center; gap: 1rem;">
          <div style="flex: 1;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
              <span style="color: #9CA3AF;">×¡×”"×› ××©×™××•×ª: <span id="totalTasksCount">0</span></span>
              <span style="color: #10B981; font-weight: bold; font-size: 1.2rem;"><span id="fulfillmentRate">0</span>%</span>
            </div>
            <div style="background: rgba(255,255,255,0.1); height: 24px; border-radius: 12px; overflow: hidden;">
              <div id="fulfillmentBar" style="background: linear-gradient(90deg, #10B981, #22C55E); height: 100%; width: 0%; transition: width 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.85rem;"></div>
            </div>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;">
          <div style="background: rgba(59, 130, 246, 0.1); padding: 0.75rem; border-radius: 8px;">
            <div style="color: #9CA3AF; font-size: 0.85rem;">×‘×‘×™×¦×•×¢</div>
            <div style="color: #3B82F6; font-size: 1.5rem; font-weight: bold;" id="inProgressCount">0</div>
          </div>
          <div style="background: rgba(16, 185, 129, 0.1); padding: 0.75rem; border-radius: 8px;">
            <div style="color: #9CA3AF; font-size: 0.85rem;">×”×•×©×œ××•</div>
            <div style="color: #10B981; font-size: 1.5rem; font-weight: bold;" id="completedTasksCount">0</div>
          </div>
          <div style="background: rgba(239, 68, 68, 0.1); padding: 0.75rem; border-radius: 8px;">
            <div style="color: #9CA3AF; font-size: 0.85rem;">×‘××™×—×•×¨</div>
            <div style="color: #EF4444; font-size: 1.5rem; font-weight: bold;" id="overdueTasksCount">0</div>
          </div>
        </div>
      </div>

      <!-- Per User Statistics -->
      <div style="margin-bottom: 2rem;">
        <h3 style="color: #fff; font-size: 1.1rem; margin-bottom: 1rem;">ğŸ‘¥ ×‘×™×¦×•×¢×™× ×œ×¤×™ ××©×ª××©</h3>
        <div id="userStatsContainer" style="display: flex; flex-direction: column; gap: 1rem;">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>

      <!-- Filters -->
      <div style="border-top: 1px solid #3a3a3a; padding-top: 1.5rem;">
        <h3 style="color: #fff; font-size: 1.1rem; margin-bottom: 1rem;">ğŸ” ×¡×™× ×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
          <div>
            <label style="color: #9CA3AF; font-size: 0.85rem; display: block; margin-bottom: 0.5rem;">××©×ª××©</label>
            <select id="statsUserFilter" onchange="updateDashboardStats()" style="width: 100%; padding: 0.5rem; border-radius: 6px; background: #1a1a1a; color: #e0e0e0; border: 1px solid #4a4a4a;">
              <option value="">×›×œ ×”××©×ª××©×™×</option>
            </select>
          </div>
          <div>
            <label style="color: #9CA3AF; font-size: 0.85rem; display: block; margin-bottom: 0.5rem;">×¡×•×’ ××©×™××”</label>
            <select id="statsTypeFilter" onchange="updateDashboardStats()" style="width: 100%; padding: 0.5rem; border-radius: 6px; background: #1a1a1a; color: #e0e0e0; border: 1px solid #4a4a4a;">
              <option value="">×›×œ ×”×¡×•×’×™×</option>
              <option value="case_action">×¤×¢×•×œ×” ×‘×ª×™×§</option>
              <option value="document_request">×‘×§×©×ª ××¡××š</option>
              <option value="review_request">×‘×§×©×ª ×‘×™×§×•×¨×ª</option>
              <option value="data_correction">×ª×™×§×•×Ÿ × ×ª×•× ×™×</option>
              <option value="follow_up">××¢×§×‘</option>
              <option value="custom">××—×¨</option>
            </select>
          </div>
          <div>
            <label style="color: #9CA3AF; font-size: 0.85rem; display: block; margin-bottom: 0.5rem;">×¢×“×™×¤×•×ª</label>
            <select id="statsPriorityFilter" onchange="updateDashboardStats()" style="width: 100%; padding: 0.5rem; border-radius: 6px; background: #1a1a1a; color: #e0e0e0; border: 1px solid #4a4a4a;">
              <option value="">×›×œ ×”×¢×“×™×¤×•×™×•×ª</option>
              <option value="urgent">×“×—×•×£</option>
              <option value="high">×’×‘×•×”</option>
              <option value="medium">×‘×™× ×•× ×™</option>
              <option value="low">× ××•×š</option>
            </select>
          </div>
        </div>
      </div>

    </div>

    <!-- Activity Feed Section -->
    <div style="margin-bottom: 2rem;">
      <div class="section-title" style="cursor: pointer; user-select: none; display: flex; align-items: center; justify-content: space-between;" onclick="toggleActivityFeed()">
        <span>ğŸ“‹ ×¤×¢×™×œ×•×ª ××—×¨×•× ×”</span>
        <span id="activity-toggle-arrow" style="transition: transform 0.2s;">â–¼</span>
      </div>
      <div id="activity-feed-container" style="display: none; margin-top: 1rem;">
        <div style="background: #1e1e1e; border-radius: 8px; overflow: hidden; max-height: 500px;">
          <div id="activity-feed" style="overflow-y: auto; max-height: 500px;">
            <div style="text-align: center; padding: 40px 20px; color: #999;">×˜×•×¢×Ÿ...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <button class="btn btn-primary" onclick="openNewTaskModal()">â• ××©×™××” ×—×“×©×”</button>
      <button class="btn btn-secondary" onclick="openNewThreadModal()">ğŸ§µ ×©×¨×©×•×¨ ×—×“×©</button>
      <button class="btn btn-secondary" onclick="openArchiveModal()">ğŸ“¦ ××¨×›×™×•×Ÿ (<span id="archiveCountToolbar">0</span>)</button>
      <button id="sendNotificationsBtn" class="btn btn-success" onclick="sendBatchNotifications()" style="display: none; background: #10B981;">
        ğŸ“¬ ×©×œ×— ×”×ª×¨××•×ª (<span id="notificationBadge">0</span>)
      </button>
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="×—×™×¤×•×© ××©×™××•×ª..." oninput="searchTasks()">
      </div>
      <select class="btn btn-secondary" id="priorityFilter" onchange="filterTasks()">
        <option value="">×›×œ ×”×¢×“×™×¤×•×™×•×ª</option>
        <option value="urgent">×“×—×•×£</option>
        <option value="high">×’×‘×•×”</option>
        <option value="medium">×‘×™× ×•× ×™</option>
        <option value="low">× ××•×š</option>
      </select>
      <select class="btn btn-secondary" id="statusFilter" onchange="filterTasks()">
        <option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
        <option value="pending">×××ª×™× ×”</option>
        <option value="in_progress">×‘×‘×™×¦×•×¢</option>
        <option value="awaiting_response">×××ª×™× ×” ×œ×ª×©×•×‘×”</option>
        <option value="completed">×”×•×©×œ××”</option>
        <option value="verified">××•×©×¨×”</option>
      </select>
    </div>

    <!-- Tasks Section -->
    <div class="section-title">ğŸ“‹ ××©×™××•×ª ××—×¨×•× ×•×ª</div>
    <div id="tasksContainer">
      <div class="loading">×˜×•×¢×Ÿ ××©×™××•×ª</div>
    </div>
  </div>

  <!-- New Task Modal -->
  <div id="newTaskModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>â• ××©×™××” ×—×“×©×”</h2>
        <button class="close-btn" onclick="closeNewTaskModal()">âœ•</button>
      </div>
      <form id="newTaskForm" onsubmit="createTask(event)">
        <!-- Template Section -->
        <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #3a3a3a;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
            <label style="margin: 0; font-weight: 600; color: #ffd700;">ğŸ“‹ ×ª×‘× ×™×•×ª ××©×™××”</label>
            <button type="button" onclick="openTemplateManager()" class="btn btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
              âš™ï¸ × ×™×”×•×œ ×ª×‘× ×™×•×ª
            </button>
          </div>
          <div style="display: flex; gap: 0.5rem;">
            <select id="templateSelect" onchange="loadTemplate()" style="flex: 1; padding: 0.5rem; background: #1a1a1a; border: 1px solid #3a3a3a; border-radius: 6px; color: white;">
              <option value="">×˜×¢×Ÿ ××ª×‘× ×™×ª ×§×™×™××ª...</option>
            </select>
            <button type="button" onclick="clearTemplate()" class="btn btn-secondary" style="padding: 0.5rem 1rem;">
              ğŸ—‘ï¸ × ×§×”
            </button>
          </div>
        </div>

        <div class="form-group">
          <label for="taskTitle">×›×•×ª×¨×ª ×”××©×™××” *</label>
          <input type="text" id="taskTitle" required>
        </div>
        <div class="form-group">
          <label for="taskDescription">×ª×™××•×¨</label>
          <textarea id="taskDescription"></textarea>
        </div>
        <div class="form-group">
          <label for="taskType">×¡×•×’ ××©×™××”</label>
          <select id="taskType">
            <option value="custom">×›×œ×œ×™×ª</option>
            <option value="case_action">×¤×¢×•×œ×” ×‘×ª×™×§</option>
            <option value="document_request">×‘×§×©×ª ××¡××š</option>
            <option value="review_request">×‘×§×©×ª ×¡×§×™×¨×”</option>
            <option value="data_correction">×ª×™×§×•×Ÿ × ×ª×•× ×™×</option>
            <option value="follow_up">××¢×§×‘</option>
          </select>
        </div>
        <div class="form-group">
          <label for="assignedTo">×”×§×¦×” ×œ- * (× ×™×ª×Ÿ ×œ×‘×—×•×¨ ××¡×¤×¨ ××©×ª××©×™×)</label>
          <div class="multi-select-container">
            <div class="multi-select-header" id="multiSelectHeader" onclick="toggleUserDropdown()">
              <span id="selectedUsersDisplay">×‘×—×¨ ××©×ª××©×™×...</span>
              <span class="dropdown-arrow">â–¼</span>
            </div>
            <div class="multi-select-dropdown" id="userDropdown" style="display: none;">
              <div class="multi-select-search">
                <input type="text" id="userSearch" placeholder="×—×¤×© ××©×ª××©..." onkeyup="filterUsers()">
              </div>
              <div class="multi-select-options" id="userOptions">
                <!-- Will be populated dynamically -->
              </div>
            </div>
          </div>
          <input type="hidden" id="assignedTo" required>
        </div>
        <div class="form-group">
          <label for="taskPriority">×¢×“×™×¤×•×ª</label>
          <select id="taskPriority">
            <option value="low">× ××•×›×”</option>
            <option value="medium" selected>×‘×™× ×•× ×™×ª</option>
            <option value="high">×’×‘×•×”×”</option>
            <option value="urgent">×“×—×•×¤×”</option>
          </select>
        </div>
        <div class="form-group">
          <label for="dueDate">×ª××¨×™×š ×™×¢×“</label>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="date" id="dueDate" style="flex: 1; cursor: pointer;">
            <button type="button" onclick="setDueDate('today')" class="btn btn-secondary" style="padding: 0.5rem 0.75rem; white-space: nowrap;">
              ×”×™×•×
            </button>
            <button type="button" onclick="setDueDate('tomorrow')" class="btn btn-secondary" style="padding: 0.5rem 0.75rem; white-space: nowrap;">
              ××—×¨
            </button>
            <button type="button" onclick="setDueDate('week')" class="btn btn-secondary" style="padding: 0.5rem 0.75rem; white-space: nowrap;">
              ×©×‘×•×¢
            </button>
          </div>
        </div>

        <!-- Recurring Task Options -->
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" id="isRecurring" onchange="toggleRecurringOptions()" style="width: auto; margin: 0;">
            <span>×”×¤×•×š ×œ××©×™××” ×—×•×–×¨×ª</span>
          </label>
        </div>

        <div id="recurringOptions" style="display: none; border: 1px solid #4a4a4a; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
          <div class="form-group">
            <label for="recurrenceType">×ª×“×™×¨×•×ª</label>
            <select id="recurrenceType" onchange="updateRecurrenceFields()">
              <option value="daily">×™×•××™</option>
              <option value="weekly">×©×‘×•×¢×™</option>
              <option value="monthly">×—×•×“×©×™</option>
            </select>
          </div>

          <div class="form-group">
            <label for="recurrenceInterval">×—×–×•×¨ ×›×œ</label>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <input type="number" id="recurrenceInterval" value="1" min="1" max="365" style="width: 80px;">
              <span id="intervalLabel">×™××™×</span>
            </div>
          </div>

          <!-- Weekly options -->
          <div class="form-group" id="weeklyOptions" style="display: none;">
            <label>×™××™× ×‘×©×‘×•×¢</label>
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
              <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                <input type="checkbox" value="0" class="day-checkbox" style="width: auto; margin: 0;"> ×¨××©×•×Ÿ
              </label>
              <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                <input type="checkbox" value="1" class="day-checkbox" style="width: auto; margin: 0;"> ×©× ×™
              </label>
              <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                <input type="checkbox" value="2" class="day-checkbox" style="width: auto; margin: 0;"> ×©×œ×™×©×™
              </label>
              <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                <input type="checkbox" value="3" class="day-checkbox" style="width: auto; margin: 0;"> ×¨×‘×™×¢×™
              </label>
              <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                <input type="checkbox" value="4" class="day-checkbox" style="width: auto; margin: 0;"> ×—××™×©×™
              </label>
              <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                <input type="checkbox" value="5" class="day-checkbox" style="width: auto; margin: 0;"> ×©×™×©×™
              </label>
              <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                <input type="checkbox" value="6" class="day-checkbox" style="width: auto; margin: 0;"> ×©×‘×ª
              </label>
            </div>
          </div>

          <!-- Monthly options -->
          <div class="form-group" id="monthlyOptions" style="display: none;">
            <label for="dayOfMonth">×™×•× ×‘×—×•×“×©</label>
            <input type="number" id="dayOfMonth" value="1" min="1" max="31">
          </div>

          <div class="form-group">
            <label for="recurrenceStartDate">×ª××¨×™×š ×”×ª×—×œ×”</label>
            <input type="date" id="recurrenceStartDate">
          </div>

          <div class="form-group">
            <label for="recurrenceEndDate">×ª××¨×™×š ×¡×™×•× (××•×¤×¦×™×•× ×œ×™)</label>
            <input type="date" id="recurrenceEndDate">
            <small style="color: #999; font-size: 0.85rem;">×”×©××¨ ×¨×™×§ ×œ××©×™××” ×œ×œ× ×¡×•×£</small>
          </div>

          <div class="form-group">
            <label for="templateName">×©× ×ª×‘× ×™×ª</label>
            <input type="text" id="templateName" placeholder="×œ×“×•×’××”: ×‘×“×™×§×ª ××œ××™ ×™×•××™×ª">
          </div>
        </div>

        <div class="form-group">
          <label for="filingCaseId">××¡×¤×¨ ×ª×™×§ (××•×¤×¦×™×•× ×œ×™)</label>
          <select id="filingCaseId" onchange="onCaseSelected()">
            <option value="">×‘×—×¨ ×ª×™×§...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="plateDropdown">××¡×¤×¨ ×¨×™×©×•×™ (××•×¤×¦×™×•× ×œ×™)</label>
          <select id="plateDropdown" onchange="onPlateDropdownChange()">
            <option value="">×‘×—×¨ ××¡×¤×¨ ×¨×™×©×•×™...</option>
            <option value="__manual__">×”×–× ×” ×™×“× ×™×ª</option>
          </select>
        </div>
        <div class="form-group" id="plateManualGroup" style="display: none;">
          <label for="plateManual">×”×–×Ÿ ××¡×¤×¨ ×¨×™×©×•×™ ×™×“× ×™×ª</label>
          <input type="text" id="plateManual" placeholder="12-345-67">
        </div>

        <!-- Child Tasks Section -->
        <div class="form-group" style="border-top: 1px solid #3a3a3a; padding-top: 1.5rem; margin-top: 1.5rem;">
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" id="hasChildTasks" onchange="toggleChildTasksSection()" style="width: auto;">
            <span>×œ××©×™××” ×–×• ×™×© ××©×™××•×ª ×™×œ×“ (×ª×ª×™-××©×™××•×ª)</span>
          </label>
        </div>

        <div id="childTasksSection" style="display: none; border: 1px solid #3a3a3a; border-radius: 8px; padding: 1rem; margin-top: 1rem; background: #252525;">
          <h3 style="margin: 0 0 1rem 0; font-size: 1rem; color: #10B981;">ğŸ”— ××©×™××•×ª ×™×œ×“</h3>
          <p style="font-size: 0.85rem; color: #999; margin-bottom: 1rem;">×›×œ ××©×™××ª ×™×œ×“ ×¢×¦×××™×ª ×‘×‘×™×¦×•×¢ ×•××“×™×“×”, ××š ×©×™×™×›×ª ×œ××•×ª×• ×”×§×©×¨ ×©×œ ×”××©×™××” ×”×¨××©×™×ª</p>

          <div id="childTasksList">
            <!-- Child tasks will be added here dynamically -->
          </div>

          <button type="button" class="btn btn-secondary" onclick="addChildTask()" style="width: 100%; margin-top: 0.5rem;">
            â• ×”×•×¡×£ ××©×™××ª ×™×œ×“ × ×•×¡×¤×ª
          </button>
        </div>

        <!-- Save as Template Button -->
        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #3a3a3a;">
          <button type="button" onclick="saveAsTemplate()" class="btn" style="width: 100%; background: #2a5a2a; border: 1px solid #3a7a3a;">
            ğŸ’¾ ×©××•×¨ ×›×ª×‘× ×™×ª
          </button>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
          <button type="submit" class="btn btn-primary" style="flex: 1;">âœ… ×¦×•×¨ ××©×™××”</button>
          <button type="button" class="btn btn-secondary" onclick="closeNewTaskModal()">×‘×™×˜×•×œ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Task Modal -->
  <div id="editTaskModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>âœï¸ ×¢×¨×•×š ××©×™××”</h2>
        <button class="close-btn" onclick="closeEditTaskModal()">âœ•</button>
      </div>
      <form onsubmit="saveTaskEdits(event)">
        <div class="form-group">
          <label for="editTaskTitle">×›×•×ª×¨×ª ×”××©×™××” *</label>
          <input type="text" id="editTaskTitle" required placeholder="×”×–×Ÿ ×›×•×ª×¨×ª ×œ××©×™××”...">
        </div>
        <div class="form-group">
          <label for="editTaskDescription">×ª×™××•×¨ ×”××©×™××”</label>
          <textarea id="editTaskDescription" rows="4" placeholder="×”×–×Ÿ ×ª×™××•×¨ ××¤×•×¨×˜..."></textarea>
        </div>
        <div class="form-group">
          <label for="editTaskType">×¡×•×’ ×”××©×™××”</label>
          <select id="editTaskType">
            <option value="case_action">×¤×¢×•×œ×” ×‘×ª×™×§</option>
            <option value="document_request">×‘×§×©×ª ××¡××š</option>
            <option value="review_request">×‘×§×©×ª ×‘×™×§×•×¨×ª</option>
            <option value="data_correction">×ª×™×§×•×Ÿ × ×ª×•× ×™×</option>
            <option value="follow_up">××¢×§×‘</option>
            <option value="custom">××—×¨</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editAssignedTo">×”×§×¦×” ×œ *</label>
          <select id="editAssignedTo" required>
            <option value="">×‘×—×¨ ××©×ª××©...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editTaskPriority">×¢×“×™×¤×•×ª</label>
          <select id="editTaskPriority">
            <option value="low">× ××•×›×”</option>
            <option value="medium">×‘×™× ×•× ×™×ª</option>
            <option value="high">×’×‘×•×”×”</option>
            <option value="urgent">×“×—×•×£</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editDueDate">×ª××¨×™×š ×™×¢×“</label>
          <input type="date" id="editDueDate">
        </div>
        <div class="form-group">
          <label for="editFilingCaseId">××¡×¤×¨ ×ª×™×§ (××•×¤×¦×™×•× ×œ×™)</label>
          <select id="editFilingCaseId">
            <option value="">×‘×—×¨ ×ª×™×§...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editPlate">××¡×¤×¨ ×¨×™×©×•×™ (××•×¤×¦×™×•× ×œ×™)</label>
          <input type="text" id="editPlate" placeholder="12-345-67">
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
          <button type="submit" class="btn btn-primary" style="flex: 1;">ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×</button>
          <button type="button" class="btn btn-secondary" onclick="closeEditTaskModal()">×‘×™×˜×•×œ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Template Manager Modal -->
  <div id="templateManagerModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header">
        <h2>âš™ï¸ × ×™×”×•×œ ×ª×‘× ×™×•×ª ××©×™××”</h2>
        <button class="close-btn" onclick="closeTemplateManager()">âœ•</button>
      </div>
      <div style="padding: 1.5rem;">
        <!-- Templates List -->
        <div id="templatesListContainer" style="margin-bottom: 2rem;">
          <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; color: #ffd700;">ğŸ“‹ ×”×ª×‘× ×™×•×ª ×©×œ×™</h3>
            <span id="templateCount" style="color: #999; font-size: 0.9rem;">0 ×ª×‘× ×™×•×ª</span>
          </div>
          <div id="templatesList" style="max-height: 400px; overflow-y: auto;">
            <div style="text-align: center; padding: 2rem; color: #999;">
              <p>××™×Ÿ ×ª×‘× ×™×•×ª ×©××•×¨×•×ª</p>
              <p style="font-size: 0.9rem;">×¦×•×¨ ××©×™××” ×•×œ×—×¥ ×¢×œ "ğŸ’¾ ×©××•×¨ ×›×ª×‘× ×™×ª" ×›×“×™ ×œ×”×ª×—×™×œ</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Archive Modal -->
  <div id="archiveModal" class="modal">
    <div class="modal-content" style="max-width: 1200px;">
      <div class="modal-header">
        <h2>ğŸ“¦ ××¨×›×™×•×Ÿ ××©×™××•×ª (<span id="archiveCount">0</span>)</h2>
        <button class="close-btn" onclick="closeArchiveModal()">âœ•</button>
      </div>

      <div style="margin-bottom: 1.5rem;">
        <div class="search-box">
          <input type="text" id="archiveSearchInput" placeholder="ğŸ” ×—×™×¤×•×© ×‘××¨×›×™×•×Ÿ..." oninput="searchArchivedTasks()">
        </div>
      </div>

      <div id="archivedTasksContainer" style="max-height: 600px; overflow-y: auto;">
        <div class="loading">×˜×•×¢×Ÿ ××©×™××•×ª ×××•×¨×›×‘×•×ª...</div>
      </div>

      <div style="text-align: center; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #3a3a3a;">
        <button type="button" class="btn btn-secondary" onclick="closeArchiveModal()">×¡×’×•×¨</button>
      </div>
    </div>
  </div>

  <div class="footer">
    Â©2025 Carmel Cayouf. All rights reserved. SmartVal Pro System by Evalix
  </div>

  <script type="module">
    import { supabase } from './lib/supabaseClient.js';
    import { taskNotifications } from './task-notifications.js';
    import { notificationCenter } from './components/notification-center.js';
    import { taskActivityFeed } from './components/task-activity-feed.js';

    // Global state
    let allTasks = [];
    let allUsers = [];
    let currentUser = null;

    // ============================================================================
    // RECURRING TASKS SCHEDULER
    // ============================================================================
    async function processRecurringTasks() {
      try {
        const today = new Date().toISOString().split('T')[0];

        // Find all active recurring tasks that are due
        const { data: dueTasks, error } = await supabase
          .from('recurring_tasks')
          .select('*')
          .lte('next_run_date', today)
          .eq('is_active', true)
          .eq('paused', false);

        if (error) throw error;

        if (!dueTasks || dueTasks.length === 0) {
          console.log('ğŸ“… No recurring tasks due today');
          return;
        }

        console.log(`ğŸ“… Found ${dueTasks.length} recurring tasks to process`);

        for (const recurringTask of dueTasks) {
          try {
            // Create task from template
            const assignedUsers = recurringTask.assigned_to_users || [];
            const primaryAssignee = assignedUsers[0];

            if (!primaryAssignee) {
              console.error('No assigned users for recurring task:', recurringTask.id);
              continue;
            }

            const newTask = {
              title: recurringTask.title,
              description: recurringTask.description,
              task_type: recurringTask.task_type,
              assigned_to: primaryAssignee,
              assigned_by: recurringTask.assigned_by,
              priority: recurringTask.priority,
              due_date: null, // Can be customized
              status: 'pending',
              completion_percentage: 0
            };

            // Insert new task
            const { data: createdTask, error: taskError } = await supabase
              .from('tasks')
              .insert([newTask])
              .select()
              .single();

            if (taskError) throw taskError;

            // Create task assignments for all users
            if (assignedUsers.length > 0) {
              const assignments = assignedUsers.map((userId, index) => ({
                task_id: createdTask.id,
                user_id: userId,
                is_primary: index === 0,
                assigned_by: recurringTask.assigned_by
              }));

              await supabase
                .from('task_assignments')
                .insert(assignments);
            }

            // Calculate next run date using SQL function
            const { data: nextDate } = await supabase
              .rpc('calculate_next_run_date', {
                p_recurrence_type: recurringTask.recurrence_type,
                p_interval: recurringTask.recurrence_interval,
                p_current_date: recurringTask.next_run_date,
                p_days_of_week: recurringTask.days_of_week || [],
                p_day_of_month: recurringTask.day_of_month
              });

            // Update recurring task with new next_run_date
            await supabase
              .from('recurring_tasks')
              .update({
                next_run_date: nextDate,
                last_run_date: new Date().toISOString(),
                total_tasks_created: (recurringTask.total_tasks_created || 0) + 1
              })
              .eq('id', recurringTask.id);

            console.log(`âœ… Created task from recurring template: ${recurringTask.template_name}`);

          } catch (taskError) {
            console.error(`Error processing recurring task ${recurringTask.id}:`, taskError);
          }
        }

      } catch (error) {
        console.error('Error in recurring tasks scheduler:', error);
      }
    }

    // Initialize
    async function init() {
      try {
        // Get current user
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          window.location.href = 'index.html';
          return;
        }

        // Get user profile
        const { data: profile } = await supabase
          .from('profiles')
          .select('*')
          .eq('user_id', user.id)
          .single();

        currentUser = profile;
        console.log('Current user:', currentUser);

        // Check access - only admin and developer can access this page
        if (profile.role !== 'admin' && profile.role !== 'developer') {
          alert('â›” ××™×Ÿ ×œ×š ×”×¨×©××” ×œ×’×©×ª ×œ×“×£ ×–×”\n\n×¨×§ ×× ×”×œ×™× ×•××¤×ª×—×™× ×™×›×•×œ×™× ×œ× ×”×œ ××©×™××•×ª.');
          window.location.href = 'user-tasks.html';
          return;
        }

        // Load users for assignment dropdown
        await loadUsers();

        // Load cases and plates for dropdowns
        await populateCaseDropdown();
        await populatePlateDropdown();

        // Load tasks
        await loadTasks();

        // Update stats
        await updateStats();

        // Update archive count
        await updateArchiveCount();

        // Set up real-time subscriptions
        setupRealtime();

        // Initialize activity feed
        await taskActivityFeed.init('activity-feed');

        // Load task templates
        await loadTaskTemplates();

        // Process recurring tasks (check for due tasks and create them)
        await processRecurringTasks();

      } catch (error) {
        console.error('Initialization error:', error);
        showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×');
      }
    }

    // Load all users for assignment dropdown
    async function loadUsers() {
      try {
        // Load users with their organization, exclude Evalix org
        const { data, error } = await supabase
          .from('profiles')
          .select('user_id, name, role, org_id, orgs(name)')
          .order('name');

        if (error) throw error;

        // Filter out Evalix organization users (developer org)
        allUsers = (data || []).filter(user => {
          const orgName = user.orgs?.name;
          return orgName !== 'Evalix';
        });

        console.log(`Loaded ${allUsers.length} users (excluding Evalix org)`);
        populateUserDropdown();

      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    // Track selected users for multi-select
    let selectedUsers = [];

    function populateUserDropdown() {
      const container = document.getElementById('userOptions');
      if (!container) return;

      container.innerHTML = '';

      allUsers.forEach(user => {
        const option = document.createElement('div');
        option.className = 'multi-select-option';
        option.innerHTML = `
          <input type="checkbox"
                 id="user_${user.user_id}"
                 value="${user.user_id}"
                 onchange="updateUserSelection('${user.user_id}')"
                 ${selectedUsers.includes(user.user_id) ? 'checked' : ''}>
          <label for="user_${user.user_id}" style="cursor: pointer; flex: 1;">
            ${user.name} (${getRoleLabel(user.role)})
          </label>
        `;
        container.appendChild(option);
      });
    }

    // Quick date setter for due date
    window.setDueDate = function(option) {
      const dateInput = document.getElementById('dueDate');
      const today = new Date();
      let targetDate;

      switch(option) {
        case 'today':
          targetDate = today;
          break;
        case 'tomorrow':
          targetDate = new Date(today);
          targetDate.setDate(today.getDate() + 1);
          break;
        case 'week':
          targetDate = new Date(today);
          targetDate.setDate(today.getDate() + 7);
          break;
        default:
          targetDate = today;
      }

      // Format date as YYYY-MM-DD for input[type="date"]
      const year = targetDate.getFullYear();
      const month = String(targetDate.getMonth() + 1).padStart(2, '0');
      const day = String(targetDate.getDate()).padStart(2, '0');
      dateInput.value = `${year}-${month}-${day}`;
    };

    window.toggleUserDropdown = function() {
      const dropdown = document.getElementById('userDropdown');
      const header = document.getElementById('multiSelectHeader');

      if (dropdown.style.display === 'none') {
        dropdown.style.display = 'block';
        header.classList.add('open');
      } else {
        dropdown.style.display = 'none';
        header.classList.remove('open');
      }
    };

    window.updateUserSelection = function(userId) {
      const checkbox = document.getElementById(`user_${userId}`);

      if (checkbox.checked) {
        if (!selectedUsers.includes(userId)) {
          selectedUsers.push(userId);
        }
      } else {
        selectedUsers = selectedUsers.filter(id => id !== userId);
      }

      updateSelectedUsersDisplay();
      updateHiddenInput();
    };

    function updateSelectedUsersDisplay() {
      const display = document.getElementById('selectedUsersDisplay');

      if (selectedUsers.length === 0) {
        display.textContent = '×‘×—×¨ ××©×ª××©×™×...';
        return;
      }

      const selectedNames = selectedUsers.map(userId => {
        const user = allUsers.find(u => u.user_id === userId);
        return user ? user.name : '';
      }).filter(name => name);

      if (selectedNames.length === 1) {
        display.textContent = selectedNames[0];
      } else if (selectedNames.length === 2) {
        display.textContent = selectedNames.join(' ×•-');
      } else {
        display.textContent = `${selectedNames.length} ××©×ª××©×™× × ×‘×—×¨×•`;
      }
    }

    function updateHiddenInput() {
      const hiddenInput = document.getElementById('assignedTo');
      // Store first selected user as primary for backwards compatibility
      hiddenInput.value = selectedUsers[0] || '';
    }

    window.filterUsers = function() {
      const searchTerm = document.getElementById('userSearch').value.toLowerCase();
      const options = document.querySelectorAll('.multi-select-option');

      options.forEach(option => {
        const text = option.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
          option.style.display = 'flex';
        } else {
          option.style.display = 'none';
        }
      });
    };

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      const container = document.querySelector('.multi-select-container');
      const dropdown = document.getElementById('userDropdown');

      if (container && !container.contains(event.target)) {
        dropdown.style.display = 'none';
        document.getElementById('multiSelectHeader')?.classList.remove('open');
      }
    });

    function getRoleLabel(role) {
      const labels = {
        admin: '×× ×”×œ',
        developer: '××¤×ª×—',
        assistant: '×¢×•×–×¨',
        assessor: '×©×××™',
        viewer: '×¦×•×¤×”'
      };
      return labels[role] || role;
    }

    // ============================================================================
    // RECURRING TASKS FUNCTIONS
    // ============================================================================

    window.toggleRecurringOptions = function() {
      const isChecked = document.getElementById('isRecurring').checked;
      const options = document.getElementById('recurringOptions');
      const childTasksCheckbox = document.getElementById('hasChildTasks');
      const childTasksSection = document.getElementById('childTasksSection');

      if (isChecked) {
        options.style.display = 'block';
        // Set default start date to today
        document.getElementById('recurrenceStartDate').value = new Date().toISOString().split('T')[0];
        updateRecurringFields();

        // Disable child tasks option when recurring is enabled
        childTasksCheckbox.checked = false;
        childTasksCheckbox.disabled = true;
        childTasksSection.style.display = 'none';
        document.getElementById('childTasksList').innerHTML = '';
        childTaskCounter = 0;
      } else {
        options.style.display = 'none';
        // Re-enable child tasks option when recurring is disabled
        childTasksCheckbox.disabled = false;
      }
    };

    window.updateRecurrenceFields = function() {
      const type = document.getElementById('recurrenceType').value;
      const weeklyOptions = document.getElementById('weeklyOptions');
      const monthlyOptions = document.getElementById('monthlyOptions');
      const intervalLabel = document.getElementById('intervalLabel');

      // Update interval label
      const labels = {
        daily: '×™××™×',
        weekly: '×©×‘×•×¢×•×ª',
        monthly: '×—×•×“×©×™×'
      };
      intervalLabel.textContent = labels[type] || '×™××™×';

      // Show/hide conditional fields
      weeklyOptions.style.display = type === 'weekly' ? 'block' : 'none';
      monthlyOptions.style.display = type === 'monthly' ? 'block' : 'none';

      // Set defaults for weekly (Mon, Wed, Fri)
      if (type === 'weekly') {
        const checkboxes = document.querySelectorAll('.day-checkbox');
        checkboxes.forEach((cb, i) => {
          cb.checked = [1, 3, 5].includes(parseInt(cb.value)); // Mon, Wed, Fri
        });
      }
    };

    async function createRecurringTask(taskData, recurringData) {
      try {
        // Get selected days of week for weekly recurrence
        let daysOfWeek = [];
        if (recurringData.recurrence_type === 'weekly') {
          const checkboxes = document.querySelectorAll('.day-checkbox:checked');
          daysOfWeek = Array.from(checkboxes).map(cb => parseInt(cb.value));

          if (daysOfWeek.length === 0) {
            alert('×× × ×‘×—×¨ ×œ×¤×—×•×ª ×™×•× ××—×“ ×‘×©×‘×•×¢');
            return false;
          }
        }

        // Prepare recurring task data
        const recurringTask = {
          template_name: recurringData.template_name,
          title: taskData.title,
          description: taskData.description,
          task_type: taskData.task_type,
          priority: taskData.priority,
          assigned_to_users: selectedUsers.length > 0 ? selectedUsers : [taskData.assigned_to],
          assigned_by: currentUser.user_id,
          recurrence_type: recurringData.recurrence_type,
          recurrence_interval: parseInt(recurringData.recurrence_interval),
          days_of_week: daysOfWeek,
          day_of_month: recurringData.day_of_month ? parseInt(recurringData.day_of_month) : null,
          start_date: recurringData.start_date,
          end_date: recurringData.end_date || null,
          next_run_date: recurringData.start_date,
          is_active: true,
          created_by: currentUser.user_id
        };

        // Insert into recurring_tasks table
        const { data, error } = await supabase
          .from('recurring_tasks')
          .insert([recurringTask])
          .select()
          .single();

        if (error) throw error;

        console.log('Recurring task created:', data);
        return data;

      } catch (error) {
        console.error('Error creating recurring task:', error);
        throw error;
      }
    }

    // Load cases for dropdown
    async function loadCases() {
      try {
        const { data, error } = await supabase
          .from('cases')
          .select('id, filing_case_id, plate')
          .order('filing_case_id', { ascending: false })
          .limit(100);

        if (error) throw error;

        return data || [];
      } catch (error) {
        console.error('Error loading cases:', error);
        return [];
      }
    }

    // Populate case dropdown
    async function populateCaseDropdown() {
      const cases = await loadCases();
      const select = document.getElementById('filingCaseId');
      select.innerHTML = '<option value="">×‘×—×¨ ×ª×™×§...</option>';

      cases.forEach(c => {
        const option = document.createElement('option');
        option.value = c.filing_case_id;
        option.setAttribute('data-uuid', c.id);
        option.setAttribute('data-plate', c.plate || '');
        option.textContent = `${c.filing_case_id}${c.plate ? ' - ' + c.plate : ''}`;
        select.appendChild(option);
      });
    }

    // Populate plate dropdown
    async function populatePlateDropdown() {
      const cases = await loadCases();
      const select = document.getElementById('plateDropdown');
      select.innerHTML = '<option value="">×‘×—×¨ ××¡×¤×¨ ×¨×™×©×•×™...</option><option value="__manual__">×”×–× ×” ×™×“× ×™×ª</option>';

      // Get unique plates
      const uniquePlates = [...new Set(cases.map(c => c.plate).filter(p => p))];

      uniquePlates.forEach(plate => {
        const option = document.createElement('option');
        option.value = plate;
        option.textContent = plate;
        select.appendChild(option);
      });
    }

    // When case is selected, auto-fill plate
    window.onCaseSelected = function() {
      const select = document.getElementById('filingCaseId');
      const selectedOption = select.options[select.selectedIndex];
      const plate = selectedOption.getAttribute('data-plate');

      if (plate) {
        const plateDropdown = document.getElementById('plateDropdown');
        // Try to select the plate in dropdown
        for (let i = 0; i < plateDropdown.options.length; i++) {
          if (plateDropdown.options[i].value === plate) {
            plateDropdown.selectedIndex = i;
            break;
          }
        }
      }
    };

    // When plate dropdown changes
    window.onPlateDropdownChange = function() {
      const dropdown = document.getElementById('plateDropdown');
      const manualGroup = document.getElementById('plateManualGroup');
      const manualInput = document.getElementById('plateManual');

      if (dropdown.value === '__manual__') {
        manualGroup.style.display = 'block';
        manualInput.required = true;
      } else {
        manualGroup.style.display = 'none';
        manualInput.required = false;
        manualInput.value = '';
      }
    };

    // Toggle activity feed visibility
    window.toggleActivityFeed = function() {
      const container = document.getElementById('activity-feed-container');
      const arrow = document.getElementById('activity-toggle-arrow');

      if (container.style.display === 'none') {
        container.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
      } else {
        container.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
      }
    };

    // ============================================================================
    // TASK TEMPLATES FUNCTIONS
    // ============================================================================

    let allTemplates = [];

    // Load all templates for current user
    async function loadTaskTemplates() {
      try {
        const { data, error } = await supabase
          .from('task_templates')
          .select('*')
          .or(`created_by.eq.${currentUser.user_id},is_public.eq.true`)
          .order('usage_count', { ascending: false });

        if (error) throw error;

        allTemplates = data || [];
        console.log(`Loaded ${allTemplates.length} task templates`);

        // Populate template select dropdown
        const templateSelect = document.getElementById('templateSelect');
        templateSelect.innerHTML = '<option value="">×˜×¢×Ÿ ××ª×‘× ×™×ª ×§×™×™××ª...</option>';

        allTemplates.forEach(template => {
          const option = document.createElement('option');
          option.value = template.id;
          option.textContent = `${template.template_name} ${template.is_public ? '(×¦×™×‘×•×¨×™)' : ''}`;
          templateSelect.appendChild(option);
        });

        return allTemplates;
      } catch (error) {
        console.error('Error loading templates:', error);
        return [];
      }
    }

    // Load selected template into form
    window.loadTemplate = async function() {
      const templateId = document.getElementById('templateSelect').value;
      if (!templateId) return;

      const template = allTemplates.find(t => t.id === templateId);
      if (!template) return;

      // Fill form with template values
      document.getElementById('taskTitle').value = template.title || '';
      document.getElementById('taskDescription').value = template.description || '';
      document.getElementById('taskType').value = template.task_type || 'custom';
      document.getElementById('taskPriority').value = template.priority || 'medium';

      // Increment usage count
      try {
        await supabase.rpc('increment_template_usage', { p_template_id: templateId });
        console.log('âœ… Template usage count incremented');
      } catch (error) {
        console.error('Error incrementing template usage:', error);
      }

      alert(`âœ… ×ª×‘× ×™×ª "${template.template_name}" × ×˜×¢× ×” ×‘×”×¦×œ×—×”!`);
    };

    // Clear template selection and form
    window.clearTemplate = function() {
      document.getElementById('templateSelect').value = '';
      document.getElementById('taskTitle').value = '';
      document.getElementById('taskDescription').value = '';
      document.getElementById('taskType').value = 'custom';
      document.getElementById('taskPriority').value = 'medium';
    };

    // Save current form as template
    window.saveAsTemplate = async function() {
      const templateName = prompt('×”×–×Ÿ ×©× ×œ×ª×‘× ×™×ª:');
      if (!templateName) return;

      const title = document.getElementById('taskTitle').value;
      if (!title) {
        alert('×× × ×”×–×Ÿ ×›×•×ª×¨×ª ×œ××©×™××” ×œ×¤× ×™ ×©××™×¨×” ×›×ª×‘× ×™×ª');
        return;
      }

      const category = prompt('×§×˜×’×•×¨×™×” (××•×¤×¦×™×•× ×œ×™):');

      const templateData = {
        template_name: templateName,
        category: category || null,
        title: document.getElementById('taskTitle').value,
        description: document.getElementById('taskDescription').value,
        task_type: document.getElementById('taskType').value,
        priority: document.getElementById('taskPriority').value,
        created_by: currentUser.user_id,
        is_public: false
      };

      try {
        const { data, error } = await supabase
          .from('task_templates')
          .insert([templateData])
          .select()
          .single();

        if (error) {
          if (error.code === '23505') {
            alert('âŒ ×ª×‘× ×™×ª ×‘×©× ×–×” ×›×‘×¨ ×§×™×™××ª. ×× × ×‘×—×¨ ×©× ××—×¨.');
          } else {
            throw error;
          }
          return;
        }

        alert(`âœ… ×ª×‘× ×™×ª "${templateName}" × ×©××¨×” ×‘×”×¦×œ×—×”!`);
        await loadTaskTemplates(); // Refresh templates list
      } catch (error) {
        console.error('Error saving template:', error);
        alert('âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”×ª×‘× ×™×ª');
      }
    };

    // Open template manager modal
    window.openTemplateManager = async function() {
      document.getElementById('templateManagerModal').style.display = 'flex';
      await renderTemplatesList();
    };

    // Close template manager modal
    window.closeTemplateManager = function() {
      document.getElementById('templateManagerModal').style.display = 'none';
    };

    // Render templates list in manager
    async function renderTemplatesList() {
      await loadTaskTemplates(); // Refresh data

      const container = document.getElementById('templatesList');
      const countSpan = document.getElementById('templateCount');

      countSpan.textContent = `${allTemplates.length} ×ª×‘× ×™×•×ª`;

      if (allTemplates.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: #999;">
            <p>××™×Ÿ ×ª×‘× ×™×•×ª ×©××•×¨×•×ª</p>
            <p style="font-size: 0.9rem;">×¦×•×¨ ××©×™××” ×•×œ×—×¥ ×¢×œ "ğŸ’¾ ×©××•×¨ ×›×ª×‘× ×™×ª" ×›×“×™ ×œ×”×ª×—×™×œ</p>
          </div>
        `;
        return;
      }

      container.innerHTML = allTemplates.map(template => `
        <div style="background: #2a2a2a; border: 1px solid #3a3a3a; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                <h4 style="margin: 0; color: #ffd700;">${template.template_name}</h4>
                ${template.is_public ? '<span style="font-size: 0.75rem; background: #3a5a7a; padding: 0.15rem 0.4rem; border-radius: 4px;">×¦×™×‘×•×¨×™</span>' : ''}
                ${template.category ? `<span style="font-size: 0.75rem; background: #4a4a4a; padding: 0.15rem 0.4rem; border-radius: 4px;">${template.category}</span>` : ''}
              </div>
              <p style="margin: 0.5rem 0; color: #ccc; font-size: 0.9rem;"><strong>×›×•×ª×¨×ª:</strong> ${template.title}</p>
              ${template.description ? `<p style="margin: 0.5rem 0; color: #999; font-size: 0.85rem;">${template.description}</p>` : ''}
              <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.85rem; color: #999;">
                <span>ğŸ“Š <strong>×¡×•×’:</strong> ${getTaskTypeLabel(template.task_type)}</span>
                <span>âš¡ <strong>×¢×“×™×¤×•×ª:</strong> ${getPriorityLabel(template.priority)}</span>
                <span>ğŸ“ˆ <strong>×©×™××•×©×™×:</strong> ${template.usage_count || 0}</span>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button onclick="deleteTemplate('${template.id}')" class="btn btn-danger" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                ğŸ—‘ï¸ ××—×§
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Delete template
    window.deleteTemplate = async function(templateId) {
      const template = allTemplates.find(t => t.id === templateId);
      if (!template) return;

      if (!confirm(`×”×× ×œ××—×•×§ ××ª ×”×ª×‘× ×™×ª "${template.template_name}"?`)) return;

      try {
        const { error } = await supabase
          .from('task_templates')
          .delete()
          .eq('id', templateId);

        if (error) throw error;

        alert('âœ… ×”×ª×‘× ×™×ª × ××—×§×” ×‘×”×¦×œ×—×”');
        await renderTemplatesList();
        await loadTaskTemplates(); // Refresh dropdown
      } catch (error) {
        console.error('Error deleting template:', error);
        alert('âŒ ×©×’×™××” ×‘××—×™×§×ª ×”×ª×‘× ×™×ª');
      }
    };

    // Helper: Get task type label for templates
    function getTaskTypeLabel(type) {
      const labels = {
        'custom': '×›×œ×œ×™×ª',
        'case_action': '×¤×¢×•×œ×” ×‘×ª×™×§',
        'document_request': '×‘×§×©×ª ××¡××š',
        'review_request': '×‘×§×©×ª ×¡×§×™×¨×”',
        'data_correction': '×ª×™×§×•×Ÿ × ×ª×•× ×™×',
        'follow_up': '××¢×§×‘'
      };
      return labels[type] || type;
    }

    // Load tasks
    async function loadTasks(includeArchived = false) {
      try {
        // Get tasks (exclude archived by default)
        let query = supabase
          .from('tasks')
          .select('*')
          .order('created_at', { ascending: false });

        // Filter archived tasks unless viewing archive
        if (!includeArchived) {
          query = query.or('archived.is.null,archived.eq.false');
        }

        query = query.limit(50);

        const { data: tasks, error: tasksError } = await query;

        if (tasksError) throw tasksError;

        // Get all profiles (for joining)
        const { data: profiles, error: profilesError } = await supabase
          .from('profiles')
          .select('user_id, name, role');

        if (profilesError) throw profilesError;

        // Create a lookup map for profiles
        const profileMap = {};
        (profiles || []).forEach(profile => {
          profileMap[profile.user_id] = profile;
        });

        // Join tasks with profile data
        allTasks = (tasks || []).map(task => ({
          ...task,
          assigned_to_profile: profileMap[task.assigned_to] || null,
          assigned_by_profile: profileMap[task.assigned_by] || null
        }));

        renderTasks(allTasks);

      } catch (error) {
        console.error('Error loading tasks:', error);
        showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”××©×™××•×ª');
      }
    }

    function renderTasks(tasks) {
      const container = document.getElementById('tasksContainer');

      if (!tasks || tasks.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“</div>
            <h3>××™×Ÿ ××©×™××•×ª ×œ×”×¦×’×”</h3>
            <p>×œ×—×¥ ×¢×œ "××©×™××” ×—×“×©×”" ×›×“×™ ×œ×”×ª×—×™×œ</p>
          </div>
        `;
        return;
      }

      container.innerHTML = tasks.map(task => {
        const isOverdue = task.due_date && new Date(task.due_date) < new Date() && task.status !== 'completed' && task.status !== 'verified';
        const progressPercent = task.completion_percentage || 0;
        const stateClass = `state-${task.status}`;
        const overdueClass = isOverdue ? 'overdue' : '';

        return `
        <div class="task-card ${task.priority} ${stateClass} ${overdueClass}" onclick="openTaskDetail('${task.id}')">
          <div class="task-header">
            <div class="task-title">
              ${escapeHtml(task.title)}
              ${isOverdue ? '<span style="color: #ff4444; margin-right: 8px;">âš ï¸ ×‘××™×—×•×¨</span>' : ''}
            </div>
            <span class="priority-badge ${task.priority}">
              ${getPriorityIcon(task.priority)} ${getPriorityLabel(task.priority)}
            </span>
          </div>

          <div class="task-meta">
            <span>ğŸ‘¤ ×”×•×§×¦×” ×œ: <strong>${task.assigned_to_profile?.name || '×œ× ×™×“×•×¢'}</strong></span>
            <span>ğŸ‘¤ ×”×•×§×¦×” ×¢×œ ×™×“×™: <strong>${task.assigned_by_profile?.name || '×œ× ×™×“×•×¢'}</strong></span>
          </div>

          <div class="task-meta">
            <span>ğŸ“… ${formatDate(task.due_date) || '×œ×œ× ××•×¢×“'}</span>
            <span class="status-badge status-${task.status}">ğŸ“Š ${getStatusLabel(task.status)}</span>
            ${task.plate ? `<span>ğŸš— ${task.plate}</span>` : ''}
          </div>

          <div class="task-stats">
            <div style="flex: 1;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                <span style="font-size: 0.85rem;">×”×ª×§×“××•×ª:</span>
                <span style="font-size: 0.85rem; font-weight: 600;">${progressPercent}%</span>
              </div>
              <div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                <div style="background: linear-gradient(90deg, #4CAF50, #8BC34A); height: 100%; width: ${progressPercent}%; transition: width 0.3s;"></div>
              </div>
            </div>
            <span style="margin-right: 16px;">ğŸ• ${formatRelativeTime(task.created_at)}</span>
          </div>

          <div class="task-actions" style="margin-top: 12px; display: flex; gap: 8px; justify-content: flex-start;" onclick="event.stopPropagation()">
            <button class="btn-edit" onclick="openEditTaskModal('${task.id}')" style="background: #3B82F6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
              âœï¸ ×¢×¨×•×š
            </button>
            ${!task.archived ? `
              <button class="btn-archive" onclick="archiveTask('${task.id}')" style="background: #6B7280; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                ğŸ“¦ ×”×¢×‘×¨ ×œ××¨×›×™×•×Ÿ
              </button>
            ` : ''}
            ${task.archived ? `
              <button class="btn-restore" onclick="restoreTask('${task.id}')" style="background: #10B981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                â†©ï¸ ×©×—×–×¨
              </button>
            ` : ''}
            <button class="btn-delete" onclick="deleteTask('${task.id}')" style="background: #EF4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
              ğŸ—‘ï¸ ××—×§
            </button>
          </div>
        </div>
      `;
      }).join('');
    }

    // Update statistics
    async function updateStats() {
      try {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // Active tasks (in_progress)
        const activeCount = allTasks.filter(t => t.status === 'in_progress').length;
        document.getElementById('activeCount').textContent = activeCount;

        // Pending tasks (pending or awaiting_response)
        const pendingCount = allTasks.filter(t =>
          t.status === 'pending' || t.status === 'awaiting_response'
        ).length;
        document.getElementById('pendingCount').textContent = pendingCount;

        // Completed today
        const completedToday = allTasks.filter(t => {
          if (!t.completed_at) return false;
          const completedDate = new Date(t.completed_at);
          return completedDate >= today;
        }).length;
        document.getElementById('completedCount').textContent = completedToday;

        // Overdue tasks
        const now = new Date();
        const overdueCount = allTasks.filter(t => {
          if (!t.due_date || t.status === 'completed' || t.status === 'verified') return false;
          return new Date(t.due_date) < now;
        }).length;
        document.getElementById('overdueCount').textContent = overdueCount;

        // Update change indicators (mock for now)
        document.getElementById('activeChange').textContent = `â†‘ +${Math.floor(Math.random() * 5)} ×”×—×•×“×©`;
        document.getElementById('pendingChange').textContent = `â†“ -${Math.floor(Math.random() * 3)} ×”×©×‘×•×¢`;
        document.getElementById('completedChange').textContent = `â†‘ +${completedToday} ×”×™×•×`;
        document.getElementById('overdueChange').textContent = overdueCount > 0 ? 'âš ï¸ ×“×•×¨×© ×˜×™×¤×•×œ' : 'âœ… ×”×›×œ ×‘×¡×“×¨';

      } catch (error) {
        console.error('Error updating stats:', error);
      }

      // Also update dashboard stats
      updateDashboardStats();
    }

    // Enhanced Dashboard Statistics
    window.updateDashboardStats = function() {
      try {
        // Get filter values
        const userFilter = document.getElementById('statsUserFilter').value;
        const typeFilter = document.getElementById('statsTypeFilter').value;
        const priorityFilter = document.getElementById('statsPriorityFilter').value;

        // Filter tasks based on selections
        let filteredTasks = allTasks.filter(t => !t.archived); // Exclude archived

        if (userFilter) filteredTasks = filteredTasks.filter(t => t.assigned_to === userFilter);
        if (typeFilter) filteredTasks = filteredTasks.filter(t => t.task_type === typeFilter);
        if (priorityFilter) filteredTasks = filteredTasks.filter(t => t.priority === priorityFilter);

        // Calculate overall metrics
        const totalTasks = filteredTasks.length;
        const completedTasks = filteredTasks.filter(t => t.status === 'completed' || t.status === 'verified').length;
        const inProgressTasks = filteredTasks.filter(t => t.status === 'in_progress').length;
        const overdueTasks = filteredTasks.filter(t => {
          if (!t.due_date || t.status === 'completed' || t.status === 'verified') return false;
          return new Date(t.due_date) < new Date();
        }).length;

        const fulfillmentRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

        // Update overall metrics
        document.getElementById('totalTasksCount').textContent = totalTasks;
        document.getElementById('fulfillmentRate').textContent = fulfillmentRate;
        document.getElementById('fulfillmentBar').style.width = `${fulfillmentRate}%`;
        document.getElementById('fulfillmentBar').textContent = fulfillmentRate > 10 ? `${fulfillmentRate}%` : '';
        document.getElementById('inProgressCount').textContent = inProgressTasks;
        document.getElementById('completedTasksCount').textContent = completedTasks;
        document.getElementById('overdueTasksCount').textContent = overdueTasks;

        // Calculate per-user statistics
        const userStats = {};
        filteredTasks.forEach(task => {
          const userId = task.assigned_to;
          if (!userStats[userId]) {
            userStats[userId] = {
              name: task.assigned_to_profile?.name || '×œ× ×™×“×•×¢',
              total: 0,
              completed: 0,
              inProgress: 0,
              overdue: 0
            };
          }
          userStats[userId].total++;
          if (task.status === 'completed' || task.status === 'verified') {
            userStats[userId].completed++;
          }
          if (task.status === 'in_progress') {
            userStats[userId].inProgress++;
          }
          if (task.due_date && new Date(task.due_date) < new Date() && task.status !== 'completed' && task.status !== 'verified') {
            userStats[userId].overdue++;
          }
        });

        // Render per-user statistics
        const userStatsContainer = document.getElementById('userStatsContainer');
        const userStatsList = Object.values(userStats).sort((a, b) => b.total - a.total);

        if (userStatsList.length === 0) {
          userStatsContainer.innerHTML = '<div style="color: #666; text-align: center; padding: 1rem;">××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</div>';
        } else {
          userStatsContainer.innerHTML = userStatsList.map(user => {
            const completionRate = user.total > 0 ? Math.round((user.completed / user.total) * 100) : 0;
            return `
              <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                  <div>
                    <div style="color: #fff; font-weight: 600;">${user.name}</div>
                    <div style="color: #9CA3AF; font-size: 0.85rem;">×¡×”"×›: ${user.total} | ×”×•×©×œ××•: ${user.completed} | ×‘×‘×™×¦×•×¢: ${user.inProgress}${user.overdue > 0 ? ` | <span style="color: #EF4444;">×‘××™×—×•×¨: ${user.overdue}</span>` : ''}</div>
                  </div>
                  <div style="color: ${completionRate >= 80 ? '#10B981' : completionRate >= 50 ? '#F59E0B' : '#EF4444'}; font-size: 1.5rem; font-weight: bold;">
                    ${completionRate}%
                  </div>
                </div>
                <div style="background: rgba(255,255,255,0.1); height: 12px; border-radius: 6px; overflow: hidden;">
                  <div style="background: linear-gradient(90deg, ${completionRate >= 80 ? '#10B981, #22C55E' : completionRate >= 50 ? '#F59E0B, #FBBF24' : '#EF4444, #F87171'}); height: 100%; width: ${completionRate}%; transition: width 0.5s;"></div>
                </div>
              </div>
            `;
          }).join('');
        }

        // Populate user filter dropdown if empty
        const statsUserFilter = document.getElementById('statsUserFilter');
        if (statsUserFilter.options.length === 1) {
          allUsers.forEach(user => {
            const option = document.createElement('option');
            option.value = user.user_id;
            option.textContent = user.name;
            statsUserFilter.appendChild(option);
          });
        }

      } catch (error) {
        console.error('Error updating dashboard stats:', error);
      }
    };

    // Real-time subscriptions
    function setupRealtime() {
      supabase
        .channel('tasks-changes')
        .on('postgres_changes',
          { event: '*', schema: 'public', table: 'tasks' },
          (payload) => {
            console.log('Task changed:', payload);
            loadTasks();
            updateStats();
          }
        )
        .subscribe();
    }

    // Modal functions
    window.openNewTaskModal = function() {
      document.getElementById('newTaskModal').classList.add('open');
    };

    window.closeNewTaskModal = function() {
      document.getElementById('newTaskModal').classList.remove('open');
      document.getElementById('newTaskForm').reset();

      // Reset child tasks section
      document.getElementById('hasChildTasks').checked = false;
      document.getElementById('childTasksSection').style.display = 'none';
      document.getElementById('childTasksList').innerHTML = '';
      childTaskCounter = 0;

      // Reset multi-select users
      selectedUsers = [];
      updateSelectedUsersDisplay();
      populateUserDropdown(); // Refresh checkboxes
    };

    // Edit Task Functions
    let currentEditingTaskId = null;

    window.openEditTaskModal = async function(taskId) {
      try {
        // Find task in allTasks array
        const task = allTasks.find(t => t.id === taskId);
        if (!task) {
          alert('××©×™××” ×œ× × ××¦××”');
          return;
        }

        currentEditingTaskId = taskId;

        // Pre-fill form
        document.getElementById('editTaskTitle').value = task.title || '';
        document.getElementById('editTaskDescription').value = task.description || '';
        document.getElementById('editTaskType').value = task.task_type || 'custom';
        document.getElementById('editTaskPriority').value = task.priority || 'medium';
        document.getElementById('editDueDate').value = task.due_date ? task.due_date.split('T')[0] : '';
        document.getElementById('editPlate').value = task.plate || '';

        // Populate user dropdown if not already done
        if (document.getElementById('editAssignedTo').options.length <= 1) {
          const select = document.getElementById('editAssignedTo');
          allUsers.forEach(user => {
            const option = document.createElement('option');
            option.value = user.user_id;
            option.textContent = `${user.name} (${getRoleLabel(user.role)})`;
            select.appendChild(option);
          });
        }

        // Set assigned user
        document.getElementById('editAssignedTo').value = task.assigned_to || '';

        // Populate case dropdown if needed
        await populateEditCaseDropdown();
        if (task.case_id) {
          // Try to find and select the case
          const caseSelect = document.getElementById('editFilingCaseId');
          for (let i = 0; i < caseSelect.options.length; i++) {
            if (caseSelect.options[i].getAttribute('data-uuid') === task.case_id) {
              caseSelect.selectedIndex = i;
              break;
            }
          }
        }

        // Show modal
        document.getElementById('editTaskModal').classList.add('open');

      } catch (error) {
        console.error('Error opening edit modal:', error);
        alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×¨×˜×™ ×”××©×™××”');
      }
    };

    window.closeEditTaskModal = function() {
      document.getElementById('editTaskModal').classList.remove('open');
      currentEditingTaskId = null;
    };

    window.saveTaskEdits = async function(event) {
      event.preventDefault();

      if (!currentEditingTaskId) {
        alert('×©×’×™××”: ×œ× × ×‘×—×¨×” ××©×™××” ×œ×¢×¨×™×›×”');
        return;
      }

      try {
        const updates = {
          title: document.getElementById('editTaskTitle').value,
          description: document.getElementById('editTaskDescription').value,
          task_type: document.getElementById('editTaskType').value,
          assigned_to: document.getElementById('editAssignedTo').value,
          priority: document.getElementById('editTaskPriority').value,
          due_date: document.getElementById('editDueDate').value || null,
          plate: document.getElementById('editPlate').value || null,
          updated_at: new Date().toISOString()
        };

        // Get case_id from selected option
        const caseSelect = document.getElementById('editFilingCaseId');
        const selectedCaseOption = caseSelect.options[caseSelect.selectedIndex];
        if (selectedCaseOption && selectedCaseOption.value) {
          updates.case_id = selectedCaseOption.getAttribute('data-uuid') || null;
        } else {
          updates.case_id = null;
        }

        const { error } = await supabase
          .from('tasks')
          .update(updates)
          .eq('id', currentEditingTaskId);

        if (error) throw error;

        // Send notification to assigned user about task update
        if (window.taskNotifications) {
          const updatedTask = allTasks.find(t => t.id === currentEditingTaskId);
          if (updatedTask) {
            const updatedTaskData = { ...updatedTask, ...updates };
            await window.taskNotifications.notifyTaskUpdated(updatedTaskData, currentUser);
          }
        }

        alert('âœ… ×”××©×™××” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!');
        closeEditTaskModal();
        await loadTasks();
        await updateStats();

      } catch (error) {
        console.error('Error updating task:', error);
        alert('âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”××©×™××”: ' + error.message);
      }
    };

    async function populateEditCaseDropdown() {
      const cases = await loadCases();
      const select = document.getElementById('editFilingCaseId');
      select.innerHTML = '<option value="">×‘×—×¨ ×ª×™×§...</option>';
      cases.forEach(c => {
        const option = document.createElement('option');
        option.value = c.filing_case_id;
        option.setAttribute('data-uuid', c.id);
        option.textContent = `${c.filing_case_id}${c.plate ? ' - ' + c.plate : ''}`;
        select.appendChild(option);
      });
    }

    window.openNewThreadModal = function() {
      alert('×™×¦×™×¨×ª ×©×¨×©×•×¨ ×—×“×© - ×‘×¤×™×ª×•×—');
    };

    // Child Tasks Management
    let childTaskCounter = 0;

    window.toggleChildTasksSection = function() {
      const checkbox = document.getElementById('hasChildTasks');
      const section = document.getElementById('childTasksSection');
      const recurringCheckbox = document.getElementById('isRecurring');
      const recurringOptions = document.getElementById('recurringOptions');

      if (checkbox.checked) {
        section.style.display = 'block';
        // Add first child task automatically
        if (document.getElementById('childTasksList').children.length === 0) {
          addChildTask();
        }

        // Disable recurring option when child tasks is enabled
        recurringCheckbox.checked = false;
        recurringCheckbox.disabled = true;
        recurringOptions.style.display = 'none';
      } else {
        section.style.display = 'none';
        // Clear all child tasks
        document.getElementById('childTasksList').innerHTML = '';
        childTaskCounter = 0;

        // Re-enable recurring option when child tasks is disabled
        recurringCheckbox.disabled = false;
      }
    };

    window.addChildTask = function() {
      const parentAssignedTo = document.getElementById('assignedTo').value;
      const childTaskId = `childTask_${childTaskCounter++}`;

      const childTaskHtml = `
        <div class="child-task-item" id="${childTaskId}" style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #3a3a3a;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <h4 style="margin: 0; font-size: 0.9rem; color: #10B981;">××©×™××ª ×™×œ×“ ${childTaskCounter}</h4>
            <button type="button" onclick="removeChildTask('${childTaskId}')" style="background: #EF4444; color: white; border: none; padding: 0.25rem 0.75rem; border-radius: 6px; cursor: pointer; font-size: 0.75rem;">
              ğŸ—‘ï¸ ×”×¡×¨
            </button>
          </div>

          <div class="form-group">
            <label>×›×•×ª×¨×ª *</label>
            <input type="text" class="child-title" required style="width: 100%; padding: 0.5rem; background: #2a2a2a; border: 1px solid #3a3a3a; border-radius: 6px; color: white;">
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
            <div class="form-group">
              <label>×”×§×¦×” ×œ-</label>
              <select class="child-assigned-to" style="width: 100%; padding: 0.5rem; background: #2a2a2a; border: 1px solid #3a3a3a; border-radius: 6px; color: white;">
                <option value="">×‘×—×¨ ××©×ª××©...</option>
                ${allUsers.map(user =>
                  `<option value="${user.user_id}" ${user.user_id === parentAssignedTo ? 'selected' : ''}>${user.name} (${getRoleLabel(user.role)})</option>`
                ).join('')}
              </select>
            </div>

            <div class="form-group">
              <label>×¢×“×™×¤×•×ª</label>
              <select class="child-priority" style="width: 100%; padding: 0.5rem; background: #2a2a2a; border: 1px solid #3a3a3a; border-radius: 6px; color: white;">
                <option value="low">× ××•×›×”</option>
                <option value="medium" selected>×‘×™× ×•× ×™×ª</option>
                <option value="high">×’×‘×•×”×”</option>
                <option value="urgent">×“×—×•×¤×”</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>×ª××¨×™×š ×™×¢×“</label>
            <input type="date" class="child-due-date" style="width: 100%; padding: 0.5rem; background: #2a2a2a; border: 1px solid #3a3a3a; border-radius: 6px; color: white;">
          </div>
        </div>
      `;

      document.getElementById('childTasksList').insertAdjacentHTML('beforeend', childTaskHtml);

      // Update all child task dropdowns when parent assigned_to changes
      updateChildTaskAssignees();
    };

    window.removeChildTask = function(childTaskId) {
      document.getElementById(childTaskId).remove();
    };

    // Update child task assignee dropdowns when parent assignee changes
    function updateChildTaskAssignees() {
      const parentAssignedTo = document.getElementById('assignedTo');

      parentAssignedTo.addEventListener('change', function() {
        const selectedUserId = this.value;
        const childAssigneeSelects = document.querySelectorAll('.child-assigned-to');

        childAssigneeSelects.forEach(select => {
          // Only update if the current value is empty or was the previous parent assignee
          if (!select.value || select.value === select.dataset.previousParent) {
            select.value = selectedUserId;
          }
          select.dataset.previousParent = selectedUserId;
        });
      });
    }

    // Create new task
    window.createTask = async function(event) {
      event.preventDefault();

      try {
        // Check if this is a recurring task
        const isRecurring = document.getElementById('isRecurring').checked;

        // Get case_id (UUID) from the selected option
        const caseSelect = document.getElementById('filingCaseId');
        const selectedCaseOption = caseSelect.options[caseSelect.selectedIndex];
        const caseId = selectedCaseOption.getAttribute('data-uuid') || null;

        // Get plate - either from dropdown or manual input
        const plateDropdown = document.getElementById('plateDropdown');
        let plate = null;
        if (plateDropdown.value === '__manual__') {
          plate = document.getElementById('plateManual').value || null;
        } else if (plateDropdown.value) {
          plate = plateDropdown.value;
        }

        const parentFormData = {
          title: document.getElementById('taskTitle').value,
          description: document.getElementById('taskDescription').value,
          task_type: document.getElementById('taskType').value,
          assigned_to: document.getElementById('assignedTo').value,
          assigned_by: currentUser.user_id,
          priority: document.getElementById('taskPriority').value,
          due_date: document.getElementById('dueDate').value || null,
          case_id: caseId,
          plate: plate,
          status: 'pending',
          completion_percentage: 0
        };

        // Handle recurring task creation
        if (isRecurring) {
          const templateName = document.getElementById('templateName').value.trim();
          if (!templateName) {
            alert('×× × ×”×–×Ÿ ×©× ×ª×‘× ×™×ª ×œ××©×™××” ×—×•×–×¨×ª');
            return;
          }

          const recurringData = {
            template_name: templateName,
            recurrence_type: document.getElementById('recurrenceType').value,
            recurrence_interval: document.getElementById('recurrenceInterval').value,
            day_of_month: document.getElementById('dayOfMonth').value,
            start_date: document.getElementById('recurrenceStartDate').value,
            end_date: document.getElementById('recurrenceEndDate').value
          };

          if (!recurringData.start_date) {
            alert('×× × ×‘×—×¨ ×ª××¨×™×š ×”×ª×—×œ×”');
            return;
          }

          await createRecurringTask(parentFormData, recurringData);

          alert('âœ… ××©×™××” ×—×•×–×¨×ª × ×•×¦×¨×” ×‘×”×¦×œ×—×”! ×”××¢×¨×›×ª ×ª×™×¦×•×¨ ××•×˜×•××˜×™×ª ××©×™××•×ª ×—×“×©×•×ª ×œ×¤×™ ×”×ª×“×™×¨×•×ª ×©× ×‘×—×¨×”.');
          closeNewTaskModal();
          await loadTasks();
          return;
        }

        // Check if task has child tasks
        const hasChildTasks = document.getElementById('hasChildTasks').checked;

        if (hasChildTasks) {
          // Collect child tasks data
          const childTaskElements = document.querySelectorAll('.child-task-item');

          if (childTaskElements.length === 0) {
            alert('×× × ×”×•×¡×£ ×œ×¤×—×•×ª ××©×™××ª ×™×œ×“ ××—×ª ××• ×‘×˜×œ ××ª ×”×¡×™××•×Ÿ');
            return;
          }

          const childTasksData = [];
          for (const childElement of childTaskElements) {
            const title = childElement.querySelector('.child-title').value.trim();
            const assignedTo = childElement.querySelector('.child-assigned-to').value;
            const priority = childElement.querySelector('.child-priority').value;
            const dueDate = childElement.querySelector('.child-due-date').value || null;

            if (!title) {
              alert('× × ×œ××œ× ×›×•×ª×¨×ª ×œ×›×œ ××©×™××•×ª ×”×™×œ×“');
              return;
            }

            if (!assignedTo) {
              alert('× × ×œ×‘×—×•×¨ ××©×ª××© ×œ×›×œ ××©×™××•×ª ×”×™×œ×“');
              return;
            }

            childTasksData.push({
              title,
              assigned_to: assignedTo,
              priority,
              due_date: dueDate
            });
          }

          // Create thread
          const { data: thread, error: threadError } = await supabase
            .from('task_threads')
            .insert({
              thread_name: parentFormData.title,
              thread_description: parentFormData.description,
              case_id: caseId,
              plate: plate,
              created_by: currentUser.user_id
            })
            .select()
            .single();

          if (threadError) throw threadError;

          // Create parent task with thread_id
          parentFormData.thread_id = thread.id;

          const { data: parentTask, error: parentError } = await supabase
            .from('tasks')
            .insert([parentFormData])
            .select()
            .single();

          if (parentError) throw parentError;

          // Create child tasks
          const childTasksToInsert = childTasksData.map(child => ({
            title: child.title,
            description: `××©×™××ª ×™×œ×“ ×©×œ: ${parentFormData.title}`,
            task_type: parentFormData.task_type,
            assigned_to: child.assigned_to,
            assigned_by: currentUser.user_id,
            priority: child.priority,
            due_date: child.due_date,
            case_id: caseId,
            plate: plate,
            status: 'pending',
            completion_percentage: 0,
            thread_id: thread.id,
            parent_task_id: parentTask.id
          }));

          const { data: childTasks, error: childError } = await supabase
            .from('tasks')
            .insert(childTasksToInsert)
            .select();

          if (childError) throw childError;

          // Add all tasks to notification queue
          if (window.taskNotifications) {
            // Parent task notification
            if (parentTask.assigned_to) {
              const assignedUser = allUsers.find(u => u.user_id === parentTask.assigned_to);
              window.taskNotifications.addToPendingNotifications(parentTask, assignedUser);
            }

            // Child tasks notifications
            childTasks.forEach(childTask => {
              if (childTask.assigned_to) {
                const assignedUser = allUsers.find(u => u.user_id === childTask.assigned_to);
                window.taskNotifications.addToPendingNotifications(childTask, assignedUser);
              }
            });

            updateNotificationBadge();
          }

          alert(`âœ… ×”××©×™××” ×”×¨××©×™×ª ×•-${childTasks.length} ××©×™××•×ª ×™×œ×“ × ×•×¦×¨×• ×‘×”×¦×œ×—×”!`);

        } else {
          // Create single task (no children)
          const { data, error } = await supabase
            .from('tasks')
            .insert([parentFormData])
            .select()
            .single();

          if (error) throw error;

          console.log('Task created:', data);

          // Create task assignments for all selected users
          if (selectedUsers.length > 0) {
            const assignments = selectedUsers.map((userId, index) => ({
              task_id: data.id,
              user_id: userId,
              is_primary: index === 0, // First user is primary
              assigned_by: currentUser.user_id,
              assigned_at: new Date().toISOString()
            }));

            const { error: assignmentError } = await supabase
              .from('task_assignments')
              .insert(assignments);

            if (assignmentError) {
              console.error('Error creating task assignments:', assignmentError);
              // Don't fail the whole operation, just log the error
            }

            // Add to pending notifications for all assigned users
            if (window.taskNotifications) {
              selectedUsers.forEach(userId => {
                const assignedUser = allUsers.find(u => u.user_id === userId);
                if (assignedUser) {
                  window.taskNotifications.addToPendingNotifications(data, assignedUser);
                }
              });
              updateNotificationBadge();
            }
          } else {
            // Fallback: if no users selected via multi-select, use single assignment
            if (window.taskNotifications && data.assigned_to) {
              const assignedUser = allUsers.find(u => u.user_id === data.assigned_to);
              window.taskNotifications.addToPendingNotifications(data, assignedUser);
              updateNotificationBadge();
            }
          }

          const userCount = selectedUsers.length || 1;
          alert(`âœ… ×”××©×™××” × ×•×¦×¨×” ×‘×”×¦×œ×—×” ×•×”×•×§×¦×ª×” ×œ-${userCount} ${userCount === 1 ? '××©×ª××©' : '××©×ª××©×™×'}!`);
        }

        closeNewTaskModal();
        await loadTasks();
        await updateStats();

      } catch (error) {
        console.error('Error creating task:', error);
        alert('âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×”××©×™××”: ' + error.message);
      }
    };

    // Archive and Restore Functions
    window.archiveTask = async function(taskId) {
      if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×¢×‘×™×¨ ××©×™××” ×–×• ×œ××¨×›×™×•×Ÿ?\n\n×ª×•×›×œ ×œ×©×—×–×¨ ××•×ª×” ×‘×›×œ ×¢×ª.')) {
        return;
      }

      try {
        const { error } = await supabase
          .from('tasks')
          .update({
            archived: true,
            archived_at: new Date().toISOString(),
            archived_by: currentUser.user_id
          })
          .eq('id', taskId);

        if (error) throw error;

        alert('âœ… ×”××©×™××” ×”×•×¢×‘×¨×” ×œ××¨×›×™×•×Ÿ ×‘×”×¦×œ×—×”');
        await loadTasks();
        await updateStats();

      } catch (error) {
        console.error('Error archiving task:', error);
        alert('âŒ ×©×’×™××” ×‘×”×¢×‘×¨×” ×œ××¨×›×™×•×Ÿ: ' + error.message);
      }
    };

    window.restoreTask = async function(taskId) {
      try {
        const { error } = await supabase
          .from('tasks')
          .update({
            archived: false,
            archived_at: null,
            archived_by: null
          })
          .eq('id', taskId);

        if (error) throw error;

        alert('âœ… ×”××©×™××” ×©×•×—×–×¨×” ××”××¨×›×™×•×Ÿ');
        await loadArchivedTasks(); // Refresh archive view
        await loadTasks(); // Refresh main task list
        await updateStats();

      } catch (error) {
        console.error('Error restoring task:', error);
        alert('âŒ ×©×’×™××” ×‘×©×—×–×•×¨ ×”××©×™××”: ' + error.message);
      }
    };

    window.deleteTask = async function(taskId) {
      if (!confirm('âš ï¸ ×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××©×™××”?\n\n×¤×¢×•×œ×” ×–×• ×ª××—×§ ×œ×¦××™×ª×•×ª ××ª ×”××©×™××” ×•×›×œ ×”×”×•×“×¢×•×ª ×•×”×§×‘×¦×™× ×”××¦×•×¨×¤×™× ××œ×™×”.\n\n×¤×¢×•×œ×” ×–×• ××™× ×” × ×™×ª× ×ª ×œ×‘×™×˜×•×œ!')) {
        return;
      }

      // Second confirmation for safety
      if (!confirm('××™×©×•×¨ ×¡×•×¤×™: ×”×× ××ª×” ×‘×˜×•×— ×œ×—×œ×•×˜×™×Ÿ? ×”××©×™××” ×ª×™××—×§ ×œ×¦××™×ª×•×ª.')) {
        return;
      }

      try {
        const { error } = await supabase
          .from('tasks')
          .delete()
          .eq('id', taskId);

        if (error) throw error;

        alert('âœ… ×”××©×™××” × ××—×§×” ×‘×”×¦×œ×—×”');
        await loadTasks();
        await updateStats();
        await updateArchiveCount();

      } catch (error) {
        console.error('Error deleting task:', error);
        alert('âŒ ×©×’×™××” ×‘××—×™×§×ª ×”××©×™××”: ' + error.message);
      }
    };

    // Archive Modal Functions
    let archivedTasks = [];

    window.openArchiveModal = async function() {
      document.getElementById('archiveModal').classList.add('open');
      await loadArchivedTasks();
    };

    window.closeArchiveModal = function() {
      document.getElementById('archiveModal').classList.remove('open');
      document.getElementById('archiveSearchInput').value = '';
    };

    async function loadArchivedTasks() {
      try {
        const { data: tasks, error } = await supabase
          .from('tasks')
          .select('*')
          .eq('archived', true)
          .order('archived_at', { ascending: false });

        if (error) throw error;

        // Fetch profiles for name lookups
        const { data: profiles } = await supabase
          .from('profiles')
          .select('user_id, name, role');

        const profileMap = {};
        (profiles || []).forEach(p => {
          profileMap[p.user_id] = p;
        });

        // Add profile data to tasks
        archivedTasks = (tasks || []).map(task => ({
          ...task,
          assigned_to_profile: profileMap[task.assigned_to],
          assigned_by_profile: profileMap[task.assigned_by],
          archived_by_profile: profileMap[task.archived_by]
        }));

        // Update counts
        const count = archivedTasks.length;
        document.getElementById('archiveCount').textContent = count;
        document.getElementById('archiveCountToolbar').textContent = count;

        renderArchivedTasks(archivedTasks);

      } catch (error) {
        console.error('Error loading archived tasks:', error);
        document.getElementById('archivedTasksContainer').innerHTML =
          '<div style="text-align: center; padding: 2rem; color: #EF4444;">×©×’×™××” ×‘×˜×¢×™× ×ª ××©×™××•×ª ×××•×¨×›×‘×•×ª</div>';
      }
    }

    function renderArchivedTasks(tasks) {
      const container = document.getElementById('archivedTasksContainer');

      if (!tasks || tasks.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #9CA3AF;">××™×Ÿ ××©×™××•×ª ×‘××¨×›×™×•×Ÿ</div>';
        return;
      }

      container.innerHTML = tasks.map(task => {
        const assignedToName = task.assigned_to_profile?.name || '×œ× ×™×“×•×¢';
        const assignedByName = task.assigned_by_profile?.name || '×œ× ×™×“×•×¢';
        const archivedByName = task.archived_by_profile?.name || '×œ× ×™×“×•×¢';
        const archivedAt = task.archived_at ? new Date(task.archived_at).toLocaleDateString('he-IL') : '';

        const priorityColors = {
          urgent: '#EF4444',
          high: '#F59E0B',
          medium: '#3B82F6',
          low: '#9CA3AF'
        };

        const priorityLabels = {
          urgent: '×“×—×•×£',
          high: '×’×‘×•×”',
          medium: '×‘×™× ×•× ×™',
          low: '× ××•×š'
        };

        const statusLabels = {
          pending: '×××ª×™× ×”',
          in_progress: '×‘×‘×™×¦×•×¢',
          awaiting_response: '×××ª×™× ×” ×œ×ª×©×•×‘×”',
          completed: '×”×•×©×œ××”',
          verified: '××•×©×¨×”',
          cancelled: '×‘×•×˜×œ×”'
        };

        return `
          <div class="task-card" style="margin-bottom: 1rem; opacity: 0.8;">
            <div class="task-header">
              <div class="task-title">
                ${task.title}
                <span class="priority-badge" style="background: ${priorityColors[task.priority] || '#9CA3AF'};">
                  ${priorityLabels[task.priority] || task.priority}
                </span>
              </div>
              <div class="task-meta">
                <span style="color: #10B981;">âœ“ ${statusLabels[task.status] || task.status}</span>
              </div>
            </div>

            ${task.description ? `<div style="color: #9CA3AF; margin: 0.5rem 0; font-size: 0.9rem;">${task.description}</div>` : ''}

            <div style="display: flex; gap: 1rem; margin-top: 0.75rem; flex-wrap: wrap; font-size: 0.85rem; color: #9CA3AF;">
              <div>ğŸ‘¤ ×”×•×§×¦×” ×œ: <strong style="color: #fff;">${assignedToName}</strong></div>
              <div>ğŸ“¤ ×”×•×§×¦×” ×¢"×™: <strong style="color: #fff;">${assignedByName}</strong></div>
              ${task.plate ? `<div>ğŸš— ${task.plate}</div>` : ''}
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 0.75rem; font-size: 0.85rem; color: #9CA3AF; border-top: 1px solid #3a3a3a; padding-top: 0.75rem;">
              <div>ğŸ“¦ ×”×•×¢×‘×¨ ×œ××¨×›×™×•×Ÿ ×‘-${archivedAt} ×¢"×™ ${archivedByName}</div>
            </div>

            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
              <button class="btn btn-sm" onclick="restoreTask('${task.id}')"
                style="background: #10B981; padding: 0.4rem 1rem; font-size: 0.85rem;">
                â†©ï¸ ×©×—×–×¨ ×××¨×›×™×•×Ÿ
              </button>
              <button class="btn btn-sm" onclick="openTaskDetail('${task.id}')"
                style="background: #3B82F6; padding: 0.4rem 1rem; font-size: 0.85rem;">
                ğŸ‘ï¸ ×¦×¤×”
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    window.searchArchivedTasks = function() {
      const search = document.getElementById('archiveSearchInput').value.toLowerCase();

      if (!search) {
        renderArchivedTasks(archivedTasks);
        return;
      }

      const filtered = archivedTasks.filter(task =>
        task.title.toLowerCase().includes(search) ||
        (task.description && task.description.toLowerCase().includes(search)) ||
        (task.assigned_to_profile?.name && task.assigned_to_profile.name.toLowerCase().includes(search)) ||
        (task.plate && task.plate.includes(search))
      );

      renderArchivedTasks(filtered);
    };

    // Update archive count when loading tasks
    async function updateArchiveCount() {
      try {
        const { count, error } = await supabase
          .from('tasks')
          .select('*', { count: 'exact', head: true })
          .eq('archived', true);

        if (!error && count !== null) {
          document.getElementById('archiveCountToolbar').textContent = count;
        }
      } catch (error) {
        console.error('Error updating archive count:', error);
      }
    }

    // Filter and search functions
    window.filterByStatus = function(status) {
      const statusFilter = document.getElementById('statusFilter');
      statusFilter.value = status === 'active' ? 'in_progress' :
                          status === 'overdue' ? '' : status;
      filterTasks();
    };

    window.filterTasks = function() {
      const priority = document.getElementById('priorityFilter').value;
      const status = document.getElementById('statusFilter').value;
      const search = document.getElementById('searchInput').value.toLowerCase();

      let filtered = allTasks;

      if (priority) {
        filtered = filtered.filter(t => t.priority === priority);
      }

      if (status) {
        filtered = filtered.filter(t => t.status === status);
      }

      if (search) {
        filtered = filtered.filter(t =>
          t.title.toLowerCase().includes(search) ||
          (t.description && t.description.toLowerCase().includes(search)) ||
          (t.plate && t.plate.includes(search))
        );
      }

      renderTasks(filtered);
    };

    window.searchTasks = function() {
      filterTasks();
    };

    window.openTaskDetail = function(taskId) {
      window.location.href = `task-detail.html?id=${taskId}`;
    };

    // Utility functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getPriorityIcon(priority) {
      const icons = {
        low: 'ğŸŸ¢',
        medium: 'ğŸ”µ',
        high: 'âš ï¸',
        urgent: 'ğŸ”´'
      };
      return icons[priority] || 'âšª';
    }

    function getPriorityLabel(priority) {
      const labels = {
        low: '× ××•×š',
        medium: '×‘×™× ×•× ×™',
        high: '×’×‘×•×”',
        urgent: '×“×—×•×£'
      };
      return labels[priority] || priority;
    }

    function getStatusLabel(status) {
      const labels = {
        pending: '×××ª×™× ×”',
        in_progress: '×‘×‘×™×¦×•×¢',
        awaiting_response: '×××ª×™× ×” ×œ×ª×©×•×‘×”',
        completed: '×”×•×©×œ××”',
        verified: '××•×©×¨×”',
        cancelled: '×‘×•×˜×œ×”'
      };
      return labels[status] || status;
    }

    function formatDate(dateString) {
      if (!dateString) return null;
      const date = new Date(dateString);
      return date.toLocaleDateString('he-IL', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatRelativeTime(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return '×¢×›×©×™×•';
      if (diffMins < 60) return `×œ×¤× ×™ ${diffMins} ×“×§×•×ª`;
      if (diffHours < 24) return `×œ×¤× ×™ ${diffHours} ×©×¢×•×ª`;
      return `×œ×¤× ×™ ${diffDays} ×™××™×`;
    }

    function showError(message) {
      const container = document.getElementById('tasksContainer');
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">âŒ</div>
          <h3>${message}</h3>
        </div>
      `;
    }

    // Batch Notification Functions
    function updateNotificationBadge() {
      if (!window.taskNotifications) return;

      const count = window.taskNotifications.getPendingCount();
      const badge = document.getElementById('notificationBadge');
      const button = document.getElementById('sendNotificationsBtn');

      if (count > 0) {
        badge.textContent = count;
        button.style.display = 'block';
      } else {
        button.style.display = 'none';
      }
    }

    window.sendBatchNotifications = async function() {
      if (!window.taskNotifications) {
        alert('××¢×¨×›×ª ×”×”×ª×¨××•×ª ×œ× ×–××™× ×”');
        return;
      }

      const count = window.taskNotifications.getPendingCount();
      if (count === 0) {
        alert('××™×Ÿ ×”×ª×¨××•×ª ×××ª×™× ×•×ª ×œ×©×œ×™×—×”');
        return;
      }

      if (!confirm(`×”×× ×œ×©×œ×•×— ×”×ª×¨××•×ª ×¢×‘×•×¨ ${count} ××©×™××•×ª?`)) {
        return;
      }

      try {
        const result = await window.taskNotifications.sendBatchNotifications();

        if (result.success) {
          if (result.count > 0) {
            alert(`âœ… × ×©×œ×—×• ${result.count} ×”×ª×¨××•×ª ×‘×”×¦×œ×—×”!\n\n××©×ª××©×™× ×©×§×™×‘×œ×• ×”×ª×¨××•×ª: ${result.usersNotified}`);
          } else {
            alert('âœ… ×›×œ ×”×”×ª×¨××•×ª × ×©×œ×—×• ×‘×”×¦×œ×—×”!');
          }
          updateNotificationBadge();
        } else {
          alert('âŒ ×©×’×™××” ×‘×©×œ×™×—×ª ×”×ª×¨××•×ª: ' + (result.error || '×œ× ×™×“×•×¢'));
        }
      } catch (error) {
        console.error('Error sending batch notifications:', error);
        alert('âŒ ×©×’×™××” ×‘×©×œ×™×—×ª ×”×ª×¨××•×ª');
      }
    };

    // Initialize on load
    init();
  </script>
</body>
</html>
