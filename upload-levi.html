<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×“×•"×— ×œ×•×™ ×™×¦×—×§</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link href="https://fonts.googleapis.com/css2?family=Assistant&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 90px 20px 20px 20px;
      min-height: 100vh;
      direction: rtl;
    }
    
    .container {
      max-width: 700px;
      width: 90%;
      background: #fff;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e1e8ed;
    }
    
    .logo img {
      width: 120px;
      margin-bottom: 15px;
    }
    
    .title { 
      font-size: 24px; 
      font-weight: bold; 
      margin-bottom: 5px; 
      color: #1e3a8a;
    }
    h2 {
      font-size: 22px;
      color: #64748b;
      margin-bottom: 30px;
    }
    .subtitle { 
      font-size: 20px; 
      color: #64748b; 
      margin-bottom: 20px; 
    }
    
    .section {
      margin-bottom: 30px;
      padding: 25px;
      border: 1px solid #e1e8ed;
      border-radius: 10px;
      background: #f8f9fa;
    }
    
    .section h3 {
      margin: 0 0 20px 0;
      color: #2c3e50;
      font-size: 20px;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .form-group {
      flex: 1;
      min-width: 200px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #34495e;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px;
      font-size: 14px;
      border-radius: 8px;
      border: 2px solid #e1e8ed;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    .file-upload-area {
      border: 3px dashed #bdc3c7;
      border-radius: 15px;
      padding: 40px 20px;
      text-align: center;
      background: #ecf0f1;
      transition: all 0.3s ease;
      cursor: pointer;
      margin-bottom: 20px;
    }
    
    .file-upload-area:hover {
      border-color: #3498db;
      background: #ebf3fd;
    }
    
    .file-upload-area.dragover {
      border-color: #27ae60;
      background: #e8f5e8;
    }
    
    .upload-icon {
      font-size: 48px;
      color: #95a5a6;
      margin-bottom: 15px;
    }
    
    .upload-text {
      font-size: 18px;
      color: #7f8c8d;
      margin-bottom: 10px;
    }
    
    .upload-hint {
      font-size: 14px;
      color: #95a5a6;
    }
    
    #file-input {
      display: none;
    }
    
    .preview-container {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }
    
    .preview-image {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    .btn {
      padding: 15px 30px;
      font-size: 16px;
      font-weight: 600;
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin: 10px 5px;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .btn:hover {
      background: linear-gradient(135deg, #2980b9, #21618c);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
    }
    
    .btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #27ae60, #229954);
    }
    
    .btn-success:hover {
      background: linear-gradient(135deg, #229954, #1e8449);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #95a5a6, #7f8c8d);
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, #7f8c8d, #6c7b7d);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
    }
    
    .btn-danger:hover {
      background: linear-gradient(135deg, #c0392b, #a93226);
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #f39c12, #e67e22);
    }
    
    .btn-warning:hover {
      background: linear-gradient(135deg, #e67e22, #d35400);
    }
    
    .processing-status {
      display: none;
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .processing-status.show {
      display: block;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #ecf0f1;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 15px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3498db, #2980b9);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .ocr-results {
      display: none;
      background: white;
      border-radius: 10px;
      padding: 25px;
      margin-top: 20px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    .ocr-results.show {
      display: block;
    }
    
    .data-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .data-card {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      border: 1px solid #e1e8ed;
    }
    
    .data-card h4 {
      margin: 0 0 15px 0;
      color: #2c3e50;
      font-size: 16px;
      border-bottom: 1px solid #3498db;
      padding-bottom: 8px;
    }
    
    .data-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding: 5px 0;
      border-bottom: 1px solid #ecf0f1;
    }
    
    .data-item:last-child {
      border-bottom: none;
    }
    
    .data-label {
      font-weight: 600;
      color: #34495e;
    }
    
    .data-value {
      color: #2c3e50;
      font-weight: 500;
    }
    
    .validation-status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      display: none;
    }
    
    .validation-status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .validation-status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .validation-status.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .validation-status.show {
      display: block;
    }
    
    .footer-btns {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e1e8ed;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      justify-content: center;
    }
    
    .footer {
      text-align: center;
      font-size: 12px;
      margin-top: 20px;
      color: #95a5a6;
    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 25px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
    }
    
    .levi-portal-section {
      background: #e8f5e8;
      border: 2px solid #27ae60;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .levi-portal-section h3 {
      color: #27ae60;
      margin-bottom: 15px;
    }
    
    .credentials-display {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-family: monospace;
      font-size: 14px;
      text-align: right;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 90px 10px 20px 10px;
      }
      
      .container {
        width: 95%;
        margin: 10px auto;
        padding: 20px;
        box-sizing: border-box;
      }
      
      .form-row {
        flex-direction: column;
      }
      
      .action-buttons {
        grid-template-columns: 1fr;
        gap: 12px;
        margin-top: 20px;
        padding: 15px;
      }

      .action-buttons .btn {
        margin-bottom: 0;
        font-size: 15px;
        padding: 14px 18px;
        min-height: 48px;
        width: 100%;
      }
      
      .footer-btns {
        gap: 10px;
        margin-top: 25px;
        flex-direction: row;
        justify-content: space-between;
      }
      
      .footer-btns .btn {
        flex: 1;
        font-size: 14px;
        padding: 12px 16px;
        min-height: 44px;
      }
      
      .data-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .alert {
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
    }
    
    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .alert.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .alert.show {
      display: block;
    }
    
    .adjustment-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .adjustment-table th,
    .adjustment-table td {
      padding: 12px;
      text-align: right;
      border-bottom: 1px solid #ecf0f1;
    }
    
    .adjustment-table th {
      background: #34495e;
      color: white;
      font-weight: 600;
    }
    
    .adjustment-table tr:hover {
      background: #f8f9fa;
    }
    
    /* Adjustments table styling */
    .adjustment-header-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1.5fr 1.5fr;
      gap: 10px;
      padding: 12px;
      background: #3498db;
      color: white;
      font-weight: bold;
      border-radius: 8px 8px 0 0;
      border: 1px solid #2980b9;
    }
    
    .adjustment-header {
      text-align: center;
      font-size: 14px;
    }
    
    .adjustment-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1.5fr 1.5fr;
      gap: 10px;
      padding: 12px;
      background: #f8f9fa;
      border-left: 1px solid #e1e8ed;
      border-right: 1px solid #e1e8ed;
      border-bottom: 1px solid #e1e8ed;
      align-items: center;
    }
    
    .adjustment-row:last-child {
      border-radius: 0 0 8px 8px;
    }
    
    .adjustment-title {
      font-weight: bold;
      color: #2c3e50;
      text-align: right;
    }
    
    .adjustment-value {
      text-align: center;
      padding: 5px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
      color: #2c3e50;
    }

    .adjustment-section {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .adjustment-section h5 {
      margin: 0 0 15px 0;
      color: #495057;
      font-size: 16px;
      font-weight: bold;
      border-bottom: 2px solid #007bff;
      padding-bottom: 8px;
    }
    
    /* Floating Toggle Squares - Same as Depreciation Module */
    .floating-toggles-top {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 8px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .toggle-square {
      width: 80px;
      height: 70px;
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: white;
      text-align: center;
      border: 2px solid transparent;
    }
    .toggle-square:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 123, 255, 0.4);
      border-color: rgba(255, 255, 255, 0.3);
    }
    .toggle-square:active {
      transform: translateY(0);
    }
    .toggle-icon {
      font-size: 18px;
      margin-bottom: 2px;
    }
    .toggle-text {
      font-size: 10px;
      font-weight: 600;
      line-height: 1.1;
    }
    @media (max-width: 768px) {
      .floating-toggles-top {
        top: 5px;
        gap: 4px;
        padding: 6px;
      }
      .toggle-square {
        width: 65px;
        height: 60px;
      }
    }
  </style>
</head>
<body>

<script type="module">
  import { WEBHOOKS } from './webhook.js';
  import { caseOwnershipService } from './services/caseOwnershipService.js';
  
  window.WEBHOOKS = WEBHOOKS;
  
  // Phase 6: Case ownership check
  (async () => {
    const plateNumber = window.helper?.plate || sessionStorage.getItem('currentPlate');
    
    if (plateNumber) {
      const ownershipCheck = await caseOwnershipService.canEditCase(plateNumber);
      
      if (!ownershipCheck.canEdit) {
        alert(ownershipCheck.reason || '××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¢×¨×•×š ×ª×™×§ ×–×”.\n\n×¨×§ ×”×‘×¢×œ×™×, ×× ×”×œ ××• ××¤×ª×— ×™×›×•×œ×™× ×œ×¢×¨×•×š.');
        window.location.href = 'selection.html';
        return;
      }
      
      console.log('âœ… Case ownership verified - user can upload levi');
    }
  })();
</script>

<script>
// ğŸš¨ CRITICAL FIX: Define calculateFinalPrice early to prevent ReferenceError
window.calculateFinalPrice = function() {
  const basePrice = parseFloat(document.getElementById('manual-base-price')?.value) || 0;
  
  if (basePrice <= 0) {
    const finalPriceEl = document.getElementById('manual-final-price');
    if (finalPriceEl) finalPriceEl.value = '';
    return;
  }

  // Get all percentage adjustments
  const registrationPercent = parseFloat(document.getElementById('manual-registration-percent')?.value) || 0;
  const ownershipPercent = parseFloat(document.getElementById('manual-ownership-percent')?.value) || 0;
  const kmPercent = parseFloat(document.getElementById('manual-km-percent')?.value) || 0;
  const ownersPercent = parseFloat(document.getElementById('manual-owners-percent')?.value) || 0;
  const featuresPercent = parseFloat(document.getElementById('manual-features-percent')?.value) || 0;

  // Calculate individual adjustment values
  const registrationValue = Math.round(basePrice * (registrationPercent / 100));
  const ownershipValue = Math.round(basePrice * (ownershipPercent / 100));
  const kmValue = Math.round(basePrice * (kmPercent / 100));
  const ownersValue = Math.round(basePrice * (ownersPercent / 100));
  const featuresValue = Math.round(basePrice * (featuresPercent / 100));

  // Update individual value fields safely
  const updateField = (id, value) => {
    const el = document.getElementById(id);
    if (el) el.value = value;
  };
  
  updateField('manual-registration-value', registrationValue);
  updateField('manual-ownership-value', ownershipValue);
  updateField('manual-km-value', kmValue);
  updateField('manual-owners-value', ownersValue);
  updateField('manual-features-value', featuresValue);

  // Calculate cumulative totals
  let runningTotal = basePrice;
  
  runningTotal += registrationValue;
  updateField('manual-registration-total', Math.round(runningTotal));
  
  runningTotal += ownershipValue;
  updateField('manual-ownership-total', Math.round(runningTotal));
  
  runningTotal += kmValue;
  updateField('manual-km-total', Math.round(runningTotal));
  
  runningTotal += ownersValue;
  updateField('manual-owners-total', Math.round(runningTotal));
  
  runningTotal += featuresValue;
  updateField('manual-features-total', Math.round(runningTotal));

  // Final price is the last cumulative total
  updateField('manual-final-price', Math.round(runningTotal));
  
  // Save to helper if available
  if (window.helper) {
    window.helper.calculations = window.helper.calculations || {};
    const grossMarketValue = basePrice + featuresValue + registrationValue;
    window.helper.calculations.vehicle_value_gross = Math.round(grossMarketValue);
    window.helper.calculations.market_value = Math.round(runningTotal);
    
    if (window.saveHelperToAllStorageLocations) {
      window.saveHelperToAllStorageLocations();
    }
  }
  
  console.log(`ğŸ’° Calculated: Base=â‚ª${basePrice.toLocaleString()}, Final=â‚ª${Math.round(runningTotal).toLocaleString()}`);
  
  // Save manual data to helper system (same as OCR behavior)
  if (typeof window.saveManualDataToHelper === 'function') {
    window.saveManualDataToHelper();
  }
  
  // Update the gross market value field in the builder if the function exists
  if (typeof window.updateGrossMarketValueField === 'function') {
    window.updateGrossMarketValueField();
  }
  
  // Immediately update floating screen when calculations change
  if (typeof window.refreshLeviData === 'function') {
    window.refreshLeviData();
  }
};
</script>

<div class="container">
  <div class="header">
    <div class="logo">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo" />
    </div>
    <h1 class="title">×™×¨×•×Ÿ ×›×™×•×£ - ×©×××•×ª ×•×™×™×¢×•×¥</h1>
    <div class="subtitle">×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</div>
    <h2>×“×•"×— ×œ×•×™ ×™×¦×—×§</h2>
  </div>

  <div id="alerts-container"></div>

  <!-- Levi Portal Integration Section -->
  <div class="levi-portal-section">
    <h3>ğŸ”— ×›× ×™×¡×” ×œ××¢×¨×›×ª ×œ×•×™ ×™×¦×—×§</h3>
    <p>×œ×‘×“×™×§×ª ×©×•×•×™ ×¨×›×‘ ×‘××¢×¨×›×ª ×œ×•×™ ×™×¦×—×§</p>
    <button type="button" class="btn btn-warning" onclick="openLeviPortal()">
      ğŸŒ ×¤×ª×— ××ª×¨ ×œ×•×™ ×™×¦×—×§
    </button>
    <div class="credentials-display" id="credentials-display" style="display: none;">
      <div>×¤×¨×˜×™ ×”×ª×—×‘×¨×•×ª ×œ××¢×¨×›×ª:</div>
      <div id="username-display"></div>
      <div id="password-display"></div>
    </div>
  </div>

  <form id="levi-form" method="POST" onsubmit="return false;">
    <!-- Case Information Section -->
    <div class="section">
      <h3>×¤×¨×˜×™ ×”×ª×™×§ 
        <button type="button" onclick="leviProcessor.loadCaseData()" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-right: 10px; cursor: pointer;">ğŸ”„ ×¨×¢× ×Ÿ × ×ª×•× ×™×</button>
      </h3>
      <div class="form-row">
        <div class="form-group">
          <label for="plate">××¡×¤×¨ ×¨×™×©×•×™:</label>
          <input id="plate" name="plate" placeholder="××¡×¤×¨ ×¨×™×©×•×™ ×”×¨×›×‘" required type="text" />
        </div>
        <div class="form-group">
          <label for="owner">×©× ×‘×¢×œ ×”×¨×›×‘:</label>
          <input id="owner" name="owner" placeholder="×©× ×‘×¢×œ ×”×¨×›×‘" required type="text" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="office_code">×§×•×“ ××©×¨×“ ×”×ª×—×‘×•×¨×”:</label>
          <input id="office_code" name="office_code" placeholder="×§×•×“ ××©×¨×“ ×”×ª×—×‘×•×¨×”" type="text" autocomplete="organization" data-form-type="other" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="report-source">××§×•×¨ ×”×“×•"×—:</label>
          <select id="report-source" name="report-source">
            <option value="screenshot">×¦×™×œ×•× ××¡×š ××ª××—×‘×¨</option>
            <option value="pdf">×§×•×‘×¥ PDF</option>
            <option value="manual">×”×–× ×” ×™×“× ×™×ª</option>
          </select>
        </div>
        <div class="form-group">
          <label for="valuation-date">×ª××¨×™×š ×”×¢×¨×›×”:</label>
          <input id="valuation-date" name="valuation-date" type="date" />
        </div>
      </div>
    </div>

    <!-- Authentication Section -->
    <div class="section">
      <h3>×¤×¨×˜×™ ×–×™×”×•×™ 
        <button type="button" onclick="testPasswordPrefill()" style="background: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-right: 10px; cursor: pointer;">ğŸ”‘ ×‘×“×™×§×ª ×¡×™×¡××</button>
      </h3>
      <div class="form-row">
        <div class="form-group">
          <label for="pass">×¡×™×¡××:</label>
          <input id="pass" name="pass" placeholder="×¡×™×¡××" required type="password" autocomplete="current-password" />
        </div>
      </div>
    </div>

    <!-- File Upload Section -->
    <div class="section" id="upload-section">
      <h3>×”×¢×œ××ª ×“×•"×— ×œ×•×™ ×™×¦×—×§</h3>
      <div class="file-upload-area" onclick="document.getElementById('file-input').click()">
        <div class="upload-icon">ğŸ“Š</div>
        <div class="upload-text">×œ×—×¥ ×›××Ÿ ××• ×’×¨×•×¨ ×“×•"×— ×œ×•×™ ×™×¦×—×§ ×œ××–×•×¨ ×–×”</div>
        <div class="upload-hint">×ª×•××š ×‘×§×‘×¦×™ PDF, JPG, PNG | ×’×•×“×œ ××§×¡×™××œ×™: 10MB</div>
      </div>
      <input id="file-input" type="file" accept="image/*,.pdf" required />
      
      <!-- Preview Container -->
      <div class="preview-container" id="preview-container">
        <img id="preview-image" class="preview-image" style="display: none;" />
      </div>
    </div>

    <!-- Manual Entry Section -->
    <div class="section" id="manual-section" style="display: none;">
      <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        âš ï¸ <strong>×”×–× ×” ×™×“× ×™×ª - ××¤×©×¨×•×ª ×’×™×‘×•×™ ×‘×œ×‘×“</strong><br>
        ××¤×©×¨×•×ª ×–×• ××©××©×ª ×¨×§ ×‘××§×¨×™× ×—×¨×™×’×™× ×›××©×¨ OCR ×œ× ×¢×•×‘×“. ×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”××©×™×š?
        <div style="margin-top: 10px;">
          <button type="button" onclick="confirmManualEntry()" style="background: #f39c12; color: white; border: none; padding: 8px 15px; border-radius: 4px; margin-right: 10px;">×›×Ÿ, ×”××©×š</button>
          <button type="button" onclick="cancelManualEntry()" style="background: #95a5a6; color: white; border: none; padding: 8px 15px; border-radius: 4px;">×‘×™×˜×•×œ</button>
        </div>
      </div>

      <div id="manual-form-content" style="display: none;">
        <h3>×”×–× ×” ×™×“× ×™×ª - ×“×•"×— ×œ×•×™ ×™×¦×—×§</h3>
        
        
        <!-- Basic Vehicle Info -->
        <div class="form-row">
          <div class="form-group">
            <label for="manual-vehicle-type">×¡×•×’ ×¨×›×‘:</label>
            <input id="manual-vehicle-type" type="text" placeholder="×¡×•×’ ×¨×›×‘" />
          </div>
          <div class="form-group">
            <label for="manual-manufacturer">×™×¦×¨×Ÿ:</label>
            <input id="manual-manufacturer" type="text" placeholder="×™×¦×¨×Ÿ ×”×¨×›×‘" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="manual-model-code">×§×•×“ ×“×’×:</label>
            <input id="manual-model-code" type="text" placeholder="×§×•×“ ×“×’×" />
          </div>
          <div class="form-group">
            <label for="manual-category">×§×˜×’×•×¨×™×”:</label>
            <input id="manual-category" type="text" placeholder="×§×˜×’×•×¨×™×™×ª ×”×¨×›×‘" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="manual-year">×©× ×ª ×™×¦×•×¨:</label>
            <input id="manual-year" type="number" min="1980" max="2030" placeholder="×©× ×ª ×™×¦×•×¨" />
          </div>
          <div class="form-group">
            <label for="manual-full-model">×©× ×“×’× ××œ×:</label>
            <input id="manual-full-model" type="text" placeholder="×©× ×“×’× ××œ×" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="manual-base-price">××—×™×¨ ×‘×¡×™×¡:</label>
            <input id="manual-base-price" type="number" min="0" step="100" placeholder="××—×™×¨ ×‘×¡×™×¡ ×‘×©×§×œ×™×" onchange="calculateFinalPrice()" />
          </div>
          <div class="form-group">
            <label for="manual-final-price">××—×™×¨ ×¡×•×¤×™ ×œ×¨×›×‘: <span style="color: #888;">(××—×•×©×‘ ××•×˜×•××˜×™×ª)</span></label>
            <input id="manual-final-price" type="number" min="0" step="100" placeholder="××—×•×©×‘ ××•×˜×•××˜×™×ª" readonly style="background: #f8f9fa;" />
          </div>
        </div>

        <!-- Price Adjustments -->
        <h4 style="margin-top: 30px; color: #2c3e50;">×”×ª×××•×ª ××—×™×¨</h4>
        
        <!-- Registration Adjustment -->
        <div class="adjustment-section">
          <h5>×¢×œ×™×” ×œ×›×‘×™×©:</h5>
          <div class="form-row">
            <div class="form-group">
              <label>×¢×œ×™×” ×œ×›×‘×™×©:</label>
              <input id="manual-registration" type="text" placeholder="×¡×•×’ ×¢×œ×™×” ×œ×›×‘×™×©" />
            </div>
            <div class="form-group">
              <label>×¢×œ×™×” ×œ×›×‘×™×© %:</label>
              <input id="manual-registration-percent" type="number" step="0.1" min="-100" max="100" placeholder="0" onchange="calculateFinalPrice()" />
            </div>
            <div class="form-group">
              <label>×¢×¨×š ×©×´×— ×¢×œ×™×” ×œ×›×‘×™×©:</label>
              <input id="manual-registration-value" type="number" step="100" placeholder="0" readonly style="background: #f8f9fa;" />
            </div>
            <div class="form-group">
              <label>×©×•×•×™ ××¦×˜×‘×¨ ×¢×œ×™×” ×œ×›×‘×™×©:</label>
              <input id="manual-registration-total" type="number" step="100" placeholder="0" readonly style="background: #f8f9fa;" />
            </div>
          </div>
        </div>

        <!-- Ownership Adjustment -->
        <div class="adjustment-section">
          <h5>×¡×•×’ ×‘×¢×œ×•×ª:</h5>
          <div class="form-row">
            <div class="form-group">
              <label>×‘×¢×œ×•×ª:</label>
              <input id="manual-ownership" type="text" placeholder="×¡×•×’ ×‘×¢×œ×•×ª" />
            </div>
            <div class="form-group">
              <label>×‘×¢×œ×•×ª %:</label>
              <input id="manual-ownership-percent" type="number" step="0.1" min="-100" max="100" placeholder="0" onchange="calculateFinalPrice()" />
            </div>
            <div class="form-group">
              <label>×¢×¨×š ×©×´×— ×‘×¢×œ×•×ª:</label>
              <input id="manual-ownership-value" type="number" step="100" placeholder="0" readonly style="background: #f8f9fa;" />
            </div>
            <div class="form-group">
              <label>×©×•×•×™ ××¦×˜×‘×¨ ×‘×¢×œ×•×ª:</label>
              <input id="manual-ownership-total" type="number" step="100" placeholder="0" readonly style="background: #f8f9fa;" />
            </div>
          </div>
        </div>

        <!-- KM Adjustment -->
        <div class="adjustment-section">
          <h5>××¡×¤×¨ ×§×´×:</h5>
          <div class="form-row">
            <div class="form-group">
              <label>××¡ ×§×´×:</label>
              <input id="manual-km" type="text" placeholder="××¡×¤×¨ ×§×´×" />
            </div>
            <div class="form-group">
              <label>××¡ ×§×´× %:</label>
              <input id="manual-km-percent" type="number" step="0.1" min="-100" max="100" placeholder="0" onchange="calculateFinalPrice()" />
            </div>
            <div class="form-group">
              <label>×¢×¨×š ×©×´×— ××¡ ×§×´×:</label>
              <input id="manual-km-value" type="number" step="100" placeholder="0" readonly style="background: #f8f9fa;" />
            </div>
            <div class="form-group">
              <label>×©×•×•×™ ××¦×˜×‘×¨ ××¡ ×§×´×:</label>
              <input id="manual-km-total" type="number" step="100" placeholder="0" readonly style="background: #f8f9fa;" />
            </div>
          </div>
        </div>

        <!-- Owners Adjustment -->
        <div class="adjustment-section">
          <h5>××¡×¤×¨ ×‘×¢×œ×™×:</h5>
          <div class="form-row">
            <div class="form-group">
              <label>××¡×¤×¨ ×‘×¢×œ×™×:</label>
              <input id="manual-owners" type="text" placeholder="××¡×¤×¨ ×‘×¢×œ×™×" />
            </div>
            <div class="form-group">
              <label>××¡×¤×¨ ×‘×¢×œ×™× %:</label>
              <input id="manual-owners-percent" type="number" step="0.1" min="-100" max="100" placeholder="0" onchange="calculateFinalPrice()" />
            </div>
            <div class="form-group">
              <label>×¢×¨×š ×©×´×— ××¡×¤×¨ ×‘×¢×œ×™×:</label>
              <input id="manual-owners-value" type="number" step="100" placeholder="0" readonly style="background: #f8f9fa;" />
            </div>
            <div class="form-group">
              <label>×©×•×•×™ ××¦×˜×‘×¨ ××¡×¤×¨ ×‘×¢×œ×™×:</label>
              <input id="manual-owners-total" type="number" step="100" placeholder="0" readonly style="background: #f8f9fa;" />
            </div>
          </div>
        </div>

        <!-- Features Adjustment -->
        <div class="adjustment-section">
          <h5>×××¤×™×™× ×™×:</h5>
          <div class="form-row">
            <div class="form-group">
              <label>×××¤×™×™× ×™×:</label>
              <input id="manual-features" type="text" placeholder="×××¤×™×™× ×™×" />
            </div>
            <div class="form-group">
              <label>×××¤×™×™× ×™× %:</label>
              <input id="manual-features-percent" type="number" step="0.1" min="-100" max="100" placeholder="0" onchange="calculateFinalPrice()" />
            </div>
            <div class="form-group">
              <label>×¢×¨×š ×©×´×— ×××¤×™×™× ×™×:</label>
              <input id="manual-features-value" type="number" step="100" placeholder="0" readonly style="background: #f8f9fa;" />
            </div>
            <div class="form-group">
              <label>×©×•×•×™ ××¦×˜×‘×¨ ×××¤×™×™× ×™×:</label>
              <input id="manual-features-total" type="number" step="100" placeholder="0" readonly style="background: #f8f9fa;" />
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Processing Status -->
    <div class="processing-status" id="processing-status">
      <h3>××¢×‘×“ ×“×•"×— ×œ×•×™ ×™×¦×—×§...</h3>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div id="progress-text">×× × ×”××ª×Ÿ...</div>
    </div>

    <!-- OCR Results Section -->
    <div class="ocr-results" id="ocr-results">
      <h3>×ª×•×¦××•×ª ×¢×™×‘×•×“ ×“×•"×— ×œ×•×™ ×™×¦×—×§</h3>
      
      <!-- Vehicle Information -->
      <div class="data-grid">
        <div class="data-card">
          <h4>×¤×¨×˜×™ ×”×¨×›×‘</h4>
          <div id="vehicle-details">
            <!-- Vehicle details will be populated here -->
          </div>
        </div>
        
        <div class="data-card">
          <h4>×¤×¨×˜×™ ×”×”×¢×¨×›×”</h4>
          <div id="valuation-details">
            <!-- Valuation details will be populated here -->
          </div>
        </div>
        
        <div class="data-card">
          <h4>××—×™×¨×™×</h4>
          <div id="pricing-details">
            <!-- Pricing details will be populated here -->
          </div>
        </div>
      </div>
      
      <!-- Price Adjustments - New Layout -->
      <div style="margin-top: 30px;">
        <h4>×”×ª×××•×ª ××—×™×¨</h4>
        <div id="adjustments-container">
          <!-- Adjustments will be populated here -->
        </div>
      </div>
      
      <!-- Manual Override Section -->
      <div class="section" style="margin-top: 20px;">
        <h3>×¢×“×›×•×Ÿ ×™×“× ×™</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="override-base-price">××—×™×¨ ×‘×¡×™×¡:</label>
            <input id="override-base-price" type="number" step="100" />
          </div>
          <div class="form-group">
            <label for="override-final-price">××—×™×¨ ×¡×•×¤×™:</label>
            <input id="override-final-price" type="number" step="100" />
          </div>
        </div>
        <button type="button" id="update-prices" class="btn btn-secondary">×¢×“×›×Ÿ ××—×™×¨×™×</button>
      </div>
    </div>

    <!-- Validation Status -->
    <div class="validation-status" id="validation-status">
      <!-- Validation messages will appear here -->
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button type="submit" id="process-levi" class="btn btn-success">
        ğŸ” ×¢×‘×“ ×“×•"×— ×œ×•×™
      </button>
      <button type="button" id="save-results" class="btn btn-primary" style="display: none;">
        ğŸ’¾ ×©××•×¨ ×ª×•×¦××•×ª
      </button>
      <button type="button" id="save-manual" class="btn btn-success" style="display: none;">
        ğŸ’¾ ×©××•×¨ × ×ª×•× ×™× ×™×“× ×™×™×
      </button>
      <button type="button" id="upload-new-report" class="btn btn-warning" style="display: none;">
        ğŸ“¤ ×”×¢×œ×” ×“×•"×— ×—×“×©
      </button>
      <button type="button" id="clear-form" class="btn btn-secondary">
        ğŸ—‘ï¸ × ×§×” ×˜×•×¤×¡
      </button>
      <button type="button" id="toggle-manual" class="btn btn-warning">
        âœï¸ ×”×–× ×” ×™×“× ×™×ª
      </button>
      <button type="button" id="continue-to-damage" class="btn btn-success" style="display: none;">
        â¡ï¸ ×”××©×š ×œ××•×§×“×™ × ×–×§
      </button>
    </div>
  </form>

  <div class="footer-btns">
    <button class="btn btn-secondary" onclick="window.location.href='selection.html'">ğŸ  ×¢××•×“ ×”×‘×™×ª</button>
    <button class="btn btn-danger" onclick="logout()">ğŸšª ×™×¦×™××”</button>
  </div>

  <div class="footer">@2025 Carmel Cayouf. All rights reserved. SmartVal Pro System by Eval Â©</div>
</div>

<script type="module">
import { sendToWebhook, getWebhook } from './webhook.js';
// SESSION 56: helper.js is NOT an ES6 module - use window.updateHelper
// import { updateHelper } from './helper.js';

// Enhanced Levi Report Processing System
class LeviProcessor {
  constructor() {
    this.uploadedFile = null;
    this.leviResults = {};
    this.processingInProgress = false;
    this.maxFileSize = 10 * 1024 * 1024; // 10MB
    this.allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'application/pdf'];
    this.isManualMode = false;
    
    this.init();
  }

  init() {
    this.setupEventListeners();
    this.loadCaseData();
    this.setupDragAndDrop();
    this.loadCredentials();
  }

  setupEventListeners() {
    // File input change
    document.getElementById('file-input').addEventListener('change', (e) => {
      this.handleFileSelection(e.target.files[0]);
    });

    // Form submission
    document.getElementById('levi-form').addEventListener('submit', (e) => {
      e.preventDefault();
      this.processLevi();
    });

    // Manual mode toggle
    document.getElementById('toggle-manual').addEventListener('click', () => {
      this.toggleManualMode();
    });

    // Report source change
    document.getElementById('report-source').addEventListener('change', (e) => {
      this.handleReportSourceChange(e.target.value);
    });

    // Clear form
    document.getElementById('clear-form').addEventListener('click', () => {
      this.clearForm();
    });

    // Save results
    document.getElementById('save-results').addEventListener('click', () => {
      this.saveResults();
    });
    
    // Upload new report
    document.getElementById('upload-new-report').addEventListener('click', () => {
      this.resetForNewUpload();
    });

    // Save manual data
    document.getElementById('save-manual').addEventListener('click', () => {
      this.saveManualData();
    });


    // Update prices
    document.getElementById('update-prices').addEventListener('click', () => {
      this.updatePrices();
    });

    // Valuation date auto-set to today
    document.getElementById('valuation-date').value = new Date().toISOString().split('T')[0];
  }

  loadCaseData() {
    try {
      
      // Check all available data sources
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      const makeCarData = JSON.parse(sessionStorage.getItem('makeCarData') || '{}');
      const carData = JSON.parse(sessionStorage.getItem('carData') || '{}');
      
      console.log('ğŸ“Š LEVI UPLOAD: Available data sources:', {
        helper: Object.keys(helper),
        makeCarData: Object.keys(makeCarData),
        carData: Object.keys(carData)
      });
      
      console.log('ğŸ“‹ helper content:', helper);
      console.log('ğŸ“‹ carData content:', carData);
      
      // Load plate number from multiple sources
      let plate = '';
      if (makeCarData.plate) plate = makeCarData.plate;
      else if (helper.car_details?.plate) plate = helper.car_details.plate;
      else if (helper.vehicle?.plate) plate = helper.vehicle.plate;
      else if (helper.meta?.plate) plate = helper.meta.plate;
      else if (carData.plate) plate = carData.plate;
      
      if (plate) {
        document.getElementById('plate').value = plate;
        console.log('âœ… LEVI UPLOAD: Plate loaded:', plate);
      }
      
      // Load owner name from multiple sources
      let owner = '';
      if (makeCarData.owner) owner = makeCarData.owner;
      else if (helper.car_details?.owner) owner = helper.car_details.owner;
      else if (helper.general_info?.owner_name) owner = helper.general_info.owner_name;
      else if (helper.meta?.owner_name) owner = helper.meta.owner_name;
      else if (carData.owner) owner = carData.owner;
      
      if (owner) {
        document.getElementById('owner').value = owner;
        console.log('âœ… LEVI UPLOAD: Owner loaded:', owner);
      }
      
      // Load office code from multiple sources with detailed logging
      let officeCode = '';
      
      console.log('ğŸ” helper.car_details?.office_code:', helper.car_details?.office_code);
      console.log('ğŸ” helper.general_info?.office_code:', helper.general_info?.office_code);
      console.log('ğŸ” helper.car_details structure:', helper.car_details);
      
      // PRIORITY 1: Extract from car_details raw text FIRST (most accurate source)
      if (helper.car_details?.raw_response || helper.car_details?.message) {
        const rawText = helper.car_details.raw_response || helper.car_details.message;
        console.log('ğŸ” Searching in car_details raw text:', rawText?.substring(0, 200) + '...');
        
        const officeCodeMatch = rawText.match(/(?:×§×•×“ ××©×¨×“ ×”×ª×—×‘×•×¨×”|×§×•×“ ××©×¨×“|××©×¨×“ ×”×ª×—×‘×•×¨×”|×§×•×“\s*××©×¨×“)[:\s-]*([0-9-]+)/i);
        console.log('ğŸ” Regex match result:', officeCodeMatch);
        
        if (officeCodeMatch && officeCodeMatch[1]) {
          officeCode = officeCodeMatch[1];
          console.log('âœ… EXTRACTED office_code from car_details raw text:', officeCode);
        }
      }
      
      // PRIORITY 2: Check structured data sources if raw text extraction failed
      if (!officeCode && makeCarData.office_code) {
        officeCode = makeCarData.office_code;
        console.log('âœ… Using office_code from makeCarData:', officeCode);
      }
      else if (!officeCode && helper.car_details?.office_code) {
        officeCode = helper.car_details.office_code;
        console.log('âœ… Using office_code from helper.car_details:', officeCode);
      }
      else if (!officeCode && helper.general_info?.office_code) {
        officeCode = helper.general_info.office_code;
        console.log('âœ… Using office_code from helper.general_info:', officeCode);
      }
      
      // PRIORITY 3: Use helper.vehicle.office_code ONLY as last resort (may be default value)
      else if (!officeCode && helper.vehicle?.office_code && helper.vehicle.office_code !== '01') {
        officeCode = helper.vehicle.office_code;
        console.log('âœ… Using office_code from helper.vehicle (non-default):', officeCode);
      }
      
      // Fallback to default only if still not found
      if (!officeCode) {
        officeCode = '01'; // âœ… DEFAULT: Set default office code if none found
        console.log('âš ï¸ Using default office_code:', officeCode);
      } else {
        console.log('âœ… Final office_code selected:', officeCode);
      }
      
      if (officeCode) {
        document.getElementById('office_code').value = officeCode;
        console.log('âœ… LEVI UPLOAD: Office code loaded:', officeCode);
      }
      
      // Load password from helper (multiple possible locations)
      let password = null;
      if (helper.credentials?.ycPass) {
        password = helper.credentials.ycPass;
      } else if (helper.general_info?.ycPass) {
        password = helper.general_info.ycPass;
      } else if (helper.general_info?.password) {
        password = helper.general_info.password;
      }
      
      if (password) {
        document.getElementById('pass').value = password;
        console.log('âœ… LEVI UPLOAD: Password loaded from helper');
      } else {
        console.log('âš ï¸ LEVI UPLOAD: No password found in helper, checking prefill system...');
        
        // Try password prefill system
        const prefillPassword = sessionStorage.getItem('prefillPassword');
        if (prefillPassword) {
          document.getElementById('pass').value = prefillPassword;
          console.log('âœ… LEVI UPLOAD: Password loaded from prefill system');
        } else {
          console.log('âŒ LEVI UPLOAD: No password found anywhere');
        }
      }
      
      // Debug password storage
      console.log('ğŸ” LEVI UPLOAD: Debugging password storage...');
      console.log('ğŸ” sessionStorage.prefillPassword:', sessionStorage.getItem('prefillPassword'));
      console.log('ğŸ” sessionStorage.auth:', sessionStorage.getItem('auth'));
      console.log('ğŸ” All sessionStorage keys:', Object.keys(sessionStorage));
      
      // Also trigger the global password prefill function
      if (typeof window.prefillUserPassword === 'function') {
        setTimeout(() => {
          window.prefillUserPassword();
          console.log('ğŸ”‘ LEVI UPLOAD: Global password prefill triggered');
        }, 500);
      }
      
      // Password prefill no longer needed with Supabase Auth
      // Legacy password system removed in Phase 6
      
      console.log('Case data loaded from helper:', {
        plate: helper.car_details?.plate,
        owner: helper.general_info?.owner_name,
        office_code: helper.general_info?.office_code,
        password_found: !!password
      });
      
    } catch (e) {
      console.warn('Could not load helper data, falling back to session storage:', e);
    }
    
    // Fallback: Load from session storage if helper data is not available
    const plate = sessionStorage.getItem('plate');
    const owner = sessionStorage.getItem('owner');
    const pass = sessionStorage.getItem('ycPass');
    const officeCode = sessionStorage.getItem('office_code');

    // Only use session storage if field is still empty
    if (!document.getElementById('plate').value && plate) {
      document.getElementById('plate').value = plate;
    }
    if (!document.getElementById('owner').value && owner) {
      document.getElementById('owner').value = owner;
    }
    if (!document.getElementById('pass').value && pass) {
      document.getElementById('pass').value = pass;
    }
    if (!document.getElementById('office_code').value && officeCode) {
      document.getElementById('office_code').value = officeCode;
    }
    
    // âœ… ENSURE FIELD: If office_code is still empty, leave it empty rather than default
    if (!document.getElementById('office_code').value) {
      console.log('âš ï¸ LEVI UPLOAD: No office_code found in any data source');
    }
  }

  async loadCredentials() {
    try {
      // Import credentials and display them when portal button is clicked
      const { dev_credentials } = await import('./credentials-vault.js');
      this.credentials = dev_credentials?.leviItzhak;
    } catch (e) {
      console.warn('Could not load credentials:', e);
      this.credentials = null;
    }
  }

  setupDragAndDrop() {
    const uploadArea = document.querySelector('.file-upload-area');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, this.preventDefaults, false);
      document.body.addEventListener(eventName, this.preventDefaults, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
      uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
    });

    uploadArea.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const files = dt.files;
      if (files.length > 0) {
        this.handleFileSelection(files[0]);
      }
    }, false);
  }

  preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  handleReportSourceChange(source) {
    const uploadSection = document.getElementById('upload-section');
    const manualSection = document.getElementById('manual-section');
    const saveResultsButton = document.getElementById('save-results');
    const saveManualButton = document.getElementById('save-manual');
    
    if (source === 'manual') {
      uploadSection.style.display = 'none';
      manualSection.style.display = 'block';
      this.isManualMode = true;
      // Show manual save button, hide OCR save button
      saveManualButton.style.display = 'inline-block';
      saveResultsButton.style.display = 'none';
      // Add event listeners for real-time saving
      setTimeout(() => addManualFieldListeners(), 100);
    } else {
      uploadSection.style.display = 'block';
      manualSection.style.display = 'none';
      this.isManualMode = false;
      // Hide manual save button, keep OCR save button hidden (shows after processing)
      saveManualButton.style.display = 'none';
      saveResultsButton.style.display = 'none';
    }
  }

  toggleManualMode() {
    const reportSource = document.getElementById('report-source');
    if (this.isManualMode) {
      reportSource.value = 'screenshot';
      this.handleReportSourceChange('screenshot');
    } else {
      reportSource.value = 'manual';
      this.handleReportSourceChange('manual');
    }
  }

  handleFileSelection(file) {
    if (!file) return;

    if (!this.validateFile(file)) {
      return;
    }

    this.uploadedFile = file;
    this.showPreview(file);
    this.showAlert('×§×•×‘×¥ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”', 'success');
  }

  validateFile(file) {
    if (!this.allowedTypes.includes(file.type)) {
      this.showAlert(`×¡×•×’ ×§×•×‘×¥ ×œ× × ×ª××š: ${file.name}`, 'error');
      return false;
    }

    if (file.size > this.maxFileSize) {
      this.showAlert(`×§×•×‘×¥ ×’×“×•×œ ××“×™: ${file.name} (××§×¡×™××•× 10MB)`, 'error');
      return false;
    }

    return true;
  }

  showPreview(file) {
    const previewContainer = document.getElementById('preview-container');
    const previewImage = document.getElementById('preview-image');
    
    if (file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage.src = e.target.result;
        previewImage.style.display = 'block';
        previewContainer.style.display = 'block';
      };
      reader.readAsDataURL(file);
    } else {
      previewImage.style.display = 'none';
      previewContainer.style.display = 'block';
      previewContainer.innerHTML = `
        <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
          <div style="font-size: 48px; color: #dc3545; margin-bottom: 10px;">ğŸ“Š</div>
          <div>×§×•×‘×¥ PDF × ×˜×¢×Ÿ: ${file.name}</div>
        </div>
      `;
    }
  }

  async processLevi() {
    // CRITICAL FIX: Only prevent concurrent processing, not multiple uploads per session
    if (this.processingInProgress) {
      this.showAlert('×¢×™×‘×•×“ ×‘×ª×”×œ×™×š, ×× × ×”××ª×Ÿ...', 'warning');
      return;
    }

    if (!this.isManualMode && !this.uploadedFile) {
      this.showAlert('×× × ×‘×—×¨ ×§×•×‘×¥ ×“×•"×— ×œ×•×™ ×™×¦×—×§', 'error');
      return;
    }

    if (!this.validateForm()) {
      return;
    }

    // Clear old case data when starting a new case
    const plateNumber = document.getElementById('plate').value.trim();
    const existingHelper = JSON.parse(sessionStorage.getItem('helper') || '{}');
    const existingPlate = existingHelper.meta?.plate;
    
    if (plateNumber && plateNumber !== existingPlate) {
      console.log('ğŸ”„ Starting new case for plate:', plateNumber);
      
      // Clear old case data using security manager if available
      if (window.securityManager && typeof window.securityManager.startNewCase === 'function') {
        window.securityManager.startNewCase();
      } else {
        // Fallback - clear old data manually
        localStorage.removeItem('lastCaseData');
        localStorage.removeItem('lastCaseTimestamp');
        sessionStorage.removeItem('helper');
        
        // Clear sensitive data from memory (don't create new helper)
        if (window.helper) {
          // Clear helper data without creating new object
          Object.keys(window.helper).forEach(key => {
            delete window.helper[key];
          });
        }
        
        console.log('âœ… Started new case - previous data cleared');
      }
    }

    this.processingInProgress = true;
    this.showProcessingStatus(true);
    
    try {
      let result;
      
      if (this.isManualMode) {
        result = this.processManualEntry();
      } else {
        result = await this.processFileUpload();
      }

      this.handleLeviResults(result);
      this.showAlert('âœ… ×“×•"×— ×œ×•×™ ×™×¦×—×§ ×¢×•×‘×“ ×‘×”×¦×œ×—×”', 'success');
      this.showContinueButton();
      
    } catch (error) {
      // âœ… ENHANCED ERROR LOGGING: More detailed error information
      console.error('âŒ Levi processing error:', {
        message: error.message,
        stack: error.stack,
        name: error.name,
        uploadedFile: !!this.uploadedFile,
        isManualMode: this.isManualMode,
        fieldsValues: {
          plate: document.getElementById('plate')?.value,
          owner: document.getElementById('owner')?.value,
          office_code: document.getElementById('office_code')?.value,
          pass: document.getElementById('pass')?.value ? '[HIDDEN]' : 'EMPTY'
        }
      });
      
      // CRITICAL FIX: Handle webhook/Make.com failures gracefully
      let errorMessage = 'âŒ ×©×’×™××” ×‘×¢×™×‘×•×“ ×“×•"×— ×œ×•×™ ×™×¦×—×§: ' + error.message;
      if (error.message.includes('fetch') || error.message.includes('network') || error.message.includes('Make.com')) {
        errorMessage += '\n\nğŸ”„ × ×™×ª×Ÿ ×œ× ×¡×•×ª ×©×•×‘ ××• ×œ×”×¢×œ×•×ª ×“×•"×— ××—×¨';
        // Don't block further attempts on network failures
      }
      
      this.showAlert(errorMessage, 'error');
      
      // Show retry/new upload options for network failures
      if (error.message.includes('fetch') || error.message.includes('network') || error.message.includes('Make.com')) {
        const uploadNewBtn = document.getElementById('upload-new-report');
        if (uploadNewBtn) {
          uploadNewBtn.style.display = 'inline-block';
        }
      }
    } finally {
      this.processingInProgress = false;
      this.showProcessingStatus(false);
    }
  }

  async processFileUpload() {
    // âœ… VALIDATION: Check if file was uploaded
    if (!this.uploadedFile) {
      throw new Error('×œ× × ×‘×—×¨ ×§×•×‘×¥ ×œ×¢×™×‘×•×“. ×× × ×‘×—×¨ ×§×•×‘×¥ ×“×•"×— ×œ×•×™ ×™×¦×—×§.');
    }

    // âœ… VALIDATION: Check required fields
    const requiredFields = {
      'plate': '××¡×¤×¨ ×¨×›×‘',
      'owner': '×©× ×‘×¢×œ×™×', 
      'office_code': '×§×•×“ ××©×¨×“',
      'pass': '×¡×™×¡××”'
    };

    const missingFields = [];
    for (const [fieldId, fieldName] of Object.entries(requiredFields)) {
      const value = document.getElementById(fieldId)?.value?.trim();
      if (!value) {
        missingFields.push(fieldName);
      }
    }

    if (missingFields.length > 0) {
      throw new Error(`×—×¡×¨×™× ×©×“×•×ª ×—×•×‘×”: ${missingFields.join(', ')}`);
    }

    // âœ… BUILD FORM DATA: Use individual fields like working uploads
    const formData = new FormData();
    formData.append('file', this.uploadedFile);
    
    // âœ… BASIC FIELDS: Required by webhook
    const plateValue = document.getElementById('plate').value.trim();
    const plateNumber = plateValue.replace(/[^0-9]/g, ''); // Extract only numbers
    formData.append('plate', plateNumber || '0'); // Send numbers only to webhook
    formData.append('owner', document.getElementById('owner').value.trim());
    formData.append('pass', document.getElementById('pass').value.trim());
    formData.append('office_code', document.getElementById('office_code').value.trim());
    formData.append('report_source', document.getElementById('report-source')?.value?.trim() || 'levi_upload');
    formData.append('valuation_date', document.getElementById('valuation-date')?.value?.trim() || new Date().toISOString().split('T')[0]);
    
    // âœ… CAR DETAILS: Pull from helper system for webhook
    try {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      const vehicle = helper.vehicle || {};
      const carDetails = helper.car_details || {};
      const meta = helper.meta || {};
      
      // Add car details that webhook expects
      formData.append('manufacturer', vehicle.manufacturer || carDetails.manufacturer || '');
      formData.append('model', vehicle.model || carDetails.model || '');
      formData.append('year', vehicle.year || carDetails.year || '');
      formData.append('chassis', vehicle.chassis || carDetails.chassis || '');
      formData.append('km', vehicle.km || carDetails.km || carDetails.odo || '');
      formData.append('fuel_type', vehicle.fuel_type || carDetails.fuel_type || '');
      formData.append('engine_volume', vehicle.engine_volume || carDetails.engine_volume || '');
      formData.append('ownership_type', carDetails.ownership_type || '');
      formData.append('location', meta.location || meta.inspection_location || '');
      
      console.log('ğŸš— Car details loaded from helper:', {
        manufacturer: vehicle.manufacturer || carDetails.manufacturer,
        model: vehicle.model || carDetails.model,
        year: vehicle.year || carDetails.year,
        km: vehicle.km || carDetails.km || carDetails.odo
      });
    } catch (error) {
      console.warn('Could not load car details for Levi upload:', error);
    }
    
    formData.append('action', 'SUBMIT_LEVI_REPORT');
    formData.append('timestamp', new Date().toISOString());
    
    console.log('ğŸ“¤ Sending Levi report with fields:', {
      plate: document.getElementById('plate').value.trim(),
      owner: document.getElementById('owner').value.trim(),
      office_code: document.getElementById('office_code').value.trim(),
      password: '[HIDDEN]',
      report_source: document.getElementById('report-source')?.value?.trim() || 'levi_upload',
      valuation_date: document.getElementById('valuation-date')?.value?.trim() || new Date().toISOString().split('T')[0]
    });
    console.log('ğŸ¢ ×§×•×“ ××©×¨×“ ×”×ª×—×‘×•×¨×” being sent:', document.getElementById('office_code').value.trim());
    console.log('ğŸ“ File:', this.uploadedFile.name, 'Size:', this.uploadedFile.size);
    console.log('ğŸ”— Webhook URL:', getWebhook('SUBMIT_LEVI_REPORT'));

    // âœ… FIXED: Use sendToWebhook instead of direct fetch
    try {
      const result = await sendToWebhook('SUBMIT_LEVI_REPORT', formData);
      
      console.log('âœ… Levi upload webhook response:', result);
      
      // Handle the response based on type
      if (typeof result === 'string') {
        // Convert text response to structured data
        return {
          success: true,
          data: result,
          parsed_data: this.parseLeviTextResponse(result),
          timestamp: new Date().toISOString()
        };
      } else if (result && typeof result === 'object') {
        // Already structured response
        return result;
      } else {
        throw new Error('×ª×’×•×‘×” ×œ× ×ª×§×™× ×” ××”×©×¨×ª');
      }
      
    } catch (error) {
      console.error('âŒ Levi upload failed:', error);
      
      // Re-throw with Hebrew error message
      if (error.message.includes('HTTP')) {
        throw new Error('×©×’×™××ª ×©×¨×ª ×‘×¢×™×‘×•×“ ×“×•"×— ×œ×•×™ ×™×¦×—×§');
      } else {
        throw error;
      }
    }
  }

  // âœ… PARSE HEBREW TEXT RESPONSE: Convert Levi text to structured data
  parseLeviTextResponse(textData) {
    const parsed = {
      vehicle_info: {},
      price_adjustments: {},
      final_values: {}
    };
    
    try {
      const lines = textData.split('\n').map(line => line.trim()).filter(line => line);
      
      for (const line of lines) {
        if (line.includes('\t')) {
          const [key, value] = line.split('\t').map(part => part.trim());
          
          // Map Hebrew keys to structured data
          switch (key) {
            case '×ª××¨×™×š':
              parsed.vehicle_info.date = value;
              break;
            case '×¡×•×’ ×¨×›×‘':
              parsed.vehicle_info.vehicle_type = value;
              break;
            case '×™×¦×¨×Ÿ':
              parsed.vehicle_info.manufacturer = value;
              break;
            case '×§×•×“ ×“×’×':
              parsed.vehicle_info.model_code = value;
              break;
            case '×§×˜×’×•×¨×™×”':
              parsed.vehicle_info.category = value;
              break;
            case '××¡×¤×¨ ×¨×™×©×•×™':
              parsed.vehicle_info.plate = value;
              break;
            case '×©× ×ª ×™×¦×•×¨':
              parsed.vehicle_info.year = value;
              break;
            case '×©× ×“×’× ××œ×':
              parsed.vehicle_info.full_model_name = value;
              break;
            case '××—×™×¨ ×‘×¡×™×¡':
              parsed.vehicle_info.base_price = value;
              break;
            case '××—×™×¨ ×¡×•×¤×™ ×œ×¨×›×‘':
              parsed.final_values.final_price = value;
              break;
            case '×©×•×•×™ ××¦×˜×‘×¨ ×¢×œ×™×” ×œ×›×‘×™×©':
              parsed.price_adjustments.registration_total = value;
              break;
            case '×©×•×•×™ ××¦×˜×‘×¨ ×‘×¢×œ×•×ª':
              parsed.price_adjustments.ownership_total = value;
              break;
            case '×©×•×•×™ ××¦×˜×‘×¨ ××¡ ×§"×':
              parsed.price_adjustments.mileage_total = value;
              break;
            case '×©×•×•×™ ××¦×˜×‘×¨ ××¡×¤×¨ ×‘×¢×œ×™×':
              parsed.price_adjustments.owners_total = value;
              break;
            case '×©×•×•×™ ××¦×˜×‘×¨  ×××¤×™×™× ×™×':
              parsed.price_adjustments.features_total = value;
              break;
          }
        }
      }
      
      console.log('âœ… Parsed Levi text data:', parsed);
      return parsed;
      
    } catch (error) {
      console.warn('Could not parse Levi text response:', error);
      return { raw_data: textData };
    }
  }

  processManualEntry() {
    // Process manual entry data according to exact JSON structure
    const manualData = {
      // Basic vehicle information
      '×¡×•×’ ×¨×›×‘': document.getElementById('manual-vehicle-type').value,
      '×™×¦×¨×Ÿ': document.getElementById('manual-manufacturer').value,
      '×§×•×“ ×“×’×': document.getElementById('manual-model-code').value,
      '×§×˜×’×•×¨×™×”': document.getElementById('manual-category').value,
      '×©× ×ª ×™×¦×•×¨': document.getElementById('manual-year').value,
      '×©× ×“×’× ××œ×': document.getElementById('manual-full-model').value,
      '××—×™×¨ ×‘×¡×™×¡': document.getElementById('manual-base-price').value,
      '××—×™×¨ ×¡×•×¤×™ ×œ×¨×›×‘': document.getElementById('manual-final-price').value,

      // Price adjustments - Registration
      '×¢×œ×™×” ×œ×›×‘×™×©': document.getElementById('manual-registration').value,
      '×¢×œ×™×” ×œ×›×‘×™×© %': document.getElementById('manual-registration-percent').value,
      '×¢×¨×š ×©×´×— ×¢×œ×™×” ×œ×›×‘×™×©': document.getElementById('manual-registration-value').value,
      '×©×•×•×™ ××¦×˜×‘×¨ ×¢×œ×™×” ×œ×›×‘×™×©': document.getElementById('manual-registration-total').value,

      // Price adjustments - Ownership
      '×‘×¢×œ×•×ª': document.getElementById('manual-ownership').value,
      '×‘×¢×œ×•×ª %': document.getElementById('manual-ownership-percent').value,
      '×¢×¨×š ×©×´×— ×‘×¢×œ×•×ª': document.getElementById('manual-ownership-value').value,
      '×©×•×•×™ ××¦×˜×‘×¨ ×‘×¢×œ×•×ª': document.getElementById('manual-ownership-total').value,

      // Price adjustments - KM
      '××¡ ×§×´×': document.getElementById('manual-km').value,
      '××¡ ×§×´× %': document.getElementById('manual-km-percent').value,
      '×¢×¨×š ×©×´×— ××¡ ×§×´×': document.getElementById('manual-km-value').value,
      '×©×•×•×™ ××¦×˜×‘×¨ ××¡ ×§×´×': document.getElementById('manual-km-total').value,

      // Price adjustments - Owners
      '××¡×¤×¨ ×‘×¢×œ×™×': document.getElementById('manual-owners').value,
      '××¡×¤×¨ ×‘×¢×œ×™× %': document.getElementById('manual-owners-percent').value,
      '×¢×¨×š ×©×´×— ××¡×¤×¨ ×‘×¢×œ×™×': document.getElementById('manual-owners-value').value,
      '×©×•×•×™ ××¦×˜×‘×¨ ××¡×¤×¨ ×‘×¢×œ×™×': document.getElementById('manual-owners-total').value,

      // Price adjustments - Features
      '×××¤×™×™× ×™×': document.getElementById('manual-features').value,
      '×××¤×™×™× ×™× %': document.getElementById('manual-features-percent').value,
      '×¢×¨×š ×©×´×— ×××¤×™×™× ×™×': document.getElementById('manual-features-value').value,
      '×©×•×•×™ ××¦×˜×‘×¨ ×××¤×™×™× ×™×': document.getElementById('manual-features-total').value,

      // Meta information
      plate: document.getElementById('plate').value,
      owner: document.getElementById('owner').value,
      office_code: document.getElementById('office_code').value,
      valuation_date: document.getElementById('valuation-date').value,
      source: 'manual_entry',
      processed_at: new Date().toISOString()
    };

    return manualData;
  }

  validateForm() {
    // âœ… FIXED: Include office_code as required field
    const required = ['plate', 'owner', 'pass', 'office_code'];
    for (const fieldId of required) {
      const field = document.getElementById(fieldId);
      if (!field.value.trim()) {
        this.showAlert(`×©×“×” ×—×•×‘×”: ${field.previousElementSibling.textContent}`, 'error');
        field.focus();
        return false;
      }
    }

    if (this.isManualMode) {
      const manualRequired = ['manual-model', 'manual-year', 'manual-base-price'];
      for (const fieldId of manualRequired) {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
          this.showAlert(`×©×“×” ×—×•×‘×” ×‘×”×–× ×” ×™×“× ×™×ª: ${field.previousElementSibling.textContent}`, 'error');
          field.focus();
          return false;
        }
      }
    }

    return true;
  }

  handleLeviResults(result) {
    this.leviResults = result;
    this.displayLeviResults(result);
    this.showValidationStatus(result);
    
    // Update helper with Levi results
    this.updateHelperWithResults(result);
    
    // Show save button
    document.getElementById('save-results').style.display = 'inline-block';
  }

  displayLeviResults(result) {
    const ocrContainer = document.getElementById('ocr-results');
    ocrContainer.classList.add('show');

    // Vehicle Details - Updated to match new OCR JSON structure
    const vehicleDetails = document.getElementById('vehicle-details');
    vehicleDetails.innerHTML = `
      <div class="data-item">
        <span class="data-label">×¡×•×’ ×¨×›×‘:</span>
        <span class="data-value">${result['×¡×•×’ ×¨×›×‘'] || result.vehicle_details?.vehicle_type || '×œ× ×–××™×Ÿ'}</span>
      </div>
      <div class="data-item">
        <span class="data-label">×™×¦×¨×Ÿ:</span>
        <span class="data-value">${result['×™×¦×¨×Ÿ'] || result.vehicle_details?.manufacturer || '×œ× ×–××™×Ÿ'}</span>
      </div>
      <div class="data-item">
        <span class="data-label">×§×•×“ ×“×’×:</span>
        <span class="data-value">${result['×§×•×“ ×“×’×'] || result.vehicle_details?.model_code || '×œ× ×–××™×Ÿ'}</span>
      </div>
      <div class="data-item">
        <span class="data-label">×§×˜×’×•×¨×™×”:</span>
        <span class="data-value">${result['×§×˜×’×•×¨×™×”'] || result.vehicle_details?.category || '×œ× ×–××™×Ÿ'}</span>
      </div>
      <div class="data-item">
        <span class="data-label">×©× ×ª ×™×¦×•×¨:</span>
        <span class="data-value">${result['×©× ×ª ×™×¦×•×¨'] || result.vehicle_details?.year || '×œ× ×–××™×Ÿ'}</span>
      </div>
      <div class="data-item">
        <span class="data-label">×©× ×“×’× ××œ×:</span>
        <span class="data-value">${result['×©× ×“×’× ××œ×'] || result.vehicle_details?.full_model || '×œ× ×–××™×Ÿ'}</span>
      </div>
    `;

    // Valuation Details
    const valuationDetails = document.getElementById('valuation-details');
    valuationDetails.innerHTML = `
      <div class="data-item">
        <span class="data-label">×ª××¨×™×š ×”×¢×¨×›×”:</span>
        <span class="data-value">${result['×ª××¨×™×š'] || result.valuation_date || new Date().toLocaleDateString('he-IL')}</span>
      </div>
      <div class="data-item">
        <span class="data-label">×§×•×“ ××©×¨×“ ×”×ª×—×‘×•×¨×”:</span>
        <span class="data-value">${this.getOfficeCode(result)}</span>
      </div>
      <div class="data-item">
        <span class="data-label">××§×•×¨ ×”×“×•"×—:</span>
        <span class="data-value">${this.getSourceLabel(result.source || result.report_source || document.getElementById('report-source')?.value)}</span>
      </div>
    `;

    // Pricing Details - Updated to match new OCR structure
    const pricingDetails = document.getElementById('pricing-details');
    
    // Helper function to parse Hebrew currency format "â‚ª 118,000" to number
    const parseCurrency = (value) => {
      if (!value) return 0;
      if (typeof value === 'number') return value;
      // Remove currency symbols, spaces, commas and parse
      const cleanValue = value.toString().replace(/[â‚ª,\s]/g, '');
      return parseFloat(cleanValue) || 0;
    };
    
    const basePrice = parseCurrency(result['××—×™×¨ ×‘×¡×™×¡']) || parseCurrency(result.pricing?.base_price) || 0;
    const finalPrice = parseCurrency(result['××—×™×¨ ×¡×•×¤×™ ×œ×¨×›×‘']) || parseCurrency(result.pricing?.final_price) || 0;
    pricingDetails.innerHTML = `
      <div class="data-item">
        <span class="data-label">××—×™×¨ ×‘×¡×™×¡:</span>
        <span class="data-value">â‚ª${basePrice.toLocaleString()}</span>
      </div>
      <div class="data-item">
        <span class="data-label">××—×™×¨ ×¡×•×¤×™ ×œ×¨×›×‘:</span>
        <span class="data-value"><strong>â‚ª${finalPrice.toLocaleString()}</strong></span>
      </div>
      <div class="data-item">
        <span class="data-label">×”×¤×¨×©:</span>
        <span class="data-value">â‚ª${(finalPrice - basePrice).toLocaleString()}</span>
      </div>
    `;

    // Adjustments Table - pass the full result object to access Hebrew fields
    this.displayAdjustments(result);

    // Update manual override fields
    document.getElementById('override-base-price').value = result.pricing?.base_price || '';
    document.getElementById('override-final-price').value = result.pricing?.final_price || '';
  }

  displayAdjustments(result) {
    const adjustmentsContainer = document.getElementById('adjustments-container');
    adjustmentsContainer.innerHTML = '';

    // Add table headers
    const headerRow = document.createElement('div');
    headerRow.className = 'adjustment-header-row';
    headerRow.innerHTML = `
      <span class="adjustment-header">×”×ª×××ª ××—×™×¨</span>
      <span class="adjustment-header">×¢×¨×š</span>
      <span class="adjustment-header">××—×•×– %</span>
      <span class="adjustment-header">×¡×›×•× ×©×´×—</span>
      <span class="adjustment-header">×¡×›×•× ××¦×˜×‘×¨</span>
    `;
    adjustmentsContainer.appendChild(headerRow);

    // REORDERED: Define adjustment structure to match floating screen order
    // ORDER: ×××¤×™×™× ×™× â†’ ×¢×œ×™×” ×œ×›×‘×™×© â†’ ×¡×•×’ ×‘×¢×œ×•×ª â†’ ××¡×¤×¨ ×§×´× â†’ ××¡×¤×¨ ×‘×¢×œ×™×
    const adjustmentSections = [
      {
        title: '×××¤×™×™× ×™×',
        fields: ['×¢×¨×š ×××¤×™×™× ×™×', '××—×™×¨ ×××¤×™×™× ×™× %', '×¢×¨×š ×©"×— ×××¤×™×™× ×™×', '×©×•×•×™ ××¦×˜×‘×¨ ×××¤×™×™× ×™×']
      },
      {
        title: '×¢×œ×™×” ×œ×›×‘×™×©',
        fields: ['×¢×¨×š ×¢×œ×™×” ×œ×›×‘×™×©', '×¢×œ×™×” ×œ×›×‘×™×© %', '×¢×¨×š ×©"×— ×¢×œ×™×” ×œ×›×‘×™×©', '×©×•×•×™ ××¦×˜×‘×¨ ×¢×œ×™×” ×œ×›×‘×™×©']
      },
      {
        title: '×¡×•×’ ×‘×¢×œ×•×ª',
        fields: ['×¢×¨×š ×‘×¢×œ×•×ª', '×‘×¢×œ×•×ª %', '×¢×¨×š ×©"×— ×‘×¢×œ×•×ª', '×©×•×•×™ ××¦×˜×‘×¨ ×‘×¢×œ×•×ª']
      },
      {
        title: '××¡×¤×¨ ×§×´×',
        fields: ['×¢×¨×š ××¡ ×§"×', '××¡ ×§"× %', '×¢×¨×š ×©"×— ××¡ ×§"×', '×©×•×•×™ ××¦×˜×‘×¨ ××¡ ×§"×']
      },
      {
        title: '××¡×¤×¨ ×‘×¢×œ×™×',
        fields: ['×¢×¨×š ××¡×¤×¨ ×‘×¢×œ×™×', '××¡×¤×¨ ×‘×¢×œ×™× %', '×¢×¨×š ×©"×— ××¡×¤×¨ ×‘×¢×œ×™×', '×©×•×•×™ ××¦×˜×‘×¨ ××¡×¤×¨ ×‘×¢×œ×™×']
      }
    ];

    adjustmentSections.forEach(section => {
      const adjustmentRow = document.createElement('div');
      adjustmentRow.className = 'adjustment-row';
      
      // First column: title
      const titleSpan = document.createElement('span');
      titleSpan.className = 'adjustment-title';
      titleSpan.textContent = section.title + ':';
      adjustmentRow.appendChild(titleSpan);
      
      // Following columns: field values
      section.fields.forEach(fieldKey => {
        // Get value directly from Hebrew webhook fields in result object
        let value = result[fieldKey] || '';
        
        // Format currency values if they contain â‚ª
        if (value && value.toString().includes('â‚ª')) {
          const numericValue = value.toString().replace(/[â‚ª,\s]/g, '');
          const parsed = parseFloat(numericValue);
          if (!isNaN(parsed)) {
            value = `â‚ª${parsed.toLocaleString()}`;
          }
        }
        
        const valueSpan = document.createElement('span');
        valueSpan.className = 'adjustment-value';
        valueSpan.textContent = value || '-';
        adjustmentRow.appendChild(valueSpan);
      });
      
      adjustmentsContainer.appendChild(adjustmentRow);
    });

    if (adjustmentsContainer.children.length === 0) {
      adjustmentsContainer.innerHTML = '<p style="text-align: center; color: #7f8c8d;">××™×Ÿ × ×ª×•× ×™ ×”×ª×××•×ª ×–××™× ×™×</p>';
    }
  }

  getSourceLabel(source) {
    const sourceLabels = {
      'screenshot': '×¦×™×œ×•× ××¡×š ××ª××—×‘×¨',
      'pdf': '×§×•×‘×¥ PDF',
      'manual': '×”×–× ×” ×™×“× ×™×ª',
      'manual_entry': '×”×–× ×” ×™×“× ×™×ª'
    };
    return sourceLabels[source] || source || '×œ× ×–××™×Ÿ';
  }

  getOfficeCode(result) {
    // Try to get office code from multiple sources
    
    // 1. Check result object directly
    if (result.office_code) return result.office_code;
    if (result['×§×•×“ ××©×¨×“ ×”×ª×—×‘×•×¨×”']) return result['×§×•×“ ××©×¨×“ ×”×ª×—×‘×•×¨×”'];
    if (result['×§×•×“ ××©×¨×“']) return result['×§×•×“ ××©×¨×“'];
    if (result.vehicle && result.vehicle.office_code) return result.vehicle.office_code;
    
    // 2. Check sessionStorage helper data
    try {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      if (helper.vehicle && helper.vehicle.office_code) return helper.vehicle.office_code;
      if (helper['×§×•×“ ××©×¨×“ ×”×ª×—×‘×•×¨×”']) return helper['×§×•×“ ××©×¨×“ ×”×ª×—×‘×•×¨×”'];
      if (helper['×§×•×“ ××©×¨×“']) return helper['×§×•×“ ××©×¨×“'];
      if (helper.meta && helper.meta.office_code) return helper.meta.office_code;
      
      // Check car details
      if (helper.car_details && helper.car_details.office_code) return helper.car_details.office_code;
      if (helper.car_details && helper.car_details['×§×•×“ ××©×¨×“ ×”×ª×—×‘×•×¨×”']) return helper.car_details['×§×•×“ ××©×¨×“ ×”×ª×—×‘×•×¨×”'];
    } catch (e) {
      console.warn('Could not parse helper data for office code:', e);
    }
    
    // 3. Check form input as fallback
    const formOfficeCode = document.getElementById('office-code')?.value;
    if (formOfficeCode && formOfficeCode.trim()) return formOfficeCode.trim();
    
    return '×œ× ×–××™×Ÿ';
  }

  updatePrices() {
    const basePrice = parseFloat(document.getElementById('override-base-price').value) || 0;
    const finalPrice = parseFloat(document.getElementById('override-final-price').value) || 0;

    if (basePrice <= 0 || finalPrice <= 0) {
      this.showAlert('×× × ×”×›× ×¡ ××—×™×¨×™× ×ª×§×™× ×™×', 'error');
      return;
    }

    // Update internal results
    this.leviResults.pricing = {
      ...this.leviResults.pricing,
      base_price: basePrice,
      final_price: finalPrice
    };

    // Recalculate and display
    this.displayLeviResults(this.leviResults);
    this.showAlert('××—×™×¨×™× ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”', 'success');
  }

  showValidationStatus(result) {
    const statusContainer = document.getElementById('validation-status');
    let statusType = 'success';
    let message = 'âœ… ×“×•"×— ×œ×•×™ ×™×¦×—×§ ×¢×•×‘×“ ×‘×”×¦×œ×—×”';
    
    if (result.warnings && result.warnings.length > 0) {
      statusType = 'warning';
      message = 'âš ï¸ ×“×•"×— ×¢×•×‘×“ ×¢× ××–×”×¨×•×ª: ' + result.warnings.join(', ');
    }
    
    if (result.errors && result.errors.length > 0) {
      statusType = 'error';
      message = 'âŒ ×©×’×™××•×ª ×‘×¢×™×‘×•×“: ' + result.errors.join(', ');
    }
    
    statusContainer.className = `validation-status ${statusType} show`;
    statusContainer.textContent = message;
    
    // Hide after 5 seconds
    setTimeout(() => {
      statusContainer.classList.remove('show');
    }, 5000);
  }

  async saveResults() {
    if (!this.leviResults || Object.keys(this.leviResults).length === 0) {
      this.showAlert('××™×Ÿ ×ª×•×¦××•×ª ×œ×©××™×¨×”', 'warning');
      return;
    }
    
    try {
      const resultData = {
        ...this.leviResults,
        updated_at: new Date().toISOString()
      };
      
      // Save to helper system
      this.updateHelperWithResults(resultData);
      
      // Send to webhook for processing
      await sendToWebhook('SAVE_LEVI_RESULTS', resultData);
      
      this.showAlert('âœ… ×ª×•×¦××•×ª × ×©××¨×• ×‘×”×¦×œ×—×”', 'success');
      
    } catch (error) {
      console.error('Save error:', error);
      this.showAlert('âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”×ª×•×¦××•×ª', 'error');
    }
  }

  async saveManualData() {
    try {
      // Get manual data from helper system
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      if (!helper.expertise || !helper.expertise.levi_report) {
        this.showAlert('××™×Ÿ × ×ª×•× ×™× ×™×“× ×™×™× ×œ×©××™×¨×”', 'warning');
        return;
      }
      
      const manualData = {
        ...helper.expertise.levi_report,
        updated_at: new Date().toISOString(),
        source: 'manual'
      };
      
      // Don't call updateHelperWithResults - it corrupts manual data!
      // Manual data is already properly saved by saveManualDataToHelper()
      
      // Send to webhook for manual data processing (different webhook than OCR)
      await sendToWebhook('SAVE_MANUAL_LEVI', manualData);
      
      this.showAlert('âœ… × ×ª×•× ×™× ×™×“× ×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”', 'success');
      
      // Refresh floating screen after save
      if (typeof refreshLeviData === 'function') {
        refreshLeviData();
      }
      
    } catch (error) {
      console.error('Manual save error:', error);
      this.showAlert('âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”× ×ª×•× ×™× ×”×™×“× ×™×™×', 'error');
    }
  }


  updateHelperWithResults(result) {
    try {
      console.log('ğŸ”„ updateHelperWithResults: Starting with result:', result);
      console.log('ğŸ”„ updateHelperWithResults: updateHelper function exists?', typeof updateHelper);
      
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      console.log('ğŸ“Š Current helper before Levi update:', helper);
      
      // ğŸš¨ CRITICAL FIX: Update levi summary data using Hebrew webhook fields (EXACT same data as upload page)
      helper.levisummary = {
        model_code: result['×§×•×“ ×“×’×'] || '',
        full_model: result['×©× ×“×’× ××œ×'] || '',
        is_automatic: result['××•×˜×•××˜'] === '×›×Ÿ' || false,
        features: result['×××¤×™×™× ×™×'] || '', // The FULL features description
        report_date: result['×ª××¨×™×š'] || new Date().toISOString().split('T')[0],
        registration_date: result['×¢×¨×š ×¢×œ×™×” ×œ×›×‘×™×©'] || '', // "11/2022"
        owner_count: result['×¢×¨×š ××¡×¤×¨ ×‘×¢×œ×™×'] || '', // "02 (××¡' ××—×•×–×™×: 2)"
        category: result['×§×˜×’×•×¨×™×”'] || '',
        km: result['×¢×¨×š ××¡ ×§×´×'] || '', // "×§"× 137719 (×§"× + 18700), ××¡ ×§"×: 1.1"
        base_price: result['××—×™×¨ ×‘×¡×™×¡'] || 0,
        final_price: result['××—×™×¨ ×¡×•×¤×™ ×œ×¨×›×‘'] || 0,
        
        // Store adjustment data EXACTLY as upload page shows it
        adjustments: {
          features: {
            description: result['×¢×¨×š ×××¤×™×™× ×™×'] || '', // "adventure"
            percent: result['××—×™×¨ ×××¤×™×™× ×™× %'] || '0%', // "9%"
            amount: result['×¢×¨×š ×©×´×— ×××¤×™×™× ×™×'] || 'â‚ª0', // "â‚ª 10,620"
            cumulative: result['×©×•×•×™ ××¦×˜×‘×¨ ×××¤×™×™× ×™×'] || 'â‚ª0' // "â‚ª 128,620"
          },
          registration: {
            description: result['×¢×¨×š ×¢×œ×™×” ×œ×›×‘×™×©'] || '', // "11/2022"
            percent: result['×¢×œ×™×” ×œ×›×‘×™×© %'] || '0%', // "0"
            amount: result['×¢×¨×š ×©×´×— ×¢×œ×™×” ×œ×›×‘×™×©'] || 'â‚ª0', // "â‚ª 4,000"
            cumulative: result['×©×•×•×™ ××¦×˜×‘×¨ ×¢×œ×™×” ×œ×›×‘×™×©'] || 'â‚ª0' // "â‚ª 132,620"
          },
          ownership_type: {
            description: result['×¢×¨×š ×‘×¢×œ×•×ª'] || '', // "×—×‘×¨×”, ×¢××•×ª×•×ª ×•××’×•×“×•×ª ×©×™×ª×•×¤×™×•×ª ×œ××™× ×™×”×Ÿ ××• ×œ×©×¢×‘×¨"
            percent: result['×‘×¢×œ×•×ª %'] || '0%', // "-17%"
            amount: result['×¢×¨×š ×©×´×— ×‘×¢×œ×•×ª'] || 'â‚ª0', // "â‚ª -22,545"
            cumulative: result['×©×•×•×™ ××¦×˜×‘×¨ ×‘×¢×œ×•×ª'] || 'â‚ª0' // "â‚ª 110,075"
          },
          mileage: {
            description: result['×¢×¨×š ××¡ ×§×´×'] || '', // "×§"× 137719 (×§"× + 18700), ××¡ ×§"×: 1.1"
            percent: result['××¡ ×§×´× %'] || '0%', // "-26.88%"
            amount: result['×¢×¨×š ×©×´×— ××¡ ×§×´×'] || 'â‚ª0', // "â‚ª -29,588"
            cumulative: result['×©×•×•×™ ××¦×˜×‘×¨ ××¡ ×§×´×'] || 'â‚ª0' // "â‚ª 80,487"
          },
          ownership_history: {
            description: result['×¢×¨×š ××¡×¤×¨ ×‘×¢×œ×™×'] || '', // "02 (××¡' ××—×•×–×™×: 2)"
            percent: result['××¡×¤×¨ ×‘×¢×œ×™× %'] || '0%', // "-2%"
            amount: result['×¢×¨×š ×©×´×— ××¡×¤×¨ ×‘×¢×œ×™×'] || 'â‚ª0', // "â‚ª -1,610"
            cumulative: result['×©×•×•×™ ××¦×˜×‘×¨ ××¡×¤×¨ ×‘×¢×œ×™×'] || 'â‚ª0' // "â‚ª 78,877"
          }
        }
      };
      
      console.log('âœ… FIXED: leviSummary populated with exact webhook data:', helper.levisummary);

      // ğŸš¨ CRITICAL FIX: Also populate helper.valuation.adjustments for FLOATING PAGE
      if (!helper.valuation) helper.valuation = {};
      
      // Update base pricing for valuation
      helper.valuation.base_price = result['××—×™×¨ ×‘×¡×™×¡'] || 0;
      helper.valuation.final_price = result['××—×™×¨ ×¡×•×¤×™ ×œ×¨×›×‘'] || 0;
      helper.valuation.levi_code = result['×§×•×“ ×“×’×'] || '';
      helper.valuation.levi_report_date = result['×ª××¨×™×š'] || new Date().toISOString().split('T')[0];
      
      // Create adjustments structure with CORRECT webhook field mapping (for floating page)
      helper.valuation.adjustments = {
        features: {
          description: '×××¤×™×™× ×™×', // Category name
          value: result['×¢×¨×š ×××¤×™×™× ×™×'] || '', // Short feature value (e.g., "adventure")
          percent: result['××—×™×¨ ×××¤×™×™× ×™× %'] || '0%',
          amount: result['×¢×¨×š ×©×´×— ×××¤×™×™× ×™×'] || 'â‚ª0',
          cumulative: result['×©×•×•×™ ××¦×˜×‘×¨ ×××¤×™×™× ×™×'] || 'â‚ª0',
          '×ª×™××•×¨ ×××¤×™×™× ×™×': result['×××¤×™×™× ×™×'] || '' // Full features description from webhook beginning
        },
        registration: {
          description: '×¢×œ×™×” ×œ×›×‘×™×©', // Category name
          value: result['×¢×¨×š ×¢×œ×™×” ×œ×›×‘×™×©'] || '', // Actual registration value (e.g., "11/2022")
          percent: result['×¢×œ×™×” ×œ×›×‘×™×© %'] || '0%',
          amount: result['×¢×¨×š ×©×´×— ×¢×œ×™×” ×œ×›×‘×™×©'] || 'â‚ª0',
          cumulative: result['×©×•×•×™ ××¦×˜×‘×¨ ×¢×œ×™×” ×œ×›×‘×™×©'] || 'â‚ª0'
        },
        ownership_type: {
          description: '×‘×¢×œ×•×ª', // Category name
          value: result['×¢×¨×š ×‘×¢×œ×•×ª'] || '', // Actual ownership type value
          percent: result['×‘×¢×œ×•×ª %'] || '0%',
          amount: result['×¢×¨×š ×©×´×— ×‘×¢×œ×•×ª'] || 'â‚ª0',
          cumulative: result['×©×•×•×™ ××¦×˜×‘×¨ ×‘×¢×œ×•×ª'] || 'â‚ª0'
        },
        mileage: {
          description: '××¡ ×§×´×', // Category name
          value: result['×¢×¨×š ××¡ ×§×´×'] || '', // Actual mileage value
          percent: result['××¡ ×§×´× %'] || '0%',
          amount: result['×¢×¨×š ×©×´×— ××¡ ×§×´×'] || 'â‚ª0',
          cumulative: result['×©×•×•×™ ××¦×˜×‘×¨ ××¡ ×§×´×'] || 'â‚ª0'
        },
        ownership_history: {
          description: '××¡×¤×¨ ×‘×¢×œ×™×', // Category name
          value: result['×¢×¨×š ××¡×¤×¨ ×‘×¢×œ×™×'] || '', // Actual ownership history value
          percent: result['××¡×¤×¨ ×‘×¢×œ×™× %'] || '0%',
          amount: result['×¢×¨×š ×©×´×— ××¡×¤×¨ ×‘×¢×œ×™×'] || 'â‚ª0',
          cumulative: result['×©×•×•×™ ××¦×˜×‘×¨ ××¡×¤×¨ ×‘×¢×œ×™×'] || 'â‚ª0'
        }
      };
      
      console.log('âœ… FIXED: helper.valuation.adjustments populated for floating page:', helper.valuation.adjustments);

      // Update expertise section
      if (!helper.expertise) helper.expertise = {};
      helper.expertise.levi_report = {
        ...helper.levisummary,
        processed_at: new Date().toISOString(),
        source: result.source || result.report_source || 'unknown'
      };
      
      // Calculate GROSS MARKET VALUE for damage calculations (base + features + registration ONLY)
      const basePrice = parseFloat(result.pricing?.base_price || result['××—×™×¨ ×‘×¡×™×¡'] || 0);
      const featuresValue = parseFloat(result.adjustments?.features?.value || 
                                     result['×¢×¨×š ×©×´×— ×××¤×™×™× ×™×'] || 0);
      const registrationValue = parseFloat(result.adjustments?.registration?.value || 
                                          result['×¢×¨×š ×©×´×— ×¢×œ×™×” ×œ×›×‘×™×©'] || 0);
      
      const grossMarketValue = basePrice + featuresValue + registrationValue;
      
      // Update calculations section
      if (!helper.calculations) helper.calculations = {};
      helper.calculations.vehicle_value_gross = Math.round(grossMarketValue);
      helper.calculations.market_value = Math.round(parseFloat(result.pricing?.final_price || result['××—×™×¨ ×¡×•×¤×™ ×œ×¨×›×‘'] || 0));
      
      console.log(`ğŸ’° OCR Calculated market values:
        - Gross Market Value (base+features+registration): â‚ª${Math.round(grossMarketValue).toLocaleString()}
        - Full Market Value (all adjustments): â‚ª${helper.calculations.market_value.toLocaleString()}`);
      
      // FOLLOW HELPER STRUCTURE: Store webhook data in helper.valuation (single source)
      // The helper catches data from outside in its specific fields
      console.log('ğŸ”„ Storing Levi data in helper.valuation structure...');
      
      // Update meta information
      helper.meta = helper.meta || {};
      helper.meta.last_levi_processed = new Date().toISOString();
      helper.meta.levi_report_available = true;
      
      // Update session storage
      sessionStorage.setItem('helper', JSON.stringify(helper));
      console.log('ğŸ’¾ Updated sessionStorage with Levi data');
      
      // Update via helper system (update each section individually)
      console.log('ğŸ”„ Calling updateHelper for levisummary:', helper.levisummary);
      window.updateHelper('levisummary', helper.levisummary, 'levi_ocr');
      
      console.log('ğŸ”„ Calling updateHelper for expertise:', helper.expertise);
      window.updateHelper('expertise', helper.expertise, 'levi_ocr');
      
      console.log('ğŸ”„ Calling updateHelper for calculations:', helper.calculations);
      window.updateHelper('calculations', helper.calculations, 'levi_ocr');
      
      console.log('ğŸ”„ Calling updateHelper for meta:', helper.meta);
      window.updateHelper('meta', helper.meta, 'levi_ocr');
      
      console.log('âœ… All updateHelper calls completed for Levi OCR data');
      
    } catch (e) {
      console.warn('Could not update helper with Levi results:', e);
    }
  }

  showProcessingStatus(show) {
    const statusElement = document.getElementById('processing-status');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    
    if (show) {
      statusElement.classList.add('show');
      
      // Simulate progress
      let progress = 0;
      const interval = setInterval(() => {
        progress += 12;
        progressFill.style.width = `${Math.min(progress, 90)}%`;
        
        if (progress >= 25 && progress < 50) {
          progressText.textContent = '××¢×‘×“ OCR...';
        } else if (progress >= 50 && progress < 75) {
          progressText.textContent = '×× ×ª×— × ×ª×•× ×™ ×”×¢×¨×›×”...';
        } else if (progress >= 75 && progress < 90) {
          progressText.textContent = '××—×©×‘ ×”×ª×××•×ª ××—×™×¨...';
        }
        
        if (progress >= 90) {
          clearInterval(interval);
          progressText.textContent = '××©×œ×™× ×¢×™×‘×•×“...';
        }
      }, 400);
      
      // Store interval reference for cleanup
      this.progressInterval = interval;
    } else {
      statusElement.classList.remove('show');
      progressFill.style.width = '0%';
      progressText.textContent = '×× × ×”××ª×Ÿ...';
      
      if (this.progressInterval) {
        clearInterval(this.progressInterval);
      }
    }
  }

  clearResults() {
    // Clear results display
    const resultsSection = document.getElementById('levi-results');
    if (resultsSection) {
      resultsSection.style.display = 'none';
      resultsSection.innerHTML = '';
    }
    
    // Clear manual results if they exist
    const manualResults = document.getElementById('manual-results');
    if (manualResults) {
      manualResults.style.display = 'none';
      manualResults.innerHTML = '';
    }
    
    // Clear OCR results
    const ocrResults = document.getElementById('ocr-results');
    if (ocrResults) {
      ocrResults.classList.remove('show');
      ocrResults.innerHTML = '';
    }
    
    // Clear validation status
    const validationStatus = document.getElementById('validation-status');
    if (validationStatus) {
      validationStatus.classList.remove('show');
      validationStatus.innerHTML = '';
    }
  }

  clearForm() {
    if (confirm('×”×× ×œ× ×§×•×ª ××ª ×›×œ ×”× ×ª×•× ×™×?')) {
      // Clear form fields
      document.getElementById('levi-form').reset();
      
      // Clear internal state
      this.uploadedFile = null;
      this.leviResults = {};
      
      // Hide sections
      document.getElementById('preview-container').style.display = 'none';
      document.getElementById('ocr-results').classList.remove('show');
      document.getElementById('validation-status').classList.remove('show');
      document.getElementById('save-results').style.display = 'none';
      
      // Reset to default mode
      this.isManualMode = false;
      document.getElementById('upload-section').style.display = 'block';
      document.getElementById('manual-section').style.display = 'none';
      document.getElementById('report-source').value = 'screenshot';
      
      // Reload case data
      this.loadCaseData();
      
      this.showAlert('×˜×•×¤×¡ × ×•×§×”', 'success');
    }
  }

  resetForNewUpload() {
    console.log('ğŸ”„ Resetting form for new upload...');
    
    // Clear previous results
    this.clearResults();
    
    // Reset upload state
    this.uploadedFile = null;
    this.processingInProgress = false;
    
    // Clear file input
    const fileInput = document.getElementById('levi-file');
    if (fileInput) {
      fileInput.value = '';
    }
    
    // Reset upload area
    const uploadArea = document.querySelector('.upload-area');
    const uploadText = document.querySelector('.upload-text');
    if (uploadArea && uploadText) {
      uploadArea.classList.remove('file-uploaded');
      uploadText.innerHTML = 'ğŸ“„ ×’×¨×•×¨ ×§×•×‘×¥ ×“×•"×— ×œ×•×™ ×™×¦×—×§ ×œ×›××Ÿ ××• ×œ×—×¥ ×œ×‘×—×™×¨×”<br><small>PDF, JPG, PNG, WEBP (×¢×“ 10MB)</small>';
    }
    
    // Hide result buttons and show upload button
    document.getElementById('save-results').style.display = 'none';
    document.getElementById('save-manual').style.display = 'none';
    document.getElementById('upload-new-report').style.display = 'none';
    document.getElementById('continue-to-damage').style.display = 'none';
    document.getElementById('process-levi').style.display = 'inline-block';
    
    // Clear alerts
    const alertsContainer = document.getElementById('alerts-container');
    if (alertsContainer) {
      alertsContainer.innerHTML = '';
    }
    
    this.showAlert('âœ… ××•×›×Ÿ ×œ×”×¢×œ××ª ×“×•"×— ×—×“×©', 'success');
    console.log('âœ… Form reset completed - ready for new upload');
  }

  showContinueButton() {
    const continueBtn = document.getElementById('continue-to-damage');
    if (continueBtn) {
      continueBtn.style.display = 'inline-block';
      continueBtn.addEventListener('click', () => {
        window.location.href = 'damage-centers-wizard.html';
      });
    }
    
    // CRITICAL FIX: Show "Upload New Report" button to allow multiple uploads
    const uploadNewBtn = document.getElementById('upload-new-report');
    if (uploadNewBtn) {
      uploadNewBtn.style.display = 'inline-block';
    }
  }

  showAlert(message, type = 'info') {
    const container = document.getElementById('alerts-container');
    const alert = document.createElement('div');
    alert.className = `alert ${type} show`;
    alert.textContent = message;
    
    container.appendChild(alert);
    
    setTimeout(() => {
      alert.remove();
    }, 5000);
  }
}

// ğŸš¨ GLOBAL FUNCTION: Display adjustments directly from helper valuation data
window.displayAdjustmentsFromHelper = function(adjustments) {
  console.log('ğŸ¯ displayAdjustmentsFromHelper called with:', adjustments);
  
  const adjustmentsContainer = document.getElementById('adjustments-container');
  if (!adjustmentsContainer) {
    console.error('âŒ adjustments-container not found');
    return;
  }
  
  adjustmentsContainer.innerHTML = '';

  // Add table headers
  const headerRow = document.createElement('div');
  headerRow.className = 'adjustment-header-row';
  headerRow.innerHTML = `
    <span class="adjustment-header">×”×ª×××ª ××—×™×¨</span>
    <span class="adjustment-header">×¢×¨×š</span>
    <span class="adjustment-header">××—×•×– %</span>
    <span class="adjustment-header">×¡×›×•× ×©×´×—</span>
    <span class="adjustment-header">×¡×›×•× ××¦×˜×‘×¨</span>
  `;
  adjustmentsContainer.appendChild(headerRow);

  // Define adjustment sections mapping to helper structure  
  const adjustmentSections = [
    {
      title: '×××¤×™×™× ×™×',
      helperKey: 'features',
      defaultReason: '×××¤×™×™× ×™× × ×•×¡×¤×™×'
    },
    {
      title: '×¢×œ×™×” ×œ×›×‘×™×©', 
      helperKey: 'registration',
      defaultReason: '×ª××¨×™×š ×¢×œ×™×” ×œ×›×‘×™×©'
    },
    {
      title: '×¡×•×’ ×‘×¢×œ×•×ª',
      helperKey: 'ownership_type', 
      defaultReason: '×¡×•×’ ×‘×¢×œ×•×ª'
    },
    {
      title: '××¡×¤×¨ ×§×´×',
      helperKey: 'mileage',
      defaultReason: '××¡×¤×¨ ×§×´×'
    },
    {
      title: '××¡×¤×¨ ×‘×¢×œ×™×',
      helperKey: 'ownership_history',
      defaultReason: '××¡×¤×¨ ×‘×¢×œ×™× ×§×•×“××™×'
    }
  ];

  let hasAnyData = false;

  adjustmentSections.forEach(section => {
    const adjustmentData = adjustments[section.helperKey];
    
    if (adjustmentData) {
      hasAnyData = true;
      const adjustmentRow = document.createElement('div');
      adjustmentRow.className = 'adjustment-row';
      
      // First column: title
      const titleSpan = document.createElement('span');
      titleSpan.className = 'adjustment-title';
      titleSpan.textContent = section.title + ':';
      adjustmentRow.appendChild(titleSpan);
      
      // Second column: reason/value description
      const reasonSpan = document.createElement('span');
      reasonSpan.className = 'adjustment-value';
      reasonSpan.textContent = adjustmentData.reason || adjustmentData.type || section.defaultReason;
      adjustmentRow.appendChild(reasonSpan);
      
      // Third column: percentage
      const percentSpan = document.createElement('span');
      percentSpan.className = 'adjustment-value';
      const percent = adjustmentData.percent || 0;
      percentSpan.textContent = percent ? `${percent}%` : '-';
      adjustmentRow.appendChild(percentSpan);
      
      // Fourth column: amount in â‚ª
      const amountSpan = document.createElement('span');
      amountSpan.className = 'adjustment-value';
      const amount = adjustmentData.amount || 0;
      amountSpan.textContent = amount ? `â‚ª${amount.toLocaleString()}` : '-';
      adjustmentRow.appendChild(amountSpan);
      
      // Fifth column: cumulative total
      const cumulativeSpan = document.createElement('span');
      cumulativeSpan.className = 'adjustment-value';
      const cumulative = adjustmentData.cumulative || 0;
      cumulativeSpan.textContent = cumulative ? `â‚ª${cumulative.toLocaleString()}` : '-';
      adjustmentRow.appendChild(cumulativeSpan);
      
      adjustmentsContainer.appendChild(adjustmentRow);
      
      console.log(`  âœ… ${section.title}: ${percent}% = â‚ª${amount} (total: â‚ª${cumulative})`);
    }
  });

  if (!hasAnyData) {
    adjustmentsContainer.innerHTML = '<p style="text-align: center; color: #7f8c8d;">××™×Ÿ × ×ª×•× ×™ ×”×ª×××•×ª ×–××™× ×™× ×‘×¢×ª ×–×•</p>';
    console.log('âš ï¸ No adjustment data found in helper.valuation.adjustments');
  } else {
    console.log('âœ… Successfully populated adjustments display from helper data');
  }
};

// Global functions
window.openLeviPortal = function() {
  // Use internal browser instead of external redirect
  if (typeof openInternalBrowser === 'function') {
    openInternalBrowser('portal.levi-itzhak.co.il', 'levi_report');
  } else {
    // Fallback to external browser if internal browser not available
    window.open("https://portal.levi-itzhak.co.il/levicars/", "_blank");
    
    if (window.leviProcessor?.credentials) {
      const credentialsDisplay = document.getElementById('credentials-display');
      const usernameDisplay = document.getElementById('username-display');
      const passwordDisplay = document.getElementById('password-display');
      
      usernameDisplay.textContent = `××©×ª××©: ${window.leviProcessor.credentials.username}`;
      passwordDisplay.textContent = `×¡×™×¡××”: ${window.leviProcessor.credentials.password}`;
      credentialsDisplay.style.display = 'block';
    } else {
      alert('ğŸ“‹ ×× × ×¤×ª×— ××ª ××ª×¨ ×œ×•×™ ×™×¦×—×§ ×‘Ö¾browser ×—×“×©');
    }
  }
};

window.logout = function() {
  sessionStorage.clear();
  window.location.href = 'index.html';
};

// Manual entry confirmation functions
window.confirmManualEntry = function() {
  if (confirm('âš ï¸ ××–×”×¨×”: ×”×–× ×” ×™×“× ×™×ª ××©××©×ª ×¨×§ ×œ×¦×¨×›×™× ×—×¨×™×’×™×.\n\n×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”××©×™×š ×¢× ×”×–× ×” ×™×“× ×™×ª ×‘××§×•× OCR?')) {
    document.getElementById('manual-form-content').style.display = 'block';
  }
};

window.cancelManualEntry = function() {
  const reportSource = document.getElementById('report-source');
  reportSource.value = 'screenshot';
  const uploadSection = document.getElementById('upload-section');
  const manualSection = document.getElementById('manual-section');
  uploadSection.style.display = 'block';
  manualSection.style.display = 'none';
};

// DISABLED: Function removed to prevent loops
window.populateManualFormFromHelper = function() {
  console.log('ğŸš« Function disabled to prevent loops');
};

// Math engine calculation function - MOVED TO EARLY SCRIPT TAG
// window.calculateFinalPrice = function() { ... }
// Function definition moved to top of file to prevent ReferenceError

// Save manual data to helper system (behave like OCR)
window.saveManualDataToHelper = function() {
  try {
    // Get all manual form values
    const basePrice = parseFloat(document.getElementById('manual-base-price').value) || 0;
    const finalPrice = parseFloat(document.getElementById('manual-final-price').value) || 0;
    
    // Vehicle details
    const manufacturer = document.getElementById('manual-manufacturer').value || '';
    const modelCode = document.getElementById('manual-model-code').value || '';
    const category = document.getElementById('manual-category').value || '';
    const year = document.getElementById('manual-year').value || '';
    const fullModel = document.getElementById('manual-full-model').value || '';
    
    // Adjustment values
    const registrationPercent = parseFloat(document.getElementById('manual-registration-percent').value) || 0;
    const registrationValue = parseFloat(document.getElementById('manual-registration-value').value) || 0;
    const registrationTotal = parseFloat(document.getElementById('manual-registration-total').value) || 0;
    
    const ownershipPercent = parseFloat(document.getElementById('manual-ownership-percent').value) || 0;
    const ownershipValue = parseFloat(document.getElementById('manual-ownership-value').value) || 0;
    const ownershipTotal = parseFloat(document.getElementById('manual-ownership-total').value) || 0;
    
    const kmPercent = parseFloat(document.getElementById('manual-km-percent').value) || 0;
    const kmValue = parseFloat(document.getElementById('manual-km-value').value) || 0;
    const kmTotal = parseFloat(document.getElementById('manual-km-total').value) || 0;
    
    const ownersPercent = parseFloat(document.getElementById('manual-owners-percent').value) || 0;
    const ownersValue = parseFloat(document.getElementById('manual-owners-value').value) || 0;
    const ownersTotal = parseFloat(document.getElementById('manual-owners-total').value) || 0;
    
    const featuresPercent = parseFloat(document.getElementById('manual-features-percent').value) || 0;
    const featuresValue = parseFloat(document.getElementById('manual-features-value').value) || 0;
    const featuresTotal = parseFloat(document.getElementById('manual-features-total').value) || 0;
    
    // Create Levi data object in Hebrew format (matching OCR structure)
    const leviData = {
      '×¡×•×’ ×¨×›×‘': '×¤×¨×˜×™', // Default vehicle type
      '×™×¦×¨×Ÿ': manufacturer,
      '×§×•×“ ×“×’×': modelCode,
      '×§×˜×’×•×¨×™×”': category,
      '×©× ×ª ×™×¦×•×¨': year,
      '×©× ×“×’× ××œ×': fullModel,
      '××—×™×¨ ×‘×¡×™×¡': basePrice,
      '××—×™×¨ ×¡×•×¤×™ ×œ×¨×›×‘': finalPrice,
      
      // Registration adjustments
      '×¢×œ×™×” ×œ×›×‘×™×©': registrationPercent > 0 ? `${registrationPercent}%` : '',
      '×¢×œ×™×” ×œ×›×‘×™×© %': registrationPercent,
      '×¢×¨×š ×©×´×— ×¢×œ×™×” ×œ×›×‘×™×©': registrationValue,
      '×©×•×•×™ ××¦×˜×‘×¨ ×¢×œ×™×” ×œ×›×‘×™×©': registrationTotal,
      
      // Ownership adjustments
      '×‘×¢×œ×•×ª': ownershipPercent > 0 ? `${ownershipPercent}%` : '',
      '×‘×¢×œ×•×ª %': ownershipPercent,
      '×¢×¨×š ×©×´×— ×‘×¢×œ×•×ª': ownershipValue,
      '×©×•×•×™ ××¦×˜×‘×¨ ×‘×¢×œ×•×ª': ownershipTotal,
      
      // KM adjustments
      '××¡ ×§×´×': kmPercent > 0 ? `${kmPercent}%` : '',
      '××¡ ×§×´× %': kmPercent,
      '×¢×¨×š ×©×´×— ××¡ ×§×´×': kmValue,
      '×©×•×•×™ ××¦×˜×‘×¨ ××¡ ×§×´×': kmTotal,
      
      // Owners adjustments
      '××¡×¤×¨ ×‘×¢×œ×™×': ownersPercent > 0 ? `${ownersPercent}%` : '',
      '××¡×¤×¨ ×‘×¢×œ×™× %': ownersPercent,
      '×¢×¨×š ×©×´×— ××¡×¤×¨ ×‘×¢×œ×™×': ownersValue,
      '×©×•×•×™ ××¦×˜×‘×¨ ××¡×¤×¨ ×‘×¢×œ×™×': ownersTotal,
      
      // Features adjustments
      '×××¤×™×™× ×™×': featuresPercent > 0 ? `${featuresPercent}%` : '',
      '×××¤×™×™× ×™× %': featuresPercent,
      '×¢×¨×š ×©×´×— ×××¤×™×™× ×™×': featuresValue,
      '×©×•×•×™ ××¦×˜×‘×¨ ×××¤×™×™× ×™×': featuresTotal
    };
    
    // Get current helper data and preserve existing OCR data
    let helper = {};
    try {
      helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
    } catch (e) {
      console.warn('Could not parse existing helper data:', e);
    }
    
    // Preserve existing OCR data and merge with manual input
    if (!helper.expertise) {
      helper.expertise = {};
    }
    
    // If OCR data exists, merge manual data with it (manual data takes priority)
    if (helper.expertise.levi_report) {
      console.log('Merging manual data with existing OCR data');
      helper.expertise.levi_report = { ...helper.expertise.levi_report, ...leviData };
    } else {
      console.log('No existing OCR data, using manual data only');
      helper.expertise.levi_report = leviData;
    }
    
    // Also update car details if provided
    if (manufacturer || modelCode || category || year || fullModel) {
      if (!helper.car_details) {
        helper.car_details = {};
      }
      if (manufacturer) helper.car_details.manufacturer = manufacturer;
      if (modelCode) helper.car_details.model_code = modelCode;
      if (category) helper.car_details.category = category;
      if (year) helper.car_details.year = year;
      if (fullModel) helper.car_details.full_model = fullModel;
    }
    
    // Save directly to sessionStorage (storage manager removed to prevent conflicts)
    try {
      sessionStorage.setItem('helper', JSON.stringify(helper));
      console.log('ğŸ’¾ Updated sessionStorage with manual Levi data');
      
      // Ensure window.helper is updated
      window.helper = helper;
      
      // Use enhanced helper update with proper section-based updates
      console.log('ğŸ”„ Broadcasting manual data updates to all modules...');
      if (typeof window.updateHelper === 'function') {
        window.updateHelper('levisummary', helper.levisummary, 'manual_input');
        window.updateHelper('expertise', helper.expertise, 'manual_input'); 
        window.updateHelper('calculations', helper.calculations, 'manual_input');
        window.updateHelper('vehicle', helper.vehicle, 'manual_input');
        window.updateHelper('car_details', helper.car_details, 'manual_input');
      }
      
      // Broadcast comprehensive update to all floating screens and modules
      if (typeof window.broadcastHelperUpdate === 'function') {
        window.broadcastHelperUpdate(['levisummary', 'expertise', 'calculations', 'vehicle', 'car_details'], 'manual_levi_input');
      }
      
      // Force refresh all module forms to show updated data
      if (typeof window.refreshAllModuleForms === 'function') {
        console.log('ğŸ”„ Force refreshing all module forms with manual data...');
        setTimeout(() => window.refreshAllModuleForms(), 200);
        setTimeout(() => window.refreshAllModuleForms(), 500); // Retry for safety
      }
      
      // Trigger floating screen updates
      if (typeof refreshLeviData === 'function' || typeof window.refreshLeviData === 'function') {
        console.log('ğŸ”„ Refreshing Levi floating screen...');
        (refreshLeviData || window.refreshLeviData)();
      }
      
      if (typeof window.refreshCarData === 'function') {
        console.log('ğŸ”„ Refreshing car details floating screen...');
        window.refreshCarData();
      }
      
      console.log('âœ… Manual data saved to helper system and all modules refreshed');
      
    } catch (storageError) {
      console.error('âŒ Error saving manual data:', storageError);
      // Emergency fallback
      try {
        sessionStorage.setItem('helper', JSON.stringify(helper));
        console.log('ğŸ’¾ Emergency save to sessionStorage completed');
      } catch (e) {
        console.error('âŒ Even emergency save failed:', e);
      }
    }
    
  } catch (error) {
    console.error('Error saving manual data to helper:', error);
  }
};

// Add event listeners to all manual input fields to save data on change
window.addManualFieldListeners = function() {
  const manualFields = [
    'manual-vehicle-type', 'manual-manufacturer', 'manual-model-code', 
    'manual-category', 'manual-year', 'manual-full-model', 'manual-base-price',
    'manual-registration-percent', 'manual-ownership-percent', 'manual-km-percent',
    'manual-owners-percent', 'manual-features-percent'
  ];
  
  manualFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
      // Remove any existing listeners first
      field.removeEventListener('input', field._manualSaveHandler);
      field.removeEventListener('change', field._manualSaveHandler);
      
      // Create the handler function
      field._manualSaveHandler = () => {
        // Debounce the save to avoid too many calls
        clearTimeout(window.manualSaveTimeout);
        window.manualSaveTimeout = setTimeout(() => {
          console.log(`Manual field ${fieldId} changed, saving data...`);
          saveManualDataToHelper();
          // Refresh floating screen immediately
          if (typeof refreshLeviData === 'function') {
            refreshLeviData();
          }
        }, 300); // Reduced debounce time for more responsive updates
      };
      
      // Add listeners for both input and change events
      field.addEventListener('input', field._manualSaveHandler);
      field.addEventListener('change', field._manualSaveHandler);
    }
  });
  
  console.log('Manual field listeners added for real-time saving and floating screen refresh');
};

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  // Auth check
  const auth = sessionStorage.getItem("auth");
  if (!auth) {
    alert("×”×’×™×©×” ×—×¡×•××” - ×× × ×”×ª×—×‘×¨ ×“×¨×š ×“×£ ×”×‘×™×ª");
    window.location.href = "index.html";
    return;
  }

  // Initialize Levi processor
  window.leviProcessor = new LeviProcessor();
  
  // ENHANCED: Auto-populate vehicle data from helper
  function populateVehicleDataFromHelper() {
    console.log('ğŸ“‹ Levi Upload: Auto-populating vehicle data from helper...');
    
    try {
      const helperString = sessionStorage.getItem('helper');
      if (helperString) {
        const helper = JSON.parse(helperString);
        console.log('âœ… Helper data loaded for Levi upload:', helper);
        
        // Populate basic vehicle fields
        const basicFieldMappings = {
          'plate': helper.vehicle?.plate || helper.meta?.plate,
          'owner': helper.stakeholders?.owner?.name,
          'office_code': helper.vehicle?.office_code,
          'manual-vehicle-type': helper.vehicle?.vehicle_type,
          'manual-manufacturer': helper.vehicle?.manufacturer,
          'manual-model-code': helper.vehicle?.model_code,
          'manual-category': helper.vehicle?.category,
          'manual-year': helper.vehicle?.year,
          'manual-full-model': `${helper.vehicle?.manufacturer || ''} ${helper.vehicle?.model || ''}`.trim(),
          'manual-km': helper.vehicle?.km,
          'manual-features': helper.vehicle?.features
        };
        
        // Populate valuation fields if available
        if (helper.valuation) {
          basicFieldMappings['manual-base-price'] = helper.valuation.base_price;
          basicFieldMappings['manual-final-price'] = helper.valuation.final_price;
          
          // Registration adjustments
          if (helper.valuation.adjustments?.registration) {
            basicFieldMappings['manual-registration'] = helper.valuation.adjustments.registration.reason;
            basicFieldMappings['manual-registration-percent'] = helper.valuation.adjustments.registration.percent;
          }
          
          // Ownership adjustments  
          if (helper.valuation.adjustments?.ownership_type) {
            basicFieldMappings['manual-ownership'] = helper.valuation.adjustments.ownership_type.type;
            basicFieldMappings['manual-ownership-percent'] = helper.valuation.adjustments.ownership_type.percent;
          }
          
          // Mileage adjustments
          if (helper.valuation.adjustments?.mileage) {
            basicFieldMappings['manual-km-percent'] = helper.valuation.adjustments.mileage.percent;
          }
          
          // Ownership history adjustments
          if (helper.valuation.adjustments?.ownership_history) {
            basicFieldMappings['manual-owners'] = helper.valuation.adjustments.ownership_history.owner_count;
            basicFieldMappings['manual-owners-percent'] = helper.valuation.adjustments.ownership_history.percent;
          }
          
          // Features adjustments
          if (helper.valuation.adjustments?.features) {
            basicFieldMappings['manual-features-percent'] = helper.valuation.adjustments.features.percent;
          }
          
          // ğŸš¨ POPULATE ALL ADJUSTMENT VALUES AND AMOUNTS
          const adjustments = helper.valuation.adjustments || {};
          
          // Registration amounts
          if (adjustments.registration) {
            basicFieldMappings['manual-registration-value'] = adjustments.registration.amount;
            basicFieldMappings['manual-registration-total'] = adjustments.registration.cumulative;
          }
          
          // Ownership amounts
          if (adjustments.ownership_type) {
            basicFieldMappings['manual-ownership-value'] = adjustments.ownership_type.amount;
            basicFieldMappings['manual-ownership-total'] = adjustments.ownership_type.cumulative;
          }
          
          // Mileage amounts
          if (adjustments.mileage) { 
            basicFieldMappings['manual-km-value'] = adjustments.mileage.amount;
            basicFieldMappings['manual-km-total'] = adjustments.mileage.cumulative;
          }
          
          // Ownership history amounts
          if (adjustments.ownership_history) {
            basicFieldMappings['manual-owners-value'] = adjustments.ownership_history.amount;
            basicFieldMappings['manual-owners-total'] = adjustments.ownership_history.cumulative;
          }
          
          // Features amounts
          if (adjustments.features) {
            basicFieldMappings['manual-features-value'] = adjustments.features.amount;
            basicFieldMappings['manual-features-total'] = adjustments.features.cumulative;
          }
        }
        
        // Apply the mappings
        Object.entries(basicFieldMappings).forEach(([fieldId, value]) => {
          const element = document.getElementById(fieldId);
          if (element && value !== undefined && value !== null && value !== '') {
            element.value = value;
            console.log(`  âœ… ${fieldId}: "${value}"`);
          }
        });
        
        // Set valuation date to today if not set
        const valuationDateElement = document.getElementById('valuation-date');
        if (valuationDateElement && !valuationDateElement.value) {
          valuationDateElement.value = new Date().toISOString().split('T')[0];
        }
        
        console.log('âœ… Levi upload auto-population completed');
        
        // ğŸš¨ CRITICAL FIX: Trigger adjustment calculations and display after population
        setTimeout(() => {
          console.log('ğŸ”„ Triggering adjustment recalculation...');
          
          // Recalculate adjustments to populate all amounts and cumulative values
          if (typeof window.calculateAdjustmentsFromFields === 'function') {
            window.calculateAdjustmentsFromFields();
          } else {
            // Manual trigger of the calculation logic
            const basePrice = parseFloat(document.getElementById('manual-base-price')?.value) || 0;
            if (basePrice > 0) {
              console.log('ğŸ“Š Base price found, triggering manual calculations...');
              
              // Trigger any existing calculation listeners
              const basePriceElement = document.getElementById('manual-base-price');
              if (basePriceElement) {
                basePriceElement.dispatchEvent(new Event('input', { bubbles: true }));
                basePriceElement.dispatchEvent(new Event('change', { bubbles: true }));
              }
            }
          }
          
          // Force refresh of adjustment display using valuation data
          if (helper.valuation?.adjustments) {
            console.log('ğŸ¯ Found valuation adjustments, populating display...');
            window.displayAdjustmentsFromHelper(helper.valuation.adjustments);
          }
        }, 500);
        
      } else {
        console.log('âš ï¸ No helper data found in sessionStorage');
      }
    } catch (error) {
      console.error('âŒ Error auto-populating Levi vehicle data:', error);
    }
  }
  
  // Auto-populate on page load
  populateVehicleDataFromHelper();
  
  // Trigger password prefill immediately when page loads
  setTimeout(() => {
    console.log('ğŸ”‘ LEVI UPLOAD: Page loaded, triggering password prefill...');
    
    // Debug what's available
    console.log('ğŸ” Available for password prefill:');
    console.log('- prefillPassword:', sessionStorage.getItem('prefillPassword'));
    console.log('- auth:', !!sessionStorage.getItem('auth'));
    
    // Try the global prefill function
    if (typeof window.prefillUserPassword === 'function') {
      window.prefillUserPassword();
    }
    
    // Manual fallback
    const prefillPassword = sessionStorage.getItem('prefillPassword');
    if (prefillPassword && document.getElementById('pass')) {
      document.getElementById('pass').value = prefillPassword;
      console.log('ğŸ”‘ LEVI UPLOAD: Password manually filled on page load');
    }
  }, 1000);
});

// Test password prefill function
window.testPasswordPrefill = function() {
  console.log('ğŸ” TESTING PASSWORD PREFILL...');
  
  // Debug all password sources
  console.log('ğŸ“Š Password Sources Debug:');
  console.log('1. sessionStorage.prefillPassword:', sessionStorage.getItem('prefillPassword'));
  console.log('2. sessionStorage.auth:', !!sessionStorage.getItem('auth'));
  console.log('3. Current pass field value:', document.getElementById('pass').value);
  console.log('4. All sessionStorage keys:', Object.keys(sessionStorage));
  
  // Test prefill function
  if (typeof window.prefillUserPassword === 'function') {
    window.prefillUserPassword();
    console.log('âœ… Global prefill function called');
  } else {
    console.log('âŒ Global prefill function not available');
  }
  
  // Manual prefill test
  const prefillPassword = sessionStorage.getItem('prefillPassword');
  if (prefillPassword) {
    document.getElementById('pass').value = prefillPassword;
    console.log('âœ… Manual prefill successful:', prefillPassword);
  } else {
    console.log('âŒ No prefillPassword found');
    // Legacy password decryption removed in Phase 6
  }
};

// ğŸ”§ FIX: Add missing logout function
function logout() {
  // Use the enhanced logout with sound if available
  if (typeof window.logoutWithSound === 'function') {
    window.logoutWithSound();
  } else {
    // Fallback to regular logout
    console.log('ğŸšª Logging out...');
    
    // Clear session storage
    sessionStorage.clear();
    localStorage.removeItem('helper_data');
    localStorage.removeItem('helper_last_save');
    
    // Redirect to selection page
    window.location.href = 'selection.html';
  }
}

</script>

<!-- Load floating screen scripts BEFORE HTML elements that use them -->
<script src="car-details-floating.js"></script>
<script src="levi-floating.js"></script>

<!-- FLOATING SCREEN TOGGLES - TOP OF PAGE -->
<div class="floating-toggles-top">
  <div class="toggle-square" onclick="toggleLeviReport()">
    <div class="toggle-icon">ğŸ“Š</div>
    <div class="toggle-text">×“×•"×— ×œ×•×™ ×™×¦×—×§</div>
  </div>
  <div class="toggle-square" onclick="toggleCarDetails()">
    <div class="toggle-icon">ğŸš—</div>
    <div class="toggle-text">×¤×¨×˜×™ ×¨×›×‘</div>
  </div>
</div>
<script src="internal-browser.js"></script>
<script src="password-prefill.js"></script>
<!-- SESSION 56: Load helper.js BEFORE universal-data-capture.js -->
<script src="helper.js"></script>
<script src="universal-data-capture.js" type="module"></script>
<script src="force-populate-forms.js"></script>

</body>
</html>