<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×“×•"×— ×œ×•×™ ×™×¦×—×§</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link href="https://fonts.googleapis.com/css2?family=Assistant&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      direction: rtl;
    }
    
    .container {
      max-width: 900px;
      width: 100%;
      background: #fff;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e1e8ed;
    }
    
    .logo img {
      width: 120px;
      margin-bottom: 15px;
    }
    
    .title { 
      font-size: 24px; 
      font-weight: bold; 
      margin-bottom: 5px; 
      color: #1e3a8a;
    }
    h2 {
      font-size: 22px;
      color: #64748b;
      margin-bottom: 30px;
    }
    .subtitle { 
      font-size: 20px; 
      color: #64748b; 
      margin-bottom: 20px; 
    }
    
    .section {
      margin-bottom: 30px;
      padding: 25px;
      border: 1px solid #e1e8ed;
      border-radius: 10px;
      background: #f8f9fa;
    }
    
    .section h3 {
      margin: 0 0 20px 0;
      color: #2c3e50;
      font-size: 20px;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .form-group {
      flex: 1;
      min-width: 200px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #34495e;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px;
      font-size: 14px;
      border-radius: 8px;
      border: 2px solid #e1e8ed;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    .file-upload-area {
      border: 3px dashed #bdc3c7;
      border-radius: 15px;
      padding: 40px 20px;
      text-align: center;
      background: #ecf0f1;
      transition: all 0.3s ease;
      cursor: pointer;
      margin-bottom: 20px;
    }
    
    .file-upload-area:hover {
      border-color: #3498db;
      background: #ebf3fd;
    }
    
    .file-upload-area.dragover {
      border-color: #27ae60;
      background: #e8f5e8;
    }
    
    .upload-icon {
      font-size: 48px;
      color: #95a5a6;
      margin-bottom: 15px;
    }
    
    .upload-text {
      font-size: 18px;
      color: #7f8c8d;
      margin-bottom: 10px;
    }
    
    .upload-hint {
      font-size: 14px;
      color: #95a5a6;
    }
    
    #file-input {
      display: none;
    }
    
    .preview-container {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }
    
    .preview-image {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    .btn {
      padding: 15px 30px;
      font-size: 16px;
      font-weight: 600;
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin: 10px 5px;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .btn:hover {
      background: linear-gradient(135deg, #2980b9, #21618c);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
    }
    
    .btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #27ae60, #229954);
    }
    
    .btn-success:hover {
      background: linear-gradient(135deg, #229954, #1e8449);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #95a5a6, #7f8c8d);
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, #7f8c8d, #6c7b7d);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
    }
    
    .btn-danger:hover {
      background: linear-gradient(135deg, #c0392b, #a93226);
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #f39c12, #e67e22);
    }
    
    .btn-warning:hover {
      background: linear-gradient(135deg, #e67e22, #d35400);
    }
    
    .processing-status {
      display: none;
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .processing-status.show {
      display: block;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #ecf0f1;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 15px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3498db, #2980b9);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .ocr-results {
      display: none;
      background: white;
      border-radius: 10px;
      padding: 25px;
      margin-top: 20px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    .ocr-results.show {
      display: block;
    }
    
    .data-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .data-card {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      border: 1px solid #e1e8ed;
    }
    
    .data-card h4 {
      margin: 0 0 15px 0;
      color: #2c3e50;
      font-size: 16px;
      border-bottom: 1px solid #3498db;
      padding-bottom: 8px;
    }
    
    .data-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding: 5px 0;
      border-bottom: 1px solid #ecf0f1;
    }
    
    .data-item:last-child {
      border-bottom: none;
    }
    
    .data-label {
      font-weight: 600;
      color: #34495e;
    }
    
    .data-value {
      color: #2c3e50;
      font-weight: 500;
    }
    
    .validation-status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      display: none;
    }
    
    .validation-status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .validation-status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .validation-status.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .validation-status.show {
      display: block;
    }
    
    .footer-btns {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e1e8ed;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      justify-content: center;
    }
    
    .footer {
      text-align: center;
      font-size: 12px;
      margin-top: 20px;
      color: #95a5a6;
    }
    
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .levi-portal-section {
      background: #e8f5e8;
      border: 2px solid #27ae60;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .levi-portal-section h3 {
      color: #27ae60;
      margin-bottom: 15px;
    }
    
    .credentials-display {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-family: monospace;
      font-size: 14px;
      text-align: right;
    }
    
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        padding: 20px;
      }
      
      .form-row {
        flex-direction: column;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .footer-btns {
        flex-direction: column;
      }
      
      .data-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .alert {
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
    }
    
    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .alert.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .alert.show {
      display: block;
    }
    
    .adjustment-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .adjustment-table th,
    .adjustment-table td {
      padding: 12px;
      text-align: right;
      border-bottom: 1px solid #ecf0f1;
    }
    
    .adjustment-table th {
      background: #34495e;
      color: white;
      font-weight: 600;
    }
    
    .adjustment-table tr:hover {
      background: #f8f9fa;
    }
    
    /* New compact adjustment display */
    .adjustment-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      margin-bottom: 8px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e1e8ed;
      flex-wrap: wrap;
    }
    
    .adjustment-row label {
      font-weight: bold;
      min-width: 120px;
      color: #2c3e50;
    }
    
    .adjustment-value {
      display: inline-block;
      padding: 5px 10px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin: 0 5px;
      font-family: monospace;
    }
  </style>
</head>
<body>

<script type="module">
  import { WEBHOOKS } from './webhook.js';
  window.WEBHOOKS = WEBHOOKS;
</script>

<div class="container">
  <div class="header">
    <div class="logo">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo" />
    </div>
    <h1 class="title">×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×¤×•×¨×˜×œ</h1>
    <div class="subtitle">×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</div>
    <h2>×“×•"×— ×œ×•×™ ×™×¦×—×§</h2>
  </div>

  <div id="alerts-container"></div>

  <!-- Levi Portal Integration Section -->
  <div class="levi-portal-section">
    <h3>ğŸ”— ×›× ×™×¡×” ×œ××¢×¨×›×ª ×œ×•×™ ×™×¦×—×§</h3>
    <p>×œ×‘×“×™×§×ª ×©×•×•×™ ×¨×›×‘ ×‘××¢×¨×›×ª ×œ×•×™ ×™×¦×—×§</p>
    <button type="button" class="btn btn-warning" onclick="openLeviPortal()">
      ğŸŒ ×¤×ª×— ××ª×¨ ×œ×•×™ ×™×¦×—×§
    </button>
    <div class="credentials-display" id="credentials-display" style="display: none;">
      <div>×¤×¨×˜×™ ×”×ª×—×‘×¨×•×ª ×œ××¢×¨×›×ª:</div>
      <div id="username-display"></div>
      <div id="password-display"></div>
    </div>
  </div>

  <form id="levi-form" method="POST" onsubmit="return false;">
    <!-- Case Information Section -->
    <div class="section">
      <h3>×¤×¨×˜×™ ×”×ª×™×§</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="plate">××¡×¤×¨ ×¨×™×©×•×™:</label>
          <input id="plate" name="plate" placeholder="××¡×¤×¨ ×¨×™×©×•×™ ×”×¨×›×‘" required type="text" />
        </div>
        <div class="form-group">
          <label for="owner">×©× ×‘×¢×œ ×”×¨×›×‘:</label>
          <input id="owner" name="owner" placeholder="×©× ×‘×¢×œ ×”×¨×›×‘" required type="text" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="office_code">×§×•×“ ××©×¨×“ ×”×ª×—×‘×•×¨×”:</label>
          <input id="office_code" name="office_code" placeholder="×§×•×“ ××©×¨×“ ×”×ª×—×‘×•×¨×”" required type="text" />
        </div>
        <div class="form-group">
          <label for="pass">×¡×™×¡××:</label>
          <input id="pass" name="pass" placeholder="×¡×™×¡××" required type="password" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="report-source">××§×•×¨ ×”×“×•"×—:</label>
          <select id="report-source" name="report-source">
            <option value="screenshot">×¦×™×œ×•× ××¡×š ××”××¢×¨×›×ª</option>
            <option value="pdf">×§×•×‘×¥ PDF</option>
            <option value="manual">×”×–× ×” ×™×“× ×™×ª</option>
          </select>
        </div>
        <div class="form-group">
          <label for="valuation-date">×ª××¨×™×š ×”×¢×¨×›×”:</label>
          <input id="valuation-date" name="valuation-date" type="date" />
        </div>
      </div>
    </div>

    <!-- File Upload Section -->
    <div class="section" id="upload-section">
      <h3>×”×¢×œ××ª ×“×•"×— ×œ×•×™ ×™×¦×—×§</h3>
      <div class="file-upload-area" onclick="document.getElementById('file-input').click()">
        <div class="upload-icon">ğŸ“Š</div>
        <div class="upload-text">×œ×—×¥ ×›××Ÿ ××• ×’×¨×•×¨ ×“×•"×— ×œ×•×™ ×™×¦×—×§ ×œ××–×•×¨ ×–×”</div>
        <div class="upload-hint">×ª×•××š ×‘×§×‘×¦×™ PDF, JPG, PNG | ×’×•×“×œ ××§×¡×™××œ×™: 10MB</div>
      </div>
      <input id="file-input" type="file" accept="image/*,.pdf" required />
      
      <!-- Preview Container -->
      <div class="preview-container" id="preview-container">
        <img id="preview-image" class="preview-image" style="display: none;" />
      </div>
    </div>

    <!-- Manual Entry Section -->
    <div class="section" id="manual-section" style="display: none;">
      <h3>×”×–× ×” ×™×“× ×™×ª - ×¤×¨×˜×™ ×”×¨×›×‘</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="manual-model">×“×’× ××œ×:</label>
          <input id="manual-model" type="text" placeholder="×“×’× ×”×¨×›×‘ ×”××œ×" />
        </div>
        <div class="form-group">
          <label for="manual-year">×©× ×ª ×™×™×¦×•×¨:</label>
          <input id="manual-year" type="number" min="1980" max="2030" placeholder="×©× ×ª ×™×™×¦×•×¨" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="manual-km">×§×™×œ×•××˜×¨××–':</label>
          <input id="manual-km" type="number" min="0" placeholder="×§×™×œ×•××˜×¨××–' ×”×¨×›×‘" />
        </div>
        <div class="form-group">
          <label for="manual-transmission">×¡×•×’ ×ª×™×‘×ª ×”×™×œ×•×›×™×:</label>
          <select id="manual-transmission">
            <option value="">×‘×—×¨ ×¡×•×’ ×ª×™×‘×”</option>
            <option value="manual">×™×“× ×™</option>
            <option value="automatic">××•×˜×•××˜×™</option>
            <option value="cvt">CVT</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="manual-base-price">××—×™×¨ ×‘×¡×™×¡:</label>
          <input id="manual-base-price" type="number" min="0" step="100" placeholder="××—×™×¨ ×‘×¡×™×¡ ×‘×©×§×œ×™×" />
        </div>
        <div class="form-group">
          <label for="manual-final-price">××—×™×¨ ×¡×•×¤×™:</label>
          <input id="manual-final-price" type="number" min="0" step="100" placeholder="××—×™×¨ ×¡×•×¤×™ ×‘×©×§×œ×™×" />
        </div>
      </div>
    </div>

    <!-- Processing Status -->
    <div class="processing-status" id="processing-status">
      <h3>××¢×‘×“ ×“×•"×— ×œ×•×™ ×™×¦×—×§...</h3>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div id="progress-text">×× × ×”××ª×Ÿ...</div>
    </div>

    <!-- OCR Results Section -->
    <div class="ocr-results" id="ocr-results">
      <h3>×ª×•×¦××•×ª ×¢×™×‘×•×“ ×“×•"×— ×œ×•×™ ×™×¦×—×§</h3>
      
      <!-- Vehicle Information -->
      <div class="data-grid">
        <div class="data-card">
          <h4>×¤×¨×˜×™ ×”×¨×›×‘</h4>
          <div id="vehicle-details">
            <!-- Vehicle details will be populated here -->
          </div>
        </div>
        
        <div class="data-card">
          <h4>×¤×¨×˜×™ ×”×”×¢×¨×›×”</h4>
          <div id="valuation-details">
            <!-- Valuation details will be populated here -->
          </div>
        </div>
        
        <div class="data-card">
          <h4>××—×™×¨×™×</h4>
          <div id="pricing-details">
            <!-- Pricing details will be populated here -->
          </div>
        </div>
      </div>
      
      <!-- Price Adjustments - New Layout -->
      <div style="margin-top: 30px;">
        <h4>×”×ª×××•×ª ××—×™×¨</h4>
        <div id="adjustments-container">
          <!-- Adjustments will be populated here -->
        </div>
      </div>
      
      <!-- Manual Override Section -->
      <div class="section" style="margin-top: 20px;">
        <h3>×¢×“×›×•×Ÿ ×™×“× ×™</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="override-base-price">××—×™×¨ ×‘×¡×™×¡:</label>
            <input id="override-base-price" type="number" step="100" />
          </div>
          <div class="form-group">
            <label for="override-final-price">××—×™×¨ ×¡×•×¤×™:</label>
            <input id="override-final-price" type="number" step="100" />
          </div>
        </div>
        <button type="button" id="update-prices" class="btn btn-secondary">×¢×“×›×Ÿ ××—×™×¨×™×</button>
      </div>
    </div>

    <!-- Validation Status -->
    <div class="validation-status" id="validation-status">
      <!-- Validation messages will appear here -->
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button type="submit" id="process-levi" class="btn btn-success">
        ğŸ” ×¢×‘×“ ×“×•"×— ×œ×•×™
      </button>
      <button type="button" id="save-results" class="btn btn-primary" style="display: none;">
        ğŸ’¾ ×©××•×¨ ×ª×•×¦××•×ª
      </button>
      <button type="button" id="clear-form" class="btn btn-secondary">
        ğŸ—‘ï¸ × ×§×” ×˜×•×¤×¡
      </button>
      <button type="button" id="toggle-manual" class="btn btn-warning">
        âœï¸ ×”×–× ×” ×™×“× ×™×ª
      </button>
      <button type="button" id="continue-to-damage" class="btn btn-success" style="display: none;">
        â¡ï¸ ×”××©×š ×œ××•×§×“×™ × ×–×§
      </button>
    </div>
  </form>

  <div class="footer-btns">
    <button class="btn btn-secondary" onclick="window.location.href='selection.html'">ğŸ  ×¢××•×“ ×”×‘×™×ª</button>
    <button class="btn btn-danger" onclick="logout()">ğŸšª ×™×¦×™××”</button>
  </div>

  <div class="footer">All rights reserved Â© Carmel Cayouf</div>
</div>

<script type="module">
import { sendToWebhook, getWebhook } from './webhook.js';
import { updateHelper } from './helper.js';

// Enhanced Levi Report Processing System
class LeviProcessor {
  constructor() {
    this.uploadedFile = null;
    this.leviResults = {};
    this.processingInProgress = false;
    this.maxFileSize = 10 * 1024 * 1024; // 10MB
    this.allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'application/pdf'];
    this.isManualMode = false;
    
    this.init();
  }

  init() {
    this.setupEventListeners();
    this.loadCaseData();
    this.setupDragAndDrop();
    this.loadCredentials();
  }

  setupEventListeners() {
    // File input change
    document.getElementById('file-input').addEventListener('change', (e) => {
      this.handleFileSelection(e.target.files[0]);
    });

    // Form submission
    document.getElementById('levi-form').addEventListener('submit', (e) => {
      e.preventDefault();
      this.processLevi();
    });

    // Manual mode toggle
    document.getElementById('toggle-manual').addEventListener('click', () => {
      this.toggleManualMode();
    });

    // Report source change
    document.getElementById('report-source').addEventListener('change', (e) => {
      this.handleReportSourceChange(e.target.value);
    });

    // Clear form
    document.getElementById('clear-form').addEventListener('click', () => {
      this.clearForm();
    });

    // Save results
    document.getElementById('save-results').addEventListener('click', () => {
      this.saveResults();
    });

    // Update prices
    document.getElementById('update-prices').addEventListener('click', () => {
      this.updatePrices();
    });

    // Valuation date auto-set to today
    document.getElementById('valuation-date').value = new Date().toISOString().split('T')[0];
  }

  loadCaseData() {
    // Load case data from session storage
    const plate = sessionStorage.getItem('plate');
    const owner = sessionStorage.getItem('owner');
    const pass = sessionStorage.getItem('ycPass');
    const officeCode = sessionStorage.getItem('office_code');

    if (plate) document.getElementById('plate').value = plate;
    if (owner) document.getElementById('owner').value = owner;
    if (pass) document.getElementById('pass').value = pass;
    if (officeCode) document.getElementById('office_code').value = officeCode;

    // Load from helper if available
    try {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      if (helper.car_details) {
        document.getElementById('plate').value = helper.car_details.plate || '';
        document.getElementById('owner').value = helper.general_info?.owner_name || '';
      }
    } catch (e) {
      console.warn('Could not load helper data:', e);
    }
  }

  async loadCredentials() {
    try {
      // Import credentials and display them when portal button is clicked
      const { dev_credentials } = await import('./credentials vault.js');
      this.credentials = dev_credentials?.leviItzhak;
    } catch (e) {
      console.warn('Could not load credentials:', e);
      this.credentials = null;
    }
  }

  setupDragAndDrop() {
    const uploadArea = document.querySelector('.file-upload-area');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, this.preventDefaults, false);
      document.body.addEventListener(eventName, this.preventDefaults, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
      uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
    });

    uploadArea.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const files = dt.files;
      if (files.length > 0) {
        this.handleFileSelection(files[0]);
      }
    }, false);
  }

  preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  handleReportSourceChange(source) {
    const uploadSection = document.getElementById('upload-section');
    const manualSection = document.getElementById('manual-section');
    
    if (source === 'manual') {
      uploadSection.style.display = 'none';
      manualSection.style.display = 'block';
      this.isManualMode = true;
    } else {
      uploadSection.style.display = 'block';
      manualSection.style.display = 'none';
      this.isManualMode = false;
    }
  }

  toggleManualMode() {
    const reportSource = document.getElementById('report-source');
    if (this.isManualMode) {
      reportSource.value = 'screenshot';
      this.handleReportSourceChange('screenshot');
    } else {
      reportSource.value = 'manual';
      this.handleReportSourceChange('manual');
    }
  }

  handleFileSelection(file) {
    if (!file) return;

    if (!this.validateFile(file)) {
      return;
    }

    this.uploadedFile = file;
    this.showPreview(file);
    this.showAlert('×§×•×‘×¥ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”', 'success');
  }

  validateFile(file) {
    if (!this.allowedTypes.includes(file.type)) {
      this.showAlert(`×¡×•×’ ×§×•×‘×¥ ×œ× × ×ª××š: ${file.name}`, 'error');
      return false;
    }

    if (file.size > this.maxFileSize) {
      this.showAlert(`×§×•×‘×¥ ×’×“×•×œ ××“×™: ${file.name} (××§×¡×™××•× 10MB)`, 'error');
      return false;
    }

    return true;
  }

  showPreview(file) {
    const previewContainer = document.getElementById('preview-container');
    const previewImage = document.getElementById('preview-image');
    
    if (file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage.src = e.target.result;
        previewImage.style.display = 'block';
        previewContainer.style.display = 'block';
      };
      reader.readAsDataURL(file);
    } else {
      previewImage.style.display = 'none';
      previewContainer.style.display = 'block';
      previewContainer.innerHTML = `
        <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
          <div style="font-size: 48px; color: #dc3545; margin-bottom: 10px;">ğŸ“Š</div>
          <div>×§×•×‘×¥ PDF × ×˜×¢×Ÿ: ${file.name}</div>
        </div>
      `;
    }
  }

  async processLevi() {
    if (this.processingInProgress) return;

    if (!this.isManualMode && !this.uploadedFile) {
      this.showAlert('×× × ×‘×—×¨ ×§×•×‘×¥ ×“×•"×— ×œ×•×™ ×™×¦×—×§', 'error');
      return;
    }

    if (!this.validateForm()) {
      return;
    }

    this.processingInProgress = true;
    this.showProcessingStatus(true);
    
    try {
      let result;
      
      if (this.isManualMode) {
        result = this.processManualEntry();
      } else {
        result = await this.processFileUpload();
      }

      this.handleLeviResults(result);
      this.showAlert('âœ… ×“×•"×— ×œ×•×™ ×™×¦×—×§ ×¢×•×‘×“ ×‘×”×¦×œ×—×”', 'success');
      this.showContinueButton();
      
    } catch (error) {
      console.error('Levi processing error:', error);
      this.showAlert('âŒ ×©×’×™××” ×‘×¢×™×‘×•×“ ×“×•"×— ×œ×•×™ ×™×¦×—×§: ' + error.message, 'error');
    } finally {
      this.processingInProgress = false;
      this.showProcessingStatus(false);
    }
  }

  async processFileUpload() {
    const formData = new FormData();
    formData.append('file', this.uploadedFile);
    formData.append('meta', JSON.stringify({
      plate: document.getElementById('plate').value,
      owner: document.getElementById('owner').value,
      office_code: document.getElementById('office_code').value,
      pass: document.getElementById('pass').value,
      report_source: document.getElementById('report-source').value,
      valuation_date: document.getElementById('valuation-date').value
    }));

    const response = await fetch(getWebhook('SUBMIT_LEVI_REPORT'), {
      method: 'POST',
      body: formData
    });

    if (response.ok) {
      return await response.json();
    } else {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.error || '×©×’×™××” ×‘×¢×™×‘×•×“ ×“×•"×— ×œ×•×™ ×™×¦×—×§');
    }
  }

  processManualEntry() {
    // Process manual entry data
    const manualData = {
      plate: document.getElementById('plate').value,
      owner: document.getElementById('owner').value,
      office_code: document.getElementById('office_code').value,
      valuation_date: document.getElementById('valuation-date').value,
      vehicle_details: {
        full_model: document.getElementById('manual-model').value,
        year: parseInt(document.getElementById('manual-year').value) || '',
        km: parseInt(document.getElementById('manual-km').value) || '',
        transmission: document.getElementById('manual-transmission').value,
        is_automatic: document.getElementById('manual-transmission').value === 'automatic'
      },
      pricing: {
        base_price: parseFloat(document.getElementById('manual-base-price').value) || 0,
        final_price: parseFloat(document.getElementById('manual-final-price').value) || 0
      },
      source: 'manual_entry',
      processed_at: new Date().toISOString()
    };

    // Calculate adjustments based on base and final price
    const basePrice = manualData.pricing.base_price;
    const finalPrice = manualData.pricing.final_price;
    const adjustment = finalPrice - basePrice;
    const adjustmentPercent = basePrice > 0 ? ((adjustment / basePrice) * 100).toFixed(2) : 0;

    manualData.adjustments = {
      total: {
        percent: adjustmentPercent,
        value: adjustment,
        total: finalPrice
      }
    };

    return manualData;
  }

  validateForm() {
    const required = ['plate', 'owner', 'office_code', 'pass'];
    for (const fieldId of required) {
      const field = document.getElementById(fieldId);
      if (!field.value.trim()) {
        this.showAlert(`×©×“×” ×—×•×‘×”: ${field.previousElementSibling.textContent}`, 'error');
        field.focus();
        return false;
      }
    }

    if (this.isManualMode) {
      const manualRequired = ['manual-model', 'manual-year', 'manual-base-price'];
      for (const fieldId of manualRequired) {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
          this.showAlert(`×©×“×” ×—×•×‘×” ×‘×”×–× ×” ×™×“× ×™×ª: ${field.previousElementSibling.textContent}`, 'error');
          field.focus();
          return false;
        }
      }
    }

    return true;
  }

  handleLeviResults(result) {
    this.leviResults = result;
    this.displayLeviResults(result);
    this.showValidationStatus(result);
    
    // Update helper with Levi results
    this.updateHelperWithResults(result);
    
    // Show save button
    document.getElementById('save-results').style.display = 'inline-block';
  }

  displayLeviResults(result) {
    const ocrContainer = document.getElementById('ocr-results');
    ocrContainer.classList.add('show');

    // Vehicle Details - Updated to match new OCR JSON structure
    const vehicleDetails = document.getElementById('vehicle-details');
    vehicleDetails.innerHTML = `
      <div class="data-item">
        <span class="data-label">×¡×•×’ ×¨×›×‘:</span>
        <span class="data-value">${result['×¡×•×’ ×¨×›×‘'] || result.vehicle_details?.vehicle_type || '×œ× ×–××™×Ÿ'}</span>
      </div>
      <div class="data-item">
        <span class="data-label">×™×¦×¨×Ÿ:</span>
        <span class="data-value">${result['×™×¦×¨×Ÿ'] || result.vehicle_details?.manufacturer || '×œ× ×–××™×Ÿ'}</span>
      </div>
      <div class="data-item">
        <span class="data-label">×§×•×“ ×“×’×:</span>
        <span class="data-value">${result['×§×•×“ ×“×’×'] || result.vehicle_details?.model_code || '×œ× ×–××™×Ÿ'}</span>
      </div>
      <div class="data-item">
        <span class="data-label">×§×˜×’×•×¨×™×”:</span>
        <span class="data-value">${result['×§×˜×’×•×¨×™×”'] || result.vehicle_details?.category || '×œ× ×–××™×Ÿ'}</span>
      </div>
      <div class="data-item">
        <span class="data-label">×©× ×ª ×™×¦×•×¨:</span>
        <span class="data-value">${result['×©× ×ª ×™×¦×•×¨'] || result.vehicle_details?.year || '×œ× ×–××™×Ÿ'}</span>
      </div>
      <div class="data-item">
        <span class="data-label">×©× ×“×’× ××œ×:</span>
        <span class="data-value">${result['×©× ×“×’× ××œ×'] || result.vehicle_details?.full_model || '×œ× ×–××™×Ÿ'}</span>
      </div>
    `;

    // Valuation Details
    const valuationDetails = document.getElementById('valuation-details');
    valuationDetails.innerHTML = `
      <div class="data-item">
        <span class="data-label">×ª××¨×™×š ×”×¢×¨×›×”:</span>
        <span class="data-value">${result.valuation_date || new Date().toLocaleDateString('he-IL')}</span>
      </div>
      <div class="data-item">
        <span class="data-label">×§×•×“ ××©×¨×“ ×”×ª×—×‘×•×¨×”:</span>
        <span class="data-value">${result.office_code || '×œ× ×–××™×Ÿ'}</span>
      </div>
      <div class="data-item">
        <span class="data-label">××§×•×¨ ×”×“×•"×—:</span>
        <span class="data-value">${this.getSourceLabel(result.source || result.report_source)}</span>
      </div>
    `;

    // Pricing Details - Updated to match new OCR structure
    const pricingDetails = document.getElementById('pricing-details');
    const basePrice = result['××—×™×¨ ×‘×¡×™×¡'] || result.pricing?.base_price || 0;
    const finalPrice = result['××—×™×¨ ×¡×•×¤×™ ×œ×¨×›×‘'] || result.pricing?.final_price || 0;
    pricingDetails.innerHTML = `
      <div class="data-item">
        <span class="data-label">××—×™×¨ ×‘×¡×™×¡:</span>
        <span class="data-value">â‚ª${parseFloat(basePrice).toLocaleString()}</span>
      </div>
      <div class="data-item">
        <span class="data-label">××—×™×¨ ×¡×•×¤×™ ×œ×¨×›×‘:</span>
        <span class="data-value"><strong>â‚ª${parseFloat(finalPrice).toLocaleString()}</strong></span>
      </div>
      <div class="data-item">
        <span class="data-label">×”×¤×¨×©:</span>
        <span class="data-value">â‚ª${(parseFloat(finalPrice) - parseFloat(basePrice)).toLocaleString()}</span>
      </div>
    `;

    // Adjustments Table
    this.displayAdjustments(result.adjustments || {});

    // Update manual override fields
    document.getElementById('override-base-price').value = result.pricing?.base_price || '';
    document.getElementById('override-final-price').value = result.pricing?.final_price || '';
  }

  displayAdjustments(adjustments) {
    const adjustmentsContainer = document.getElementById('adjustments-container');
    adjustmentsContainer.innerHTML = '';

    // Define adjustment structure based on your OCR JSON example
    const adjustmentSections = [
      {
        title: '×¢×œ×™×” ×œ×›×‘×™×©',
        fields: ['×¢×œ×™×” ×œ×›×‘×™×©', '×¢×œ×™×” ×œ×›×‘×™×© %', '×¢×¨×š ×©×´×— ×¢×œ×™×” ×œ×›×‘×™×©', '×©×•×•×™ ××¦×˜×‘×¨ ×¢×œ×™×” ×œ×›×‘×™×©']
      },
      {
        title: '×¡×•×’ ×‘×¢×œ×•×ª',
        fields: ['×‘×¢×œ×•×ª', '×‘×¢×œ×•×ª %', '×¢×¨×š ×©×´×— ×‘×¢×œ×•×ª', '×©×•×•×™ ××¦×˜×‘×¨ ×‘×¢×œ×•×ª']
      },
      {
        title: '××¡×¤×¨ ×§×´×',
        fields: ['××¡ ×§×´×', '××¡ ×§×´× %', '×¢×¨×š ×©×´×— ××¡ ×§×´×', '×©×•×•×™ ××¦×˜×‘×¨ ××¡ ×§×´×']
      },
      {
        title: '××¡×¤×¨ ×‘×¢×œ×™×',
        fields: ['××¡×¤×¨ ×‘×¢×œ×™×', '××¡×¤×¨ ×‘×¢×œ×™× %', '×¢×¨×š ×©×´×— ××¡×¤×¨ ×‘×¢×œ×™×', '×©×•×•×™ ××¦×˜×‘×¨ ××¡×¤×¨ ×‘×¢×œ×™×']
      },
      {
        title: '×××¤×™×™× ×™×',
        fields: ['×××¤×™×™× ×™×', '×××¤×™×™× ×™× %', '×¢×¨×š ×©×´×— ×××¤×™×™× ×™×', '×©×•×•×™ ××¦×˜×‘×¨ ×××¤×™×™× ×™×']
      }
    ];

    adjustmentSections.forEach(section => {
      const adjustmentRow = document.createElement('div');
      adjustmentRow.className = 'adjustment-row';
      
      const label = document.createElement('label');
      label.textContent = section.title + ':';
      adjustmentRow.appendChild(label);
      
      section.fields.forEach(fieldKey => {
        const value = adjustments[fieldKey] || 
                     (adjustments[section.title] && adjustments[section.title][fieldKey]) || 
                     '';
        
        const valueSpan = document.createElement('span');
        valueSpan.className = 'adjustment-value';
        valueSpan.textContent = value || '-';
        adjustmentRow.appendChild(valueSpan);
      });
      
      adjustmentsContainer.appendChild(adjustmentRow);
    });

    if (adjustmentsContainer.children.length === 0) {
      adjustmentsContainer.innerHTML = '<p style="text-align: center; color: #7f8c8d;">××™×Ÿ × ×ª×•× ×™ ×”×ª×××•×ª ×–××™× ×™×</p>';
    }
  }

  getSourceLabel(source) {
    const sourceLabels = {
      'screenshot': '×¦×™×œ×•× ××¡×š',
      'pdf': '×§×•×‘×¥ PDF',
      'manual': '×”×–× ×” ×™×“× ×™×ª',
      'manual_entry': '×”×–× ×” ×™×“× ×™×ª'
    };
    return sourceLabels[source] || source || '×œ× ×–××™×Ÿ';
  }

  updatePrices() {
    const basePrice = parseFloat(document.getElementById('override-base-price').value) || 0;
    const finalPrice = parseFloat(document.getElementById('override-final-price').value) || 0;

    if (basePrice <= 0 || finalPrice <= 0) {
      this.showAlert('×× × ×”×›× ×¡ ××—×™×¨×™× ×ª×§×™× ×™×', 'error');
      return;
    }

    // Update internal results
    this.leviResults.pricing = {
      ...this.leviResults.pricing,
      base_price: basePrice,
      final_price: finalPrice
    };

    // Recalculate and display
    this.displayLeviResults(this.leviResults);
    this.showAlert('××—×™×¨×™× ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”', 'success');
  }

  showValidationStatus(result) {
    const statusContainer = document.getElementById('validation-status');
    let statusType = 'success';
    let message = 'âœ… ×“×•"×— ×œ×•×™ ×™×¦×—×§ ×¢×•×‘×“ ×‘×”×¦×œ×—×”';
    
    if (result.warnings && result.warnings.length > 0) {
      statusType = 'warning';
      message = 'âš ï¸ ×“×•"×— ×¢×•×‘×“ ×¢× ××–×”×¨×•×ª: ' + result.warnings.join(', ');
    }
    
    if (result.errors && result.errors.length > 0) {
      statusType = 'error';
      message = 'âŒ ×©×’×™××•×ª ×‘×¢×™×‘×•×“: ' + result.errors.join(', ');
    }
    
    statusContainer.className = `validation-status ${statusType} show`;
    statusContainer.textContent = message;
    
    // Hide after 5 seconds
    setTimeout(() => {
      statusContainer.classList.remove('show');
    }, 5000);
  }

  async saveResults() {
    if (!this.leviResults || Object.keys(this.leviResults).length === 0) {
      this.showAlert('××™×Ÿ ×ª×•×¦××•×ª ×œ×©××™×¨×”', 'warning');
      return;
    }
    
    try {
      const resultData = {
        ...this.leviResults,
        updated_at: new Date().toISOString()
      };
      
      // Save to helper system
      this.updateHelperWithResults(resultData);
      
      // Send to webhook for processing
      await sendToWebhook('SAVE_LEVI_RESULTS', resultData);
      
      this.showAlert('âœ… ×ª×•×¦××•×ª × ×©××¨×• ×‘×”×¦×œ×—×”', 'success');
      
    } catch (error) {
      console.error('Save error:', error);
      this.showAlert('âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”×ª×•×¦××•×ª', 'error');
    }
  }

  updateHelperWithResults(result) {
    try {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Update levi summary data
      helper.levisummary = {
        model_code: result.vehicle_details?.model_code || '',
        full_model: result.vehicle_details?.full_model || '',
        is_automatic: result.vehicle_details?.is_automatic || false,
        features: result.vehicle_details?.features || '',
        report_date: result.valuation_date || new Date().toISOString().split('T')[0],
        registration_date: result.vehicle_details?.registration_date || '',
        owner_count: result.vehicle_details?.owner_count || '',
        category: result.vehicle_details?.category || '',
        km: result.vehicle_details?.km || '',
        base_price: result.pricing?.base_price || 0,
        final_price: result.pricing?.final_price || 0,
        adjustments: result.adjustments || {}
      };

      // Update expertise section
      if (!helper.expertise) helper.expertise = {};
      helper.expertise.levi_report = {
        ...helper.levisummary,
        processed_at: new Date().toISOString(),
        source: result.source || result.report_source || 'unknown'
      };
      
      // Update meta information
      helper.meta = helper.meta || {};
      helper.meta.last_levi_processed = new Date().toISOString();
      helper.meta.levi_report_available = true;
      
      // Update session storage
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      // Update via helper system
      updateHelper(helper);
      
    } catch (e) {
      console.warn('Could not update helper with Levi results:', e);
    }
  }

  showProcessingStatus(show) {
    const statusElement = document.getElementById('processing-status');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    
    if (show) {
      statusElement.classList.add('show');
      
      // Simulate progress
      let progress = 0;
      const interval = setInterval(() => {
        progress += 12;
        progressFill.style.width = `${Math.min(progress, 90)}%`;
        
        if (progress >= 25 && progress < 50) {
          progressText.textContent = '××¢×‘×“ OCR...';
        } else if (progress >= 50 && progress < 75) {
          progressText.textContent = '×× ×ª×— × ×ª×•× ×™ ×”×¢×¨×›×”...';
        } else if (progress >= 75 && progress < 90) {
          progressText.textContent = '××—×©×‘ ×”×ª×××•×ª ××—×™×¨...';
        }
        
        if (progress >= 90) {
          clearInterval(interval);
          progressText.textContent = '××©×œ×™× ×¢×™×‘×•×“...';
        }
      }, 400);
      
      // Store interval reference for cleanup
      this.progressInterval = interval;
    } else {
      statusElement.classList.remove('show');
      progressFill.style.width = '0%';
      progressText.textContent = '×× × ×”××ª×Ÿ...';
      
      if (this.progressInterval) {
        clearInterval(this.progressInterval);
      }
    }
  }

  clearForm() {
    if (confirm('×”×× ×œ× ×§×•×ª ××ª ×›×œ ×”× ×ª×•× ×™×?')) {
      // Clear form fields
      document.getElementById('levi-form').reset();
      
      // Clear internal state
      this.uploadedFile = null;
      this.leviResults = {};
      
      // Hide sections
      document.getElementById('preview-container').style.display = 'none';
      document.getElementById('ocr-results').classList.remove('show');
      document.getElementById('validation-status').classList.remove('show');
      document.getElementById('save-results').style.display = 'none';
      
      // Reset to default mode
      this.isManualMode = false;
      document.getElementById('upload-section').style.display = 'block';
      document.getElementById('manual-section').style.display = 'none';
      document.getElementById('report-source').value = 'screenshot';
      
      // Reload case data
      this.loadCaseData();
      
      this.showAlert('×˜×•×¤×¡ × ×•×§×”', 'success');
    }
  }

  showContinueButton() {
    const continueBtn = document.getElementById('continue-to-damage');
    if (continueBtn) {
      continueBtn.style.display = 'inline-block';
      continueBtn.addEventListener('click', () => {
        window.location.href = 'damage-center-flow.html';
      });
    }
  }

  showAlert(message, type = 'info') {
    const container = document.getElementById('alerts-container');
    const alert = document.createElement('div');
    alert.className = `alert ${type} show`;
    alert.textContent = message;
    
    container.appendChild(alert);
    
    setTimeout(() => {
      alert.remove();
    }, 5000);
  }
}

// Global functions
window.openLeviPortal = function() {
  // Use internal browser instead of external redirect
  if (typeof openInternalBrowser === 'function') {
    openInternalBrowser('portal.levi-itzhak.co.il', 'levi_report');
  } else {
    // Fallback to external browser if internal browser not available
    window.open("https://portal.levi-itzhak.co.il", "_blank");
    
    if (window.leviProcessor?.credentials) {
      const credentialsDisplay = document.getElementById('credentials-display');
      const usernameDisplay = document.getElementById('username-display');
      const passwordDisplay = document.getElementById('password-display');
      
      usernameDisplay.textContent = `××©×ª××©: ${window.leviProcessor.credentials.username}`;
      passwordDisplay.textContent = `×¡×™×¡××”: ${window.leviProcessor.credentials.password}`;
      credentialsDisplay.style.display = 'block';
    } else {
      alert('ğŸ“‹ ×× × ×¤×ª×— ××ª ××ª×¨ ×œ×•×™ ×™×¦×—×§ ×‘Ö¾browser ×—×“×©');
    }
  }
};

window.logout = function() {
  sessionStorage.clear();
  window.location.href = 'index.html';
};

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  // Auth check
  const auth = sessionStorage.getItem("auth");
  if (!auth) {
    alert("×”×’×™×©×” ×—×¡×•××” - ×× × ×”×ª×—×‘×¨ ×“×¨×š ×“×£ ×”×‘×™×ª");
    window.location.href = "index.html";
    return;
  }

  // Initialize Levi processor
  window.leviProcessor = new LeviProcessor();
});

</script>
<script src="car-details-float.js"></script>
<script src="levi-floating.js"></script>
<script src="internal-browser.js"></script>

</body>
</html>