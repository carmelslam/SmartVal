<!DOCTYPE html>
<html>
<head>
    <title>Invoice Floating Screen Fix Test</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            direction: rtl;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .test-button:hover {
            background: #0052a3;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    </style>
    <script>
        // Mock window.helper for testing
        window.helper = {
            case_info: {
                supabase_case_id: 'test-case-uuid-123',
                plate: 'test-plate-456'
            },
            current_invoice: {
                case_uuid: 'test-invoice-case-uuid'
            }
        };
        
        // Mock supabase for testing
        window.supabase = {
            from: (table) => ({
                select: () => ({
                    eq: () => ({
                        order: () => ({
                            then: (callback) => {
                                // Mock invoice lines data with catalog_code
                                const mockData = table === 'invoice_lines' ? [
                                    {
                                        catalog_code: '12345-ABC',
                                        pcode: '12345-ABC',
                                        oem: '12345-ABC',
                                        description: '×‘×œ× ×§×“××™ ×™××™×Ÿ',
                                        quantity: 2,
                                        unit_price: 150,
                                        line_total: 300,
                                        item_category: 'part'
                                    },
                                    {
                                        catalog_code: '67890-DEF',
                                        pcode: '67890-DEF',
                                        oem: '67890-DEF',
                                        description: '×× ×•×¢ ××’×‘×™×',
                                        quantity: 1,
                                        unit_price: 450,
                                        line_total: 450,
                                        item_category: 'part'
                                    }
                                ] : table === 'invoice_damage_center_mappings' ? [
                                    {
                                        damage_center_id: 'center-1',
                                        damage_center_name: '×§×“××ª ×”×¨×›×‘',
                                        validation_status: 'pending',
                                        invoice_line: {
                                            catalog_code: '12345-ABC',
                                            pcode: '12345-ABC',
                                            oem: '12345-ABC',
                                            description: '×‘×œ× ×§×“××™ ×™××™×Ÿ',
                                            quantity: 2,
                                            unit_price: 150,
                                            line_total: 300
                                        },
                                        invoice: {
                                            supplier_name: '××•×¡×š ×”×›×œ ×‘×¡×“×¨'
                                        }
                                    }
                                ] : [];
                                
                                callback({ data: mockData, error: null });
                            }
                        })
                    })
                })
            })
        };
        
        function logTest(message, type = 'info') {
            const log = document.getElementById('test-log');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            log.appendChild(div);
        }
        
        function testFirstTab() {
            logTest('×‘×•×“×§ Tab 1 - ×¤×™×¨×•×˜ ×©×•×¨×•×ª ×—×©×‘×•× ×™×ª...', 'info');
            
            // Switch to first tab
            if (window.switchInvoiceTab) {
                window.switchInvoiceTab('documents');
                logTest('×¢×‘×¨ ×œ-Tab 1 ×‘×”×¦×œ×—×”', 'success');
                
                setTimeout(() => {
                    // Check if table shows catalog codes
                    const table = document.getElementById('invoice-results-table');
                    if (table) {
                        const rows = table.querySelectorAll('tbody tr');
                        let foundCatalogCode = false;
                        
                        rows.forEach(row => {
                            const firstCell = row.querySelector('td:first-child');
                            if (firstCell && firstCell.textContent.includes('12345-ABC')) {
                                foundCatalogCode = true;
                            }
                        });
                        
                        if (foundCatalogCode) {
                            logTest('âœ… Tab 1: × ××¦××• ×§×•×“×™ ×§×˜×œ×•×’ ×‘××§×•× "×¤×¨×™×˜"', 'success');
                        } else {
                            logTest('âŒ Tab 1: ×œ× × ××¦××• ×§×•×“×™ ×§×˜×œ×•×’', 'warning');
                        }
                    } else {
                        logTest('âŒ Tab 1: ×˜×‘×œ×” ×œ× × ××¦××”', 'warning');
                    }
                }, 1000);
            } else {
                logTest('âŒ ×¤×•× ×§×¦×™×™×ª switchInvoiceTab ×œ× ×–××™× ×”', 'warning');
            }
        }
        
        function testSecondTab() {
            logTest('×‘×•×“×§ Tab 2 - ×”×§×¦××•×ª ×œ××•×§×“×™ × ×–×§...', 'info');
            
            // Switch to second tab
            if (window.switchInvoiceTab) {
                window.switchInvoiceTab('mappings');
                logTest('×¢×‘×¨ ×œ-Tab 2 ×‘×”×¦×œ×—×”', 'success');
                
                setTimeout(() => {
                    // Check if mappings are displayed
                    const container = document.getElementById('damage-centers-container');
                    const summary = document.getElementById('mappings-summary');
                    const noData = document.getElementById('no-mappings-data');
                    
                    if (container && container.style.display === 'block') {
                        logTest('âœ… Tab 2: ××›×œ ×”× ×ª×•× ×™× ××•×¦×’', 'success');
                    } else if (summary && summary.style.display === 'block') {
                        logTest('âœ… Tab 2: ×¡×™×›×•× ×”×§×¦××•×ª ××•×¦×’', 'success');
                    } else if (noData && noData.style.display === 'block') {
                        logTest('â„¹ï¸ Tab 2: ××•×¦×’ ××¡×š "××™×Ÿ × ×ª×•× ×™×"', 'info');
                    } else {
                        logTest('âŒ Tab 2: ××£ ×ª×•×›×Ÿ ×œ× ××•×¦×’', 'warning');
                    }
                    
                    // Check for catalog codes in second tab tables
                    const tables = document.querySelectorAll('#damage-centers-container table');
                    let foundCatalogInTab2 = false;
                    
                    tables.forEach(table => {
                        const rows = table.querySelectorAll('tbody tr');
                        rows.forEach(row => {
                            const firstCell = row.querySelector('td:first-child');
                            if (firstCell && firstCell.textContent.includes('12345-ABC')) {
                                foundCatalogInTab2 = true;
                            }
                        });
                    });
                    
                    if (foundCatalogInTab2) {
                        logTest('âœ… Tab 2: ×§×•×“×™ ×§×˜×œ×•×’ ××•×¦×’×™× × ×›×•×Ÿ ×‘×˜×‘×œ××•×ª', 'success');
                    } else {
                        logTest('â„¹ï¸ Tab 2: ×œ× × ××¦××• ×§×•×“×™ ×§×˜×œ×•×’ (×™×™×ª×›×Ÿ ×©××™×Ÿ × ×ª×•× ×™×)', 'info');
                    }
                }, 1500);
            } else {
                logTest('âŒ ×¤×•× ×§×¦×™×™×ª switchInvoiceTab ×œ× ×–××™× ×”', 'warning');
            }
        }
        
        function testTabSwitching() {
            logTest('×‘×•×“×§ ××¢×‘×¨ ×‘×™×Ÿ ×˜××‘×™×...', 'info');
            
            // Test switching between tabs
            if (window.switchInvoiceTab) {
                window.switchInvoiceTab('documents');
                setTimeout(() => {
                    window.switchInvoiceTab('mappings');
                    setTimeout(() => {
                        window.switchInvoiceTab('documents');
                        logTest('âœ… ××¢×‘×¨ ×‘×™×Ÿ ×˜××‘×™× ×¢×•×‘×“', 'success');
                    }, 500);
                }, 500);
            } else {
                logTest('âŒ ×¤×•× ×§×¦×™×™×ª switchInvoiceTab ×œ× ×–××™× ×”', 'warning');
            }
        }
    </script>
    <script src="invoice-details-floating.js"></script>
</head>
<body>
    <h1>ğŸ§ª ×‘×“×™×§×ª ×ª×™×§×•×Ÿ ××¡×š ×¤×¨×˜×™ ×—×©×‘×•× ×™×•×ª</h1>
    
    <div class="test-section">
        <h3>×ª×™×§×•× ×™× ×©×‘×•×¦×¢×•:</h3>
        <div class="status info">
            âœ… ×ª×•×§×Ÿ Tab 1: ×”×˜×‘×œ×” ×”×¨××©×•× ×” ×ª×¦×™×’ ×§×•×“×™ ×§×˜×œ×•×’ ×‘××§×•× "×¤×¨×™×˜"
        </div>
        <div class="status info">
            âœ… ×ª×•×§×Ÿ Tab 2: ×ª×•×§× ×” ×‘×¢×™×™×ª ×”×¦×’×ª ×”× ×ª×•× ×™× ×•×§×•×“×™ ×”×§×˜×œ×•×’
        </div>
    </div>
    
    <div class="test-section">
        <h3>×›×¤×ª×•×¨×™ ×‘×“×™×§×”:</h3>
        <button class="test-button" onclick="toggleInvoiceDetails()">×¤×ª×— ××¡×š ×¤×¨×˜×™ ×—×©×‘×•× ×™×•×ª</button>
        <button class="test-button" onclick="testFirstTab()">×‘×“×•×§ Tab 1</button>
        <button class="test-button" onclick="testSecondTab()">×‘×“×•×§ Tab 2</button>
        <button class="test-button" onclick="testTabSwitching()">×‘×“×•×§ ××¢×‘×¨ ×˜××‘×™×</button>
        <button class="test-button" onclick="document.getElementById('test-log').innerHTML=''">× ×§×” ×œ×•×’</button>
    </div>
    
    <div class="test-section">
        <h3>×œ×•×’ ×‘×“×™×§×•×ª:</h3>
        <div id="test-log"></div>
    </div>
    
    <script>
        // Log initial status
        window.addEventListener('load', function() {
            logTest('âœ… ×”×“×£ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”', 'success');
            logTest('âœ… ×¤×•× ×§×¦×™×™×ª toggleInvoiceDetails ×–××™× ×”: ' + (typeof window.toggleInvoiceDetails), 'info');
            logTest('âœ… ×¤×•× ×§×¦×™×™×ª switchInvoiceTab ×–××™× ×”: ' + (typeof window.switchInvoiceTab), 'info');
        });
    </script>
</body>
</html>