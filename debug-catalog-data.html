<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Catalog Data</title>
    <style>
        body { font-family: Arial; margin: 20px; direction: rtl; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; }
        button { padding: 10px 20px; margin: 5px; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: right; }
        th { background: #f0f0f0; }
    </style>
</head>
<body>
    <h1>בדיקת נתוני קטלוג - Hebrew Parts</h1>

    <div>
        <button onclick="checkTotalItems()">בדוק סה"כ פריטים</button>
        <button onclick="searchHebrewParts()">חפש חלקים בעברית</button>
        <button onclick="searchEnglishParts()">חפש חלקים באנגלית</button>
        <button onclick="getSampleData()">דוגמאות נתונים</button>
        <button onclick="testPiPWindow()">בדוק PiP</button>
    </div>

    <div id="results" class="result"></div>

    <script src="./services/supabaseClient.js"></script>
    <script src="./services/smartPartsSearchService.js"></script>
    <script src="./parts-search-results-pip.js"></script>

    <script>
        const results = document.getElementById('results');

        async function checkTotalItems() {
            results.innerHTML = 'בודק סה"כ פריטים...';
            
            try {
                // Use a simple select with limit to estimate total items
                const { data, error } = await window.supabase
                    .from('catalog_items')
                    .select('id')
                    .limit(1000);
                
                if (error) {
                    results.innerHTML = `שגיאה: ${error.message}`;
                    return;
                }
                
                if (data.length === 1000) {
                    results.innerHTML = `יש לפחות 1000+ פריטים בקטלוג`;
                } else {
                    results.innerHTML = `סה"כ פריטים בקטלוג: ${data.length}`;
                }
                
            } catch (error) {
                results.innerHTML = `שגיאה: ${error.message}`;
            }
        }

        async function getSampleData() {
            results.innerHTML = 'מביא דוגמאות נתונים...';
            
            try {
                const { data, error } = await window.supabase
                    .from('catalog_items')
                    .select('*')
                    .limit(10);
                
                if (error) {
                    results.innerHTML = `שגיאה: ${error.message}`;
                    return;
                }
                
                let html = `<h3>דוגמאות נתונים (${data.length} פריטים):</h3><table>`;
                html += '<tr><th>ID</th><th>PCODE</th><th>תיאור</th><th>משפחת חלק</th><th>יצרן</th><th>דגם</th></tr>';
                
                data.forEach(item => {
                    html += `<tr>
                        <td>${item.id}</td>
                        <td>${item.pcode || 'N/A'}</td>
                        <td>${item.cat_num_desc || 'N/A'}</td>
                        <td>${item.part_family || 'N/A'}</td>
                        <td>${item.make || 'N/A'}</td>
                        <td>${item.model || 'N/A'}</td>
                    </tr>`;
                });
                
                html += '</table>';
                results.innerHTML = html;
                
            } catch (error) {
                results.innerHTML = `שגיאה: ${error.message}`;
            }
        }

        async function searchHebrewParts() {
            results.innerHTML = 'מחפש חלקים בעברית...';
            
            const hebrewTerms = ['פגוש', 'כנף', 'פנס', 'מראה', 'דלת', 'טויוטה', 'יוליק'];
            let foundResults = [];
            
            try {
                for (const term of hebrewTerms) {
                    console.log(`🔍 Testing Hebrew term: "${term}"`);
                    
                    // Test direct ILIKE search
                    const { data, error } = await window.supabase
                        .from('catalog_items')
                        .select('*')
                        .or(`cat_num_desc.ilike.%${term}%,part_family.ilike.%${term}%,make.ilike.%${term}%`)
                        .limit(5);
                    
                    if (!error && data && data.length > 0) {
                        foundResults.push({
                            term: term,
                            count: data.length,
                            samples: data.slice(0, 2)
                        });
                    }
                }
                
                let html = `<h3>תוצאות חיפוש עברית:</h3>`;
                
                if (foundResults.length === 0) {
                    html += '<p>❌ לא נמצאו תוצאות לאף מילה בעברית</p>';
                    
                    // Try broader search
                    const { data: broadData } = await window.supabase
                        .from('catalog_items')
                        .select('cat_num_desc, part_family, make')
                        .not('cat_num_desc', 'is', null)
                        .limit(20);
                    
                    html += '<h4>דוגמאות תיאורים מהמאגר:</h4><ul>';
                    broadData?.forEach(item => {
                        if (item.cat_num_desc) {
                            html += `<li>${item.cat_num_desc}</li>`;
                        }
                    });
                    html += '</ul>';
                } else {
                    foundResults.forEach(result => {
                        html += `<h4>"${result.term}" - ${result.count} תוצאות:</h4><ul>`;
                        result.samples.forEach(sample => {
                            html += `<li>${sample.cat_num_desc || sample.part_family || sample.make}</li>`;
                        });
                        html += '</ul>';
                    });
                }
                
                results.innerHTML = html;
                
            } catch (error) {
                results.innerHTML = `שגיאה: ${error.message}`;
            }
        }

        async function searchEnglishParts() {
            results.innerHTML = 'מחפש חלקים באנגלית...';
            
            const englishTerms = ['bumper', 'fender', 'door', 'toyota', 'light'];
            let foundResults = [];
            
            try {
                for (const term of englishTerms) {
                    const { data, error } = await window.supabase
                        .from('catalog_items')
                        .select('*')
                        .or(`cat_num_desc.ilike.%${term}%,part_family.ilike.%${term}%,make.ilike.%${term}%`)
                        .limit(5);
                    
                    if (!error && data && data.length > 0) {
                        foundResults.push({
                            term: term,
                            count: data.length,
                            samples: data.slice(0, 2)
                        });
                    }
                }
                
                let html = `<h3>תוצאות חיפוש אנגלית:</h3>`;
                
                if (foundResults.length === 0) {
                    html += '<p>❌ לא נמצאו תוצאות לאף מילה באנגלית</p>';
                } else {
                    foundResults.forEach(result => {
                        html += `<h4>"${result.term}" - ${result.count} תוצאות:</h4><ul>`;
                        result.samples.forEach(sample => {
                            html += `<li>${sample.cat_num_desc || sample.part_family || sample.make}</li>`;
                        });
                        html += '</ul>';
                    });
                }
                
                results.innerHTML = html;
                
            } catch (error) {
                results.innerHTML = `שגיאה: ${error.message}`;
            }
        }

        // Test PiP window function
        function testPiPWindow() {
            console.log('🧪 Testing PiP window visibility...');
            results.innerHTML = 'בודק חלון PiP...';
            
            const sampleResults = [
                {
                    id: 'test-1',
                    pcode: 'TEST123',
                    cat_num_desc: 'Test Part Description - תיאור חלק לבדיקה',
                    part_family: 'Test Family - משפחת בדיקה',
                    make: 'Toyota - טויוטה',
                    model: 'Corolla',
                    price: 150,
                    oem: 'TEST-OEM-123',
                    supplier_name: 'Test Supplier - ספק בדיקה',
                    availability: 'Available - זמין'
                },
                {
                    id: 'test-2',
                    pcode: 'TEST456',
                    cat_num_desc: 'Another Test Part - חלק נוסף לבדיקה',
                    part_family: 'Another Family - משפחה אחרת',
                    make: 'Honda - הונדה',
                    model: 'Civic',
                    price: 200,
                    oem: 'TEST-OEM-456',
                    supplier_name: 'Another Supplier - ספק אחר',
                    availability: 'Available - זמין'
                }
            ];
            
            if (window.partsResultsPiP) {
                window.partsResultsPiP.showResults(sampleResults, {
                    plate: 'TEST-123-456',
                    sessionId: 'debug-test-session',
                    searchType: 'debug_test',
                    searchSuccess: true,
                    errorMessage: null,
                    searchTime: 100
                });
                results.innerHTML = 'חלון PiP הופעל עם נתוני בדיקה - בדוק אם הוא נראה על המסך';
            } else {
                results.innerHTML = 'שגיאה: window.partsResultsPiP לא זמין';
            }
        }
    </script>
</body>
</html>