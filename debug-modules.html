<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug Modules - SmartVal</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .debug-box {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
    }
    .error { border-left-color: #ef4444; }
    .success { border-left-color: #10b981; }
    .warning { border-left-color: #f59e0b; }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #2563eb;
    }
    pre {
      background: #f3f4f6;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>🔧 Module Debug Tool</h1>
  
  <button onclick="testPiPModule()">Test PiP Module</button>
  <button onclick="testSearchService()">Test Search Service</button>
  <button onclick="testSupabaseClient()">Test Supabase Client</button>
  <button onclick="clearResults()">Clear Results</button>
  
  <div id="results"></div>

  <!-- Include modules to test -->
  <script type="module" src="./parts-search-results-pip.js"></script>
  <script type="module" src="./services/partsSearchService.js"></script>
  <script type="module" src="./lib/supabaseClient.js"></script>

  <script>
    function log(message, type = 'info') {
      const results = document.getElementById('results');
      const div = document.createElement('div');
      div.className = `debug-box ${type}`;
      div.innerHTML = `
        <strong>${new Date().toLocaleTimeString()}:</strong> ${message}
      `;
      results.appendChild(div);
      console.log(message);
    }

    function clearResults() {
      document.getElementById('results').innerHTML = '';
    }

    async function testPiPModule() {
      log('🧪 Testing PiP Module...', 'info');
      
      try {
        // Check if window.partsResultsPiP exists
        if (window.partsResultsPiP) {
          log('✅ window.partsResultsPiP is available', 'success');
          log(`Type: ${typeof window.partsResultsPiP}`, 'info');
          
          // Check methods
          if (typeof window.partsResultsPiP.showResults === 'function') {
            log('✅ showResults method is available', 'success');
          } else {
            log('❌ showResults method not found', 'error');
          }
          
          // Test with mock data
          const mockData = [{
            id: 'test-1',
            pcode: 'TEST123',
            cat_num_desc: 'Test Part',
            supplier_name: 'Test Supplier',
            price: 100,
            oem: 'TEST-OEM',
            part_family: 'test'
          }];
          
          log('🔄 Testing PiP with mock data...', 'info');
          await window.partsResultsPiP.showResults(mockData, {
            plate: 'TEST123',
            sessionId: 'debug-session'
          });
          log('✅ PiP test completed successfully', 'success');
          
        } else {
          log('❌ window.partsResultsPiP not found', 'error');
          log('Available window objects with "parts": ' + 
              Object.keys(window).filter(k => k.toLowerCase().includes('parts')).join(', '), 'info');
        }
      } catch (error) {
        log(`❌ PiP test error: ${error.message}`, 'error');
        log(`Stack: ${error.stack}`, 'error');
      }
    }

    async function testSearchService() {
      log('🧪 Testing Search Service...', 'info');
      
      try {
        const { partsSearchService } = await import('./services/partsSearchService.js');
        log('✅ partsSearchService imported successfully', 'success');
        log(`Type: ${typeof partsSearchService}`, 'info');
        
        // Test search
        log('🔄 Testing search with minimal params...', 'info');
        const result = await partsSearchService.searchParts({
          manufacturer: 'Toyota',
          free_query: 'test'
        });
        
        log(`Search result: ${JSON.stringify(result, null, 2)}`, 'info');
        
        if (result.success) {
          log(`✅ Search successful: ${result.results ? result.results.length : 0} results`, 'success');
        } else {
          log(`⚠️ Search returned no results`, 'warning');
        }
        
      } catch (error) {
        log(`❌ Search service test error: ${error.message}`, 'error');
        log(`Stack: ${error.stack}`, 'error');
      }
    }

    async function testSupabaseClient() {
      log('🧪 Testing Supabase Client...', 'info');
      
      try {
        const { supabase } = await import('./lib/supabaseClient.js');
        log('✅ Supabase client imported successfully', 'success');
        log(`Type: ${typeof supabase}`, 'info');
        
        // Test basic query
        log('🔄 Testing basic Supabase query...', 'info');
        const { data, error } = await supabase
          .from('catalog_items')
          .select('id, pcode, cat_num_desc')
          .limit(5);
        
        if (error) {
          log(`❌ Supabase query error: ${error.message}`, 'error');
        } else {
          log(`✅ Supabase query successful: ${data ? data.length : 0} rows`, 'success');
          if (data && data.length > 0) {
            log(`Sample data: <pre>${JSON.stringify(data[0], null, 2)}</pre>`, 'info');
          }
        }
        
      } catch (error) {
        log(`❌ Supabase client test error: ${error.message}`, 'error');
        log(`Stack: ${error.stack}`, 'error');
      }
    }

    // Auto-run tests on load
    window.addEventListener('load', () => {
      log('🚀 Debug page loaded', 'info');
      setTimeout(() => {
        log('⏱️ Running auto-tests in 2 seconds...', 'info');
        setTimeout(() => {
          testPiPModule();
          setTimeout(testSearchService, 1000);
          setTimeout(testSupabaseClient, 2000);
        }, 2000);
      }, 100);
    });
  </script>
</body>
</html>