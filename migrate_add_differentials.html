<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Migrate - Add Differentials to Existing Damage Centers</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { padding: 20px; font-size: 18px; background: #4CAF50; color: white; border: none; cursor: pointer; margin: 10px; }
        #output { margin-top: 20px; padding: 20px; background: #f5f5f5; font-family: monospace; white-space: pre-wrap; max-height: 600px; overflow-y: auto; }
        .warning { background: #fff3cd; padding: 15px; margin: 10px 0; border-left: 4px solid #ffc107; }
    </style>
</head>
<body>
    <h1>üîß Migration Tool: Add Differentials to Existing Damage Centers</h1>
    
    <div class="warning">
        <strong>‚ö†Ô∏è WARNING:</strong> This will modify your existing damage centers by adding differentials fields to parts_meta, works_meta, and repairs_meta. Make sure you understand what this does before clicking.
    </div>
    
    <button onclick="migrateDamageCenters()">
        üîÑ Migrate Damage Centers - Add Differentials
    </button>
    
    <button onclick="showCurrentData()">
        üìä Show Current Data (No Changes)
    </button>
    
    <div id="output"></div>

    <script src="helper.js"></script>
    <script>
        function showCurrentData() {
            const output = document.getElementById('output');
            output.innerHTML = 'üìä Loading current data...\n\n';
            
            const helperRaw = sessionStorage.getItem('helper');
            if (!helperRaw) {
                output.innerHTML += '‚ùå No helper data found\n';
                return;
            }
            
            const helper = JSON.parse(helperRaw);
            output.innerHTML += `Found ${helper.damage_centers?.length || 0} damage centers\n\n`;
            
            helper.damage_centers?.forEach((center, idx) => {
                output.innerHTML += `\n=== Damage Center ${idx + 1} ===\n`;
                output.innerHTML += `Location: ${center.Location}\n`;
                output.innerHTML += `Parts meta: ${JSON.stringify(center.Parts?.parts_meta, null, 2)}\n`;
                output.innerHTML += `Works meta: ${JSON.stringify(center.Works?.works_meta, null, 2)}\n`;
                output.innerHTML += `Repairs meta: ${JSON.stringify(center.Repairs?.repairs_meta, null, 2)}\n`;
            });
        }
        
        function migrateDamageCenters() {
            const output = document.getElementById('output');
            output.innerHTML = 'üîÑ Starting migration...\n\n';
            
            try {
                // Load helper from sessionStorage
                const helperRaw = sessionStorage.getItem('helper');
                if (!helperRaw) {
                    output.innerHTML += '‚ùå ERROR: No helper data found in sessionStorage!\n';
                    return;
                }
                
                window.helper = JSON.parse(helperRaw);
                const centersCount = window.helper.damage_centers?.length || 0;
                output.innerHTML += `‚úÖ Loaded helper from sessionStorage\n`;
                output.innerHTML += `‚úÖ Found ${centersCount} damage centers\n\n`;
                
                if (centersCount === 0) {
                    output.innerHTML += '‚ö†Ô∏è No damage centers to migrate\n';
                    return;
                }
                
                // Migrate each damage center
                let migratedCount = 0;
                
                window.helper.damage_centers.forEach((center, index) => {
                    output.innerHTML += `\nüì¶ Processing Damage Center ${index + 1}: ${center.Location}\n`;
                    
                    // ===== MIGRATE PARTS =====
                    const parts = center.Parts?.parts_required || [];
                    if (parts.length > 0) {
                        // Calculate BEFORE (original price √ó quantity)
                        const totalBefore = parts.reduce((sum, part) => {
                            const pricePerUnit = parseFloat(part.price_per_unit) || 0;
                            const quantity = parseInt(part.quantity) || 1;
                            return sum + (pricePerUnit * quantity);
                        }, 0);
                        
                        // Calculate AFTER (with reductions/wear)
                        const totalAfter = parts.reduce((sum, part) => {
                            return sum + (parseFloat(part.total_cost) || 0);
                        }, 0);
                        
                        const differentials = totalBefore - totalAfter;
                        
                        // Update parts_meta
                        if (!center.Parts.parts_meta) center.Parts.parts_meta = {};
                        center.Parts.parts_meta.total_cost_before_differentials = totalBefore;
                        center.Parts.parts_meta.total_cost = totalAfter;
                        center.Parts.parts_meta.total_differentials_value = differentials;
                        center.Parts.parts_meta.total_items = parts.length;
                        
                        output.innerHTML += `  ‚úÖ Parts: Before=‚Ç™${totalBefore.toFixed(2)}, After=‚Ç™${totalAfter.toFixed(2)}, Diff=‚Ç™${differentials.toFixed(2)}\n`;
                    }
                    
                    // ===== MIGRATE WORKS =====
                    const works = center.Works?.works || [];
                    if (works.length > 0) {
                        const worksTotalCost = works.reduce((sum, work) => {
                            return sum + (parseFloat(work.cost) || 0);
                        }, 0);
                        
                        if (!center.Works.works_meta) center.Works.works_meta = {};
                        center.Works.works_meta.total_cost_before_differentials = worksTotalCost;
                        center.Works.works_meta.total_cost = worksTotalCost;
                        center.Works.works_meta.total_differentials_value = 0; // No differentials for works yet
                        center.Works.works_meta.total_items = works.length;
                        
                        output.innerHTML += `  ‚úÖ Works: ‚Ç™${worksTotalCost.toFixed(2)} (no differentials)\n`;
                    }
                    
                    // ===== MIGRATE REPAIRS =====
                    const repairs = center.Repairs?.repairs || [];
                    if (repairs.length > 0) {
                        const repairsTotalCost = repairs.reduce((sum, repair) => {
                            return sum + (parseFloat(repair.cost) || 0);
                        }, 0);
                        
                        if (!center.Repairs.repairs_meta) center.Repairs.repairs_meta = {};
                        center.Repairs.repairs_meta.total_cost_before_differentials = repairsTotalCost;
                        center.Repairs.repairs_meta.total_cost = repairsTotalCost;
                        center.Repairs.repairs_meta.total_differentials_value = 0; // No differentials for repairs yet
                        center.Repairs.repairs_meta.total_items = repairs.length;
                        
                        output.innerHTML += `  ‚úÖ Repairs: ‚Ç™${repairsTotalCost.toFixed(2)} (no differentials)\n`;
                    }
                    
                    migratedCount++;
                });
                
                // Also update helper.centers (internal wizard structure)
                if (window.helper.centers && Array.isArray(window.helper.centers)) {
                    window.helper.centers = window.helper.damage_centers;
                    output.innerHTML += `\n‚úÖ Synced to helper.centers\n`;
                }
                
                output.innerHTML += `\n‚úÖ Migrated ${migratedCount} damage centers\n`;
                
                // Now rebuild damage_assessment with new differentials
                output.innerHTML += `\nüèóÔ∏è Rebuilding damage_assessment with differentials...\n`;
                
                // Rebuild damage_assessment manually
                const vatRate = window.helper?.calculations?.vat_rate || 18;
                
                window.helper.damage_assessment = {
                    damage_centers_summary: {},
                    summary: {},
                    totals: {},
                    totals_after_differentials: {}
                };
                
                let summaryAccumulators = {
                    works: { before: 0, after: 0, diff: 0, count: 0 },
                    parts: { before: 0, after: 0, diff: 0, count: 0 },
                    repairs: { before: 0, after: 0, diff: 0, count: 0 }
                };
                
                let totalBeforeDifferentials = 0;
                let totalAfterDifferentials = 0;
                
                // Build damage_centers_summary
                window.helper.damage_centers.forEach((center, index) => {
                    const centerNumber = center["Damage center Number"] || (index + 1).toString();
                    const centerKey = `Damage center ${centerNumber}`;
                    
                    const worksData = {
                        before: parseFloat(center.Works?.works_meta?.total_cost_before_differentials || 0),
                        after: parseFloat(center.Works?.works_meta?.total_cost || 0),
                        diff: parseFloat(center.Works?.works_meta?.total_differentials_value || 0),
                        count: parseInt(center.Works?.works_meta?.total_items || 0)
                    };
                    
                    const partsData = {
                        before: parseFloat(center.Parts?.parts_meta?.total_cost_before_differentials || 0),
                        after: parseFloat(center.Parts?.parts_meta?.total_cost || 0),
                        diff: parseFloat(center.Parts?.parts_meta?.total_differentials_value || 0),
                        count: parseInt(center.Parts?.parts_meta?.total_items || 0)
                    };
                    
                    const repairsData = {
                        before: parseFloat(center.Repairs?.repairs_meta?.total_cost_before_differentials || 0),
                        after: parseFloat(center.Repairs?.repairs_meta?.total_cost || 0),
                        diff: parseFloat(center.Repairs?.repairs_meta?.total_differentials_value || 0),
                        count: parseInt(center.Repairs?.repairs_meta?.total_items || 0)
                    };
                    
                    const centerBeforeTotal = worksData.before + partsData.before + repairsData.before;
                    const centerAfterTotal = worksData.after + partsData.after + repairsData.after;
                    const centerDiffTotal = worksData.diff + partsData.diff + repairsData.diff;
                    const centerVAT = centerAfterTotal * (vatRate / 100);
                    const centerTotalWithVAT = centerAfterTotal + centerVAT;
                    
                    window.helper.damage_assessment.damage_centers_summary[centerKey] = {
                        "Works": {
                            "before_differentials": worksData.before,
                            "after_differentials": worksData.after,
                            "differentials_value": worksData.diff,
                            "items_count": worksData.count
                        },
                        "Parts": {
                            "before_differentials": partsData.before,
                            "after_differentials": partsData.after,
                            "differentials_value": partsData.diff,
                            "items_count": partsData.count
                        },
                        "Repairs": {
                            "before_differentials": repairsData.before,
                            "after_differentials": repairsData.after,
                            "differentials_value": repairsData.diff,
                            "items_count": repairsData.count
                        },
                        "Subtotal before differentials": centerBeforeTotal,
                        "Subtotal after differentials": centerAfterTotal,
                        "Total differentials value": centerDiffTotal,
                        "VAT amount": centerVAT,
                        "Total with VAT": centerTotalWithVAT
                    };
                    
                    summaryAccumulators.works.before += worksData.before;
                    summaryAccumulators.works.after += worksData.after;
                    summaryAccumulators.works.diff += worksData.diff;
                    summaryAccumulators.works.count += worksData.count;
                    
                    summaryAccumulators.parts.before += partsData.before;
                    summaryAccumulators.parts.after += partsData.after;
                    summaryAccumulators.parts.diff += partsData.diff;
                    summaryAccumulators.parts.count += partsData.count;
                    
                    summaryAccumulators.repairs.before += repairsData.before;
                    summaryAccumulators.repairs.after += repairsData.after;
                    summaryAccumulators.repairs.diff += repairsData.diff;
                    summaryAccumulators.repairs.count += repairsData.count;
                    
                    totalBeforeDifferentials += centerBeforeTotal;
                    totalAfterDifferentials += centerAfterTotal;
                });
                
                // Build summary
                window.helper.damage_assessment.summary = {
                    "Works": {
                        "before_differentials": summaryAccumulators.works.before,
                        "after_differentials": summaryAccumulators.works.after,
                        "differentials_value": summaryAccumulators.works.diff,
                        "items_count": summaryAccumulators.works.count
                    },
                    "Parts": {
                        "before_differentials": summaryAccumulators.parts.before,
                        "after_differentials": summaryAccumulators.parts.after,
                        "differentials_value": summaryAccumulators.parts.diff,
                        "items_count": summaryAccumulators.parts.count
                    },
                    "Repairs": {
                        "before_differentials": summaryAccumulators.repairs.before,
                        "after_differentials": summaryAccumulators.repairs.after,
                        "differentials_value": summaryAccumulators.repairs.diff,
                        "items_count": summaryAccumulators.repairs.count
                    }
                };
                
                const totalDifferentialsValue = totalBeforeDifferentials - totalAfterDifferentials;
                const vatAmount = totalAfterDifferentials * (vatRate / 100);
                const totalWithVAT = totalAfterDifferentials + vatAmount;
                
                // Build totals
                window.helper.damage_assessment.totals = {
                    "Total before differentials": totalBeforeDifferentials,
                    "Total after differentials": totalAfterDifferentials,
                    "Total differentials value": totalDifferentialsValue,
                    "VAT amount": vatAmount,
                    "Total with VAT": totalWithVAT,
                    "vat_rate": vatRate,
                    "last_updated": new Date().toISOString(),
                    "source": "migration_tool_wizard_data"
                };
                
                // Build totals_after_differentials
                window.helper.damage_assessment.totals_after_differentials = {
                    "Parts": {
                        "before": summaryAccumulators.parts.before,
                        "after": summaryAccumulators.parts.after,
                        "differentials": summaryAccumulators.parts.diff
                    },
                    "Works": {
                        "before": summaryAccumulators.works.before,
                        "after": summaryAccumulators.works.after,
                        "differentials": summaryAccumulators.works.diff
                    },
                    "Repairs": {
                        "before": summaryAccumulators.repairs.before,
                        "after": summaryAccumulators.repairs.after,
                        "differentials": summaryAccumulators.repairs.diff
                    },
                    "Combined": {
                        "before": totalBeforeDifferentials,
                        "after": totalAfterDifferentials,
                        "differentials": totalDifferentialsValue,
                        "vat": vatAmount,
                        "total_with_vat": totalWithVAT
                    }
                };
                
                output.innerHTML += `‚úÖ Rebuilt damage_assessment manually\n`;
                
                // Save back to sessionStorage
                sessionStorage.setItem('helper', JSON.stringify(window.helper));
                output.innerHTML += `‚úÖ Saved to sessionStorage\n\n`;
                
                // Show final damage_assessment
                const newSource = window.helper.damage_assessment?.totals?.source;
                const hasDifferentials = window.helper.damage_assessment?.totals?.["Total before differentials"] !== undefined;
                
                output.innerHTML += `\nüìä FINAL RESULT:\n`;
                output.innerHTML += `Source: ${newSource}\n`;
                output.innerHTML += `Has differentials: ${hasDifferentials ? '‚úÖ YES' : '‚ùå NO'}\n\n`;
                
                if (hasDifferentials) {
                    output.innerHTML += `damage_assessment.totals:\n`;
                    output.innerHTML += JSON.stringify(window.helper.damage_assessment.totals, null, 2);
                    output.innerHTML += `\n\nüéâ SUCCESS! Migration complete. Refresh the page to see changes.\n`;
                } else {
                    output.innerHTML += `‚ö†Ô∏è WARNING: Migration ran but differentials still not showing\n`;
                }
                
            } catch (error) {
                output.innerHTML += `\n‚ùå ERROR: ${error.message}\n`;
                output.innerHTML += error.stack;
                console.error(error);
            }
        }
    </script>
</body>
</html>
