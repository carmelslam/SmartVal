<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×‘×“×™×§×ª ××¢×¨×›×ª ×—×™×¤×•×© ×“×•××œ×™×ª</title>
    <style>
        body { font-family: Arial; margin: 20px; direction: rtl; }
        .test-section { background: #f5f5f5; padding: 15px; margin: 15px 0; border-radius: 8px; }
        .result { background: #e8f5e9; padding: 10px; margin: 10px 0; font-family: monospace; border-radius: 4px; }
        .error { background: #ffebee; border-left: 4px solid #f44336; }
        .success { background: #e8f5e9; border-left: 4px solid #4caf50; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .test-btn { background: #2196F3; color: white; }
        .clear-btn { background: #757575; color: white; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
        th { background: #f0f0f0; }
        input[type="text"] { width: 200px; padding: 5px; margin: 5px; }
    </style>
</head>
<body>
    <h1>ğŸ§ª ×‘×“×™×§×ª ××¢×¨×›×ª ×”×—×™×¤×•×© ×”×“×•××œ×™×ª</h1>
    <p>×‘×•×“×§ ×©-PARTS_BANK (× ×ª×•× ×™× ××§×•××™×™×) ×•-catalog_items (Supabase) ×¢×•×‘×“×™× × ×›×•×Ÿ</p>

    <!-- Test Section 1: Free Text Search -->
    <div class="test-section">
        <h3>ğŸ” 1. ×‘×“×™×§×ª ×—×™×¤×•×© ×—×•×¤×©×™ (Free Text Search)</h3>
        <p>×¦×¨×™×š ×œ×—×¤×© ×‘-catalog_items ×§×•×“×, ×•×× ×œ× × ××¦× - ×œ-PARTS_BANK</p>
        
        <input type="text" id="freeTextInput" placeholder="×”×§×œ×“ ×˜×§×¡×˜ ×œ×—×™×¤×•×© (×œ××©×œ: ×˜×•×™×•×˜×”, ×¤× ×¡, ×›× ×£)" value="×¤× ×¡">
        <button class="test-btn" onclick="testFreeTextSearch()">ğŸ” ×‘×“×•×§ ×—×™×¤×•×© ×—×•×¤×©×™</button>
        <button class="clear-btn" onclick="clearResults('freeTextResults')">× ×§×” ×ª×•×¦××•×ª</button>
        
        <div id="freeTextResults" class="result"></div>
    </div>

    <!-- Test Section 2: Advanced Search -->
    <div class="test-section">
        <h3>ğŸ¯ 2. ×‘×“×™×§×ª ×—×™×¤×•×© ××ª×§×“× (Advanced Search)</h3>
        <p>×¦×¨×™×š ×œ×—×¤×© ×‘-PARTS_BANK ×¢×‘×•×¨ part_group/part_name</p>
        
        <select id="partGroupSelect">
            <option value="">×‘×—×¨ ××©×¤×—×ª ×—×œ×§...</option>
            <option value="×¤× ×¡×™×">×¤× ×¡×™×</option>
            <option value="×“×œ×ª×•×ª">×“×œ×ª×•×ª</option>
            <option value="×¤×’×•×©×™×">×¤×’×•×©×™×</option>
            <option value="××¨××•×ª">××¨××•×ª</option>
            <option value="×–×›×•×›×™×•×ª">×–×›×•×›×™×•×ª</option>
            <option value="×‘×¨×–×œ×™×">×‘×¨×–×œ×™×</option>
        </select>
        
        <input type="text" id="partNameInput" placeholder="×©× ×—×œ×§ (××•×¤×¦×™×•× ×œ×™)" value="">
        <button class="test-btn" onclick="testAdvancedSearch()">ğŸ¯ ×‘×“×•×§ ×—×™×¤×•×© ××ª×§×“×</button>
        <button class="clear-btn" onclick="clearResults('advancedResults')">× ×§×” ×ª×•×¦××•×ª</button>
        
        <div id="advancedResults" class="result"></div>
    </div>

    <!-- Test Section 3: Data Source Verification -->
    <div class="test-section">
        <h3>ğŸ¦ 3. ×‘×“×™×§×ª ××§×•×¨×•×ª × ×ª×•× ×™×</h3>
        <p>×‘×•×“×§ ×©××™×“×¢ ×-PARTS_BANK ×•×-catalog_items ××•×‘×—×Ÿ ×‘×‘×™×¨×•×¨</p>
        
        <button class="test-btn" onclick="testDataSources()">ğŸ¦ ×‘×“×•×§ ××§×•×¨×•×ª × ×ª×•× ×™×</button>
        <button class="clear-btn" onclick="clearResults('dataSourceResults')">× ×§×” ×ª×•×¦××•×ª</button>
        
        <div id="dataSourceResults" class="result"></div>
    </div>

    <!-- Test Section 4: PiP Integration -->
    <div class="test-section">
        <h3>ğŸªŸ 4. ×‘×“×™×§×ª ××™× ×˜×’×¨×¦×™×” ×¢× PiP</h3>
        <p>×‘×•×“×§ ×©×ª×•×¦××•×ª ×”×—×™×¤×•×© ××•×¦×’×•×ª × ×›×•×Ÿ ×‘-PiP</p>
        
        <button class="test-btn" onclick="testPiPIntegration()">ğŸªŸ ×‘×“×•×§ PiP</button>
        <button class="clear-btn" onclick="clearResults('pipResults')">× ×§×” ×ª×•×¦××•×ª</button>
        
        <div id="pipResults" class="result"></div>
    </div>

    <!-- Load Dependencies -->
    <script src="./services/supabaseClient.js"></script>
    <script src="./parts.js"></script>
    <script src="./services/smartPartsSearchService.js"></script>
    <script src="./parts-search-results-pip.js"></script>

    <script>
        // Test utilities
        function clearResults(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        function formatResult(title, content, isError = false) {
            const className = isError ? 'result error' : 'result success';
            return `<div class="${className}"><h4>${title}</h4><pre>${content}</pre></div>`;
        }

        function formatTable(data, title) {
            if (!data || data.length === 0) return `<p>${title}: ××™×Ÿ × ×ª×•× ×™×</p>`;
            
            let html = `<h4>${title} (${data.length} ×ª×•×¦××•×ª):</h4><table>`;
            
            // Header
            const keys = Object.keys(data[0]);
            html += '<tr>';
            keys.forEach(key => html += `<th>${key}</th>`);
            html += '</tr>';
            
            // Rows (show first 5)
            data.slice(0, 5).forEach(row => {
                html += '<tr>';
                keys.forEach(key => {
                    const value = row[key] || '';
                    const displayValue = String(value).length > 30 ? String(value).substring(0, 30) + '...' : value;
                    html += `<td>${displayValue}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</table>';
            if (data.length > 5) {
                html += `<p>...×•×¢×•×“ ${data.length - 5} ×ª×•×¦××•×ª</p>`;
            }
            return html;
        }

        // Test 1: Free Text Search
        async function testFreeTextSearch() {
            const resultsDiv = document.getElementById('freeTextResults');
            const searchTerm = document.getElementById('freeTextInput').value.trim();
            
            if (!searchTerm) {
                resultsDiv.innerHTML = formatResult('×©×’×™××”', '× × ×œ×”×§×œ×™×“ ×˜×§×¡×˜ ×œ×—×™×¤×•×©', true);
                return;
            }

            resultsDiv.innerHTML = '<p>â³ ××‘×¦×¢ ×—×™×¤×•×© ×—×•×¤×©×™...</p>';

            try {
                // Initialize service
                const searchService = new window.SmartPartsSearchService();
                
                // Test free text search
                const result = await searchService.searchParts({
                    free_query: searchTerm
                });

                let report = `ğŸ” ×—×™×¤×•×© ×—×•×¤×©×™ ×¢×‘×•×¨: "${searchTerm}"\n\n`;
                report += `â±ï¸ ×–××Ÿ ×—×™×¤×•×©: ${result.searchTime || '×œ× ×–××™×Ÿ'} ms\n`;
                report += `âŒ ×©×’×™××•×ª: ${result.error ? result.error.message : '××™×Ÿ'}\n`;
                report += `ğŸ“Š ×ª×•×¦××•×ª: ${result.data ? result.data.length : 0}\n\n`;

                if (result.data && result.data.length > 0) {
                    // Analyze data sources
                    const sourceAnalysis = {
                        'PARTS_BANK': result.data.filter(item => item.source === 'PARTS_BANK').length,
                        'catalog_items': result.data.filter(item => item.source !== 'PARTS_BANK').length
                    };
                    
                    report += `ğŸ“ˆ × ×™×ª×•×— ××§×•×¨×•×ª:\n`;
                    report += `  - PARTS_BANK: ${sourceAnalysis.PARTS_BANK} ×ª×•×¦××•×ª\n`;
                    report += `  - catalog_items: ${sourceAnalysis.catalog_items} ×ª×•×¦××•×ª\n\n`;
                }

                let html = formatResult('×ª×•×¦××•×ª ×—×™×¤×•×© ×—×•×¤×©×™', report);
                
                if (result.data && result.data.length > 0) {
                    html += formatTable(result.data, '× ×ª×•× ×™× ××¤×•×¨×˜×™×');
                }

                resultsDiv.innerHTML = html;

            } catch (error) {
                resultsDiv.innerHTML = formatResult('×©×’×™××”', `×©×’×™××” ×‘×—×™×¤×•×©: ${error.message}`, true);
            }
        }

        // Test 2: Advanced Search
        async function testAdvancedSearch() {
            const resultsDiv = document.getElementById('advancedResults');
            const partGroup = document.getElementById('partGroupSelect').value;
            const partName = document.getElementById('partNameInput').value.trim();
            
            if (!partGroup && !partName) {
                resultsDiv.innerHTML = formatResult('×©×’×™××”', '× × ×œ×‘×—×•×¨ ××©×¤×—×ª ×—×œ×§ ××• ×œ×”×§×œ×™×“ ×©× ×—×œ×§', true);
                return;
            }

            resultsDiv.innerHTML = '<p>â³ ××‘×¦×¢ ×—×™×¤×•×© ××ª×§×“×...</p>';

            try {
                // Initialize service
                const searchService = new window.SmartPartsSearchService();
                
                // Test advanced search
                const result = await searchService.searchParts({
                    part_group: partGroup,
                    part_name: partName
                });

                let report = `ğŸ¯ ×—×™×¤×•×© ××ª×§×“×\n`;
                report += `  - ××©×¤×—×ª ×—×œ×§: ${partGroup || '×œ× ×¦×•×™×Ÿ'}\n`;
                report += `  - ×©× ×—×œ×§: ${partName || '×œ× ×¦×•×™×Ÿ'}\n\n`;
                report += `â±ï¸ ×–××Ÿ ×—×™×¤×•×©: ${result.searchTime || '×œ× ×–××™×Ÿ'} ms\n`;
                report += `âŒ ×©×’×™××•×ª: ${result.error ? result.error.message : '××™×Ÿ'}\n`;
                report += `ğŸ“Š ×ª×•×¦××•×ª: ${result.data ? result.data.length : 0}\n\n`;

                if (result.data && result.data.length > 0) {
                    // Should be mostly from PARTS_BANK for advanced search
                    const fromPartsBank = result.data.filter(item => item.source === 'PARTS_BANK').length;
                    report += `ğŸ“ˆ ××§×•×¨ × ×ª×•× ×™×:\n`;
                    report += `  - PARTS_BANK: ${fromPartsBank} ×ª×•×¦××•×ª (×¦×¤×•×™ ×œ×”×™×•×ª ×”×¨×•×‘)\n`;
                    report += `  - ××—×¨: ${result.data.length - fromPartsBank} ×ª×•×¦××•×ª\n\n`;
                }

                let html = formatResult('×ª×•×¦××•×ª ×—×™×¤×•×© ××ª×§×“×', report);
                
                if (result.data && result.data.length > 0) {
                    html += formatTable(result.data, '× ×ª×•× ×™× ××¤×•×¨×˜×™×');
                }

                resultsDiv.innerHTML = html;

            } catch (error) {
                resultsDiv.innerHTML = formatResult('×©×’×™××”', `×©×’×™××” ×‘×—×™×¤×•×©: ${error.message}`, true);
            }
        }

        // Test 3: Data Sources
        async function testDataSources() {
            const resultsDiv = document.getElementById('dataSourceResults');
            resultsDiv.innerHTML = '<p>â³ ×‘×•×“×§ ××§×•×¨×•×ª × ×ª×•× ×™×...</p>';

            try {
                let report = 'ğŸ¦ ×‘×“×™×§×ª ××§×•×¨×•×ª × ×ª×•× ×™×:\n\n';

                // Check PARTS_BANK
                if (window.PARTS_BANK) {
                    const categories = Object.keys(window.PARTS_BANK);
                    let totalParts = 0;
                    categories.forEach(cat => totalParts += window.PARTS_BANK[cat].length);
                    
                    report += `âœ… PARTS_BANK ×–××™×Ÿ:\n`;
                    report += `  - ${categories.length} ×§×˜×’×•×¨×™×•×ª\n`;
                    report += `  - ${totalParts} ×—×œ×§×™× ×‘×¡×š ×”×›×œ\n`;
                    report += `  - ×“×•×’×××•×ª ×§×˜×’×•×¨×™×•×ª: ${categories.slice(0, 3).join(', ')}\n\n`;
                } else {
                    report += `âŒ PARTS_BANK ×œ× ×–××™×Ÿ\n\n`;
                }

                // Check Supabase connection
                if (window.supabase) {
                    report += `âœ… Supabase client ×–××™×Ÿ\n`;
                    
                    try {
                        const { data, error } = await window.supabase
                            .from('catalog_items')
                            .select('id')
                            .limit(1);
                        
                        if (error) {
                            report += `  âŒ ×©×’×™××ª ×—×™×‘×•×¨: ${error.message}\n\n`;
                        } else {
                            report += `  âœ… ×—×™×‘×•×¨ ×ª×§×™×Ÿ ×œ×××’×¨ ×”× ×ª×•× ×™×\n`;
                            report += `  ğŸ“Š catalog_items × ×’×™×©\n\n`;
                        }
                    } catch (dbError) {
                        report += `  âŒ ×©×’×™××ª ×××’×¨ × ×ª×•× ×™×: ${dbError.message}\n\n`;
                    }
                } else {
                    report += `âŒ Supabase client ×œ× ×–××™×Ÿ\n\n`;
                }

                // Check SmartPartsSearchService
                if (window.SmartPartsSearchService) {
                    report += `âœ… SmartPartsSearchService ×–××™×Ÿ\n`;
                    const service = new window.SmartPartsSearchService();
                    report += `  - Session ID: ${service.getSessionId() || '×œ× ×”×•×’×“×¨'}\n\n`;
                } else {
                    report += `âŒ SmartPartsSearchService ×œ× ×–××™×Ÿ\n\n`;
                }

                resultsDiv.innerHTML = formatResult('×‘×“×™×§×ª ××§×•×¨×•×ª × ×ª×•× ×™×', report);

            } catch (error) {
                resultsDiv.innerHTML = formatResult('×©×’×™××”', `×©×’×™××” ×‘×‘×“×™×§×ª ××§×•×¨×•×ª: ${error.message}`, true);
            }
        }

        // Test 4: PiP Integration
        async function testPiPIntegration() {
            const resultsDiv = document.getElementById('pipResults');
            resultsDiv.innerHTML = '<p>â³ ×‘×•×“×§ ××™× ×˜×’×¨×¦×™×” ×¢× PiP...</p>';

            try {
                let report = 'ğŸªŸ ×‘×“×™×§×ª PiP:\n\n';

                // Check if PiP is available
                if (window.partsResultsPiP) {
                    report += `âœ… PiP component ×–××™×Ÿ\n`;
                    
                    // Create test data mixing both sources
                    const testResults = [
                        {
                            id: 'test-parts-bank-1',
                            pcode: 'PB-TEST123',
                            cat_num_desc: '×¤× ×¡ ×§×“××™ ×™××™×Ÿ',
                            part_family: '×¤× ×¡×™×',
                            make: '×›×œ×œ×™',
                            model: '×¨×‘ ×“×’××™×',
                            price: 350,
                            source: 'PARTS_BANK',
                            match_type: 'exact_match'
                        },
                        {
                            id: 'test-catalog-1',
                            pcode: 'CAT-456789',
                            cat_num_desc: 'Toyota Corolla Headlight',
                            part_family: 'Lights',
                            make: 'Toyota',
                            model: 'Corolla',
                            price: 280,
                            source: 'catalog_items',
                            supplier_name: 'AutoParts Ltd'
                        }
                    ];

                    // Show test results in PiP
                    await window.partsResultsPiP.showResults(testResults, {
                        plate: 'TEST-PiP-123',
                        sessionId: 'dual-search-test',
                        searchType: 'dual_system_test',
                        searchSuccess: true,
                        errorMessage: null,
                        searchTime: 150
                    });

                    report += `âœ… PiP × ×¤×ª×— ×‘×”×¦×œ×—×” ×¢× × ×ª×•× ×™ ×‘×“×™×§×”\n`;
                    report += `ğŸ“Š ×”×•×¦×’×• ${testResults.length} ×ª×•×¦××•×ª ××‘×“×™×§×”\n`;
                    report += `  - 1 ××ª×•×š PARTS_BANK\n`;
                    report += `  - 1 ××ª×•×š catalog_items\n\n`;
                    report += `ğŸ‘€ ×‘×“×•×§ ×©×”×—×œ×•×Ÿ PiP × ×¨××” ×¢×œ ×”××¡×š\n`;
                    
                } else {
                    report += `âŒ PiP component ×œ× ×–××™×Ÿ\n`;
                    report += `ğŸ”§ × ×“×¨×© ×œ×˜×¢×•×Ÿ ××ª parts-search-results-pip.js\n\n`;
                }

                resultsDiv.innerHTML = formatResult('×‘×“×™×§×ª PiP', report);

            } catch (error) {
                resultsDiv.innerHTML = formatResult('×©×’×™××”', `×©×’×™××” ×‘×‘×“×™×§×ª PiP: ${error.message}`, true);
            }
        }

        // Initialize page
        window.addEventListener('load', () => {
            console.log('ğŸ§ª Test page loaded');
            console.log('ğŸ“¦ Available components:');
            console.log('  - PARTS_BANK:', !!window.PARTS_BANK);
            console.log('  - supabase:', !!window.supabase);
            console.log('  - SmartPartsSearchService:', !!window.SmartPartsSearchService);
            console.log('  - partsResultsPiP:', !!window.partsResultsPiP);
        });
    </script>
</body>
</html>