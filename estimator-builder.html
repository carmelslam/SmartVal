<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>××•××“×Ÿ × ×–×§×™ ×¨×›×‘ - ×™×¨×•×Ÿ ×›×™×•×£</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" type="image/webp">
  <style>
    /* Base Styles - Exact copy from original */
    body {
      font-family: sans-serif;
      background: #f3f6fb;
      margin: 0;
      min-height: 100vh;
      padding: 0;
      padding-top: 90px;
      overflow-x: hidden;
    }
    
    .container {
      width: 100%;
      max-width: 820px;
      min-width: 320px;
      background: #fff;
      padding: 32px 24px 24px 24px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.08);
      margin: 32px auto 32px auto;
      box-sizing: border-box;
    }
    
    .logo {
      display: flex;
      justify-content: center;
      margin-bottom: 8px;
    }
    
    .logo img {
      width: 112px;
      height: auto;
      display: block;
    }
    
    .title { 
      font-size: 27px; 
      font-weight: bold; 
      text-align: center; 
      margin-bottom: 2px; 
      font-weight: 900;
    }
    
    .subtitle { 
      font-size: 23px; 
      color: #666; 
      text-align: center; 
      margin-bottom: 10px;
    }
    
    h1, h2 { 
      color: #1e3a8a; 
      font-size: 25px; 
      text-align: center; 
      margin: 15px 0 8px 0; 
      font-weight: 600;
    }
    
    h3 { 
      color: #1e3a8a; 
      font-size: 22px; 
      margin: 22px 0 12px 0; 
      text-align: right; 
      font-weight: 900;
    }
    
    .form-section {
      width: 100%;
      max-width: 100%;
      margin-bottom: 20px;
      background: #fafbfe;
      border-radius: 12px;
      padding: 17px 15px 12px 15px;
      box-sizing: border-box;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      overflow: hidden;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px 18px;
      width: 100%;
    }
    
    @media (max-width: 600px) {
      .form-grid { 
        grid-template-columns: 1fr; 
      }
      .container {
        width: 98vw;
        max-width: 98vw;
        min-width: 0;
        padding: 14px 2vw 20px 2vw;
      }
    }
    
    label {
      font-size: 18px;
      margin-bottom: 4px;
      display: block;
      text-align: right;
    }
    
    input, select, textarea {
      width: 100%;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 0px;
      padding: 8px 9px;
      box-sizing: border-box;
      text-align: right !important;
      background: #f9f9f9;
      transition: border .15s;
      outline: none;
    }
    
    input:focus, select:focus, textarea:focus {
      border-color: #3b82f6;
    }
    
    input[type="radio"] {
      width: auto;
      margin-left: 10px;
      margin-right: 5px;
    }
    
    .readonly-box {
      background: #f4f6fa;
      border-radius: 6px;
      border: 1px solid #eee;
      padding: 7px 8px;
      min-height: 20px;
      font-size: 16px;
      color: #333;
      text-align: right !important;
    }
    
    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      display: block;
    }

    .btn.add {
      background: #3ea74b;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 14px;
      display: inline-block;
      margin-top: 10px;
    }

    .btn.add:hover {
      background: #359a3e;
    }

    .btn.remove {
      background: #dc3545;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }

    .btn.remove:hover {
      background: #c82333;
    }
    
    .collapsible-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 1px solid #dee2e6;
      border-radius: 8px;
      text-align: right;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 10px;
    }
    
    .collapsible-btn:hover {
      background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    }

    /* Floating Screens Styling */
    .floating-toggles-top {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 8px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .toggle-square {
      width: 80px;
      height: 70px;
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%) !important;
      background-image: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%) !important;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: white;
      text-align: center;
      border: 2px solid transparent;
    }

    .toggle-square::before,
    .toggle-square::after {
      display: none !important;
      content: none !important;
    }

    .toggle-square:hover {
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%) !important;
      background-image: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%) !important;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .toggle-square.active {
      border-color: #fbbf24;
      background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%) !important;
      background-image: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%) !important;
    }

    .toggle-square span:first-child {
      font-size: 24px;
      margin-bottom: 4px;
    }

    .toggle-square span:last-child {
      font-size: 12px;
    }
    
    /* Depreciation Styles */
    #depreciationBulkTable {
      margin-top: 15px;
    }

    #depreciationBulkTable .dep-row {
      display: grid;
      grid-template-columns: 1fr 1fr 120px 120px 80px;
      gap: 14px;
      margin-bottom: 10px;
      align-items: center;
      position: relative;
      padding-bottom: 10px;
    }

    #depreciationBulkTable .dep-row::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: #e5e7eb;
    }

    #depreciationBulkTable .dep-row > div::before {
      font-weight: bold;
      font-size: 12px;
      margin-bottom: 4px;
    }

    #depreciationBulkTable .dep-row > div:nth-child(1)::before {
      content: "×”×—×œ×§ ×”× ×™×–×•×§:";
    }

    #depreciationBulkTable .dep-row > div:nth-child(2)::before {
      content: "××”×•×ª ×”×ª×™×§×•×Ÿ:";
    }

    #depreciationBulkTable .dep-row > div:nth-child(3)::before {
      content: "% ×™×¨×™×“×ª ×¢×¨×š:";
    }

    #depreciationBulkTable .dep-row > div:nth-child(4)::before {
      content: "×¢×¨×š ×‘-â‚ª:";
    }

    #depreciationBulkTable .dep-row > div:nth-child(5)::before {
      content: "×¤×¢×•×œ×•×ª:";
    }

    @media (max-width: 600px) {
      #depreciationBulkTable .dep-row {
        grid-template-columns: 1fr;
        gap: 8px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 10px;
      }
      
      #depreciationBulkTable .dep-row > div::before {
        display: block;
      }
    }
    
    /* Damage Center Styles */
    .damage-center-card {
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .damage-center-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e5e7eb;
    }

    .damage-center-header h4 {
      margin: 0;
      color: #1e3a8a;
      font-size: 18px;
    }

    /* Summary Styles */
    .summary-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    @media (max-width: 768px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Floating PDF Styles */
    .floating-pdf-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .floating-pdf-container {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 1200px;
      height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .floating-pdf-header {
      background: #1e3a8a;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    
    .floating-pdf-header h3 {
      margin: 0;
      font-size: 18px;
      color: white;
    }
    
    .floating-pdf-controls {
      display: flex;
      gap: 10px;
    }
    
    .floating-pdf-content {
      flex: 1;
      padding: 0;
      overflow: hidden;
    }

    /* PIP Styles */
    .pip-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 320px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      z-index: 10000;
      display: none;
    }

    .pip-header {
      background: #1e3a8a;
      color: white;
      padding: 10px 15px;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: move;
    }

    .pip-content {
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
    }

    /* Adjustment Row Styles */
    .adjustment-row {
      display: grid;
      grid-template-columns: 2fr 100px 100px 120px 80px;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
    }

    .adjustment-row input,
    .adjustment-row select {
      background: white;
    }

    /* Success/Error Messages */
    .section-message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      z-index: 9999;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }

    .section-message.success {
      background: #10b981;
      color: white;
    }

    .section-message.error {
      background: #ef4444;
      color: white;
    }

    /* Action Buttons Container */
    .action-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }

    .action-buttons .btn {
      padding: 12px 20px;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .action-buttons .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .action-buttons .btn-primary:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .action-buttons .btn-secondary {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    }

    .action-buttons .btn-secondary:hover {
      background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
    }

    .action-buttons .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .action-buttons .btn-success:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    /* AGGRESSIVE: Force remove any debug mesh patterns */
    .floating-toggles-top *,
    .floating-toggles-top *::before,
    .floating-toggles-top *::after,
    .toggle-square,
    .toggle-square::before,
    .toggle-square::after {
      background-image: none !important;
      background: none !important;
    }
    
    .floating-toggles-top .toggle-square {
      background-image: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%) !important;
    }
    
    .floating-toggles-top .toggle-square:hover {
      background-image: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%) !important;
    }
    
    .floating-toggles-top .toggle-square.active {
      background-image: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%) !important;
    }

    /* Anti-mesh classes applied by JavaScript */
    .no-mesh-before::before {
      display: none !important;
      content: none !important;
      background: none !important;
      background-image: none !important;
    }

    .no-mesh-after::after {
      display: none !important;
      content: none !important;
      background: none !important;
      background-image: none !important;
    }
  </style>
</head>
<body>
  <!-- Floating Toggles -->
  <div class="floating-toggles-top">
    <div class="toggle-square" onclick="toggleFloatingScreen('levi')">
      <span>ğŸ“„</span>
      <span>×œ×•×™ ×™×¦×—×§</span>
    </div>
    <div class="toggle-square" onclick="toggleFloatingScreen('carDetails')">
      <span>ğŸš—</span>
      <span>×¤×¨×˜×™ ×¨×›×‘</span>
    </div>
    <div class="toggle-square" onclick="toggleFloatingScreen('parts')">
      <span>ğŸ”§</span>
      <span>×—×œ×§×™×</span>
    </div>
    <div class="toggle-square" onclick="toggleFloatingScreen('invoice')">
      <span>ğŸ“‹</span>
      <span>×—×©×‘×•× ×™×ª</span>
    </div>
  </div>

  <div class="container">
    <div class="logo"><img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo"></div>
    <div class="title">×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×¤×•×¨×˜×œ</div>
    <div class="subtitle">×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</div>
    
    <h1>×‘× ×™×™×ª ××•××“×Ÿ × ×–×§×™ ×¨×›×‘</h1>
    <h2 id="pageTitle">×¨×›×‘ ××¡. ...</h2>

    <!-- Estimate Type Section -->
    <div class="form-section" id="estimate-type">
      <h3>×¡×•×’ ×”××•××“×Ÿ</h3>
      <div>
        <label>
          <input type="radio" name="estimate-type" value="××•×‘×“×Ÿ_×œ×”×œ×›×”" checked> ××•××“×Ÿ ×¨××©×•× ×™ - ××•×‘×“×Ÿ ×œ×”×œ×›×”
        </label>
        <label>
          <input type="radio" name="estimate-type" value="×˜×•×˜×œ×•×¡"> ××•××“×Ÿ ×¨××©×•× ×™ - ×˜×•×˜×œ×•×¡
        </label>
      </div>
    </div>

    <!-- Vehicle Data Section -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('vehicleData')">× ×ª×•× ×™ ×¨×›×‘ (×”×¦×’/×”×¡×ª×¨)</button>
      <div id="vehicleData" style="display:none;">
        <div class="form-grid">
          <div><label>××¡×¤×¨ ×¨×›×‘:</label><input type="text" id="carPlate" onchange="updateHelperFromField(event);" /></div>
          <div><label>×ª×•×¦×¨×ª:</label><input type="text" id="carManufacturer" onchange="updateHelperFromField(event);" /></div>
          <div><label>×“×’×:</label><input type="text" id="carModel" onchange="updateHelperFromField(event);" /></div>
          <div><label>×©× ×ª ×™×™×¦×•×¨:</label><input type="text" id="carYear" onchange="updateHelperFromField(event);" /></div>
          <div><label>×§×•×“ ×“×’×:</label><input type="text" id="carModelCode" onchange="updateHelperFromField(event);" /></div>
          <div><label>××—×™×¨ ×‘×¡×™×¡:</label><input type="text" id="carBasePrice" onchange="updateHelperFromField(event);" /></div>
          <div><label>×¢×¨×š ×”×©×•×§ ×©×œ ×”×¨×›×‘:</label><input type="text" id="carMarketValue" onchange="updateHelperFromField(event);" /></div>
          <div><label>×ª××¨×™×š ×”×¤×§×”:</label><input type="date" id="carReportDate" onchange="updateHelperFromField(event);" /></div>
        </div>
        <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
          <button type="button" class="btn save-btn" onclick="saveVehicleDataWithFeedback(event)" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">×©××•×¨</button>
        </div>
        <div style="text-align: center; margin-top: 10px;">
          <button type="button" class="btn section-collapse-button" onclick="toggleSection('vehicleData')" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">×›×•×•×¥ ×¡×¢×™×£</button>
        </div>
      </div>
    </div>

    <!-- Contact Data Section -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('contactData')">× ×ª×•× ×™ ×”×ª×§×©×¨×•×ª (×”×¦×’/×”×¡×ª×¨)</button>
      <div id="contactData" style="display:none;">
        <div class="form-grid">
          <div><label>×©× ×‘×¢×œ ×”×¨×›×‘:</label><input type="text" id="ownerName" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>×›×ª×•×‘×ª ×‘×¢×œ ×”×¨×›×‘:</label><input type="text" id="ownerAddress" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>×˜×œ×¤×•×Ÿ ×‘×¢×œ ×”×¨×›×‘:</label><input type="text" id="ownerPhone" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>×—×‘×¨×ª ×‘×™×˜×•×—:</label><input type="text" id="insuranceCompany" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>××™××™×™×œ ×—×‘×¨×ª ×‘×™×˜×•×—:</label><input type="text" id="insuranceEmail" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>×¡×•×›×Ÿ ×‘×™×˜×•×—:</label><input type="text" id="insuranceAgent" onchange="updateHelperFromContactField(this); triggerFloatingScreenRefresh();" /></div>
          <div><label>×˜×œ×¤×•×Ÿ ×¡×•×›×Ÿ ×‘×™×˜×•×—:</label><input type="text" id="agentPhone" onchange="updateHelperFromContactField(this); triggerFloatingScreenRefresh();" /></div>
          <div><label>××™××™×™×œ ×¡×•×›×Ÿ ×‘×™×˜×•×—:</label><input type="text" id="agentEmail" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>×©× ××•×¡×š:</label><input type="text" id="garageName" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>×˜×œ×¤×•×Ÿ ××•×¡×š:</label><input type="text" id="garagePhone" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>××™××™×™×œ ××•×¡×š:</label><input type="text" id="garageEmail" onchange="updateHelperFromContactField(this);" /></div>
        </div>
        <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
          <button type="button" class="btn save-btn" onclick="saveContactDataWithFeedback(event)" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">×©××•×¨</button>
        </div>
        <div style="text-align: center; margin-top: 10px;">
          <button type="button" class="btn section-collapse-button" onclick="toggleSection('contactData')" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">×›×•×•×¥ ×¡×¢×™×£</button>
        </div>
      </div>
    </div>

    <!-- DAMAGE CENTERS SUMMARY SECTION - EDITABLE -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('damageCentersSummary')">×¡×™×›×•× ××•×§×“×™ × ×–×§ (×”×¦×’/×”×¡×ª×¨)</button>
      <div id="damageCentersSummary" style="display:none;">
        <h3>×¡×™×›×•× ××•×§×“×™ × ×–×§ (× ×™×ª×Ÿ ×œ×¢×¨×™×›×”)</h3>
        <div style="background: #f8f9fa; border-radius: 6px; padding: 15px; min-height: 50px;" id="damageCentersContent">
          <div style="color: #666; text-align: center;">×˜×•×¢×Ÿ × ×ª×•× ×™ ××•×§×“×™ × ×–×§...</div>
        </div>
        <!-- Buttons will be added dynamically after the totals -->
        <div id="damageCenterButtons" style="display: none;">
          <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
            <button type="button" class="save-btn" onclick="saveDamageCenterChangesWithFeedback(event)" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">×©××•×¨</button>
            <button type="button" onclick="addNewDamageCenter()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">×”×•×¡×£ ××•×§×“ × ×–×§ ×—×“×©</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Gross Market Value Section -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('grossCalc')">×¢×¨×š ×”×¨×›×‘ ×”×’×•×œ××™ - ×××¤×™×™× ×™× ×•×¢×œ×™×” ×œ×›×‘×™×© ×‘×œ×‘×“ (×”×¦×’/×”×¡×ª×¨)</button>
      <div id="grossCalc" style="display:none;">
        <div class="form-grid">
          <div><label>×¢×¨×š ×”×¨×›×‘ ×¢"×¤ ××—×™×¨×•×Ÿ ×›×•×œ×œ ××¢"×:</label><input type="text" id="basicPrice" placeholder="â‚ª" /></div>
          <div></div>
        </div>
        
        <!-- Features Adjustments -->
        <div style="margin-top: 20px;">
          <h4 style="color: #1e3a8a; margin-bottom: 10px;">×ª×•×¡×¤×•×ª ×××¤×™×™× ×™× (×ª×›×•× ×•×ª ×”×¨×›×‘):</h4>
          <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
            ×ª×•×¡×¤×•×ª ×”×§×©×•×¨×•×ª ×œ×ª×›×•× ×•×ª ×¤×™×–×™×•×ª ×©×œ ×”×¨×›×‘ ×¢×¦××•
          </div>
          <div id="featuresAdjustments">
            <div style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr 80px; gap:10px; margin-bottom:8px;">
              <div><label>×ª×™××•×¨:</label></div>
              <div><label>×¡×•×’:</label></div>
              <div><label>××—×•×–:</label></div>
              <div><label>×¢×¨×š:</label></div>
              <div><label>×¤×¢×•×œ×•×ª:</label></div>
            </div>
            <div id="featuresAdjustmentsList"></div>
            <div id="grossFeaturesCumulative" style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-weight: bold; text-align: center;">
              ×¢×¨×š ×œ××—×¨ ×ª×•×¡×¤×•×ª ×××¤×™×™× ×™×: <span style="color: #28a745;">â‚ª0</span>
            </div>
            <button class="btn add" type="button" onclick="addFeatureAdjustment()">×”×•×¡×£ ×ª×•×¡×¤×ª ×××¤×™×™×Ÿ</button>
          </div>
        </div>
        
        <!-- Registration Adjustments -->
        <div style="margin-top: 20px;">
          <h4 style="color: #1e3a8a; margin-bottom: 10px;">×¢×œ×™×” ×œ×›×‘×™×© (×ª××¨×™×š ×¨×™×©×•×):</h4>
          <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
            ×”×ª×××•×ª ×‘×’×™×Ÿ ×ª××¨×™×š ×¨×™×©×•× ×”×¨×›×‘ (×××¤×™×™×Ÿ ×§×‘×•×¢ ×©×œ ×”×¨×›×‘)
          </div>
          <div id="registrationAdjustments">
            <div style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr 80px; gap:10px; margin-bottom:8px;">
              <div><label>×ª×™××•×¨:</label></div>
              <div><label>×¡×•×’:</label></div>
              <div><label>××—×•×–:</label></div>
              <div><label>×¢×¨×š:</label></div>
              <div><label>×¤×¢×•×œ×•×ª:</label></div>
            </div>
            <div id="registrationAdjustmentsList"></div>
            <div id="grossRegistrationCumulative" style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-weight: bold; text-align: center;">
              ×¢×¨×š ×œ××—×¨ ×¢×œ×™×” ×œ×›×‘×™×©: <span style="color: #28a745;">â‚ª0</span>
            </div>
            <button class="btn add" type="button" onclick="addRegistrationAdjustment()">×”×•×¡×£ ×ª×•×¡×¤×ª ×¢×œ×™×” ×œ×›×‘×™×©</button>
          </div>
        </div>
        
        <!-- Gross Market Value Result -->
        <div style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px; border: 2px solid #4a90e2;">
          <div class="form-grid">
            <div><label><strong>×¢×¨×š ×”×¨×›×‘ ×œ× ×–×§ ×’×•×œ××™ ×›×•×œ×œ ××¢"×:</strong></label><input type="text" id="grossMarketValueResult" style="background: #f8f9fa; font-weight: bold;" readonly /></div>
            <div></div>
          </div>
        </div>
        <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
          <button type="button" onclick="saveGrossValueWithFeedback(event)" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">×©××•×¨</button>
        </div>
        <div style="text-align: center; margin-top: 10px;">
          <button type="button" class="btn section-collapse-button" onclick="toggleSection('grossCalc')" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">×›×•×•×¥ ×¡×¢×™×£</button>
        </div>
      </div>
    </div>

    <!-- Gross Damage Percentage Section -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('grossPercentageResult')">××—×•×– ×”× ×–×§ ×”×’×•×œ××™ - ×‘×¡×™×¡ ×”×¨×›×‘ ×‘×œ×‘×“ (×”×¦×’/×”×¡×ª×¨)</button>
      <div id="grossPercentageResult" style="display:none;">
        <div class="form-grid">
          <div>
            <label>×¡×”"×› ×¢×œ×•×ª × ×–×§ ××•×¢×¨×›×ª:</label>
            <input type="text" id="totalDamageCost" readonly />
          </div>
          <div>
            <label>×¢×¨×š ×”×¨×›×‘ ×”×’×•×œ××™:</label>
            <input type="text" id="grossValueDisplay" readonly />
          </div>
          <div>
            <label>××—×•×– ×”× ×–×§ ×”×’×•×œ××™:</label>
            <input type="text" id="grossDamagePercentage" readonly style="font-weight: bold; font-size: 18px; color: #1e3a8a;" />
          </div>
        </div>
        <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
          <button type="button" class="btn save-btn" onclick="saveGrossPercentageWithFeedback(event)" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">×©××•×¨</button>
        </div>
        <div style="text-align: center; margin-top: 10px;">
          <button type="button" class="btn section-collapse-button" onclick="toggleSection('grossPercentageResult')" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">×›×•×•×¥ ×¡×¢×™×£</button>
        </div>
      </div>
    </div>

    <!-- Full Market Value Section -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('fullMarketValue')">×¢×¨×š ×”×©×•×§ ×”××œ× - ×›×•×œ×œ ×’×•×¨××™ ×©×™××•×© (×”×¦×’/×”×¡×ª×¨)</button>
      <div id="fullMarketValue" style="display:none;">
        <h4>×”×ª×××•×ª × ×•×¡×¤×•×ª (×’×•×¨××™ ×©×™××•×©)</h4>
        <div id="allAdjustmentsList"></div>
        <button type="button" class="btn btn-secondary" onclick="autoPopulateMarketAdjustments()">×˜×¢×Ÿ ×”×ª×××•×ª ××“×•×— ×œ×•×™</button>
        <button type="button" class="btn btn-secondary" onclick="addFullMarketAdjustment()">+ ×”×•×¡×£ ×”×ª×××” ×™×“× ×™×ª</button>
        
        <div class="summary-grid" style="margin-top: 20px; background: #f0f9ff; padding: 15px; border-radius: 8px;">
          <div>
            <label>×¢×¨×š ×”×©×•×§ ×”××œ×:</label>
            <input type="text" id="fullMarketValueField" readonly style="background: white; font-weight: bold;">
          </div>
          <div>
            <label>×¡×”"×› ×”×ª×××•×ª:</label>
            <input type="text" id="totalAdjustmentsValue" readonly />
          </div>
        </div>
        <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
          <button type="button" class="btn save-btn" onclick="saveFullMarketValueWithFeedback(event)" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">×©××•×¨</button>
        </div>
        <div style="text-align: center; margin-top: 10px;">
          <button type="button" class="btn section-collapse-button" onclick="toggleSection('fullMarketValue')" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">×›×•×•×¥ ×¡×¢×™×£</button>
        </div>
      </div>
    </div>

    <!-- Depreciation Section -->
    <div class="form-section" id="depreciationSection">
      <button class="collapsible-btn" type="button" onclick="toggleSection('depreciationContent')">×—×™×©×•×‘ ×™×¨×™×“×ª ×¢×¨×š ×œ×¤×™ ××•×§×“×™ × ×–×§ (×”×¦×’/×”×¡×ª×¨)</button>
      <div id="depreciationContent" style="display:none;">
        <h3>×—×™×©×•×‘ ×™×¨×™×“×ª ×¢×¨×š ×œ×¤×™ ××•×§×“×™ × ×–×§</h3>
        <div id="depreciationBulkTable"></div>
        <button type="button" class="btn btn-secondary" onclick="addDepField()">+ ×”×•×¡×£ ×©×•×¨×”</button>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px;">
          <div>
            <label>×™×¨×™×“×ª ×¢×¨×š ×›×•×œ×œ×ª (%):</label>
            <input type="number" id="globalDep1" placeholder="0" onchange="updateGlobalDepreciationCalculation();" />
          </div>
          <div>
            <label>×™×¨×™×“×ª ×¢×¨×š ×›×•×œ×œ×ª (â‚ª):</label>
            <input type="text" id="globalDepValue" readonly />
          </div>
        </div>
        
        <div style="margin-top:14px;">
          <label>×™××™ ××•×¡×š ××©×•×¢×¨×™×:</label>
          <input type="number" id="garageDays" placeholder="××¡×¤×¨ ×™××™ ×¢×‘×•×“×”" style="width: 200px;" onchange="updateHelperDepreciationField(this, 'work_days_impact');" />
        </div>
        
        <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
          <button type="button" class="btn save-btn" onclick="saveDepreciationData()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">×©××•×¨ × ×ª×•× ×™ ×™×¨×™×“×ª ×¢×¨×š</button>
        </div>
        <div style="text-align: center; margin-top: 10px;">
          <button type="button" class="btn section-collapse-button" onclick="toggleSection('depreciationContent')" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">×›×•×•×¥ ×¡×¢×™×£</button>
        </div>
      </div>
    </div>

    <!-- Claims Data Section -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('priceData')">× ×ª×•× ×™ ×ª×‘×™×¢×” (×”×¦×’/×”×¡×ª×¨)</button>
      <div id="priceData" style="display:none;">
        <h3>× ×ª×•× ×™ ×ª×‘×™×¢×”</h3>
        <div class="form-grid">
          <div>
            <label>×¡×”"×› ×ª×‘×™×¢×”:</label>
            <input type="text" id="totalClaim" readonly />
          </div>
          <div>
            <label>×ª×‘×™×¢×” ×××•×©×¨×ª:</label>
            <input type="text" id="authorizedClaim" placeholder="â‚ª" onchange="updateClaimsDataFromField(this, 'authorized_claim');" />
          </div>
          <div>
            <label>×™×¨×™×“×ª ×¢×¨×š:</label>
            <input type="text" id="depreciationClaim" placeholder="â‚ª" onchange="updateClaimsDataFromField(this, 'depreciation');" />
          </div>
          <div>
            <label>×”×¤×¨×© ×ª×‘×™×¢×”:</label>
            <input type="text" id="claimDifference" placeholder="â‚ª" onchange="updateClaimsDataFromField(this, 'claim_difference');" />
          </div>
        </div>
        <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
          <button type="button" class="btn save-btn" onclick="saveWithFeedback(event, 'claims')" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">×©××•×¨</button>
        </div>
        <div style="text-align: center; margin-top: 10px;">
          <button type="button" class="btn section-collapse-button" onclick="toggleSection('priceData')" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">×›×•×•×¥ ×¡×¢×™×£</button>
        </div>
      </div>
    </div>

    <!-- Summary Section -->
    <div class="form-section" style="background: linear-gradient(135deg, #ff8c00 0%, #ff7300 100%); color: white; border-radius: 12px; padding: 20px;">
      <h3 style="color: white; text-align: center; font-size: 24px; margin-bottom: 20px;">×¡×™×›×•× ××•××“×Ÿ</h3>
      <div class="summary-grid">
        <div style="text-align: center;">
          <label style="color: #ffe4b5; font-size: 14px;">×©×•×•×™ ×¨×›×‘:</label>
          <div id="sumMarketValue" style="font-size: 28px; font-weight: bold;">â‚ª0</div>
        </div>
        <div style="text-align: center;">
          <label style="color: #ffe4b5; font-size: 14px;">×¡×”×´×› ×ª×‘×™×¢×”:</label>
          <div id="sumClaim" style="font-size: 28px; font-weight: bold;">â‚ª0</div>
        </div>
        <div style="text-align: center;">
          <label style="color: #ffe4b5; font-size: 14px;">××¢×´×:</label>
          <div id="sumVAT" style="font-size: 28px; font-weight: bold;">â‚ª0</div>
        </div>
        <div style="text-align: center;">
          <label style="color: #ffe4b5; font-size: 14px;">×¡×”×´×› ×›×•×œ×œ ××¢×´×:</label>
          <div id="sumTotalClaim" style="font-size: 28px; font-weight: bold;">â‚ª0</div>
        </div>
        <div style="text-align: center;">
          <label style="color: #ffe4b5; font-size: 14px;">×™×¨×™×“×ª ×¢×¨×š:</label>
          <div id="depCompensation" style="font-size: 28px; font-weight: bold;">â‚ª0</div>
        </div>
        <div style="text-align: center;">
          <label style="color: #ffe4b5; font-size: 14px;">××—×•×– ×”× ×–×§:</label>
          <div id="damagePercentage" style="font-size: 28px; font-weight: bold;">0%</div>
        </div>
      </div>
    </div>

    <!-- Additional Notes Section -->
    <div class="form-section">
      <h3>×”×¢×¨×•×ª × ×•×¡×¤×•×ª ×œ××•××“×Ÿ</h3>
      <textarea id="additional-notes" rows="4" placeholder="×”×›× ×¡ ×”×¢×¨×•×ª × ×•×¡×¤×•×ª ×›××Ÿ..." onchange="updateHelperFromField(event);"></textarea>
      <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
        <button type="button" class="btn save-btn" onclick="saveWithFeedback(event, 'notes')" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">×©××•×¨</button>
      </div>
    </div>

    <!-- Legal Text Section -->
    <div class="form-section" id="legal-text">
      <h3>×˜×§×¡×˜ ××©×¤×˜×™ ×œ××•××“×Ÿ</h3>
      <select id="legal-text-selector" onchange="loadLegalTextFromVault();">
        <option value="">×‘×—×¨ ×˜×§×¡×˜ ××©×¤×˜×™...</option>
      </select>
      <textarea id="legal-text-content" rows="6" placeholder="×”×˜×§×¡×˜ ×”××©×¤×˜×™ ×™×•×˜×¢×Ÿ ×›××Ÿ..." onchange="updateHelperFromField(event);"></textarea>
      <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
        <button type="button" class="btn save-btn" onclick="saveWithFeedback(event, 'legal-text')" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">×©××•×¨</button>
        <button type="button" class="btn btn-secondary" onclick="resetLegalText()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">××™×¤×•×¡ ×˜×§×¡×˜</button>
      </div>
    </div>

    <!-- Attachments Section -->
    <div class="form-section" id="attachments-section">
      <h3>×¨×©×™××ª × ×¡×¤×—×™×</h3>
      <select id="attachments-selector" onchange="loadAttachmentsFromVault();">
        <option value="">×‘×—×¨ ×¨×©×™××ª × ×¡×¤×—×™×...</option>
      </select>
      <textarea id="attachments-list" rows="4" placeholder="×¨×©×™××ª ×”× ×¡×¤×—×™× ×ª×•×˜×¢×Ÿ ×›××Ÿ..." onchange="updateHelperFromField(event);"></textarea>
      <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
        <button type="button" class="btn save-btn" onclick="saveWithFeedback(event, 'attachments')" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">×©××•×¨</button>
        <button type="button" class="btn btn-secondary" onclick="resetAttachments()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">××™×¤×•×¡ × ×¡×¤×—×™×</button>
      </div>
    </div>

    <!-- VAT Settings Section -->
    <div class="form-section" id="vat-settings" style="background: #fff3cd; border-left: 4px solid #ffc107;">
      <h3>×”×’×“×¨×•×ª ××¢"×</h3>
      <div class="form-grid">
        <div>
          <label>××—×•×– ××¢"× × ×•×›×—×™:</label>
          <input type="text" id="current-vat-rate" readonly style="font-weight: bold;" />
        </div>
        <div>
          <label>×¢×“×›×•×Ÿ ×™×“× ×™ (×œ××§×¨×™× ×—×¨×™×’×™×):</label>
          <input type="number" id="manual-vat-rate" placeholder="17" min="0" max="100" step="0.1" />
          <button type="button" class="btn btn-secondary" onclick="updateVatRateEstimate()">×¢×“×›×Ÿ</button>
        </div>
      </div>
      <div style="margin-top: 10px; font-size: 14px; color: #856404;">
        <strong>×”×¢×¨×”:</strong> ×©×™× ×•×™ ××—×•×– ×”××¢"× ×™×©×¤×™×¢ ×¢×œ ×›×œ ×”×—×™×©×•×‘×™× ×‘×“×£ ×–×”.
      </div>
      <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
        <button type="button" class="btn save-btn" onclick="saveWithFeedback(event, 'vat-settings')" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">×©××•×¨</button>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button type="button" class="btn btn-primary" onclick="saveEstimate()">ğŸ’¾ ×©××•×¨ ××•××“×Ÿ</button>
      <button type="button" class="btn btn-secondary" onclick="previewEstimate()">ğŸ‘ï¸ ×ª×¦×•×’×” ××§×“×™××”</button>
      <button type="button" class="btn btn-success" onclick="generateEstimate()">ğŸ“„ ×”×¤×§ ××•××“×Ÿ ×¡×•×¤×™</button>
    </div>
  </div>

  <!-- Floating PDF Viewer (hidden by default) -->
  <div id="floatingPdfViewer" style="display: none;">
    <div class="floating-pdf-overlay" onclick="if(event.target === this) document.getElementById('floatingPdfViewer').style.display='none';">
      <div class="floating-pdf-container">
        <div class="floating-pdf-header">
          <h3 id="floatingPdfTitle">××¡××š</h3>
          <div class="floating-pdf-controls">
            <button type="button" class="btn" onclick="document.querySelector('.floating-pdf-content').classList.toggle('minimized')">_</button>
            <button type="button" class="btn" id="closePdfBtn" onclick="document.getElementById('floatingPdfViewer').style.display='none';">âœ•</button>
          </div>
        </div>
        <div class="floating-pdf-content" id="floatingPdfContent">
          <iframe src="" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- PIP Container (hidden by default) -->
  <div id="pip-container" class="pip-container">
    <div class="pip-header">
      <span>×ª×¦×•×’×” ××§×“×™××” - ××•××“×Ÿ</span>
      <div>
        <button onclick="document.getElementById('pip-content').classList.toggle('minimized')" style="background: none; border: none; color: white; cursor: pointer;">_</button>
        <button onclick="document.getElementById('pip-container').style.display='none'" style="background: none; border: none; color: white; cursor: pointer;">âœ•</button>
      </div>
    </div>
    <div class="pip-content" id="pip-content">
      <!-- Preview content will be loaded here -->
    </div>
  </div>

  <!-- Load external scripts -->
  <script src="legal-text-engine.js"></script>
  <script type="module" src="auth.js"></script>
  <script src="helper.js" type="module"></script>
  <script src="internal-browser.js"></script>
  <script src="levi-floating.js"></script>
  <script src="car-details-floating.js"></script>
  <script src="parts-search-results-floating.js"></script>
  <script src="invoice-details-floating.js"></script>
  
  <script>
    // Global state object to avoid conflicts
    const EstimateBuilderState = {
      isUpdating: false,
      autoSaveTimeout: null,
      damageCenters: [],
      adjustments: {
        features: [],
        registration: [],
        allAdjustments: []
      },
      depreciation: {
        items: [],
        global: {}
      }
    };

    // Single DOMContentLoaded handler
    document.addEventListener('DOMContentLoaded', function() {
      initializeEstimateBuilder();
    });

    // Main initialization function
    function initializeEstimateBuilder() {
      console.log('ğŸš€ Initializing Estimate Builder (Clean Version)');
      
      // Set initialization flag
      isInitializing = true;
      
      // Load data from helper
      loadDataFromHelper();
      loadDamageCentersSummary(window.helper || {});
      
      // Add event listeners
      addEventListeners();
      
      // Initialize button states
      initializeButtonStates();
      
      // Setup auto-save
      setupAutoSave();
      
      // Initialize floating screens
      initializeFloatingScreens();
      
      // Clear initialization flag after delay
      setTimeout(() => {
        isInitializing = false;
        console.log('âœ… Initialization complete - auto-save enabled');
      }, 1000);
      
      console.log('âœ… Estimate Builder initialized successfully');
    }

    // Toggle section visibility
    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        section.style.display = section.style.display === 'none' ? 'block' : 'none';
      }
    }

    // Toggle floating screen
    window.toggleFloatingScreen = function(screenType) {
      console.log('ğŸ”„ Toggle floating screen:', screenType);
      
      // Implementation will depend on floating screen modules
      if (typeof window.toggleFloatingScreenOriginal === 'function') {
        window.toggleFloatingScreenOriginal(screenType);
      }
    };

    // ANTI-MESH WARFARE: Continuously remove mesh patterns
    function destroyMeshPattern() {
      const toggleSquares = document.querySelectorAll('.toggle-square');
      toggleSquares.forEach(square => {
        // Force remove any mesh background
        square.style.setProperty('background-image', 'linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%)', 'important');
        square.style.setProperty('background', 'linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%)', 'important');
        
        // Remove any pseudo-element mesh
        const beforeEl = window.getComputedStyle(square, '::before');
        const afterEl = window.getComputedStyle(square, '::after');
        
        if (beforeEl.getPropertyValue('background-image') !== 'none') {
          square.classList.add('no-mesh-before');
        }
        if (afterEl.getPropertyValue('background-image') !== 'none') {
          square.classList.add('no-mesh-after');
        }
      });
    }

    // Run anti-mesh on load and periodically
    document.addEventListener('DOMContentLoaded', destroyMeshPattern);
    window.addEventListener('load', destroyMeshPattern);
    setInterval(destroyMeshPattern, 1000); // Check every second

    // Also run when floating screens are toggled
    const originalToggle = window.toggleFloatingScreen;
    window.toggleFloatingScreen = function(screenType) {
      if (originalToggle) originalToggle(screenType);
      setTimeout(destroyMeshPattern, 100);
    };

    // Load data from helper
    function loadDataFromHelper() {
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        if (!helper || Object.keys(helper).length === 0) {
          console.log('âš ï¸ No helper data found');
          return;
        }

        console.log('ğŸ“Š Loading data from helper');

        // Load vehicle data
        loadVehicleData(helper);
        
        // Load contact data
        loadContactData(helper);
        
        // Load damage centers
        loadDamageCenters(helper);
        
        // Load adjustments
        loadAdjustments(helper);
        
        // Load gross values (basic price + adjustments)
        loadGrossValues(helper);
        
        // Load depreciation
        loadDepreciation(helper);
        
        // Load claims data
        loadClaimsData(helper);
        
        // Load additional notes
        loadAdditionalNotes(helper);
        
        // Update page title
        updatePageTitle(helper);

      } catch (error) {
        console.error('âŒ Error loading helper data:', error);
      }
    }

    // Load vehicle data
    function loadVehicleData(helper) {
      const fields = {
        'carPlate': helper.car_details?.plate || helper.vehicle?.plate || '',
        'carManufacturer': helper.car_details?.manufacturer || '',
        'carModel': helper.car_details?.model || '',
        'carYear': helper.car_details?.year || '',
        'carModelCode': helper.car_details?.model_code || helper.vehicle?.model_code || '',
        'carBasePrice': helper.valuation?.base_price || helper.car_details?.base_price || '',
        'carMarketValue': helper.vehicle?.market_value || helper.calculations?.full_market_value || '',
        'carReportDate': helper.car_details?.report_date || ''
      };

      Object.entries(fields).forEach(([fieldId, value]) => {
        const field = document.getElementById(fieldId);
        if (field && value) {
          field.value = value;
        }
      });
    }

    // Load contact data
    function loadContactData(helper) {
      const fields = {
        'ownerName': helper.stakeholders?.owner?.name || helper.client?.name || '',
        'ownerAddress': helper.stakeholders?.owner?.address || helper.client?.address || '',
        'ownerPhone': helper.stakeholders?.owner?.phone || helper.client?.phone || '',
        'insuranceCompany': helper.stakeholders?.insurance?.company || helper.client?.insurance_company || '',
        'insuranceEmail': helper.stakeholders?.insurance?.email || helper.client?.insurance_email || '',
        'insuranceAgent': helper.stakeholders?.insurance?.agent?.name || helper.client?.insurance_agent || '',
        'agentPhone': helper.stakeholders?.insurance?.agent?.phone || helper.client?.insurance_agent_phone || '',
        'agentEmail': helper.stakeholders?.insurance?.agent?.email || helper.client?.insurance_agent_email || '',
        'garageName': helper.car_details?.garageName || '',
        'garagePhone': helper.car_details?.garagePhone || '',
        'garageEmail': helper.car_details?.garageEmail || ''
      };

      Object.entries(fields).forEach(([fieldId, value]) => {
        const field = document.getElementById(fieldId);
        if (field && value) {
          field.value = value;
        }
      });
    }

    // Update helper from field
    function updateHelperFromField(event) {
      if (EstimateBuilderState.isUpdating) return;
      
      try {
        EstimateBuilderState.isUpdating = true;
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        const fieldId = event.target.id;
        const value = event.target.value;
        
        console.log(`ğŸ“ Updating field: ${fieldId} = "${value}"`);
        
        // Update helper based on field
        // This is a simplified version - expand as needed
        switch(fieldId) {
          case 'carPlate':
            if (!helper.car_details) helper.car_details = {};
            helper.car_details.plate = value;
            break;
          case 'carManufacturer':
            if (!helper.car_details) helper.car_details = {};
            helper.car_details.manufacturer = value;
            break;
          // Add more cases as needed
        }
        
        // Save to session storage
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        // Update window.helper if exists
        if (window.helper) {
          window.helper = helper;
        }
        
      } catch (error) {
        console.error('âŒ Error updating helper:', error);
      } finally {
        EstimateBuilderState.isUpdating = false;
      }
    }

    // Update helper from contact field
    function updateHelperFromContactField(element) {
      // Similar to updateHelperFromField but for contact fields
      const event = { target: element };
      updateHelperFromField(event);
    }

    // Add event listeners
    function addEventListeners() {
      // Estimate type change
      document.querySelectorAll('input[name="estimate-type"]').forEach(radio => {
        radio.addEventListener('change', updateEstimateType);
      });

      // Add more event listeners as needed
    }

    // Update estimate type
    function updateEstimateType() {
      const selectedType = document.querySelector('input[name="estimate-type"]:checked')?.value;
      console.log('ğŸ“‹ Estimate type changed:', selectedType);
      
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        if (!helper.estimate) helper.estimate = {};
        helper.estimate.type = selectedType;
        sessionStorage.setItem('helper', JSON.stringify(helper));
      } catch (error) {
        console.error('âŒ Error updating estimate type:', error);
      }
    }

    // Save estimate
    window.saveEstimate = function() {
      console.log('ğŸ’¾ Saving estimate...');
      
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        // Collect all form data
        const estimateData = {
          type: document.querySelector('input[name="estimate-type"]:checked')?.value,
          vehicle: collectVehicleData(),
          contact: collectContactData(),
          damageCenters: EstimateBuilderState.damageCenters,
          adjustments: EstimateBuilderState.adjustments,
          depreciation: EstimateBuilderState.depreciation,
          notes: document.getElementById('additional-notes')?.value || '',
          legalText: document.getElementById('legal-text-content')?.value || '',
          attachments: document.getElementById('attachments-list')?.value || ''
        };
        
        // Save to helper.estimate
        helper.estimate = estimateData;
        helper.estimate.savedAt = new Date().toISOString();
        
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        // Show success message
        showMessage('××•××“×Ÿ × ×©××¨ ×‘×”×¦×œ×—×”', 'success');
        
      } catch (error) {
        console.error('âŒ Error saving estimate:', error);
        showMessage('×©×’×™××” ×‘×©××™×¨×ª ×”××•××“×Ÿ', 'error');
      }
    };

    // Preview estimate
    window.previewEstimate = function() {
      console.log('ğŸ‘ï¸ Preview estimate');
      saveEstimate();
      // Implementation depends on preview requirements
      showEstimatePreviewPip();
    };

    // Generate estimate
    window.generateEstimate = function() {
      console.log('ğŸ“„ Generate estimate');
      saveEstimate();
      // Navigate to validation page
      window.location.href = 'estimate-validation.html';
    };

    // Show message
    function showMessage(message, type = 'info') {
      const messageDiv = document.createElement('div');
      messageDiv.className = `section-message ${type}`;
      messageDiv.textContent = message;
      document.body.appendChild(messageDiv);
      
      setTimeout(() => {
        messageDiv.remove();
      }, 3000);
    }

    // Initialize button states
    function initializeButtonStates() {
      // Add any specific button initialization here
    }

    // Setup auto-save
    function setupAutoSave() {
      // Auto-save every 30 seconds if there are changes
      setInterval(() => {
        if (EstimateBuilderState.hasChanges) {
          saveEstimate();
          EstimateBuilderState.hasChanges = false;
        }
      }, 30000);
    }

    // Initialize floating screens
    function initializeFloatingScreens() {
      // This will be handled by the floating screen modules
      console.log('ğŸ–¼ï¸ Floating screens ready');
    }

    // Update page title
    function updatePageTitle(helper) {
      const plate = helper.meta?.plate || helper.car_details?.plate || '...';
      document.getElementById('pageTitle').textContent = `×¨×›×‘ ××¡. ${plate}`;
    }

    // Add feature adjustment row
    function addFeatureAdjustment() {
      const container = document.getElementById('featuresAdjustmentsList');
      const rowId = 'featureAdj_' + Date.now();
      
      const newRow = `
        <div id="${rowId}" style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr 80px; gap:10px; margin-bottom:8px;">
          <div><input type="text" placeholder="×ª×™××•×¨ ×”×××¤×™×™×Ÿ" /></div>
          <div><select>
            <option value="plus">×ª×•×¡×¤×ª (+)</option>
            <option value="minus">×”×¤×—×ª×” (-)</option>
          </select></div>
          <div><input type="text" placeholder="××—×•×–" oninput="calculateAdjustmentValueSimple(this);" /></div>
          <div><input type="text" placeholder="â‚ª" /></div>
          <div><button class="btn remove" onclick="removeAdjustmentRow('${rowId}')">××—×§</button></div>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', newRow);
      updateGrossMarketValueCalculation();
    }

    // Add registration adjustment row
    function addRegistrationAdjustment() {
      const container = document.getElementById('registrationAdjustmentsList');
      const rowId = 'regAdj_' + Date.now();
      
      const newRow = `
        <div id="${rowId}" style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr 80px; gap:10px; margin-bottom:8px;">
          <div><input type="text" placeholder="×ª×™××•×¨ ×¢×œ×™×” ×œ×›×‘×™×©" /></div>
          <div><select>
            <option value="plus">×ª×•×¡×¤×ª (+)</option>
            <option value="minus">×”×¤×—×ª×” (-)</option>
          </select></div>
          <div><input type="text" placeholder="××—×•×–" oninput="calculateAdjustmentValueSimple(this);" /></div>
          <div><input type="text" placeholder="â‚ª" /></div>
          <div><button class="btn remove" onclick="removeAdjustmentRow('${rowId}')">××—×§</button></div>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', newRow);
      updateGrossMarketValueCalculation();
    }

    function addFullMarketAdjustment() {
      console.log('â• Add full market adjustment');
      // Implementation for full market adjustment - kept as placeholder for now
    }

    
    // WORKING DAMAGE CENTER FUNCTIONS FROM FINAL-REPORT-BUILDER
    function addNewDamageCenter() {
      const container = document.getElementById('editableDamageCenters');
      if (!container) {
        // If no container exists, create it
        document.getElementById('damageCentersContent').innerHTML = '<div style="display: grid; gap: 15px;" id="editableDamageCenters"></div>';
      }
      
      const newIndex = document.querySelectorAll('.editable-damage-card').length;
      const newBlock = {
        damage_center_name: `××•×§×“ × ×–×§ ${newIndex + 1}`,
        parts: [],
        works: [],
        repairs: [],
        work_cost: 0,
        parts_cost: 0
      };
      
      const newCardHTML = createEditableDamageCenterCard(newBlock, newIndex);
      document.getElementById('editableDamageCenters').insertAdjacentHTML('beforeend', newCardHTML);
      
      setTimeout(() => {
        addDamageCenterEventListeners();
        // Create subtotal if it doesn't exist
        if (!document.getElementById('damageCentersSubtotal')) {
          createDamageCentersSubtotal();
        }
      }, 100);
    }

    function addDamageCenterEventListeners_OLD_REMOVE() {
      // 2-WAY DATA FLOW: Add listeners to ALL fields for auto-save
      const selectors = '.damage-center-location, .damage-center-description, .part-name, .part-desc, .part-price, .part-source, .work-name, .work-type, .work-cost, .repair-text, .repair-cost';
      
      document.querySelectorAll(selectors).forEach(input => {
        // Check if already has listeners to prevent duplicates
        if (!input.hasAttribute('data-listeners-added')) {
          // Auto-save on change
          input.addEventListener('change', () => {
            saveDamageCenterChanges();
            updateAllCostDisplays();
          });
          
          // Auto-save on blur (when user leaves field)
          input.addEventListener('blur', () => {
            saveDamageCenterChanges();
            updateAllCostDisplays();
          });
          
          // Live update displays on input
          input.addEventListener('input', () => {
            updateAllCostDisplays();
          });
          
          input.setAttribute('data-listeners-added', 'true');
        }
      });
    }
    
    function handleCostInputChange(e) {
      const card = e.target.closest('.editable-damage-card');
      updateCostDisplay(card);
      updateDamageCentersSubtotal();
    }
    
    // Handle damage center changes
    function handleDamageCenterChange(event) {
      EstimateBuilderState.hasChanges = true;
      updateCostDisplay(event.target.closest('.editable-damage-card'));
    }

    
    // UPDATE COST DISPLAY - WORKING VERSION
    function updateCostDisplay(card) {
      if (!card) return;
      
      // Calculate parts cost
      let partsCost = 0;
      card.querySelectorAll('.part-price').forEach(input => {
        partsCost += parseFloat(input.value) || 0;
      });
      
      // Calculate works cost
      let worksCost = 0;
      card.querySelectorAll('.work-cost').forEach(input => {
        worksCost += parseFloat(input.value) || 0;
      });
      
      // Calculate repairs cost
      let repairsCost = 0;
      card.querySelectorAll('.repair-cost').forEach(input => {
        repairsCost += parseFloat(input.value) || 0;
      });
      
      const totalCost = partsCost + worksCost + repairsCost;
      const vatRate = (window.getHelperVatRate ? window.getHelperVatRate() / 100 : 0.17);
      const totalWithVAT = totalCost * (1 + vatRate);
      
      // Update display elements
      const workDisplay = card.querySelector('.work-costs-display');
      const partsDisplay = card.querySelector('.parts-costs-display');
      const repairsDisplay = card.querySelector('.repairs-costs-display');
      const totalDisplay = card.querySelector('.total-with-vat-display');
      
      if (workDisplay) {
        workDisplay.textContent = `â‚ª${worksCost.toLocaleString()}`;
      }
      if (partsDisplay) {
        partsDisplay.textContent = `â‚ª${partsCost.toLocaleString()}`;
      }
      if (repairsDisplay) {
        repairsDisplay.textContent = `â‚ª${repairsCost.toLocaleString()}`;
      }
      if (totalDisplay) {
        totalDisplay.textContent = `â‚ª${Math.round(totalWithVAT).toLocaleString()}`;
      }
    }
    
    // Create damage centers subtotal
    function createDamageCentersSubtotal() {
      const existingSubtotal = document.getElementById('damageCentersSubtotal');
      if (existingSubtotal) {
        existingSubtotal.remove();
      }
      
      const damageCentersContent = document.getElementById('damageCentersContent');
      if (!damageCentersContent) return;
      
      const subtotalHTML = `
        <div id="damageCentersSubtotal" style="background: #f8f9fa; border: 2px solid #28a745; border-radius: 6px; padding: 12px; margin-top: 15px;">
          <h4 style="margin: 0 0 10px 0; color: #28a745; text-align: center; font-size: 14px; font-weight: bold;">ğŸ§® ×¡×™×›×•× ×›×œ×œ×™ - ××¨×›×–×™ × ×–×§</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-bottom: 8px;">
            <div style="background: #17a2b8; color: white; padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 16px; font-weight: bold;" id="totalWorksCost">â‚ª0</div>
              <div style="font-size: 10px; opacity: 0.9;">×¡×”"×› ×¢×‘×•×“×•×ª</div>
            </div>
            <div style="background: #28a745; color: white; padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 16px; font-weight: bold;" id="totalPartsCost">â‚ª0</div>
              <div style="font-size: 10px; opacity: 0.9;">×¡×”"×› ×—×œ×¤×™×</div>
            </div>
            <div style="background: #ffc107; color: #212529; padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 16px; font-weight: bold;" id="totalRepairsCost">â‚ª0</div>
              <div style="font-size: 10px; opacity: 0.9;">×¡×”"×› ×ª×™×§×•× ×™×</div>
            </div>
            <div style="background: #6c757d; color: white; padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 16px; font-weight: bold;" id="totalBeforeVAT">â‚ª0</div>
              <div style="font-size: 10px; opacity: 0.9;">×œ×¤× ×™ ××¢"×</div>
            </div>
            <div style="background: #dc3545; color: white; padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 16px; font-weight: bold;" id="totalWithVAT">â‚ª0</div>
              <div style="font-size: 10px; opacity: 0.9;">×›×•×œ×œ ××¢"×</div>
            </div>
          </div>
        </div>
      `;
      
      damageCentersContent.insertAdjacentHTML('beforeend', subtotalHTML);
      updateDamageCentersSubtotal();
    }
    
    // UPDATE DAMAGE CENTERS SUBTOTAL - COMPLETE VERSION
    function updateDamageCentersSubtotal() {
      let totalWorks = 0;
      let totalParts = 0;
      let totalRepairs = 0;
      
      // Calculate totals from all damage center cards
      document.querySelectorAll('.editable-damage-card').forEach(card => {
        // Sum parts costs
        card.querySelectorAll('.part-row').forEach(row => {
          const price = parseFloat(row.querySelector('.part-price').value) || 0;
          totalParts += price;
        });
        
        // Sum work costs
        card.querySelectorAll('.work-row').forEach(row => {
          const cost = parseFloat(row.querySelector('.work-cost').value) || 0;
          totalWorks += cost;
        });
        
        // Sum repair costs
        card.querySelectorAll('.repair-row').forEach(row => {
          const cost = parseFloat(row.querySelector('.repair-cost').value) || 0;
          totalRepairs += cost;
        });
      });
      
      const totalWithoutVat = totalWorks + totalParts + totalRepairs;
      const vatRate = (window.getHelperVatRate ? window.getHelperVatRate() / 100 : 0.17);
      const totalWithVat = totalWithoutVat * (1 + vatRate);
      
      // Update displays
      const totalPartsDisplay = document.getElementById('totalPartsCost');
      if (totalPartsDisplay) totalPartsDisplay.textContent = `â‚ª${totalParts.toLocaleString()}`;
      
      const totalWorksDisplay = document.getElementById('totalWorksCost');
      if (totalWorksDisplay) totalWorksDisplay.textContent = `â‚ª${totalWorks.toLocaleString()}`;
      
      const totalRepairsDisplay = document.getElementById('totalRepairsCost');
      if (totalRepairsDisplay) totalRepairsDisplay.textContent = `â‚ª${totalRepairs.toLocaleString()}`;
      
      const totalBeforeDisplay = document.getElementById('totalBeforeVAT');
      if (totalBeforeDisplay) totalBeforeDisplay.textContent = `â‚ª${totalWithoutVat.toLocaleString()}`;
      
      const totalWithDisplay = document.getElementById('totalWithVAT');
      if (totalWithDisplay) totalWithDisplay.textContent = `â‚ª${Math.round(totalWithVat).toLocaleString()}`;
      
      // Update claims data fields
      const totalClaimField = document.getElementById('totalClaim');
      if (totalClaimField) {
        totalClaimField.value = `â‚ª${totalWithoutVat.toLocaleString()}`;
      }
      
      // Update damage percentage calculation
      calculateDamagePercentage();
    }
    
    // Show part suggestions
    window.showPartSuggestions = function(input, centerIndex, partIndex) {
      const value = input.value.trim();
      const suggestionsDiv = input.nextElementSibling;
      
      if (value.length < 2) {
        suggestionsDiv.style.display = 'none';
        return;
      }
      
      // This would integrate with parts search module
      // For now, just hide suggestions
      suggestionsDiv.style.display = 'none';
    };
    
    // Handle work type change
    window.handleWorkTypeChange = function(select, centerIndex, workIndex) {
      // Could implement auto-pricing based on work type
      EstimateBuilderState.hasChanges = true;
    };
    
    // Global flag to prevent saving during initialization
    let isInitializing = true;
    
    // Save damage center changes with feedback
    // FIXED DAMAGE CENTERS SAVE FUNCTION - Using DOM-First Pattern from estimate-builder.html
    window.saveDamageCenterChanges = function saveDamageCenterChanges() {
      // Don't save during initialization
      if (isInitializing) {
        console.log('â¸ï¸ Skipping save during initialization');
        return true;
      }
      
      try {
        // ğŸ”§ CRITICAL: Use window.helper directly (not const) to ensure we're updating the live object
        window.helper = window.helper || {};
        
        // Initialize centers if not exists
        if (!window.helper.centers) window.helper.centers = [];
        
        // ğŸ†• ESTIMATE WORKFLOW: Initialize estimate structure
        if (!window.helper.estimate) window.helper.estimate = {};
        if (!window.helper.estimate.damage_centers) window.helper.estimate.damage_centers = [];
        
        // Clean up any redundant damage_assessment.centers (duplicate section)
        // BUT preserve damage_assessment.summary which contains totals data
        if (window.helper.damage_assessment?.centers) {
          console.log('ğŸ§¹ Cleaning up redundant damage_assessment.centers');
          delete window.helper.damage_assessment.centers;
          
          // Only delete damage_assessment object if it has no important data left
          // Preserve .summary, .totals, and any other important sections
          const remainingKeys = Object.keys(window.helper.damage_assessment);
          const importantSections = ['summary', 'totals', 'total_centers', 'total_items', 'last_updated', 'totals_after_differentials'];
          const hasImportantData = remainingKeys.some(key => importantSections.includes(key));
          
          if (!hasImportantData && remainingKeys.length === 0) {
            console.log('ğŸ§¹ Deleting empty damage_assessment object');
            delete window.helper.damage_assessment;
          } else {
            console.log('ğŸ”’ Preserving damage_assessment with important sections:', remainingKeys);
          }
        }
        
        // Also maintain expertise.damage_blocks for backward compatibility
        if (!window.helper.expertise) window.helper.expertise = {};
        if (!window.helper.expertise.damage_blocks) window.helper.expertise.damage_blocks = [];
        
        // ğŸ”¥ CRITICAL FIX: Collect ALL data from DOM BEFORE clearing arrays
        const collectedCenters = [];
        const collectedDamageBlocks = [];
        const collectedEstimateCenters = [];
        
        // Store damage center names for depreciation section
        const damageCenterNames = [];
        
        // ğŸ”¥ FIRST: Collect ALL data from DOM elements into temporary arrays
        document.querySelectorAll('.editable-damage-card').forEach((card, index) => {
          // Extract just the number from the damage center number field
          const centerNumberField = card.querySelector('.damage-center-number').value;
          // Extract the number (e.g., "××•×§×“ × ×–×§ ××¡' 1" -> "1")
          const numberMatch = centerNumberField.match(/\d+$/);
          const centerNumber = numberMatch ? numberMatch[0] : String(index + 1);
          const centerLocation = card.querySelector('.damage-center-location').value;
          const centerDescription = card.querySelector('.damage-center-description').value;
          
          // Collect parts
          const parts = [];
          card.querySelectorAll('.part-row').forEach(row => {
            const name = row.querySelector('.part-name').value;
            const desc = row.querySelector('.part-desc').value;
            const price = row.querySelector('.part-price').value;
            const source = row.querySelector('.part-source')?.value || '×ª×—×œ×™×¤×™';
            
            if (name.trim()) {
              parts.push({ name, desc, price: parseFloat(price) || 0, source });
            }
          });
          
          // Collect works
          const works = [];
          card.querySelectorAll('.work-row').forEach(row => {
            let type = row.querySelector('.work-type').value;
            const note = row.querySelector('.work-note')?.value || '';
            const cost = parseFloat(row.querySelector('.work-cost').value) || 0;
            
            // If "××—×¨" is selected, get the custom text from the input
            if (type === '××—×¨') {
              const otherInput = row.querySelector('.work-type-other');
              if (otherInput && otherInput.value.trim()) {
                type = otherInput.value.trim();
              }
            }
            
            if (type) {
              works.push({ category: type, comments: note, cost });
            }
          });
          
          // Collect repairs
          const repairs = [];
          card.querySelectorAll('.repair-row').forEach(row => {
            const text = row.querySelector('.repair-text').value;
            const cost = parseFloat(row.querySelector('.repair-cost').value) || 0;
            
            if (text.trim()) {
              repairs.push({ description: text, cost });
            }
          });
          
          // Calculate costs using individual cost fields
          const partsCost = parts.reduce((sum, part) => sum + (parseFloat(part.price) || 0), 0);
          const workCost = works.reduce((sum, work) => sum + (parseFloat(work.cost) || 0), 0);
          const repairsCost = repairs.reduce((sum, repair) => sum + (parseFloat(repair.cost) || 0), 0);
          const totalCost = partsCost + workCost + repairsCost;
          
          // Create center object in helper.centers format (source of truth)
          const centerObject = {
            Id: `dc_${Date.now()}_${index + 1}`, // Generate unique ID
            "Damage center Number": centerNumber || (index + 1),
            Location: centerLocation,
            Description: centerDescription,
            Parts: {
              parts_required: parts,
              parts_meta: {
                total_items: parts.length,
                total_cost: partsCost
              }
            },
            Works: {
              works: works,
              works_meta: {
                total_items: works.length,
                total_cost: workCost
              }
            },
            Repairs: {
              repairs: repairs,
              repairs_meta: {
                total_items: repairs.length,
                total_cost: repairsCost
              }
            },
            Summary: {
              "Total with VAT": totalCost * (1 + (window.getHelperVatRate ? window.getHelperVatRate() : 18) / 100)
            }
          };
          
          // ğŸ”¥ Add to temporary collections (not directly to helper)
          collectedCenters.push(centerObject);
          
          // ğŸ†• ESTIMATE WORKFLOW: Prepare estimate structure
          collectedEstimateCenters.push({
            center_number: centerNumber || (index + 1),
            location: centerLocation,
            description: centerDescription,
            parts: parts,
            works: works,
            repairs: repairs,
            costs: {
              parts_cost: partsCost,
              work_cost: workCost,
              repairs_cost: repairsCost,
              total_cost: totalCost,
              total_with_vat: totalCost * (1 + (window.getHelperVatRate ? window.getHelperVatRate() : 18) / 100)
            }
          });
          
          // Also prepare damage_blocks for backward compatibility
          collectedDamageBlocks.push({
            damage_center_name: centerLocation,
            damage_center_number: index + 1,
            center_header: centerNumber,
            description: centerDescription,
            parts,
            works,
            repairs,
            parts_cost: partsCost,
            work_cost: workCost,
            repairs_cost: repairsCost
          });
          
          // Store damage center data for depreciation section (complete object)
          if (centerLocation.trim()) {
            damageCenterNames.push({
              name: centerLocation.trim(),
              number: centerNumber || (index + 1),
              description: centerDescription || ''
            });
          }
          
          // Update cost display for this card
          updateCostDisplay(card, partsCost, workCost, repairsCost);
        });
        
        // ğŸ”¥ NOW clear and rebuild arrays with collected data
        window.helper.centers = collectedCenters;
        window.helper.expertise.damage_blocks = collectedDamageBlocks;
        window.helper.estimate.damage_centers = collectedEstimateCenters;
        
        // ğŸ†• ESTIMATE WORKFLOW: Calculate estimate totals and save to calculations
        const totalEstimateCost = collectedEstimateCenters.reduce((sum, center) => sum + center.costs.total_cost, 0);
        const totalEstimateWithVAT = collectedEstimateCenters.reduce((sum, center) => sum + center.costs.total_with_vat, 0);
        
        if (!window.helper.calculations) window.helper.calculations = {};
        window.helper.calculations.total_estimate = totalEstimateCost;
        window.helper.calculations.total_estimate_with_vat = totalEstimateWithVAT;
        
        // Initialize damage assessment if needed
        if (!window.helper.damage_assessment) window.helper.damage_assessment = {};
        
        // Save damage assessment summary and totals
        window.helper.damage_assessment.summary = {
          total_centers: document.querySelectorAll('.editable-damage-card').length,
          total_parts: document.querySelectorAll('.part-row').length,
          total_works: document.querySelectorAll('.work-row').length,
          total_repairs: document.querySelectorAll('.repair-row').length,
          damage_center_names: damageCenterNames,
          last_updated: new Date().toISOString()
        };
        
        // Save updated centers count
        window.helper.damage_assessment.total_centers = document.querySelectorAll('.editable-damage-card').length;
        
        // ğŸ”¥ CRITICAL: Update estimate metadata
        if (!window.helper.estimate.metadata) window.helper.estimate.metadata = {};
        window.helper.estimate.metadata.damage_centers_count = document.querySelectorAll('.editable-damage-card').length;
        window.helper.estimate.metadata.last_updated = new Date().toISOString();
        
        // ğŸ”¥ CRITICAL: Save to sessionStorage - ensure we're saving the updated window.helper
        sessionStorage.setItem('helper', JSON.stringify(window.helper));
        
        // Update depreciation section with damage center names
        if (typeof updateDepreciationFromDamageCenters === 'function') {
          updateDepreciationFromDamageCenters(damageCenterNames);
        }
        
        // Trigger floating screen refresh
        if (typeof triggerFloatingScreenRefresh === 'function') {
          triggerFloatingScreenRefresh();
        }
        
        console.log('âœ… Damage centers saved to multiple locations:');
        console.log('- window.helper.centers:', window.helper.centers);
        console.log('- window.helper.estimate.damage_centers:', window.helper.estimate.damage_centers);
        console.log('- window.helper.expertise.damage_blocks:', window.helper.expertise.damage_blocks);
        console.log('- Calculations:', window.helper.calculations);
        
        // Update damage centers totals display
        setTimeout(updateDamageCentersSubtotal, 100);
        
        return true;
      } catch (error) {
        console.error('Error saving damage center changes:', error);
        return false;
      }
    }

    window.saveDamageCenterChangesWithFeedback = function(event) {
      console.log('ğŸ”˜ Save button clicked');
      const button = event.target;
      const originalText = button.textContent;
      const originalBg = button.style.background;
      
      button.disabled = true;
      button.textContent = '×©×•××¨...';
      button.style.background = '#ffc107';
      
      try {
        if (saveDamageCenterChanges()) {
          button.style.background = '#28a745';
          button.textContent = 'âœ“ × ×©××¨ ×‘×”×¦×œ×—×”!';
          console.log('âœ… Save successful');
          
          setTimeout(() => {
            button.disabled = false;
            button.style.background = originalBg;
            button.textContent = originalText;
          }, 2000);
        } else {
          button.style.background = '#dc3545';
          button.textContent = 'âœ— ×©×’×™××” ×‘×©××™×¨×”';
          console.log('âŒ Save failed');
          
          setTimeout(() => {
            button.disabled = false;
            button.style.background = originalBg;
            button.textContent = originalText;
          }, 2000);
        }
      } catch (error) {
        console.error('âŒ Error in save:', error);
        button.style.background = '#dc3545';
        button.textContent = 'âœ— ×©×’×™××”';
        
        setTimeout(() => {
          button.disabled = false;
          button.style.background = originalBg;
          button.textContent = originalText;
        }, 2000);
      }
    };

    // Generic save feedback function for all sections
    function saveWithFeedback(event, sectionName) {
      const button = event.target;
      const originalText = button.textContent;
      const originalBg = button.style.background;
      
      button.disabled = true;
      button.textContent = '×©×•××¨...';
      button.style.background = '#ffc107';
      
      // Save to sessionStorage
      const helper = window.helper || {};
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      // Show success
      button.style.background = '#28a745';
      button.textContent = 'âœ“ × ×©××¨ ×‘×”×¦×œ×—×”!';
      console.log(`âœ… ${sectionName} saved successfully`);
      
      setTimeout(() => {
        button.disabled = false;
        button.style.background = originalBg;
        button.textContent = originalText;
      }, 2000);
    }

    // Save functions for each section
    window.saveVehicleDataWithFeedback = function(event) {
      saveWithFeedback(event, 'Vehicle Data');
    };

    window.saveContactDataWithFeedback = function(event) {
      saveWithFeedback(event, 'Contact Data');
    };

    window.saveGrossValueWithFeedback = function(event) {
      saveWithFeedback(event, 'Gross Value');
    };

    window.saveGrossPercentageWithFeedback = function(event) {
      saveWithFeedback(event, 'Gross Percentage');
    };
    
    // Calculate damage percentage
    function calculateDamagePercentage() {
      const totalDamage = parseFloat(document.getElementById('totalBeforeVAT')?.textContent.replace(/[â‚ª,]/g, '')) || 0;
      const grossValue = parseFloat(document.getElementById('grossMarketValueField')?.value.replace(/[â‚ª,]/g, '')) || 0;
      
      if (grossValue > 0) {
        const percentage = (totalDamage / grossValue) * 100;
        const percentageField = document.getElementById('grossDamagePercentage');
        if (percentageField) {
          percentageField.value = percentage.toFixed(2) + '%';
        }
        
        // Update damage cost field
        const damageCostField = document.getElementById('totalDamageCost');
        if (damageCostField) {
          damageCostField.value = `â‚ª${totalDamage.toLocaleString()}`;
        }
        
        // Update gross value display
        const grossValueDisplay = document.getElementById('grossValueDisplay');
        if (grossValueDisplay) {
          grossValueDisplay.value = `â‚ª${grossValue.toLocaleString()}`;
        }
        
        // Update summary damage percentage
        const summaryPercentage = document.getElementById('damagePercentage');
        if (summaryPercentage) {
          summaryPercentage.textContent = percentage.toFixed(2) + '%';
        }
      }
    }

    function addDepField() {
      console.log('â• Add depreciation field');
      // Implementation here
    }

    function updateGrossMarketValueCalculation() {
      console.log('ğŸ“Š Update gross market value');
      try {
        // Get basic price
        const basicPriceField = document.getElementById('basicPrice');
        const basicPrice = parseFloat((basicPriceField?.value || '').replace(/[â‚ª,]/g, '')) || 0;
        
        // Calculate features adjustments total
        let featuresTotal = 0;
        const featuresRows = document.querySelectorAll('#featuresAdjustmentsList > div');
        featuresRows.forEach(row => {
          const inputs = row.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const amount = parseFloat((inputs[3].value || '').replace(/[â‚ª,]/g, '')) || 0;
            const type = inputs[1].value;
            featuresTotal += (type === 'minus' ? -amount : amount);
          }
        });
        
        // Update features cumulative display
        const featuresCumulative = document.querySelector('#grossFeaturesCumulative span');
        if (featuresCumulative) {
          const afterFeatures = basicPrice + featuresTotal;
          featuresCumulative.textContent = `â‚ª${afterFeatures.toLocaleString()}`;
          featuresCumulative.style.color = afterFeatures > 0 ? '#28a745' : '#dc3545';
        }
        
        // Calculate registration adjustments total
        let registrationTotal = 0;
        const registrationRows = document.querySelectorAll('#registrationAdjustmentsList > div');
        registrationRows.forEach(row => {
          const inputs = row.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const amount = parseFloat((inputs[3].value || '').replace(/[â‚ª,]/g, '')) || 0;
            const type = inputs[1].value;
            registrationTotal += (type === 'minus' ? -amount : amount);
          }
        });
        
        // Update registration cumulative display
        const registrationCumulative = document.querySelector('#grossRegistrationCumulative span');
        if (registrationCumulative) {
          const afterRegistration = basicPrice + featuresTotal + registrationTotal;
          registrationCumulative.textContent = `â‚ª${afterRegistration.toLocaleString()}`;
          registrationCumulative.style.color = afterRegistration > 0 ? '#28a745' : '#dc3545';
        }
        
        // Calculate gross market value
        const grossMarketValue = basicPrice + featuresTotal + registrationTotal;
        
        // Update the result field
        const resultField = document.getElementById('grossMarketValueResult');
        if (resultField) {
          resultField.value = `â‚ª${grossMarketValue.toLocaleString()}`;
        }
        
        // Update any other gross value displays
        const grossValueDisplay = document.getElementById('grossValueDisplay');
        if (grossValueDisplay) {
          grossValueDisplay.value = `â‚ª${grossMarketValue.toLocaleString()}`;
        }
        
        console.log('âœ… Updated gross market value to:', grossMarketValue);
        console.log('ğŸ“Š Cumulative values - After features:', basicPrice + featuresTotal, 'After registration:', grossMarketValue);
        
      } catch (error) {
        console.error('âŒ Error updating gross market value:', error);
      }
    }

    function updateHelperFromAdjustments(helper) {
      console.log('ğŸ“Š Update helper from adjustments');
      try {
        // Ensure valuation structure exists
        if (!helper.valuation) helper.valuation = {};
        if (!helper.valuation.adjustments) helper.valuation.adjustments = {};
        
        // 1. Update basic price
        const basicPriceField = document.getElementById('basicPrice');
        if (basicPriceField && basicPriceField.value) {
          helper.valuation.base_price = parseFloat((basicPriceField.value || '').replace(/[â‚ª,]/g, '')) || 0;
        }
        
        // 2. Update features adjustments - CORRECT FIELD MAPPING
        if (!helper.valuation.adjustments.features) helper.valuation.adjustments.features = {};
        const featuresRows = document.querySelectorAll('#featuresAdjustmentsList > div');
        if (featuresRows.length > 0) {
          const firstRow = featuresRows[0];
          const inputs = firstRow.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            // Store the description in the correct field
            helper.valuation.adjustments.features.description = inputs[0].value || '';
            helper.valuation.adjustments.features.value = inputs[0].value || ''; // Also store in value for backward compatibility
            
            // Store percentage as number
            const percentage = parseFloat(inputs[2].value) || 0;
            helper.valuation.adjustments.features.percentage = percentage;
            
            // Store amount without formatting
            const amount = parseFloat((inputs[3].value || '').replace(/[â‚ª,]/g, '')) || 0;
            const type = inputs[1].value || 'plus';
            helper.valuation.adjustments.features.amount = type === 'minus' ? -amount : amount;
            
            // Also store the display value
            helper.valuation.adjustments.features.value = amount.toString();
          }
        }
        
        // 3. Update registration adjustments - CORRECT FIELD MAPPING
        if (!helper.valuation.adjustments.registration) helper.valuation.adjustments.registration = {};
        const registrationRows = document.querySelectorAll('#registrationAdjustmentsList > div');
        if (registrationRows.length > 0) {
          const firstRow = registrationRows[0];
          const inputs = firstRow.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            // Store description/value correctly
            helper.valuation.adjustments.registration.value = inputs[0].value || '';
            helper.valuation.adjustments.registration.description = inputs[0].value || '';
            
            // Store percentage as number
            const percentage = parseFloat(inputs[2].value) || 0;
            helper.valuation.adjustments.registration.percent = percentage;
            
            // Store amount without formatting  
            const amount = parseFloat((inputs[3].value || '').replace(/[â‚ª,]/g, '')) || 0;
            const type = inputs[1].value || 'plus';
            helper.valuation.adjustments.registration.amount = type === 'minus' ? -amount : amount;
          }
        }
        
        console.log('âœ… Updated helper from adjustments:', helper.valuation);
        
        // Return the updated helper
        return helper;
        
      } catch (error) {
        console.error('âŒ Error updating helper from adjustments:', error);
        return helper;
      }
    }


    function saveDepreciationData() {
      console.log('ğŸ’¾ Save depreciation data');
      // Implementation here
    }

    function updateHelperDepreciationField(element, field) {
      console.log('ğŸ“ Update depreciation field:', field);
      // Implementation here
    }

    function updateClaimsDataFromField(element, field) {
      console.log('ğŸ“ Update claims field:', field);
      // Implementation here
    }

    function updateGrossPercentageFromGrossValue() {
      console.log('ğŸ“Š Update gross percentage');
      // Implementation here
    }

    function updateGlobalDepreciationCalculation() {
      console.log('ğŸ“Š Update global depreciation');
      // Implementation here
    }

    function triggerFloatingScreenRefresh() {
      console.log('ğŸ”„ Trigger floating screen refresh');
      // Implementation here
    }

    function autoPopulateMarketAdjustments() {
      console.log('ğŸ”„ Auto populate market adjustments');
      // Implementation here
    }

    function loadLegalTextFromVault() {
      console.log('ğŸ“„ Load legal text');
      // Implementation here
    }

    function resetLegalText() {
      document.getElementById('legal-text-content').value = '';
    }

    function loadAttachmentsFromVault() {
      console.log('ğŸ“ Load attachments');
      // Implementation here
    }

    function resetAttachments() {
      document.getElementById('attachments-list').value = '';
    }

    function updateVatRateEstimate() {
      console.log('ğŸ’° Update VAT rate');
      // Implementation here
    }

    function showEstimatePreviewPip() {
      console.log('ğŸ–¼ï¸ Show PIP preview');
      const pip = document.getElementById('pip-container');
      if (pip) {
        pip.style.display = 'block';
      }
    }

    // Load damage centers from helper
    function loadDamageCenters(helper) {
      console.log('ğŸ—ï¸ Load damage centers');
    }
    
    // LOAD DAMAGE CENTERS SUMMARY - EDITABLE CARDS
    function loadDamageCentersSummary(helper) {
      try {
        const damageCentersContent = document.getElementById('damageCentersContent');
        
        // Load from damage centers helper (primary source) with fallbacks
        const damageCenters = helper.centers || 
                             helper.damage_centers || 
                             helper.expertise?.damage_blocks || [];
        
        if (damageCenters && damageCenters.length > 0) {
          let summaryHTML = '<div style="display: grid; gap: 15px;" id="editableDamageCenters">';
          
          damageCenters.forEach((center, index) => {
            // Adapt centers data structure to damage block structure for compatibility
            const adaptedCenter = adaptCenterToBlock(center, index);
            summaryHTML += createEditableDamageCenterCard(adaptedCenter, index);
          });
          
          summaryHTML += '</div>';
          damageCentersContent.innerHTML = summaryHTML;
          
          // Add event listeners after HTML is created
          setTimeout(addDamageCenterEventListeners, 100);
          
          // Create damage centers subtotal
          setTimeout(createDamageCentersSubtotal, 150);
          
        } else {
          damageCentersContent.innerHTML = '<div style="color: #666; text-align: center;">×œ× × ××¦××• × ×ª×•× ×™ ××•×§×“×™ × ×–×§ - ×œ×—×¥ "×”×•×¡×£ ××•×§×“ × ×–×§ ×—×“×©" ×›×“×™ ×œ×”×ª×—×™×œ</div>';
        }
      } catch (error) {
        console.error('Error loading damage centers summary:', error);
        document.getElementById('damageCentersContent').innerHTML = '<div style="color: #dc3545; text-align: center;">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ××•×§×“×™ × ×–×§</div>';
      }
    }
    
    // Adapt centers data structure to damage block structure for compatibility
    function adaptCenterToBlock(center, index) {
      const adaptedBlock = {
        damage_center_name: center.Location || center.damage_center_name || `××•×§×“ × ×–×§ ${index + 1}`,
        damage_center_number: (() => {
          const num = center["Damage center Number"] || center.damage_center_number || (index + 1);
          if (typeof num === 'string' && num.includes('××•×§×“')) {
            const match = num.match(/\d+$/);
            return match ? match[0] : String(index + 1);
          }
          return num;
        })(),
        description: center.Description || center.description || '',
        works: center.Works?.works || center.works || [],
        parts: center.Parts?.parts_required || center.Parts?.parts || center.parts_required || center.parts || center.Parts || [],
        repairs: center.Repairs?.repairs || center.repairs || [],
        works_meta: center.Works?.works_meta || center.works_meta || { total_cost: 0 },
        parts_meta: center.Parts?.parts_meta || center.parts_meta || { total_cost: 0 },
        repairs_meta: center.Repairs?.repairs_meta || center.repairs_meta || { total_cost: 0 },
        total_cost: center.Summary?.["Total with VAT"] || center.total_cost || 0
      };
      
      // Additional normalization for different data structures
      if (Array.isArray(center.Works) && adaptedBlock.works.length === 0) {
        adaptedBlock.works = center.Works;
      }
      if (Array.isArray(center.Parts) && adaptedBlock.parts.length === 0) {
        adaptedBlock.parts = center.Parts;
      }
      if (Array.isArray(center.Repairs) && adaptedBlock.repairs.length === 0) {
        adaptedBlock.repairs = center.Repairs;
      }
      
      console.log(`âœ… Adapted block ${index}:`, adaptedBlock);
      console.log(`ğŸ“‹ Parts found: ${adaptedBlock.parts.length}, Works found: ${adaptedBlock.works.length}`);
      
      return adaptedBlock;
    }
    
    // CREATE EDITABLE DAMAGE CENTER CARD
    function createEditableDamageCenterCard(block, index) {
      const centerNum = block.damage_center_number || (index + 1);
      const centerLocation = block.damage_center_name || block.Location || `××•×§×“ × ×–×§ ${centerNum}`;
      
      // Get VAT rate
      const vatRate = window.getHelperVatRate ? window.getHelperVatRate() / 100 : 0.17;
      const vatPercentage = vatRate * 100;
      
      // Calculate costs from parts, works, repairs
      const partsCost = block.parts?.reduce((sum, part) => sum + (parseFloat(part.price) || 0), 0) || 0;
      const worksCost = block.works?.reduce((sum, work) => sum + (parseFloat(work.cost) || 0), 0) || 0;
      const repairsCost = block.repairs?.reduce((sum, repair) => sum + (parseFloat(repair.cost) || 0), 0) || 0;
      
      const totalBeforeVat = partsCost + worksCost + repairsCost;
      const totalWithVAT = totalBeforeVat * (1 + vatRate);
      
      // Get existing parts, works, repairs from block
      const parts = block.parts || [];
      const works = block.works || [];
      const repairs = block.repairs || [];
      
      return `
        <div class="damage-center-card" data-center-index="${index}">
          <div class="damage-center-header">
            <h4>××•×§×“ × ×–×§ ××¡' ${centerNum}</h4>
            <button onclick="estimateRemoveDamageCenter(${index})" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">××—×§</button>
          </div>
          
          <!-- Damage Center Location Field -->
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1e3a8a;">×©× ××•×§×“ ×”× ×–×§:</label>
            <input type="text" class="damage-center-location" style="width: 100%; border: 1px solid #ddd; padding: 8px; border-radius: 4px; font-size: 14px;" placeholder="×”×–×Ÿ ×©×/××™×–×•×¨ ××•×§×“ ×”× ×–×§" value="${centerLocation}" />
          </div>
          
          <!-- Damage Description Field -->
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1e3a8a;">×ª×™××•×¨ ×”× ×–×§:</label>
            <textarea class="damage-center-description" style="width: 100%; min-height: 60px; border: 1px solid #ddd; padding: 8px; border-radius: 4px; font-size: 14px; resize: vertical;" placeholder="×”×–×Ÿ ×ª×™××•×¨ ××¤×•×¨×˜ ×©×œ ×”× ×–×§ ×‘××•×§×“ ×–×”...">${block.description || ''}</textarea>
          </div>

          <!-- Parts Section -->
          <div style="border: 1px solid #e2e8f0; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
            <h4 style="margin: 0 0 10px 0; color: #1e3a8a;">×—×œ×§×™× × ×“×¨×©×™×:</h4>
            <div class="parts-list" data-center="${index}">
              ${parts.map((part, partIndex) => createEditablePartRow(part, index, partIndex)).join('')}
            </div>
            <button onclick="estimateAddPartRow(${index})" class="btn" style="background: #28a745; color: white; padding: 6px 12px; margin-top: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">×”×•×¡×£ ×—×œ×§</button>
          </div>

          <!-- Works Section -->
          <div style="border: 1px solid #e2e8f0; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
            <h4 style="margin: 0 0 10px 0; color: #1e3a8a;">×¢×‘×•×“×•×ª × ×“×¨×©×•×ª:</h4>
            <div class="works-list" data-center="${index}">
              ${works.map((work, workIndex) => createEditableWorkRow(work, index, workIndex)).join('')}
            </div>
            <button onclick="estimateAddWorkRow(${index})" class="btn" style="background: #17a2b8; color: white; padding: 6px 12px; margin-top: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">×”×•×¡×£ ×¢×‘×•×“×”</button>
          </div>

          <!-- Cost Summary -->
          <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 14px;">
              <div><strong>×—×œ×§×™×:</strong> <span class="parts-costs-display">â‚ª${partsCost.toLocaleString()}</span></div>
              <div><strong>×¢×‘×•×“×•×ª:</strong> <span class="work-costs-display">â‚ª${worksCost.toLocaleString()}</span></div>
              <div><strong>×œ×¤× ×™ ××¢"×:</strong> <span class="total-before-vat">â‚ª${totalBeforeVat.toLocaleString()}</span></div>
              <div><strong>×›×•×œ×œ ××¢"×:</strong> <span class="total-with-vat-display">â‚ª${Math.round(totalWithVAT).toLocaleString()}</span></div>
            </div>
          </div>
        </div>
      `;
    }
    
    // CREATE EDITABLE PART ROW
    function createEditablePartRow(part, centerIndex, partIndex) {
      const partName = part?.name || '';
      const partDesc = part?.desc || part?.description || '';
      const partPrice = part?.price || 0;
      const partSource = part?.source || '×ª×—×œ×™×¤×™';
      
      return `
        <div class="part-row" data-center="${centerIndex}" data-part="${partIndex}" style="display: grid; grid-template-columns: 2fr 2fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
          <div style="position: relative;">
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×©× ×”×—×œ×§:</label>
            <input type="text" value="${partName}" placeholder="×©× ×”×—×œ×§" class="part-name" 
                   style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;"
                   onkeyup="showPartSuggestions(this, ${centerIndex}, ${partIndex})" />
            <div class="part-suggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; display: none; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×ª×™××•×¨:</label>
            <input type="text" value="${partDesc}" placeholder="×ª×™××•×¨ ×”×—×œ×§" class="part-desc" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">××—×™×¨:</label>
            <input type="number" value="${partPrice}" placeholder="××—×™×¨" class="part-price" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">××§×•×¨:</label>
            <select class="part-source" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
              <option value="××§×•×¨×™" ${partSource === '××§×•×¨×™' ? 'selected' : ''}>××§×•×¨×™</option>
              <option value="×ª×—×œ×™×¤×™" ${partSource === '×ª×—×œ×™×¤×™' ? 'selected' : ''}>×ª×—×œ×™×¤×™</option>
              <option value="××©×•××©" ${partSource === '××©×•××©' ? 'selected' : ''}>××©×•××©</option>
            </select>
          </div>
          <div style="align-self: end;">
            <button onclick="estimateRemovePartRow(${centerIndex}, ${partIndex})" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">××—×§</button>
          </div>
        </div>
      `;
    }
    
    // CREATE EDITABLE WORK ROW
    function createEditableWorkRow(work, centerIndex, workIndex) {
      const workName = work?.name || work?.work_name || '';
      const workType = work?.type || work?.work_type || '×¤×—×—×•×ª';
      const workCost = work?.cost || work?.work_cost || 0;
      
      return `
        <div class="work-row" data-center="${centerIndex}" data-work="${workIndex}" style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×ª×™××•×¨ ×”×¢×‘×•×“×”:</label>
            <input type="text" value="${workName}" placeholder="×ª×™××•×¨ ×”×¢×‘×•×“×”" class="work-name" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×¡×•×’ ×¢×‘×•×“×”:</label>
            <select class="work-type" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" onchange="handleWorkTypeChange(this, ${centerIndex}, ${workIndex})">
              <option value="×¤×—×—×•×ª" ${workType === '×¤×—×—×•×ª' ? 'selected' : ''}>×¤×—×—×•×ª</option>
              <option value="×¦×‘×¢" ${workType === '×¦×‘×¢' ? 'selected' : ''}>×¦×‘×¢</option>
              <option value="××›×•× ××•×ª" ${workType === '××›×•× ××•×ª' ? 'selected' : ''}>××›×•× ××•×ª</option>
              <option value="×—×©××œ" ${workType === '×—×©××œ' ? 'selected' : ''}>×—×©××œ</option>
              <option value="××—×¨" ${workType === '××—×¨' ? 'selected' : ''}>××—×¨</option>
            </select>
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×¢×œ×•×ª:</label>
            <input type="number" value="${workCost}" placeholder="×¢×œ×•×ª" class="work-cost" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />
          </div>
          <div style="align-self: end;">
            <button onclick="estimateRemoveWorkRow(${centerIndex}, ${workIndex})" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">××—×§</button>
          </div>
        </div>
      `;
    }

    function loadAdjustments(helper) {
      console.log('ğŸ“Š Load adjustments');
      // Implementation here
    }

    // Load gross values from helper (basic price + features + registration adjustments)
    function loadGrossValues(helper) {
      try {
        console.log('ğŸ—ï¸ Loading gross values from helper');
        
        // Auto-populate basic price using EXACT logic from final-report-builder
        const basicPriceField = document.getElementById('basicPrice');
        if (basicPriceField) {
          let basicPrice = 0;
          
          // PRIORITY MAPPING for basicPrice field - valuation.base_price FIRST
          if (helper.valuation?.base_price) {
            basicPrice = parseFloat(helper.valuation.base_price.toString().replace(/[â‚ª,]/g, ''));
            console.log('ğŸ“„ Found BASE PRICE in helper.valuation.base_price:', basicPrice);
          } else if (helper.levi_report?.base_price) {
            basicPrice = parseFloat(helper.levi_report.base_price);
            console.log('ğŸ“„ Found BASE PRICE in helper.levi_report.base_price:', basicPrice);
          } else if (helper.expertise?.levi_report?.base_price) {
            basicPrice = parseFloat(helper.expertise.levi_report.base_price);
            console.log('ğŸ“„ Found BASE PRICE in helper.expertise.levi_report.base_price:', basicPrice);
          } else if (helper.levisummary?.base_price) {
            basicPrice = parseFloat(helper.levisummary.base_price);
            console.log('ğŸ“„ Found BASE PRICE in helper.levisummary.base_price:', basicPrice);
          } else if (helper.car_details?.base_price) {
            basicPrice = parseFloat(helper.car_details.base_price.toString().replace(/[â‚ª,]/g, ''));
            console.log('ğŸ“„ Found BASE PRICE in helper.car_details.base_price:', basicPrice);
          }
          
          if (basicPrice > 0) {
            basicPriceField.value = `â‚ª${basicPrice.toLocaleString()}`;
            console.log('âœ… Auto-filled basic price field:', basicPrice);
            
            // Trigger helper update and calculation like in final-report-builder
            updateHelperFromField({ target: basicPriceField });
            setTimeout(() => {
              if (typeof updateGrossMarketValueCalculation === 'function') {
                updateGrossMarketValueCalculation();
              }
            }, 100);
          } else {
            console.warn('âš ï¸ No BASE PRICE found in helper for auto-population');
          }
        }
        
        // Load gross adjustments from helper data using EXACT same logic as final-report-builder
        loadGrossAdjustmentsFromHelper(helper);
        
        // FALLBACK: Load existing gross adjustments from helper.estimate.gross_sections if no helper data
        if (helper.estimate?.gross_sections) {
          const grossValueSection = helper.estimate.gross_sections.find(
            section => section.section_type === 'gross_vehicle_value'
          );
          
          if (grossValueSection?.data) {
            const data = grossValueSection.data;
            
            // Only load from estimate if no adjustments were loaded from helper
            const existingFeatures = document.querySelectorAll('#featuresAdjustmentsList > div');
            const existingRegistration = document.querySelectorAll('#registrationAdjustmentsList > div');
            
            if (existingFeatures.length === 0 && data.features_adjustments && data.features_adjustments.length > 0) {
              console.log('ğŸ“ Loading features adjustments from helper.estimate.gross_sections (fallback)');
              data.features_adjustments.forEach(adjustment => {
                addFeatureAdjustment();
                const rows = document.querySelectorAll('#featuresAdjustmentsList > div');
                const lastRow = rows[rows.length - 1];
                if (lastRow) {
                  const inputs = lastRow.querySelectorAll('input, select');
                  if (inputs[0]) inputs[0].value = adjustment.description || '';
                  if (inputs[1]) inputs[1].value = adjustment.type || 'plus';
                  if (inputs[2]) inputs[2].value = adjustment.percentage || '';
                  if (inputs[3]) inputs[3].value = adjustment.value || '';
                }
              });
            }
            
            if (existingRegistration.length === 0 && data.registration_adjustments && data.registration_adjustments.length > 0) {
              console.log('ğŸ“… Loading registration adjustments from helper.estimate.gross_sections (fallback)');
              data.registration_adjustments.forEach(adjustment => {
                addRegistrationAdjustment();
                const rows = document.querySelectorAll('#registrationAdjustmentsList > div');
                const lastRow = rows[rows.length - 1];
                if (lastRow) {
                  const inputs = lastRow.querySelectorAll('input, select');
                  if (inputs[0]) inputs[0].value = adjustment.description || '';
                  if (inputs[1]) inputs[1].value = adjustment.type || 'plus';
                  if (inputs[2]) inputs[2].value = adjustment.percentage || '';
                  if (inputs[3]) inputs[3].value = adjustment.value || '';
                }
              });
            }
          }
        }
        
        // Also load gross percentage section fields using same helper mapping as final-report-builder
        loadGrossPercentageFields(helper);
        
        // Trigger calculation after loading
        setTimeout(() => {
          if (typeof updateGrossMarketValueCalculation === 'function') {
            updateGrossMarketValueCalculation();
          }
          
          // ALSO SYNC TO gross_value_adjustments after auto-populating
          let helperStr = sessionStorage.getItem('helper');
          if (helperStr && helperStr !== 'undefined') {
            let helper = JSON.parse(helperStr);
            helper = syncAdjustmentToEstimateHelper(null, 'features', helper) || helper;
            helper = syncAdjustmentToEstimateHelper(null, 'registration', helper) || helper;
            sessionStorage.setItem('helper', JSON.stringify(helper));
            window.helper = helper;
            console.log('âœ… Synced auto-populated data to gross_value_adjustments');
          }
        }, 200);
        
      } catch (error) {
        console.error('âŒ Error loading gross values:', error);
      }
    }
    
    // Load gross percentage fields using exact mapping from final-report-builder
    function loadGrossPercentageFields(helper) {
      try {
        console.log('ğŸ“Š Loading gross percentage fields from helper');
        
        // Map totalDamageCost field - from claims_data.total_claim
        const totalDamageCostField = document.getElementById('totalDamageCost');
        if (totalDamageCostField && helper.claims_data?.total_claim) {
          // Remove formatting (â‚ª symbol and commas) before parsing
          const totalClaim = parseFloat(helper.claims_data.total_claim.toString().replace(/[â‚ª,]/g, '')) || 0;
          if (totalClaim > 0) {
            totalDamageCostField.value = `â‚ª${totalClaim.toLocaleString()}`;
            console.log('âœ… Loaded totalDamageCost from claims_data.total_claim:', totalClaim);
          }
        }
        
        // Map grossValueDisplay field (estimator-builder field ID) - using EXACT logic from final-report-builder  
        const grossValueDisplayField = document.getElementById('grossValueDisplay');
        if (grossValueDisplayField) {
          let leviPrice = 0;
          
          // SAME PRIORITY as basicPrice field - valuation.base_price FIRST
          if (helper.valuation?.base_price) {
            leviPrice = parseFloat(helper.valuation.base_price.toString().replace(/[â‚ª,]/g, ''));
          } else if (helper.levi_report?.base_price) {
            leviPrice = parseFloat(helper.levi_report.base_price);
          } else if (helper.expertise?.levi_report?.base_price) {
            leviPrice = parseFloat(helper.expertise.levi_report.base_price);
          } else if (helper.levisummary?.base_price) {
            leviPrice = parseFloat(helper.levisummary.base_price);
          } else if (helper.car_details?.base_price) {
            leviPrice = parseFloat(helper.car_details.base_price.toString().replace(/[â‚ª,]/g, ''));
          }
          
          if (leviPrice > 0) {
            grossValueDisplayField.value = `â‚ª${leviPrice.toLocaleString()}`;
            console.log('âœ… Auto-filled grossValueDisplay:', leviPrice);
          }
        }
        
        console.log('âœ… Gross percentage fields loaded from helper');
        
      } catch (error) {
        console.error('âŒ Error loading gross percentage fields:', error);
      }
    }

    // Load gross adjustments - EXACT COPY from final-report-builder loadGrossAdjustments function
    function loadGrossAdjustmentsFromHelper(helper) {
      try {
        // FIRST LOAD THE BASIC PRICE!
        const basicPriceField = document.getElementById('basicPrice');
        if (basicPriceField && helper.valuation?.base_price) {
          basicPriceField.value = `â‚ª${helper.valuation.base_price.toLocaleString()}`;
          console.log('âœ… Loaded basic price:', helper.valuation.base_price);
        }
        
        // ALSO LOAD TOTAL DAMAGE COST
        const totalDamageCostField = document.getElementById('totalDamageCost');
        if (totalDamageCostField && helper.claims_data?.total_claim) {
          // Remove formatting (â‚ª symbol and commas) before parsing
          const totalClaim = parseFloat(helper.claims_data.total_claim.toString().replace(/[â‚ª,]/g, '')) || 0;
          if (totalClaim > 0) {
            totalDamageCostField.value = `â‚ª${totalClaim.toLocaleString()}`;
            console.log('âœ… Loaded totalDamageCost from claims_data.total_claim:', totalClaim);
          }
        }
        
        const featuresContainer = document.getElementById('featuresAdjustmentsList');
        const registrationContainer = document.getElementById('registrationAdjustmentsList');

        if (featuresContainer) featuresContainer.innerHTML = '';
        if (registrationContainer) registrationContainer.innerHTML = '';

        const leviData = helper.valuation?.adjustments || {};
        const featuresData = leviData.features || {};
        const registrationData = leviData.registration || {};
        
        console.log('EXACT DATA:', { leviData, featuresData, registrationData });

        // ===== Features Adjustments =====
        // Check if features exist using EXACT path from your screenshot
        if (helper.valuation?.adjustments?.features?.value || helper.valuation?.adjustments?.features?.percentage) {
          if (typeof addFeatureAdjustment === 'function') {
            addFeatureAdjustment();
            const row = document.querySelector('#featuresAdjustmentsList > div:last-child');
            if (row) {
              const inputs = row.querySelectorAll('input, select');
              
              // Use EXACT paths from your mapping
              const amount = parseFloat(helper.valuation.adjustments.features.amount?.toString().replace(/[â‚ª,\s]/g, '')) || 0;
              const percent = parseFloat(helper.valuation.adjustments.features.percentage) || 0;
              
              if (inputs.length >= 4) {
                // Use description from the exact path 
                const desc = helper.valuation?.adjustments?.features?.description || helper.valuation?.adjustments?.features?.value || '';
                inputs[0].value = desc;
                
                // Determine type based on negative values in helper data
                const isNegative = (amount < 0 || percent < 0);
                inputs[1].value = isNegative ? 'minus' : 'plus';
              
                inputs[2].value = percent ? Math.abs(percent) : '';
                
                // If amount exists in helper, use it; otherwise calculate from percentage
                if (amount) {
                  inputs[3].value = `â‚ª${Math.abs(amount).toLocaleString()}`;
                } else if (percent && typeof calculateAdjustmentValueSimple === 'function') {
                  // Trigger calculation from percentage Ã— base price
                  setTimeout(() => calculateAdjustmentValueSimple(inputs[2]), 100);
                }
              }
            }
          }
        }

        // ===== Registration Adjustment =====
        console.log('Registration check:', registrationData);
        if (registrationData.amount || registrationData.percent || registrationData.date || registrationData.description || registrationData.value) {
          if (typeof addRegistrationAdjustment === 'function') {
            addRegistrationAdjustment();
            const row = document.querySelector('#registrationAdjustmentsList > div:last-child');
            if (row) {
              const inputs = row.querySelectorAll('input, select');
              
              // Parse amount using EXACT path: helper.valuation.adjustments.registration.amount
              let amount = 0;
              if (helper.valuation?.adjustments?.registration?.amount) {
                amount = parseFloat(helper.valuation.adjustments.registration.amount.toString().replace(/[â‚ª,\s]/g, '')) || 0;
              }
              
              let percent = parseFloat(helper.valuation?.adjustments?.registration?.percent) || 0;
              
              if (inputs.length >= 4) {
                // Use the EXACT path from your mapping: helper.valuation.adjustments.registration.value
                const desc = helper.valuation?.adjustments?.registration?.value || helper.valuation?.adjustments?.registration?.description || helper.valuation?.adjustments?.registration?.date || helper.vehicle?.registration_date || '×¢×œ×™×” ×œ×›×‘×™×©';
                inputs[0].value = desc;
                console.log('Set registration description:', desc);
                
                // Determine type based on negative values in helper data
                const isNegative = (amount < 0 || percent < 0);
                inputs[1].value = isNegative ? 'minus' : 'plus';
              
                inputs[2].value = percent ? Math.abs(percent) : '';
                
                // If amount exists in helper, use it; otherwise calculate from percentage
                if (amount) {
                  inputs[3].value = `â‚ª${Math.abs(amount).toLocaleString()}`;
                  console.log('Set registration amount:', `â‚ª${Math.abs(amount).toLocaleString()}`);
                } else if (percent && typeof calculateAdjustmentValueSimple === 'function') {
                  // Trigger calculation from percentage Ã— base price
                  setTimeout(() => calculateAdjustmentValueSimple(inputs[2]), 100);
                }
                
                console.log('Final registration inputs:', {
                  description: inputs[0].value,
                  type: inputs[1].value, 
                  percent: inputs[2].value,
                  amount: inputs[3].value
                });
              }
            }
          }
        }

        updateGrossMarketValueCalculation();

      } catch (error) {
        console.error('âŒ Error loading gross adjustments from helper:', error);
      }
    }

    function loadDepreciation(helper) {
      console.log('ğŸ“‰ Load depreciation');
      // Implementation here
    }

    function loadClaimsData(helper) {
      console.log('ğŸ’° Load claims data');
      // Implementation here
    }

    function loadAdditionalNotes(helper) {
      const notes = helper.estimate?.notes || '';
      const notesField = document.getElementById('additional-notes');
      if (notesField && notes) {
        notesField.value = notes;
      }
    }

    function collectVehicleData() {
      return {
        plate: document.getElementById('carPlate')?.value || '',
        manufacturer: document.getElementById('carManufacturer')?.value || '',
        model: document.getElementById('carModel')?.value || '',
        year: document.getElementById('carYear')?.value || '',
        modelCode: document.getElementById('carModelCode')?.value || '',
        basePrice: document.getElementById('carBasePrice')?.value || '',
        marketValue: document.getElementById('carMarketValue')?.value || '',
        reportDate: document.getElementById('carReportDate')?.value || ''
      };
    }

    function collectContactData() {
      return {
        ownerName: document.getElementById('ownerName')?.value || '',
        ownerAddress: document.getElementById('ownerAddress')?.value || '',
        ownerPhone: document.getElementById('ownerPhone')?.value || '',
        insuranceCompany: document.getElementById('insuranceCompany')?.value || '',
        insuranceEmail: document.getElementById('insuranceEmail')?.value || '',
        insuranceAgent: document.getElementById('insuranceAgent')?.value || '',
        agentPhone: document.getElementById('agentPhone')?.value || '',
        agentEmail: document.getElementById('agentEmail')?.value || '',
        garageName: document.getElementById('garageName')?.value || '',
        garagePhone: document.getElementById('garagePhone')?.value || '',
        garageEmail: document.getElementById('garageEmail')?.value || ''
      };
    }

    // CREATE EDITABLE PART ROW - FROM FINAL-REPORT-BUILDER
    function createEditablePartRow(part, centerIndex, partIndex) {
      const partName = part?.name || '';
      const partDesc = part?.desc || part?.description || part?.×ª×™××•×¨ || '';
      const partPrice = part?.price || 0;
      const partSource = part?.source || part?.××§×•×¨ || '';
      
      return `
        <div class="part-row" data-center="${centerIndex}" data-part="${partIndex}" style="display: grid; grid-template-columns: 2fr 2fr 1fr auto; gap: 8px; margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
          <div style="position: relative;">
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×©× ×”×—×œ×§:</label>
            <input type="text" value="${partName}" placeholder="×©× ×”×—×œ×§" class="part-name" 
                   style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;"
                   onkeyup="showPartSuggestions(this, ${centerIndex}, ${partIndex})" />
            <div class="part-suggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; display: none; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×ª×™××•×¨:</label>
            <input type="text" value="${partDesc}" placeholder="×ª×™××•×¨ ×”×—×œ×§" class="part-desc" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×¢×œ×•×ª (â‚ª):</label>
            <input type="number" value="${partPrice}" placeholder="0" class="part-price" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" min="0" step="0.01" />
          </div>
          <button onclick="estimateRemovePartRow(${centerIndex}, ${partIndex})" style="background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; align-self: end;">××—×§</button>
          <input type="hidden" value="${partSource}" class="part-source" />
        </div>
      `;
    }

    // CREATE EDITABLE WORK ROW WITH DROPDOWN - FROM FINAL-REPORT-BUILDER
    function createEditableWorkRow(work, centerIndex, workIndex) {
      const workTypes = [
        '×›×œ ×¢×‘×•×“×•×ª ×”×¤×—×—×•×ª ×›×•×œ×œ ×¤×™×¨×•×§×™× ×•×”×¨×›×‘×•×ª','×¢×‘×•×“×•×ª ×¦×‘×¢', '×¢×‘×•×“×•×ª ×—×©××œ', '×¢×‘×•×“×•×ª ××›×•× ××•×ª', 
        '×¢×‘×•×“×•×ª ××–×’×Ÿ', '×¢×‘×•×“×•×ª ×¨×™×¤×•×“', '×¢×‘×•×“×•×ª ×–×’×’×•×ª',
        '××™×˜×•× ×•×–×™×¤×•×ª', '×‘×“×™×§×ª ××ª×œ×”', '×”× ×–×§ ××—×™×™×‘ ×ª×§× ×” 309',
        '×›×™×•×œ ×¨×“××¨', '×”×¢×‘×¨×ª ×—×™×™×©× ×™×', '××—×¨'
      ];
      
      const workType = typeof work === 'object' ? (work.category || work.type) : work;
      const workNote = typeof work === 'object' ? (work.comments || work.note || '') : '';
      const workCost = typeof work === 'object' ? work.cost : 0;
      
      return `
        <div class="work-row" data-center="${centerIndex}" data-work="${workIndex}" style="display: grid; grid-template-columns: 2fr 2fr 1fr auto; gap: 8px; margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×¡×•×’ ×¢×‘×•×“×”:</label>
            <select class="work-type" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" onchange="handleWorkTypeChange(this, ${centerIndex}, ${workIndex})">
              ${workTypes.map(type => `<option value="${type}" ${type === workType ? 'selected' : ''}>${type}</option>`).join('')}
            </select>
            <input type="text" class="work-type-other" placeholder="×”×›× ×¡ ×¡×•×’ ×¢×‘×•×“×” ××—×¨" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; margin-top: 4px; display: ${workType === '××—×¨' ? 'block' : 'none'};" />
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×”×¢×¨×•×ª:</label>
            <input type="text" value="${workNote}" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª" class="work-note" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×¢×œ×•×ª (â‚ª):</label>
            <input type="number" value="${workCost}" placeholder="0" class="work-cost" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" min="0" step="0.01" />
          </div>
          <button onclick="estimateRemoveWorkRow(${centerIndex}, ${workIndex})" style="background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; align-self: end;">××—×§</button>
        </div>
      `;
    }

    // CREATE EDITABLE REPAIR ROW - FROM FINAL-REPORT-BUILDER
    function createEditableRepairRow(repair, centerIndex, repairIndex) {
      const repairText = typeof repair === 'object' ? repair.description : repair;
      const repairCost = typeof repair === 'object' ? repair.cost : 0;
      
      return `
        <div class="repair-row" data-center="${centerIndex}" data-repair="${repairIndex}" style="display: grid; grid-template-columns: 3fr 1fr auto; gap: 8px; margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×ª×™××•×¨ ×”×ª×™×§×•×Ÿ:</label>
            <textarea placeholder="×ª×™××•×¨ ×”×ª×™×§×•×Ÿ" class="repair-text" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; min-height: 60px; resize: vertical;">${repairText}</textarea>
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×¢×œ×•×ª (â‚ª):</label>
            <input type="number" value="${repairCost}" placeholder="0" class="repair-cost" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" min="0" step="0.01" />
          </div>
          <button onclick="estimateRemoveRepairRow(${centerIndex}, ${repairIndex})" style="background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; height: 32px; margin-top: 14px;">××—×§</button>
        </div>
      `;
    }

    // Add/Remove functions
    window.estimateAddPartRow = function(centerIndex) {
      const partsList = document.querySelector(`[data-center-index="${centerIndex}"] .parts-list`);
      if (partsList) {
        const partIndex = partsList.children.length;
        const newPartHTML = createEditablePartRow({}, centerIndex, partIndex);
        partsList.insertAdjacentHTML('beforeend', newPartHTML);
        addDamageCenterEventListeners();
      }
    };

    window.estimateAddWorkRow = function(centerIndex) {
      const worksList = document.querySelector(`[data-center-index="${centerIndex}"] .works-list`);
      if (worksList) {
        const workIndex = worksList.children.length;
        const newWorkHTML = createEditableWorkRow({}, centerIndex, workIndex);
        worksList.insertAdjacentHTML('beforeend', newWorkHTML);
        addDamageCenterEventListeners();
      }
    };

    window.estimateAddRepairRow = function(centerIndex) {
      const repairsList = document.querySelector(`[data-center-index="${centerIndex}"] .repairs-list`);
      if (repairsList) {
        const repairIndex = repairsList.children.length;
        const newRepairHTML = createEditableRepairRow({}, centerIndex, repairIndex);
        repairsList.insertAdjacentHTML('beforeend', newRepairHTML);
        addDamageCenterEventListeners();
      }
    };

    window.estimateRemovePartRow = function(centerIndex, partIndex) {
      const row = document.querySelector(`[data-center="${centerIndex}"][data-part="${partIndex}"]`);
      if (row) {
        row.remove();
      }
    };

    window.estimateRemoveWorkRow = function(centerIndex, workIndex) {
      const row = document.querySelector(`[data-center="${centerIndex}"][data-work="${workIndex}"]`);
      if (row) {
        row.remove();
      }
    };

    window.estimateRemoveRepairRow = function(centerIndex, repairIndex) {
      const row = document.querySelector(`[data-center="${centerIndex}"][data-repair="${repairIndex}"]`);
      if (row) {
        row.remove();
      }
    };

    window.estimateRemoveDamageCenter = function(index) {
      if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××•×§×“ × ×–×§ ×–×”?')) {
        const card = document.querySelector(`[data-center-index="${index}"]`);
        if (card) {
          card.remove();
        }
      }
    };

    // Helper function for work type change
    window.handleWorkTypeChange = function(selectElement, centerIndex, workIndex) {
      const otherInput = selectElement.parentElement.querySelector('.work-type-other');
      if (selectElement.value === '××—×¨') {
        otherInput.style.display = 'block';
      } else {
        otherInput.style.display = 'none';
      }
    };

    // Stub for part suggestions (can be implemented later)
    window.showPartSuggestions = function(input, centerIndex, partIndex) {
      // Part suggestions functionality would go here
    };

    // ADD NEW DAMAGE CENTER
    window.addNewDamageCenter = function() {
      const editableContainer = document.getElementById('editableDamageCenters');
      if (!editableContainer) {
        // Create the container if it doesn't exist
        const damageCentersContent = document.getElementById('damageCentersContent');
        damageCentersContent.innerHTML = '<div style="display: grid; gap: 15px;" id="editableDamageCenters"></div>';
      }
      
      const container = document.getElementById('editableDamageCenters');
      const newIndex = container.children.length;
      
      // Create new empty damage center
      const newCenter = {
        damage_center_name: `××•×§×“ × ×–×§ ${newIndex + 1}`,
        damage_center_number: newIndex + 1,
        description: '',
        parts: [],
        works: [],
        repairs: []
      };
      
      const newCardHTML = createEditableDamageCenterCard(newCenter, newIndex);
      container.insertAdjacentHTML('beforeend', newCardHTML);
      
      // Add event listeners to the new card
      setTimeout(() => {
        addDamageCenterEventListeners();
        // Focus on the name field
        const nameField = container.querySelector(`[data-center-index="${newIndex}"] .damage-center-location`);
        if (nameField) nameField.focus();
      }, 100);
      
      // Save the new damage center
      setTimeout(() => {
        saveDamageCenterChanges();
      }, 200);
    };

    // ADD DAMAGE CENTER EVENT LISTENERS - AUTO-SAVE ON CHANGE
    function addDamageCenterEventListeners() {
      const selectors = '.damage-center-number, .damage-center-location, .damage-center-description, .part-name, .part-desc, .part-price, .part-source, .work-type, .work-type-other, .work-note, .work-cost, .repair-text, .repair-cost';
      
      document.querySelectorAll(selectors).forEach(input => {
        // Check if already has listeners
        if (!input.hasAttribute('data-listeners-added')) {
          input.addEventListener('change', () => {
            saveDamageCenterChanges();
            updateAllCostDisplays();
          });
          input.addEventListener('blur', () => {
            saveDamageCenterChanges();
            updateAllCostDisplays();
          });
          input.addEventListener('input', () => {
            updateAllCostDisplays();
          });
          
          // Mark as having listeners to prevent duplicates
          input.setAttribute('data-listeners-added', 'true');
        }
      });
      
      // Hide suggestions when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.part-row')) {
          document.querySelectorAll('.part-suggestions').forEach(div => {
            div.style.display = 'none';
          });
        }
      });
    }

    // UPDATE COST DISPLAY FOR A DAMAGE CENTER
    function updateCostDisplay(card, partsCost = null, worksCost = null, repairsCost = null) {
      if (!card) return;
      
      // Calculate costs if not provided
      if (partsCost === null) {
        partsCost = 0;
        card.querySelectorAll('.part-row').forEach(row => {
          const price = parseFloat(row.querySelector('.part-price').value) || 0;
          partsCost += price;
        });
      }
      
      if (worksCost === null) {
        worksCost = 0;
        card.querySelectorAll('.work-row').forEach(row => {
          const cost = parseFloat(row.querySelector('.work-cost').value) || 0;
          worksCost += cost;
        });
      }
      
      if (repairsCost === null) {
        repairsCost = 0;
        card.querySelectorAll('.repair-row').forEach(row => {
          const cost = parseFloat(row.querySelector('.repair-cost').value) || 0;
          repairsCost += cost;
        });
      }
      
      // Update display
      const partsDisplay = card.querySelector('.parts-costs-display');
      const worksDisplay = card.querySelector('.work-costs-display');
      const repairsDisplay = card.querySelector('.repairs-costs-display');
      const totalDisplay = card.querySelector('.total-with-vat-display');
      
      if (partsDisplay) partsDisplay.textContent = `â‚ª${partsCost.toLocaleString()}`;
      if (worksDisplay) worksDisplay.textContent = `â‚ª${worksCost.toLocaleString()}`;
      if (repairsDisplay) repairsDisplay.textContent = `â‚ª${repairsCost.toLocaleString()}`;
      
      // Calculate total with VAT
      const totalCost = partsCost + worksCost + repairsCost;
      const vatRate = (window.getHelperVatRate ? window.getHelperVatRate() / 100 : 0.17);
      const totalWithVAT = totalCost * (1 + vatRate);
      
      if (totalDisplay) totalDisplay.textContent = `â‚ª${Math.round(totalWithVAT).toLocaleString()}`;
    }

    // UPDATE ALL COST DISPLAYS
    function updateAllCostDisplays() {
      document.querySelectorAll('.editable-damage-card').forEach(card => {
        updateCostDisplay(card);
      });
      
      // Update subtotal if exists
      if (typeof updateDamageCentersSubtotal === 'function') {
        updateDamageCentersSubtotal();
      }
    }

    // LOAD DAMAGE CENTERS SUMMARY - EXACT COPY FROM FINAL-REPORT-BUILDER
    function loadDamageCentersSummary(helper) {
      try {
        const damageCentersContent = document.getElementById('damageCentersContent');
        
        const damageCenters = helper.centers || 
                             helper.damage_centers || 
                             helper.expertise?.damage_blocks || [];
        
        if (damageCenters && damageCenters.length > 0) {
          let summaryHTML = '<div style="display: grid; gap: 15px;" id="editableDamageCenters">';
          
          damageCenters.forEach((center, index) => {
            const adaptedCenter = adaptCenterToBlock(center, index);
            summaryHTML += createEditableDamageCenterCard(adaptedCenter, index);
          });
          
          summaryHTML += '</div>';
          damageCentersContent.innerHTML = summaryHTML;
          
          setTimeout(addDamageCenterEventListeners, 100);
          
          // Add subtotal section after damage centers
          createDamageCentersSubtotal();
          
          // Update all cost displays after loading
          setTimeout(() => {
            document.querySelectorAll('.editable-damage-card').forEach(card => {
              updateCostDisplay(card);
            });
            updateDamageCentersSubtotal();
          }, 150);
        } else {
          damageCentersContent.innerHTML = '<div style="color: #666; text-align: center;">×œ× × ××¦××• × ×ª×•× ×™ ××•×§×“×™ × ×–×§ - ×œ×—×¥ "×”×•×¡×£ ××•×§×“ × ×–×§ ×—×“×©" ×›×“×™ ×œ×”×ª×—×™×œ</div>';
        }
      } catch (error) {
        console.error('Error loading damage centers summary:', error);
        document.getElementById('damageCentersContent').innerHTML = '<div style="color: #dc3545; text-align: center;">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ××•×§×“×™ × ×–×§</div>';
      }
    }

    function adaptCenterToBlock(center, index) {
      const adaptedBlock = {
        damage_center_name: center.Location || center.damage_center_name || `××•×§×“ × ×–×§ ${index + 1}`,
        damage_center_number: (() => {
          const num = center["Damage center Number"] || center.damage_center_number || (index + 1);
          if (typeof num === 'string' && num.includes('××•×§×“')) {
            const match = num.match(/\d+$/);
            return match ? match[0] : String(index + 1);
          }
          return num;
        })(),
        description: center.Description || center.description || '',
        works: center.Works?.works || center.works || [],
        parts: center.Parts?.parts_required || center.Parts?.parts || center.parts_required || center.parts || center.Parts || [],
        repairs: center.Repairs?.repairs || center.repairs || [],
        works_meta: center.Works?.works_meta || center.works_meta || { total_cost: 0 },
        parts_meta: center.Parts?.parts_meta || center.parts_meta || { total_cost: 0 },
        repairs_meta: center.Repairs?.repairs_meta || center.repairs_meta || { total_cost: 0 },
        total_cost: center.Summary?.["Total with VAT"] || center.total_cost || 0
      };
      
      if (Array.isArray(center.Works) && adaptedBlock.works.length === 0) {
        adaptedBlock.works = center.Works;
      }
      if (Array.isArray(center.Parts) && adaptedBlock.parts.length === 0) {
        adaptedBlock.parts = center.Parts;
      }
      if (Array.isArray(center.Repairs) && adaptedBlock.repairs.length === 0) {
        adaptedBlock.repairs = center.Repairs;
      }
      
      return adaptedBlock;
    }

    // CREATE DAMAGE CENTERS SUBTOTAL - FROM ORIGINAL
    function createDamageCentersSubtotal() {
      const existingSubtotal = document.getElementById('damageCentersSubtotal');
      if (existingSubtotal) {
        return; // Already exists
      }
      
      const damageCentersContent = document.getElementById('damageCentersContent');
      if (!damageCentersContent) return;
      
      const subtotalHTML = `
        <div id="damageCentersSubtotal" style="background: #f8f9fa; border: 2px solid #28a745; border-radius: 6px; padding: 12px; margin-top: 15px;">
          <h4 style="margin: 0 0 10px 0; color: #28a745; text-align: center; font-size: 14px; font-weight: bold;">ğŸ§® ×¡×™×›×•× ×›×œ×œ×™ - ××¨×›×–×™ × ×–×§</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-bottom: 8px;">
            <div style="background: #ffc107; color: #212529; padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 16px; font-weight: bold;" id="totalRepairsSubtotal">â‚ª0</div>
              <div style="font-size: 10px;">×¡×”"×› ×ª×™×§×•× ×™×</div>
            </div>
            <div style="background: #28a745; color: white; padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 16px; font-weight: bold;" id="totalPartsSubtotal">â‚ª0</div>
              <div style="font-size: 10px; opacity: 0.9;">×¡×”"×› ×—×œ×§×™×</div>
            </div>
            <div style="background: #17a2b8; color: white; padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 16px; font-weight: bold;" id="totalWorksSubtotal">â‚ª0</div>
              <div style="font-size: 10px; opacity: 0.9;">×¡×”"×› ×¢×‘×•×“×•×ª</div>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <div style="background: #dc3545; color: white; padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 18px; font-weight: bold;" id="totalWithVatSubtotal">â‚ª0</div>
              <div style="font-size: 11px; opacity: 0.9;">×¡×”"×› ×›×•×œ×œ ××¢"×</div>
            </div>
            <div style="background: #6c757d; color: white; padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 18px; font-weight: bold;" id="totalWithoutVatSubtotal">â‚ª0</div>
              <div style="font-size: 11px; opacity: 0.9;">×¡×”"×› ×œ×œ× ××¢"×</div>
            </div>
          </div>
        </div>
      `;
      
      damageCentersContent.insertAdjacentHTML('afterend', subtotalHTML);
      
      // Move the buttons div to after subtotal
      const buttonsDiv = document.getElementById('damageCenterButtons');
      if (buttonsDiv) {
        buttonsDiv.style.display = 'block';
        const subtotalElement = document.getElementById('damageCentersSubtotal');
        if (subtotalElement && subtotalElement.parentNode) {
          subtotalElement.parentNode.insertBefore(buttonsDiv, subtotalElement.nextSibling);
        }
      }
      
      // Add collapse button after buttons
      const collapseButtonHTML = `
        <div style="text-align: center; margin-top: 10px;">
          <button type="button" class="btn section-collapse-button" onclick="toggleSection('damageCentersSummary')" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">×›×•×•×¥ ×¡×¢×™×£</button>
        </div>
      `;
      
      const buttonsElement = document.getElementById('damageCenterButtons');
      if (buttonsElement) {
        buttonsElement.insertAdjacentHTML('afterend', collapseButtonHTML);
      }
    }

    // UPDATE DAMAGE CENTERS SUBTOTAL
    function updateDamageCentersSubtotal() {
      let totalParts = 0;
      let totalWorks = 0;
      let totalRepairs = 0;
      
      // Calculate totals from all damage centers
      document.querySelectorAll('.editable-damage-card').forEach(card => {
        // Parts
        card.querySelectorAll('.part-row .part-price').forEach(input => {
          totalParts += parseFloat(input.value) || 0;
        });
        
        // Works
        card.querySelectorAll('.work-row .work-cost').forEach(input => {
          totalWorks += parseFloat(input.value) || 0;
        });
        
        // Repairs
        card.querySelectorAll('.repair-row .repair-cost').forEach(input => {
          totalRepairs += parseFloat(input.value) || 0;
        });
      });
      
      // Calculate totals
      const totalBeforeVAT = totalParts + totalWorks + totalRepairs;
      const vatRate = (window.getHelperVatRate ? window.getHelperVatRate() / 100 : 0.17);
      const totalWithVAT = totalBeforeVAT * (1 + vatRate);
      
      // Update displays
      const partsElement = document.getElementById('totalPartsSubtotal');
      const worksElement = document.getElementById('totalWorksSubtotal');
      const repairsElement = document.getElementById('totalRepairsSubtotal');
      const withoutVatElement = document.getElementById('totalWithoutVatSubtotal');
      const withVatElement = document.getElementById('totalWithVatSubtotal');
      
      if (partsElement) partsElement.textContent = `â‚ª${totalParts.toLocaleString()}`;
      if (worksElement) worksElement.textContent = `â‚ª${totalWorks.toLocaleString()}`;
      if (repairsElement) repairsElement.textContent = `â‚ª${totalRepairs.toLocaleString()}`;
      if (withoutVatElement) withoutVatElement.textContent = `â‚ª${totalBeforeVAT.toLocaleString()}`;
      if (withVatElement) withVatElement.textContent = `â‚ª${Math.round(totalWithVAT).toLocaleString()}`;
    }

    function createEditableDamageCenterCard(block, index) {
      const centerNum = block.damage_center_number || (index + 1);
      const centerLocation = block.damage_center_name || block.Location || `××•×§×“ × ×–×§ ${centerNum}`;
      
      // Calculate initial costs from actual data
      let workCosts = 0;
      let partsCosts = 0; 
      let repairsCosts = 0;
      
      // Calculate from existing data if available
      if (block.works && Array.isArray(block.works)) {
        workCosts = block.works.reduce((sum, work) => sum + (parseFloat(work.cost) || 0), 0);
      }
      if (block.parts && Array.isArray(block.parts)) {
        partsCosts = block.parts.reduce((sum, part) => sum + (parseFloat(part.price) || 0), 0);
      }
      if (block.repairs && Array.isArray(block.repairs)) {
        repairsCosts = block.repairs.reduce((sum, repair) => sum + (parseFloat(repair.cost) || 0), 0);
      }
      
      const totalCost = workCosts + partsCosts + repairsCosts;
      const vatRate = (window.getHelperVatRate ? window.getHelperVatRate() / 100 : 0.17);
      const totalWithVAT = totalCost * (1 + vatRate);
      
      const parts = block.parts || [];
      const works = block.works || [];
      const repairs = block.repairs || [];
      
      return `
        <div class="editable-damage-card" data-center-index="${index}" style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="font-weight: bold; color: #1e3a8a; font-size: 16px;">××•×§×“ × ×–×§ ××¡'</span>
              <input type="text" value="${centerNum}" class="damage-center-number" style="font-weight: bold; color: #1e3a8a; font-size: 16px; border: 1px solid #ddd; padding: 8px; border-radius: 4px; width: 50px; text-align: center;" />
            </div>
            <button onclick="estimateRemoveDamageCenter(${index})" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">××—×§</button>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1e3a8a;">×©× ××•×§×“ ×”× ×–×§:</label>
            <input type="text" class="damage-center-location" style="width: 100%; border: 1px solid #ddd; padding: 8px; border-radius: 4px; font-size: 14px;" placeholder="×”×–×Ÿ ×©×/××™×–×•×¨ ××•×§×“ ×”× ×–×§ (×œ×“×•×’××”: ×¤×’×•×© ×§×“××™, ×“×œ×ª × ×”×’, ×•×›×•')" value="${centerLocation}" />
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1e3a8a;">×ª×™××•×¨ ×”× ×–×§:</label>
            <textarea class="damage-center-description" style="width: 100%; min-height: 60px; border: 1px solid #ddd; padding: 8px; border-radius: 4px; font-size: 14px; resize: vertical;" placeholder="×”×–×Ÿ ×ª×™××•×¨ ××¤×•×¨×˜ ×©×œ ×”× ×–×§ ×‘××•×§×“ ×–×”...">${block.description || ''}</textarea>
          </div>

          <div style="border: 1px solid #e2e8f0; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
            <h4 style="margin: 0 0 10px 0; color: #1e3a8a;">×—×œ×§×™× × ×“×¨×©×™×:</h4>
            <div class="parts-list" data-center="${index}">
              ${parts.map((part, partIndex) => createEditablePartRow(part, index, partIndex)).join('')}
            </div>
            <button onclick="estimateAddPartRow(${index})" class="btn" style="background: #28a745; color: white; padding: 6px 12px; margin-top: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">×”×•×¡×£ ×—×œ×§</button>
          </div>

          <div style="border: 1px solid #e2e8f0; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
            <h4 style="margin: 0 0 10px 0; color: #1e3a8a;">×¢×‘×•×“×•×ª × ×“×¨×©×•×ª:</h4>
            <div class="works-list" data-center="${index}">
              ${works.map((work, workIndex) => createEditableWorkRow(work, index, workIndex)).join('')}
            </div>
            <button onclick="estimateAddWorkRow(${index})" class="btn" style="background: #17a2b8; color: white; padding: 6px 12px; margin-top: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">×”×•×¡×£ ×¢×‘×•×“×”</button>
          </div>

          <div style="border: 1px solid #e2e8f0; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
            <h4 style="margin: 0 0 10px 0; color: #1e3a8a;">×ª×™×§×•× ×™× × ×“×¨×©×™×:</h4>
            <div class="repairs-list" data-center="${index}">
              ${repairs.map((repair, repairIndex) => createEditableRepairRow(repair, index, repairIndex)).join('')}
            </div>
            <button onclick="estimateAddRepairRow(${index})" class="btn" style="background: #ffc107; color: #212529; padding: 6px 12px; margin-top: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">×”×•×¡×£ ×ª×™×§×•×Ÿ</button>
          </div>

          <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 14px;">
              <div><strong>×¢×‘×•×“×•×ª:</strong> <span class="work-costs-display">â‚ª${workCosts.toLocaleString()}</span></div>
              <div><strong>×—×œ×¤×™×:</strong> <span class="parts-costs-display">â‚ª${partsCosts.toLocaleString()}</span></div>
              <div><strong>×ª×™×§×•× ×™×:</strong> <span class="repairs-costs-display">â‚ª${repairsCosts.toLocaleString()}</span></div>
              <div><strong>×›×•×œ×œ ××¢"×:</strong> <span class="total-with-vat-display">â‚ª${Math.round(totalWithVAT).toLocaleString()}</span></div>
            </div>
          </div>
        </div>
      `;
    }

    // REMOVED DUPLICATE - Using the one at line 2041 instead

    // Remove adjustment row
    function removeAdjustmentRow(rowId) {
      const row = document.getElementById(rowId);
      if (row) {
        row.remove();
        updateGrossMarketValueCalculation();
        updateHelperFromAdjustments();
      }
    }

    // Calculate adjustment value from percentage
    function calculateAdjustmentValueSimple(percentInput) {
      const row = percentInput.closest('div[id^="featureAdj_"], div[id^="regAdj_"]');
      if (!row) return;
      
      const inputs = row.querySelectorAll('input[type="text"]');
      const valueInput = inputs[2];
      if (!valueInput) return;
      
      const percent = parseFloat(percentInput.value) || 0;
      const basicPrice = parseFloat(document.getElementById('basicPrice')?.value?.replace(/[â‚ª,]/g, '')) || 0;
      
      if (percent > 0 && basicPrice > 0) {
        const calculatedValue = basicPrice * (percent / 100);
        valueInput.value = `â‚ª${Math.round(calculatedValue).toLocaleString()}`;
      }
    }

    // Sync adjustment to estimate helper (mirror data)
    function syncAdjustmentToEstimateHelper(element, category, helperParam) {
      try {
        // Use passed helper or get from storage
        let helper;
        if (helperParam) {
          helper = helperParam;
        } else {
          let helperStr = sessionStorage.getItem('helper');
          if (!helperStr || helperStr === 'undefined') {
            console.log('No helper found, skipping sync');
            return null;
          }
          helper = JSON.parse(helperStr);
        }
        
        // Initialize estimate structure if needed
        if (!helper.estimate) helper.estimate = {};
        if (!helper.estimate.gross_value_adjustments) {
          helper.estimate.gross_value_adjustments = {
            features: [],
            registration: []
          };
        }
        
        // Clear and rebuild the adjustments
        helper.estimate.gross_value_adjustments[category] = [];
        
        // Collect all adjustments of this category
        const selector = category === 'features' ? '#featuresAdjustmentsList > div' : '#registrationAdjustmentsList > div';
        const rows = document.querySelectorAll(selector);
        
        rows.forEach(row => {
          const inputs = row.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const adjustmentData = {
              description: inputs[0].value || '',
              type: inputs[1].value || 'plus',
              percentage: parseFloat(inputs[2].value) || 0,
              value: parseFloat(inputs[3].value.replace(/[â‚ª,]/g, '')) || 0,
              timestamp: new Date().toISOString()
            };
            
            if (adjustmentData.value !== 0 || adjustmentData.percentage !== 0) {
              helper.estimate.gross_value_adjustments[category].push(adjustmentData);
            }
          }
        });
        
        // Update gross market value in estimate
        const grossValueResult = document.getElementById('grossMarketValueResult');
        if (grossValueResult) {
          helper.estimate.gross_market_value = parseFloat(grossValueResult.value.replace(/[â‚ª,]/g, '')) || 0;
        }
        
        // Add total damage cost and gross damage percentage to estimate
        const totalDamageCostField = document.getElementById('totalDamageCost');
        if (totalDamageCostField) {
          helper.estimate.total_damage_cost = parseFloat(totalDamageCostField.value.replace(/[â‚ª,]/g, '')) || 0;
        }
        
        const grossDamagePercentageField = document.getElementById('grossDamagePercentage');
        if (grossDamagePercentageField) {
          helper.estimate.gross_damage_percentage = parseFloat(grossDamagePercentageField.value.replace(/[%,]/g, '')) || 0;
        }
        
        // Only save to sessionStorage if helper wasn't passed as parameter
        if (!helperParam) {
          sessionStorage.setItem('helper', JSON.stringify(helper));
        }
        
        console.log(`âœ… Synced ${category} adjustments to helper.estimate.gross_value_adjustments.${category}:`, helper.estimate.gross_value_adjustments[category]);
        
        return helper;
        
      } catch (error) {
        console.error('Error syncing adjustment to estimate helper:', error);
        return helperParam || null;
      }
    }

    // REMOVED DUPLICATE - Using the one at line 2094 that accepts helper parameter

    // Write back to data source - helper.valuation.adjustments
    function writeToDataSource(helper) {
      try {
        // Ensure structure exists
        if (!helper.valuation) helper.valuation = {};
        if (!helper.valuation.adjustments) helper.valuation.adjustments = {};
        if (!helper.valuation.adjustments.features) helper.valuation.adjustments.features = {};
        if (!helper.valuation.adjustments.registration) helper.valuation.adjustments.registration = {};
        
        // Write features adjustments back to source
        const featuresRows = document.querySelectorAll('#featuresAdjustmentsList > div');
        if (featuresRows.length > 0) {
          const firstFeatureRow = featuresRows[0];
          const inputs = firstFeatureRow.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            helper.valuation.adjustments.features.description = inputs[0].value || '';
            helper.valuation.adjustments.features.percentage = inputs[2].value || '';
            helper.valuation.adjustments.features.value = inputs[3].value || '';
          }
        }
        
        // Write registration adjustments back to source
        const registrationRows = document.querySelectorAll('#registrationAdjustmentsList > div');
        if (registrationRows.length > 0) {
          const firstRegRow = registrationRows[0];
          const inputs = firstRegRow.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            helper.valuation.adjustments.registration.value = inputs[0].value || '';
            helper.valuation.adjustments.registration.percent = inputs[2].value || '';
            helper.valuation.adjustments.registration.amount = inputs[3].value || '';
          }
        }
        
        console.log('âœ… Written back to data source');
        
      } catch (error) {
        console.error('âŒ Error writing to data source:', error);
      }
    }

    // Save gross sections as array to helper.estimate (including both gross value and gross percentage sections)
    function saveGrossSectionsToEstimateHelper(helper) {
      try {
        // Initialize estimate structure if it doesn't exist
        if (!helper.estimate) helper.estimate = {};
        if (!helper.estimate.gross_values) helper.estimate.gross_values = [];
        
        // Clear existing gross_values array to avoid duplicates
        helper.estimate.gross_values = [];
        
        // Create gross value section data
        const grossValueSection = {
          section_type: 'gross_vehicle_value',
          section_title: '×¢×¨×š ×”×¨×›×‘ ×”×’×•×œ××™ - ×××¤×™×™× ×™× ×•×¢×œ×™×” ×œ×›×‘×™×© ×‘×œ×‘×“',
          data: {}
        };
        
        // Save basic price
        const basicPriceField = document.getElementById('basicPrice');
        if (basicPriceField && basicPriceField.value) {
          grossValueSection.data.basic_price = basicPriceField.value;
          grossValueSection.data.basic_price_raw = parseFloat(basicPriceField.value.replace(/[â‚ª,]/g, '')) || 0;
        }
        
        // Save features adjustments
        const featuresRows = document.querySelectorAll('#featuresAdjustmentsList > div');
        grossValueSection.data.features_adjustments = [];
        featuresRows.forEach(row => {
          const inputs = row.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const adjustment = {
              description: inputs[0].value || '',
              type: inputs[1].value || 'plus',
              percentage: inputs[2].value || '',
              value: inputs[3].value || '',
              value_raw: parseFloat((inputs[3].value || '').replace(/[â‚ª,]/g, '')) || 0
            };
            if (adjustment.description.trim() || adjustment.value_raw !== 0) {
              grossValueSection.data.features_adjustments.push(adjustment);
            }
          }
        });
        
        // Save registration adjustments
        const registrationRows = document.querySelectorAll('#registrationAdjustmentsList > div');
        grossValueSection.data.registration_adjustments = [];
        registrationRows.forEach(row => {
          const inputs = row.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const adjustment = {
              description: inputs[0].value || '',
              type: inputs[1].value || 'plus',
              percentage: inputs[2].value || '',
              value: inputs[3].value || '',
              value_raw: parseFloat((inputs[3].value || '').replace(/[â‚ª,]/g, '')) || 0
            };
            if (adjustment.description.trim() || adjustment.value_raw !== 0) {
              grossValueSection.data.registration_adjustments.push(adjustment);
            }
          }
        });
        
        // Save cumulative values
        const featuresCumulative = document.querySelector('#grossFeaturesCumulative span')?.textContent;
        const registrationCumulative = document.querySelector('#grossRegistrationCumulative span')?.textContent;
        const grossResult = document.getElementById('grossMarketValueResult')?.value;
        
        grossValueSection.data.cumulatives = {
          features_total: featuresCumulative || 'â‚ª0',
          features_total_raw: parseFloat((featuresCumulative || 'â‚ª0').replace(/[â‚ª,]/g, '')) || 0,
          registration_total: registrationCumulative || 'â‚ª0',
          registration_total_raw: parseFloat((registrationCumulative || 'â‚ª0').replace(/[â‚ª,]/g, '')) || 0,
          gross_market_value: grossResult || 'â‚ª0',
          gross_market_value_raw: parseFloat((grossResult || 'â‚ª0').replace(/[â‚ª,]/g, '')) || 0
        };
        
        // Add gross percentage section data if available
        const grossPercentageSection = {
          section_type: 'gross_damage_percentage',
          section_title: '××—×•×– ×”× ×–×§ ×”×’×•×œ××™ - ×‘×¡×™×¡ ×”×¨×›×‘ ×‘×œ×‘×“',
          data: {}
        };
        
        // Collect gross percentage fields (using correct estimator-builder field IDs)
        const totalDamageCostField = document.getElementById('totalDamageCost');
        const grossValueDisplayField = document.getElementById('grossValueDisplay');
        const grossDamagePercentageField = document.getElementById('grossDamagePercentage');
        
        if (totalDamageCostField) {
          grossPercentageSection.data.total_damage_cost = totalDamageCostField.value;
          grossPercentageSection.data.total_damage_cost_raw = parseFloat(totalDamageCostField.value.replace(/[â‚ª,]/g, '')) || 0;
        }
        
        if (grossValueDisplayField) {
          grossPercentageSection.data.gross_value_display = grossValueDisplayField.value;
          grossPercentageSection.data.gross_value_display_raw = parseFloat(grossValueDisplayField.value.replace(/[â‚ª,]/g, '')) || 0;
        }
        
        if (grossDamagePercentageField) {
          grossPercentageSection.data.gross_damage_percentage = grossDamagePercentageField.value;
          grossPercentageSection.data.gross_damage_percentage_raw = parseFloat(grossDamagePercentageField.value.replace(/[%,]/g, '')) || 0;
        }
        
        // Add timestamps
        const timestamp = new Date().toISOString();
        grossValueSection.last_updated = timestamp;
        grossPercentageSection.last_updated = timestamp;
        
        // Remove existing sections of these types and add new ones
        helper.estimate.gross_values = helper.estimate.gross_values.filter(
          section => !['gross_vehicle_value', 'gross_damage_percentage'].includes(section.section_type)
        );
        
        helper.estimate.gross_values.push(grossValueSection);
        helper.estimate.gross_values.push(grossPercentageSection);
        
        console.log('âœ… Saved gross sections to helper.estimate.gross_values array');
        
      } catch (error) {
        console.error('âŒ Error saving gross sections to estimate helper:', error);
      }
    }

    // Save gross value with feedback
    function saveGrossValueWithFeedback(event) {
      console.log('ğŸ”˜ Save gross value button clicked!');
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        console.log('ğŸ“ Current helper before save:', helper);
        
        // Update calculations
        updateGrossMarketValueCalculation();
        
        // Update helper with form values - THIS IS THE KEY!
        helper = updateHelperFromAdjustments(helper);
        
        // 1. WRITE TO DATA SOURCE: Update helper.valuation.adjustments with current form values
        writeToDataSource(helper);
        
        // 2. Save gross value to main calculations
        const grossValue = document.getElementById('grossMarketValueResult')?.value;
        if (grossValue) {
          if (!helper.calculations) helper.calculations = {};
          helper.calculations.gross_market_value = parseFloat(grossValue.replace(/[â‚ª,]/g, '')) || 0;
        }
        
        // 3. SAVE TO gross_value_adjustments.features and .registration
        helper = syncAdjustmentToEstimateHelper(null, 'features', helper) || helper;
        helper = syncAdjustmentToEstimateHelper(null, 'registration', helper) || helper;
        
        // 4. Save total damage cost and gross damage percentage to estimate
        if (!helper.estimate) helper.estimate = {};
        
        const totalDamageCostField = document.getElementById('totalDamageCost');
        if (totalDamageCostField) {
          helper.estimate.total_damage_cost = parseFloat(totalDamageCostField.value.replace(/[â‚ª,]/g, '')) || 0;
        }
        
        const grossDamagePercentageField = document.getElementById('grossDamagePercentage');
        if (grossDamagePercentageField) {
          helper.estimate.gross_damage_percentage = parseFloat(grossDamagePercentageField.value.replace(/[%,]/g, '')) || 0;
        }
        
        // 5. DUAL STORAGE: Save gross sections array to helper.estimate
        saveGrossSectionsToEstimateHelper(helper);
        
        // 4. SAVE TO ALL STORAGE LOCATIONS
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        // Update window.helper (single source of truth)
        if (typeof window.updateHelper === 'function') {
          window.updateHelper(helper);
        } else {
          window.helper = helper;
        }
        
        console.log('âœ… Saved to all locations:', helper.estimate?.gross_values);
        console.log('âœ… Final helper after save:', helper);
        
        // Show feedback
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = '× ×©××¨ âœ“';
        button.style.background = '#28a745';
        
        setTimeout(() => {
          button.textContent = originalText;
          button.style.background = '#007bff';
        }, 2000);
        
      } catch (error) {
        console.error('âŒ Error saving gross value:', error);
        alert('âŒ Error saving: ' + error.message);
      }
    }
    
    // Make sure function is globally accessible
    window.saveGrossValueWithFeedback = saveGrossValueWithFeedback;
    
    // Auto-save function for real-time updates
    function autoSaveToHelper() {
      try {
        // Get helper from sessionStorage or window.helper
        let helperStr = sessionStorage.getItem('helper');
        if (!helperStr || helperStr === 'undefined') {
          // Try to get from window.helper
          if (window.helper && typeof window.helper === 'object') {
            helperStr = JSON.stringify(window.helper);
          } else {
            console.log('No helper found, skipping auto-save');
            return;
          }
        }
        
        let helper = JSON.parse(helperStr);
        
        // Update helper with current form values
        helper = updateHelperFromAdjustments(helper);
        
        // Also sync to gross_value_adjustments
        helper = syncAdjustmentToEstimateHelper(null, 'features', helper) || helper;
        helper = syncAdjustmentToEstimateHelper(null, 'registration', helper) || helper;
        
        // Save to all storage locations
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        // Update window.helper directly
        window.helper = helper;
        
        console.log('âœ… Auto-saved to helper');
        
      } catch (error) {
        console.error('âŒ Error in auto-save:', error);
      }
    }
    
    // Add real-time calculation listeners
    function addCalculationListeners() {
      // Listen to basic price changes
      const basicPriceField = document.getElementById('basicPrice');
      if (basicPriceField) {
        basicPriceField.addEventListener('input', function() {
          updateGrossMarketValueCalculation();
          // AUTO-SAVE ON EVERY CHANGE
          autoSaveToHelper();
        });
      }
      
      // Listen to all adjustment input changes
      function addListenersToAdjustmentRows() {
        const allInputs = document.querySelectorAll('#featuresAdjustmentsList input, #registrationAdjustmentsList input, #featuresAdjustmentsList select, #registrationAdjustmentsList select');
        allInputs.forEach(input => {
          input.addEventListener('input', function() {
            updateGrossMarketValueCalculation();
            // AUTO-SAVE ON EVERY CHANGE
            autoSaveToHelper();
          });
          input.addEventListener('change', function() {
            updateGrossMarketValueCalculation();
            // AUTO-SAVE ON EVERY CHANGE
            autoSaveToHelper();
          });
        });
      }
      
      addListenersToAdjustmentRows();
      
      // Re-add listeners when new rows are added
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'childList') {
            addListenersToAdjustmentRows();
          }
        });
      });
      
      const featuresContainer = document.getElementById('featuresAdjustmentsList');
      const registrationContainer = document.getElementById('registrationAdjustmentsList');
      
      if (featuresContainer) {
        observer.observe(featuresContainer, { childList: true });
      }
      if (registrationContainer) {
        observer.observe(registrationContainer, { childList: true });
      }
    }

    // Load data when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸš€ Page loaded - loading data from storage');
      try {
        let helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        if (helper && Object.keys(helper).length > 0) {
          console.log('ğŸ“ Found helper data:', helper);
          loadGrossAdjustmentsFromHelper(helper);
          // Trigger calculation after loading
          setTimeout(() => {
            updateGrossMarketValueCalculation();
            
            // Sync auto-populated data to gross_value_adjustments
            helper = syncAdjustmentToEstimateHelper(null, 'features', helper) || helper;
            helper = syncAdjustmentToEstimateHelper(null, 'registration', helper) || helper;
            sessionStorage.setItem('helper', JSON.stringify(helper));
            window.helper = helper;
            console.log('âœ… Page load: Synced to gross_value_adjustments');
          }, 100);
        } else {
          console.log('â„¹ï¸ No helper data found in storage');
        }
        
        // Add calculation listeners
        addCalculationListeners();
        
      } catch (error) {
        console.error('âŒ Error loading data on page load:', error);
      }
    });
  </script>
</body>
</html>