<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>אומדן נזקי רכב - ירון כיוף</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" type="image/webp">
  <style>
    /* Base Styles - Exact copy from original */
    body {
      font-family: sans-serif;
      background: #f3f6fb;
      margin: 0;
      min-height: 100vh;
      padding: 0;
      padding-top: 90px;
      overflow-x: hidden;
    }
    
    .container {
      width: 100%;
      max-width: 820px;
      min-width: 320px;
      background: #fff;
      padding: 32px 24px 24px 24px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.08);
      margin: 32px auto 32px auto;
      box-sizing: border-box;
    }
    
    .logo {
      display: flex;
      justify-content: center;
      margin-bottom: 8px;
    }
    
    .logo img {
      width: 112px;
      height: auto;
      display: block;
    }
    
    .title { 
      font-size: 27px; 
      font-weight: bold; 
      text-align: center; 
      margin-bottom: 2px; 
      font-weight: 900;
    }
    
    .subtitle { 
      font-size: 23px; 
      color: #666; 
      text-align: center; 
      margin-bottom: 10px;
    }
    
    h1, h2 { 
      color: #1e3a8a; 
      font-size: 25px; 
      text-align: center; 
      margin: 15px 0 8px 0; 
      font-weight: 600;
    }
    
    h3 { 
      color: #1e3a8a; 
      font-size: 22px; 
      margin: 22px 0 12px 0; 
      text-align: right; 
      font-weight: 900;
    }
    
    .form-section {
      width: 100%;
      max-width: 100%;
      margin-bottom: 20px;
      background: #fafbfe;
      border-radius: 12px;
      padding: 17px 15px 12px 15px;
      box-sizing: border-box;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      overflow: hidden;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px 18px;
      width: 100%;
    }
    
    @media (max-width: 600px) {
      .form-grid { 
        grid-template-columns: 1fr; 
      }
      .container {
        width: 98vw;
        max-width: 98vw;
        min-width: 0;
        padding: 14px 2vw 20px 2vw;
      }
    }
    
    label {
      font-size: 18px;
      margin-bottom: 4px;
      display: block;
      text-align: right;
    }
    
    input, select, textarea {
      width: 100%;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 0px;
      padding: 8px 9px;
      box-sizing: border-box;
      text-align: right !important;
      background: #f9f9f9;
      transition: border .15s;
      outline: none;
    }
    
    input:focus, select:focus, textarea:focus {
      border-color: #3b82f6;
    }
    
    input[type="radio"] {
      width: auto;
      margin-left: 10px;
      margin-right: 5px;
    }
    
    .readonly-box {
      background: #f4f6fa;
      border-radius: 6px;
      border: 1px solid #eee;
      padding: 7px 8px;
      min-height: 20px;
      font-size: 16px;
      color: #333;
      text-align: right !important;
    }
    
    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      display: block;
    }

    .btn.add {
      background: #3ea74b;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 14px;
      display: inline-block;
      margin-top: 10px;
    }

    .btn.add:hover {
      background: #359a3e;
    }

    .btn.remove {
      background: #dc3545;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }

    .btn.remove:hover {
      background: #c82333;
    }
    
    .collapsible-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 1px solid #dee2e6;
      border-radius: 8px;
      text-align: right;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 10px;
    }
    
    .collapsible-btn:hover {
      background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    }

    /* Floating Screens Styling */
    .floating-toggles-top {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 8px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .toggle-square {
      width: 80px;
      height: 70px;
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%) !important;
      background-image: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%) !important;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: white;
      text-align: center;
      border: 2px solid transparent;
    }

    .toggle-square::before,
    .toggle-square::after {
      display: none !important;
      content: none !important;
    }

    .toggle-square:hover {
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%) !important;
      background-image: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%) !important;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .toggle-square.active {
      border-color: #fbbf24;
      background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%) !important;
      background-image: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%) !important;
    }

    .toggle-square span:first-child {
      font-size: 24px;
      margin-bottom: 4px;
    }

    .toggle-square span:last-child {
      font-size: 12px;
    }
    
    /* Depreciation Styles */
    #depreciationBulkTable {
      margin-top: 15px;
    }

    #depreciationBulkTable .dep-row {
      display: grid;
      grid-template-columns: 1fr 1fr 120px 120px 80px;
      gap: 14px;
      margin-bottom: 10px;
      align-items: center;
      position: relative;
      padding-bottom: 10px;
    }

    #depreciationBulkTable .dep-row::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: #e5e7eb;
    }

    #depreciationBulkTable .dep-row > div::before {
      font-weight: bold;
      font-size: 12px;
      margin-bottom: 4px;
    }

    #depreciationBulkTable .dep-row > div:nth-child(1)::before {
      content: "החלק הניזוק:";
    }

    #depreciationBulkTable .dep-row > div:nth-child(2)::before {
      content: "מהות התיקון:";
    }

    #depreciationBulkTable .dep-row > div:nth-child(3)::before {
      content: "% ירידת ערך:";
    }

    #depreciationBulkTable .dep-row > div:nth-child(4)::before {
      content: "ערך ב-₪:";
    }

    #depreciationBulkTable .dep-row > div:nth-child(5)::before {
      content: "פעולות:";
    }

    @media (max-width: 600px) {
      #depreciationBulkTable .dep-row {
        grid-template-columns: 1fr;
        gap: 8px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 10px;
      }
      
      #depreciationBulkTable .dep-row > div::before {
        display: block;
      }
    }
    
    /* Damage Center Styles */
    .damage-center-card {
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .damage-center-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e5e7eb;
    }

    .damage-center-header h4 {
      margin: 0;
      color: #1e3a8a;
      font-size: 18px;
    }

    /* Summary Styles */
    .summary-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    @media (max-width: 768px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Floating PDF Styles */
    .floating-pdf-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .floating-pdf-container {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 1200px;
      height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .floating-pdf-header {
      background: #1e3a8a;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    
    .floating-pdf-header h3 {
      margin: 0;
      font-size: 18px;
      color: white;
    }
    
    .floating-pdf-controls {
      display: flex;
      gap: 10px;
    }
    
    .floating-pdf-content {
      flex: 1;
      padding: 0;
      overflow: hidden;
    }

    /* PIP Styles */
    .pip-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 320px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      z-index: 10000;
      display: none;
    }

    .pip-header {
      background: #1e3a8a;
      color: white;
      padding: 10px 15px;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: move;
    }

    .pip-content {
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
    }

    /* Adjustment Row Styles */
    .adjustment-row {
      display: grid;
      grid-template-columns: 2fr 100px 100px 120px 80px;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
    }

    .adjustment-row input,
    .adjustment-row select {
      background: white;
    }

    /* Success/Error Messages */
    .section-message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      z-index: 9999;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }

    .section-message.success {
      background: #10b981;
      color: white;
    }

    .section-message.error {
      background: #ef4444;
      color: white;
    }

    /* Action Buttons Container */
    .action-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }

    .action-buttons .btn {
      padding: 12px 20px;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .action-buttons .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .action-buttons .btn-primary:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .action-buttons .btn-secondary {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    }

    .action-buttons .btn-secondary:hover {
      background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
    }

    .action-buttons .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .action-buttons .btn-success:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    /* AGGRESSIVE: Force remove any debug mesh patterns */
    .floating-toggles-top *,
    .floating-toggles-top *::before,
    .floating-toggles-top *::after,
    .toggle-square,
    .toggle-square::before,
    .toggle-square::after {
      background-image: none !important;
      background: none !important;
    }
    
    .floating-toggles-top .toggle-square {
      background-image: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%) !important;
    }
    
    .floating-toggles-top .toggle-square:hover {
      background-image: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%) !important;
    }
    
    .floating-toggles-top .toggle-square.active {
      background-image: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%) !important;
    }

    /* Anti-mesh classes applied by JavaScript */
    .no-mesh-before::before {
      display: none !important;
      content: none !important;
      background: none !important;
      background-image: none !important;
    }

    .no-mesh-after::after {
      display: none !important;
      content: none !important;
      background: none !important;
      background-image: none !important;
    }
  </style>
</head>
<body>
  <!-- Floating Toggles -->
  <div class="floating-toggles-top">
    <div class="toggle-square" onclick="toggleFloatingScreen('levi')">
      <span>📄</span>
      <span>לוי יצחק</span>
    </div>
    <div class="toggle-square" onclick="toggleFloatingScreen('carDetails')">
      <span>🚗</span>
      <span>פרטי רכב</span>
    </div>
    <div class="toggle-square" onclick="toggleFloatingScreen('parts')">
      <span>🔧</span>
      <span>חלקים</span>
    </div>
    <div class="toggle-square" onclick="toggleFloatingScreen('invoice')">
      <span>📋</span>
      <span>חשבונית</span>
    </div>
  </div>

  <div class="container">
    <div class="logo"><img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo"></div>
    <div class="title">ירון כיוף שמאות - פורטל</div>
    <div class="subtitle">שמאות והערכת נזקי רכב ורכוש</div>
    
    <h1>בניית אומדן נזקי רכב</h1>
    <h2 id="pageTitle">רכב מס. ...</h2>

    <!-- Estimate Type Section -->
    <div class="form-section" id="estimate-type">
      <h3>סוג האומדן</h3>
      <div>
        <label>
          <input type="radio" name="estimate-type" value="אובדן_להלכה" checked> אומדן ראשוני - אובדן להלכה
        </label>
        <label>
          <input type="radio" name="estimate-type" value="טוטלוס"> אומדן ראשוני - טוטלוס
        </label>
      </div>
    </div>

    <!-- Vehicle Data Section -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('vehicleData')">נתוני רכב (הצג/הסתר)</button>
      <div id="vehicleData" style="display:none;">
        <div class="form-grid">
          <div><label>מספר רכב:</label><input type="text" id="carPlate" onchange="updateHelperFromField(event);" /></div>
          <div><label>תוצרת:</label><input type="text" id="carManufacturer" onchange="updateHelperFromField(event);" /></div>
          <div><label>דגם:</label><input type="text" id="carModel" onchange="updateHelperFromField(event);" /></div>
          <div><label>שנת ייצור:</label><input type="text" id="carYear" onchange="updateHelperFromField(event);" /></div>
          <div><label>קוד דגם:</label><input type="text" id="carModelCode" onchange="updateHelperFromField(event);" /></div>
          <div><label>מחיר בסיס:</label><input type="text" id="carBasePrice" onchange="updateHelperFromField(event);" /></div>
          <div><label>ערך השוק של הרכב:</label><input type="text" id="carMarketValue" onchange="updateHelperFromField(event);" /></div>
          <div><label>תאריך הפקה:</label><input type="date" id="carReportDate" onchange="updateHelperFromField(event);" /></div>
        </div>
        <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
          <button type="button" class="btn save-btn" onclick="saveVehicleDataWithFeedback(event)" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">שמור</button>
        </div>
        <div style="text-align: center; margin-top: 10px;">
          <button type="button" class="btn section-collapse-button" onclick="toggleSection('vehicleData')" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">כווץ סעיף</button>
        </div>
      </div>
    </div>

    <!-- Contact Data Section -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('contactData')">נתוני התקשרות (הצג/הסתר)</button>
      <div id="contactData" style="display:none;">
        <div class="form-grid">
          <div><label>שם בעל הרכב:</label><input type="text" id="ownerName" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>כתובת בעל הרכב:</label><input type="text" id="ownerAddress" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>טלפון בעל הרכב:</label><input type="text" id="ownerPhone" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>חברת ביטוח:</label><input type="text" id="insuranceCompany" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>אימייל חברת ביטוח:</label><input type="text" id="insuranceEmail" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>סוכן ביטוח:</label><input type="text" id="insuranceAgent" onchange="updateHelperFromContactField(this); triggerFloatingScreenRefresh();" /></div>
          <div><label>טלפון סוכן ביטוח:</label><input type="text" id="agentPhone" onchange="updateHelperFromContactField(this); triggerFloatingScreenRefresh();" /></div>
          <div><label>אימייל סוכן ביטוח:</label><input type="text" id="agentEmail" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>שם מוסך:</label><input type="text" id="garageName" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>טלפון מוסך:</label><input type="text" id="garagePhone" onchange="updateHelperFromContactField(this);" /></div>
          <div><label>אימייל מוסך:</label><input type="text" id="garageEmail" onchange="updateHelperFromContactField(this);" /></div>
        </div>
        <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
          <button type="button" class="btn save-btn" onclick="saveContactDataWithFeedback(event)" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">שמור</button>
        </div>
        <div style="text-align: center; margin-top: 10px;">
          <button type="button" class="btn section-collapse-button" onclick="toggleSection('contactData')" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">כווץ סעיף</button>
        </div>
      </div>
    </div>

    <!-- DAMAGE CENTERS SUMMARY SECTION - EDITABLE -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('damageCentersSummary')">סיכום מוקדי נזק (הצג/הסתר)</button>
      <div id="damageCentersSummary" style="display:none;">
        <h3>סיכום מוקדי נזק (ניתן לעריכה)</h3>
        <div style="background: #f8f9fa; border-radius: 6px; padding: 15px; min-height: 50px;" id="damageCentersContent">
          <div style="color: #666; text-align: center;">טוען נתוני מוקדי נזק...</div>
        </div>
        <!-- Buttons will be added dynamically after the totals -->
        <div id="damageCenterButtons" style="display: none;">
          <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
            <button type="button" class="save-btn" onclick="saveDamageCenterChangesWithFeedback(event)" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">שמור</button>
            <button type="button" onclick="addNewDamageCenter()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">הוסף מוקד נזק חדש</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Gross Market Value Section -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('grossCalc')">ערך הרכב הגולמי - מאפיינים ועליה לכביש בלבד (הצג/הסתר)</button>
      <div id="grossCalc" style="display:none;">
        <div class="form-grid">
          <div><label>ערך הרכב ע"פ מחירון כולל מע"מ:</label><input type="text" id="basicPrice" placeholder="₪" /></div>
          <div></div>
        </div>
        
        <!-- Features Adjustments -->
        <div style="margin-top: 20px;">
          <h4 style="color: #1e3a8a; margin-bottom: 10px;">תוספות מאפיינים (תכונות הרכב):</h4>
          <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
            תוספות הקשורות לתכונות פיזיות של הרכב עצמו
          </div>
          <div id="featuresAdjustments">
            <div style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr 80px; gap:10px; margin-bottom:8px;">
              <div><label>תיאור:</label></div>
              <div><label>סוג:</label></div>
              <div><label>אחוז:</label></div>
              <div><label>ערך:</label></div>
              <div><label>פעולות:</label></div>
            </div>
            <div id="featuresAdjustmentsList"></div>
            <div id="grossFeaturesCumulative" style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-weight: bold; text-align: center;">
              ערך לאחר תוספות מאפיינים: <span style="color: #28a745;">₪0</span>
            </div>
            <button class="btn add" type="button" onclick="addFeatureAdjustment()">הוסף תוספת מאפיין</button>
          </div>
        </div>
        
        <!-- Registration Adjustments -->
        <div style="margin-top: 20px;">
          <h4 style="color: #1e3a8a; margin-bottom: 10px;">עליה לכביש (תאריך רישום):</h4>
          <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
            התאמות בגין תאריך רישום הרכב (מאפיין קבוע של הרכב)
          </div>
          <div id="registrationAdjustments">
            <div style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr 80px; gap:10px; margin-bottom:8px;">
              <div><label>תיאור:</label></div>
              <div><label>סוג:</label></div>
              <div><label>אחוז:</label></div>
              <div><label>ערך:</label></div>
              <div><label>פעולות:</label></div>
            </div>
            <div id="registrationAdjustmentsList"></div>
            <div id="grossRegistrationCumulative" style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-weight: bold; text-align: center;">
              ערך לאחר עליה לכביש: <span style="color: #28a745;">₪0</span>
            </div>
            <button class="btn add" type="button" onclick="addRegistrationAdjustment()">הוסף תוספת עליה לכביש</button>
          </div>
        </div>
        
        <!-- Gross Market Value Result -->
        <div style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px; border: 2px solid #4a90e2;">
          <div class="form-grid">
            <div><label><strong>ערך הרכב לנזק גולמי כולל מע"מ:</strong></label><input type="text" id="grossMarketValueResult" style="background: #f8f9fa; font-weight: bold;" readonly /></div>
            <div></div>
          </div>
        </div>
        <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
          <button type="button" onclick="saveGrossValueWithFeedback(event)" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">שמור</button>
        </div>
        <div style="text-align: center; margin-top: 10px;">
          <button type="button" class="btn section-collapse-button" onclick="toggleSection('grossCalc')" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">כווץ סעיף</button>
        </div>
      </div>
    </div>

    <!-- Gross Damage Percentage Section -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('grossPercentageResult')">אחוז הנזק הגולמי - בסיס הרכב בלבד (הצג/הסתר)</button>
      <div id="grossPercentageResult" style="display:none;">
        <div class="form-grid">
          <div>
            <label>סה"כ עלות נזק מוערכת:</label>
            <input type="text" id="totalDamageCost" placeholder="₪" />
          </div>
          <div>
            <label>ערך הרכב הגולמי:</label>
            <input type="text" id="grossValueDisplay" readonly />
          </div>
          <div>
            <label>אחוז הנזק הגולמי:</label>
            <input type="text" id="grossDamagePercentage" readonly style="font-weight: bold; font-size: 18px; color: #1e3a8a;" />
          </div>
        </div>
        <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
          <button type="button" class="btn save-btn" onclick="saveGrossPercentageWithFeedback(event)" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">שמור</button>
        </div>
        <div style="text-align: center; margin-top: 10px;">
          <button type="button" class="btn section-collapse-button" onclick="toggleSection('grossPercentageResult')" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">כווץ סעיף</button>
        </div>
      </div>
    </div>

    <!-- Full Market Value Section -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('fullMarketValue')">ערך השוק המלא - כולל גורמי שימוש (הצג/הסתר)</button>
      <div id="fullMarketValue" style="display:none;">
        <div class="form-grid">
          <div><label>ערך הרכב ע"פ מחירון כולל מע"מ:</label><input type="text" id="fullBasicPrice" placeholder="₪" readonly style="background: #f8f9fa;" /></div>
          <div></div>
        </div>
        
        <!-- Features Adjustments (תוספות מאפיינים) -->
        <div style="margin-top: 20px;">
          <h4 style="color: #1e3a8a; margin-bottom: 10px;">תוספות מאפיינים (תכונות הרכב):</h4>
          <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
            🏗️ תוספות הקשורות לתכונות פיזיות של הרכב עצמו
          </div>
          <div id="fullFeaturesAdjustments">
            <div style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr 80px; gap:10px; margin-bottom:8px;">
              <div><label>תיאור:</label></div>
              <div><label>סוג:</label></div>
              <div><label>אחוז:</label></div>
              <div><label>ערך:</label></div>
              <div><label>פעולות:</label></div>
            </div>
            <div id="fullFeaturesAdjustmentsList"></div>
            <div id="featuresCumulative" style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-weight: bold; text-align: center;">
              ערך לאחר תוספות מאפיינים: <span style="color: #28a745;">₪0</span>
            </div>
            <button class="btn add" type="button" onclick="addFullFeaturesAdjustment()">הוסף תוספת מאפיין</button>
          </div>
        </div>
        
        <!-- Registration Adjustments (עליה לכביש) -->
        <div style="margin-top: 20px;">
          <h4 style="color: #1e3a8a; margin-bottom: 10px;">עליה לכביש (תאריך רישום):</h4>
          <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
            📅 התאמות בגין תאריך רישום הרכב (מאפיין קבוע של הרכב)
          </div>
          <div id="fullRegistrationAdjustments">
            <div style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr 80px; gap:10px; margin-bottom:8px;">
              <div><label>תיאור:</label></div>
              <div><label>סוג:</label></div>
              <div><label>אחוז:</label></div>
              <div><label>ערך:</label></div>
              <div><label>פעולות:</label></div>
            </div>
            <div id="fullRegistrationAdjustmentsList"></div>
            <div id="registrationCumulative" style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-weight: bold; text-align: center;">
              ערך לאחר עליה לכביש: <span style="color: #28a745;">₪0</span>
            </div>
            <button class="btn add" type="button" onclick="addFullRegistrationAdjustment()">הוסף תוספת עליה לכביש</button>
          </div>
        </div>
        
        <!-- Mileage Adjustments (מס ק"מ) -->
        <div style="margin-top: 20px;">
          <h4 style="color: #1e3a8a; margin-bottom: 10px;">מס ק"מ:</h4>
          <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
            🚗 התאמות בגין ק"מ של הרכב
          </div>
          <div id="mileageAdjustments">
            <div style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr 80px; gap:10px; margin-bottom:8px;">
              <div><label>תיאור:</label></div>
              <div><label>סוג:</label></div>
              <div><label>אחוז:</label></div>
              <div><label>ערך:</label></div>
              <div><label>פעולות:</label></div>
            </div>
            <div id="mileageAdjustmentsList"></div>
            <div id="mileageCumulative" style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-weight: bold; text-align: center;">
              ערך לאחר מס ק"מ: <span style="color: #dc3545;">₪0</span>
            </div>
            <button class="btn add" type="button" onclick="addMileageAdjustment()">הוסף התאמת מס ק"מ</button>
          </div>
        </div>
        
        <!-- Ownership Type Adjustments (סוג בעלות) -->
        <div style="margin-top: 20px;">
          <h4 style="color: #1e3a8a; margin-bottom: 10px;">סוג בעלות:</h4>
          <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
            🏢 התאמות בגין סוג בעלות (פרטי, חברה, ליסינג)
          </div>
          <div id="ownershipAdjustments">
            <div style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr 80px; gap:10px; margin-bottom:8px;">
              <div><label>תיאור:</label></div>
              <div><label>סוג:</label></div>
              <div><label>אחוז:</label></div>
              <div><label>ערך:</label></div>
              <div><label>פעולות:</label></div>
            </div>
            <div id="ownershipAdjustmentsList"></div>
            <div id="ownershipCumulative" style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-weight: bold; text-align: center;">
              ערך לאחר סוג בעלות: <span style="color: #dc3545;">₪0</span>
            </div>
            <button class="btn add" type="button" onclick="addOwnershipAdjustment()">הוסף התאמת סוג בעלות</button>
          </div>
        </div>
        
        <!-- Number of Owners Adjustments (מספר בעלים) -->
        <div style="margin-top: 20px;">
          <h4 style="color: #1e3a8a; margin-bottom: 10px;">מספר בעלים:</h4>
          <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
            👥 התאמות בגין מספר בעלים קודמים
          </div>
          <div id="ownersAdjustments">
            <div style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr 80px; gap:10px; margin-bottom:8px;">
              <div><label>תיאור:</label></div>
              <div><label>סוג:</label></div>
              <div><label>אחוז:</label></div>
              <div><label>ערך:</label></div>
              <div><label>פעולות:</label></div>
            </div>
            <div id="ownersAdjustmentsList"></div>
            <div id="ownersCumulative" style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-weight: bold; text-align: center;">
              ערך לאחר מספר בעלים: <span style="color: #dc3545;">₪0</span>
            </div>
            <button class="btn add" type="button" onclick="addOwnersAdjustment()">הוסף התאמת מספר בעלים</button>
          </div>
        </div>
        
        <!-- Additional Market Adjustments -->
        <div style="margin-top: 20px;">
          <h4 style="color: #1e3a8a; margin-bottom: 10px;">התאמות שוק נוספות:</h4>
          <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
            💡 התאמות נוספות בגין שווי שוק
          </div>
          <div id="allAdjustments">
            <div style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr 80px; gap:10px; margin-bottom:8px;">
              <div><label>תיאור:</label></div>
              <div><label>סוג:</label></div>
              <div><label>אחוז:</label></div>
              <div><label>ערך:</label></div>
              <div><label>פעולות:</label></div>
            </div>
            <div id="allAdjustmentsList">
              <!-- This will be populated from helper data -->
            </div>
            <button class="btn add" type="button" onclick="addFullMarketAdjustment()">הוסף התאמה נוספת</button>
          </div>
        </div>
        
        <!-- Auto-populate button -->
        <div style="margin-top: 20px;">
          <button type="button" class="btn btn-secondary" onclick="autoPopulateMarketAdjustments()">טען התאמות מדוח לוי יצחק</button>
        </div>
        
        <!-- Full Market Value Result -->
        <div style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px; border: 2px solid #28a745;">
          <div class="form-grid">
            <div><label><strong>ערך השוק המלא של הרכב כולל מע"מ:</strong></label><input type="text" id="fullMarketValueResult" style="background: #f8f9fa; font-weight: bold; color: #28a745;" readonly /></div>
            <div></div>
          </div>
          <div style="margin-top: 10px; font-size: 14px; color: #666;">
            <strong>חישוב:</strong> (מחיר בסיס + התאמות רכב) + התאמות שימוש
          </div>
        </div>
        
        <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
          <button type="button" class="btn save-btn" onclick="saveFullMarketValueWithFeedback(event)" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">שמור</button>
        </div>
        <div style="text-align: center; margin-top: 10px;">
          <button type="button" class="btn section-collapse-button" onclick="toggleSection('fullMarketValue')" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">כווץ סעיף</button>
        </div>
      </div>
    </div>

    <!-- Depreciation Section -->
    <div class="form-section" id="depreciationSection">
      <button class="collapsible-btn" type="button" onclick="toggleSection('depreciationContent')">חישוב ירידת ערך לפי מוקדי נזק (הצג/הסתר)</button>
      <div id="depreciationContent" style="display:none;">
        <h3>חישוב ירידת ערך לפי מוקדי נזק</h3>
        <div id="depreciationBulkTable"></div>
        <button type="button" class="btn btn-secondary" onclick="addDepField()">+ הוסף שורה</button>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px;">
          <div>
            <label>ירידת ערך כוללת (%):</label>
            <input type="number" id="globalDep1" placeholder="0" onchange="updateGlobalDepreciationCalculation();" />
          </div>
          <div>
            <label>ירידת ערך כוללת (₪):</label>
            <input type="text" id="globalDepValue" readonly />
          </div>
        </div>
        
        <div style="margin-top:14px;">
          <label>ימי מוסך משוערים:</label>
          <input type="number" id="garageDays" placeholder="מספר ימי עבודה" style="width: 200px;" onchange="updateHelperDepreciationField(this, 'work_days_impact');" />
        </div>
        
        <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
          <button type="button" class="btn save-btn" onclick="saveDepreciationData()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">שמור נתוני ירידת ערך</button>
        </div>
        <div style="text-align: center; margin-top: 10px;">
          <button type="button" class="btn section-collapse-button" onclick="toggleSection('depreciationContent')" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">כווץ סעיף</button>
        </div>
      </div>
    </div>

    <!-- Claims Data Section -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('priceData')">נתוני תביעה (הצג/הסתר)</button>
      <div id="priceData" style="display:none;">
        <h3>נתוני תביעה</h3>
        <div class="form-grid">
          <div>
            <label>סה"כ תביעה:</label>
            <input type="text" id="totalClaim" readonly />
          </div>
          <div>
            <label>תביעה מאושרת:</label>
            <input type="text" id="authorizedClaim" placeholder="₪" onchange="updateClaimsDataFromField(this, 'authorized_claim');" />
          </div>
          <div>
            <label>ירידת ערך:</label>
            <input type="text" id="depreciationClaim" placeholder="₪" onchange="updateClaimsDataFromField(this, 'depreciation');" />
          </div>
          <div>
            <label>הפרש תביעה:</label>
            <input type="text" id="claimDifference" placeholder="₪" onchange="updateClaimsDataFromField(this, 'claim_difference');" />
          </div>
        </div>
        <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
          <button type="button" class="btn save-btn" onclick="saveWithFeedback(event, 'claims')" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">שמור</button>
        </div>
        <div style="text-align: center; margin-top: 10px;">
          <button type="button" class="btn section-collapse-button" onclick="toggleSection('priceData')" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">כווץ סעיף</button>
        </div>
      </div>
    </div>

    <!-- Summary Section -->
    <div class="form-section" style="background: linear-gradient(135deg, #ff8c00 0%, #ff7300 100%); color: white; border-radius: 12px; padding: 20px;">
      <h3 style="color: white; text-align: center; font-size: 24px; margin-bottom: 20px;">סיכום אומדן</h3>
      <div class="summary-grid">
        <div style="text-align: center;">
          <label style="color: #ffe4b5; font-size: 14px;">שווי רכב:</label>
          <div id="sumMarketValue" style="font-size: 28px; font-weight: bold;">₪0</div>
        </div>
        <div style="text-align: center;">
          <label style="color: #ffe4b5; font-size: 14px;">סה״כ תביעה:</label>
          <div id="sumClaim" style="font-size: 28px; font-weight: bold;">₪0</div>
        </div>
        <div style="text-align: center;">
          <label style="color: #ffe4b5; font-size: 14px;">מע״מ:</label>
          <div id="sumVAT" style="font-size: 28px; font-weight: bold;">₪0</div>
        </div>
        <div style="text-align: center;">
          <label style="color: #ffe4b5; font-size: 14px;">סה״כ כולל מע״מ:</label>
          <div id="sumTotalClaim" style="font-size: 28px; font-weight: bold;">₪0</div>
        </div>
        <div style="text-align: center;">
          <label style="color: #ffe4b5; font-size: 14px;">ירידת ערך:</label>
          <div id="depCompensation" style="font-size: 28px; font-weight: bold;">₪0</div>
        </div>
        <div style="text-align: center;">
          <label style="color: #ffe4b5; font-size: 14px;">אחוז הנזק:</label>
          <div id="damagePercentage" style="font-size: 28px; font-weight: bold;">0%</div>
        </div>
      </div>
    </div>

    <!-- Additional Notes Section -->
    <div class="form-section">
      <h3>הערות נוספות לאומדן</h3>
      <textarea id="additional-notes" rows="4" placeholder="הכנס הערות נוספות כאן..." onchange="updateHelperFromField(event);"></textarea>
      <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
        <button type="button" class="btn save-btn" onclick="saveWithFeedback(event, 'notes')" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">שמור</button>
      </div>
    </div>

    <!-- Legal Text Section -->
    <div class="form-section" id="legal-text">
      <h3>טקסט משפטי לאומדן</h3>
      <select id="legal-text-selector" onchange="loadLegalTextFromVault();">
        <option value="">בחר טקסט משפטי...</option>
      </select>
      <textarea id="legal-text-content" rows="6" placeholder="הטקסט המשפטי יוטען כאן..." onchange="updateHelperFromField(event);"></textarea>
      <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
        <button type="button" class="btn save-btn" onclick="saveWithFeedback(event, 'legal-text')" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">שמור</button>
        <button type="button" class="btn btn-secondary" onclick="resetLegalText()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">איפוס טקסט</button>
      </div>
    </div>

    <!-- Attachments Section -->
    <div class="form-section" id="attachments-section">
      <h3>רשימת נספחים</h3>
      <select id="attachments-selector" onchange="loadAttachmentsFromVault();">
        <option value="">בחר רשימת נספחים...</option>
      </select>
      <textarea id="attachments-list" rows="4" placeholder="רשימת הנספחים תוטען כאן..." onchange="updateHelperFromField(event);"></textarea>
      <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
        <button type="button" class="btn save-btn" onclick="saveWithFeedback(event, 'attachments')" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">שמור</button>
        <button type="button" class="btn btn-secondary" onclick="resetAttachments()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">איפוס נספחים</button>
      </div>
    </div>

    <!-- VAT Settings Section -->
    <div class="form-section" id="vat-settings" style="background: #fff3cd; border-left: 4px solid #ffc107;">
      <h3>הגדרות מע"מ</h3>
      <div class="form-grid">
        <div>
          <label>אחוז מע"מ נוכחי:</label>
          <input type="text" id="current-vat-rate" readonly style="font-weight: bold;" />
        </div>
        <div>
          <label>עדכון ידני (למקרים חריגים):</label>
          <input type="number" id="manual-vat-rate" placeholder="17" min="0" max="100" step="0.1" />
          <button type="button" class="btn btn-secondary" onclick="updateVatRateEstimate()">עדכן</button>
        </div>
      </div>
      <div style="margin-top: 10px; font-size: 14px; color: #856404;">
        <strong>הערה:</strong> שינוי אחוז המע"מ ישפיע על כל החישובים בדף זה.
      </div>
      <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 15px;">
        <button type="button" class="btn save-btn" onclick="saveWithFeedback(event, 'vat-settings')" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">שמור</button>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button type="button" class="btn btn-primary" onclick="saveEstimate()">💾 שמור אומדן</button>
      <button type="button" class="btn btn-secondary" onclick="previewEstimate()">👁️ תצוגה מקדימה</button>
      <button type="button" class="btn btn-success" onclick="generateEstimate()">📄 הפק אומדן סופי</button>
    </div>
  </div>

  <!-- Floating PDF Viewer (hidden by default) -->
  <div id="floatingPdfViewer" style="display: none;">
    <div class="floating-pdf-overlay" onclick="if(event.target === this) document.getElementById('floatingPdfViewer').style.display='none';">
      <div class="floating-pdf-container">
        <div class="floating-pdf-header">
          <h3 id="floatingPdfTitle">מסמך</h3>
          <div class="floating-pdf-controls">
            <button type="button" class="btn" onclick="document.querySelector('.floating-pdf-content').classList.toggle('minimized')">_</button>
            <button type="button" class="btn" id="closePdfBtn" onclick="document.getElementById('floatingPdfViewer').style.display='none';">✕</button>
          </div>
        </div>
        <div class="floating-pdf-content" id="floatingPdfContent">
          <iframe src="" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- PIP Container (hidden by default) -->
  <div id="pip-container" class="pip-container">
    <div class="pip-header">
      <span>תצוגה מקדימה - אומדן</span>
      <div>
        <button onclick="document.getElementById('pip-content').classList.toggle('minimized')" style="background: none; border: none; color: white; cursor: pointer;">_</button>
        <button onclick="document.getElementById('pip-container').style.display='none'" style="background: none; border: none; color: white; cursor: pointer;">✕</button>
      </div>
    </div>
    <div class="pip-content" id="pip-content">
      <!-- Preview content will be loaded here -->
    </div>
  </div>

  <!-- Load external scripts -->
  <script src="legal-text-engine.js"></script>
  <script type="module" src="auth.js"></script>
  <script src="helper.js" type="module"></script>
  <script src="internal-browser.js"></script>
  <script src="levi-floating.js"></script>
  <script src="car-details-floating.js"></script>
  <script src="parts-search-results-floating.js"></script>
  <script src="invoice-details-floating.js"></script>
  
  <script>
    // Global state object to avoid conflicts
    const EstimateBuilderState = {
      isUpdating: false,
      autoSaveTimeout: null,
      damageCenters: [],
      adjustments: {
        features: [],
        registration: [],
        allAdjustments: []
      },
      depreciation: {
        items: [],
        global: {}
      }
    };

    // Initialize Full Market Value section
    function initializeFullMarketValueSection() {
      try {
        console.log('🔧 Initializing Full Market Value section');
        
        // Copy base price to full basic price field
        const basicPriceField = document.getElementById('basicPrice');
        const fullBasicPriceField = document.getElementById('fullBasicPrice');
        
        if (basicPriceField && fullBasicPriceField) {
          fullBasicPriceField.value = basicPriceField.value;
          
          // Add listener to keep them in sync
          basicPriceField.addEventListener('input', function() {
            fullBasicPriceField.value = this.value;
            // Calculate amounts first, then update calculations
            if (typeof calculateMarketValueAmounts === 'function') {
              calculateMarketValueAmounts();
            }
            updateFullMarketValueCalculation();
          });
          
          basicPriceField.addEventListener('change', function() {
            fullBasicPriceField.value = this.value;
            // Calculate amounts first, then update calculations
            if (typeof calculateMarketValueAmounts === 'function') {
              calculateMarketValueAmounts();
            }
            updateFullMarketValueCalculation();
          });
        }
        
        // Auto-populate gross value adjustments first
        setTimeout(() => {
          const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
          if (helper.valuation?.adjustments && (helper.valuation.adjustments.features || helper.valuation.adjustments.registration)) {
            console.log('📋 Auto-populating gross value adjustments on init');
            // autoPopulateGrossValueAdjustments(); // Disabled - using loadAdjustments() instead
          } else {
            console.log('ℹ️ No features/registration adjustments to auto-populate for gross value');
          }
        }, 200);

        // Auto-populate market adjustments if data exists
        setTimeout(() => {
          const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
          if (helper.valuation?.adjustments && Object.keys(helper.valuation.adjustments).length > 0) {
            console.log('📋 Auto-populating market adjustments on init');
            // autoPopulateMarketAdjustments(); // Disabled - using loadAdjustments() instead
          } else {
            console.log('ℹ️ No valuation adjustments to auto-populate');
          }
        }, 500);
        
      } catch (error) {
        console.error('❌ Error initializing Full Market Value section:', error);
      }
    }

    // Single DOMContentLoaded handler
    document.addEventListener('DOMContentLoaded', function() {
      initializeEstimateBuilder();
    });

    // Main initialization function
    function initializeEstimateBuilder() {
      console.log('🚀 Initializing Estimate Builder (Clean Version)');
      
      // Set initialization flag
      isInitializing = true;
      
      // Load data from helper
      loadDataFromHelper();
      loadDamageCentersSummary(window.helper || {});
      
      // Initialize Full Market Value section
      initializeFullMarketValueSection();
      
      // Add event listeners
      addEventListeners();
      
      // Initialize button states
      initializeButtonStates();
      
      // Setup auto-save
      setupAutoSave();
      
      // Initialize floating screens
      initializeFloatingScreens();
      
      // Clear initialization flag after delay
      setTimeout(() => {
        isInitializing = false;
        console.log('✅ Initialization complete - auto-save enabled');
      }, 1000);
      
      console.log('✅ Estimate Builder initialized successfully');
    }

    // Toggle section visibility
    window.toggleSection = function(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        section.style.display = section.style.display === 'none' ? 'block' : 'none';
      }
    }

    // Toggle floating screen
    window.toggleFloatingScreen = function(screenType) {
      console.log('🔄 Toggle floating screen:', screenType);
      
      // Implementation will depend on floating screen modules
      if (typeof window.toggleFloatingScreenOriginal === 'function') {
        window.toggleFloatingScreenOriginal(screenType);
      }
    };

    // ANTI-MESH WARFARE: Continuously remove mesh patterns
    function destroyMeshPattern() {
      const toggleSquares = document.querySelectorAll('.toggle-square');
      toggleSquares.forEach(square => {
        // Force remove any mesh background
        square.style.setProperty('background-image', 'linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%)', 'important');
        square.style.setProperty('background', 'linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%)', 'important');
        
        // Remove any pseudo-element mesh
        const beforeEl = window.getComputedStyle(square, '::before');
        const afterEl = window.getComputedStyle(square, '::after');
        
        if (beforeEl.getPropertyValue('background-image') !== 'none') {
          square.classList.add('no-mesh-before');
        }
        if (afterEl.getPropertyValue('background-image') !== 'none') {
          square.classList.add('no-mesh-after');
        }
      });
    }

    // Run anti-mesh on load and periodically
    document.addEventListener('DOMContentLoaded', destroyMeshPattern);
    window.addEventListener('load', destroyMeshPattern);
    setInterval(destroyMeshPattern, 1000); // Check every second

    // Also run when floating screens are toggled
    const originalToggle = window.toggleFloatingScreen;
    window.toggleFloatingScreen = function(screenType) {
      if (originalToggle) originalToggle(screenType);
      setTimeout(destroyMeshPattern, 100);
    };

    // Load data from helper
    function loadDataFromHelper() {
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        if (!helper || Object.keys(helper).length === 0) {
          console.log('⚠️ No helper data found');
          return;
        }

        console.log('📊 Loading data from helper');

        // Load vehicle data
        loadVehicleData(helper);
        
        // Load contact data
        loadContactData(helper);
        
        // Load damage centers
        loadDamageCenters(helper);
        
        // Load adjustments for full market section
        loadAdjustments(helper);
        
        // Load gross adjustments for gross section
        loadGrossAdjustments(helper);
        
        // Load gross values (basic price + adjustments)
        loadGrossValues(helper);
        
        // Load depreciation
        loadDepreciation(helper);
        
        // Load claims data
        loadClaimsData(helper);
        
        // Load additional notes
        loadAdditionalNotes(helper);
        
        // Update page title
        updatePageTitle(helper);

      } catch (error) {
        console.error('❌ Error loading helper data:', error);
      }
    }

    // Load vehicle data
    function loadVehicleData(helper) {
      const fields = {
        'carPlate': helper.car_details?.plate || helper.vehicle?.plate || '',
        'carManufacturer': helper.car_details?.manufacturer || '',
        'carModel': helper.car_details?.model || '',
        'carYear': helper.car_details?.year || '',
        'carModelCode': helper.car_details?.model_code || helper.vehicle?.model_code || '',
        'carBasePrice': helper.valuation?.base_price || helper.car_details?.base_price || '',
        'carMarketValue': helper.vehicle?.market_value || helper.calculations?.full_market_value || '',
        'carReportDate': helper.car_details?.report_date || ''
      };

      Object.entries(fields).forEach(([fieldId, value]) => {
        const field = document.getElementById(fieldId);
        if (field && value) {
          field.value = value;
        }
      });
    }

    // Load contact data
    function loadContactData(helper) {
      const fields = {
        'ownerName': helper.stakeholders?.owner?.name || helper.client?.name || '',
        'ownerAddress': helper.stakeholders?.owner?.address || helper.client?.address || '',
        'ownerPhone': helper.stakeholders?.owner?.phone || helper.client?.phone || '',
        'insuranceCompany': helper.stakeholders?.insurance?.company || helper.client?.insurance_company || '',
        'insuranceEmail': helper.stakeholders?.insurance?.email || helper.client?.insurance_email || '',
        'insuranceAgent': helper.stakeholders?.insurance?.agent?.name || helper.client?.insurance_agent || '',
        'agentPhone': helper.stakeholders?.insurance?.agent?.phone || helper.client?.insurance_agent_phone || '',
        'agentEmail': helper.stakeholders?.insurance?.agent?.email || helper.client?.insurance_agent_email || '',
        'garageName': helper.car_details?.garageName || '',
        'garagePhone': helper.car_details?.garagePhone || '',
        'garageEmail': helper.car_details?.garageEmail || ''
      };

      Object.entries(fields).forEach(([fieldId, value]) => {
        const field = document.getElementById(fieldId);
        if (field && value) {
          field.value = value;
        }
      });
    }

    // Update helper from field
    function updateHelperFromField(event) {
      if (EstimateBuilderState.isUpdating) return;
      
      try {
        EstimateBuilderState.isUpdating = true;
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        const fieldId = event.target.id;
        const value = event.target.value;
        
        console.log(`📝 Updating field: ${fieldId} = "${value}"`);
        
        // Update helper based on field
        // This is a simplified version - expand as needed
        switch(fieldId) {
          case 'carPlate':
            if (!helper.car_details) helper.car_details = {};
            helper.car_details.plate = value;
            break;
          case 'carManufacturer':
            if (!helper.car_details) helper.car_details = {};
            helper.car_details.manufacturer = value;
            break;
          // Add more cases as needed
        }
        
        // Save to session storage
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        // Update window.helper if exists
        if (window.helper) {
          window.helper = helper;
        }
        
      } catch (error) {
        console.error('❌ Error updating helper:', error);
      } finally {
        EstimateBuilderState.isUpdating = false;
      }
    }

    // Update helper from contact field
    window.updateHelperFromContactField = function(element) {
      // Similar to updateHelperFromField but for contact fields
      const event = { target: element };
      updateHelperFromField(event);
    }

    // Add event listeners
    function addEventListeners() {
      // Estimate type change
      document.querySelectorAll('input[name="estimate-type"]').forEach(radio => {
        radio.addEventListener('change', updateEstimateType);
      });

      // Add more event listeners as needed
    }

    // Update estimate type
    function updateEstimateType() {
      const selectedType = document.querySelector('input[name="estimate-type"]:checked')?.value;
      console.log('📋 Estimate type changed:', selectedType);
      
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        if (!helper.estimate) helper.estimate = {};
        helper.estimate.type = selectedType;
        sessionStorage.setItem('helper', JSON.stringify(helper));
      } catch (error) {
        console.error('❌ Error updating estimate type:', error);
      }
    }

    // Save estimate
    window.saveEstimate = function() {
      console.log('💾 Saving estimate...');
      
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        // Collect all form data
        const estimateData = {
          type: document.querySelector('input[name="estimate-type"]:checked')?.value,
          vehicle: collectVehicleData(),
          contact: collectContactData(),
          damageCenters: EstimateBuilderState.damageCenters,
          adjustments: EstimateBuilderState.adjustments,
          depreciation: EstimateBuilderState.depreciation,
          notes: document.getElementById('additional-notes')?.value || '',
          legalText: document.getElementById('legal-text-content')?.value || '',
          attachments: document.getElementById('attachments-list')?.value || ''
        };
        
        // Save to helper.estimate
        helper.estimate = estimateData;
        helper.estimate.savedAt = new Date().toISOString();
        
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        // Show success message
        showMessage('אומדן נשמר בהצלחה', 'success');
        
      } catch (error) {
        console.error('❌ Error saving estimate:', error);
        showMessage('שגיאה בשמירת האומדן', 'error');
      }
    };

    // Preview estimate
    window.previewEstimate = function() {
      console.log('👁️ Preview estimate');
      saveEstimate();
      // Implementation depends on preview requirements
      showEstimatePreviewPip();
    };

    // Generate estimate
    window.generateEstimate = function() {
      console.log('📄 Generate estimate');
      saveEstimate();
      // Navigate to validation page
      window.location.href = 'estimate-validation.html';
    };

    // Show message
    function showMessage(message, type = 'info') {
      const messageDiv = document.createElement('div');
      messageDiv.className = `section-message ${type}`;
      messageDiv.textContent = message;
      document.body.appendChild(messageDiv);
      
      setTimeout(() => {
        messageDiv.remove();
      }, 3000);
    }

    // Initialize button states
    function initializeButtonStates() {
      // Add any specific button initialization here
    }

    // Setup auto-save
    function setupAutoSave() {
      // Auto-save every 30 seconds if there are changes
      setInterval(() => {
        if (EstimateBuilderState.hasChanges) {
          saveEstimate();
          EstimateBuilderState.hasChanges = false;
        }
      }, 30000);
    }

    // Initialize floating screens
    function initializeFloatingScreens() {
      // This will be handled by the floating screen modules
      console.log('🖼️ Floating screens ready');
    }

    // Update page title
    function updatePageTitle(helper) {
      const plate = helper.meta?.plate || helper.car_details?.plate || '...';
      document.getElementById('pageTitle').textContent = `רכב מס. ${plate}`;
    }

    // Add feature adjustment row
    function addFeatureAdjustment() {
      const container = document.getElementById('featuresAdjustmentsList');
      const rowId = 'featureAdj_' + Date.now();
      
      const newRow = `
        <div id="${rowId}" style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr 80px; gap:10px; margin-bottom:8px;">
          <div><input type="text" placeholder="תיאור המאפיין" onchange="updateGrossMarketValueCalculation(); syncAdjustmentToHelper(this, 'features');" /></div>
          <div><select onchange="updateGrossMarketValueCalculation(); syncAdjustmentToHelper(this, 'features');">
            <option value="plus">תוספת (+)</option>
            <option value="minus">הפחתה (-)</option>
          </select></div>
          <div><input type="text" placeholder="אחוז" oninput="calculateAdjustmentValueSimple(this);" onchange="updateGrossMarketValueCalculation(); syncAdjustmentToHelper(this, 'features');" /></div>
          <div><input type="text" placeholder="₪" onchange="updateGrossMarketValueCalculation(); syncAdjustmentToHelper(this, 'features');" /></div>
          <div><button class="btn remove" onclick="removeAdjustmentRow('${rowId}')">מחק</button></div>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', newRow);
      updateGrossMarketValueCalculation();
    }

    // Add registration adjustment row
    function addRegistrationAdjustment() {
      const container = document.getElementById('registrationAdjustmentsList');
      const rowId = 'regAdj_' + Date.now();
      
      const newRow = `
        <div id="${rowId}" style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr 80px; gap:10px; margin-bottom:8px;">
          <div><input type="text" placeholder="תיאור עליה לכביש" onchange="updateGrossMarketValueCalculation(); syncAdjustmentToHelper(this, 'registration');" /></div>
          <div><select onchange="updateGrossMarketValueCalculation(); syncAdjustmentToHelper(this, 'registration');">
            <option value="plus">תוספת (+)</option>
            <option value="minus">הפחתה (-)</option>
          </select></div>
          <div><input type="text" placeholder="אחוז" oninput="calculateAdjustmentValueSimple(this);" onchange="updateGrossMarketValueCalculation(); syncAdjustmentToHelper(this, 'registration');" /></div>
          <div><input type="text" placeholder="₪" onchange="updateGrossMarketValueCalculation(); syncAdjustmentToHelper(this, 'registration');" /></div>
          <div><button class="btn remove" onclick="removeAdjustmentRow('${rowId}')">מחק</button></div>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', newRow);
      updateGrossMarketValueCalculation();
    }

    // Add Features Adjustment
    window.addFullFeaturesAdjustment = function() {
      const container = document.getElementById('fullFeaturesAdjustmentsList');
      const rowId = 'fullFeaturesAdj_' + Date.now();
      const newRow = `
        <div id="${rowId}" class="adjustment-row" style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr 80px; gap:10px; margin-bottom:8px;">
          <div><input type="text" placeholder="תיאור תוספת מאפיין" title="" onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'features'); this.title = this.value;" oninput="this.title = this.value;" /></div>
          <div><select onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'features');" title="">
            <option value="plus">תוספת (+)</option>
            <option value="minus">הפחתה (-)</option>
          </select></div>
          <div><input type="text" placeholder="אחוז" title="" oninput="calculateAdjustmentValueSimple(this); this.title = this.value;" onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'features'); this.title = this.value;" /></div>
          <div><input type="text" placeholder="₪" title="" onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'features'); this.title = this.value;" oninput="this.title = this.value;" /></div>
          <div><button class="btn remove" onclick="removeAdjustmentRow('${rowId}')">מחק</button></div>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', newRow);
    }
    
    // Add Registration Adjustment  
    window.addFullRegistrationAdjustment = function() {
      const container = document.getElementById('fullRegistrationAdjustmentsList');
      const rowId = 'fullRegistrationAdj_' + Date.now();
      const newRow = `
        <div id="${rowId}" class="adjustment-row" style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr 80px; gap:10px; margin-bottom:8px;">
          <div><input type="text" placeholder="תיאור עליה לכביש" onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'registration');" /></div>
          <div><select onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'registration');">
            <option value="plus">תוספת (+)</option>
            <option value="minus">הפחתה (-)</option>
          </select></div>
          <div><input type="text" placeholder="אחוז" oninput="calculateAdjustmentValueSimple(this);" onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'registration');" /></div>
          <div><input type="text" placeholder="₪" onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'registration');" /></div>
          <div><button class="btn remove" onclick="removeAdjustmentRow('${rowId}')">מחק</button></div>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', newRow);
    }
    
    // Add Mileage Adjustment
    window.addMileageAdjustment = function() {
      const container = document.getElementById('mileageAdjustmentsList');
      const rowId = 'mileageAdj_' + Date.now();
      
      const newRow = `
        <div id="${rowId}" class="adjustment-row" style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr 80px; gap:10px; margin-bottom:8px;">
          <div><input type="text" placeholder="תיאור מס ק&quot;מ" title="" onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'mileage'); this.title = this.value;" oninput="this.title = this.value;" /></div>
          <div><select onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'mileage');" title="">
            <option value="plus">תוספת (+)</option>
            <option value="minus">הפחתה (-)</option>
          </select></div>
          <div><input type="text" placeholder="אחוז" title="" oninput="calculateAdjustmentValueSimple(this); this.title = this.value;" onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'mileage'); this.title = this.value;" /></div>
          <div><input type="text" placeholder="₪" title="" onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'mileage'); this.title = this.value;" oninput="this.title = this.value;" /></div>
          <div><button class="btn remove" onclick="removeAdjustmentRow('${rowId}')">מחק</button></div>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', newRow);
    }
    
    // Add Ownership Type Adjustment
    window.addOwnershipAdjustment = function() {
      const container = document.getElementById('ownershipAdjustmentsList');
      const rowId = 'ownershipAdj_' + Date.now();
      
      const newRow = `
        <div id="${rowId}" class="adjustment-row" style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr 80px; gap:10px; margin-bottom:8px;">
          <div><input type="text" placeholder="תיאור סוג בעלות" title="" onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'ownership_type'); this.title = this.value;" oninput="this.title = this.value;" /></div>
          <div><select onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'ownership_type');" title="">
            <option value="plus">תוספת (+)</option>
            <option value="minus">הפחתה (-)</option>
          </select></div>
          <div><input type="text" placeholder="אחוז" title="" oninput="calculateAdjustmentValueSimple(this); this.title = this.value;" onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'ownership_type'); this.title = this.value;" /></div>
          <div><input type="text" placeholder="₪" title="" onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'ownership_type'); this.title = this.value;" oninput="this.title = this.value;" /></div>
          <div><button class="btn remove" onclick="removeAdjustmentRow('${rowId}')">מחק</button></div>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', newRow);
    }
    
    // Add Number of Owners Adjustment
    window.addOwnersAdjustment = function() {
      const container = document.getElementById('ownersAdjustmentsList');
      const rowId = 'ownersAdj_' + Date.now();
      
      const newRow = `
        <div id="${rowId}" class="adjustment-row" style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr 80px; gap:10px; margin-bottom:8px;">
          <div><input type="text" placeholder="תיאור מספר בעלים" title="" onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'ownership_history'); this.title = this.value;" oninput="this.title = this.value;" /></div>
          <div><select onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'ownership_history');" title="">
            <option value="plus">תוספת (+)</option>
            <option value="minus">הפחתה (-)</option>
          </select></div>
          <div><input type="text" placeholder="אחוז" title="" oninput="calculateAdjustmentValueSimple(this); this.title = this.value;" onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'ownership_history'); this.title = this.value;" /></div>
          <div><input type="text" placeholder="₪" title="" onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'ownership_history'); this.title = this.value;" oninput="this.title = this.value;" /></div>
          <div><button class="btn remove" onclick="removeAdjustmentRow('${rowId}')">מחק</button></div>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', newRow);
    }
    
    // Add General Full Market Adjustment (additional)
    window.addFullMarketAdjustment = function() {
      const container = document.getElementById('allAdjustmentsList');
      const rowId = 'fullAdj_' + Date.now();
      
      const newRow = `
        <div id="${rowId}" class="adjustment-row" style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr 80px; gap:10px; margin-bottom:8px;">
          <div><input type="text" placeholder="תיאור התאמה נוספת" onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'additional');" /></div>
          <div><select onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'additional');">
            <option value="plus">תוספת (+)</option>
            <option value="minus">הפחתה (-)</option>
          </select></div>
          <div><input type="text" placeholder="אחוז" oninput="calculateAdjustmentValueSimple(this);" onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'additional');" /></div>
          <div><input type="text" placeholder="₪" onchange="updateFullMarketValueCalculation(); syncAdjustmentToHelper(this, 'additional');" /></div>
          <div><button class="btn remove" onclick="removeAdjustmentRow('${rowId}')">מחק</button></div>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', newRow);
    }

    
    // WORKING DAMAGE CENTER FUNCTIONS FROM FINAL-REPORT-BUILDER
    function addNewDamageCenter() {
      const container = document.getElementById('editableDamageCenters');
      if (!container) {
        // If no container exists, create it
        document.getElementById('damageCentersContent').innerHTML = '<div style="display: grid; gap: 15px;" id="editableDamageCenters"></div>';
      }
      
      const newIndex = document.querySelectorAll('.editable-damage-card').length;
      const newBlock = {
        damage_center_name: `מוקד נזק ${newIndex + 1}`,
        parts: [],
        works: [],
        repairs: [],
        work_cost: 0,
        parts_cost: 0
      };
      
      const newCardHTML = createEditableDamageCenterCard(newBlock, newIndex);
      document.getElementById('editableDamageCenters').insertAdjacentHTML('beforeend', newCardHTML);
      
      setTimeout(() => {
        addDamageCenterEventListeners();
        // Create subtotal if it doesn't exist
        if (!document.getElementById('damageCentersSubtotal')) {
          createDamageCentersSubtotal();
        }
      }, 100);
    }

    function addDamageCenterEventListeners_OLD_REMOVE() {
      // 2-WAY DATA FLOW: Add listeners to ALL fields for auto-save
      const selectors = '.damage-center-location, .damage-center-description, .part-name, .part-desc, .part-price, .part-source, .work-name, .work-type, .work-cost, .repair-text, .repair-cost';
      
      document.querySelectorAll(selectors).forEach(input => {
        // Check if already has listeners to prevent duplicates
        if (!input.hasAttribute('data-listeners-added')) {
          // Auto-save on change
          input.addEventListener('change', () => {
            saveDamageCenterChanges();
            updateAllCostDisplays();
          });
          
          // Auto-save on blur (when user leaves field)
          input.addEventListener('blur', () => {
            saveDamageCenterChanges();
            updateAllCostDisplays();
          });
          
          // Live update displays on input
          input.addEventListener('input', () => {
            updateAllCostDisplays();
          });
          
          input.setAttribute('data-listeners-added', 'true');
        }
      });
    }
    
    function handleCostInputChange(e) {
      const card = e.target.closest('.editable-damage-card');
      updateCostDisplay(card);
      updateDamageCentersSubtotal();
    }
    
    // Handle damage center changes
    function handleDamageCenterChange(event) {
      EstimateBuilderState.hasChanges = true;
      updateCostDisplay(event.target.closest('.editable-damage-card'));
    }

    
    // UPDATE COST DISPLAY - WORKING VERSION
    function updateCostDisplay(card) {
      if (!card) return;
      
      // Calculate parts cost
      let partsCost = 0;
      card.querySelectorAll('.part-price').forEach(input => {
        partsCost += parseFloat(input.value) || 0;
      });
      
      // Calculate works cost
      let worksCost = 0;
      card.querySelectorAll('.work-cost').forEach(input => {
        worksCost += parseFloat(input.value) || 0;
      });
      
      // Calculate repairs cost
      let repairsCost = 0;
      card.querySelectorAll('.repair-cost').forEach(input => {
        repairsCost += parseFloat(input.value) || 0;
      });
      
      const totalCost = partsCost + worksCost + repairsCost;
      const vatRate = (window.getHelperVatRate ? window.getHelperVatRate() / 100 : 0.17);
      const totalWithVAT = totalCost * (1 + vatRate);
      
      // Update display elements
      const workDisplay = card.querySelector('.work-costs-display');
      const partsDisplay = card.querySelector('.parts-costs-display');
      const repairsDisplay = card.querySelector('.repairs-costs-display');
      const totalDisplay = card.querySelector('.total-with-vat-display');
      
      if (workDisplay) {
        workDisplay.textContent = `₪${worksCost.toLocaleString()}`;
      }
      if (partsDisplay) {
        partsDisplay.textContent = `₪${partsCost.toLocaleString()}`;
      }
      if (repairsDisplay) {
        repairsDisplay.textContent = `₪${repairsCost.toLocaleString()}`;
      }
      if (totalDisplay) {
        totalDisplay.textContent = `₪${Math.round(totalWithVAT).toLocaleString()}`;
      }
    }
    
    // Create damage centers subtotal
    function createDamageCentersSubtotal() {
      const existingSubtotal = document.getElementById('damageCentersSubtotal');
      if (existingSubtotal) {
        existingSubtotal.remove();
      }
      
      const damageCentersContent = document.getElementById('damageCentersContent');
      if (!damageCentersContent) return;
      
      const subtotalHTML = `
        <div id="damageCentersSubtotal" style="background: #f8f9fa; border: 2px solid #28a745; border-radius: 6px; padding: 12px; margin-top: 15px;">
          <h4 style="margin: 0 0 10px 0; color: #28a745; text-align: center; font-size: 14px; font-weight: bold;">🧮 סיכום כללי - מרכזי נזק</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-bottom: 8px;">
            <div style="background: #17a2b8; color: white; padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 16px; font-weight: bold;" id="totalWorksCost">₪0</div>
              <div style="font-size: 10px; opacity: 0.9;">סה"כ עבודות</div>
            </div>
            <div style="background: #28a745; color: white; padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 16px; font-weight: bold;" id="totalPartsCost">₪0</div>
              <div style="font-size: 10px; opacity: 0.9;">סה"כ חלפים</div>
            </div>
            <div style="background: #ffc107; color: #212529; padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 16px; font-weight: bold;" id="totalRepairsCost">₪0</div>
              <div style="font-size: 10px; opacity: 0.9;">סה"כ תיקונים</div>
            </div>
            <div style="background: #6c757d; color: white; padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 16px; font-weight: bold;" id="totalBeforeVAT">₪0</div>
              <div style="font-size: 10px; opacity: 0.9;">לפני מע"מ</div>
            </div>
            <div style="background: #dc3545; color: white; padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 16px; font-weight: bold;" id="totalWithVAT">₪0</div>
              <div style="font-size: 10px; opacity: 0.9;">כולל מע"מ</div>
            </div>
          </div>
        </div>
      `;
      
      damageCentersContent.insertAdjacentHTML('beforeend', subtotalHTML);
      updateDamageCentersSubtotal();
    }
    
    // UPDATE DAMAGE CENTERS SUBTOTAL - COMPLETE VERSION
    function updateDamageCentersSubtotal() {
      let totalWorks = 0;
      let totalParts = 0;
      let totalRepairs = 0;
      
      // Calculate totals from all damage center cards
      document.querySelectorAll('.editable-damage-card').forEach(card => {
        // Sum parts costs
        card.querySelectorAll('.part-row').forEach(row => {
          const price = parseFloat(row.querySelector('.part-price').value) || 0;
          totalParts += price;
        });
        
        // Sum work costs
        card.querySelectorAll('.work-row').forEach(row => {
          const cost = parseFloat(row.querySelector('.work-cost').value) || 0;
          totalWorks += cost;
        });
        
        // Sum repair costs
        card.querySelectorAll('.repair-row').forEach(row => {
          const cost = parseFloat(row.querySelector('.repair-cost').value) || 0;
          totalRepairs += cost;
        });
      });
      
      const totalWithoutVat = totalWorks + totalParts + totalRepairs;
      const vatRate = (window.getHelperVatRate ? window.getHelperVatRate() / 100 : 0.17);
      const totalWithVat = totalWithoutVat * (1 + vatRate);
      
      // Update displays
      const totalPartsDisplay = document.getElementById('totalPartsCost');
      if (totalPartsDisplay) totalPartsDisplay.textContent = `₪${totalParts.toLocaleString()}`;
      
      const totalWorksDisplay = document.getElementById('totalWorksCost');
      if (totalWorksDisplay) totalWorksDisplay.textContent = `₪${totalWorks.toLocaleString()}`;
      
      const totalRepairsDisplay = document.getElementById('totalRepairsCost');
      if (totalRepairsDisplay) totalRepairsDisplay.textContent = `₪${totalRepairs.toLocaleString()}`;
      
      const totalBeforeDisplay = document.getElementById('totalBeforeVAT');
      if (totalBeforeDisplay) totalBeforeDisplay.textContent = `₪${totalWithoutVat.toLocaleString()}`;
      
      const totalWithDisplay = document.getElementById('totalWithVAT');
      if (totalWithDisplay) totalWithDisplay.textContent = `₪${Math.round(totalWithVat).toLocaleString()}`;
      
      // Update claims data fields
      const totalClaimField = document.getElementById('totalClaim');
      if (totalClaimField) {
        totalClaimField.value = `₪${totalWithoutVat.toLocaleString()}`;
      }
      
      // Update damage percentage calculation
      calculateDamagePercentage();
    }
    
    // Show part suggestions
    window.showPartSuggestions = function(input, centerIndex, partIndex) {
      const value = input.value.trim();
      const suggestionsDiv = input.nextElementSibling;
      
      if (value.length < 2) {
        suggestionsDiv.style.display = 'none';
        return;
      }
      
      // This would integrate with parts search module
      // For now, just hide suggestions
      suggestionsDiv.style.display = 'none';
    };
    
    // Handle work type change
    window.handleWorkTypeChange = function(select, centerIndex, workIndex) {
      // Could implement auto-pricing based on work type
      EstimateBuilderState.hasChanges = true;
    };
    
    // Global flag to prevent saving during initialization
    let isInitializing = true;
    
    // Save damage center changes with feedback
    // FIXED DAMAGE CENTERS SAVE FUNCTION - Using DOM-First Pattern from estimate-builder.html
    window.saveDamageCenterChanges = function saveDamageCenterChanges() {
      // Don't save during initialization
      if (isInitializing) {
        console.log('⏸️ Skipping save during initialization');
        return true;
      }
      
      try {
        // 🔧 CRITICAL: Use window.helper directly (not const) to ensure we're updating the live object
        window.helper = window.helper || {};
        
        // Initialize centers if not exists
        if (!window.helper.centers) window.helper.centers = [];
        
        // 🆕 ESTIMATE WORKFLOW: Initialize estimate structure
        if (!window.helper.estimate) window.helper.estimate = {};
        if (!window.helper.estimate.damage_centers) window.helper.estimate.damage_centers = [];
        
        // Clean up any redundant damage_assessment.centers (duplicate section)
        // BUT preserve damage_assessment.summary which contains totals data
        if (window.helper.damage_assessment?.centers) {
          console.log('🧹 Cleaning up redundant damage_assessment.centers');
          delete window.helper.damage_assessment.centers;
          
          // Only delete damage_assessment object if it has no important data left
          // Preserve .summary, .totals, and any other important sections
          const remainingKeys = Object.keys(window.helper.damage_assessment);
          const importantSections = ['summary', 'totals', 'total_centers', 'total_items', 'last_updated', 'totals_after_differentials'];
          const hasImportantData = remainingKeys.some(key => importantSections.includes(key));
          
          if (!hasImportantData && remainingKeys.length === 0) {
            console.log('🧹 Deleting empty damage_assessment object');
            delete window.helper.damage_assessment;
          } else {
            console.log('🔒 Preserving damage_assessment with important sections:', remainingKeys);
          }
        }
        
        // Also maintain expertise.damage_blocks for backward compatibility
        if (!window.helper.expertise) window.helper.expertise = {};
        if (!window.helper.expertise.damage_blocks) window.helper.expertise.damage_blocks = [];
        
        // 🔥 CRITICAL FIX: Collect ALL data from DOM BEFORE clearing arrays
        const collectedCenters = [];
        const collectedDamageBlocks = [];
        const collectedEstimateCenters = [];
        
        // Store damage center names for depreciation section
        const damageCenterNames = [];
        
        // 🔥 FIRST: Collect ALL data from DOM elements into temporary arrays
        document.querySelectorAll('.editable-damage-card').forEach((card, index) => {
          // Extract just the number from the damage center number field
          const centerNumberField = card.querySelector('.damage-center-number').value;
          // Extract the number (e.g., "מוקד נזק מס' 1" -> "1")
          const numberMatch = centerNumberField.match(/\d+$/);
          const centerNumber = numberMatch ? numberMatch[0] : String(index + 1);
          const centerLocation = card.querySelector('.damage-center-location').value;
          const centerDescription = card.querySelector('.damage-center-description').value;
          
          // Collect parts
          const parts = [];
          card.querySelectorAll('.part-row').forEach(row => {
            const name = row.querySelector('.part-name').value;
            const desc = row.querySelector('.part-desc').value;
            const price = row.querySelector('.part-price').value;
            const source = row.querySelector('.part-source')?.value || 'תחליפי';
            
            if (name.trim()) {
              parts.push({ name, desc, price: parseFloat(price) || 0, source });
            }
          });
          
          // Collect works
          const works = [];
          card.querySelectorAll('.work-row').forEach(row => {
            let type = row.querySelector('.work-type').value;
            const note = row.querySelector('.work-note')?.value || '';
            const cost = parseFloat(row.querySelector('.work-cost').value) || 0;
            
            // If "אחר" is selected, get the custom text from the input
            if (type === 'אחר') {
              const otherInput = row.querySelector('.work-type-other');
              if (otherInput && otherInput.value.trim()) {
                type = otherInput.value.trim();
              }
            }
            
            if (type) {
              works.push({ category: type, comments: note, cost });
            }
          });
          
          // Collect repairs
          const repairs = [];
          card.querySelectorAll('.repair-row').forEach(row => {
            const text = row.querySelector('.repair-text').value;
            const cost = parseFloat(row.querySelector('.repair-cost').value) || 0;
            
            if (text.trim()) {
              repairs.push({ description: text, cost });
            }
          });
          
          // Calculate costs using individual cost fields
          const partsCost = parts.reduce((sum, part) => sum + (parseFloat(part.price) || 0), 0);
          const workCost = works.reduce((sum, work) => sum + (parseFloat(work.cost) || 0), 0);
          const repairsCost = repairs.reduce((sum, repair) => sum + (parseFloat(repair.cost) || 0), 0);
          const totalCost = partsCost + workCost + repairsCost;
          
          // Create center object in helper.centers format (source of truth)
          const centerObject = {
            Id: `dc_${Date.now()}_${index + 1}`, // Generate unique ID
            "Damage center Number": centerNumber || (index + 1),
            Location: centerLocation,
            Description: centerDescription,
            Parts: {
              parts_required: parts,
              parts_meta: {
                total_items: parts.length,
                total_cost: partsCost
              }
            },
            Works: {
              works: works,
              works_meta: {
                total_items: works.length,
                total_cost: workCost
              }
            },
            Repairs: {
              repairs: repairs,
              repairs_meta: {
                total_items: repairs.length,
                total_cost: repairsCost
              }
            },
            Summary: {
              "Total with VAT": totalCost * (1 + (window.getHelperVatRate ? window.getHelperVatRate() : 18) / 100)
            }
          };
          
          // 🔥 Add to temporary collections (not directly to helper)
          collectedCenters.push(centerObject);
          
          // 🆕 ESTIMATE WORKFLOW: Prepare estimate structure
          collectedEstimateCenters.push({
            center_number: centerNumber || (index + 1),
            location: centerLocation,
            description: centerDescription,
            parts: parts,
            works: works,
            repairs: repairs,
            costs: {
              parts_cost: partsCost,
              work_cost: workCost,
              repairs_cost: repairsCost,
              total_cost: totalCost,
              total_with_vat: totalCost * (1 + (window.getHelperVatRate ? window.getHelperVatRate() : 18) / 100)
            }
          });
          
          // Also prepare damage_blocks for backward compatibility
          collectedDamageBlocks.push({
            damage_center_name: centerLocation,
            damage_center_number: index + 1,
            center_header: centerNumber,
            description: centerDescription,
            parts,
            works,
            repairs,
            parts_cost: partsCost,
            work_cost: workCost,
            repairs_cost: repairsCost
          });
          
          // Store damage center data for depreciation section (complete object)
          if (centerLocation.trim()) {
            damageCenterNames.push({
              name: centerLocation.trim(),
              number: centerNumber || (index + 1),
              description: centerDescription || ''
            });
          }
          
          // Update cost display for this card
          updateCostDisplay(card, partsCost, workCost, repairsCost);
        });
        
        // 🔥 NOW clear and rebuild arrays with collected data
        window.helper.centers = collectedCenters;
        window.helper.expertise.damage_blocks = collectedDamageBlocks;
        window.helper.estimate.damage_centers = collectedEstimateCenters;
        
        // 🆕 ESTIMATE WORKFLOW: Calculate estimate totals and save to calculations
        const totalEstimateCost = collectedEstimateCenters.reduce((sum, center) => sum + center.costs.total_cost, 0);
        const totalEstimateWithVAT = collectedEstimateCenters.reduce((sum, center) => sum + center.costs.total_with_vat, 0);
        
        if (!window.helper.calculations) window.helper.calculations = {};
        window.helper.calculations.total_estimate = totalEstimateCost;
        window.helper.calculations.total_estimate_with_vat = totalEstimateWithVAT;
        
        // Initialize damage assessment if needed
        if (!window.helper.damage_assessment) window.helper.damage_assessment = {};
        
        // Save damage assessment summary and totals
        window.helper.damage_assessment.summary = {
          total_centers: document.querySelectorAll('.editable-damage-card').length,
          total_parts: document.querySelectorAll('.part-row').length,
          total_works: document.querySelectorAll('.work-row').length,
          total_repairs: document.querySelectorAll('.repair-row').length,
          damage_center_names: damageCenterNames,
          last_updated: new Date().toISOString()
        };
        
        // Save updated centers count
        window.helper.damage_assessment.total_centers = document.querySelectorAll('.editable-damage-card').length;
        
        // 🔥 CRITICAL: Update estimate metadata
        if (!window.helper.estimate.metadata) window.helper.estimate.metadata = {};
        window.helper.estimate.metadata.damage_centers_count = document.querySelectorAll('.editable-damage-card').length;
        window.helper.estimate.metadata.last_updated = new Date().toISOString();
        
        // 🔥 CRITICAL: Save to sessionStorage - ensure we're saving the updated window.helper
        sessionStorage.setItem('helper', JSON.stringify(window.helper));
        
        // Update depreciation section with damage center names
        if (typeof updateDepreciationFromDamageCenters === 'function') {
          updateDepreciationFromDamageCenters(damageCenterNames);
        }
        
        // Trigger floating screen refresh
        if (typeof triggerFloatingScreenRefresh === 'function') {
          triggerFloatingScreenRefresh();
        }
        
        console.log('✅ Damage centers saved to multiple locations:');
        console.log('- window.helper.centers:', window.helper.centers);
        console.log('- window.helper.estimate.damage_centers:', window.helper.estimate.damage_centers);
        console.log('- window.helper.expertise.damage_blocks:', window.helper.expertise.damage_blocks);
        console.log('- Calculations:', window.helper.calculations);
        
        // Update damage centers totals display
        setTimeout(updateDamageCentersSubtotal, 100);
        
        return true;
      } catch (error) {
        console.error('Error saving damage center changes:', error);
        return false;
      }
    }

    window.saveDamageCenterChangesWithFeedback = function(event) {
      console.log('🔘 Save button clicked');
      const button = event.target;
      const originalText = button.textContent;
      const originalBg = button.style.background;
      
      button.disabled = true;
      button.textContent = 'שומר...';
      button.style.background = '#ffc107';
      
      try {
        if (saveDamageCenterChanges()) {
          button.style.background = '#28a745';
          button.textContent = '✓ נשמר בהצלחה!';
          console.log('✅ Save successful');
          
          setTimeout(() => {
            button.disabled = false;
            button.style.background = originalBg;
            button.textContent = originalText;
          }, 2000);
        } else {
          button.style.background = '#dc3545';
          button.textContent = '✗ שגיאה בשמירה';
          console.log('❌ Save failed');
          
          setTimeout(() => {
            button.disabled = false;
            button.style.background = originalBg;
            button.textContent = originalText;
          }, 2000);
        }
      } catch (error) {
        console.error('❌ Error in save:', error);
        button.style.background = '#dc3545';
        button.textContent = '✗ שגיאה';
        
        setTimeout(() => {
          button.disabled = false;
          button.style.background = originalBg;
          button.textContent = originalText;
        }, 2000);
      }
    };

    // Generic save feedback function for all sections
    function saveWithFeedback(event, sectionName) {
      const button = event.target;
      const originalText = button.textContent;
      const originalBg = button.style.background;
      
      button.disabled = true;
      button.textContent = 'שומר...';
      button.style.background = '#ffc107';
      
      // Save to sessionStorage
      const helper = window.helper || {};
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      // Show success
      button.style.background = '#28a745';
      button.textContent = '✓ נשמר בהצלחה!';
      console.log(`✅ ${sectionName} saved successfully`);
      
      setTimeout(() => {
        button.disabled = false;
        button.style.background = originalBg;
        button.textContent = originalText;
      }, 2000);
    }

    // Save functions for each section
    window.saveVehicleDataWithFeedback = function(event) {
      saveWithFeedback(event, 'Vehicle Data');
    };

    window.saveContactDataWithFeedback = function(event) {
      saveWithFeedback(event, 'Contact Data');
    };

    window.saveFullMarketValueWithFeedback = function(event) {
      console.log('🔘 Save full market value button clicked!');
      try {
        // Get helper with proper structure check
        let helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        if (!helper) helper = {};
        
        // Update helper from all market value adjustments - DISABLED: conflicts with real-time sync
        // updateHelperFromAdjustments(helper); // This function only processes first row and overwrites multi-row data
        
        // Save back to sessionStorage
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        // Call the standard save with feedback
        saveWithFeedback(event, 'Full Market Value');
      } catch (error) {
        console.error('❌ Error in saveFullMarketValueWithFeedback:', error);
        showSaveResult('שגיאה בשמירת נתוני ערך שוק מלא', false);
      }
    };

    window.saveGrossValueWithFeedback = function(event) {
      saveWithFeedback(event, 'Gross Value');
    };

    window.saveGrossPercentageWithFeedback = function(event) {
      console.log('🔘 Save gross percentage button clicked!');
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        // Save the percentage fields to helper
        const totalDamageCostField = document.getElementById('totalDamageCost');
        const grossValueDisplayField = document.getElementById('grossValueDisplay');
        const grossDamagePercentageField = document.getElementById('grossDamagePercentage');
        
        helper.claims_data = helper.claims_data || {};
        
        if (totalDamageCostField && totalDamageCostField.value) {
          helper.claims_data.total_claim = totalDamageCostField.value;
        }
        
        if (grossValueDisplayField && grossValueDisplayField.value) {
          helper.claims_data.gross_value = grossValueDisplayField.value;
        }
        
        if (grossDamagePercentageField && grossDamagePercentageField.value) {
          helper.claims_data.gross_percent = grossDamagePercentageField.value;
        }
        
        // Save to storage
        sessionStorage.setItem('helper', JSON.stringify(helper));
        window.helper = helper;
        
        // Show feedback
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'נשמר ✓';
        button.style.background = '#28a745';
        
        setTimeout(() => {
          button.textContent = originalText;
          button.style.background = '#007bff';
        }, 2000);
        
        console.log('✅ Saved gross percentage data');
        
      } catch (error) {
        console.error('❌ Error saving gross percentage:', error);
        alert('❌ Error saving: ' + error.message);
      }
    };
    
    // Calculate damage percentage
    function calculateDamagePercentage() {
      const totalDamage = parseFloat(document.getElementById('totalDamageCost')?.value.replace(/[₪,]/g, '')) || 0;
      const grossValue = parseFloat(document.getElementById('grossMarketValueResult')?.value.replace(/[₪,]/g, '')) || 0;
      
      if (grossValue > 0) {
        const percentage = (totalDamage / grossValue) * 100;
        const percentageField = document.getElementById('grossDamagePercentage');
        if (percentageField) {
          percentageField.value = percentage.toFixed(2) + '%';
        }
        
        // Also write to claims_data.gross_percent (same as final-report-builder)
        try {
          const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
          helper.claims_data = helper.claims_data || {};
          helper.claims_data.gross_percent = `${percentage.toFixed(2)}%`;
          sessionStorage.setItem('helper', JSON.stringify(helper));
          window.helper = helper;
          console.log('✅ Updated claims_data.gross_percent:', helper.claims_data.gross_percent);
        } catch (error) {
          console.error('❌ Error updating claims_data.gross_percent:', error);
        }
        
        // Update damage cost field
        const damageCostField = document.getElementById('totalDamageCost');
        if (damageCostField) {
          damageCostField.value = `₪${totalDamage.toLocaleString()}`;
        }
        
        // Update gross value display
        const grossValueDisplay = document.getElementById('grossValueDisplay');
        if (grossValueDisplay) {
          grossValueDisplay.value = `₪${grossValue.toLocaleString()}`;
        }
        
        // Update summary damage percentage
        const summaryPercentage = document.getElementById('damagePercentage');
        if (summaryPercentage) {
          summaryPercentage.textContent = percentage.toFixed(2) + '%';
        }
      }
    }

    function addDepField() {
      console.log('➕ Add depreciation field');
      // Implementation here
    }

    function updateGrossMarketValueCalculation() {
      console.log('📊 Update gross market value');
      try {
        // Get basic price
        const basicPriceField = document.getElementById('basicPrice');
        const basicPrice = parseFloat((basicPriceField?.value || '').replace(/[₪,]/g, '')) || 0;
        
        // Calculate features adjustments total from GROSS section
        let featuresTotal = 0;
        const featuresRows = document.querySelectorAll('#featuresAdjustmentsList > div');
        featuresRows.forEach(row => {
          const inputs = row.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const amount = parseFloat((inputs[3].value || '').replace(/[₪,]/g, '')) || 0;
            const type = inputs[1].value;
            featuresTotal += (type === 'minus' ? -amount : amount);
          }
        });
        
        // Update features cumulative display
        const featuresCumulative = document.querySelector('#grossFeaturesCumulative span');
        if (featuresCumulative) {
          const afterFeatures = basicPrice + featuresTotal;
          featuresCumulative.textContent = `₪${afterFeatures.toLocaleString()}`;
          featuresCumulative.style.color = afterFeatures > 0 ? '#28a745' : '#dc3545';
        }
        
        // Calculate registration adjustments total from GROSS section
        let registrationTotal = 0;
        const registrationRows = document.querySelectorAll('#registrationAdjustmentsList > div');
        registrationRows.forEach(row => {
          const inputs = row.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const amount = parseFloat((inputs[3].value || '').replace(/[₪,]/g, '')) || 0;
            const type = inputs[1].value;
            registrationTotal += (type === 'minus' ? -amount : amount);
          }
        });
        
        // Update registration cumulative display
        const registrationCumulative = document.querySelector('#grossRegistrationCumulative span');
        if (registrationCumulative) {
          const afterRegistration = basicPrice + featuresTotal + registrationTotal;
          registrationCumulative.textContent = `₪${afterRegistration.toLocaleString()}`;
          registrationCumulative.style.color = afterRegistration > 0 ? '#28a745' : '#dc3545';
        }
        
        // Calculate gross market value
        const grossMarketValue = basicPrice + featuresTotal + registrationTotal;
        
        // Update the result field
        const resultField = document.getElementById('grossMarketValueResult');
        if (resultField) {
          resultField.value = `₪${grossMarketValue.toLocaleString()}`;
        }
        
        // Update any other gross value displays
        const grossValueDisplay = document.getElementById('grossValueDisplay');
        if (grossValueDisplay) {
          grossValueDisplay.value = `₪${grossMarketValue.toLocaleString()}`;
        }
        
        // Use existing math engine for gross damage percentage calculation
        if (typeof calculateDamagePercentage === 'function') {
          calculateDamagePercentage();
        }
        
        console.log('✅ Updated gross market value to:', grossMarketValue);
        console.log('📊 Cumulative values - After features:', basicPrice + featuresTotal, 'After registration:', grossMarketValue);
        
      } catch (error) {
        console.error('❌ Error updating gross market value:', error);
      }
    }

    function updateHelperFromAdjustments(helper) {
      console.log('📊 Update helper from adjustments');
      try {
        // Ensure valuation structure exists
        if (!helper.valuation) helper.valuation = {};
        if (!helper.valuation.adjustments) helper.valuation.adjustments = {};
        
        // 1. Update basic price
        const basicPriceField = document.getElementById('basicPrice');
        if (basicPriceField && basicPriceField.value) {
          helper.valuation.base_price = parseFloat((basicPriceField.value || '').replace(/[₪,]/g, '')) || 0;
        }
        
        // 2. Update features adjustments - CORRECT FIELD MAPPING
        if (!helper.valuation.adjustments.features) helper.valuation.adjustments.features = {};
        const featuresRows = document.querySelectorAll('#fullFeaturesAdjustmentsList > div');
        if (featuresRows.length > 0) {
          const firstRow = featuresRows[0];
          const inputs = firstRow.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            // Store the description in the correct field
            helper.valuation.adjustments.features.value = inputs[0].value || ''; // UI input goes in value field
            
            // Store percentage as number
            const percentage = parseFloat(inputs[2].value) || 0;
            helper.valuation.adjustments.features.percentage = percentage;
            
            // Store amount without formatting
            const amount = parseFloat((inputs[3].value || '').replace(/[₪,]/g, '')) || 0;
            const type = inputs[1].value || 'plus';
            helper.valuation.adjustments.features.amount = type === 'minus' ? -amount : amount;
            
            // Also store the display value
            helper.valuation.adjustments.features.value = amount.toString();
          }
        }
        
        // 3. Update registration adjustments - CORRECT FIELD MAPPING
        if (!helper.valuation.adjustments.registration) helper.valuation.adjustments.registration = {};
        const registrationRows = document.querySelectorAll('#fullRegistrationAdjustmentsList > div');
        if (registrationRows.length > 0) {
          const firstRow = registrationRows[0];
          const inputs = firstRow.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            // Store description/value correctly
            helper.valuation.adjustments.registration.value = inputs[0].value || ''; // UI input goes in value field
            
            // Store percentage as number
            const percentage = parseFloat(inputs[2].value) || 0;
            helper.valuation.adjustments.registration.percent = percentage;
            
            // Store amount without formatting  
            const amount = parseFloat((inputs[3].value || '').replace(/[₪,]/g, '')) || 0;
            const type = inputs[1].value || 'plus';
            helper.valuation.adjustments.registration.amount = type === 'minus' ? -amount : amount;
          }
        }

        // 4. Update ownership adjustments - CORRECT FIELD MAPPING
        if (!helper.valuation.adjustments.ownership_type) helper.valuation.adjustments.ownership_type = {};
        const ownershipRows = document.querySelectorAll('#ownershipAdjustmentsList > div');
        if (ownershipRows.length > 0) {
          const firstRow = ownershipRows[0];
          const inputs = firstRow.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            helper.valuation.adjustments.ownership_type.value = inputs[0].value || ''; // UI input goes in value field
            
            // Store percentage as number
            const percentage = parseFloat(inputs[2].value) || 0;
            helper.valuation.adjustments.ownership_type.percentage = percentage;
            
            // Store amount without formatting
            const amount = parseFloat((inputs[3].value || '').replace(/[₪,]/g, '')) || 0;
            const type = inputs[1].value || 'plus';
            helper.valuation.adjustments.ownership_type.amount = type === 'minus' ? -amount : amount;
          }
        }

        // 5. Update owners adjustments - CORRECT FIELD MAPPING
        if (!helper.valuation.adjustments.ownership_history) helper.valuation.adjustments.ownership_history = {};
        const ownersRows = document.querySelectorAll('#ownersAdjustmentsList > div');
        if (ownersRows.length > 0) {
          const firstRow = ownersRows[0];
          const inputs = firstRow.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            helper.valuation.adjustments.ownership_history.value = inputs[0].value || ''; // UI input goes in value field
            
            // Store percentage as number
            const percentage = parseFloat(inputs[2].value) || 0;
            helper.valuation.adjustments.ownership_history.percentage = percentage;
            
            // Store amount without formatting
            const amount = parseFloat((inputs[3].value || '').replace(/[₪,]/g, '')) || 0;
            const type = inputs[1].value || 'plus';
            helper.valuation.adjustments.ownership_history.amount = type === 'minus' ? -amount : amount;
          }
        }
        
        console.log('✅ Updated helper from adjustments including ownership_type and ownership_history:', helper.valuation);
        
        // 6. Write GROSS VALUE adjustments back to valuation source AND estimate.adjustments
        updateGrossValueToValuationAndEstimate(helper);

        // 7. Write FULL MARKET VALUE features/registration back to valuation source AND estimate.adjustments
        // NOTE: Full market sync is now handled in specific event listeners to avoid conflicts
        updateFullMarketValueToValuationAndEstimate(helper);
        
        // Save to sessionStorage
        sessionStorage.setItem('helper', JSON.stringify(helper));
        console.log('💾 Helper data saved to sessionStorage');
        
        // Return the updated helper
        return helper;
        
      } catch (error) {
        console.error('❌ Error updating helper from adjustments:', error);
        return helper;
      }
    }


    function saveDepreciationData() {
      console.log('💾 Save depreciation data');
      // Implementation here
    }

    function updateHelperDepreciationField(element, field) {
      console.log('📝 Update depreciation field:', field);
      // Implementation here
    }

    function updateClaimsDataFromField(element, field) {
      console.log('📝 Update claims field:', field);
      // Implementation here
    }

    function updateGrossPercentageFromGrossValue() {
      console.log('📊 Update gross percentage');
      // Implementation here
    }

    function updateGlobalDepreciationCalculation() {
      console.log('📊 Update global depreciation');
      // Implementation here
    }

    function triggerFloatingScreenRefresh() {
      console.log('🔄 Trigger floating screen refresh');
      // Implementation here
    }

    // Immediate cleanup function to clear ownership duplicates from UI and storage
    window.clearOwnershipDuplicatesNow = function() {
      console.log('🚨 EMERGENCY CLEANUP: Clearing ownership duplicates from UI and storage');
      
      // 1. Clear from UI
      const ownershipContainer = document.getElementById('ownershipAdjustmentsList');
      if (ownershipContainer) {
        const allRows = ownershipContainer.querySelectorAll('div');
        console.log(`🗑️ Removing ${allRows.length} ownership rows from UI`);
        allRows.forEach(row => row.remove());
      }

      const registrationContainer = document.getElementById('fullRegistrationAdjustmentsList');
      if (registrationContainer) {
        const allRows = registrationContainer.querySelectorAll('div');
        console.log(`🗑️ Removing ${allRows.length} registration rows from UI`);
        allRows.forEach(row => row.remove());
      }

      const ownersContainer = document.getElementById('ownersAdjustmentsList');
      if (ownersContainer) {
        const allRows = ownersContainer.querySelectorAll('div');
        console.log(`🗑️ Removing ${allRows.length} owners rows from UI`);
        allRows.forEach(row => row.remove());
      }
      
      // 2. Clear from storage
      cleanOwnershipDuplicatesFromStorage();
      
      // 3. Force refresh
      console.log('🔄 Forcing page refresh to apply cleanup');
      location.reload();
    }

    // Function to clean duplicate ownership entries from sessionStorage
    window.cleanOwnershipDuplicatesFromStorage = function() {
      console.log('🧹 Cleaning ownership duplicates from sessionStorage');
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        if (helper.valuation?.adjustments) {
          const adjustments = helper.valuation.adjustments;
          
          // Count ownership-related entries
          const ownershipKeys = Object.keys(adjustments).filter(key => 
            key.toLowerCase().includes('ownership') || key.toLowerCase().includes('owners')
          );
          
          // Count registration-related entries
          const registrationKeys = Object.keys(adjustments).filter(key => 
            key.toLowerCase().includes('registration')
          );
          
          console.log('🔍 Found ownership keys in storage:', ownershipKeys);
          console.log('🔍 Found registration keys in storage:', registrationKeys);
          
          // Clean registration duplicates
          if (adjustments.registration && adjustments.road_registration) {
            console.log('⚠️ Found duplicate registration entries in storage');
            
            // Compare which has more complete data
            const registrationData = adjustments.registration;
            const roadRegistrationData = adjustments.road_registration;
            
            const regHasData = registrationData.percent || registrationData.amount || registrationData.value;
            const roadHasData = roadRegistrationData.percent || roadRegistrationData.amount || roadRegistrationData.value;
            
            if (regHasData && !roadHasData) {
              // Keep registration and remove road_registration
              delete adjustments.road_registration;
              console.log('🗑️ Removed road_registration entry, kept registration');
            } else if (roadHasData && !regHasData) {
              // Keep road_registration and remove registration  
              delete adjustments.registration;
              console.log('🗑️ Removed registration entry, kept road_registration');
            } else if (regHasData && roadHasData) {
              // Keep the one with better data (registration usually better)
              delete adjustments.road_registration;
              console.log('🗑️ Removed road_registration entry, kept registration (both had data)');
            }
          }
          
          // If we have both ownership_type and ownership, keep only the one with more complete data
          if (adjustments.ownership_type && adjustments.ownership) {
            console.log('⚠️ Found duplicate ownership entries in storage');
            
            // Compare which has more complete data
            const ownershipTypeData = adjustments.ownership_type;
            const ownershipData = adjustments.ownership;
            
            const typeHasData = ownershipTypeData.percent || ownershipTypeData.amount || ownershipTypeData.value;
            const ownershipHasData = ownershipData.percent || ownershipData.amount || ownershipData.value;
            
            if (typeHasData && ownershipHasData) {
              // Keep ownership_type and remove ownership
              delete adjustments.ownership;
              console.log('🗑️ Removed duplicate ownership entry, kept ownership_type');
            } else if (ownershipHasData && !typeHasData) {
              // Keep ownership and remove ownership_type  
              delete adjustments.ownership_type;
              console.log('🗑️ Removed duplicate ownership_type entry, kept ownership');
            }
            
            // Save cleaned data back
            sessionStorage.setItem('helper', JSON.stringify(helper));
            console.log('💾 Cleaned ownership data saved to sessionStorage');
          }
        }
      } catch (error) {
        console.error('❌ Error cleaning ownership duplicates:', error);
      }
    }

    window.autoPopulateMarketAdjustments = function(force = false) {
      // Prevent multiple calls unless forced
      if (window.autoPopulatingInProgress && !force) {
        console.log('🚫 Auto-population already in progress, skipping...');
        return;
      }
      
      window.autoPopulatingInProgress = true;
      
      // Reset processing flags
      window.ownershipProcessed = false;
      window.registrationProcessed = false;
      window.ownersProcessed = false;
      console.log('🔄 Reset ownership, registration, and owners processing flags');
      
      // Clean ownership duplicates from storage before proceeding
      cleanOwnershipDuplicatesFromStorage();
      
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      const adjustments = helper.valuation?.adjustments || {};
      
      console.log('🏪 Auto-populating market adjustments from helper.valuation.adjustments');
      console.log('🔍 Available adjustments:', adjustments);
      console.log('🔍 Available adjustment keys:', Object.keys(adjustments));
      
      // Get base price for calculations
      let basePrice = 0;
      const basicPriceField = document.getElementById('basicPrice');
      if (basicPriceField && basicPriceField.value) {
        basePrice = parseFloat(basicPriceField.value.replace(/[₪,]/g, '')) || 0;
      }
      
      // Update fullBasicPrice field
      const fullBasicPriceField = document.getElementById('fullBasicPrice');
      if (fullBasicPriceField) {
        fullBasicPriceField.value = basicPriceField ? basicPriceField.value : '';
      }
      
      console.log('📊 Base price for calculations:', basePrice);
      
      // Clear existing auto-populated adjustments from ALL containers
      const containers = [
        'fullFeaturesAdjustmentsList',
        'fullRegistrationAdjustmentsList', 
        'mileageAdjustmentsList',
        'ownershipAdjustmentsList',
        'ownersAdjustmentsList',
        'allAdjustmentsList'
      ];
      
      containers.forEach(containerId => {
        const container = document.getElementById(containerId);
        if (container) {
          // For ownership, registration, and owners containers, use more aggressive clearing
          if (containerId === 'ownershipAdjustmentsList' || containerId === 'fullRegistrationAdjustmentsList' || containerId === 'ownersAdjustmentsList') {
            console.log(`🎯 Applying aggressive clearing for ${containerId} container`);
            
            // Clear ALL rows in these containers to prevent duplicates
            const allRows = container.querySelectorAll('div');
            console.log(`🧹 Clearing ALL ${allRows.length} rows from ${containerId}`);
            allRows.forEach(row => {
              console.log(`🗑️ Removing row from ${containerId}:`, row);
              row.remove();
            });
          } else {
            // For other containers, only remove auto-populated rows
            const autoRows = container.querySelectorAll('div[data-source="auto"]');
            console.log(`🧹 Clearing ${autoRows.length} auto-populated rows from ${containerId}`);
            autoRows.forEach(row => {
              console.log(`🗑️ Removing auto row:`, row);
              row.remove();
            });
          }
        } else {
          console.log(`⚠️ Container not found: ${containerId}`);
        }
      });
      
      // Process each adjustment type in PRIORITY ORDER to avoid duplicate prevention issues
      const allKeys = Object.keys(adjustments);
      console.log('🔄 All available keys (alphabetical):', allKeys);
      
      // Define priority order - good data sources first
      const priorityKeys = [
        'features',
        'registration', 
        'ownership_history', // Process this BEFORE previous_owners
        'ownership_type',
        'mileage',
        'km',
        // Lower priority / malformed data
        'previous_owners',
        'road_registration'
      ];
      
      // Process priority keys first, then any remaining keys
      const prioritizedKeys = [];
      priorityKeys.forEach(priorityKey => {
        if (allKeys.includes(priorityKey)) {
          prioritizedKeys.push(priorityKey);
        }
      });
      
      // Add any keys not in priority list
      allKeys.forEach(key => {
        if (!prioritizedKeys.includes(key)) {
          prioritizedKeys.push(key);
        }
      });
      
      console.log('🎯 Processing keys in priority order:', prioritizedKeys);
      
      prioritizedKeys.forEach(key => {
        const adjData = adjustments[key];
        console.log(`📝 Processing ${key} adjustment:`, adjData);
        console.log(`📝 adjData type:`, typeof adjData);
        console.log(`📝 adjData properties:`, adjData ? Object.keys(adjData) : 'no properties');
        
        // Special detailed logging for ownership_history
        if (key === 'ownership_history') {
          console.log(`🔍 DETAILED ownership_history data:`, JSON.stringify(adjData, null, 2));
        }
        
        // Handle nested structure (like registration and owners that have date/description properties)
        let value = '';
        let percent = 0;
        let amount = 0;
        
        if (adjData) {
          // Direct values
          if (adjData.value) {
            value = adjData.value;
            console.log(`📝 ${key} - Found direct value:`, value);
          }
          if (adjData.percent !== undefined) {
            // Handle percentage parsing - could be string with % symbol
            const percentStr = String(adjData.percent).replace('%', '').trim();
            percent = parseFloat(percentStr);
            // Don't default to 0 if NaN, keep it as 0 only if it was actually 0
            if (isNaN(percent)) {
              percent = 0;
            }
            console.log(`📝 ${key} - Found direct percent: "${adjData.percent}" → percentStr="${percentStr}" → parsed=${percent}`);
          }
          if (adjData.amount !== undefined) {
            // Handle amount parsing - could be string with currency symbols
            const amountStr = String(adjData.amount).replace(/[₪,\s]/g, '').trim();
            amount = parseFloat(amountStr) || 0;
            console.log(`📝 ${key} - Found direct amount: "${adjData.amount}" → ${amount}`);
          }
          
          // Handle nested structure for registration
          if (key === 'registration' && !value) {
            console.log(`📝 ${key} - Checking nested structure for registration...`);
            if (adjData.date) {
              value = adjData.date;
              console.log(`📝 ${key} - Using date as value:`, value);
            }
            else if (adjData.description) {
              value = adjData.description;
              console.log(`📝 ${key} - Using description as value:`, value);
            }
            else if (typeof adjData === 'string') {
              value = adjData;
              console.log(`📝 ${key} - Using string adjData as value:`, value);
            }
          }
          
          // Handle nested structure for owners  
          if ((key === 'owners' || key === 'ownership_history') && !value) {
            console.log(`📝 ${key} - Checking nested structure for owners/ownership_history...`);
            if (adjData.description) {
              value = adjData.description;
              console.log(`📝 ${key} - Using description as value:`, value);
            }
            else if (adjData.number) {
              value = `${adjData.number} בעלים`;
              console.log(`📝 ${key} - Using number as value:`, value);
            }
            else if (typeof adjData === 'string') {
              value = adjData;
              console.log(`📝 ${key} - Using string adjData as value:`, value);
            }
          }

          // Special handling for ownership_history - if value contains description text, look for number elsewhere
          if (key === 'ownership_history' && value && (value.includes('מספר') || value.includes('בעלים'))) {
            console.log(`📝 ${key} - Value contains description text "${value}", looking for actual number...`);
            
            // Check if there's a number in other fields
            if (adjData.count !== undefined) {
              value = adjData.count;
              console.log(`📝 ${key} - Found count field: ${value}`);
            } else if (adjData.num !== undefined) {
              value = adjData.num;
              console.log(`📝 ${key} - Found num field: ${value}`);
            } else {
              // Try to extract number from any field that might contain it
              const fields = Object.keys(adjData);
              for (let field of fields) {
                const fieldValue = String(adjData[field]);
                // Look for a field that contains just a number (like "02", "2", etc.)
                if (/^\d{1,2}$/.test(fieldValue.trim())) {
                  value = fieldValue.trim();
                  console.log(`📝 ${key} - Found number in ${field} field: ${value}`);
                  break;
                }
              }
            }
          }

          // Handle malformed data like {percentage: "עליה לכביש"} or {percentage: "מספר בעלים"}
          if (!value && !percent && !amount && adjData.percentage && typeof adjData.percentage === 'string') {
            console.log(`📝 ${key} - Found text in percentage field, using as value:`, adjData.percentage);
            value = adjData.percentage;
          }
        }
        
        console.log(`   🎯 FINAL EXTRACTION - Key: ${key}, Value: "${value}", Percent: ${percent}, Amount: ${amount}`);
        console.log(`   ✅ Condition check (value || percent || amount):`, !!(value || percent || amount));
        console.log(`   🔍 adjData exists:`, !!adjData);
        console.log(`   🔍 Individual checks: value="${value}", percent=${percent}, amount=${amount}`);
        
        if (adjData && (value || percent || amount)) {
          let containerId = null;
          let addFunction = null;
          
          // Special handling for ownership entries - prevent duplicates  
          // BUT BE SPECIFIC: ownership_type goes to different section than ownership_history
          const isOwnershipButNotType = key.toLowerCase().includes('ownership') && !key.toLowerCase().includes('ownership_type');
          if (isOwnershipButNotType) {
            console.log(`🎯 Processing ownership (non-type) entry: ${key}`);
            
            // Check if we already processed an ownership entry
            if (window.ownershipProcessed) {
              console.log(`🚫 Skipping duplicate ownership entry: ${key} (already processed ownership)`);
              return; // Skip this entry to prevent duplicates
            }
            
            // Mark that we've processed an ownership entry
            window.ownershipProcessed = true;
            console.log(`✅ Marked ownership as processed for: ${key}`);
          }

          // Special handling for registration entries - prevent duplicates
          const isRegistration = key.toLowerCase().includes('registration');
          if (isRegistration) {
            console.log(`🎯 Processing registration entry: ${key}`);
            
            // Check if we already processed a registration entry
            if (window.registrationProcessed) {
              console.log(`🚫 Skipping duplicate registration entry: ${key} (already processed registration)`);
              return; // Skip this entry to prevent duplicates
            }
            
            // Mark that we've processed a registration entry
            window.registrationProcessed = true;
            console.log(`✅ Marked registration as processed for: ${key}`);
          }

          // Special handling for owners entries - prevent duplicates
          // Be more specific - only keys that map to ownersAdjustmentsList
          const ownersKeys = ['owners', 'num_owners', 'number_of_owners', 'numberofowners', 'number of owners', 'מספר בעלים', 'previous_owners', 'ownership_history'];
          const isOwners = ownersKeys.includes(key.toLowerCase());
          if (isOwners) {
            console.log(`🎯 Processing owners entry: ${key}`);
            
            // Check if we already processed an owners entry
            if (window.ownersProcessed) {
              console.log(`🚫 Skipping duplicate owners entry: ${key} (already processed owners)`);
              return; // Skip this entry to prevent duplicates
            }
            
            // PRIORITY LOGIC: Skip previous_owners if ownership_history exists with better data
            if (key === 'previous_owners' && adjustments.ownership_history) {
              const ownershipHistoryData = adjustments.ownership_history;
              if (ownershipHistoryData.percent || ownershipHistoryData.amount || ownershipHistoryData.value) {
                console.log(`🚫 Skipping previous_owners because ownership_history has better data`);
                return; // Skip previous_owners in favor of ownership_history
              }
            }
            
            // Mark that we've processed an owners entry
            window.ownersProcessed = true;
            console.log(`✅ Marked owners as processed for: ${key}`);
          }
          
          // Map adjustment types to containers and functions
          console.log(`🎯 Mapping key "${key}" to container...`);
          switch(key.toLowerCase()) {
            case 'features':
            case 'feature':
              containerId = 'fullFeaturesAdjustmentsList';
              addFunction = addFullFeaturesAdjustment;
              console.log(`✅ MATCHED FEATURES CASE: ${key} → ${containerId}`);
              break;
            case 'registration':
            case 'registration_date':
            case 'registrationdate':
            case 'registration date':
            case 'road_registration':
              containerId = 'fullRegistrationAdjustmentsList';
              addFunction = addFullRegistrationAdjustment;
              console.log(`✅ MATCHED REGISTRATION CASE: ${key} → ${containerId}`);
              break;
            case 'mileage':
            case 'km':
            case 'kilometers':
              containerId = 'mileageAdjustmentsList';
              addFunction = addMileageAdjustment;
              console.log(`✅ MATCHED MILEAGE CASE: ${key} → ${containerId}`);
              break;
            case 'ownership':
            case 'ownership_type':
              containerId = 'ownershipAdjustmentsList';
              addFunction = addOwnershipAdjustment;
              console.log(`✅ MATCHED OWNERSHIP CASE: ${key} → ${containerId}`);
              break;
            case 'owners':
            case 'num_owners':
            case 'number_of_owners':
            case 'numberofowners':
            case 'number of owners':
            case 'מספר בעלים':
            case 'previous_owners':
            case 'ownership_history':
              containerId = 'ownersAdjustmentsList';
              addFunction = addOwnersAdjustment;
              console.log(`✅ MATCHED OWNERS CASE: ${key} → ${containerId}`);
              break;
            default:
              // Any other adjustments go to additional adjustments
              containerId = 'allAdjustmentsList';
              addFunction = addFullMarketAdjustment;
              console.log(`⚠️ MATCHED DEFAULT CASE: ${key} → ${containerId} (התאמות שוק נוספות)`);
              break;
          }
          
          if (containerId && addFunction) {
            // Add the adjustment row
            addFunction();
            
            // Get the last added row
            const container = document.getElementById(containerId);
            const lastRow = container.querySelector('div.adjustment-row:last-child');
            
            if (lastRow) {
              // Mark as auto-populated
              lastRow.setAttribute('data-source', 'auto');
              
              const inputs = lastRow.querySelectorAll('input, select');
              if (inputs.length >= 4) {
                // FIELD POPULATION LOGIC:
                
                // EXACT COPY FROM FINAL REPORT FOR ALL FIELDS:
                
                // Extract percentage
                let percent = 0;
                if (adjData.percent) {
                  const percentStr = String(adjData.percent).replace(/[%\s]/g, '');
                  percent = parseFloat(percentStr) || 0;
                } else if (adjData.percentage) {
                  const percentStr = String(adjData.percentage).replace(/[%\s]/g, '');
                  percent = parseFloat(percentStr) || 0;
                }
                
                // Extract amount
                let amount = 0;
                if (adjData.amount) {
                  const amountStr = String(adjData.amount).replace(/[₪,\sש]/g, '');
                  amount = parseFloat(amountStr) || 0;
                }
                
                // CRITICAL: Description comes from .value field
                const description = adjData.value || adjData.description || '';
                
                // Determine if reduction
                const isReduction = percent < 0 || amount < 0;
                
                // Field 1: תיאור (Description) - from adjData.value
                inputs[0].value = description;
                
                // Field 2: סוג (Type) - plus/minus based on sign
                inputs[1].value = isReduction ? 'minus' : 'plus';
                
                // Field 3: אחוז (Percentage) - from adjData.percent/percentage
                if (percent !== 0) {
                  inputs[2].value = percent.toString();
                }
                
                // Field 4: ערך (Value) - CALCULATE LOCALLY using Final Report logic
                if (percent !== 0 && basePrice > 0) {
                  let calculatedAmount = 0;
                  
                  // Different calculation methods by adjustment type (EXACT Final Report logic)
                  if (containerId === 'fullFeaturesAdjustmentsList') {
                    // Features: Use BASE price for calculation
                    calculatedAmount = (basePrice * Math.abs(percent)) / 100;
                  } else if (containerId === 'fullRegistrationAdjustmentsList') {
                    // Registration: Fixed amount (not percentage), skip calculation here
                    calculatedAmount = 0; // Will be handled separately
                  } else {
                    // KM, Ownership, Owners: Will be calculated by the cumulative function
                    // Mark for later calculation with proper cumulative values
                    calculatedAmount = 0; // Placeholder, will be updated by calculateMarketValueAmounts()
                  }
                  
                  // Apply correct sign and format
                  inputs[3].value = `₪${Math.round(calculatedAmount).toLocaleString()}`;
                  
                  console.log(`🧮 CALCULATED ${containerId}: ${percent}% of base ${basePrice} = ₪${Math.round(calculatedAmount)}`);
                } else if (adjData.amount && adjData.amount !== '₪ 0') {
                  // Fallback: Use helper amount only if no percentage available
                  const amount = parseFloat(String(adjData.amount).replace(/[₪,\s]/g, '')) || 0;
                  if (amount !== 0) {
                    inputs[3].value = amount < 0 ? 
                      `-₪${Math.abs(amount).toLocaleString()}` : 
                      `₪${amount.toLocaleString()}`;
                  }
                }
                
                console.log(`📝 Final Report Logic - ${containerId}: desc="${inputs[0].value}", type="${inputs[1].value}", percent="${inputs[2].value}", amount="${inputs[3].value}"`);
                console.log(`📝 Data used: adjData.value="${adjData.value}", adjData.percent="${adjData.percent}", adjData.amount="${adjData.amount}"`);
                
              }
            }
          }
        } else {
          console.log(`⚠️ No valid data for ${key}:`, adjData);
        }
      });
      
      // Calculate ערך amounts with cumulative logic first
      if (typeof calculateMarketValueAmounts === 'function') {
        setTimeout(() => {
          calculateMarketValueAmounts();
          console.log('✅ Market value amounts calculated with cumulative logic');
        }, 50);
      }
      
      // Then trigger main calculation
      if (typeof updateFullMarketValueCalculation === 'function') {
        setTimeout(() => {
          updateFullMarketValueCalculation();
          console.log('✅ Full market value calculation triggered after auto-population');
        }, 100);
      }
      
      console.log('✅ Market adjustments auto-population completed from helper.valuation.adjustments');
      
      // Reset all flags
      window.autoPopulatingInProgress = false;
      window.ownershipProcessed = false;
      window.registrationProcessed = false;
      window.ownersProcessed = false;
      console.log('🔄 Reset all processing flags');
    }

    // ============ FULL MARKET VALUE CALCULATION FUNCTIONS ============
    
    // COPIED FROM FINAL REPORT: Calculate ערך fields with cumulative logic
    window.calculateMarketValueAmounts = function() {
      console.log('🧮 Starting market value amount calculations...');
      
      // Get base price
      let basicPrice = 0;
      const basicPriceField = document.getElementById('basicPrice');
      if (basicPriceField?.value) {
        basicPrice = parseFloat(basicPriceField.value.replace(/[₪,]/g, '')) || 0;
      }
      
      if (basicPrice === 0) {
        console.log('⚠️ No base price available for calculations');
        return;
      }
      
      console.log('🏠 Base price for calculations:', basicPrice);
      let currentValue = basicPrice;
      
      // 1. Features: Calculate from base price
      const featuresRows = document.querySelectorAll('#fullFeaturesAdjustmentsList > div');
      featuresRows.forEach(row => {
        const inputs = row.querySelectorAll('input, select');
        if (inputs.length >= 4) {
          const type = inputs[1].value; // סוג field
          const percentInput = inputs[2]; // אחוז field
          const valueInput = inputs[3]; // ערך field
          
          const percent = parseFloat(percentInput.value) || 0;
          if (percent !== 0) {
            const adjustment = basicPrice * (Math.abs(percent) / 100);
            const signedAdjustment = (type === 'minus') ? -adjustment : adjustment;
            currentValue += signedAdjustment;
            
            // Update ערך field with calculated amount - show negative if type is minus
            const displayValue = (type === 'minus') ? `-₪${Math.round(adjustment).toLocaleString()}` : `₪${Math.round(adjustment).toLocaleString()}`;
            valueInput.value = displayValue;
            console.log(`🏗️ Features: ${percent}% of ₪${basicPrice} = ${displayValue}, cumulative: ₪${Math.round(currentValue)}`);
          }
        }
      });
      
      // 2. Registration: Add fixed amounts to cumulative  
      const registrationRows = document.querySelectorAll('#fullRegistrationAdjustmentsList > div');
      registrationRows.forEach(row => {
        const inputs = row.querySelectorAll('input, select');
        if (inputs.length >= 4) {
          const type = inputs[1].value;
          const valueInput = inputs[3];
          
          if (valueInput.value) {
            const value = parseFloat(valueInput.value.replace(/[₪,]/g, '')) || 0;
            const signedValue = (type === 'minus') ? -value : value;
            currentValue += signedValue;
            console.log(`🏛️ Registration: ₪${value}, cumulative: ₪${Math.round(currentValue)}`);
          }
        }
      });
      
      // 3. Mileage: Calculate from previous cumulative
      const mileageRows = document.querySelectorAll('#mileageAdjustmentsList > div');
      mileageRows.forEach(row => {
        const inputs = row.querySelectorAll('input, select');
        if (inputs.length >= 4) {
          const type = inputs[1].value;
          const percentInput = inputs[2];
          const valueInput = inputs[3];
          
          const percent = parseFloat(percentInput.value) || 0;
          if (percent !== 0) {
            const previousCumulative = currentValue;
            const specificResult = previousCumulative * (Math.abs(percent) / 100);
            
            if (type === 'minus') {
              currentValue = previousCumulative - specificResult;
            } else {
              currentValue = previousCumulative + specificResult;
            }
            
            // Update ערך field with calculated amount - show negative if type is minus
            const displayValue = (type === 'minus') ? `-₪${Math.round(specificResult).toLocaleString()}` : `₪${Math.round(specificResult).toLocaleString()}`;
            valueInput.value = displayValue;
            console.log(`🏃 Mileage: ${percent}% of ₪${Math.round(previousCumulative)} = ${displayValue}, cumulative: ₪${Math.round(currentValue)}`);
          }
        }
      });
      
      // 4. Ownership: Calculate from previous cumulative
      const ownershipRows = document.querySelectorAll('#ownershipAdjustmentsList > div');
      ownershipRows.forEach(row => {
        const inputs = row.querySelectorAll('input, select');
        if (inputs.length >= 4) {
          const type = inputs[1].value;
          const percentInput = inputs[2];
          const valueInput = inputs[3];
          
          const percent = parseFloat(percentInput.value) || 0;
          if (percent !== 0) {
            const previousCumulative = currentValue;
            const specificResult = previousCumulative * (Math.abs(percent) / 100);
            
            if (type === 'minus') {
              currentValue = previousCumulative - specificResult;
            } else {
              currentValue = previousCumulative + specificResult;
            }
            
            // Update ערך field with calculated amount - show negative if type is minus
            const displayValue = (type === 'minus') ? `-₪${Math.round(specificResult).toLocaleString()}` : `₪${Math.round(specificResult).toLocaleString()}`;
            valueInput.value = displayValue;
            console.log(`🏢 Ownership: ${percent}% of ₪${Math.round(previousCumulative)} = ${displayValue}, cumulative: ₪${Math.round(currentValue)}`);
          }
        }
      });
      
      // 5. Owners: Calculate from previous cumulative
      const ownersRows = document.querySelectorAll('#ownersAdjustmentsList > div');
      ownersRows.forEach(row => {
        const inputs = row.querySelectorAll('input, select');
        if (inputs.length >= 4) {
          const type = inputs[1].value;
          const percentInput = inputs[2];
          const valueInput = inputs[3];
          
          const percent = parseFloat(percentInput.value) || 0;
          if (percent !== 0) {
            const previousCumulative = currentValue;
            const specificResult = previousCumulative * (Math.abs(percent) / 100);
            
            if (type === 'minus') {
              currentValue = previousCumulative - specificResult;
            } else {
              currentValue = previousCumulative + specificResult;
            }
            
            // Update ערך field with calculated amount - show negative if type is minus
            const displayValue = (type === 'minus') ? `-₪${Math.round(specificResult).toLocaleString()}` : `₪${Math.round(specificResult).toLocaleString()}`;
            valueInput.value = displayValue;
            console.log(`👥 Owners: ${percent}% of ₪${Math.round(previousCumulative)} = ${displayValue}, cumulative: ₪${Math.round(currentValue)}`);
          }
        }
      });
      
      console.log(`✅ Final cumulative value: ₪${Math.round(currentValue)}`);
      return currentValue;
    }

    // GROSS VALUE AMOUNTS CALCULATION (Features & Registration only)
    window.calculateGrossValueAmounts = function() {
      console.log('🧮 Starting gross value amount calculations...');
      
      // Get base price
      let basicPrice = 0;
      const basicPriceField = document.getElementById('basicPrice');
      if (basicPriceField?.value) {
        basicPrice = parseFloat(basicPriceField.value.replace(/[₪,]/g, '')) || 0;
      }
      
      if (basicPrice === 0) {
        console.log('⚠️ No base price available for gross value calculations');
        return;
      }
      
      console.log('🏠 Base price for gross value calculations:', basicPrice);
      
      // 1. Features: Calculate from base price (same logic as full market value)
      const featuresRows = document.querySelectorAll('#featuresAdjustmentsList > div');
      featuresRows.forEach(row => {
        const inputs = row.querySelectorAll('input, select');
        if (inputs.length >= 4) {
          const type = inputs[1].value; // סוג field
          const percentInput = inputs[2]; // אחוז field
          const valueInput = inputs[3]; // ערך field
          
          const percent = parseFloat(percentInput.value) || 0;
          if (percent !== 0) {
            const adjustment = basicPrice * (Math.abs(percent) / 100);
            
            // Update ערך field with calculated amount - show negative if type is minus
            const displayValue = (type === 'minus') ? `-₪${Math.round(adjustment).toLocaleString()}` : `₪${Math.round(adjustment).toLocaleString()}`;
            valueInput.value = displayValue;
            console.log(`🏗️ Gross Features: ${percent}% of ₪${basicPrice} = ${displayValue}`);
          }
        }
      });
      
      // 2. Registration: Fixed amounts (no percentage calculation needed - display as is)
      const registrationRows = document.querySelectorAll('#registrationAdjustmentsList > div');
      registrationRows.forEach(row => {
        const inputs = row.querySelectorAll('input, select');
        if (inputs.length >= 4) {
          const valueInput = inputs[3];
          if (valueInput.value) {
            console.log(`🏛️ Gross Registration: ${valueInput.value} (fixed amount)`);
          }
        }
      });
      
      console.log('✅ Gross value amounts calculated');
    }

    // Auto-populate gross value adjustments from valuation.adjustments
    window.autoPopulateGrossValueAdjustments = function() {
      try {
        console.log('🏪 Auto-populating gross value adjustments from helper.valuation.adjustments');
        
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        const adjustments = helper.valuation?.adjustments || {};
        
        console.log('🔍 Available adjustments for gross value:', adjustments);
        
        // Clear existing adjustments
        const featuresContainer = document.getElementById('featuresAdjustmentsList');
        const registrationContainer = document.getElementById('registrationAdjustmentsList');
        if (featuresContainer) featuresContainer.innerHTML = '';
        if (registrationContainer) registrationContainer.innerHTML = '';
        
        // Get base price for calculations
        let basePrice = 0;
        const basicPriceField = document.getElementById('basicPrice');
        if (basicPriceField && basicPriceField.value) {
          basePrice = parseFloat(basicPriceField.value.replace(/[₪,]/g, '')) || 0;
        }
        
        // 1. Auto-populate FEATURES from valuation.adjustments.features
        if (adjustments.features) {
          console.log('📝 Loading features from valuation.adjustments.features:', adjustments.features);
          
          // Add features row
          if (typeof addFeatureAdjustment === 'function') {
            addFeatureAdjustment();
            const featuresRows = document.querySelectorAll('#featuresAdjustmentsList > div');
            const lastRow = featuresRows[featuresRows.length - 1];
            if (lastRow) {
              const inputs = lastRow.querySelectorAll('input, select');
              if (inputs.length >= 4) {
                inputs[0].value = adjustments.features.value || adjustments.features.description || '';
                inputs[1].value = adjustments.features.amount >= 0 ? 'plus' : 'minus';
                inputs[2].value = adjustments.features.percentage || '';
                
                // Calculate ערך locally if percentage exists
                if (adjustments.features.percentage && basePrice > 0) {
                  const percent = Math.abs(adjustments.features.percentage);
                  const calculatedAmount = (basePrice * percent) / 100;
                  const displayValue = adjustments.features.amount < 0 ? 
                    `-₪${Math.round(calculatedAmount).toLocaleString()}` : 
                    `₪${Math.round(calculatedAmount).toLocaleString()}`;
                  inputs[3].value = displayValue;
                } else if (adjustments.features.amount) {
                  // Use amount from helper
                  const amount = Math.abs(adjustments.features.amount);
                  const displayValue = adjustments.features.amount < 0 ? 
                    `-₪${amount.toLocaleString()}` : 
                    `₪${amount.toLocaleString()}`;
                  inputs[3].value = displayValue;
                }
              }
            }
          }
        }
        
        // 2. Auto-populate REGISTRATION from valuation.adjustments.registration
        if (adjustments.registration) {
          console.log('📅 Loading registration from valuation.adjustments.registration:', adjustments.registration);
          
          // Add registration row
          if (typeof addRegistrationAdjustment === 'function') {
            addRegistrationAdjustment();
            const registrationRows = document.querySelectorAll('#registrationAdjustmentsList > div');
            const lastRow = registrationRows[registrationRows.length - 1];
            if (lastRow) {
              const inputs = lastRow.querySelectorAll('input, select');
              if (inputs.length >= 4) {
                inputs[0].value = adjustments.registration.value || adjustments.registration.description || '';
                inputs[1].value = adjustments.registration.amount >= 0 ? 'plus' : 'minus';
                inputs[2].value = adjustments.registration.percent || adjustments.registration.percentage || '';
                
                // Registration uses fixed amounts (not calculated)
                if (adjustments.registration.amount) {
                  const amount = Math.abs(adjustments.registration.amount);
                  const displayValue = adjustments.registration.amount < 0 ? 
                    `-₪${amount.toLocaleString()}` : 
                    `₪${amount.toLocaleString()}`;
                  inputs[3].value = displayValue;
                }
              }
            }
          }
        }
        
        // Trigger calculations after populating
        setTimeout(() => {
          if (typeof calculateGrossValueAmounts === 'function') {
            calculateGrossValueAmounts();
          }
          if (typeof updateGrossMarketValueCalculation === 'function') {
            updateGrossMarketValueCalculation();
          }
          console.log('✅ Gross value auto-population completed');
        }, 100);
        
      } catch (error) {
        console.error('❌ Error in autoPopulateGrossValueAdjustments:', error);
      }
    }

    // ============ FULL MARKET VALUE CALCULATION FUNCTIONS ============
    
    // Update full market value calculation with cumulative logic
    window.updateFullMarketValueCalculation = function() {
      try {
        console.log('🧮 Starting full market value calculation...');
        
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        // Get base price
        let basePrice = 0;
        const basicPriceField = document.getElementById('basicPrice');
        const fullBasicPriceField = document.getElementById('fullBasicPrice');
        
        if (basicPriceField && basicPriceField.value) {
          basePrice = parseFloat(basicPriceField.value.replace(/[₪,]/g, '')) || 0;
        }
        
        // Update full basic price field
        if (fullBasicPriceField) {
          fullBasicPriceField.value = basePrice > 0 ? `₪${basePrice.toLocaleString()}` : '';
        }
        
        console.log('📊 Base price:', basePrice);
        
        if (basePrice === 0) {
          console.warn('⚠️ No base price found for calculations');
          return;
        }
        
        let currentValue = basePrice;
        
        // 1. Features Adjustments (calculate from base price)
        const featuresRows = document.querySelectorAll('#fullFeaturesAdjustmentsList > div');
        featuresRows.forEach(row => {
          const inputs = row.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const type = inputs[1].value;
            const percent = parseFloat(inputs[2].value) || 0;
            let value = parseFloat(inputs[3].value.replace(/[₪,]/g, '')) || 0;
            
            if (percent && !value) {
              value = (basePrice * Math.abs(percent)) / 100;
              inputs[3].value = `₪${Math.round(value).toLocaleString()}`;
            }
            
            if (type === 'plus') {
              currentValue += Math.abs(value);
            } else {
              currentValue -= Math.abs(value);
            }
          }
        });
        
        // Update features cumulative
        const featuresCumulative = document.querySelector('#featuresCumulative span');
        if (featuresCumulative) {
          featuresCumulative.textContent = `₪${Math.round(currentValue).toLocaleString()}`;
        }
        
        // 2. Registration Adjustments (calculate from base price)
        const registrationRows = document.querySelectorAll('#fullRegistrationAdjustmentsList > div');
        registrationRows.forEach(row => {
          const inputs = row.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const type = inputs[1].value;
            const percent = parseFloat(inputs[2].value) || 0;
            let value = parseFloat(inputs[3].value.replace(/[₪,]/g, '')) || 0;
            
            if (percent && !value) {
              value = (basePrice * Math.abs(percent)) / 100;
              inputs[3].value = `₪${Math.round(value).toLocaleString()}`;
            }
            
            if (type === 'plus') {
              currentValue += Math.abs(value);
            } else {
              currentValue -= Math.abs(value);
            }
          }
        });
        
        // Update registration cumulative
        const registrationCumulative = document.querySelector('#registrationCumulative span');
        if (registrationCumulative) {
          registrationCumulative.textContent = `₪${Math.round(currentValue).toLocaleString()}`;
        }
        
        // 3. Mileage Adjustments (calculate from cumulative)
        const mileageRows = document.querySelectorAll('#mileageAdjustmentsList > div');
        mileageRows.forEach(row => {
          const inputs = row.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const type = inputs[1].value;
            const percent = parseFloat(inputs[2].value) || 0;
            let value = parseFloat(inputs[3].value.replace(/[₪,]/g, '')) || 0;
            
            if (percent && !value) {
              value = (currentValue * Math.abs(percent)) / 100;
              inputs[3].value = `₪${Math.round(value).toLocaleString()}`;
            }
            
            if (type === 'plus') {
              currentValue += Math.abs(value);
            } else {
              currentValue -= Math.abs(value);
            }
          }
        });
        
        // Update mileage cumulative
        const mileageCumulative = document.querySelector('#mileageCumulative span');
        if (mileageCumulative) {
          mileageCumulative.textContent = `₪${Math.round(currentValue).toLocaleString()}`;
          mileageCumulative.style.color = currentValue < basePrice ? '#dc3545' : '#28a745';
        }
        
        // 4. Ownership Type Adjustments (calculate from cumulative)
        const ownershipRows = document.querySelectorAll('#ownershipAdjustmentsList > div');
        ownershipRows.forEach(row => {
          const inputs = row.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const type = inputs[1].value;
            const percent = parseFloat(inputs[2].value) || 0;
            let value = parseFloat(inputs[3].value.replace(/[₪,]/g, '')) || 0;
            
            if (percent && !value) {
              value = (currentValue * Math.abs(percent)) / 100;
              inputs[3].value = `₪${Math.round(value).toLocaleString()}`;
            }
            
            if (type === 'plus') {
              currentValue += Math.abs(value);
            } else {
              currentValue -= Math.abs(value);
            }
          }
        });
        
        // Update ownership cumulative
        const ownershipCumulative = document.querySelector('#ownershipCumulative span');
        if (ownershipCumulative) {
          ownershipCumulative.textContent = `₪${Math.round(currentValue).toLocaleString()}`;
          ownershipCumulative.style.color = currentValue < basePrice ? '#dc3545' : '#28a745';
        }
        
        // 5. Number of Owners Adjustments (calculate from cumulative)
        const ownersRows = document.querySelectorAll('#ownersAdjustmentsList > div');
        ownersRows.forEach(row => {
          const inputs = row.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const type = inputs[1].value;
            const percent = parseFloat(inputs[2].value) || 0;
            let value = parseFloat(inputs[3].value.replace(/[₪,]/g, '')) || 0;
            
            if (percent && !value) {
              value = (currentValue * Math.abs(percent)) / 100;
              inputs[3].value = `₪${Math.round(value).toLocaleString()}`;
            }
            
            if (type === 'plus') {
              currentValue += Math.abs(value);
            } else {
              currentValue -= Math.abs(value);
            }
          }
        });
        
        // Update owners cumulative
        const ownersCumulative = document.querySelector('#ownersCumulative span');
        if (ownersCumulative) {
          ownersCumulative.textContent = `₪${Math.round(currentValue).toLocaleString()}`;
          ownersCumulative.style.color = currentValue < basePrice ? '#dc3545' : '#28a745';
        }
        
        // 6. Additional Market Adjustments (calculate from base price)
        const additionalRows = document.querySelectorAll('#allAdjustmentsList > div');
        additionalRows.forEach(row => {
          const inputs = row.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const type = inputs[1].value;
            const percent = parseFloat(inputs[2].value) || 0;
            let value = parseFloat(inputs[3].value.replace(/[₪,]/g, '')) || 0;
            
            if (percent && !value) {
              value = (basePrice * Math.abs(percent)) / 100;
              inputs[3].value = `₪${Math.round(value).toLocaleString()}`;
            }
            
            if (type === 'plus') {
              currentValue += Math.abs(value);
            } else {
              currentValue -= Math.abs(value);
            }
          }
        });
        
        // Update final result
        const fullMarketValueResult = document.getElementById('fullMarketValueResult');
        if (fullMarketValueResult) {
          fullMarketValueResult.value = `₪${Math.round(currentValue).toLocaleString()}`;
        }
        
        // Legacy field update for compatibility
        const fullMarketValueField = document.getElementById('fullMarketValueField');
        if (fullMarketValueField) {
          fullMarketValueField.value = `₪${Math.round(currentValue).toLocaleString()}`;
        }
        
        console.log('✅ Full market value calculation completed:', currentValue);
        
      } catch (error) {
        console.error('❌ Error in updateFullMarketValueCalculation:', error);
      }
    }
    
    // Calculate adjustment value from percentage
    window.calculateAdjustmentValueSimple = function(percentInput) {
      const row = percentInput.closest('div');
      if (!row) return;
      
      const inputs = row.querySelectorAll('input, select');
      if (inputs.length < 4) return;
      
      const percent = parseFloat(percentInput.value) || 0;
      
      // Determine which section this adjustment belongs to
      const isCumulative = row.closest('#mileageAdjustmentsList') || 
                          row.closest('#ownershipAdjustmentsList') || 
                          row.closest('#ownersAdjustmentsList');
      
      let referenceValue = 0;
      
      if (isCumulative) {
        // For cumulative sections, get the previous cumulative value
        const section = row.closest('div[id$="Adjustments"]');
        if (section) {
          const prevSection = section.previousElementSibling;
          if (prevSection) {
            const cumulativeSpan = prevSection.querySelector('div[id$="Cumulative"] span');
            if (cumulativeSpan) {
              referenceValue = parseFloat(cumulativeSpan.textContent.replace(/[₪,]/g, '')) || 0;
            }
          }
        }
        
        // If no previous cumulative, use registration cumulative as fallback
        if (referenceValue === 0) {
          const registrationCumulative = document.querySelector('#registrationCumulative span');
          if (registrationCumulative) {
            referenceValue = parseFloat(registrationCumulative.textContent.replace(/[₪,]/g, '')) || 0;
          }
        }
      } else {
        // For non-cumulative sections, use base price
        const basicPrice = document.getElementById('basicPrice');
        if (basicPrice && basicPrice.value) {
          referenceValue = parseFloat(basicPrice.value.replace(/[₪,]/g, '')) || 0;
        }
      }
      
      if (referenceValue > 0 && percent !== 0) {
        const calculatedValue = (referenceValue * Math.abs(percent)) / 100;
        inputs[3].value = `₪${Math.round(calculatedValue).toLocaleString()}`;
      } else {
        inputs[3].value = '';
      }
    }
    
    // Remove adjustment row - SIMPLIFIED VERSION
    window.removeAdjustmentRow = function(rowId) {
      console.log('🗑️ SIMPLE DELETE: Removing row:', rowId);
      
      const row = document.getElementById(rowId);
      if (!row) {
        console.log('❌ Row not found:', rowId);
        return;
      }
      
      // Determine category from container
      const container = row.parentElement;
      const rowIndex = Array.from(container.children).indexOf(row);
      
      let category = '';
      if (container.id === 'fullFeaturesAdjustmentsList' || container.id === 'featuresAdjustmentsList') category = 'features';
      else if (container.id === 'fullRegistrationAdjustmentsList' || container.id === 'registrationAdjustmentsList') category = 'registration';
      else if (container.id === 'mileageAdjustmentsList') category = 'mileage';
      else if (container.id === 'ownershipAdjustmentsList') category = 'ownership_type';
      else if (container.id === 'ownersAdjustmentsList') category = 'ownership_history';
      else if (container.id === 'allAdjustmentsList') category = 'additional';
      
      console.log(`🎯 Category: ${category}, Row Index: ${rowIndex}`);
      
      // Remove from UI first
      row.remove();
      
      // Update helper data - REBUILD FROM CURRENT UI STATE
      let helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Ensure all structures exist
      if (!helper.valuation) helper.valuation = {};
      if (!helper.valuation.adjustments) helper.valuation.adjustments = {};
      if (!helper.estimate) helper.estimate = {};
      if (!helper.estimate.adjustments) helper.estimate.adjustments = {};
      
      // Rebuild this category's array from remaining UI rows
      const remainingRows = Array.from(container.children);
      helper.estimate.adjustments[category] = [];
      
      remainingRows.forEach((remainingRow, index) => {
        const inputs = remainingRow.querySelectorAll('input, select');
        if (inputs.length >= 4) {
          const item = {
            value: inputs[0].value || '',
            type: inputs[1].value || 'plus',
            percentage: parseFloat(inputs[2].value) || 0,
            percent: parseFloat(inputs[2].value) || 0, // Backward compatibility
            amount_display: inputs[3].value || '',
            amount: parseFloat((inputs[3].value || '').replace(/[₪,-]/g, '')) || 0,
            source: 'manual',
            timestamp: new Date().toISOString()
          };
          
          // Apply sign based on type
          if (item.type === 'minus') {
            item.percentage = -Math.abs(item.percentage);
            item.percent = -Math.abs(item.percent);
            item.amount = -Math.abs(item.amount);
          }
          
          // Calculate amount from percentage if needed
          if (item.percentage && !item.amount) {
            const baseValue = parseFloat(helper.estimate?.market_value_base) || 0;
            if (baseValue > 0) {
              const amount = Math.round((baseValue * Math.abs(item.percentage)) / 100);
              item.amount = item.type === 'minus' ? -amount : amount;
            }
          }
          
          helper.estimate.adjustments[category].push(item);
        }
      });
      
      // Update valuation.adjustments with first item (if any) 
      if (helper.estimate.adjustments[category].length > 0) {
        if (!helper.valuation) helper.valuation = {};
        if (!helper.valuation.adjustments) helper.valuation.adjustments = {};
        helper.valuation.adjustments[category] = helper.estimate.adjustments[category][0];
      } else {
        // Clear valuation if no items remain
        if (helper.valuation?.adjustments?.[category]) {
          delete helper.valuation.adjustments[category];
        }
      }
      
      console.log(`✅ Rebuilt ${category}: ${helper.estimate.adjustments[category].length} items remaining`);
      console.log(`📊 Updated valuation.adjustments.${category}:`, helper.valuation.adjustments[category]);
      
      // For features and registration, also update gross_value_adjustments and sync UI sections
      if (category === 'features' || category === 'registration') {
        // Ensure gross_value_adjustments exists
        if (!helper.estimate.gross_value_adjustments) helper.estimate.gross_value_adjustments = {};
        
        // Update gross_value_adjustments with same data
        helper.estimate.gross_value_adjustments[category] = helper.estimate.adjustments[category];
        
        // Determine which section was deleted from and sync the other section
        const isFromGrossSection = container.id.includes('registration') ? 
          container.id === 'registrationAdjustmentsList' : 
          container.id === 'featuresAdjustmentsList';
        
        if (isFromGrossSection) {
          // Deleted from gross section -> sync to full market section
          const targetContainerId = category === 'features' ? 'fullFeaturesAdjustmentsList' : 'fullRegistrationAdjustmentsList';
          syncUISection(targetContainerId, helper.estimate.adjustments[category]);
        } else {
          // Deleted from full market section -> sync to gross section
          const targetContainerId = category === 'features' ? 'featuresAdjustmentsList' : 'registrationAdjustmentsList';
          syncUISection(targetContainerId, helper.estimate.adjustments[category]);
        }
        
        console.log(`🔄 Synced deletion between gross and full market sections for ${category}`);
      }
      
      // Save and recalculate
      sessionStorage.setItem('helper', JSON.stringify(helper));
      updateFullMarketValueCalculation();
    }
    
    // Sync adjustment to helper - REBUILD ENTIRE CATEGORY FROM ALL UI ROWS
    window.syncAdjustmentToHelper = function(element, category) {
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        // Ensure structures exist
        if (!helper.valuation) helper.valuation = {};
        if (!helper.valuation.adjustments) helper.valuation.adjustments = {};
        if (!helper.estimate) helper.estimate = {};
        if (!helper.estimate.adjustments) helper.estimate.adjustments = {};
        
        // Map category to container ID - Check both full market and gross containers
        let containerId = '';
        if (category === 'features') {
          // Check if element is from gross section or full market section
          const row = element.closest('div');
          const grossContainer = document.getElementById('featuresAdjustmentsList');
          const fullContainer = document.getElementById('fullFeaturesAdjustmentsList');
          
          if (grossContainer && grossContainer.contains(row)) {
            containerId = 'featuresAdjustmentsList'; // Gross section
          } else {
            containerId = 'fullFeaturesAdjustmentsList'; // Full market section
          }
        }
        else if (category === 'registration') {
          // Check if element is from gross section or full market section  
          const row = element.closest('div');
          const grossContainer = document.getElementById('registrationAdjustmentsList');
          const fullContainer = document.getElementById('fullRegistrationAdjustmentsList');
          
          if (grossContainer && grossContainer.contains(row)) {
            containerId = 'registrationAdjustmentsList'; // Gross section
          } else {
            containerId = 'fullRegistrationAdjustmentsList'; // Full market section
          }
        }
        else if (category === 'mileage') containerId = 'mileageAdjustmentsList';
        else if (category === 'ownership_type') containerId = 'ownershipAdjustmentsList';
        else if (category === 'ownership_history') containerId = 'ownersAdjustmentsList';
        else if (category === 'additional') containerId = 'allAdjustmentsList';
        
        if (!containerId) {
          console.error('❌ Unknown category:', category);
          return;
        }
        
        const container = document.getElementById(containerId);
        if (!container) {
          console.error('❌ Container not found:', containerId);
          return;
        }
        
        console.log(`🔄 Rebuilding ${category} from all UI rows in ${containerId}`);
        
        // Rebuild entire category array from ALL visible UI rows
        const allRows = Array.from(container.children);
        helper.estimate.adjustments[category] = [];
        
        allRows.forEach((row, index) => {
          const inputs = row.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const adjustmentData = {
              value: inputs[0].value || '',
              type: inputs[1].value || 'plus',
              percentage: parseFloat(inputs[2].value) || 0,
              percent: parseFloat(inputs[2].value) || 0, // Backward compatibility
              amount_display: inputs[3].value || '',
              amount: parseFloat((inputs[3].value || '').replace(/[₪,-]/g, '')) || 0,
              source: 'manual',
              timestamp: new Date().toISOString()
            };
            
            // Apply sign based on type
            if (adjustmentData.type === 'minus') {
              adjustmentData.percentage = -Math.abs(adjustmentData.percentage);
              adjustmentData.percent = -Math.abs(adjustmentData.percent);
              adjustmentData.amount = -Math.abs(adjustmentData.amount);
            }
            
            // Calculate amount from percentage if needed
            if (adjustmentData.percentage && !adjustmentData.amount) {
              const baseValue = parseFloat(helper.estimate?.market_value_base) || 0;
              if (baseValue > 0) {
                const amount = Math.round((baseValue * Math.abs(adjustmentData.percentage)) / 100);
                adjustmentData.amount = adjustmentData.type === 'minus' ? -amount : amount;
              }
            }
            
            helper.estimate.adjustments[category].push(adjustmentData);
            console.log(`📝 Added row ${index} to ${category}:`, adjustmentData.value);
          }
        });
        
        console.log(`✅ Rebuilt ${category}: ${helper.estimate.adjustments[category].length} items total`);
        
        // Update valuation.adjustments with first item (for backward compatibility)
        if (helper.estimate.adjustments[category].length > 0) {
          helper.valuation.adjustments[category] = helper.estimate.adjustments[category][0];
        } else {
          // Clear valuation if no items remain
          if (helper.valuation.adjustments[category]) {
            delete helper.valuation.adjustments[category];
          }
        }
        
        // For features and registration, also write to gross_value_adjustments and sync between sections
        if (category === 'features' || category === 'registration') {
          // Ensure gross_value_adjustments exists
          if (!helper.estimate.gross_value_adjustments) helper.estimate.gross_value_adjustments = {};
          
          // Write to gross_value_adjustments as well
          helper.estimate.gross_value_adjustments[category] = helper.estimate.adjustments[category];
          
          // Bi-directional sync: update the other section's UI with the same data
          const isFromGrossSection = containerId.includes('registration') ? 
            containerId === 'registrationAdjustmentsList' : 
            containerId === 'featuresAdjustmentsList';
          
          if (isFromGrossSection) {
            // Update was from gross section -> sync to full market section
            const targetContainerId = category === 'features' ? 'fullFeaturesAdjustmentsList' : 'fullRegistrationAdjustmentsList';
            syncUISection(targetContainerId, helper.estimate.adjustments[category]);
          } else {
            // Update was from full market section -> sync to gross section
            const targetContainerId = category === 'features' ? 'featuresAdjustmentsList' : 'registrationAdjustmentsList';
            syncUISection(targetContainerId, helper.estimate.adjustments[category]);
          }
        }
        
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
      } catch (error) {
        console.error('❌ Error syncing adjustment:', error);
      }
    }

    // Helper function to sync UI section with data array
    function syncUISection(containerId, dataArray) {
      try {
        const container = document.getElementById(containerId);
        if (!container) {
          console.log(`⚠️ Container ${containerId} not found for sync`);
          return;
        }
        
        // Clear existing rows
        container.innerHTML = '';
        
        // Add rows based on data
        dataArray.forEach(item => {
          if (containerId === 'featuresAdjustmentsList') {
            addFeatureAdjustment();
          } else if (containerId === 'fullFeaturesAdjustmentsList') {
            addFullFeaturesAdjustment();
          } else if (containerId === 'registrationAdjustmentsList') {
            addRegistrationAdjustment();
          } else if (containerId === 'fullRegistrationAdjustmentsList') {
            addFullRegistrationAdjustment();
          }
          
          // Populate the last added row
          const lastRow = container.children[container.children.length - 1];
          if (lastRow) {
            const inputs = lastRow.querySelectorAll('input, select');
            if (inputs.length >= 4) {
              inputs[0].value = item.description || item.value || '';
              inputs[1].value = item.type || 'plus';
              inputs[2].value = item.percentage || item.percent || '';
              inputs[3].value = item.amount_display || (item.amount ? `₪${Math.abs(item.amount).toLocaleString()}` : '');
            }
          }
        });
        
        console.log(`🔄 Synced ${containerId} with ${dataArray.length} items`);
        
      } catch (error) {
        console.error(`❌ Error syncing UI section ${containerId}:`, error);
      }
    }

    function loadLegalTextFromVault() {
      console.log('📄 Load legal text');
      // Implementation here
    }

    function resetLegalText() {
      document.getElementById('legal-text-content').value = '';
    }

    function loadAttachmentsFromVault() {
      console.log('📎 Load attachments');
      // Implementation here
    }

    function resetAttachments() {
      document.getElementById('attachments-list').value = '';
    }

    function updateVatRateEstimate() {
      console.log('💰 Update VAT rate');
      // Implementation here
    }

    function showEstimatePreviewPip() {
      console.log('🖼️ Show PIP preview');
      const pip = document.getElementById('pip-container');
      if (pip) {
        pip.style.display = 'block';
      }
    }

    // Load damage centers from helper
    function loadDamageCenters(helper) {
      console.log('🏗️ Load damage centers');
    }
    
    // LOAD DAMAGE CENTERS SUMMARY - EDITABLE CARDS
    function loadDamageCentersSummary(helper) {
      try {
        const damageCentersContent = document.getElementById('damageCentersContent');
        
        // Load from damage centers helper (primary source) with fallbacks
        const damageCenters = helper.centers || 
                             helper.damage_centers || 
                             helper.expertise?.damage_blocks || [];
        
        if (damageCenters && damageCenters.length > 0) {
          let summaryHTML = '<div style="display: grid; gap: 15px;" id="editableDamageCenters">';
          
          damageCenters.forEach((center, index) => {
            // Adapt centers data structure to damage block structure for compatibility
            const adaptedCenter = adaptCenterToBlock(center, index);
            summaryHTML += createEditableDamageCenterCard(adaptedCenter, index);
          });
          
          summaryHTML += '</div>';
          damageCentersContent.innerHTML = summaryHTML;
          
          // Add event listeners after HTML is created
          setTimeout(addDamageCenterEventListeners, 100);
          
          // Create damage centers subtotal
          setTimeout(createDamageCentersSubtotal, 150);
          
        } else {
          damageCentersContent.innerHTML = '<div style="color: #666; text-align: center;">לא נמצאו נתוני מוקדי נזק - לחץ "הוסף מוקד נזק חדש" כדי להתחיל</div>';
        }
      } catch (error) {
        console.error('Error loading damage centers summary:', error);
        document.getElementById('damageCentersContent').innerHTML = '<div style="color: #dc3545; text-align: center;">שגיאה בטעינת נתוני מוקדי נזק</div>';
      }
    }
    
    // Adapt centers data structure to damage block structure for compatibility
    function adaptCenterToBlock(center, index) {
      const adaptedBlock = {
        damage_center_name: center.Location || center.damage_center_name || `מוקד נזק ${index + 1}`,
        damage_center_number: (() => {
          const num = center["Damage center Number"] || center.damage_center_number || (index + 1);
          if (typeof num === 'string' && num.includes('מוקד')) {
            const match = num.match(/\d+$/);
            return match ? match[0] : String(index + 1);
          }
          return num;
        })(),
        description: center.Description || center.description || '',
        works: center.Works?.works || center.works || [],
        parts: center.Parts?.parts_required || center.Parts?.parts || center.parts_required || center.parts || center.Parts || [],
        repairs: center.Repairs?.repairs || center.repairs || [],
        works_meta: center.Works?.works_meta || center.works_meta || { total_cost: 0 },
        parts_meta: center.Parts?.parts_meta || center.parts_meta || { total_cost: 0 },
        repairs_meta: center.Repairs?.repairs_meta || center.repairs_meta || { total_cost: 0 },
        total_cost: center.Summary?.["Total with VAT"] || center.total_cost || 0
      };
      
      // Additional normalization for different data structures
      if (Array.isArray(center.Works) && adaptedBlock.works.length === 0) {
        adaptedBlock.works = center.Works;
      }
      if (Array.isArray(center.Parts) && adaptedBlock.parts.length === 0) {
        adaptedBlock.parts = center.Parts;
      }
      if (Array.isArray(center.Repairs) && adaptedBlock.repairs.length === 0) {
        adaptedBlock.repairs = center.Repairs;
      }
      
      console.log(`✅ Adapted block ${index}:`, adaptedBlock);
      console.log(`📋 Parts found: ${adaptedBlock.parts.length}, Works found: ${adaptedBlock.works.length}`);
      
      return adaptedBlock;
    }
    
    // CREATE EDITABLE DAMAGE CENTER CARD
    function createEditableDamageCenterCard(block, index) {
      const centerNum = block.damage_center_number || (index + 1);
      const centerLocation = block.damage_center_name || block.Location || `מוקד נזק ${centerNum}`;
      
      // Get VAT rate
      const vatRate = window.getHelperVatRate ? window.getHelperVatRate() / 100 : 0.17;
      const vatPercentage = vatRate * 100;
      
      // Calculate costs from parts, works, repairs
      const partsCost = block.parts?.reduce((sum, part) => sum + (parseFloat(part.price) || 0), 0) || 0;
      const worksCost = block.works?.reduce((sum, work) => sum + (parseFloat(work.cost) || 0), 0) || 0;
      const repairsCost = block.repairs?.reduce((sum, repair) => sum + (parseFloat(repair.cost) || 0), 0) || 0;
      
      const totalBeforeVat = partsCost + worksCost + repairsCost;
      const totalWithVAT = totalBeforeVat * (1 + vatRate);
      
      // Get existing parts, works, repairs from block
      const parts = block.parts || [];
      const works = block.works || [];
      const repairs = block.repairs || [];
      
      return `
        <div class="damage-center-card" data-center-index="${index}">
          <div class="damage-center-header">
            <h4>מוקד נזק מס' ${centerNum}</h4>
            <button onclick="estimateRemoveDamageCenter(${index})" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">מחק</button>
          </div>
          
          <!-- Damage Center Location Field -->
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1e3a8a;">שם מוקד הנזק:</label>
            <input type="text" class="damage-center-location" style="width: 100%; border: 1px solid #ddd; padding: 8px; border-radius: 4px; font-size: 14px;" placeholder="הזן שם/איזור מוקד הנזק" value="${centerLocation}" />
          </div>
          
          <!-- Damage Description Field -->
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1e3a8a;">תיאור הנזק:</label>
            <textarea class="damage-center-description" style="width: 100%; min-height: 60px; border: 1px solid #ddd; padding: 8px; border-radius: 4px; font-size: 14px; resize: vertical;" placeholder="הזן תיאור מפורט של הנזק במוקד זה...">${block.description || ''}</textarea>
          </div>

          <!-- Parts Section -->
          <div style="border: 1px solid #e2e8f0; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
            <h4 style="margin: 0 0 10px 0; color: #1e3a8a;">חלקים נדרשים:</h4>
            <div class="parts-list" data-center="${index}">
              ${parts.map((part, partIndex) => createEditablePartRow(part, index, partIndex)).join('')}
            </div>
            <button onclick="estimateAddPartRow(${index})" class="btn" style="background: #28a745; color: white; padding: 6px 12px; margin-top: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">הוסף חלק</button>
          </div>

          <!-- Works Section -->
          <div style="border: 1px solid #e2e8f0; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
            <h4 style="margin: 0 0 10px 0; color: #1e3a8a;">עבודות נדרשות:</h4>
            <div class="works-list" data-center="${index}">
              ${works.map((work, workIndex) => createEditableWorkRow(work, index, workIndex)).join('')}
            </div>
            <button onclick="estimateAddWorkRow(${index})" class="btn" style="background: #17a2b8; color: white; padding: 6px 12px; margin-top: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">הוסף עבודה</button>
          </div>

          <!-- Cost Summary -->
          <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 14px;">
              <div><strong>חלקים:</strong> <span class="parts-costs-display">₪${partsCost.toLocaleString()}</span></div>
              <div><strong>עבודות:</strong> <span class="work-costs-display">₪${worksCost.toLocaleString()}</span></div>
              <div><strong>לפני מע"מ:</strong> <span class="total-before-vat">₪${totalBeforeVat.toLocaleString()}</span></div>
              <div><strong>כולל מע"מ:</strong> <span class="total-with-vat-display">₪${Math.round(totalWithVAT).toLocaleString()}</span></div>
            </div>
          </div>
        </div>
      `;
    }
    
    // CREATE EDITABLE PART ROW
    function createEditablePartRow(part, centerIndex, partIndex) {
      const partName = part?.name || '';
      const partDesc = part?.desc || part?.description || '';
      const partPrice = part?.price || 0;
      const partSource = part?.source || 'תחליפי';
      
      return `
        <div class="part-row" data-center="${centerIndex}" data-part="${partIndex}" style="display: grid; grid-template-columns: 2fr 2fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
          <div style="position: relative;">
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">שם החלק:</label>
            <input type="text" value="${partName}" placeholder="שם החלק" class="part-name" 
                   style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;"
                   onkeyup="showPartSuggestions(this, ${centerIndex}, ${partIndex})" />
            <div class="part-suggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; display: none; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">תיאור:</label>
            <input type="text" value="${partDesc}" placeholder="תיאור החלק" class="part-desc" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">מחיר:</label>
            <input type="number" value="${partPrice}" placeholder="מחיר" class="part-price" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">מקור:</label>
            <select class="part-source" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
              <option value="מקורי" ${partSource === 'מקורי' ? 'selected' : ''}>מקורי</option>
              <option value="תחליפי" ${partSource === 'תחליפי' ? 'selected' : ''}>תחליפי</option>
              <option value="משומש" ${partSource === 'משומש' ? 'selected' : ''}>משומש</option>
            </select>
          </div>
          <div style="align-self: end;">
            <button onclick="estimateRemovePartRow(${centerIndex}, ${partIndex})" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">מחק</button>
          </div>
        </div>
      `;
    }
    
    // CREATE EDITABLE WORK ROW
    function createEditableWorkRow(work, centerIndex, workIndex) {
      const workName = work?.name || work?.work_name || '';
      const workType = work?.type || work?.work_type || 'פחחות';
      const workCost = work?.cost || work?.work_cost || 0;
      
      return `
        <div class="work-row" data-center="${centerIndex}" data-work="${workIndex}" style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">תיאור העבודה:</label>
            <input type="text" value="${workName}" placeholder="תיאור העבודה" class="work-name" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">סוג עבודה:</label>
            <select class="work-type" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" onchange="handleWorkTypeChange(this, ${centerIndex}, ${workIndex})">
              <option value="פחחות" ${workType === 'פחחות' ? 'selected' : ''}>פחחות</option>
              <option value="צבע" ${workType === 'צבע' ? 'selected' : ''}>צבע</option>
              <option value="מכונאות" ${workType === 'מכונאות' ? 'selected' : ''}>מכונאות</option>
              <option value="חשמל" ${workType === 'חשמל' ? 'selected' : ''}>חשמל</option>
              <option value="אחר" ${workType === 'אחר' ? 'selected' : ''}>אחר</option>
            </select>
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">עלות:</label>
            <input type="number" value="${workCost}" placeholder="עלות" class="work-cost" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />
          </div>
          <div style="align-self: end;">
            <button onclick="estimateRemoveWorkRow(${centerIndex}, ${workIndex})" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">מחק</button>
          </div>
        </div>
      `;
    }

    // Clear test data and restore proper data flow
    function cleanupTestDataAndRestoreValuationFlow(helper) {
      console.log('🧹 Cleaning up test data surgically');
      
      // Clean estimate.adjustments arrays
      if (helper.estimate?.adjustments) {
        Object.keys(helper.estimate.adjustments).forEach(category => {
          if (Array.isArray(helper.estimate.adjustments[category])) {
            const originalLength = helper.estimate.adjustments[category].length;
            // Filter out only items that contain test data, keep legitimate data
            helper.estimate.adjustments[category] = helper.estimate.adjustments[category].filter(item => {
              const isTestData = (item.description && item.description.toLowerCase().includes('test')) || 
                                 (item.value && item.value.toLowerCase().includes('test'));
              if (isTestData) {
                console.log(`🗑️ Removing test item from estimate.${category}:`, item);
              }
              return !isTestData; // Keep non-test items
            });
            console.log(`🧹 ${category}: ${originalLength} → ${helper.estimate.adjustments[category].length} items after cleanup`);
          }
        });
      }
      
      // Clean valuation.adjustments objects
      if (helper.valuation?.adjustments) {
        Object.keys(helper.valuation.adjustments).forEach(category => {
          const item = helper.valuation.adjustments[category];
          const isTestData = (item?.description && item.description.toLowerCase().includes('test')) || 
                             (item?.value && item.value.toLowerCase().includes('test'));
          if (isTestData) {
            console.log(`🗑️ Removing test item from valuation.${category}:`, item);
            delete helper.valuation.adjustments[category];
          }
        });
      }
      
      // Clean up legacy field names that should not exist
      console.log('🧹 Cleaning up legacy field names');
      
      // Remove from valuation.adjustments
      if (helper.valuation?.adjustments) {
        const legacyFields = ['owners', 'ownership', 'previous_owners'];
        legacyFields.forEach(field => {
          if (helper.valuation.adjustments[field]) {
            console.log(`🗑️ Deleting legacy field: valuation.adjustments.${field}`);
            delete helper.valuation.adjustments[field];
          }
        });
      }
      
      // Remove from estimate.adjustments  
      if (helper.estimate?.adjustments) {
        const legacyFields = ['owners', 'ownership', 'previous_owners'];
        legacyFields.forEach(field => {
          if (helper.estimate.adjustments[field]) {
            console.log(`🗑️ Deleting legacy field: estimate.adjustments.${field}`);
            delete helper.estimate.adjustments[field];
          }
        });
      }
      
      return helper;
    }
    
    // Load gross adjustments (features and registration only) for gross section
    function loadGrossAdjustments(helper) {
      try {
        console.log('📊 Loading GROSS adjustments from helper.estimate.adjustments');
        
        // CLEAN UP TEST DATA FIRST 
        helper = cleanupTestDataAndRestoreValuationFlow(helper);
        
        // CLEAR EXISTING GROSS UI ROWS FIRST to prevent duplication
        document.getElementById('featuresAdjustmentsList').innerHTML = '';
        document.getElementById('registrationAdjustmentsList').innerHTML = '';
        
        if (!helper.estimate?.adjustments) {
          console.log('⚠️ No estimate.adjustments found - trying valuation.adjustments fallback');
          // If no estimate.adjustments, try to use valuation.adjustments as fallback
          if (helper.valuation?.adjustments) {
            // Convert single objects to arrays for consistency
            helper.estimate = helper.estimate || {};
            helper.estimate.adjustments = {};
            
            Object.keys(helper.valuation.adjustments).forEach(key => {
              if (helper.valuation.adjustments[key] && (key === 'features' || key === 'registration')) {
                helper.estimate.adjustments[key] = [helper.valuation.adjustments[key]];
              }
            });
            
            // Save back to sessionStorage
            sessionStorage.setItem('helper', JSON.stringify(helper));
          } else {
            return;
          }
        }
        
        const adjustments = helper.estimate.adjustments;
        
        // 1. Load Features Adjustments - EXACT COPY from full market section
        if (adjustments.features && adjustments.features.length > 0) {
          console.log('📝 Loading GROSS features adjustments:', adjustments.features);
          adjustments.features.forEach(item => {
            addFeatureAdjustment();
            const lastRow = document.querySelector('#featuresAdjustmentsList > div:last-child');
            if (lastRow) {
              const inputs = lastRow.querySelectorAll('input, select');
              if (inputs.length >= 4) {
                inputs[0].value = item.value || '';
                inputs[1].value = item.type || 'plus';
                inputs[2].value = item.percent || item.percentage || '';
                inputs[3].value = item.amount_display || (item.amount ? `₪${Math.abs(item.amount).toLocaleString()}` : '');
              }
            }
          });
        }
        
        // 2. Load Registration Adjustments - EXACT COPY from full market section
        if (adjustments.registration && adjustments.registration.length > 0) {
          console.log('📝 Loading GROSS registration adjustments:', adjustments.registration);
          adjustments.registration.forEach(item => {
            addRegistrationAdjustment();
            const lastRow = document.querySelector('#registrationAdjustmentsList > div:last-child');
            if (lastRow) {
              const inputs = lastRow.querySelectorAll('input, select');
              if (inputs.length >= 4) {
                inputs[0].value = item.value || '';
                inputs[1].value = item.type || 'plus';
                inputs[2].value = item.percent || item.percentage || '';
                inputs[3].value = item.amount_display || (item.amount ? `₪${Math.abs(item.amount).toLocaleString()}` : '');
              }
            }
          });
        }
        
        console.log('✅ Gross adjustments loaded successfully');
        
      } catch (error) {
        console.error('❌ Error loading gross adjustments:', error);
      }
    }
    
    function loadAdjustments(helper) {
      try {
        console.log('📊 Loading adjustments from helper.estimate.adjustments');
        
        // CLEAN UP TEST DATA FIRST 
        helper = cleanupTestDataAndRestoreValuationFlow(helper);
        
        // CLEAR EXISTING UI ROWS FIRST to prevent duplication
        document.getElementById('fullFeaturesAdjustmentsList').innerHTML = '';
        document.getElementById('fullRegistrationAdjustmentsList').innerHTML = '';
        document.getElementById('mileageAdjustmentsList').innerHTML = '';
        document.getElementById('ownershipAdjustmentsList').innerHTML = '';
        document.getElementById('ownersAdjustmentsList').innerHTML = '';
        document.getElementById('allAdjustmentsList').innerHTML = '';
        
        if (!helper.estimate?.adjustments) {
          console.log('⚠️ No estimate.adjustments found - trying valuation.adjustments fallback');
          // If no estimate.adjustments, try to use valuation.adjustments as fallback
          if (helper.valuation?.adjustments) {
            // Convert single objects to arrays for consistency
            helper.estimate = helper.estimate || {};
            helper.estimate.adjustments = {};
            
            Object.keys(helper.valuation.adjustments).forEach(key => {
              if (helper.valuation.adjustments[key]) {
                helper.estimate.adjustments[key] = [helper.valuation.adjustments[key]];
              }
            });
            
            // Save back to sessionStorage
            sessionStorage.setItem('helper', JSON.stringify(helper));
          } else {
            return;
          }
        }
        
        const adjustments = helper.estimate.adjustments;
        
        // 1. Load Features Adjustments
        if (adjustments.features && adjustments.features.length > 0) {
          console.log('📝 Loading features adjustments:', adjustments.features);
          adjustments.features.forEach(item => {
            addFullFeaturesAdjustment();
            const lastRow = document.querySelector('#fullFeaturesAdjustmentsList > div:last-child');
            if (lastRow) {
              const inputs = lastRow.querySelectorAll('input, select');
              if (inputs.length >= 4) {
                inputs[0].value = item.value || '';
                inputs[1].value = item.type || 'plus';
                inputs[2].value = item.percentage || item.percent || '';
                inputs[3].value = item.amount_display || (item.amount ? `₪${Math.abs(item.amount).toLocaleString()}` : '');
              }
            }
          });
        }
        
        // 2. Load Registration Adjustments
        if (adjustments.registration && adjustments.registration.length > 0) {
          console.log('📝 Loading registration adjustments:', adjustments.registration);
          adjustments.registration.forEach(item => {
            addFullRegistrationAdjustment();
            const lastRow = document.querySelector('#fullRegistrationAdjustmentsList > div:last-child');
            if (lastRow) {
              const inputs = lastRow.querySelectorAll('input, select');
              if (inputs.length >= 4) {
                inputs[0].value = item.value || '';
                inputs[1].value = item.type || 'plus';
                inputs[2].value = item.percentage || item.percent || '';
                inputs[3].value = item.amount_display || (item.amount ? `₪${Math.abs(item.amount).toLocaleString()}` : '');
              }
            }
          });
        }
        
        // 3. Load Mileage Adjustments
        if (adjustments.mileage && adjustments.mileage.length > 0) {
          console.log('📝 Loading mileage adjustments:', adjustments.mileage);
          adjustments.mileage.forEach(item => {
            addMileageAdjustment();
            const lastRow = document.querySelector('#mileageAdjustmentsList > div:last-child');
            if (lastRow) {
              const inputs = lastRow.querySelectorAll('input, select');
              if (inputs.length >= 4) {
                inputs[0].value = item.value || '';
                inputs[1].value = item.type || 'plus';
                inputs[2].value = item.percentage || item.percent || '';
                inputs[3].value = item.amount_display || (item.amount ? `₪${Math.abs(item.amount).toLocaleString()}` : '');
              }
            }
          });
        }
        
        // 4. Load Ownership Type Adjustments
        if (adjustments.ownership_type && adjustments.ownership_type.length > 0) {
          console.log('📝 Loading ownership_type adjustments:', adjustments.ownership_type);
          adjustments.ownership_type.forEach(item => {
            addOwnershipAdjustment();
            const lastRow = document.querySelector('#ownershipAdjustmentsList > div:last-child');
            if (lastRow) {
              const inputs = lastRow.querySelectorAll('input, select');
              if (inputs.length >= 4) {
                inputs[0].value = item.value || '';
                inputs[1].value = item.type || 'plus';
                inputs[2].value = item.percentage || item.percent || '';
                inputs[3].value = item.amount_display || (item.amount ? `₪${Math.abs(item.amount).toLocaleString()}` : '');
              }
            }
          });
        }
        
        // 5. Load Ownership History Adjustments
        if (adjustments.ownership_history && adjustments.ownership_history.length > 0) {
          console.log('📝 Loading ownership_history adjustments:', adjustments.ownership_history);
          adjustments.ownership_history.forEach(item => {
            addOwnersAdjustment();
            const lastRow = document.querySelector('#ownersAdjustmentsList > div:last-child');
            if (lastRow) {
              const inputs = lastRow.querySelectorAll('input, select');
              if (inputs.length >= 4) {
                inputs[0].value = item.value || '';
                inputs[1].value = item.type || 'plus';
                inputs[2].value = item.percentage || item.percent || '';
                inputs[3].value = item.amount_display || (item.amount ? `₪${Math.abs(item.amount).toLocaleString()}` : '');
              }
            }
          });
        }
        
        // 6. Load Additional Adjustments
        if (adjustments.additional && adjustments.additional.length > 0) {
          console.log('📝 Loading additional adjustments:', adjustments.additional);
          adjustments.additional.forEach(item => {
            addFullMarketAdjustment();
            const lastRow = document.querySelector('#allAdjustmentsList > div:last-child');
            if (lastRow) {
              const inputs = lastRow.querySelectorAll('input, select');
              if (inputs.length >= 4) {
                inputs[0].value = item.value || '';
                inputs[1].value = item.type || 'plus';
                inputs[2].value = item.percentage || item.percent || '';
                inputs[3].value = item.amount_display || (item.amount ? `₪${Math.abs(item.amount).toLocaleString()}` : '');
              }
            }
          });
        }
        
        console.log('✅ Finished loading all adjustments');
        
        // Trigger calculations after loading
        setTimeout(() => {
          if (typeof calculateMarketValueAmounts === 'function') {
            calculateMarketValueAmounts();
          }
          if (typeof updateFullMarketValueCalculation === 'function') {
            updateFullMarketValueCalculation();
          }
        }, 100);
        
      } catch (error) {
        console.error('❌ Error loading adjustments:', error);
      }
    }

    // Load gross values from helper (basic price + features + registration adjustments)
    function loadGrossValues(helper) {
      try {
        console.log('🏗️ Loading gross values from helper');
        
        // Auto-populate basic price using EXACT logic from final-report-builder
        const basicPriceField = document.getElementById('basicPrice');
        if (basicPriceField) {
          let basicPrice = 0;
          
          // PRIORITY MAPPING for basicPrice field - valuation.base_price FIRST
          if (helper.valuation?.base_price) {
            basicPrice = parseFloat(helper.valuation.base_price.toString().replace(/[₪,]/g, ''));
            console.log('📄 Found BASE PRICE in helper.valuation.base_price:', basicPrice);
          } else if (helper.levi_report?.base_price) {
            basicPrice = parseFloat(helper.levi_report.base_price);
            console.log('📄 Found BASE PRICE in helper.levi_report.base_price:', basicPrice);
          } else if (helper.expertise?.levi_report?.base_price) {
            basicPrice = parseFloat(helper.expertise.levi_report.base_price);
            console.log('📄 Found BASE PRICE in helper.expertise.levi_report.base_price:', basicPrice);
          } else if (helper.levisummary?.base_price) {
            basicPrice = parseFloat(helper.levisummary.base_price);
            console.log('📄 Found BASE PRICE in helper.levisummary.base_price:', basicPrice);
          } else if (helper.car_details?.base_price) {
            basicPrice = parseFloat(helper.car_details.base_price.toString().replace(/[₪,]/g, ''));
            console.log('📄 Found BASE PRICE in helper.car_details.base_price:', basicPrice);
          }
          
          if (basicPrice > 0) {
            basicPriceField.value = `₪${basicPrice.toLocaleString()}`;
            console.log('✅ Auto-filled basic price field:', basicPrice);
            
            // Trigger helper update and calculation like in final-report-builder
            updateHelperFromField({ target: basicPriceField });
            setTimeout(() => {
              if (typeof updateGrossMarketValueCalculation === 'function') {
                updateGrossMarketValueCalculation();
              }
            }, 100);
          } else {
            console.warn('⚠️ No BASE PRICE found in helper for auto-population');
          }
        }
        
        // Load gross adjustments from helper data using EXACT same logic as final-report-builder
        loadGrossAdjustmentsFromHelper(helper);
        
        // FALLBACK: Load existing gross adjustments from helper.estimate.gross_sections if no helper data
        if (helper.estimate?.gross_sections) {
          const grossValueSection = helper.estimate.gross_sections.find(
            section => section.section_type === 'gross_vehicle_value'
          );
          
          if (grossValueSection?.data) {
            const data = grossValueSection.data;
            
            // Only load from estimate if no adjustments were loaded from helper
            const existingFeatures = document.querySelectorAll('#fullFeaturesAdjustmentsList > div');
            const existingRegistration = document.querySelectorAll('#fullRegistrationAdjustmentsList > div');
            
            if (existingFeatures.length === 0 && data.features_adjustments && data.features_adjustments.length > 0) {
              console.log('📝 Loading features adjustments from helper.estimate.gross_sections (fallback)');
              data.features_adjustments.forEach(adjustment => {
                addFeatureAdjustment();
                const rows = document.querySelectorAll('#featuresAdjustmentsList > div');
                const lastRow = rows[rows.length - 1];
                if (lastRow) {
                  const inputs = lastRow.querySelectorAll('input, select');
                  if (inputs[0]) inputs[0].value = adjustment.description || '';
                  if (inputs[1]) inputs[1].value = adjustment.type || 'plus';
                  if (inputs[2]) inputs[2].value = adjustment.percentage || '';
                  if (inputs[3]) inputs[3].value = adjustment.value || '';
                }
              });
            }
            
            if (existingRegistration.length === 0 && data.registration_adjustments && data.registration_adjustments.length > 0) {
              console.log('📅 Loading registration adjustments from helper.estimate.gross_sections (fallback)');
              data.registration_adjustments.forEach(adjustment => {
                addRegistrationAdjustment();
                const rows = document.querySelectorAll('#registrationAdjustmentsList > div');
                const lastRow = rows[rows.length - 1];
                if (lastRow) {
                  const inputs = lastRow.querySelectorAll('input, select');
                  if (inputs[0]) inputs[0].value = adjustment.description || '';
                  if (inputs[1]) inputs[1].value = adjustment.type || 'plus';
                  if (inputs[2]) inputs[2].value = adjustment.percentage || '';
                  if (inputs[3]) inputs[3].value = adjustment.value || '';
                }
              });
            }
          }
        }
        
        // Also load gross percentage section fields using same helper mapping as final-report-builder
        loadGrossPercentageFields(helper);
        
        // Trigger calculation after loading
        setTimeout(() => {
          if (typeof updateGrossMarketValueCalculation === 'function') {
            updateGrossMarketValueCalculation();
          }
          
          // ALSO SYNC TO gross_value_adjustments after auto-populating
          let helperStr = sessionStorage.getItem('helper');
          if (helperStr && helperStr !== 'undefined') {
            let helper = JSON.parse(helperStr);
            helper = syncAdjustmentToEstimateHelper(null, 'features', helper) || helper;
            helper = syncAdjustmentToEstimateHelper(null, 'registration', helper) || helper;
            sessionStorage.setItem('helper', JSON.stringify(helper));
            window.helper = helper;
            console.log('✅ Synced auto-populated data to gross_value_adjustments');
          }
        }, 200);
        
      } catch (error) {
        console.error('❌ Error loading gross values:', error);
      }
    }
    
    // Load gross percentage fields using exact mapping from final-report-builder
    function loadGrossPercentageFields(helper) {
      try {
        console.log('📊 Loading gross percentage fields from helper');
        
        // Map totalDamageCost field - PRIORITY: claims_data.total_claim, FALLBACK: damage_assessment.totals["Total with VAT"]
        const totalDamageCostField = document.getElementById('totalDamageCost');
        if (totalDamageCostField) {
          let totalValue = 0;
          let source = '';
          
          // First try claims_data.total_claim (user edited value)
          if (helper.claims_data?.total_claim) {
            const claimValue = helper.claims_data.total_claim.toString().replace(/[₪,]/g, '');
            totalValue = parseFloat(claimValue) || 0;
            source = 'claims_data.total_claim';
          }
          // Fallback to damage_assessment.totals["Total with VAT"]
          else if (helper.damage_assessment?.totals?.["Total with VAT"]) {
            totalValue = parseFloat(helper.damage_assessment.totals["Total with VAT"]) || 0;
            source = 'damage_assessment.totals["Total with VAT"]';
          }
          
          if (totalValue > 0) {
            totalDamageCostField.value = `₪${totalValue.toLocaleString()}`;
            console.log(`✅ Loaded totalDamageCost from ${source}:`, totalValue);
          }
        }
        
        // Map grossValueDisplay field (estimator-builder field ID) - using EXACT logic from final-report-builder  
        const grossValueDisplayField = document.getElementById('grossValueDisplay');
        if (grossValueDisplayField) {
          let leviPrice = 0;
          
          // SAME PRIORITY as basicPrice field - valuation.base_price FIRST
          if (helper.valuation?.base_price) {
            leviPrice = parseFloat(helper.valuation.base_price.toString().replace(/[₪,]/g, ''));
          } else if (helper.levi_report?.base_price) {
            leviPrice = parseFloat(helper.levi_report.base_price);
          } else if (helper.expertise?.levi_report?.base_price) {
            leviPrice = parseFloat(helper.expertise.levi_report.base_price);
          } else if (helper.levisummary?.base_price) {
            leviPrice = parseFloat(helper.levisummary.base_price);
          } else if (helper.car_details?.base_price) {
            leviPrice = parseFloat(helper.car_details.base_price.toString().replace(/[₪,]/g, ''));
          }
          
          if (leviPrice > 0) {
            grossValueDisplayField.value = `₪${leviPrice.toLocaleString()}`;
            console.log('✅ Auto-filled grossValueDisplay:', leviPrice);
          }
        }
        
        console.log('✅ Gross percentage fields loaded from helper');
        
      } catch (error) {
        console.error('❌ Error loading gross percentage fields:', error);
      }
    }

    // Load gross adjustments - EXACT COPY from final-report-builder loadGrossAdjustments function
    function loadGrossAdjustmentsFromHelper(helper) {
      try {
        // FIRST LOAD THE BASIC PRICE!
        const basicPriceField = document.getElementById('basicPrice');
        if (basicPriceField && helper.valuation?.base_price) {
          basicPriceField.value = `₪${helper.valuation.base_price.toLocaleString()}`;
          console.log('✅ Loaded basic price:', helper.valuation.base_price);
        }
        
        // LOAD TOTAL DAMAGE COST - PRIORITY: claims_data.total_claim, FALLBACK: damage_assessment.totals["Total with VAT"]
        const totalDamageCostField = document.getElementById('totalDamageCost');
        if (totalDamageCostField) {
          let totalValue = 0;
          let source = '';
          
          // First try claims_data.total_claim (user edited value)
          if (helper.claims_data?.total_claim) {
            const claimValue = helper.claims_data.total_claim.toString().replace(/[₪,]/g, '');
            totalValue = parseFloat(claimValue) || 0;
            source = 'claims_data.total_claim';
          }
          // Fallback to damage_assessment.totals["Total with VAT"]
          else if (helper.damage_assessment?.totals?.["Total with VAT"]) {
            totalValue = parseFloat(helper.damage_assessment.totals["Total with VAT"]) || 0;
            source = 'damage_assessment.totals["Total with VAT"]';
          }
          
          if (totalValue > 0) {
            totalDamageCostField.value = `₪${totalValue.toLocaleString()}`;
            console.log(`✅ Loaded totalDamageCost from ${source}:`, totalValue);
          }
        }
        
        const featuresContainer = document.getElementById('featuresAdjustmentsList');
        const registrationContainer = document.getElementById('registrationAdjustmentsList');

        if (featuresContainer) featuresContainer.innerHTML = '';
        if (registrationContainer) registrationContainer.innerHTML = '';

        // PRIORITY 1: Load saved dynamic adjustments from helper.estimate.gross_value_adjustments
        let loadedFromEstimate = false;
        if (helper.estimate?.gross_value_adjustments) {
          const savedFeatures = helper.estimate.gross_value_adjustments.features || [];
          const savedRegistration = helper.estimate.gross_value_adjustments.registration || [];
          
          // Load saved features adjustments (multiple rows)
          if (savedFeatures.length > 0) {
            console.log('📝 Loading features adjustments from helper.estimate.gross_value_adjustments:', savedFeatures);
            savedFeatures.forEach(adjustment => {
              if (typeof addFeatureAdjustment === 'function') {
                addFeatureAdjustment();
                const rows = document.querySelectorAll('#featuresAdjustmentsList > div');
                const lastRow = rows[rows.length - 1];
                if (lastRow) {
                  const inputs = lastRow.querySelectorAll('input, select');
                  if (inputs.length >= 4) {
                    inputs[0].value = adjustment.description || '';
                    inputs[1].value = adjustment.type || 'plus';
                    inputs[2].value = adjustment.percentage || '';
                    inputs[3].value = adjustment.value ? `₪${Math.abs(parseFloat(adjustment.value)).toLocaleString()}` : '';
                  }
                }
              }
            });
            loadedFromEstimate = true;
          }
          
          // Load saved registration adjustments (multiple rows)
          if (savedRegistration.length > 0) {
            console.log('📅 Loading registration adjustments from helper.estimate.gross_value_adjustments:', savedRegistration);
            savedRegistration.forEach(adjustment => {
              if (typeof addRegistrationAdjustment === 'function') {
                addRegistrationAdjustment();
                const rows = document.querySelectorAll('#registrationAdjustmentsList > div');
                const lastRow = rows[rows.length - 1];
                if (lastRow) {
                  const inputs = lastRow.querySelectorAll('input, select');
                  if (inputs.length >= 4) {
                    inputs[0].value = adjustment.description || '';
                    inputs[1].value = adjustment.type || 'plus';
                    inputs[2].value = adjustment.percentage || '';
                    inputs[3].value = adjustment.value ? `₪${Math.abs(parseFloat(adjustment.value)).toLocaleString()}` : '';
                  }
                }
              }
            });
            loadedFromEstimate = true;
          }
        }

        // FALLBACK: Only load from original helper data if nothing was loaded from estimate
        if (!loadedFromEstimate) {
          const leviData = helper.valuation?.adjustments || {};
          const featuresData = leviData.features || {};
          const registrationData = leviData.registration || {};
          
          console.log('EXACT DATA:', { leviData, featuresData, registrationData });

          // ===== Features Adjustments =====
          if (helper.valuation?.adjustments?.features?.value || helper.valuation?.adjustments?.features?.percentage) {
            if (typeof addFeatureAdjustment === 'function') {
              addFeatureAdjustment();
              const row = document.querySelector('#featuresAdjustmentsList > div:last-child');
              if (row) {
                const inputs = row.querySelectorAll('input, select');
                
                // Use EXACT paths from your mapping
                const amount = parseFloat(helper.valuation.adjustments.features.amount?.toString().replace(/[₪,\s]/g, '')) || 0;
                const percent = parseFloat(helper.valuation.adjustments.features.percentage) || 0;
                
                if (inputs.length >= 4) {
                  // Use description from the exact path 
                  const desc = helper.valuation?.adjustments?.features?.description || helper.valuation?.adjustments?.features?.value || '';
                  inputs[0].value = desc;
                  
                  // Determine type based on negative values in helper data
                  const isNegative = (amount < 0 || percent < 0);
                  inputs[1].value = isNegative ? 'minus' : 'plus';
                
                  inputs[2].value = percent ? Math.abs(percent) : '';
                  
                  // If amount exists in helper, use it; otherwise calculate from percentage
                  if (amount) {
                    inputs[3].value = `₪${Math.abs(amount).toLocaleString()}`;
                  } else if (percent && typeof calculateAdjustmentValueSimple === 'function') {
                    // Trigger calculation from percentage × base price
                    setTimeout(() => calculateAdjustmentValueSimple(inputs[2]), 100);
                  }
                }
              }
            }
          }

          // ===== Registration Adjustment =====
          console.log('Registration check:', registrationData);
          if (registrationData.amount || registrationData.percent || registrationData.date || registrationData.description || registrationData.value) {
            if (typeof addRegistrationAdjustment === 'function') {
              addRegistrationAdjustment();
              const row = document.querySelector('#registrationAdjustmentsList > div:last-child');
              if (row) {
                const inputs = row.querySelectorAll('input, select');
                
                // Parse amount using EXACT path: helper.valuation.adjustments.registration.amount
                let amount = 0;
                if (helper.valuation?.adjustments?.registration?.amount) {
                  amount = parseFloat(helper.valuation.adjustments.registration.amount.toString().replace(/[₪,\s]/g, '')) || 0;
                }
                
                let percent = parseFloat(helper.valuation?.adjustments?.registration?.percent) || 0;
                
                if (inputs.length >= 4) {
                  // Use the EXACT path from your mapping: helper.valuation.adjustments.registration.value
                  const desc = helper.valuation?.adjustments?.registration?.value || helper.valuation?.adjustments?.registration?.description || helper.valuation?.adjustments?.registration?.date || helper.vehicle?.registration_date || 'עליה לכביש';
                  inputs[0].value = desc;
                  console.log('Set registration description:', desc);
                  
                  // Determine type based on negative values in helper data
                  const isNegative = (amount < 0 || percent < 0);
                  inputs[1].value = isNegative ? 'minus' : 'plus';
                
                  inputs[2].value = percent ? Math.abs(percent) : '';
                  
                  // If amount exists in helper, use it; otherwise calculate from percentage
                  if (amount) {
                    inputs[3].value = `₪${Math.abs(amount).toLocaleString()}`;
                    console.log('Set registration amount:', `₪${Math.abs(amount).toLocaleString()}`);
                  } else if (percent && typeof calculateAdjustmentValueSimple === 'function') {
                    // Trigger calculation from percentage × base price
                    setTimeout(() => calculateAdjustmentValueSimple(inputs[2]), 100);
                  }
                  
                  console.log('Final registration inputs:', {
                    description: inputs[0].value,
                    type: inputs[1].value, 
                    percent: inputs[2].value,
                    amount: inputs[3].value
                  });
                }
              }
            }
          }
        }

        updateGrossMarketValueCalculation();

      } catch (error) {
        console.error('❌ Error loading gross adjustments from helper:', error);
      }
    }

    function loadDepreciation(helper) {
      console.log('📉 Load depreciation');
      // Implementation here
    }

    function loadClaimsData(helper) {
      console.log('💰 Load claims data');
      // Implementation here
    }

    function loadAdditionalNotes(helper) {
      const notes = helper.estimate?.notes || '';
      const notesField = document.getElementById('additional-notes');
      if (notesField && notes) {
        notesField.value = notes;
      }
    }

    function collectVehicleData() {
      return {
        plate: document.getElementById('carPlate')?.value || '',
        manufacturer: document.getElementById('carManufacturer')?.value || '',
        model: document.getElementById('carModel')?.value || '',
        year: document.getElementById('carYear')?.value || '',
        modelCode: document.getElementById('carModelCode')?.value || '',
        basePrice: document.getElementById('carBasePrice')?.value || '',
        marketValue: document.getElementById('carMarketValue')?.value || '',
        reportDate: document.getElementById('carReportDate')?.value || ''
      };
    }

    function collectContactData() {
      return {
        ownerName: document.getElementById('ownerName')?.value || '',
        ownerAddress: document.getElementById('ownerAddress')?.value || '',
        ownerPhone: document.getElementById('ownerPhone')?.value || '',
        insuranceCompany: document.getElementById('insuranceCompany')?.value || '',
        insuranceEmail: document.getElementById('insuranceEmail')?.value || '',
        insuranceAgent: document.getElementById('insuranceAgent')?.value || '',
        agentPhone: document.getElementById('agentPhone')?.value || '',
        agentEmail: document.getElementById('agentEmail')?.value || '',
        garageName: document.getElementById('garageName')?.value || '',
        garagePhone: document.getElementById('garagePhone')?.value || '',
        garageEmail: document.getElementById('garageEmail')?.value || ''
      };
    }

    // CREATE EDITABLE PART ROW - FROM FINAL-REPORT-BUILDER
    function createEditablePartRow(part, centerIndex, partIndex) {
      const partName = part?.name || '';
      const partDesc = part?.desc || part?.description || part?.תיאור || '';
      const partPrice = part?.price || 0;
      const partSource = part?.source || part?.מקור || '';
      
      return `
        <div class="part-row" data-center="${centerIndex}" data-part="${partIndex}" style="display: grid; grid-template-columns: 2fr 2fr 1fr auto; gap: 8px; margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
          <div style="position: relative;">
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">שם החלק:</label>
            <input type="text" value="${partName}" placeholder="שם החלק" class="part-name" 
                   style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;"
                   onkeyup="showPartSuggestions(this, ${centerIndex}, ${partIndex})" />
            <div class="part-suggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; display: none; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">תיאור:</label>
            <input type="text" value="${partDesc}" placeholder="תיאור החלק" class="part-desc" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">עלות (₪):</label>
            <input type="number" value="${partPrice}" placeholder="0" class="part-price" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" min="0" step="0.01" />
          </div>
          <button onclick="estimateRemovePartRow(${centerIndex}, ${partIndex})" style="background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; align-self: end;">מחק</button>
          <input type="hidden" value="${partSource}" class="part-source" />
        </div>
      `;
    }

    // CREATE EDITABLE WORK ROW WITH DROPDOWN - FROM FINAL-REPORT-BUILDER
    function createEditableWorkRow(work, centerIndex, workIndex) {
      const workTypes = [
        'כל עבודות הפחחות כולל פירוקים והרכבות','עבודות צבע', 'עבודות חשמל', 'עבודות מכונאות', 
        'עבודות מזגן', 'עבודות ריפוד', 'עבודות זגגות',
        'איטום וזיפות', 'בדיקת מתלה', 'הנזק מחייב תקנה 309',
        'כיול רדאר', 'העברת חיישנים', 'אחר'
      ];
      
      const workType = typeof work === 'object' ? (work.category || work.type) : work;
      const workNote = typeof work === 'object' ? (work.comments || work.note || '') : '';
      const workCost = typeof work === 'object' ? work.cost : 0;
      
      return `
        <div class="work-row" data-center="${centerIndex}" data-work="${workIndex}" style="display: grid; grid-template-columns: 2fr 2fr 1fr auto; gap: 8px; margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">סוג עבודה:</label>
            <select class="work-type" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" onchange="handleWorkTypeChange(this, ${centerIndex}, ${workIndex})">
              ${workTypes.map(type => `<option value="${type}" ${type === workType ? 'selected' : ''}>${type}</option>`).join('')}
            </select>
            <input type="text" class="work-type-other" placeholder="הכנס סוג עבודה אחר" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; margin-top: 4px; display: ${workType === 'אחר' ? 'block' : 'none'};" />
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">הערות:</label>
            <input type="text" value="${workNote}" placeholder="הערות נוספות" class="work-note" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">עלות (₪):</label>
            <input type="number" value="${workCost}" placeholder="0" class="work-cost" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" min="0" step="0.01" />
          </div>
          <button onclick="estimateRemoveWorkRow(${centerIndex}, ${workIndex})" style="background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; align-self: end;">מחק</button>
        </div>
      `;
    }

    // CREATE EDITABLE REPAIR ROW - FROM FINAL-REPORT-BUILDER
    function createEditableRepairRow(repair, centerIndex, repairIndex) {
      const repairText = typeof repair === 'object' ? repair.description : repair;
      const repairCost = typeof repair === 'object' ? repair.cost : 0;
      
      return `
        <div class="repair-row" data-center="${centerIndex}" data-repair="${repairIndex}" style="display: grid; grid-template-columns: 3fr 1fr auto; gap: 8px; margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">תיאור התיקון:</label>
            <textarea placeholder="תיאור התיקון" class="repair-text" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; min-height: 60px; resize: vertical;">${repairText}</textarea>
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">עלות (₪):</label>
            <input type="number" value="${repairCost}" placeholder="0" class="repair-cost" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" min="0" step="0.01" />
          </div>
          <button onclick="estimateRemoveRepairRow(${centerIndex}, ${repairIndex})" style="background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; height: 32px; margin-top: 14px;">מחק</button>
        </div>
      `;
    }

    // Add/Remove functions
    window.estimateAddPartRow = function(centerIndex) {
      const partsList = document.querySelector(`[data-center-index="${centerIndex}"] .parts-list`);
      if (partsList) {
        const partIndex = partsList.children.length;
        const newPartHTML = createEditablePartRow({}, centerIndex, partIndex);
        partsList.insertAdjacentHTML('beforeend', newPartHTML);
        addDamageCenterEventListeners();
      }
    };

    window.estimateAddWorkRow = function(centerIndex) {
      const worksList = document.querySelector(`[data-center-index="${centerIndex}"] .works-list`);
      if (worksList) {
        const workIndex = worksList.children.length;
        const newWorkHTML = createEditableWorkRow({}, centerIndex, workIndex);
        worksList.insertAdjacentHTML('beforeend', newWorkHTML);
        addDamageCenterEventListeners();
      }
    };

    window.estimateAddRepairRow = function(centerIndex) {
      const repairsList = document.querySelector(`[data-center-index="${centerIndex}"] .repairs-list`);
      if (repairsList) {
        const repairIndex = repairsList.children.length;
        const newRepairHTML = createEditableRepairRow({}, centerIndex, repairIndex);
        repairsList.insertAdjacentHTML('beforeend', newRepairHTML);
        addDamageCenterEventListeners();
      }
    };

    window.estimateRemovePartRow = function(centerIndex, partIndex) {
      const row = document.querySelector(`[data-center="${centerIndex}"][data-part="${partIndex}"]`);
      if (row) {
        row.remove();
      }
    };

    window.estimateRemoveWorkRow = function(centerIndex, workIndex) {
      const row = document.querySelector(`[data-center="${centerIndex}"][data-work="${workIndex}"]`);
      if (row) {
        row.remove();
      }
    };

    window.estimateRemoveRepairRow = function(centerIndex, repairIndex) {
      const row = document.querySelector(`[data-center="${centerIndex}"][data-repair="${repairIndex}"]`);
      if (row) {
        row.remove();
      }
    };

    window.estimateRemoveDamageCenter = function(index) {
      if (confirm('האם אתה בטוח שברצונך למחוק מוקד נזק זה?')) {
        const card = document.querySelector(`[data-center-index="${index}"]`);
        if (card) {
          card.remove();
        }
      }
    };

    // Helper function for work type change
    window.handleWorkTypeChange = function(selectElement, centerIndex, workIndex) {
      const otherInput = selectElement.parentElement.querySelector('.work-type-other');
      if (selectElement.value === 'אחר') {
        otherInput.style.display = 'block';
      } else {
        otherInput.style.display = 'none';
      }
    };

    // Stub for part suggestions (can be implemented later)
    window.showPartSuggestions = function(input, centerIndex, partIndex) {
      // Part suggestions functionality would go here
    };

    // ADD NEW DAMAGE CENTER
    window.addNewDamageCenter = function() {
      const editableContainer = document.getElementById('editableDamageCenters');
      if (!editableContainer) {
        // Create the container if it doesn't exist
        const damageCentersContent = document.getElementById('damageCentersContent');
        damageCentersContent.innerHTML = '<div style="display: grid; gap: 15px;" id="editableDamageCenters"></div>';
      }
      
      const container = document.getElementById('editableDamageCenters');
      const newIndex = container.children.length;
      
      // Create new empty damage center
      const newCenter = {
        damage_center_name: `מוקד נזק ${newIndex + 1}`,
        damage_center_number: newIndex + 1,
        description: '',
        parts: [],
        works: [],
        repairs: []
      };
      
      const newCardHTML = createEditableDamageCenterCard(newCenter, newIndex);
      container.insertAdjacentHTML('beforeend', newCardHTML);
      
      // Add event listeners to the new card
      setTimeout(() => {
        addDamageCenterEventListeners();
        // Focus on the name field
        const nameField = container.querySelector(`[data-center-index="${newIndex}"] .damage-center-location`);
        if (nameField) nameField.focus();
      }, 100);
      
      // Save the new damage center
      setTimeout(() => {
        saveDamageCenterChanges();
      }, 200);
    };

    // ADD DAMAGE CENTER EVENT LISTENERS - AUTO-SAVE ON CHANGE
    function addDamageCenterEventListeners() {
      const selectors = '.damage-center-number, .damage-center-location, .damage-center-description, .part-name, .part-desc, .part-price, .part-source, .work-type, .work-type-other, .work-note, .work-cost, .repair-text, .repair-cost';
      
      document.querySelectorAll(selectors).forEach(input => {
        // Check if already has listeners
        if (!input.hasAttribute('data-listeners-added')) {
          input.addEventListener('change', () => {
            saveDamageCenterChanges();
            updateAllCostDisplays();
          });
          input.addEventListener('blur', () => {
            saveDamageCenterChanges();
            updateAllCostDisplays();
          });
          input.addEventListener('input', () => {
            updateAllCostDisplays();
          });
          
          // Mark as having listeners to prevent duplicates
          input.setAttribute('data-listeners-added', 'true');
        }
      });
      
      // Hide suggestions when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.part-row')) {
          document.querySelectorAll('.part-suggestions').forEach(div => {
            div.style.display = 'none';
          });
        }
      });
    }

    // UPDATE COST DISPLAY FOR A DAMAGE CENTER
    function updateCostDisplay(card, partsCost = null, worksCost = null, repairsCost = null) {
      if (!card) return;
      
      // Calculate costs if not provided
      if (partsCost === null) {
        partsCost = 0;
        card.querySelectorAll('.part-row').forEach(row => {
          const price = parseFloat(row.querySelector('.part-price').value) || 0;
          partsCost += price;
        });
      }
      
      if (worksCost === null) {
        worksCost = 0;
        card.querySelectorAll('.work-row').forEach(row => {
          const cost = parseFloat(row.querySelector('.work-cost').value) || 0;
          worksCost += cost;
        });
      }
      
      if (repairsCost === null) {
        repairsCost = 0;
        card.querySelectorAll('.repair-row').forEach(row => {
          const cost = parseFloat(row.querySelector('.repair-cost').value) || 0;
          repairsCost += cost;
        });
      }
      
      // Update display
      const partsDisplay = card.querySelector('.parts-costs-display');
      const worksDisplay = card.querySelector('.work-costs-display');
      const repairsDisplay = card.querySelector('.repairs-costs-display');
      const totalDisplay = card.querySelector('.total-with-vat-display');
      
      if (partsDisplay) partsDisplay.textContent = `₪${partsCost.toLocaleString()}`;
      if (worksDisplay) worksDisplay.textContent = `₪${worksCost.toLocaleString()}`;
      if (repairsDisplay) repairsDisplay.textContent = `₪${repairsCost.toLocaleString()}`;
      
      // Calculate total with VAT
      const totalCost = partsCost + worksCost + repairsCost;
      const vatRate = (window.getHelperVatRate ? window.getHelperVatRate() / 100 : 0.17);
      const totalWithVAT = totalCost * (1 + vatRate);
      
      if (totalDisplay) totalDisplay.textContent = `₪${Math.round(totalWithVAT).toLocaleString()}`;
    }

    // UPDATE ALL COST DISPLAYS
    function updateAllCostDisplays() {
      document.querySelectorAll('.editable-damage-card').forEach(card => {
        updateCostDisplay(card);
      });
      
      // Update subtotal if exists
      if (typeof updateDamageCentersSubtotal === 'function') {
        updateDamageCentersSubtotal();
      }
    }

    // LOAD DAMAGE CENTERS SUMMARY - EXACT COPY FROM FINAL-REPORT-BUILDER
    function loadDamageCentersSummary(helper) {
      try {
        const damageCentersContent = document.getElementById('damageCentersContent');
        
        const damageCenters = helper.centers || 
                             helper.damage_centers || 
                             helper.expertise?.damage_blocks || [];
        
        if (damageCenters && damageCenters.length > 0) {
          let summaryHTML = '<div style="display: grid; gap: 15px;" id="editableDamageCenters">';
          
          damageCenters.forEach((center, index) => {
            const adaptedCenter = adaptCenterToBlock(center, index);
            summaryHTML += createEditableDamageCenterCard(adaptedCenter, index);
          });
          
          summaryHTML += '</div>';
          damageCentersContent.innerHTML = summaryHTML;
          
          setTimeout(() => {
            addDamageCenterEventListeners();
            addDamageCenterListeners();
          }, 100);
          
          // Add subtotal section after damage centers
          createDamageCentersSubtotal();
          
          // Update all cost displays after loading
          setTimeout(() => {
            document.querySelectorAll('.editable-damage-card').forEach(card => {
              updateCostDisplay(card);
            });
            updateDamageCentersSubtotal();
          }, 150);
        } else {
          damageCentersContent.innerHTML = '<div style="color: #666; text-align: center;">לא נמצאו נתוני מוקדי נזק - לחץ "הוסף מוקד נזק חדש" כדי להתחיל</div>';
        }
      } catch (error) {
        console.error('Error loading damage centers summary:', error);
        document.getElementById('damageCentersContent').innerHTML = '<div style="color: #dc3545; text-align: center;">שגיאה בטעינת נתוני מוקדי נזק</div>';
      }
    }

    function adaptCenterToBlock(center, index) {
      const adaptedBlock = {
        damage_center_name: center.Location || center.damage_center_name || `מוקד נזק ${index + 1}`,
        damage_center_number: (() => {
          const num = center["Damage center Number"] || center.damage_center_number || (index + 1);
          if (typeof num === 'string' && num.includes('מוקד')) {
            const match = num.match(/\d+$/);
            return match ? match[0] : String(index + 1);
          }
          return num;
        })(),
        description: center.Description || center.description || '',
        works: center.Works?.works || center.works || [],
        parts: center.Parts?.parts_required || center.Parts?.parts || center.parts_required || center.parts || center.Parts || [],
        repairs: center.Repairs?.repairs || center.repairs || [],
        works_meta: center.Works?.works_meta || center.works_meta || { total_cost: 0 },
        parts_meta: center.Parts?.parts_meta || center.parts_meta || { total_cost: 0 },
        repairs_meta: center.Repairs?.repairs_meta || center.repairs_meta || { total_cost: 0 },
        total_cost: center.Summary?.["Total with VAT"] || center.total_cost || 0
      };
      
      if (Array.isArray(center.Works) && adaptedBlock.works.length === 0) {
        adaptedBlock.works = center.Works;
      }
      if (Array.isArray(center.Parts) && adaptedBlock.parts.length === 0) {
        adaptedBlock.parts = center.Parts;
      }
      if (Array.isArray(center.Repairs) && adaptedBlock.repairs.length === 0) {
        adaptedBlock.repairs = center.Repairs;
      }
      
      return adaptedBlock;
    }

    // CREATE DAMAGE CENTERS SUBTOTAL - FROM ORIGINAL
    function createDamageCentersSubtotal() {
      const existingSubtotal = document.getElementById('damageCentersSubtotal');
      if (existingSubtotal) {
        return; // Already exists
      }
      
      const damageCentersContent = document.getElementById('damageCentersContent');
      if (!damageCentersContent) return;
      
      const subtotalHTML = `
        <div id="damageCentersSubtotal" style="background: #f8f9fa; border: 2px solid #28a745; border-radius: 6px; padding: 12px; margin-top: 15px;">
          <h4 style="margin: 0 0 10px 0; color: #28a745; text-align: center; font-size: 14px; font-weight: bold;">🧮 סיכום כללי - מרכזי נזק</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-bottom: 8px;">
            <div style="background: #ffc107; color: #212529; padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 16px; font-weight: bold;" id="totalRepairsSubtotal">₪0</div>
              <div style="font-size: 10px;">סה"כ תיקונים</div>
            </div>
            <div style="background: #28a745; color: white; padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 16px; font-weight: bold;" id="totalPartsSubtotal">₪0</div>
              <div style="font-size: 10px; opacity: 0.9;">סה"כ חלקים</div>
            </div>
            <div style="background: #17a2b8; color: white; padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 16px; font-weight: bold;" id="totalWorksSubtotal">₪0</div>
              <div style="font-size: 10px; opacity: 0.9;">סה"כ עבודות</div>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <div style="background: #dc3545; color: white; padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 18px; font-weight: bold;" id="totalWithVatSubtotal">₪0</div>
              <div style="font-size: 11px; opacity: 0.9;">סה"כ כולל מע"מ</div>
            </div>
            <div style="background: #6c757d; color: white; padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 18px; font-weight: bold;" id="totalWithoutVatSubtotal">₪0</div>
              <div style="font-size: 11px; opacity: 0.9;">סה"כ ללא מע"מ</div>
            </div>
          </div>
        </div>
      `;
      
      damageCentersContent.insertAdjacentHTML('afterend', subtotalHTML);
      
      // Move the buttons div to after subtotal
      const buttonsDiv = document.getElementById('damageCenterButtons');
      if (buttonsDiv) {
        buttonsDiv.style.display = 'block';
        const subtotalElement = document.getElementById('damageCentersSubtotal');
        if (subtotalElement && subtotalElement.parentNode) {
          subtotalElement.parentNode.insertBefore(buttonsDiv, subtotalElement.nextSibling);
        }
      }
      
      // Add collapse button after buttons
      const collapseButtonHTML = `
        <div style="text-align: center; margin-top: 10px;">
          <button type="button" class="btn section-collapse-button" onclick="toggleSection('damageCentersSummary')" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">כווץ סעיף</button>
        </div>
      `;
      
      const buttonsElement = document.getElementById('damageCenterButtons');
      if (buttonsElement) {
        buttonsElement.insertAdjacentHTML('afterend', collapseButtonHTML);
      }
    }

    // UPDATE DAMAGE CENTERS SUBTOTAL
    function updateDamageCentersSubtotal() {
      let totalParts = 0;
      let totalWorks = 0;
      let totalRepairs = 0;
      
      // Calculate totals from all damage centers
      document.querySelectorAll('.editable-damage-card').forEach(card => {
        // Parts
        card.querySelectorAll('.part-row .part-price').forEach(input => {
          totalParts += parseFloat(input.value) || 0;
        });
        
        // Works
        card.querySelectorAll('.work-row .work-cost').forEach(input => {
          totalWorks += parseFloat(input.value) || 0;
        });
        
        // Repairs
        card.querySelectorAll('.repair-row .repair-cost').forEach(input => {
          totalRepairs += parseFloat(input.value) || 0;
        });
      });
      
      // Calculate totals
      const totalBeforeVAT = totalParts + totalWorks + totalRepairs;
      const vatRate = (window.getHelperVatRate ? window.getHelperVatRate() / 100 : 0.17);
      const totalWithVAT = totalBeforeVAT * (1 + vatRate);
      
      // Update displays
      const partsElement = document.getElementById('totalPartsSubtotal');
      const worksElement = document.getElementById('totalWorksSubtotal');
      const repairsElement = document.getElementById('totalRepairsSubtotal');
      const withoutVatElement = document.getElementById('totalWithoutVatSubtotal');
      const withVatElement = document.getElementById('totalWithVatSubtotal');
      
      if (partsElement) partsElement.textContent = `₪${totalParts.toLocaleString()}`;
      if (worksElement) worksElement.textContent = `₪${totalWorks.toLocaleString()}`;
      if (repairsElement) repairsElement.textContent = `₪${totalRepairs.toLocaleString()}`;
      if (withoutVatElement) withoutVatElement.textContent = `₪${totalBeforeVAT.toLocaleString()}`;
      if (withVatElement) withVatElement.textContent = `₪${Math.round(totalWithVAT).toLocaleString()}`;
    }

    function createEditableDamageCenterCard(block, index) {
      const centerNum = block.damage_center_number || (index + 1);
      const centerLocation = block.damage_center_name || block.Location || `מוקד נזק ${centerNum}`;
      
      // Calculate initial costs from actual data
      let workCosts = 0;
      let partsCosts = 0; 
      let repairsCosts = 0;
      
      // Calculate from existing data if available
      if (block.works && Array.isArray(block.works)) {
        workCosts = block.works.reduce((sum, work) => sum + (parseFloat(work.cost) || 0), 0);
      }
      if (block.parts && Array.isArray(block.parts)) {
        partsCosts = block.parts.reduce((sum, part) => sum + (parseFloat(part.price) || 0), 0);
      }
      if (block.repairs && Array.isArray(block.repairs)) {
        repairsCosts = block.repairs.reduce((sum, repair) => sum + (parseFloat(repair.cost) || 0), 0);
      }
      
      const totalCost = workCosts + partsCosts + repairsCosts;
      const vatRate = (window.getHelperVatRate ? window.getHelperVatRate() / 100 : 0.17);
      const totalWithVAT = totalCost * (1 + vatRate);
      
      const parts = block.parts || [];
      const works = block.works || [];
      const repairs = block.repairs || [];
      
      return `
        <div class="editable-damage-card" data-center-index="${index}" style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="font-weight: bold; color: #1e3a8a; font-size: 16px;">מוקד נזק מס'</span>
              <input type="text" value="${centerNum}" class="damage-center-number" style="font-weight: bold; color: #1e3a8a; font-size: 16px; border: 1px solid #ddd; padding: 8px; border-radius: 4px; width: 50px; text-align: center;" />
            </div>
            <button onclick="estimateRemoveDamageCenter(${index})" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">מחק</button>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1e3a8a;">שם מוקד הנזק:</label>
            <input type="text" class="damage-center-location" style="width: 100%; border: 1px solid #ddd; padding: 8px; border-radius: 4px; font-size: 14px;" placeholder="הזן שם/איזור מוקד הנזק (לדוגמה: פגוש קדמי, דלת נהג, וכו')" value="${centerLocation}" />
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1e3a8a;">תיאור הנזק:</label>
            <textarea class="damage-center-description" style="width: 100%; min-height: 60px; border: 1px solid #ddd; padding: 8px; border-radius: 4px; font-size: 14px; resize: vertical;" placeholder="הזן תיאור מפורט של הנזק במוקד זה...">${block.description || ''}</textarea>
          </div>

          <div style="border: 1px solid #e2e8f0; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
            <h4 style="margin: 0 0 10px 0; color: #1e3a8a;">חלקים נדרשים:</h4>
            <div class="parts-list" data-center="${index}">
              ${parts.map((part, partIndex) => createEditablePartRow(part, index, partIndex)).join('')}
            </div>
            <button onclick="estimateAddPartRow(${index})" class="btn" style="background: #28a745; color: white; padding: 6px 12px; margin-top: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">הוסף חלק</button>
          </div>

          <div style="border: 1px solid #e2e8f0; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
            <h4 style="margin: 0 0 10px 0; color: #1e3a8a;">עבודות נדרשות:</h4>
            <div class="works-list" data-center="${index}">
              ${works.map((work, workIndex) => createEditableWorkRow(work, index, workIndex)).join('')}
            </div>
            <button onclick="estimateAddWorkRow(${index})" class="btn" style="background: #17a2b8; color: white; padding: 6px 12px; margin-top: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">הוסף עבודה</button>
          </div>

          <div style="border: 1px solid #e2e8f0; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
            <h4 style="margin: 0 0 10px 0; color: #1e3a8a;">תיקונים נדרשים:</h4>
            <div class="repairs-list" data-center="${index}">
              ${repairs.map((repair, repairIndex) => createEditableRepairRow(repair, index, repairIndex)).join('')}
            </div>
            <button onclick="estimateAddRepairRow(${index})" class="btn" style="background: #ffc107; color: #212529; padding: 6px 12px; margin-top: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">הוסף תיקון</button>
          </div>

          <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 14px;">
              <div><strong>עבודות:</strong> <span class="work-costs-display">₪${workCosts.toLocaleString()}</span></div>
              <div><strong>חלפים:</strong> <span class="parts-costs-display">₪${partsCosts.toLocaleString()}</span></div>
              <div><strong>תיקונים:</strong> <span class="repairs-costs-display">₪${repairsCosts.toLocaleString()}</span></div>
              <div><strong>כולל מע"מ:</strong> <span class="total-with-vat-display">₪${Math.round(totalWithVAT).toLocaleString()}</span></div>
            </div>
          </div>
        </div>
      `;
    }

    // REMOVED DUPLICATE - Using the one at line 2041 instead



    // Sync adjustment to estimate helper (mirror data)
    function syncAdjustmentToEstimateHelper(element, category, helperParam) {
      try {
        // Use passed helper or get from storage
        let helper;
        if (helperParam) {
          helper = helperParam;
        } else {
          let helperStr = sessionStorage.getItem('helper');
          if (!helperStr || helperStr === 'undefined') {
            console.log('No helper found, skipping sync');
            return null;
          }
          helper = JSON.parse(helperStr);
        }
        
        // Initialize estimate structure if needed
        if (!helper.estimate) helper.estimate = {};
        if (!helper.estimate.gross_value_adjustments) {
          helper.estimate.gross_value_adjustments = {
            features: [],
            registration: []
          };
        }
        
        // Clear and rebuild the adjustments
        helper.estimate.gross_value_adjustments[category] = [];
        
        // Collect all adjustments of this category
        const selector = category === 'features' ? '#featuresAdjustmentsList > div' : '#registrationAdjustmentsList > div';
        const rows = document.querySelectorAll(selector);
        
        rows.forEach(row => {
          const inputs = row.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const adjustmentData = {
              description: category, // Category name like "features", "registration"
              value: inputs[0].value || '', // תיאור content goes in value field
              type: inputs[1].value || 'plus',
              percentage: parseFloat(inputs[2].value) || 0,
              amount: parseFloat(inputs[3].value.replace(/[₪,]/g, '')) || 0, // Monetary amount goes in amount field
              timestamp: new Date().toISOString()
            };
            
            if (adjustmentData.value.trim() !== '' || adjustmentData.amount !== 0 || adjustmentData.percentage !== 0) {
              helper.estimate.gross_value_adjustments[category].push(adjustmentData);
            }
          }
        });
        
        // Update gross market value in estimate
        const grossValueResult = document.getElementById('grossMarketValueResult');
        if (grossValueResult) {
          helper.estimate.gross_market_value = parseFloat(grossValueResult.value.replace(/[₪,]/g, '')) || 0;
        }
        
        // Add total damage cost and gross damage percentage to estimate
        const totalDamageCostField = document.getElementById('totalDamageCost');
        if (totalDamageCostField) {
          helper.estimate.total_damage_cost = parseFloat(totalDamageCostField.value.replace(/[₪,]/g, '')) || 0;
        }
        
        const grossDamagePercentageField = document.getElementById('grossDamagePercentage');
        if (grossDamagePercentageField) {
          helper.estimate.gross_damage_percentage = parseFloat(grossDamagePercentageField.value.replace(/[%,]/g, '')) || 0;
        }
        
        // Only save to sessionStorage if helper wasn't passed as parameter
        if (!helperParam) {
          sessionStorage.setItem('helper', JSON.stringify(helper));
        }
        
        console.log(`✅ Synced ${category} adjustments to helper.estimate.gross_value_adjustments.${category}:`, helper.estimate.gross_value_adjustments[category]);
        
        return helper;
        
      } catch (error) {
        console.error('Error syncing adjustment to estimate helper:', error);
        return helperParam || null;
      }
    }

    // Sync FULL MARKET VALUE features/registration to estimate.gross_value_adjustments
    function syncFullMarketValueToEstimateHelper(element, category, helperParam) {
      try {
        // Use passed helper or get from storage
        let helper;
        if (helperParam) {
          helper = helperParam;
        } else {
          let helperStr = sessionStorage.getItem('helper');
          if (!helperStr || helperStr === 'undefined') {
            console.log('No helper found, skipping full market sync');
            return null;
          }
          helper = JSON.parse(helperStr);
        }
        
        // Initialize estimate structure if needed
        if (!helper.estimate) helper.estimate = {};
        if (!helper.estimate.gross_value_adjustments) {
          helper.estimate.gross_value_adjustments = {
            features: [],
            registration: []
          };
        }
        
        // Clear and rebuild the adjustments from FULL MARKET VALUE containers
        helper.estimate.gross_value_adjustments[category] = [];
        
        // Collect all adjustments from FULL MARKET VALUE containers
        const selector = category === 'features' ? '#fullFeaturesAdjustmentsList > div' : '#fullRegistrationAdjustmentsList > div';
        const rows = document.querySelectorAll(selector);
        
        console.log(`🔍 syncFullMarketValueToEstimateHelper: Found ${rows.length} rows for ${category} in ${selector}`);
        
        rows.forEach((row, index) => {
          const inputs = row.querySelectorAll('input, select');
          console.log(`🔍 Row ${index}: Found ${inputs.length} inputs`);
          
          if (inputs.length >= 4) {
            const adjustmentData = {
              description: category, // Category name like "features", "registration"
              value: inputs[0].value || '', // תיאור content goes in value field
              type: inputs[1].value || 'plus',
              percentage: parseFloat(inputs[2].value) || 0,
              amount: parseFloat(inputs[3].value.replace(/[₪,]/g, '')) || 0, // Monetary amount goes in amount field
              timestamp: new Date().toISOString()
            };
            
            console.log(`🔍 Created adjustment data for ${category}:`, adjustmentData);
            
            if (adjustmentData.value.trim() !== '' || adjustmentData.amount !== 0 || adjustmentData.percentage !== 0) {
              helper.estimate.gross_value_adjustments[category].push(adjustmentData);
              console.log(`✅ Added to estimate.gross_value_adjustments.${category}[${helper.estimate.gross_value_adjustments[category].length - 1}]`);
            }
          }
        });
        
        console.log(`✅ Synced full market ${category} to estimate.gross_value_adjustments:`, helper.estimate.gross_value_adjustments[category]);
        
        // Only save to sessionStorage if helper wasn't passed as parameter
        if (!helperParam) {
          sessionStorage.setItem('helper', JSON.stringify(helper));
        }
        
        return helper;
        
      } catch (error) {
        console.error('Error syncing full market adjustment to estimate helper:', error);
        return helperParam || null;
      }
    }

    // REMOVED DUPLICATE - Using the one at line 2094 that accepts helper parameter

    // Write back to data source - helper.valuation.adjustments
    function writeToDataSource(helper) {
      try {
        // Ensure structure exists
        if (!helper.valuation) helper.valuation = {};
        if (!helper.valuation.adjustments) helper.valuation.adjustments = {};
        if (!helper.valuation.adjustments.features) helper.valuation.adjustments.features = {};
        if (!helper.valuation.adjustments.registration) helper.valuation.adjustments.registration = {};
        
        // Write features adjustments back to source
        const featuresRows = document.querySelectorAll('#fullFeaturesAdjustmentsList > div');
        if (featuresRows.length > 0) {
          const firstFeatureRow = featuresRows[0];
          const inputs = firstFeatureRow.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            helper.valuation.adjustments.features.value = inputs[0].value || ''; // UI input goes in value field
            helper.valuation.adjustments.features.percentage = inputs[2].value || '';
          }
        }
        
        // Write registration adjustments back to source
        const registrationRows = document.querySelectorAll('#fullRegistrationAdjustmentsList > div');
        if (registrationRows.length > 0) {
          const firstRegRow = registrationRows[0];
          const inputs = firstRegRow.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            helper.valuation.adjustments.registration.value = inputs[0].value || '';
            helper.valuation.adjustments.registration.percent = inputs[2].value || '';
            helper.valuation.adjustments.registration.amount = inputs[3].value || '';
          }
        }

        // Write ownership adjustments back to source
        if (!helper.valuation.adjustments.ownership_type) helper.valuation.adjustments.ownership_type = {};
        const ownershipRows = document.querySelectorAll('#ownershipAdjustmentsList > div');
        if (ownershipRows.length > 0) {
          const firstOwnershipRow = ownershipRows[0];
          const inputs = firstOwnershipRow.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            helper.valuation.adjustments.ownership_type.value = inputs[0].value || ''; // UI input goes in value field
            helper.valuation.adjustments.ownership_type.percentage = inputs[2].value || '';
          }
        }

        // Write owners adjustments back to source  
        if (!helper.valuation.adjustments.ownership_history) helper.valuation.adjustments.ownership_history = {};
        const ownersRows = document.querySelectorAll('#ownersAdjustmentsList > div');
        if (ownersRows.length > 0) {
          const firstOwnersRow = ownersRows[0];
          const inputs = firstOwnersRow.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            helper.valuation.adjustments.ownership_history.value = inputs[0].value || ''; // UI input goes in value field
            helper.valuation.adjustments.ownership_history.percentage = inputs[2].value || '';
          }
        }
        
        console.log('✅ Written back to data source including ownership_type and ownership_history');
        
      } catch (error) {
        console.error('❌ Error writing to data source:', error);
      }
    }

    // Save gross sections as array to helper.estimate (including both gross value and gross percentage sections)
    function saveGrossSectionsToEstimateHelper(helper) {
      try {
        // Initialize estimate structure if it doesn't exist
        if (!helper.estimate) helper.estimate = {};
        if (!helper.estimate.gross_values) helper.estimate.gross_values = [];
        
        // Clear existing gross_values array to avoid duplicates
        helper.estimate.gross_values = [];
        
        // Create gross value section data
        const grossValueSection = {
          section_type: 'gross_vehicle_value',
          section_title: 'ערך הרכב הגולמי - מאפיינים ועליה לכביש בלבד',
          data: {}
        };
        
        // Save basic price
        const basicPriceField = document.getElementById('basicPrice');
        if (basicPriceField && basicPriceField.value) {
          grossValueSection.data.basic_price = basicPriceField.value;
          grossValueSection.data.basic_price_raw = parseFloat(basicPriceField.value.replace(/[₪,]/g, '')) || 0;
        }
        
        // Save features adjustments
        const featuresRows = document.querySelectorAll('#fullFeaturesAdjustmentsList > div');
        grossValueSection.data.features_adjustments = [];
        featuresRows.forEach(row => {
          const inputs = row.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const adjustment = {
              value: inputs[0].value || '', // UI input goes in value field
              type: inputs[1].value || 'plus',
              percentage: inputs[2].value || '',
              amount_display: inputs[3].value || '',
              value_raw: parseFloat((inputs[3].value || '').replace(/[₪,]/g, '')) || 0
            };
            if (adjustment.description.trim() || adjustment.value_raw !== 0) {
              grossValueSection.data.features_adjustments.push(adjustment);
            }
          }
        });
        
        // Save registration adjustments
        const registrationRows = document.querySelectorAll('#fullRegistrationAdjustmentsList > div');
        grossValueSection.data.registration_adjustments = [];
        registrationRows.forEach(row => {
          const inputs = row.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const adjustment = {
              value: inputs[0].value || '', // UI input goes in value field
              type: inputs[1].value || 'plus',
              percentage: inputs[2].value || '',
              amount_display: inputs[3].value || '',
              value_raw: parseFloat((inputs[3].value || '').replace(/[₪,]/g, '')) || 0
            };
            if (adjustment.description.trim() || adjustment.value_raw !== 0) {
              grossValueSection.data.registration_adjustments.push(adjustment);
            }
          }
        });
        
        // Save cumulative values
        const featuresCumulative = document.querySelector('#grossFeaturesCumulative span')?.textContent;
        const registrationCumulative = document.querySelector('#grossRegistrationCumulative span')?.textContent;
        const grossResult = document.getElementById('grossMarketValueResult')?.value;
        
        grossValueSection.data.cumulatives = {
          features_total: featuresCumulative || '₪0',
          features_total_raw: parseFloat((featuresCumulative || '₪0').replace(/[₪,]/g, '')) || 0,
          registration_total: registrationCumulative || '₪0',
          registration_total_raw: parseFloat((registrationCumulative || '₪0').replace(/[₪,]/g, '')) || 0,
          gross_market_value: grossResult || '₪0',
          gross_market_value_raw: parseFloat((grossResult || '₪0').replace(/[₪,]/g, '')) || 0
        };
        
        // Add gross percentage section data if available
        const grossPercentageSection = {
          section_type: 'gross_damage_percentage',
          section_title: 'אחוז הנזק הגולמי - בסיס הרכב בלבד',
          data: {}
        };
        
        // Collect gross percentage fields (using correct estimator-builder field IDs)
        const totalDamageCostField = document.getElementById('totalDamageCost');
        const grossValueDisplayField = document.getElementById('grossValueDisplay');
        const grossDamagePercentageField = document.getElementById('grossDamagePercentage');
        
        if (totalDamageCostField) {
          grossPercentageSection.data.total_damage_cost = totalDamageCostField.value;
          grossPercentageSection.data.total_damage_cost_raw = parseFloat(totalDamageCostField.value.replace(/[₪,]/g, '')) || 0;
        }
        
        if (grossValueDisplayField) {
          grossPercentageSection.data.gross_value_display = grossValueDisplayField.value;
          grossPercentageSection.data.gross_value_display_raw = parseFloat(grossValueDisplayField.value.replace(/[₪,]/g, '')) || 0;
        }
        
        if (grossDamagePercentageField) {
          grossPercentageSection.data.gross_damage_percentage = grossDamagePercentageField.value;
          grossPercentageSection.data.gross_damage_percentage_raw = parseFloat(grossDamagePercentageField.value.replace(/[%,]/g, '')) || 0;
        }
        
        // Add timestamps
        const timestamp = new Date().toISOString();
        grossValueSection.last_updated = timestamp;
        grossPercentageSection.last_updated = timestamp;
        
        
        // Remove existing sections of these types and add new ones
        helper.estimate.gross_values = helper.estimate.gross_values.filter(
          section => !['gross_vehicle_value', 'gross_damage_percentage'].includes(section.section_type)
        );
        
        helper.estimate.gross_values.push(grossValueSection);
        helper.estimate.gross_values.push(grossPercentageSection);
        
        console.log('✅ Saved gross sections to helper.estimate.gross_values array');
        
      } catch (error) {
        console.error('❌ Error saving gross sections to estimate helper:', error);
      }
    }

    // Save gross value with feedback
    function saveGrossValueWithFeedback(event) {
      console.log('🔘 Save gross value button clicked!');
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        console.log('📝 Current helper before save:', helper);
        
        // Update calculations
        updateGrossMarketValueCalculation();
        
        // Update helper with form values - DISABLED: conflicts with real-time sync  
        // helper = updateHelperFromAdjustments(helper); // This function only processes first row
        
        // 1. WRITE TO DATA SOURCE: Update helper.valuation.adjustments with current form values
        writeToDataSource(helper);
        
        // 2. Save gross value to main calculations
        const grossValue = document.getElementById('grossMarketValueResult')?.value;
        if (grossValue) {
          if (!helper.calculations) helper.calculations = {};
          helper.calculations.gross_market_value = parseFloat(grossValue.replace(/[₪,]/g, '')) || 0;
        }
        
        // 3. SAVE TO gross_value_adjustments.features and .registration
        helper = syncAdjustmentToEstimateHelper(null, 'features', helper) || helper;
        helper = syncAdjustmentToEstimateHelper(null, 'registration', helper) || helper;
        
        // 4. Save total damage cost and gross damage percentage to estimate
        if (!helper.estimate) helper.estimate = {};
        
        const totalDamageCostField = document.getElementById('totalDamageCost');
        if (totalDamageCostField) {
          helper.estimate.total_damage_cost = parseFloat(totalDamageCostField.value.replace(/[₪,]/g, '')) || 0;
        }
        
        const grossDamagePercentageField = document.getElementById('grossDamagePercentage');
        if (grossDamagePercentageField) {
          helper.estimate.gross_damage_percentage = parseFloat(grossDamagePercentageField.value.replace(/[%,]/g, '')) || 0;
        }
        
        // 5. DUAL STORAGE: Save gross sections array to helper.estimate
        saveGrossSectionsToEstimateHelper(helper);
        
        // 4. SAVE TO ALL STORAGE LOCATIONS
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        // Update window.helper (single source of truth)
        if (typeof window.updateHelper === 'function') {
          window.updateHelper(helper);
        } else {
          window.helper = helper;
        }
        
        // Force sync all damage center locations and rebuild assessment
        window.rebuildAssessments();
        
        console.log('✅ Saved to all locations:', helper.estimate?.gross_values);
        console.log('✅ Final helper after save:', helper);
        
        // Show feedback
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'נשמר ✓';
        button.style.background = '#28a745';
        
        setTimeout(() => {
          button.textContent = originalText;
          button.style.background = '#007bff';
        }, 2000);
        
      } catch (error) {
        console.error('❌ Error saving gross value:', error);
        alert('❌ Error saving: ' + error.message);
      }
    }
    
    // Make sure function is globally accessible
    window.saveGrossValueWithFeedback = saveGrossValueWithFeedback;
    
    // Function to rebuild assessments - call this whenever damage centers change
    window.rebuildAssessments = function() {
      // FORCE SYNC ALL DAMAGE CENTER LOCATIONS
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Make sure helper.centers is the source of truth
      if (helper.centers && Array.isArray(helper.centers)) {
        // Copy centers to damage_centers location
        helper.damage_centers = [...helper.centers];
        
        // Update window.helper
        window.helper = helper;
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        // Now rebuild assessment from the synced data
        if (typeof window.buildComprehensiveDamageAssessment === 'function') {
          window.buildComprehensiveDamageAssessment();
        }
      }
    };
    
    // Auto-save function for real-time updates
    function autoSaveToHelper() {
      try {
        // Get helper from sessionStorage or window.helper
        let helperStr = sessionStorage.getItem('helper');
        if (!helperStr || helperStr === 'undefined') {
          // Try to get from window.helper
          if (window.helper && typeof window.helper === 'object') {
            helperStr = JSON.stringify(window.helper);
          } else {
            console.log('No helper found, skipping auto-save');
            return;
          }
        }
        
        let helper = JSON.parse(helperStr);
        
        // Update helper with current form values - DISABLED: conflicts with real-time sync
        // helper = updateHelperFromAdjustments(helper); // This function only processes first row
        
        // Also sync to gross_value_adjustments
        helper = syncAdjustmentToEstimateHelper(null, 'features', helper) || helper;
        helper = syncAdjustmentToEstimateHelper(null, 'registration', helper) || helper;
        
        // Save to all storage locations
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        // Update window.helper directly
        window.helper = helper;
        
        // Also rebuild damage assessment to keep it in sync
        window.rebuildAssessments();
        
        console.log('✅ Auto-saved to helper');
        
      } catch (error) {
        console.error('❌ Error in auto-save:', error);
      }
    }
    
    // Update gross value adjustments to BOTH valuation source AND estimate.adjustments  
    function updateGrossValueToValuationAndEstimate(helper) {
      try {
        // Initialize structures
        if (!helper.valuation) helper.valuation = {};
        if (!helper.valuation.adjustments) helper.valuation.adjustments = {};
        if (!helper.estimate) helper.estimate = {};
        if (!helper.estimate.adjustments) helper.estimate.adjustments = {};
        
        
        // 1. FEATURES - Write to both valuation source and estimate
        const featuresRows = document.querySelectorAll('#featuresAdjustmentsList > div');
        if (featuresRows.length > 0) {
          // For VALUATION: Only store first row (no arrays in valuation)
          const firstRow = featuresRows[0];
          const inputs = firstRow.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const adjustmentData = {
              value: inputs[0].value || '', // תיאור goes in value field
              description: inputs[0].value || '', // Also store as description for backward compatibility
              type: inputs[1].value || 'plus',
              percentage: parseFloat(inputs[2].value) || 0,
              amount_display: inputs[3].value || '',
              amount: parseFloat((inputs[3].value || '').replace(/[₪,-]/g, '')) || 0
            };
            
            // Apply sign based on type
            if (inputs[1].value === 'minus') {
              adjustmentData.amount = -Math.abs(adjustmentData.amount);
            }
            
            // Write to VALUATION source (primary) - single object
            helper.valuation.adjustments.features = adjustmentData;
          }
          
          // For ESTIMATE: Store ALL rows (arrays in estimate)  
          helper.estimate.adjustments.features = [];
          featuresRows.forEach(row => {
            const inputs = row.querySelectorAll('input, select');
            if (inputs.length >= 4) {
              const adjustmentData = {
                value: inputs[0].value || '', // תיאור goes in value field (don't overwrite description from Levi data)
                type: inputs[1].value || 'plus',
                percentage: parseFloat(inputs[2].value) || 0,
                amount_display: inputs[3].value || '',
                amount: parseFloat((inputs[3].value || '').replace(/[₪,-]/g, '')) || 0
              };
              
              // Apply sign based on type
              if (inputs[1].value === 'minus') {
                adjustmentData.amount = -Math.abs(adjustmentData.amount);
              }
              
              helper.estimate.adjustments.features.push(adjustmentData);
            }
          });
        }
        
        // 2. REGISTRATION - Write to both valuation source and estimate
        const registrationRows = document.querySelectorAll('#registrationAdjustmentsList > div');
        if (registrationRows.length > 0) {
          // For VALUATION: Only store first row (no arrays in valuation)
          const firstRow = registrationRows[0];
          const inputs = firstRow.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const adjustmentData = {
              value: inputs[0].value || '', // תיאור goes in value field  
              description: inputs[0].value || '', // Also store as description for backward compatibility
              type: inputs[1].value || 'plus',
              percentage: parseFloat(inputs[2].value) || 0,
              percent: parseFloat(inputs[2].value) || 0, // Also store as 'percent' for backward compatibility
              amount_display: inputs[3].value || '',
              amount: parseFloat((inputs[3].value || '').replace(/[₪,-]/g, '')) || 0
            };
            
            // Apply sign based on type
            if (inputs[1].value === 'minus') {
              adjustmentData.amount = -Math.abs(adjustmentData.amount);
            }
            
            // Write to VALUATION source (primary) - single object
            helper.valuation.adjustments.registration = adjustmentData;
          }
          
          // For ESTIMATE: Store ALL rows (arrays in estimate)
          helper.estimate.adjustments.registration = [];
          registrationRows.forEach(row => {
            const inputs = row.querySelectorAll('input, select');
            if (inputs.length >= 4) {
              const adjustmentData = {
                value: inputs[0].value || '', // תיאור goes in value field  
                description: inputs[0].value || '', // Also store as description for backward compatibility
                type: inputs[1].value || 'plus',
                percentage: parseFloat(inputs[2].value) || 0,
                percent: parseFloat(inputs[2].value) || 0, // Also store as 'percent' for backward compatibility
                amount_display: inputs[3].value || '',
                amount: parseFloat((inputs[3].value || '').replace(/[₪,-]/g, '')) || 0
              };
              
              // Apply sign based on type
              if (inputs[1].value === 'minus') {
                adjustmentData.amount = -Math.abs(adjustmentData.amount);
              }
              
              helper.estimate.adjustments.registration.push(adjustmentData);
            }
          });
        }
        
        console.log('✅ Updated gross value adjustments to BOTH valuation.adjustments AND estimate.adjustments');
        
      } catch (error) {
        console.error('❌ Error updating gross value to valuation and estimate adjustments:', error);
      }
    }

    // Update FULL MARKET VALUE features/registration to BOTH valuation source AND estimate.adjustments  
    function updateFullMarketValueToValuationAndEstimate(helper) {
      try {
        // Initialize structures
        if (!helper.valuation) helper.valuation = {};
        if (!helper.valuation.adjustments) helper.valuation.adjustments = {};
        if (!helper.estimate) helper.estimate = {};
        if (!helper.estimate.adjustments) helper.estimate.adjustments = {};
        
        
        // 1. FEATURES - Write to both valuation source and estimate
        const featuresRows = document.querySelectorAll('#fullFeaturesAdjustmentsList > div');
        if (featuresRows.length > 0) {
          // For VALUATION: Only store first row (no arrays in valuation)
          const firstRow = featuresRows[0];
          const inputs = firstRow.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const adjustmentData = {
              value: inputs[0].value || '', // תיאור content goes in value field (don't overwrite description from Levi data)
              type: inputs[1].value || 'plus',
              percentage: parseFloat(inputs[2].value) || 0,
              amount_display: inputs[3].value || '',
              amount: parseFloat((inputs[3].value || '').replace(/[₪,-]/g, '')) || 0
            };
            
            // Apply sign based on type
            if (inputs[1].value === 'minus') {
              adjustmentData.amount = -Math.abs(adjustmentData.amount);
            }
            
            // Write to VALUATION source (primary) - single object
            helper.valuation.adjustments.features = adjustmentData;
          }
          
          
          // For ESTIMATE: Store ALL rows (arrays in estimate)
          helper.estimate.adjustments.features = [];
          featuresRows.forEach(row => {
            const inputs = row.querySelectorAll('input, select');
            if (inputs.length >= 4) {
              const adjustmentData = {
                value: inputs[0].value || '', // תיאור content goes in value field (don't overwrite description from Levi data)
                type: inputs[1].value || 'plus',
                percentage: parseFloat(inputs[2].value) || 0,
                amount_display: inputs[3].value || '',
                amount: parseFloat((inputs[3].value || '').replace(/[₪,-]/g, '')) || 0
              };
              
              // Apply sign based on type
              if (inputs[1].value === 'minus') {
                adjustmentData.amount = -Math.abs(adjustmentData.amount);
              }
              
              helper.estimate.adjustments.features.push(adjustmentData);
            }
          });
        }
        
        // 2. REGISTRATION - Write to both valuation source and estimate
        const registrationRows = document.querySelectorAll('#fullRegistrationAdjustmentsList > div');
        if (registrationRows.length > 0) {
          // For VALUATION: Only store first row (no arrays in valuation)
          const firstRow = registrationRows[0];
          const inputs = firstRow.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const adjustmentData = {
              value: inputs[0].value || '', // תיאור content goes in value field (don't overwrite description from Levi data)
              type: inputs[1].value || 'plus',
              percentage: parseFloat(inputs[2].value) || 0,
              percent: parseFloat(inputs[2].value) || 0, // Also store as 'percent' for backward compatibility
              amount_display: inputs[3].value || '',
              amount: parseFloat((inputs[3].value || '').replace(/[₪,-]/g, '')) || 0
            };
            
            // Apply sign based on type
            if (inputs[1].value === 'minus') {
              adjustmentData.amount = -Math.abs(adjustmentData.amount);
            }
            
            // Write to VALUATION source (primary) - single object
            helper.valuation.adjustments.registration = adjustmentData;
          }
          
          
          // For ESTIMATE: Store ALL rows (arrays in estimate)
          helper.estimate.adjustments.registration = [];
          registrationRows.forEach(row => {
            const inputs = row.querySelectorAll('input, select');
            if (inputs.length >= 4) {
              const adjustmentData = {
                value: inputs[0].value || '', // תיאור content goes in value field (don't overwrite description from Levi data)
                type: inputs[1].value || 'plus',
                percentage: parseFloat(inputs[2].value) || 0,
                percent: parseFloat(inputs[2].value) || 0, // Also store as 'percent' for backward compatibility
                amount_display: inputs[3].value || '',
                amount: parseFloat((inputs[3].value || '').replace(/[₪,-]/g, '')) || 0
              };
              
              // Apply sign based on type
              if (inputs[1].value === 'minus') {
                adjustmentData.amount = -Math.abs(adjustmentData.amount);
              }
              
              helper.estimate.adjustments.registration.push(adjustmentData);
            }
          });
        }
        
        // 3. MILEAGE - Write to both valuation source and estimate
        const mileageRows = document.querySelectorAll('#mileageAdjustmentsList > div');
        if (mileageRows.length > 0) {
          // For VALUATION: Only store first row (no arrays in valuation)
          const firstRow = mileageRows[0];
          const inputs = firstRow.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const adjustmentData = {
              value: inputs[0].value || '', // UI input goes in value field  
              type: inputs[1].value || 'plus',
              percentage: parseFloat(inputs[2].value) || 0,
              percent: parseFloat(inputs[2].value) || 0,
              amount_display: inputs[3].value || '',
              amount: parseFloat((inputs[3].value || '').replace(/[₪,-]/g, '')) || 0
            };
            
            if (inputs[1].value === 'minus') {
              adjustmentData.amount = -Math.abs(adjustmentData.amount);
            }
            
            helper.valuation.adjustments.mileage = adjustmentData;
          }
          
          // For ESTIMATE: Store ALL rows (arrays in estimate)
          helper.estimate.adjustments.mileage = [];
          mileageRows.forEach(row => {
            const inputs = row.querySelectorAll('input, select');
            if (inputs.length >= 4) {
              const adjustmentData = {
                description: inputs[0].value || '',
                value: inputs[0].value || '',
                type: inputs[1].value || 'plus',
                percentage: parseFloat(inputs[2].value) || 0,
                percent: parseFloat(inputs[2].value) || 0,
                amount_display: inputs[3].value || '',
                amount: parseFloat((inputs[3].value || '').replace(/[₪,-]/g, '')) || 0
              };
              
              if (inputs[1].value === 'minus') {
                adjustmentData.amount = -Math.abs(adjustmentData.amount);
              }
              
              helper.estimate.adjustments.mileage.push(adjustmentData);
            }
          });
        }
        
        // 4. OWNERSHIP TYPE - Write to both valuation source and estimate
        const ownershipRows = document.querySelectorAll('#ownershipAdjustmentsList > div');
        if (ownershipRows.length > 0) {
          // For VALUATION: Only store first row (no arrays in valuation)
          const firstRow = ownershipRows[0];
          const inputs = firstRow.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const adjustmentData = {
              value: inputs[0].value || '', // UI input goes in value field  
              type: inputs[1].value || 'plus',
              percentage: parseFloat(inputs[2].value) || 0,
              percent: parseFloat(inputs[2].value) || 0,
              amount_display: inputs[3].value || '',
              amount: parseFloat((inputs[3].value || '').replace(/[₪,-]/g, '')) || 0
            };
            
            if (inputs[1].value === 'minus') {
              adjustmentData.amount = -Math.abs(adjustmentData.amount);
            }
            
            helper.valuation.adjustments.ownership_type = adjustmentData;
          }
          
          // For ESTIMATE: Store ALL rows (arrays in estimate)
          helper.estimate.adjustments.ownership_type = [];
          ownershipRows.forEach(row => {
            const inputs = row.querySelectorAll('input, select');
            if (inputs.length >= 4) {
              const adjustmentData = {
                description: inputs[0].value || '',
                value: inputs[0].value || '',
                type: inputs[1].value || 'plus',
                percentage: parseFloat(inputs[2].value) || 0,
                percent: parseFloat(inputs[2].value) || 0,
                amount_display: inputs[3].value || '',
                amount: parseFloat((inputs[3].value || '').replace(/[₪,-]/g, '')) || 0
              };
              
              if (inputs[1].value === 'minus') {
                adjustmentData.amount = -Math.abs(adjustmentData.amount);
              }
              
              helper.estimate.adjustments.ownership_type.push(adjustmentData);
            }
          });
        }
        
        // 5. OWNERSHIP HISTORY (NUMBER OF OWNERS) - Write to both valuation source and estimate
        const ownersRows = document.querySelectorAll('#ownersAdjustmentsList > div');
        if (ownersRows.length > 0) {
          // For VALUATION: Only store first row (no arrays in valuation)
          const firstRow = ownersRows[0];
          const inputs = firstRow.querySelectorAll('input, select');
          if (inputs.length >= 4) {
            const adjustmentData = {
              value: inputs[0].value || '', // UI input goes in value field  
              type: inputs[1].value || 'plus',
              percentage: parseFloat(inputs[2].value) || 0,
              percent: parseFloat(inputs[2].value) || 0,
              amount_display: inputs[3].value || '',
              amount: parseFloat((inputs[3].value || '').replace(/[₪,-]/g, '')) || 0
            };
            
            if (inputs[1].value === 'minus') {
              adjustmentData.amount = -Math.abs(adjustmentData.amount);
            }
            
            helper.valuation.adjustments.ownership_history = adjustmentData;
          }
          
          // For ESTIMATE: Store ALL rows (arrays in estimate)
          helper.estimate.adjustments.ownership_history = [];
          ownersRows.forEach(row => {
            const inputs = row.querySelectorAll('input, select');
            if (inputs.length >= 4) {
              const adjustmentData = {
                description: inputs[0].value || '',
                value: inputs[0].value || '',
                type: inputs[1].value || 'plus',
                percentage: parseFloat(inputs[2].value) || 0,
                percent: parseFloat(inputs[2].value) || 0,
                amount_display: inputs[3].value || '',
                amount: parseFloat((inputs[3].value || '').replace(/[₪,-]/g, '')) || 0
              };
              
              if (inputs[1].value === 'minus') {
                adjustmentData.amount = -Math.abs(adjustmentData.amount);
              }
              
              helper.estimate.adjustments.ownership_history.push(adjustmentData);
            }
          });
        }
        
        // 6. ADDITIONAL ADJUSTMENTS (התאמות שוק נוספות) - Write to BOTH estimate AND valuation
        const additionalRows = document.querySelectorAll('#allAdjustmentsList > div');
        console.log('🔍 SAVE DEBUG: Found', additionalRows.length, 'additional rows in UI');
        console.log('🔍 SAVE DEBUG: Rows:', additionalRows);
        if (additionalRows.length > 0) {
          helper.estimate.adjustments.additional = [];
          
          // Also update valuation for first row only (to match other categories)
          let firstAdditionalData = null;
          
          additionalRows.forEach(row => {
            const inputs = row.querySelectorAll('input, select');
            if (inputs.length >= 4) {
              const adjustmentData = {
                description: inputs[0].value || '',
                value: inputs[0].value || '',
                type: inputs[1].value || 'plus',
                percentage: parseFloat(inputs[2].value) || 0,
                percent: parseFloat(inputs[2].value) || 0,
                amount_display: inputs[3].value || '',
                amount: parseFloat((inputs[3].value || '').replace(/[₪,-]/g, '')) || 0
              };
              
              if (inputs[1].value === 'minus') {
                adjustmentData.amount = -Math.abs(adjustmentData.amount);
              }
              
              helper.estimate.adjustments.additional.push(adjustmentData);
              
              // Keep first row for valuation
              if (!firstAdditionalData) {
                firstAdditionalData = adjustmentData;
              }
            }
          });
          
          // Update valuation with first additional adjustment
          if (firstAdditionalData) {
            helper.valuation.adjustments.additional = firstAdditionalData;
          }
        } else {
          // Clear both if no rows
          helper.estimate.adjustments.additional = [];
          if (helper.valuation.adjustments.additional) {
            delete helper.valuation.adjustments.additional;
          }
        }
        
        console.log('✅ Updated ALL FULL MARKET VALUE adjustments to valuation.adjustments AND estimate.adjustments');
        
      } catch (error) {
        console.error('❌ Error updating full market value to valuation and estimate adjustments:', error);
      }
    }

    // Add real-time calculation listeners
    function addCalculationListeners() {
      // Listen to basic price changes
      const basicPriceField = document.getElementById('basicPrice');
      if (basicPriceField) {
        basicPriceField.addEventListener('input', function() {
          // Calculate gross value amounts first with local logic
          if (typeof calculateGrossValueAmounts === 'function') {
            calculateGrossValueAmounts();
          }
          // Then update calculations
          updateGrossMarketValueCalculation();
          // AUTO-SAVE ON EVERY CHANGE
          let helper = autoSaveToHelper();
          // SYNC TO estimate.gross_value_adjustments (third destination)
          if (helper) {
            helper = syncAdjustmentToEstimateHelper(null, 'features', helper) || helper;
            helper = syncAdjustmentToEstimateHelper(null, 'registration', helper) || helper;
            sessionStorage.setItem('helper', JSON.stringify(helper));
            console.log('✅ Synced basic price change to estimate.gross_value_adjustments');
          }
        });
      }
      
      // Listen to total damage cost changes - write to claims_data.total_claim
      const totalDamageCostField = document.getElementById('totalDamageCost');
      if (totalDamageCostField) {
        console.log('✅ Found totalDamageCost field, adding listener');
        totalDamageCostField.addEventListener('input', function() {
          console.log('🔄 totalDamageCost changed to:', this.value);
          // Update claims_data.total_claim when field changes
          try {
            const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
            helper.claims_data = helper.claims_data || {};
            helper.claims_data.total_claim = this.value;
            sessionStorage.setItem('helper', JSON.stringify(helper));
            window.helper = helper;
            console.log('✅ Updated claims_data.total_claim to:', this.value);
            
            // Also trigger percentage calculation
            if (typeof calculateDamagePercentage === 'function') {
              calculateDamagePercentage();
            }
          } catch (error) {
            console.error('Error updating claims_data.total_claim:', error);
          }
        });
      } else {
        console.log('❌ totalDamageCost field not found!');
      }
      
      // Listen to all adjustment input changes
      function addListenersToAdjustmentRows() {
        // Gross market value adjustments
        const allInputs = document.querySelectorAll('#featuresAdjustmentsList input, #registrationAdjustmentsList input, #featuresAdjustmentsList select, #registrationAdjustmentsList select');
        allInputs.forEach(input => {
          input.addEventListener('input', function() {
            // Calculate amounts first with local logic
            if (typeof calculateGrossValueAmounts === 'function') {
              calculateGrossValueAmounts();
            }
            // Then update calculations
            updateGrossMarketValueCalculation();
            // AUTO-SAVE ON EVERY CHANGE
            let helper = autoSaveToHelper();
            // SYNC TO estimate.gross_value_adjustments (third destination)
            if (helper) {
              helper = syncAdjustmentToEstimateHelper(null, 'features', helper) || helper;
              helper = syncAdjustmentToEstimateHelper(null, 'registration', helper) || helper;
              sessionStorage.setItem('helper', JSON.stringify(helper));
              console.log('✅ Synced gross value input changes to estimate.gross_value_adjustments');
            }
          });
          input.addEventListener('change', function() {
            // Calculate amounts first with local logic
            if (typeof calculateGrossValueAmounts === 'function') {
              calculateGrossValueAmounts();
            }
            // Then update calculations
            updateGrossMarketValueCalculation();
            // AUTO-SAVE ON EVERY CHANGE
            let helper = autoSaveToHelper();
            // SYNC TO estimate.gross_value_adjustments (third destination)
            if (helper) {
              helper = syncAdjustmentToEstimateHelper(null, 'features', helper) || helper;
              helper = syncAdjustmentToEstimateHelper(null, 'registration', helper) || helper;
              sessionStorage.setItem('helper', JSON.stringify(helper));
              console.log('✅ Synced gross value change event to estimate.gross_value_adjustments');
            }
          });
        });
        
        // Full market value adjustments - SEPARATE handling for features/registration vs others
        
        // Features and Registration in full market value (write to 3 destinations including gross_value_adjustments)
        const fullMarketFeaturesRegistrationInputs = document.querySelectorAll('#fullFeaturesAdjustmentsList input, #fullRegistrationAdjustmentsList input, #fullFeaturesAdjustmentsList select, #fullRegistrationAdjustmentsList select');
        fullMarketFeaturesRegistrationInputs.forEach(input => {
          input.addEventListener('input', function() {
            // Calculate amounts first with cumulative logic
            if (typeof calculateMarketValueAmounts === 'function') {
              calculateMarketValueAmounts();
            }
            // Then update calculations
            updateFullMarketValueCalculation();
            // AUTO-SAVE ON EVERY CHANGE 
            let helper = autoSaveToHelper();
            
            // ADDITIONAL SYNC specifically for full market features/registration to estimate.gross_value_adjustments
            if (helper) {
              const isFeatures = input.closest('#fullFeaturesAdjustmentsList');
              const isRegistration = input.closest('#fullRegistrationAdjustmentsList');
              
              console.log('🔍 Full market input change detected:', { 
                isFeatures: !!isFeatures, 
                isRegistration: !!isRegistration,
                inputElement: input,
                parentContainer: input.parentElement?.id || input.parentElement?.parentElement?.id,
                closest: {
                  features: input.closest('#fullFeaturesAdjustmentsList')?.id,
                  registration: input.closest('#fullRegistrationAdjustmentsList')?.id
                }
              });
              
              if (isFeatures) {
                console.log('📝 Syncing full market FEATURES to estimate.gross_value_adjustments');
                helper = syncFullMarketValueToEstimateHelper(null, 'features', helper) || helper;
              }
              if (isRegistration) {
                console.log('📅 Syncing full market REGISTRATION to estimate.gross_value_adjustments');
                helper = syncFullMarketValueToEstimateHelper(null, 'registration', helper) || helper;
              }
              
              if (isFeatures || isRegistration) {
                sessionStorage.setItem('helper', JSON.stringify(helper));
                console.log('✅ FULL MARKET VALUE synced to estimate.gross_value_adjustments');
              }
            }
          });
          input.addEventListener('change', function() {
            // Calculate amounts first with cumulative logic
            if (typeof calculateMarketValueAmounts === 'function') {
              calculateMarketValueAmounts();
            }
            // Then update calculations
            updateFullMarketValueCalculation();
            // AUTO-SAVE ON EVERY CHANGE 
            let helper = autoSaveToHelper();
            
            // ADDITIONAL SYNC specifically for full market features/registration to estimate.gross_value_adjustments
            if (helper) {
              const isFeatures = input.closest('#fullFeaturesAdjustmentsList');
              const isRegistration = input.closest('#fullRegistrationAdjustmentsList');
              
              console.log('🔍 Full market input change detected:', { 
                isFeatures: !!isFeatures, 
                isRegistration: !!isRegistration,
                inputElement: input,
                parentContainer: input.parentElement?.id || input.parentElement?.parentElement?.id,
                closest: {
                  features: input.closest('#fullFeaturesAdjustmentsList')?.id,
                  registration: input.closest('#fullRegistrationAdjustmentsList')?.id
                }
              });
              
              if (isFeatures) {
                console.log('📝 Syncing full market FEATURES to estimate.gross_value_adjustments');
                helper = syncFullMarketValueToEstimateHelper(null, 'features', helper) || helper;
              }
              if (isRegistration) {
                console.log('📅 Syncing full market REGISTRATION to estimate.gross_value_adjustments');
                helper = syncFullMarketValueToEstimateHelper(null, 'registration', helper) || helper;
              }
              
              if (isFeatures || isRegistration) {
                sessionStorage.setItem('helper', JSON.stringify(helper));
                console.log('✅ FULL MARKET VALUE synced to estimate.gross_value_adjustments');
              }
            }
          });
        });
        
        // Other full market value adjustments (KM, Ownership, Owners) - original logic
        const fullMarketOtherInputs = document.querySelectorAll('#mileageAdjustmentsList input, #ownershipAdjustmentsList input, #ownersAdjustmentsList input, #mileageAdjustmentsList select, #ownershipAdjustmentsList select, #ownersAdjustmentsList select');
        fullMarketOtherInputs.forEach(input => {
          input.addEventListener('input', function() {
            // Calculate amounts first with cumulative logic
            if (typeof calculateMarketValueAmounts === 'function') {
              calculateMarketValueAmounts();
            }
            // Then update calculations
            updateFullMarketValueCalculation();
            // AUTO-SAVE ON EVERY CHANGE
            autoSaveToHelper();
          });
          input.addEventListener('change', function() {
            // Calculate amounts first with cumulative logic
            if (typeof calculateMarketValueAmounts === 'function') {
              calculateMarketValueAmounts();
            }
            // Then update calculations
            updateFullMarketValueCalculation();
            // AUTO-SAVE ON EVERY CHANGE
            autoSaveToHelper();
          });
        });
      }
      
      addListenersToAdjustmentRows();
      
      // Re-add listeners when new rows are added
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'childList') {
            addListenersToAdjustmentRows();
          }
        });
      });
      
      const featuresContainer = document.getElementById('featuresAdjustmentsList');
      const registrationContainer = document.getElementById('registrationAdjustmentsList');
      
      // Full market value containers
      const fullFeaturesContainer = document.getElementById('fullFeaturesAdjustmentsList');
      const fullRegistrationContainer = document.getElementById('fullRegistrationAdjustmentsList');
      const mileageContainer = document.getElementById('mileageAdjustmentsList');
      const ownershipContainer = document.getElementById('ownershipAdjustmentsList');
      const ownersContainer = document.getElementById('ownersAdjustmentsList');
      
      // Observe gross market value containers
      if (featuresContainer) {
        observer.observe(featuresContainer, { childList: true });
      }
      if (registrationContainer) {
        observer.observe(registrationContainer, { childList: true });
      }
      
      // Observe full market value containers
      if (fullFeaturesContainer) {
        observer.observe(fullFeaturesContainer, { childList: true });
      }
      if (fullRegistrationContainer) {
        observer.observe(fullRegistrationContainer, { childList: true });
      }
      if (mileageContainer) {
        observer.observe(mileageContainer, { childList: true });
      }
      if (ownershipContainer) {
        observer.observe(ownershipContainer, { childList: true });
      }
      if (ownersContainer) {
        observer.observe(ownersContainer, { childList: true });
      }
    }
    
    // Add auto-save listeners to damage center fields
    function addDamageCenterListeners() {
      // Listen to all damage center input changes
      const damageCenterInputs = document.querySelectorAll('input[data-field], textarea[data-field], select[data-field]');
      damageCenterInputs.forEach(input => {
        input.addEventListener('input', function() {
          console.log('🔄 Damage center input changed:', this.getAttribute('data-field'), this.value);
          // Save damage center changes first, then rebuild assessment
          setTimeout(() => {
            saveDamageCenterChanges();
            window.rebuildAssessments();
            console.log('✅ Damage centers synced to assessment');
          }, 100);
        });
        
        input.addEventListener('change', function() {
          console.log('🔄 Damage center changed:', this.getAttribute('data-field'), this.value);
          // Save damage center changes first, then rebuild assessment  
          setTimeout(() => {
            saveDamageCenterChanges();
            window.rebuildAssessments();
            console.log('✅ Damage centers synced to assessment');
          }, 100);
        });
      });
    }

    // Load data when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🚀 Page loaded - loading data from storage');
      try {
        let helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        if (helper && Object.keys(helper).length > 0) {
          console.log('📝 Found helper data:', helper);
          loadGrossAdjustmentsFromHelper(helper);
          // Trigger calculation after loading
          setTimeout(() => {
            updateGrossMarketValueCalculation();
            
            // Sync auto-populated data to gross_value_adjustments
            helper = syncAdjustmentToEstimateHelper(null, 'features', helper) || helper;
            helper = syncAdjustmentToEstimateHelper(null, 'registration', helper) || helper;
            sessionStorage.setItem('helper', JSON.stringify(helper));
            window.helper = helper;
            console.log('✅ Page load: Synced to gross_value_adjustments');
          }, 100);
        } else {
          console.log('ℹ️ No helper data found in storage');
        }
        
        // Add calculation listeners
        addCalculationListeners();
        
        // Add damage center auto-save listeners
        addDamageCenterListeners();
        
      } catch (error) {
        console.error('❌ Error loading data on page load:', error);
      }
    });
  </script>
</body>
</html>