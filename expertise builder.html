<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <style>
    @page { size: A4; margin: 10mm; }
    body{ margin:0; direction:rtl; -webkit-print-color-adjust:exact; print-color-adjust:exact;
          font-family:"Noto Sans Hebrew", Arial, sans-serif; max-width: 210mm; }
    
    /* Ensure watermark shows in PDF */
    @media print {
      -webkit-print-color-adjust: exact !important;
      color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
    .bg{ position:fixed; inset:0; width:100%; height:100%; object-fit:cover; z-index:0; pointer-events:none }
    .page{ position:relative; z-index:1; padding:5mm; width:100%; box-sizing:border-box; }
    
    /* Draft watermark styles */
    .draft-watermark { 
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%) rotate(-45deg); 
      font-size: 80px; 
      color: rgba(255, 0, 0, 0.1); 
      font-weight: bold; 
      z-index: 999; 
      pointer-events: none;
      white-space: nowrap;
    }
  </style>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ירון כיוף שמאות - פורטל - דו"ח אקספרטיזה</title>
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link rel="shortcut icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link rel="apple-touch-icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <style>
    body { 
      font-family: "Noto Sans Hebrew", Arial, sans-serif; 
      margin: 0; 
      padding: 20px; 
      background: white;
      font-size: 14px;
      line-height: 1.4;
    }
    .banner { 
      width: 100%; 
      display: block; 
      margin-bottom: 0;
      padding: 8px 16px;
      box-sizing: border-box;
    }
    h1, h2, h3, h4, h5, h6,
    .business-title,
    .section-title,
    .footer,
    th {
      font-weight: bold;
      color: #1e3a8a !important;
    }
    h1 { 
      text-align: center; 
      font-size: 24px; 
      margin-top: 15px; 
      margin-bottom: 20px;
      font-weight: bold;
      color: #1e3a8a !important;
    }
    .business-title { 
      text-align: center; 
      font-size: 16px; 
      margin-bottom: 20px;
      font-weight: bold;
    }
    .section-title { 
      font-size: 16px; 
      font-weight: bold;
      margin-top: 25px; 
      margin-bottom: 10px;
      border-bottom: 2px solid #1e3a8a; 
      padding-bottom: 5px;
      color: #1e3a8a !important;
    }
    h3 {
      font-size: 15px;
      font-weight: bold;
      margin-top: 15px;
      margin-bottom: 8px;
      color: #1e3a8a !important;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; margin-bottom: 8px; }
    th, td { 
      border: 1px solid #64748b; 
      padding: 8px 10px; 
      text-align: center; 
      vertical-align: middle;
      font-size: 12px;
    }
    th { 
      text-align: center;
      font-weight: bold;
      background: #f8fafc;
      font-size: 12px;
    }
    .table-param {
      font-weight: bold;
      color: #1e3a8a;
      text-align: center !important;
    }
    .table-num {
      font-weight: bold;
      color: #1e3a8a;
      text-align: center !important;
      width: 36px !important;
      min-width: 36px !important;
      max-width: 36px !important;
    }
    /* Bold border for split and outer border */
    .split-border {
      border-right: 3px solid #1e3a8a !important;
    }
    .outer-border, table {
      border: 3px solid #1e3a8a !important;
    }
    th, .header-bottom-bold th {
      border-bottom: 3px solid #1e3a8a !important;
      background: #f8fafc !important;
    }
    .watermark {
      position: fixed;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-30deg);
      font-size: 8rem;
      color: rgba(59, 130, 246, 0.25);
      z-index: 0;
      white-space: normal;
      pointer-events: none;
      font-weight: bold;
      max-width: 70vw;
      width: auto;
      text-align: center;
      line-height: 0.9;
      word-wrap: break-word;
      overflow-wrap: break-word;
      hyphens: auto;
    }
    .paragraph { margin-top: 20px; line-height: 1.6; white-space: pre-line; }
    .signature-img { width: 220px; display: block; }
    .footer { margin-top: 40px; font-size: 18px; }
    .side-header-border {
      border-left: 3px solid #1e3a8a !important;
    }
    .left-bold-border {
      border-left: 3px solid #1e3a8a !important;
    }
    
    /* Control Buttons Styling */
    .control-btn {
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      color: white;
    }
    .control-btn:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transform: translateY(-1px);
    }
    .review-btn {
      background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
    }
    .review-btn:hover {
      background: linear-gradient(135deg, #138496 0%, #1ea085 100%);
    }
    .edit-btn {
      background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
    }
    .edit-btn:hover {
      background: linear-gradient(135deg, #e0a800 0%, #e8690b 100%);
    }
    .preview-btn {
      background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
    }
    .preview-btn:hover {
      background: linear-gradient(135deg, #5a359a 0%, #d91a72 100%);
    }
    .submit-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    .submit-btn:hover {
      background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
    }
    .home-btn {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    }
    .home-btn:hover {
      background: linear-gradient(135deg, #545b62 0%, #3d4142 100%);
    }
    .draft-opinion-btn {
      background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    }
    .draft-opinion-btn:hover {
      background: linear-gradient(135deg, #138496 0%, #10707f 100%);
    }
    .draft-estimate-btn {
      background: linear-gradient(135deg, #fd7e14 0%, #e8690b 100%);
    }
    .draft-estimate-btn:hover {
      background: linear-gradient(135deg, #e8690b 0%, #d35400 100%);
    }
    
    /* A4 Layout and Print Optimization */
    @page {
      size: A4;
      margin: 15mm 20mm 15mm 20mm;
    }
    
    body {
      max-width: 210mm;
      font-size: 14px;
      line-height: 1.4;
    }
    
    /* Page break control */
    .page-break-before {
      page-break-before: always;
    }
    
    .page-break-after {
      page-break-after: always;
    }
    
    .page-break-inside-avoid {
      page-break-inside: avoid;
    }
    
    .keep-together {
      page-break-inside: avoid;
      break-inside: avoid;
    }
    
    /* Print styles */
    @media print {
      .no-print {
        display: none !important;
      }
      
      body {
        font-size: 12px;
        margin: 0;
        padding: 10mm;
        background: white !important;
        color: black !important;
      }
      
      .banner {
        border: 2px solid #d4af37 !important;
        height: 100px !important;
        margin-bottom: 15px !important;
        page-break-inside: avoid;
      }
      
      .watermark {
        font-size: 4rem !important;
        opacity: 0.15 !important;
        color: rgba(220, 38, 38, 0.2) !important;
        display: block !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }
      
      h1 {
        font-size: 18px !important;
        margin-top: 10px !important;
        margin-bottom: 10px !important;
      }
      
      .section-title {
        font-size: 14px !important;
        margin-top: 20px !important;
        margin-bottom: 8px !important;
        page-break-after: avoid;
      }
      
      table {
        margin-bottom: 12px !important;
        page-break-inside: avoid;
      }
      
      th, td {
        padding: 4px 6px !important;
        font-size: 10px !important;
      }
      
      .paragraph {
        margin-top: 15px !important;
        page-break-inside: avoid;
      }
      
      .damage-centers-container > div {
        page-break-inside: avoid;
        margin-bottom: 5px;
      }
      
      .footer {
        page-break-inside: avoid;
        margin-top: 20px !important;
      }
      
      .signature-img {
        width: 120px !important;
        height: auto !important;
      }
      
      /* Smart page breaks - avoid unnecessary breaks */
      .damage-centers-container {
        page-break-before: auto;
        margin-top: 0px !important;
        margin-bottom: 0px !important;
      }
      
      /* Only break before summary if needed */
      .summary-section {
        page-break-before: auto;
        page-break-inside: avoid;
      }
      
      /* Avoid orphaned titles */
      h2, h3, .section-title {
        page-break-after: avoid;
        orphans: 3;
        widows: 3;
      }
    }
    
    /* Screen optimization for better preview */
    @media screen {
      body {
        max-width: 210mm;
        margin: 0 auto;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        background: white;
      }
    }
  </style>
  <script>
    let helper = {};
    
    window.onload = () => {
      loadHelperData();
      populateExpertiseData();
    };
    
    function loadHelperData() {
      try {
        const helperData = sessionStorage.getItem('helper');
        if (helperData) {
          helper = JSON.parse(helperData);
          console.log('Helper data loaded:', helper);
        } else {
          console.warn('No helper data found in sessionStorage');
          helper = {};
        }
      } catch (error) {
        console.error('Error loading helper data:', error);
        helper = {};
      }
    }
    
    function populateExpertiseData() {
      // Update watermark
      const watermark = document.querySelector('.watermark');
      if (watermark && helper.case_info?.status) {
        watermark.textContent = helper.case_info.status;
      }
      
      // Update header info with proper centering
      const headerDate = document.getElementById('header-date');
      const headerPlate = document.getElementById('header-plate');
      if (headerDate && helper.case_info?.inspection_date) {
        headerDate.textContent = formatDate(helper.case_info.inspection_date);
      }
      if (headerPlate && helper.vehicle?.plate) {
        headerPlate.textContent = helper.vehicle.plate;
      }
      
      // Populate main data table
      populateMainDataTable();
      
      // Generate damage centers sections
      generateDamageCenters();
      
      // Update footer signature date
      const signatureDate = document.querySelector('.signature-date');
      if (signatureDate && helper.case_info?.inspection_date) {
        signatureDate.textContent = formatDate(helper.case_info.inspection_date);
      }
      
      // Update final warning plate number
      const warningPlate = document.querySelector('.warning-plate');
      if (warningPlate && helper.vehicle?.plate) {
        warningPlate.textContent = helper.vehicle.plate;
      }
      
      // Update final warning date
      const warningDate = document.querySelector('.warning-date');
      if (warningDate && helper.case_info?.inspection_date) {
        warningDate.textContent = formatDate(helper.case_info.inspection_date);
      }
      
      // Update general assessment section
      updateGeneralAssessment();
      
      // Update additional data mappings
      updateAdditionalMappings();
    }
    
    function populateMainDataTable() {
      const dataFields = {
        'plate-1': helper.vehicle?.plate,
        'plate-2': helper.vehicle?.plate,
        'manufacturer': helper.vehicle?.manufacturer,
        'model': helper.vehicle?.model,
        'trim': helper.vehicle?.trim,
        'chassis': helper.vehicle?.chassis,
        'year': helper.vehicle?.year,
        'km': helper.vehicle?.km,
        'model-type': helper.vehicle?.model_type,
        'damage-date': helper.case_info?.damage_date ? formatDate(helper.case_info.damage_date) : '',
        'inspection-date': helper.case_info?.inspection_date ? formatDate(helper.case_info.inspection_date) : '',
        'model-code': helper.vehicle?.model_code,
        'vehicle-type': helper.vehicle?.vehicle_type || helper.vehicle?.ownership_type,
        'ownership-type': helper.vehicle?.ownership_type,
        'base-price': helper.valuation?.base_price || helper.vehicle?.base_price,
        'owner-name': helper.stakeholders?.owner?.name,
        'owner-address': helper.stakeholders?.owner?.address,
        'owner-phone': helper.stakeholders?.owner?.phone,
        'garage-name': helper.stakeholders?.garage?.name,
        'garage-email': helper.stakeholders?.garage?.email,
        'garage-phone': helper.stakeholders?.garage?.phone,
        'insurance-company': helper.stakeholders?.insurance?.company,
        'insurance-email': helper.stakeholders?.insurance?.email,
        'insurance-agent-name': helper.stakeholders?.insurance?.agent?.name,
        'insurance-agent-phone': helper.stakeholders?.insurance?.agent?.phone,
        'insurance-agent-email': helper.stakeholders?.insurance?.agent?.email,
        'damage-type': helper.case_info?.damage_type || helper.damage_assessment?.summary?.damage_type || 'תאונתי',
        'inspection-location': helper.case_info?.inspection_location || helper.meta?.inspection_location
      };
      
      Object.entries(dataFields).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element && value) {
          element.textContent = value;
        }
      });
    }
    
    function generateDamageCenters() {
      const container = document.querySelector('.damage-centers-container');
      if (!container || !helper.centers || !Array.isArray(helper.centers)) {
        console.warn('No damage centers data found or container missing');
        return;
      }
      
      container.innerHTML = ''; // Clear existing content
      
      // Add general description section first
      const generalDescriptionHtml = createGeneralDescriptionSection();
      container.innerHTML += generalDescriptionHtml;
      
      // Add global alert for all damage centers
      const globalAlertHtml = createGlobalAlert();
      container.innerHTML += globalAlertHtml;
      
      helper.centers.forEach((center, index) => {
        const centerHtml = createDamageCenterSection(center, index);
        container.innerHTML += centerHtml;
      });
      
      // Update summary table
      updateDamageSummaryTable();
    }
    
    function createGeneralDescriptionSection() {
      if (!helper.centers || !Array.isArray(helper.centers)) {
        return '';
      }
      
      // Create list of all locations
      const locations = helper.centers.map(center => center.Location || 'לא צוין');
      const locationsList = locations.map(location => `${location}`).join('\n');
      
      return `
        <div class="keep-together" style="margin: 0; padding: 0; margin-bottom: 1px; page-break-inside: avoid;">
          <table class="outer-border keep-together" style="margin: 0; margin-bottom: 0px;">
            <tbody>
              <tr>
                <td class="table-param left-bold-border" style="width: 25%; font-weight: bold;"><span>תיאור כללי</span></td>
                <td style="text-align: right; padding: 10px; font-size: 16px; line-height: 1.4;">
                  בבדיקת הרכב הנדון נוכחנו בנזקים תאונתיים באיזורים הבאים:<br>
                  <span style="font-weight: bold; color: #1e3a8a; margin: 8px 0; display: block;">${locationsList.replace(/\n/g, '<br>')}</span>
                  כתוצאה מכך, חלקים אלה נמצאו ניזוקים וטעונים תיקון.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      `;
    }
    
    function createGlobalAlert() {
      return `
        <div class="keep-together" style="margin: 0; padding: 0; margin-bottom: 1px; page-break-inside: avoid;">
          <h3 style="font-size: 16px; font-weight: bold; color: #dc2626; margin: 1px 0 0 0; text-decoration: underline; text-align: center;">
            לזמן שמאי לאחר פירוקים ולפני צבע
          </h3>
        </div>
      `;
    }
    
    function createDamageCenterSection(center, index) {
      const centerNumber = center['Damage center Number'] || (index + 1);
      const location = center.Location || 'לא צוין';
      const description = center.Description || '';
      
      return `
        <div class="keep-together" style="margin-bottom: 2px; page-break-inside: avoid; margin-top: 0px;">
          <div style="text-align: right; font-weight: bold; color: #1e3a8a; margin-bottom: 4px; font-size: 17px;">
            מוקד הנזק מספר ${centerNumber} - ${location}
          </div>
          <table class="outer-border keep-together" style="margin-bottom: 15px;">
            <tbody>
              <tr>
                <td class="table-param left-bold-border" style="width: 25%; font-weight: bold;"><span>תיאור כללי</span></td>
                <td style="text-align: right; padding: 10px;">${description || `בבדיקת הרכב הנדון נוכחנו בנזקים תאונתיים באזור ${location} של הרכב. כתוצאה מכך, חלקים אלה נמצאו ניזוקים וטעונים תיקון.`}</td>
              </tr>
            </tbody>
          </table>
          ${generateWorksTable(center.Works)}
          ${generateRepairsTable(center.Repairs)}
          ${generatePartsTable(center.Parts)}
        </div>
      `;
    }
    
    function generateWorksTable(works) {
      if (!works || !works.works || !Array.isArray(works.works) || works.works.length === 0) {
        return '<p style="font-style: italic; color: #666; margin: 15px 0; font-size: 16px;">אין עבודות מוגדרות</p>';
      }
      
      let tableHtml = `
        <h4 style="font-size: 18px; font-weight: bold; color: #1e3a8a; margin: 15px 0 10px 0; text-align: right;">עבודות</h4>
        <table class="outer-border keep-together" style="margin-bottom: 20px; font-size: 16px;">
          <thead class="header-bottom-bold">
            <tr>
              <th class="table-num" style="width: 10%; font-size: 16px; padding: 12px 8px;">מס"ד</th>
              <th class="table-param" style="width: 35%; font-size: 16px; padding: 12px; color: #1e3a8a;">סוג עבודה</th>
              <th class="table-param" style="width: 25%; font-size: 16px; padding: 12px; background: #ffe6e6; color: #dc2626;">עלות משוערת</th>
              <th class="table-param" style="width: 30%; font-size: 16px; padding: 12px; color: #1e3a8a;">תיאור</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      works.works.forEach((work, index) => {
        const rowNum = index + 1;
        const category = work.category || '';
        const comments = work.comments || '';
        const cost = work.cost || 0;
        
        tableHtml += `
          <tr>
            <td class="table-num" style="font-size: 16px; padding: 10px; text-align: center;">${rowNum}</td>
            <td style="text-align: right; padding: 10px; font-size: 16px; font-weight: 500;">${category}</td>
            <td style="text-align: center; padding: 10px; font-size: 16px; font-weight: bold; color: #dc2626;">${cost} ₪</td>
            <td style="text-align: right; padding: 10px; font-size: 16px;">${comments}</td>
          </tr>
        `;
      });
      
      tableHtml += '</tbody></table>';
      return tableHtml;
    }
    
    function generateRepairsTable(repairs) {
      if (!repairs || !repairs.repairs || !Array.isArray(repairs.repairs) || repairs.repairs.length === 0) {
        return '<p style="font-style: italic; color: #666; margin: 15px 0; font-size: 16px;">אין תיקונים מוגדרים</p>';
      }
      
      let tableHtml = `
        <h4 style="font-size: 18px; font-weight: bold; color: #1e3a8a; margin: 15px 0 10px 0; text-align: right;">תיקונים</h4>
        <table class="outer-border keep-together" style="margin-bottom: 20px; font-size: 16px;">
          <thead>
            <tr>
              <th class="table-num" style="width: 10%; font-size: 16px; padding: 12px 8px;">מס"ד</th>
              <th class="table-param" style="width: 35%; font-size: 16px; padding: 12px; color: #1e3a8a;">שם התיקון</th>
              <th class="table-param" style="width: 25%; font-size: 16px; padding: 12px; background: #ffe6e6; color: #dc2626;">עלות משוערת</th>
              <th class="table-param" style="width: 30%; font-size: 16px; padding: 12px; color: #1e3a8a;">תיאור עלות</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      repairs.repairs.forEach((repair, index) => {
        const rowNum = index + 1;
        const name = repair.name || '';
        const description = repair.description || '';
        const cost = repair.cost || 0;
        
        tableHtml += `
          <tr>
            <td class="table-num" style="font-size: 16px; padding: 10px; text-align: center;">${rowNum}</td>
            <td style="text-align: right; padding: 10px; font-size: 16px; font-weight: 500;">${name}</td>
            <td style="text-align: center; padding: 10px; font-size: 16px; font-weight: bold; color: #dc2626;">${cost} ₪</td>
            <td style="text-align: right; padding: 10px; font-size: 16px;">${description}</td>
          </tr>
        `;
      });
      
      tableHtml += '</tbody></table>';
      return tableHtml;
    }
    
    function generatePartsTable(parts) {
      if (!parts || !parts.parts_required || !Array.isArray(parts.parts_required) || parts.parts_required.length === 0) {
        return '<p style="font-style: italic; color: #666; margin: 15px 0; font-size: 16px;">אין חלקים מוגדרים</p>';
      }
      
      let tableHtml = `
        <h4 style="font-size: 18px; font-weight: bold; color: #1e3a8a; margin: 15px 0 10px 0; text-align: right;">חלקים</h4>
        <table class="outer-border keep-together" style="margin-bottom: 20px; font-size: 16px;">
          <thead>
            <tr>
              <th class="table-num" style="width: 10%; font-size: 16px; padding: 12px 8px;">מס"ד</th>
              <th class="table-param" style="width: 25%; font-size: 16px; padding: 12px; color: #1e3a8a;">שם החלק</th>
              <th class="table-param" style="width: 20%; font-size: 16px; padding: 12px; background: #ffe6e6; color: #dc2626;">עלות משוערת</th>
              <th class="table-param" style="width: 20%; font-size: 16px; padding: 12px; color: #1e3a8a;">מקור</th>
              <th class="table-param" style="width: 25%; font-size: 16px; padding: 12px; color: #1e3a8a;">תיאור</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      parts.parts_required.forEach((part, index) => {
        const rowNum = index + 1;
        const name = part.name || '';
        const description = part.תיאור || part.description || '';
        const source = part.source || '';
        const price = part.מחיר || part.price || '';
        
        tableHtml += `
          <tr>
            <td class="table-num" style="font-size: 16px; padding: 10px; text-align: center;">${rowNum}</td>
            <td style="text-align: right; padding: 10px; font-size: 16px; font-weight: 500;">${name}</td>
            <td style="text-align: center; padding: 10px; font-size: 16px; font-weight: bold; color: #dc2626;">${price}</td>
            <td style="text-align: center; padding: 10px; font-size: 16px;">${source}</td>
            <td style="text-align: right; padding: 10px; font-size: 16px;">${description}</td>
          </tr>
        `;
      });
      
      tableHtml += '</tbody></table>';
      return tableHtml;
    }
    
    function updateDamageSummaryTable() {
      const summaryContainer = document.querySelector('.damage-summary-table');
      if (!summaryContainer || !helper.centers) return;
      
      let summaryHtml = '';
      let totalParts = 0, totalWorks = 0, totalRepairs = 0, totalWithVat = 0;
      
      helper.centers.forEach((center, index) => {
        const centerNumber = center['Damage center Number'] || (index + 1);
        const location = center.Location || 'לא צוין';
        const description = center.Description || '';
        const summary = center.Summary || {};
        
        const partsTotal = summary['Total parts'] || 0;
        const worksTotal = summary['Total works'] || 0;
        const repairsTotal = summary['Total repairs'] || 0;
        const centerTotal = summary['Total with VAT'] || 0;
        
        totalParts += partsTotal;
        totalWorks += worksTotal;
        totalRepairs += repairsTotal;
        totalWithVat += centerTotal;
        
        summaryHtml += `
          <tr>
            <td class="table-num">${centerNumber}</td>
            <td class="table-param">${location} - ${description}</td>
            <td>${partsTotal} ₪</td>
            <td>${worksTotal} ₪</td>
            <td>${repairsTotal} ₪</td>
            <td style="font-weight: bold; color: #1e3a8a;">${centerTotal} ₪</td>
          </tr>
        `;
      });
      
      // Calculate subtotals without VAT
      const totalBeforeVat = totalParts + totalWorks + totalRepairs;
      const vatAmount = Math.round(totalBeforeVat * 0.17);
      const totalWithVatCalculated = totalBeforeVat + vatAmount;
      
      summaryHtml += `
        <tr style="background: #f1f5f9; border-top: 1px solid #e2e8f0;">
          <td colspan="2" class="table-param" style="font-weight: bold; text-align: center;">סה"כ ללא מע"מ</td>
          <td style="font-weight: bold; color: #1e3a8a;">${totalParts} ₪</td>
          <td style="font-weight: bold; color: #1e3a8a;">${totalWorks} ₪</td>
          <td style="font-weight: bold; color: #1e3a8a;">${totalRepairs} ₪</td>
          <td style="font-weight: bold; color: #dc2626;">${totalBeforeVat} ₪</td>
        </tr>
        <tr style="background: #f1f5f9;">
          <td colspan="5" class="table-param" style="font-weight: bold; text-align: center;">מע"מ (17%)</td>
          <td style="font-weight: bold; color: #dc2626;">${vatAmount} ₪</td>
        </tr>
        <tr style="background: #1e3a8a; border-top: 2px solid #1e3a8a;">
          <td colspan="5" class="table-param" style="font-weight: bold; text-align: center; color: white;">סה"כ כולל מע"מ</td>
          <td style="font-weight: bold; color: white; font-size: 18px;">${totalWithVatCalculated} ₪</td>
        </tr>
      `;
      
      summaryContainer.innerHTML = summaryHtml;
      
      // Update financial summary
      updateFinancialSummary();
    }
    
    function updateFinancialSummary() {
      // Calculate totals from centers if financials not available
      let centersCount = 0;
      let totalParts = 0;
      let totalWorks = 0;
      let totalRepairs = 0;
      let totalWithVat = 0;
      
      if (helper.centers && Array.isArray(helper.centers)) {
        centersCount = helper.centers.length;
        helper.centers.forEach(center => {
          const summary = center.Summary || {};
          totalParts += parseFloat(summary['Total parts']) || 0;
          totalWorks += parseFloat(summary['Total works']) || 0;
          totalRepairs += parseFloat(summary['Total repairs']) || 0;
          totalWithVat += parseFloat(summary['Total with VAT']) || 0;
        });
      }
      
      const elements = {
        'centers-count': centersCount,
        'before-tax': helper.financials?.totals?.before_tax || (totalWithVat / 1.17), // Estimate before tax
        'vat-amount': helper.financials?.taxes?.vat_amount || (totalWithVat - (totalWithVat / 1.17)), // Estimate VAT
        'after-tax': helper.financials?.totals?.after_tax || totalWithVat
      };
      
      Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
          if (id === 'centers-count') {
            element.textContent = value;
          } else {
            element.textContent = Math.round(value) + ' ₪';
          }
        }
      });
    }
    
    function updateGeneralAssessment() {
      // Update assessment notes - try multiple possible paths
      const assessmentNotes = document.getElementById('assessment-notes');
      if (assessmentNotes) {
        const notes = helper.damage_assessment?.summary?.assessment_notes || 
                     helper.assessment?.notes || 
                     'בבדיקת הרכב נמצאו נזקים תאונתיים הדורשים תיקון על פי הפירוט לעיל.';
        assessmentNotes.textContent = notes;
      }
      
      
      // Update status
      const statusText = document.getElementById('status-text');
      if (statusText) {
        const status = helper.expertise?.summary?.status || helper.case_info?.status || 'בתהליך';
        statusText.textContent = status;
      }
      
      // Update technician info
      const technicianInfo = document.getElementById('technician-info');
      if (technicianInfo) {
        const technician = helper.expertise?.summary?.technician || 'ירון כיוף';
        const license = helper.expertise?.summary?.license || '1097';
        technicianInfo.textContent = `${technician} - רישיון ${license}`;
      }
      
      // Update directive from helper.expertise.summary
      const directiveText = document.getElementById('directive-text');
      if (directiveText) {
        const directive = helper.expertise?.summary?.directive || 'לתיקון';
        directiveText.textContent = directive;
      }
      
      // Update additional notes (show only if exists)
      const additionalNotes = document.getElementById('additional-notes');
      const additionalNotesContent = document.getElementById('additional-notes-content');
      if (helper.expertise?.summary?.notes) {
        additionalNotes.style.display = 'block';
        additionalNotesContent.textContent = helper.expertise.summary.notes;
      } else {
        additionalNotes.style.display = 'none';
      }
    }
    
    function updateAdditionalMappings() {
      // Update watermark with directive and dynamic sizing
      const watermark = document.querySelector('.watermark');
      if (watermark) {
        const directive = helper.expertise?.summary?.directive || 'לתיקון';
        watermark.textContent = directive;
        
        // Dynamic font sizing based on text length and word count
        const textLength = directive.length;
        const wordCount = directive.split(' ').length;
        let fontSize = '8rem';
        
        // More aggressive sizing for longer text
        if (wordCount >= 5 || textLength > 25) {
          fontSize = '4rem';
        } else if (wordCount >= 4 || textLength > 20) {
          fontSize = '5rem';
        } else if (wordCount >= 3 || textLength > 15) {
          fontSize = '6rem';
        } else if (textLength > 10) {
          fontSize = '7rem';
        }
        
        watermark.style.fontSize = fontSize;
      }
    }
    
    function formatDate(dateString) {
      if (!dateString) return '';
      try {
        const date = new Date(dateString);
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } catch (error) {
        return dateString;
      }
    }

    
    // Control button functions
    window.editExpertise = function() {
      if (confirm('האם ברצונך לערוך את נתוני האקספירטיזה? זה יחזיר אותך לדף האימות.')) {
        // Go back to validation page where user can edit data
        window.location.href = 'expertise-validation.html';
      }
    };

    window.printPreview = function() {
      // Hide control buttons before printing
      const controlSection = document.querySelector('.no-print');
      if (controlSection) {
        controlSection.style.display = 'none';
      }
      
      // Add print-specific title
      const originalTitle = document.title;
      const plateNumber = helper.vehicle?.plate || 'ללא מספר';
      document.title = `אקספרטיזה - ${plateNumber}`;
      
      // Print
      window.print();
      
      // Restore original state
      document.title = originalTitle;
      if (controlSection) {
        controlSection.style.display = '';
      }
    };

    window.submitFinalExpertise = function() {
      console.log('🔄 Starting submit process...');
      
      if (confirm('האם אתה בטוח שברצונך לשלוח את האקספירטיזה הסופית? לא יהיה ניתן לערוך לאחר מכן.')) {
        try {
          console.log('⏱️ Getting helper data...');
          const currentHelper = JSON.parse(sessionStorage.getItem('helper') || '{}');
          console.log('✅ Helper data loaded, size:', JSON.stringify(currentHelper).length);
          
          console.log('⏱️ Creating optimized payload...');
          
          // Create optimized payload without duplicates
          const payload = {
            // Core webhook fields
            plate: currentHelper.car_details?.plate || currentHelper.vehicle?.plate || currentHelper.meta?.plate || 'unknown',
            action: 'LAUNCH_EXPERTISE',
            submittedAt: new Date().toISOString(),
            callbackUrl: null,
            
            // PROTECTED SECTIONS - Send as-is (source of truth)
            car_details: currentHelper.car_details || {},
            case_info: currentHelper.case_info || {},
            centers: currentHelper.centers || [],
            current_damage_center: currentHelper.current_damage_center || {},
            damage_assessment: currentHelper.damage_assessment || {},
            damage_info: currentHelper.damage_info || {},
            expertise: currentHelper.expertise || {},
            general: currentHelper.general || {},
            levisummary: currentHelper.levisummary || {},
            meta: currentHelper.meta || {},
            parts_search: currentHelper.parts_search || {},
            raw_webhook_data: currentHelper.raw_webhook_data || {},
            stakeholders: currentHelper.stakeholders || {},
            valuation: currentHelper.valuation || {},
            vehicle: currentHelper.vehicle || {},
            
            // OTHER SECTIONS - Evaluate for importance
            calculations: currentHelper.calculations || {},
            documents: currentHelper.documents || {},
            estimate: currentHelper.estimate || {},
            final_report: currentHelper.final_report || {},
            levi_data: currentHelper.levi_data || {},
            
            // SKIP DUPLICATE/REDUNDANT SECTIONS
            // Skip: system sections, duplicated vehicle data, technical fields
            // Note: Complete helper object NOT included to avoid duplicates
          };
          
          console.log('✅ Payload created:', payload);
        
          console.log('⏱️ Sending multiple webhooks...');
          
          // Import and use sendToWebhook for multiple webhooks
          import('./webhook.js').then(({ sendToWebhook }) => {
            console.log('✅ Webhook module loaded');
            
            // Prepare different payloads for each webhook
            const htmlContent = document.documentElement.outerHTML;
            const htmlPayload = {
              plate: payload.plate,
              action: 'EXPERTISE_HTML',
              submittedAt: new Date().toISOString(),
              html: htmlContent,
              case_id: payload.meta?.case_id || `YC-${payload.plate}-2025`,
              callbackUrl: null
            };
            
            const helperExportPayload = {
              ...payload,
              action: 'HELPER_EXPORT',
              export_type: 'expertise_submission',
              backup_timestamp: new Date().toISOString(),
              callbackUrl: null
            };
            
            // Send all 3 webhooks sequentially for better reliability
            console.log('📤 1/3 Sending EXPERTISE_HTML...');
            return sendToWebhook('EXPERTISE_HTML', htmlPayload)
              .then(() => {
                console.log('✅ 1/3 EXPERTISE_HTML sent successfully');
                console.log('📤 2/3 Sending LAUNCH_EXPERTISE...');
                return sendToWebhook('LAUNCH_EXPERTISE', payload);
              })
              .then(() => {
                console.log('✅ 2/3 LAUNCH_EXPERTISE sent successfully');
                console.log('📤 3/3 Sending HELPER_EXPORT...');
                return sendToWebhook('HELPER_EXPORT', helperExportPayload);
              })
              .then(() => {
                console.log('✅ 3/3 HELPER_EXPORT sent successfully');
                console.log('🎉 All 3 webhooks sent successfully');
                return { success: true, webhooks_sent: 3 };
              });
          })
          .then(() => {
            console.log('✅ All webhooks completed successfully');
            alert('האקספירטיזה נשלחה בהצלחה! (3 webhooks sent)');
          })
          .catch((error) => {
            console.error('❌ Webhook sequence failed:', error);
            alert('שגיאה בשליחה: ' + error.message);
          });
          
        } catch (error) {
          console.error('❌ Submit process failed:', error);
          alert('שגיאה בעיבוד הנתונים: ' + error.message);
        }
      }
    };

    window.viewDraftOpinion = function() {
      // Navigate to final report template builder for draft opinion
      window.location.href = 'final-report-template-builder.html';
    };

    window.viewDraftEstimate = function() {
      // Navigate to estimate report builder for draft estimate
      window.location.href = 'estimate-report-builder.html';
    };
  </script>
<script type="module" src="./expertise.js"></script>

</head>
<body>
  <img class="bg" src="https://157.90.125.220:8080/assets/bg-report.png" alt="">
  <div class="page">
  <div class="banner" style="border: 4px solid #d4af37; padding: 8px 12px; background-color: #fff8e1; text-align: center; position: relative; min-height: 100px; display: flex; align-items: center; justify-content: space-between; box-sizing: border-box;">
    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0 8px;">
      <div style="font-size: 24px; font-weight: bold; margin-bottom: 4px; line-height: 1.1;">ירון כיוף - שמאות והערכת נזקי רכב ורכוש / רישיון מס. 1097</div>
      <div style="font-size: 16px; font-weight: bold; margin-bottom: 2px;">עוספיא, רח' אבא חושי, מיקוד 30090, ת.ד. 3051</div>
      <div style="font-size: 16px; font-weight: bold; direction: ltr;">office@yc-shamaut.co.il</div>
    </div>
    <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp"
         alt="Logo"
         style="height: 80px; margin-left: 12px; display: block; flex-shrink: 0;">
  </div>

  <div class="watermark">סטטוס</div>

  <h1>דו"ח אקספרטיזה</h1>

  <p class="header-info" style="font-size:16px; font-weight: bold; color: #1e3a8a; text-align: center; margin: 20px 0;">
    תאריך בדיקה: <span id="header-date"></span> | מספר רכב: <span id="header-plate" style="color: #dc2626; font-weight: bold;"></span>
  </p>

  <table class="outer-border keep-together">
    <thead>
      <tr>
        <th class="table-num"><span>מס"ד</span></th>
        <th colspan="2">נתוני רכב</th>
        <th class="table-num split-border"><span>מס"ד</span></th>
        <th colspan="2">פרטי התקשרות</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="table-num">1</td><td class="table-param">מספר רכב</td><td id="plate-1"></td>
        <td class="table-num split-border">15</td><td class="table-param">שם בעל הרכב</td><td id="owner-name"></td>
      </tr>
      <tr>
        <td class="table-num">2</td><td class="table-param">שם היצרן</td><td id="manufacturer"></td>
        <td class="table-num split-border">16</td><td class="table-param">כתובת</td><td id="owner-address"></td>
      </tr>
      <tr>
        <td class="table-num">3</td><td class="table-param">דגם</td><td id="model"></td>
        <td class="table-num split-border">17</td><td class="table-param">טלפון</td><td id="owner-phone"></td>
      </tr>
      <tr>
        <td class="table-num">4</td><td class="table-param">רמת גימור</td><td id="trim"></td>
        <td class="table-num split-border">18</td><td class="table-param">מוסך</td><td id="garage-name"></td>
      </tr>
      <tr>
        <td class="table-num">5</td><td class="table-param">מספר שילדה</td><td id="chassis"></td>
        <td class="table-num split-border">19</td><td class="table-param">אימייל מוסך</td><td id="garage-email"></td>
      </tr>
      <tr>
        <td class="table-num">6</td><td class="table-param">שנת ייצור</td><td id="year"></td>
        <td class="table-num split-border">20</td><td class="table-param">טלפון מוסך</td><td id="garage-phone"></td>
      </tr>
      <tr>
        <td class="table-num">7</td><td class="table-param">מד אוץ</td><td id="km"></td>
        <td class="table-num split-border">21</td><td class="table-param">חברת ביטוח</td><td id="insurance-company"></td>
      </tr>
      <tr>
        <td class="table-num">8</td><td class="table-param">סוג הדגם</td><td id="model-type"></td>
        <td class="table-num split-border">22</td><td class="table-param">אימייל חברת ביטוח</td><td id="insurance-email"></td>
      </tr>
      <tr>
        <td class="table-num">9</td><td class="table-param">תאריך הנזק</td><td id="damage-date"></td>
        <td class="table-num split-border">23</td><td class="table-param">סוכן ביטוח</td><td id="insurance-agent-name"></td>
      </tr>
      <tr>
        <td class="table-num">10</td><td class="table-param">תאריך בדיקה</td><td id="inspection-date"></td>
        <td class="table-num split-border">24</td><td class="table-param">טלפון סוכן ביטוח</td><td id="insurance-agent-phone"></td>
      </tr>
      <tr>
        <td class="table-num">11</td><td class="table-param">קוד דגם</td><td id="model-code"></td>
        <td class="table-num split-border">25</td><td class="table-param">אימייל סוכן ביטוח</td><td id="insurance-agent-email"></td>
      </tr>
      <tr>
        <td class="table-num">12</td><td class="table-param">סוג הרכב</td><td id="vehicle-type"></td>
        <td class="table-num split-border">26</td><td class="table-param">סוג נזק</td><td id="damage-type"></td>
      </tr>
      <tr>
        <td class="table-num">13</td><td class="table-param">סוג בעלות</td><td id="ownership-type"></td>
        <td class="table-num split-border">27</td><td class="table-param">מקום בדיקה</td><td id="inspection-location"></td>
      </tr>
      <tr>
        <td class="table-num">14</td><td class="table-param">מחיר בסיס</td><td id="base-price"></td>
        <td class="table-num split-border">28</td><td class="table-param"></td><td></td>
      </tr>
    </tbody>
  </table>

  <div class="paragraph">
    <h2 class="section-title">מפרט תיקון - הערכת נזק (מבלי לפגוע בזכויות)</h2>
    <div class="damage-centers-container">
      <!-- Damage centers will be populated by JavaScript -->
    </div>
  </div>

  <!-- Multi-Damage Centers Summary -->
  <div class="paragraph summary-section">
    <h2 class="section-title" style="font-size: 16px; text-align: center; color: #dc2626; font-weight: bold;">סיכום כלל מוקדי הנזק</h2>
    <table class="outer-border keep-together">
      <thead class="header-bottom-bold">
        <tr>
          <th class="table-num"><span>מס"ד</span></th>
          <th class="table-param">מוקד נזק</th>
          <th class="table-param">סה"כ חלקים</th>
          <th class="table-param">סה"כ עבודות</th>
          <th class="table-param">סה"כ תיקונים</th>
          <th class="table-param">סה"כ ערך מוקד</th>
        </tr>
      </thead>
      <tbody class="damage-summary-table">
        <!-- Summary rows will be populated by JavaScript -->
      </tbody>
    </table>
    
    <div style="margin-top: 15px; padding: 12px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px;">
      <div style="font-weight: bold; color: #1e3a8a; margin-bottom: 8px; font-size: 22px;">פירוט נוסף:</div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 16px;">
        <div><strong>מספר מוקדי נזק:</strong> <span id="centers-count"></span></div>
        <div><strong>סכום נזקים ללא מע"מ:</strong> <span id="before-tax"></span></div>
        <div><strong>מע"מ:</strong> <span id="vat-amount"></span></div>
        <div><strong>סכום נזקים כולל מע"מ:</strong> <span id="after-tax"></span></div>
      </div>
    </div>
  </div>

  <div class="paragraph page-break-inside-avoid">
    <h2 class="section-title" style="font-size: 24px; font-weight: bold; text-align: center;">הערכה כללית</h2>
    <p id="assessment-notes" style="font-size: 20px; line-height: 1.6; margin: 15px 0; text-align: justify;"></p>
    <div style="text-align: center; margin: 20px 0;">
      <div style="background: #f8fafc; padding: 10px 15px; border-radius: 8px; border: 2px solid #e2e8f0; display: inline-block; min-width: 300px; max-width: 95%; word-wrap: break-word; white-space: normal;">
      <p style="margin: 6px 0; font-size: 18px; text-align: center;">
        <span style="font-weight:bold; color:#1e3a8a;">הנחיית תיק:</span>
        <span style="font-weight:bold; color:#dc2626; font-size: 22px;" id="directive-text"></span>
      </p>
      <p id="additional-notes" style="margin: 8px 0; font-size: 17px; display: none; white-space: normal; word-wrap: break-word; line-height: 1.4;">
        <span style="font-weight:bold; color:#1e3a8a;">הערות נוספות:</span>
        <span style="font-weight:bold; color:#000;" id="additional-notes-content"></span>
      </p>
      <p style="margin: 8px 0; font-size: 17px;">
        <span style="font-weight:bold; color:#1e3a8a;">שמאי:</span>
        <span style="font-weight:bold; color:#000;" id="technician-info"></span>
      </p>
      </div>
    </div>
  </div>

  <div class="paragraph page-break-inside-avoid">
    <h2 class="section-title" style="font-size: 24px; font-weight: bold; text-align: center;">הצהרה</h2>
    <div style="background: #ffcccc; border: 1px solid #ccc; padding: 6px 12px; font-weight: bold; text-align: center; font-size: 16px; margin: 12px 0;">
      כדי למנוע אי הבנה - שים לב להערות הר״מ:
    </div>
    <div style="border: 2px solid #475569; padding: 8px 15px; background: #f8fafc; margin-top: 8px; border-radius: 6px;">
      <ol style="margin: 0; padding-right: 20px; font-size: 16px; line-height: 1.5;">
        <li style="margin-bottom: 6px;">יש להודיע לשמאי על כל נזק נוסף.</li>
        <li style="margin-bottom: 6px;">הצעת תיקון זו כפופה לעיון בטופס התביעה.</li>
        <li style="margin-bottom: 6px;">החלקים שיפורקו מהרכב יעמדו לרשות חברת הביטוח.</li>
        <li style="margin-bottom: 6px;">הצעה זו אינה מחייבת את חברת הביטוח לתשלום כלשהו.</li>
      </ol>
    </div>
  </div>

  <!-- Control Buttons Section (moved from summary page) -->
  <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin: 30px 0; border: 2px solid #e2e8f0; text-align: center; page-break-inside: avoid;" class="no-print">
    <h3 style="color: #1e3a8a; margin-bottom: 15px;">פעולות על הדו"ח</h3>
    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ffeaa7;">
      <strong>הודעה חשובה:</strong> לאחר אישור סופי ושליחה תיסגר האקספירטיזה, יישלח אימייל למוסך ותיווצר חוות דעת סופית לרכב מס׳ <strong class="warning-plate"></strong> בתאריך <strong class="warning-date"></strong>.
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 15px;">
      <button type="button" class="control-btn edit-btn" onclick="editExpertise()">
        ✏️ עריכת נתונים
      </button>
      <button type="button" class="control-btn preview-btn" onclick="printPreview()">
        🖨️ תצוגה מקדימה להדפסה
      </button>
      <button type="button" class="control-btn submit-btn" onclick="submitFinalExpertise()">
        📤 אישור סופי ושליחה
      </button>
      <button type="button" class="control-btn home-btn" onclick="window.location.href='selection.html'">
        🏠 חזור לדף הבחירה
      </button>
      <button type="button" class="control-btn draft-opinion-btn" onclick="viewDraftOpinion()">
        📄 צפייה בחוות דעת טיוטה
      </button>
      <button type="button" class="control-btn draft-estimate-btn" onclick="viewDraftEstimate()">
        📊 צפייה באומדן טיוטה
      </button>
    </div>
  </div>

  <div class="footer page-break-inside-avoid">
    <div style="text-align: center; font-weight: bold; margin-bottom: 40px; font-size: 20px;">בכבוד רב,</div>
    <div style="display: flex; flex-direction: row-reverse; align-items: flex-start; justify-content: space-between;">
      <div>
        <img src="https://carmelcayouf.com/wp-content/uploads/2025/04/yaron-signature-transparent-.webp" class="signature-img" alt="חתימה" style="width: 180px; height: auto;">
        <div class="signature-date" style="font-size: 16px; font-weight: bold; margin-top: 8px; text-align: center;"></div>
      </div>
      <div>
        <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp"
             alt="Logo"
             style="height: 120px; margin-left: 0; margin-right: 16px; display: block;">
      </div>
    </div>
    <div style="text-align: center; font-size: 14px; color: #64748b; margin-top: 20px; border-top: 1px solid #e2e8f0; padding-top: 15px; font-weight: bold;">
      כל הזכויות שמורות © ירון כיוף - שמאות והערכת נזקי רכב ורכוש
    </div>
  </div>
  
  <!-- Floating screens integration -->
  <script src="car-details-floating.js"></script>
  <script src="levi-floating.js"></script>
  <script src="parts-search-results-floating.js"></script>
  <script src="internal-browser.js"></script>
  </div>
</body>
</html>
