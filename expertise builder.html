<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&display=swap');
    
    @page { size: A4; margin: 0; }
    body{ margin:0; direction:rtl; -webkit-print-color-adjust:exact; print-color-adjust:exact;
          font-family:'Heebo', 'Segoe UI', Tahoma, Arial, sans-serif; }
    
    /* Ensure watermark shows in PDF */
    @media print {
      -webkit-print-color-adjust: exact !important;
      color-adjust: exact !important;
      print-color-adjust: exact !important;
      
      /* Force all table borders to show when printing */
      table, .outer-border {
        border: 3px solid #1e3a8a !important;
        border-top: 3px solid #1e3a8a !important;
        border-bottom: 3px solid #1e3a8a !important;
        border-left: 3px solid #1e3a8a !important;
        border-right: 3px solid #1e3a8a !important;
      }
      
      th, td {
        border: 1px solid #aaa !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
    }
    .bg{ position:fixed; inset:0; width:100%; height:100%; object-fit:cover; z-index:0; pointer-events:none }
    .page{ position:relative; z-index:1; padding:25mm 15mm 20mm 15mm; }
    
    /* Draft watermark styles */
    .draft-watermark { 
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%) rotate(-45deg); 
      font-size: 80px; 
      color: rgba(255, 0, 0, 0.1); 
      font-weight: bold; 
      z-index: 999; 
      pointer-events: none;
      white-space: nowrap;
    }
  </style>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×¤×•×¨×˜×œ - ×“×•"×— ××§×¡×¤×¨×˜×™×–×”</title>
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link rel="shortcut icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link rel="apple-touch-icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <style>
    /* Clean Modern Professional Styling - Built from Scratch */
    body {
      font-family: 'Heebo', 'Segoe UI', Tahoma, Arial, sans-serif;
      direction: rtl;
      margin: 0;
      padding: 0;
      font-weight: 400;
    }
    
    h1, h2, h3 {
      color: #1e3a8a;
      font-family: 'Heebo', 'Segoe UI', Tahoma, Arial, sans-serif;
      font-weight: 600;
    }
    
    h1 {
      font-size: 28px;
      font-weight: 700;
      text-align: center;
      margin: 20px 0 25px 0;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      letter-spacing: -0.5px;
    }
    
    h2 {
      font-size: 20px;
      font-weight: 600;
      margin: 25px 0 15px 0;
      border-right: 4px solid #3b82f6;
      padding-right: 12px;
    }
    
    table {
      width: 100%;
      max-width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
      border: 3px solid #1e3a8a !important;
      border-color: #1e3a8a !important;
      table-layout: fixed;
      background: white;
    }
    
    table + table {
      margin-top: 10px;
    }
    
    th, td {
      padding: 8px;
      text-align: right;
      border: 1px solid #aaa;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    th {
      color: #1e3a8a !important;
      background: #fff8e1 !important;
      border-bottom: 3px solid #1e3a8a !important;
      text-align: center !important;
    }
    
    td {
      background: white;
    }
    
    .section {
      margin-bottom: 20px;
      page-break-inside: avoid;
    }
    
    .section:not(:first-child) {
      margin-top: 15px;
    }
    
    .car-details {
      background: white;
      border: 2px solid #3b82f6;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.1);
      transition: all 0.3s ease;
    }
    
    .car-details-title {
      color: #1e3a8a;
      font-weight: 700;
      font-size: 22px;
      text-align: center;
      margin-bottom: 20px;
      font-family: 'Heebo', 'Segoe UI', Tahoma, Arial, sans-serif;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      letter-spacing: -0.3px;
    }
    
    .car-details-table {
      width: 100%;
      border: none;
      font-size: 16px;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .car-details-table td {
      padding: 12px 16px;
      border-bottom: 1px solid #f1f5f9;
      font-weight: 500;
      background: white;
    }
    
    .car-details-table tr:nth-child(even) td {
      background: #f8fafc;
    }
    
    .car-details-table tr:hover td {
      background: #e0f2fe;
    }
    
    .intellectual-box {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 20px;
      font-size: 16px;
      font-weight: 600;
      margin: 20px 0;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15);
      font-family: 'Heebo', 'Segoe UI', Tahoma, Arial, sans-serif;
      color: #1e3a8a;
    }
    
    .signature-stamp {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 40px;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      border: 1px solid #e2e8f0;
    }
    
    .signature-stamp img {
      height: 120px;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
    }
    
    .signature-stamp .center-text {
      flex-grow: 1;
      text-align: center;
      font-size: 20px;
      font-weight: 700;
      color: #1e3a8a;
      font-family: 'Heebo', 'Segoe UI', Tahoma, Arial, sans-serif;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Keep essential expertise-specific classes */
    .table-param {
      font-weight: bold;
      color: #1e3a8a;
      text-align: center !important;
    }
    
    .table-num {
      font-weight: bold;
      color: #1e3a8a;
      text-align: center !important;
      width: 36px !important;
      min-width: 36px !important;
      max-width: 36px !important;
    }
    
    .split-border {
      border-right: 3px solid #1e3a8a !important;
    }
    
    .outer-border, table {
      border: 3px solid #1e3a8a !important;
      border-color: #1e3a8a !important;
    }
    
    /* Override any browser defaults or conflicting styles */
    table, table *, .outer-border, .outer-border * {
      border-color: #1e3a8a !important;
    }
    
    /* âœ… Pagination hygiene - Keep content blocks intact */
    .section, .text-box, .credentials-box, .car-details, tr {
      break-inside: avoid;
      page-break-inside: avoid;
    }
    
    /* Repeat table headers on every page */
    thead { display: table-header-group; }
    tfoot { display: table-footer-group; }
    
    /* Strong bottom border on headers for clean page breaks */
    thead th {
      border-bottom: 3px solid #1e3a8a !important;
    }
    
    /* Force page breaks when needed */
    .page-break { break-before: page; page-break-before: always; }
    
    .header-bottom-bold th {
      border-bottom: 3px solid #1e3a8a !important;
      background: #f8fafc !important;
    }
    
    .left-bold-border {
      border-left: 3px solid #1e3a8a !important;
    }
    
    .watermark {
      position: fixed;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-30deg);
      font-size: 8rem;
      color: rgba(59, 130, 246, 0.25);
      z-index: 0;
      white-space: normal;
      pointer-events: none;
      font-weight: bold;
      max-width: 70vw;
      width: auto;
      text-align: center;
      line-height: 0.9;
      word-wrap: break-word;
      overflow-wrap: break-word;
      hyphens: auto;
    }
    
    .paragraph { 
      margin-top: 20px; 
      line-height: 1.6; 
      white-space: pre-line; 
    }
    
    .section-title { 
      font-size: 20px; 
      font-weight: 600;
      margin-top: 25px; 
      margin-bottom: 15px;
      border-bottom: 2px solid #1e3a8a; 
      padding-bottom: 5px;
      color: #1e3a8a !important;
    }
    
    .footer { 
      margin-top: 40px; 
      font-size: 18px; 
    }
    
    .signature-img { 
      width: 220px; 
      display: block; 
    }
    
    .banner { 
      width: 100%; 
      display: block; 
      margin-bottom: 0;
      padding: 8px 16px;
      box-sizing: border-box;
    }

    .keep-together {
      page-break-inside: avoid;
      break-inside: avoid;
    }
    
    /* Control Buttons Styling */
    .control-btn {
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      color: white;
    }
    
    .control-btn:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transform: translateY(-1px);
    }
    
    .review-btn { background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%); }
    .edit-btn { background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); }
    .preview-btn { background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%); }
    .submit-btn { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
    .home-btn { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); }
    .draft-opinion-btn { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); }
    .draft-estimate-btn { background: linear-gradient(135deg, #fd7e14 0%, #e8690b 100%); }
    
    /* Text boxes for all non-table content */
    .text-box {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .credentials-box {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15);
    }
    
    /* Complete A4 Print Layout */
    @page {
      size: A4;
      margin: 0;
    }
    
    @media print {
      html, body {
        margin: 0 !important;
        padding: 0 !important;
        width: 210mm !important;
        font-size: 11px !important;
        line-height: 1.3 !important;
        /* Let @page margin handle the spacing */
      }
      
      .bg {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 210mm !important;
        height: 297mm !important;
        z-index: 0 !important;
      }
      
      .page {
        width: 210mm !important;
        padding: 25mm 15mm 20mm 15mm !important;
        margin: 0 !important;
        box-sizing: border-box !important;
        position: relative !important;
        z-index: 1 !important;
      }
      
      .no-print {
        display: none !important;
      }
      
      /* Proper page breaks */
      .section {
        page-break-inside: avoid !important;
        margin-bottom: 6mm !important;
      }
      
      .paragraph {
        page-break-inside: avoid !important;
        margin: 4mm 0 !important;
      }
      
      table {
        page-break-inside: avoid !important;
        margin-bottom: 4mm !important;
        font-size: 10px !important;
      }
      
      th, td {
        padding: 3mm !important;
        font-size: 9px !important;
      }
      
      .keep-together {
        page-break-inside: avoid !important;
      }
      
      .damage-centers-container > div {
        page-break-inside: avoid !important;
        margin-bottom: 3mm !important;
      }
      
      h1, h2, .section-title {
        page-break-after: avoid !important;
        margin-bottom: 3mm !important;
        font-size: 14px !important;
      }
      
      .watermark {
        font-size: 4rem !important;
        color: rgba(59, 130, 246, 0.15) !important;
      }
    }
  </style>
  <script>
    let helper = {};
    
    window.onload = () => {
      loadHelperData();
      populateExpertiseData();
    };
    
    function loadHelperData() {
      try {
        const helperData = sessionStorage.getItem('helper');
        if (helperData) {
          helper = JSON.parse(helperData);
          console.log('Helper data loaded:', helper);
        } else {
          console.warn('No helper data found in sessionStorage');
          helper = {};
        }
      } catch (error) {
        console.error('Error loading helper data:', error);
        helper = {};
      }
    }
    
    function populateExpertiseData() {
      // Update watermark
      const watermark = document.querySelector('.watermark');
      if (watermark && helper.case_info?.status) {
        watermark.textContent = helper.case_info.status;
      }
      
      // Update header info with proper centering
      const headerDate = document.getElementById('header-date');
      const headerPlate = document.getElementById('header-plate');
      if (headerDate && helper.case_info?.inspection_date) {
        headerDate.textContent = formatDate(helper.case_info.inspection_date);
      }
      if (headerPlate && helper.vehicle?.plate) {
        headerPlate.textContent = helper.vehicle.plate;
      }
      
      // Populate main data table
      populateMainDataTable();
      
      // Generate damage centers sections
      generateDamageCenters();
      
      // Update footer signature date
      const signatureDate = document.querySelector('.signature-date');
      if (signatureDate && helper.case_info?.inspection_date) {
        signatureDate.textContent = formatDate(helper.case_info.inspection_date);
      }
      
      // Update final warning plate number
      const warningPlate = document.querySelector('.warning-plate');
      if (warningPlate && helper.vehicle?.plate) {
        warningPlate.textContent = helper.vehicle.plate;
      }
      
      // Update final warning date
      const warningDate = document.querySelector('.warning-date');
      if (warningDate && helper.case_info?.inspection_date) {
        warningDate.textContent = formatDate(helper.case_info.inspection_date);
      }
      
      // Update general assessment section
      updateGeneralAssessment();
      
      // Update additional data mappings
      updateAdditionalMappings();
    }
    
    function populateMainDataTable() {
      const dataFields = {
        'plate-1': helper.vehicle?.plate,
        'plate-2': helper.vehicle?.plate,
        'manufacturer': helper.vehicle?.manufacturer,
        'model': helper.vehicle?.model,
        'trim': helper.vehicle?.trim,
        'chassis': helper.vehicle?.chassis,
        'year': helper.vehicle?.year,
        'km': helper.vehicle?.km,
        'model-type': helper.levisummary?.category || helper.vehicle?.model_type,
        'damage-date': helper.case_info?.damage_date ? formatDate(helper.case_info.damage_date) : '',
        'inspection-date': helper.case_info?.inspection_date ? formatDate(helper.case_info.inspection_date) : '',
        'model-code': helper.vehicle?.model_code,
        'vehicle-type': helper.vehicle?.vehicle_type || helper.vehicle?.ownership_type,
        'ownership-type': helper.vehicle?.ownership_type,
        'base-price': helper.valuation?.base_price || helper.vehicle?.base_price,
        'owner-name': helper.stakeholders?.owner?.name,
        'owner-address': helper.stakeholders?.owner?.address,
        'owner-phone': helper.stakeholders?.owner?.phone,
        'garage-name': helper.stakeholders?.garage?.name,
        'garage-email': helper.stakeholders?.garage?.email,
        'garage-phone': helper.stakeholders?.garage?.phone,
        'insurance-company': helper.stakeholders?.insurance?.company,
        'insurance-email': helper.stakeholders?.insurance?.email,
        'insurance-agent-name': helper.stakeholders?.insurance?.agent?.name,
        'insurance-agent-phone': helper.stakeholders?.insurance?.agent?.phone,
        'insurance-agent-email': helper.stakeholders?.insurance?.agent?.email,
        'damage-type': helper.case_info?.damage_type || helper.damage_assessment?.summary?.damage_type || '×ª××•× ×ª×™',
        'inspection-location': helper.case_info?.inspection_location || helper.meta?.inspection_location
      };
      
      Object.entries(dataFields).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element && value) {
          element.textContent = value;
        }
      });
    }
    
    function generateDamageCenters() {
      const container = document.querySelector('.damage-centers-container');
      if (!container || !helper.centers || !Array.isArray(helper.centers)) {
        console.warn('No damage centers data found or container missing');
        return;
      }
      
      container.innerHTML = ''; // Clear existing content
      
      // Add general description section first
      const generalDescriptionHtml = createGeneralDescriptionSection();
      container.innerHTML += generalDescriptionHtml;
      
      // Add global alert for all damage centers
      const globalAlertHtml = createGlobalAlert();
      container.innerHTML += globalAlertHtml;
      
      helper.centers.forEach((center, index) => {
        const centerHtml = createDamageCenterSection(center, index);
        container.innerHTML += centerHtml;
      });
      
      // Update summary table
      updateDamageSummaryTable();
    }
    
    function createGeneralDescriptionSection() {
      if (!helper.centers || !Array.isArray(helper.centers)) {
        return '';
      }
      
      // Create list of all damage centers with number, location and description
      const damageDescriptions = helper.centers.map(center => {
        const number = center['Damage center Number'];
        const location = center.Location || '×œ× ×¦×•×™×Ÿ';
        const description = center.Description;
        return `××•×§×“ × ×–×§ ××¡×¤×¨ ${number}: ${location} - ${description}`;
      });
      const locationsList = damageDescriptions.join('\n');
      
      return `
        <div class="keep-together" style="margin: 0; padding: 0; margin-bottom: 1px; page-break-inside: avoid;">
          <table class="outer-border keep-together" style="margin: 0; margin-bottom: 0px;">
            <tbody>
              <tr>
                <td class="table-param left-bold-border" style="width: 25%; font-weight: bold;"><span>×ª×™××•×¨ ×›×œ×œ×™</span></td>
                <td style="text-align: right; padding: 10px; font-size: 16px; line-height: 1.4;">
                  ×‘×‘×“×™×§×ª ×”×¨×›×‘ ×”× ×“×•×Ÿ × ×•×›×—× ×• ×‘× ×–×§×™× ×ª××•× ×ª×™×™× ×‘××™×–×•×¨×™× ×”×‘××™×:<br>
                  <span style="font-weight: bold; color: #1e3a8a; margin: 8px 0; display: block;">${locationsList.replace(/\n/g, '<br>')}</span>
                  ×›×ª×•×¦××” ××›×š, ×—×œ×§×™× ××œ×” × ××¦××• × ×™×–×•×§×™× ×•×˜×¢×•× ×™× ×ª×™×§×•×Ÿ.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      `;
    }
    
    function createGlobalAlert() {
      return `
        <div class="keep-together" style="margin: 0; padding: 0; margin-bottom: 1px; page-break-inside: avoid;">
          <h3 style="font-size: 16px; font-weight: bold; color: #dc2626; margin: 1px 0 0 0; text-decoration: underline; text-align: center;">
            ×œ×–××Ÿ ×©×××™ ×œ××—×¨ ×¤×™×¨×•×§×™× ×•×œ×¤× ×™ ×¦×‘×¢
          </h3>
        </div>
      `;
    }
    
    function createDamageCenterSection(center, index) {
      const centerNumber = center['Damage center Number'] || (index + 1);
      const location = center.Location || '×œ× ×¦×•×™×Ÿ';
      const description = center.Description || '';
      
      return `
        <div class="keep-together" style="margin-bottom: 2px; page-break-inside: avoid; margin-top: 0px;">
          <div style="text-align: right; font-weight: bold; color: #1e3a8a; margin-bottom: 4px; font-size: 17px;">
            ××•×§×“ × ×–×§ ××¡×¤×¨ ${centerNumber}: ${location} - ${center.Description || ''}
          </div>
          <table class="outer-border keep-together" style="margin-bottom: 15px;">
            <tbody>
              <tr>
                <td class="table-param left-bold-border" style="width: 25%; font-weight: bold;"><span>×ª×™××•×¨ ×›×œ×œ×™</span></td>
                <td style="text-align: right; padding: 10px;">${description || `×‘×‘×“×™×§×ª ×”×¨×›×‘ ×”× ×“×•×Ÿ × ×•×›×—× ×• ×‘× ×–×§×™× ×ª××•× ×ª×™×™× ×‘××•×§×“ × ×–×§ ××¡×¤×¨ ${centerNumber}: ${location} - ${center.Description || ''}. ×›×ª×•×¦××” ××›×š, ×—×œ×§×™× ××œ×” × ××¦××• × ×™×–×•×§×™× ×•×˜×¢×•× ×™× ×ª×™×§×•×Ÿ.`}</td>
              </tr>
              ${center.RepairNature ? `<tr>
                <td class="table-param left-bold-border" style="width: 25%; font-weight: bold;"><span>××”×•×ª ×”×ª×™×§×•×Ÿ</span></td>
                <td style="text-align: right; padding: 10px;">${center.RepairNature}</td>
              </tr>` : ''}
            </tbody>
          </table>
          ${generateWorksTable(center.Works)}
          ${generateRepairsTable(center.Repairs)}
          ${generatePartsTable(center.Parts)}
        </div>
      `;
    }
    
    function generateWorksTable(works) {
      if (!works || !works.works || !Array.isArray(works.works) || works.works.length === 0) {
        return '<p style="font-style: italic; color: #666; margin: 15px 0; font-size: 16px;">××™×Ÿ ×¢×‘×•×“×•×ª ××•×’×“×¨×•×ª</p>';
      }
      
      // Get the takana389 value
      const takana389Value = works && works.takana389 ? works.takana389 : '×œ× ×¦×•×™×Ÿ';
      
      let tableHtml = `
        <h4 style="font-size: 18px; font-weight: bold; color: #1e3a8a; margin: 15px 0 10px 0; text-align: right;">×¢×‘×•×“×•×ª</h4>
        <table style="width: auto; margin-left: auto; margin-right: 0; margin-bottom: 10px; font-size: 16px; border: 2px solid #1e3a8a;">
          <tbody>
            <tr>
              <td style="background: #f8fafc; font-weight: bold; padding: 8px 12px; border: 1px solid #cbd5e1; white-space: nowrap;">×”×× ××—×•×™×‘ ×‘×ª×§× ×” 389</td>
              <td style="padding: 8px 12px; border: 1px solid #cbd5e1; text-align: center; font-weight: 500;">${takana389Value}</td>
            </tr>
          </tbody>
        </table>
        <table class="outer-border keep-together" style="margin-bottom: 20px; font-size: 16px;">
          <thead class="header-bottom-bold">
            <tr>
              <th class="table-num" style="width: 10%; font-size: 16px; padding: 12px 8px;">××¡"×“</th>
              <th class="table-param" style="width: 35%; font-size: 16px; padding: 12px; color: #1e3a8a;">×¡×•×’ ×¢×‘×•×“×”</th>
              <th class="table-param" style="width: 25%; font-size: 16px; padding: 12px; background: #ffe6e6; color: #dc2626;">×¢×œ×•×ª ××©×•×¢×¨×ª</th>
              <th class="table-param" style="width: 30%; font-size: 16px; padding: 12px; color: #1e3a8a;">×ª×™××•×¨</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      works.works.forEach((work, index) => {
        const rowNum = index + 1;
        const category = work.category || '';
        const comments = work.comments || '';
        const cost = work.cost || 0;
        
        tableHtml += `
          <tr>
            <td class="table-num" style="font-size: 16px; padding: 10px; text-align: center;">${rowNum}</td>
            <td style="text-align: right; padding: 10px; font-size: 16px; font-weight: 500;">${category}</td>
            <td style="text-align: center; padding: 10px; font-size: 16px; font-weight: bold; color: #dc2626;">${Math.round(parseFloat(cost) || 0).toLocaleString()} â‚ª</td>
            <td style="text-align: right; padding: 10px; font-size: 16px;">${comments}</td>
          </tr>
        `;
      });
      
      tableHtml += '</tbody></table>';
      return tableHtml;
    }
    
    function generateRepairsTable(repairs) {
      if (!repairs || !repairs.repairs || !Array.isArray(repairs.repairs) || repairs.repairs.length === 0) {
        return '<p style="font-style: italic; color: #666; margin: 15px 0; font-size: 16px;">××™×Ÿ ×ª×™×§×•× ×™× ××•×’×“×¨×™×</p>';
      }
      
      let tableHtml = `
        <h4 style="font-size: 18px; font-weight: bold; color: #1e3a8a; margin: 15px 0 10px 0; text-align: right;">×ª×™×§×•× ×™×</h4>
        <table class="outer-border keep-together" style="margin-bottom: 20px; font-size: 16px;">
          <thead>
            <tr>
              <th class="table-num" style="width: 10%; font-size: 16px; padding: 12px 8px;">××¡"×“</th>
              <th class="table-param" style="width: 35%; font-size: 16px; padding: 12px; color: #1e3a8a;">×©× ×”×ª×™×§×•×Ÿ</th>
              <th class="table-param" style="width: 25%; font-size: 16px; padding: 12px; background: #ffe6e6; color: #dc2626;">×¢×œ×•×ª ××©×•×¢×¨×ª</th>
              <th class="table-param" style="width: 30%; font-size: 16px; padding: 12px; color: #1e3a8a;">×ª×™××•×¨ ×¢×œ×•×ª</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      repairs.repairs.forEach((repair, index) => {
        const rowNum = index + 1;
        const name = repair.name || '';
        const description = repair.description || '';
        const cost = repair.cost || 0;
        
        tableHtml += `
          <tr>
            <td class="table-num" style="font-size: 16px; padding: 10px; text-align: center;">${rowNum}</td>
            <td style="text-align: right; padding: 10px; font-size: 16px; font-weight: 500;">${name}</td>
            <td style="text-align: center; padding: 10px; font-size: 16px; font-weight: bold; color: #dc2626;">${Math.round(parseFloat(cost) || 0).toLocaleString()} â‚ª</td>
            <td style="text-align: right; padding: 10px; font-size: 16px;">${description}</td>
          </tr>
        `;
      });
      
      tableHtml += '</tbody></table>';
      return tableHtml;
    }
    
    function generatePartsTable(parts) {
      if (!parts || !parts.parts_required || !Array.isArray(parts.parts_required) || parts.parts_required.length === 0) {
        return '<p style="font-style: italic; color: #666; margin: 15px 0; font-size: 16px;">××™×Ÿ ×—×œ×§×™× ××•×’×“×¨×™×</p>';
      }
      
      let tableHtml = `
        <h4 style="font-size: 18px; font-weight: bold; color: #1e3a8a; margin: 15px 0 10px 0; text-align: right;">×—×œ×§×™×</h4>
        <table class="outer-border keep-together" style="margin-bottom: 20px; font-size: 16px;">
          <thead>
            <tr>
              <th class="table-num" style="width: 10%; font-size: 16px; padding: 12px 8px;">××¡"×“</th>
              <th class="table-param" style="width: 25%; font-size: 16px; padding: 12px; color: #1e3a8a;">×©× ×”×—×œ×§</th>
              <th class="table-param" style="width: 20%; font-size: 16px; padding: 12px; background: #ffe6e6; color: #dc2626;">×¢×œ×•×ª ××©×•×¢×¨×ª</th>
              <th class="table-param" style="width: 20%; font-size: 16px; padding: 12px; color: #1e3a8a;">××§×•×¨</th>
              <th class="table-param" style="width: 25%; font-size: 16px; padding: 12px; color: #1e3a8a;">×ª×™××•×¨</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      parts.parts_required.forEach((part, index) => {
        const rowNum = index + 1;
        const name = part.name || '';
        const description = part.×ª×™××•×¨ || part.description || '';
        const source = part.source || '';
        const price = part.××—×™×¨ || part.price || '';
        
        tableHtml += `
          <tr>
            <td class="table-num" style="font-size: 16px; padding: 10px; text-align: center;">${rowNum}</td>
            <td style="text-align: right; padding: 10px; font-size: 16px; font-weight: 500;">${name}</td>
            <td style="text-align: center; padding: 10px; font-size: 16px; font-weight: bold; color: #dc2626;">${price ? Math.round(parseFloat(price.toString().replace(/[â‚ª,]/g, '')) || 0).toLocaleString() + ' â‚ª' : price}</td>
            <td style="text-align: center; padding: 10px; font-size: 16px;">${source}</td>
            <td style="text-align: right; padding: 10px; font-size: 16px;">${description}</td>
          </tr>
        `;
      });
      
      tableHtml += '</tbody></table>';
      return tableHtml;
    }
    
    function updateDamageSummaryTable() {
      const summaryContainer = document.querySelector('.damage-summary-table');
      if (!summaryContainer || !helper.centers) return;
      
      let summaryHtml = '';
      let totalParts = 0, totalWorks = 0, totalRepairs = 0, totalWithVat = 0;
      
      helper.centers.forEach((center, index) => {
        const centerNumber = center['Damage center Number'] || (index + 1);
        const location = center.Location || '×œ× ×¦×•×™×Ÿ';
        const description = center.Description || '';
        const summary = center.Summary || {};
        
        const partsTotal = summary['Total parts'] || 0;
        const worksTotal = summary['Total works'] || 0;
        const repairsTotal = summary['Total repairs'] || 0;
        const centerTotal = summary['Total with VAT'] || 0;
        
        totalParts += partsTotal;
        totalWorks += worksTotal;
        totalRepairs += repairsTotal;
        totalWithVat += centerTotal;
        
        summaryHtml += `
          <tr>
            <td class="table-num">${centerNumber}</td>
            <td class="table-param">${location} - ${description}</td>
            <td>${Math.round(partsTotal).toLocaleString()} â‚ª</td>
            <td>${Math.round(worksTotal).toLocaleString()} â‚ª</td>
            <td>${Math.round(repairsTotal).toLocaleString()} â‚ª</td>
            <td style="font-weight: bold; color: #1e3a8a;">${Math.round(centerTotal).toLocaleString()} â‚ª</td>
          </tr>
        `;
      });
      
      // Calculate subtotals without VAT
      const totalBeforeVat = totalParts + totalWorks + totalRepairs;
      const vatRate = (window.helper?.calculations?.vat_rate || 18) / 100;
      const vatAmount = Math.round(totalBeforeVat * vatRate);
      const totalWithVatCalculated = totalBeforeVat + vatAmount;
      
      summaryHtml += `
        <tr style="background: #f1f5f9; border-top: 1px solid #e2e8f0;">
          <td colspan="2" class="table-param" style="font-weight: bold; text-align: center;">×¡×”"×› ×œ×œ× ××¢"×</td>
          <td style="font-weight: bold; color: #1e3a8a;">${Math.round(totalParts).toLocaleString()} â‚ª</td>
          <td style="font-weight: bold; color: #1e3a8a;">${Math.round(totalWorks).toLocaleString()} â‚ª</td>
          <td style="font-weight: bold; color: #1e3a8a;">${Math.round(totalRepairs).toLocaleString()} â‚ª</td>
          <td style="font-weight: bold; color: #dc2626;">${Math.round(totalBeforeVat).toLocaleString()} â‚ª</td>
        </tr>
        <tr style="background: #f1f5f9;">
          <td colspan="5" class="table-param" style="font-weight: bold; text-align: center;">××¢"× (${window.helper?.calculations?.vat_rate || 18}%)</td>
          <td style="font-weight: bold; color: #dc2626;">${Math.round(vatAmount).toLocaleString()} â‚ª</td>
        </tr>
        <tr style="background: #f1f5f9; border-top: 2px solid #1e3a8a;">
          <td colspan="5" class="table-param" style="font-weight: bold; text-align: center; color: #1e3a8a;">×¡×”"×› ××•×¢×¨×š ×›×•×œ×œ ××¢"×</td>
          <td style="font-weight: bold; color: #dc2626; font-size: 18px;">${Math.round(helper.damage_assessment?.totals?.["Total with VAT"] || totalWithVatCalculated).toLocaleString()} â‚ª</td>
        </tr>
      `;
      
      summaryContainer.innerHTML = summaryHtml;
      
      // Update financial summary
      updateFinancialSummary();
    }
    
    function updateFinancialSummary() {
      // Calculate totals from centers if financials not available
      let centersCount = 0;
      let totalParts = 0;
      let totalWorks = 0;
      let totalRepairs = 0;
      let totalWithVat = 0;
      
      if (helper.centers && Array.isArray(helper.centers)) {
        centersCount = helper.centers.length;
        helper.centers.forEach(center => {
          const summary = center.Summary || {};
          totalParts += parseFloat(summary['Total parts']) || 0;
          totalWorks += parseFloat(summary['Total works']) || 0;
          totalRepairs += parseFloat(summary['Total repairs']) || 0;
          totalWithVat += parseFloat(summary['Total with VAT']) || 0;
        });
      }
      
      const elements = {
        'centers-count': centersCount,
        'before-tax': helper.financials?.totals?.before_tax || (totalWithVat / (1 + (window.helper?.calculations?.vat_rate || 18) / 100)), // Estimate before tax
        'vat-amount': helper.financials?.taxes?.vat_amount || (totalWithVat - (totalWithVat / (1 + (window.helper?.calculations?.vat_rate || 18) / 100))), // Estimate VAT
        'after-tax': helper.financials?.totals?.after_tax || totalWithVat
      };
      
      Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
          if (id === 'centers-count') {
            element.textContent = value;
          } else {
            element.textContent = Math.round(value).toLocaleString() + ' â‚ª';
          }
        }
      });
    }
    
    function updateGeneralAssessment() {
      // Update assessment notes - try multiple possible paths
      const assessmentNotes = document.getElementById('assessment-notes');
      if (assessmentNotes) {
        const notes = helper.damage_assessment?.summary?.assessment_notes || 
                     helper.assessment?.notes || 
                     '×‘×‘×“×™×§×ª ×”×¨×›×‘ × ××¦××• × ×–×§×™× ×ª××•× ×ª×™×™× ×”×“×•×¨×©×™× ×ª×™×§×•×Ÿ ×¢×œ ×¤×™ ×”×¤×™×¨×•×˜ ×œ×¢×™×œ.';
        assessmentNotes.textContent = notes;
      }
      
      
      // Update status
      const statusText = document.getElementById('status-text');
      if (statusText) {
        const status = helper.expertise?.summary?.status || helper.case_info?.status || '×‘×ª×”×œ×™×š';
        statusText.textContent = status;
      }
      
      // Update technician info
      const technicianInfo = document.getElementById('technician-info');
      if (technicianInfo) {
        const technician = helper.expertise?.summary?.technician || '×™×¨×•×Ÿ ×›×™×•×£';
        const license = helper.expertise?.summary?.license || '1097';
        technicianInfo.textContent = `${technician} - ×¨×™×©×™×•×Ÿ ${license}`;
      }
      
      // Update directive from helper.expertise.summary
      const directiveText = document.getElementById('directive-text');
      if (directiveText) {
        const directive = helper.expertise?.summary?.directive || '×œ×ª×™×§×•×Ÿ';
        directiveText.textContent = directive;
      }
      
      // Update additional notes (show only if exists)
      const additionalNotes = document.getElementById('additional-notes');
      const additionalNotesContent = document.getElementById('additional-notes-content');
      if (helper.expertise?.summary?.notes) {
        additionalNotes.style.display = 'block';
        additionalNotesContent.textContent = helper.expertise.summary.notes;
      } else {
        additionalNotes.style.display = 'none';
      }
    }
    
    function updateAdditionalMappings() {
      // Update watermark with directive and dynamic sizing
      const watermark = document.querySelector('.watermark');
      if (watermark) {
        const directive = helper.expertise?.summary?.directive || '×œ×ª×™×§×•×Ÿ';
        watermark.textContent = directive;
        
        // Dynamic font sizing based on text length and word count
        const textLength = directive.length;
        const wordCount = directive.split(' ').length;
        let fontSize = '8rem';
        
        // More aggressive sizing for longer text
        if (wordCount >= 5 || textLength > 25) {
          fontSize = '4rem';
        } else if (wordCount >= 4 || textLength > 20) {
          fontSize = '5rem';
        } else if (wordCount >= 3 || textLength > 15) {
          fontSize = '6rem';
        } else if (textLength > 10) {
          fontSize = '7rem';
        }
        
        watermark.style.fontSize = fontSize;
      }
    }
    
    function formatDate(dateString) {
      if (!dateString) return '';
      try {
        const date = new Date(dateString);
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } catch (error) {
        return dateString;
      }
    }

    
    // Control button functions
    window.editExpertise = function() {
      if (confirm('×”×× ×‘×¨×¦×•× ×š ×œ×¢×¨×•×š ××ª × ×ª×•× ×™ ×”××§×¡×¤×™×¨×˜×™×–×”? ×–×” ×™×—×–×™×¨ ××•×ª×š ×œ×“×£ ×”××™××•×ª.')) {
        // Go back to validation page where user can edit data
        window.location.href = 'expertise-validation.html';
      }
    };

    window.printPreview = function() {
      // Hide control buttons before printing
      const controlSection = document.querySelector('.no-print');
      if (controlSection) {
        controlSection.style.display = 'none';
      }
      
      // Add print-specific title
      const originalTitle = document.title;
      const plateNumber = helper.vehicle?.plate || '×œ×œ× ××¡×¤×¨';
      document.title = `××§×¡×¤×¨×˜×™×–×” - ${plateNumber}`;
      
      // Print
      window.print();
      
      // Restore original state
      document.title = originalTitle;
      if (controlSection) {
        controlSection.style.display = '';
      }
    };

    // Helper function to save report drafts to Supabase
    async function saveReportDraftToSupabase(reportType, status) {
      try {
        const helper = window.helper || JSON.parse(sessionStorage.getItem('helper') || '{}');
        let caseIdOrNumber = helper.case_info?.supabase_case_id || helper.meta?.case_id;
        const plate = helper.car_details?.plate || helper.vehicle?.plate || helper.meta?.plate;

        if (!caseIdOrNumber || !plate || !window.supabase) {
          console.warn(`âš ï¸ Missing data for ${reportType} draft save - skipping`);
          return;
        }

        console.log(`ğŸ’¾ Saving ${reportType} ${status} to Supabase...`, { caseIdOrNumber, plate });

        // Check if case_id is a valid UUID
        const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
        let actualCaseId = caseIdOrNumber;

        if (!uuidPattern.test(caseIdOrNumber)) {
          const { data: caseData, error: lookupError } = await window.supabase
            .from('cases')
            .select('id')
            .or(`case_number.eq.${caseIdOrNumber},plate.eq.${plate?.replace(/-/g, '')}`)
            .limit(1)
            .single();

          if (lookupError || !caseData) {
            console.warn(`âš ï¸ Could not find case UUID for ${reportType} - skipping`);
            return;
          }
          actualCaseId = caseData.id;
        }

        // Transform helper structure for SQL function
        const centersData = helper[reportType]?.centers || helper.centers || helper.damage_centers || [];
        const helperForSupabase = {
          ...helper,
          [reportType]: {
            ...helper[reportType],
            centers: centersData
          }
        };

        const { data, error } = await window.supabase.rpc('upsert_tracking_final_report_from_helper', {
          helper_json: helperForSupabase,
          p_case_id: actualCaseId,
          p_plate: plate?.replace(/-/g, ''),
          p_report_type: reportType,
          p_status: status
        });

        if (error) {
          console.error(`âŒ ${reportType} ${status} save failed:`, error);
        } else {
          console.log(`âœ… ${reportType} ${status} saved to Supabase (${data} records)`);
        }
      } catch (error) {
        console.error(`âŒ Error saving ${reportType} ${status}:`, error);
      }
    }

    window.submitFinalExpertise = function() {
      console.log('ğŸ”„ Starting submit process...');
      
      // Get submit button and disable it to prevent multiple submissions
      const submitButton = document.querySelector('.submit-btn');
      if (submitButton.disabled) {
        console.log('âŒ Submit already in progress, ignoring click');
        return;
      }
      
      if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×©×œ×•×— ××ª ×”××§×¡×¤×™×¨×˜×™×–×” ×”×¡×•×¤×™×ª? ×œ× ×™×”×™×” × ×™×ª×Ÿ ×œ×¢×¨×•×š ×œ××—×¨ ××›×Ÿ.')) {
        // Disable button and change text to show it's processing
        submitButton.disabled = true;
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML = 'â³ ×©×•×œ×—... ×× × ×”××ª×Ÿ';
        submitButton.style.opacity = '0.6';
        try {
          console.log('â±ï¸ Getting helper data...');
          const currentHelper = JSON.parse(sessionStorage.getItem('helper') || '{}');
          console.log('âœ… Helper data loaded, size:', JSON.stringify(currentHelper).length);
          
          console.log('â±ï¸ Creating optimized payload...');
          
          // Create optimized payload without duplicates
          const payload = {
            // Core webhook fields
            plate: currentHelper.car_details?.plate || currentHelper.vehicle?.plate || currentHelper.meta?.plate || 'unknown',
            owner_name: currentHelper.stakeholders?.owner?.name || currentHelper.vehicle?.owner || '×œ× ×¦×•×™×Ÿ',
            action: 'LAUNCH_EXPERTISE',
            submittedAt: new Date().toISOString(),
            callbackUrl: null,
            
            // PROTECTED SECTIONS - Send as-is (source of truth)
            car_details: currentHelper.car_details || {},
            case_info: currentHelper.case_info || {},
            centers: currentHelper.centers || [],
            current_damage_center: currentHelper.current_damage_center || {},
            damage_assessment: currentHelper.damage_assessment || {},
            damage_info: currentHelper.damage_info || {},
            expertise: currentHelper.expertise || {},
            general: currentHelper.general || {},
            levisummary: currentHelper.levisummary || {},
            meta: currentHelper.meta || {},
            parts_search: currentHelper.parts_search || {},
            raw_webhook_data: currentHelper.raw_webhook_data || {},
            stakeholders: currentHelper.stakeholders || {},
            valuation: currentHelper.valuation || {},
            vehicle: currentHelper.vehicle || {},
            
            // OTHER SECTIONS - Evaluate for importance
            calculations: currentHelper.calculations || {},
            documents: currentHelper.documents || {},
            estimate: currentHelper.estimate || {},
            final_report: currentHelper.final_report || {},
            levi_data: currentHelper.levi_data || {},
            
            // SKIP DUPLICATE/REDUNDANT SECTIONS
            // Skip: system sections, duplicated vehicle data, technical fields
            // Note: Complete helper object NOT included to avoid duplicates
          };
          
          console.log('âœ… Payload created:', payload);
        
          console.log('â±ï¸ Sending multiple webhooks...');
          
          // Import and use sendToWebhook for multiple webhooks
          import('./webhook.js').then(async ({ sendToWebhook }) => {
            console.log('âœ… Webhook module loaded');
            
            // Prepare different payloads for each webhook
            // Make sure expertise data is fully populated before capturing HTML
            populateExpertiseData();
            
            // Wait a moment for DOM updates, then capture clean HTML
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Clone document and remove no-print elements for clean PDF
            const clonedDoc = document.cloneNode(true);
            const controlSection = clonedDoc.querySelector('.no-print');
            if (controlSection) {
              controlSection.remove();
            }
            
            const htmlContent = clonedDoc.documentElement.outerHTML;
            const htmlPayload = {
              plate: payload.plate,
              action: 'EXPERTISE_HTML',
              submittedAt: new Date().toISOString(),
              html: htmlContent,
              case_id: payload.meta?.case_id || `YC-${payload.plate.replace(/[-\/]/g, '')}-${new Date().getFullYear()}`,
              callbackUrl: null
            };
            
            const helperExportPayload = {
              ...payload,
              action: 'HELPER_EXPORT',
              export_type: 'expertise_submission',
              backup_timestamp: new Date().toISOString(),
              callbackUrl: null
            };
            
            // Function to fetch populated HTML from report URLs
            async function fetchReportHTML(reportUrl, reportType) {
              try {
                console.log(`ğŸ”„ Fetching ${reportType} HTML from: ${reportUrl}`);
                
                // First, ensure the target page has access to current helper data
                // We'll open the URL in a hidden iframe and wait for it to load and populate
                return new Promise((resolve, reject) => {
                  const iframe = document.createElement('iframe');
                  iframe.style.display = 'none';
                  iframe.style.position = 'absolute';
                  iframe.style.left = '-9999px';
                  iframe.style.width = '1px';
                  iframe.style.height = '1px';
                  document.body.appendChild(iframe);
                  
                  let timeoutId;
                  
                  iframe.onload = () => {
                    console.log(`ğŸ“„ ${reportType} iframe loaded, waiting for data population...`);
                    
                    // Clear any existing timeout
                    if (timeoutId) clearTimeout(timeoutId);
                    
                    // Wait longer for the report to fully populate with data
                    timeoutId = setTimeout(() => {
                      try {
                        // Get the populated HTML from the iframe
                        let iframeDoc;
                        try {
                          iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                        } catch (docError) {
                          console.warn(`âš ï¸ ${reportType} iframe document access failed:`, docError);
                          // Clean up and provide fallback
                          if (iframe.parentNode) {
                            document.body.removeChild(iframe);
                          }
                          const accessErrorHTML = `<html><body><h1>${reportType} Report - Access Error</h1><p>Plate: ${payload.plate}</p><p>Generated: ${new Date().toLocaleString()}</p><p>Could not access iframe document (security/CORS issue)</p></body></html>`;
                          resolve(accessErrorHTML);
                          return;
                        }
                        
                        if (!iframeDoc || !iframeDoc.body) {
                          console.warn(`âš ï¸ ${reportType} iframe document or body is null`);
                          // Clean up and provide fallback
                          if (iframe.parentNode) {
                            document.body.removeChild(iframe);
                          }
                          const nullDocHTML = `<html><body><h1>${reportType} Report - Document Null</h1><p>Plate: ${payload.plate}</p><p>Generated: ${new Date().toLocaleString()}</p><p>Iframe document or body was null</p></body></html>`;
                          resolve(nullDocHTML);
                          return;
                        }
                        
                        // Check if the page has populated content (not just empty template)
                        const hasContent = iframeDoc.body.innerHTML.length > 5000; // Basic content check
                        const hasPlateNumber = payload.plate && iframeDoc.body.innerHTML.includes(payload.plate);
                        
                        console.log(`ğŸ” ${reportType} content check:`, { 
                          contentLength: iframeDoc.body.innerHTML.length,
                          hasPlateNumber,
                          hasContent 
                        });
                        
                        // Remove any no-print elements before capturing
                        const noPrintElements = iframeDoc.querySelectorAll('.no-print, .control-buttons, .no-pdf');
                        noPrintElements.forEach(el => el.remove());
                        
                        const populatedHTML = iframeDoc.documentElement.outerHTML;
                        
                        // Cleanup
                        if (iframe.parentNode) {
                          document.body.removeChild(iframe);
                        }
                        
                        if (hasContent || hasPlateNumber) {
                          console.log(`âœ… ${reportType} HTML captured successfully (${populatedHTML.length} chars)`);
                          resolve(populatedHTML);
                        } else {
                          console.warn(`âš ï¸ ${reportType} HTML seems empty, using fallback`);
                          const fallbackHTML = `<html><body><h1>${reportType} Report</h1><p>Plate: ${payload.plate}</p><p>Generated: ${new Date().toLocaleString()}</p><p>Note: Template did not populate properly</p></body></html>`;
                          resolve(fallbackHTML);
                        }
                        
                      } catch (captureError) {
                        console.error(`âŒ Failed to capture ${reportType} HTML:`, captureError);
                        // Clean up safely
                        try {
                          if (iframe && iframe.parentNode) {
                            document.body.removeChild(iframe);
                          }
                        } catch (cleanupError) {
                          console.warn('Cleanup error:', cleanupError);
                        }
                        
                        const errorHTML = `<html><body><h1>${reportType} Report - Error</h1><p>Plate: ${payload.plate}</p><p>Generated: ${new Date().toLocaleString()}</p><p>Error: ${captureError.message}</p></body></html>`;
                        resolve(errorHTML);
                      }
                    }, 5000); // Wait 5 seconds for data population
                  };
                  
                  iframe.onerror = (error) => {
                    console.error(`âŒ Failed to load ${reportType} iframe:`, error);
                    if (timeoutId) clearTimeout(timeoutId);
                    document.body.removeChild(iframe);
                    
                    const errorHTML = `<html><body><h1>${reportType} Report - Load Error</h1><p>Plate: ${payload.plate}</p><p>Generated: ${new Date().toLocaleString()}</p><p>Failed to load: ${reportUrl}</p></body></html>`;
                    resolve(errorHTML); // Don't reject, provide fallback
                  };
                  
                  // Set a maximum timeout
                  setTimeout(() => {
                    if (iframe.parentNode) {
                      console.warn(`â±ï¸ ${reportType} iframe timeout, using fallback`);
                      document.body.removeChild(iframe);
                      const timeoutHTML = `<html><body><h1>${reportType} Report - Timeout</h1><p>Plate: ${payload.plate}</p><p>Generated: ${new Date().toLocaleString()}</p><p>URL timed out: ${reportUrl}</p></body></html>`;
                      resolve(timeoutHTML);
                    }
                  }, 10000); // 10 second maximum timeout
                  
                  // Load the report URL
                  iframe.src = reportUrl;
                });
                
              } catch (error) {
                console.error(`âŒ Error setting up ${reportType} fetch:`, error);
                return `<html><body><h1>${reportType} Report - Setup Error</h1><p>Plate: ${payload.plate}</p><p>Generated: ${new Date().toLocaleString()}</p><p>Setup error: ${error.message}</p></body></html>`;
              }
            }

            // ğŸ’¾ CRITICAL FIX: Save to Supabase BEFORE webhooks
            // This ensures expertise reports are backed up to database
            (async () => {
              try {
                const helper = window.helper || JSON.parse(sessionStorage.getItem('helper') || '{}');
                // âœ… FIX: Check supabase_case_id first (actual UUID), fallback to case_id (filing ID)
                let caseIdOrNumber = helper.case_info?.supabase_case_id || helper.meta?.case_id;
                const plate = helper.car_details?.plate || helper.vehicle?.plate || payload.plate;

                if (caseIdOrNumber && plate && window.supabase) {
                  console.log('ğŸ’¾ Saving expertise to Supabase...', { caseIdOrNumber, plate });

                  // ğŸ” DEBUG: Log helper structure to understand data format
                  console.log('ğŸ” DEBUG: helper.damage_assessment =', helper.damage_assessment);
                  console.log('ğŸ” DEBUG: helper.damage_assessment?.centers =', helper.damage_assessment?.centers);
                  console.log('ğŸ” DEBUG: Full helper keys =', Object.keys(helper));

                  // Check if case_id is a valid UUID (format: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)
                  const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                  let actualCaseId = caseIdOrNumber;

                  if (!uuidPattern.test(caseIdOrNumber)) {
                    console.log('âš ï¸ case_id is not a UUID, looking up by case_number or plate...');

                    // Try to find the case UUID by case_number or plate
                    const { data: caseData, error: lookupError } = await window.supabase
                      .from('cases')
                      .select('id')
                      .or(`case_number.eq.${caseIdOrNumber},plate.eq.${plate?.replace(/-/g, '')}`)
                      .limit(1)
                      .single();

                    if (lookupError || !caseData) {
                      console.warn('âš ï¸ Could not find case UUID - skipping Supabase save');
                      console.warn('Lookup error:', lookupError);
                      return; // Skip Supabase save, continue with webhooks
                    }

                    actualCaseId = caseData.id;
                    console.log('âœ… Found case UUID:', actualCaseId);
                  }

                  // ğŸ”§ FIX: Transform helper structure for SQL function
                  // SQL expects helper.damage_assessment.centers but data is at helper.centers
                  const centersData = helper.centers || helper.damage_centers || [];
                  const helperForSupabase = {
                    ...helper,
                    damage_assessment: {
                      ...helper.damage_assessment,
                      centers: centersData
                    }
                  };

                  console.log('ğŸ” DEBUG: Calling RPC with parameters:', {
                    p_case_id: actualCaseId,
                    p_plate: plate?.replace(/-/g, ''),
                    centers_found: centersData.length,
                    centers_source: helper.centers ? 'helper.centers' : helper.damage_centers ? 'helper.damage_centers' : 'none'
                  });

                  const { data, error } = await window.supabase.rpc('upsert_tracking_expertise_from_helper', {
                    helper_json: helperForSupabase,
                    p_case_id: actualCaseId,
                    p_plate: plate?.replace(/-/g, ''),
                    p_status: 'final'  // âœ… Expertise is always final (no draft state)
                  });

                  // ğŸ” DEBUG: Log RPC response
                  console.log('ğŸ” DEBUG: RPC response data =', data);
                  console.log('ğŸ” DEBUG: RPC response error =', error);

                  if (error) {
                    console.error('âŒ Supabase save failed:', error);
                    console.warn('âš ï¸ Expertise will still be sent to Make.com webhooks');
                  } else {
                    console.log('âœ… Expertise saved to Supabase successfully');
                    console.log('âœ… Number of records inserted:', data);
                  }
                } else {
                  console.warn('âš ï¸ Missing case_id or plate - skipping Supabase save');
                }
              } catch (error) {
                console.error('âŒ Error saving expertise to Supabase:', error);
                console.warn('âš ï¸ Continuing with webhooks despite Supabase error');
              }
            })();

            // Send 3 essential webhooks sequentially for better reliability
            console.log('ğŸ“¤ 1/3 Sending EXPERTISE_HTML...');
            console.log('ğŸ” DEBUG: EXPERTISE_HTML payload size:', JSON.stringify(htmlPayload).length, 'characters');
            console.log('ğŸ” DEBUG: HTML content preview:', htmlPayload.html.substring(0, 500) + '...');
            console.log('ğŸ” DEBUG: HTML contains populated data?', htmlPayload.html.includes(payload.plate), htmlPayload.html.includes('×“×•"×— ××§×¡×¤×¨×˜×™×–×”'));
            return sendToWebhook('EXPERTISE_HTML', htmlPayload)
              .then(async () => {
                console.log('âœ… 1/3 EXPERTISE_HTML sent successfully');
                console.log('ğŸ“¤ 2/3 Sending SUBMIT_ESTIMATE_DRAFT...');

                // ğŸ’¾ Save estimate DRAFT to Supabase BEFORE webhook
                await saveReportDraftToSupabase('estimate', 'draft');

                // Fetch estimate HTML from the actual report URL
                const estimateHTML = await fetchReportHTML(
                  'https://yaron-cayouf-portal.netlify.app/estimate-report-builder.html?from=expertise&skipValidation=true',
                  'Estimate'
                );

                const estimatePayload = {
                  plate: payload.plate,
                  owner_name: payload.owner_name,
                  action: 'SUBMIT_ESTIMATE_DRAFT',
                  submittedAt: new Date().toISOString(),
                  html: estimateHTML,
                  case_id: payload.meta?.case_id || `YC-${payload.plate.replace(/[-\/]/g, '')}-${new Date().getFullYear()}`,
                  callbackUrl: null
                };

                return sendToWebhook('SUBMIT_ESTIMATE_DRAFT', estimatePayload);
              })
              .then(async () => {
                console.log('âœ… 2/3 SUBMIT_ESTIMATE_DRAFT sent successfully');
                console.log('ğŸ“¤ 3/3 Sending FINAL_REPORT_DRAFT...');

                // ğŸ’¾ Save final report DRAFT to Supabase BEFORE webhook
                await saveReportDraftToSupabase('final_report', 'draft');

                // Fetch final report HTML from the actual report URL
                const finalReportHTML = await fetchReportHTML(
                  'https://yaron-cayouf-portal.netlify.app/final-report-template-builder.html?from=expertise&skipValidation=true',
                  'Final Report'
                );

                const finalReportPayload = {
                  plate: payload.plate,
                  owner_name: payload.owner_name,
                  action: 'FINAL_REPORT_DRAFT',
                  submittedAt: new Date().toISOString(),
                  html: finalReportHTML,
                  case_id: payload.meta?.case_id || `YC-${payload.plate.replace(/[-\/]/g, '')}-${new Date().getFullYear()}`,
                  callbackUrl: null
                };

                return sendToWebhook('FINAL_REPORT_DRAFT', finalReportPayload);
              })
              .then(() => {
                console.log('âœ… 3/3 FINAL_REPORT_DRAFT sent successfully');
                console.log('ğŸ‰ All 3 webhooks sent successfully');
                return { success: true, webhooks_sent: 3 };
              });
          })
          .then(() => {
            console.log('âœ… All webhooks completed successfully');
            alert('×”××§×¡×¤×™×¨×˜×™×–×” × ×©×œ×—×” ×‘×”×¦×œ×—×”! (3 webhooks sent)');
            // Keep button disabled after successful submission
            submitButton.innerHTML = 'âœ… × ×©×œ×— ×‘×”×¦×œ×—×”';
            submitButton.style.backgroundColor = '#059669';
          })
          .catch((error) => {
            console.error('âŒ Webhook sequence failed:', error);
            alert('×©×’×™××” ×‘×©×œ×™×—×”: ' + error.message);
            // Re-enable button on error so user can retry
            submitButton.disabled = false;
            submitButton.innerHTML = originalText;
            submitButton.style.opacity = '1';
            submitButton.style.backgroundColor = '';
          });
          
        } catch (error) {
          console.error('âŒ Submit process failed:', error);
          alert('×©×’×™××” ×‘×¢×™×‘×•×“ ×”× ×ª×•× ×™×: ' + error.message);
          // Re-enable button on error
          submitButton.disabled = false;
          submitButton.innerHTML = originalText;
          submitButton.style.opacity = '1';
          submitButton.style.backgroundColor = '';
        }
      } else {
        // User cancelled the confirmation dialog
        console.log('â„¹ï¸ User cancelled submission');
      }
    };

    window.viewDraftOpinion = function() {
      openReportPreviewPiP('final-report-template-builder.html?from=expertise&skipValidation=true', 'ğŸ“„ ×¦×¤×™×™×” ×‘×—×•×•×ª ×“×¢×ª ×˜×™×•×˜×”');
    };

    window.viewDraftEstimate = function() {
      openReportPreviewPiP('estimate-report-builder.html?from=expertise&skipValidation=true', 'ğŸ“Š ×¦×¤×™×™×” ×‘××•××“×Ÿ ×˜×™×•×˜×”');
    };

    // Report Preview PiP function
    function openReportPreviewPiP(url, title) {
      // Create floating modal for report preview
      const modal = document.createElement('div');
      modal.id = 'reportPreviewModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.8);
        z-index: 99999;
        display: flex;
        justify-content: center;
        align-items: center;
      `;
      
      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        width: 95vw;
        height: 95vh;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        position: relative;
      `;
      
      const modalHeader = document.createElement('div');
      modalHeader.style.cssText = `
        background: #2c3e50;
        color: white;
        padding: 15px 20px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
        direction: rtl;
      `;
      modalHeader.innerHTML = `
        <span>${title}</span>
        <button onclick="closeReportPreviewPiP()" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold;">âœ• ×¡×’×•×¨</button>
      `;
      
      const iframe = document.createElement('iframe');
      iframe.style.cssText = `
        width: 100%;
        height: calc(100% - 60px);
        border: none;
        border-radius: 0 0 12px 12px;
      `;
      iframe.src = url;
      
      modalContent.appendChild(modalHeader);
      modalContent.appendChild(iframe);
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      
      // Close modal when clicking outside
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeReportPreviewPiP();
        }
      });
    }

    window.closeReportPreviewPiP = function() {
      const modal = document.getElementById('reportPreviewModal');
      if (modal) {
        modal.remove();
      }
    };
  </script>
<script type="module" src="./expertise.js"></script>

</head>
<body>
  <img class="bg" src="https://assets.carmelcayouf.com/assets/bg-report.png" alt="">
  <div class="page">
  <div class="banner" style="border: 4px solid #d4af37; padding: 12px 16px; background-color: #fff8e1; text-align: center; position: relative; min-height: 120px; display: flex; align-items: center; justify-content: space-between; box-sizing: border-box;">
    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0 8px;">
      <div style="font-size: 24px; font-weight: bold; margin-bottom: 4px; line-height: 1.1;">×™×¨×•×Ÿ ×›×™×•×£ - ×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</div>
      <div style="font-size: 22px; font-weight: bold; margin-bottom: 2px;">×¨×™×©×™×•×Ÿ ××¡. 1097</div>
      <div style="font-size: 16px; font-weight: bold; margin-bottom: 2px;">×¢×•×¡×¤×™×, ×¨×—' ××‘× ×—×•×©×™, ××™×§×•×“ 30090, ×ª.×“. 3051</div>
      <div style="font-size: 14px; font-weight: bold; direction: ltr;">office@yc-shamaut.co.il</div>
    </div>
    <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp"
         alt="Logo"
         style="height: 80px; margin-left: 12px; display: block; flex-shrink: 0;">
  </div>

  <div class="watermark">×¡×˜×˜×•×¡</div>

  <h1>×“×•"×— ××§×¡×¤×¨×˜×™×–×”</h1>

  <p class="header-info" style="font-size:22px; font-weight: bold; color: #1e3a8a; text-align: center; margin: 20px 0;">
    ×ª××¨×™×š ×‘×“×™×§×”: <span id="header-date"></span> | ××¡×¤×¨ ×¨×›×‘: <span id="header-plate" style="color: #dc2626; font-weight: bold;"></span>
  </p>

  <table class="outer-border keep-together">
    <thead>
      <tr>
        <th class="table-num"><span>××¡"×“</span></th>
        <th colspan="2">× ×ª×•× ×™ ×¨×›×‘</th>
        <th class="table-num split-border"><span>××¡"×“</span></th>
        <th colspan="2">×¤×¨×˜×™ ×”×ª×§×©×¨×•×ª</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="table-num">1</td><td class="table-param">××¡×¤×¨ ×¨×›×‘</td><td id="plate-1"></td>
        <td class="table-num split-border">15</td><td class="table-param">×©× ×‘×¢×œ ×”×¨×›×‘</td><td id="owner-name"></td>
      </tr>
      <tr>
        <td class="table-num">2</td><td class="table-param">×©× ×”×™×¦×¨×Ÿ</td><td id="manufacturer"></td>
        <td class="table-num split-border">16</td><td class="table-param">×›×ª×•×‘×ª</td><td id="owner-address"></td>
      </tr>
      <tr>
        <td class="table-num">3</td><td class="table-param">×“×’×</td><td id="model"></td>
        <td class="table-num split-border">17</td><td class="table-param">×˜×œ×¤×•×Ÿ</td><td id="owner-phone"></td>
      </tr>
      <tr>
        <td class="table-num">4</td><td class="table-param">×¨××ª ×’×™××•×¨</td><td id="trim"></td>
        <td class="table-num split-border">18</td><td class="table-param">××•×¡×š</td><td id="garage-name"></td>
      </tr>
      <tr>
        <td class="table-num">5</td><td class="table-param">××¡×¤×¨ ×©×™×œ×“×”</td><td id="chassis"></td>
        <td class="table-num split-border">19</td><td class="table-param">××™××™×™×œ ××•×¡×š</td><td id="garage-email"></td>
      </tr>
      <tr>
        <td class="table-num">6</td><td class="table-param">×©× ×ª ×™×™×¦×•×¨</td><td id="year"></td>
        <td class="table-num split-border">20</td><td class="table-param">×˜×œ×¤×•×Ÿ ××•×¡×š</td><td id="garage-phone"></td>
      </tr>
      <tr>
        <td class="table-num">7</td><td class="table-param">××“ ××•×¥</td><td id="km"></td>
        <td class="table-num split-border">21</td><td class="table-param">×—×‘×¨×ª ×‘×™×˜×•×—</td><td id="insurance-company"></td>
      </tr>
      <tr>
        <td class="table-num">8</td><td class="table-param">×¡×•×’ ×”×“×’×</td><td id="model-type"></td>
        <td class="table-num split-border">22</td><td class="table-param">××™××™×™×œ ×—×‘×¨×ª ×‘×™×˜×•×—</td><td id="insurance-email"></td>
      </tr>
      <tr>
        <td class="table-num">9</td><td class="table-param">×ª××¨×™×š ×”× ×–×§</td><td id="damage-date"></td>
        <td class="table-num split-border">23</td><td class="table-param">×¡×•×›×Ÿ ×‘×™×˜×•×—</td><td id="insurance-agent-name"></td>
      </tr>
      <tr>
        <td class="table-num">10</td><td class="table-param">×ª××¨×™×š ×‘×“×™×§×”</td><td id="inspection-date"></td>
        <td class="table-num split-border">24</td><td class="table-param">×˜×œ×¤×•×Ÿ ×¡×•×›×Ÿ ×‘×™×˜×•×—</td><td id="insurance-agent-phone"></td>
      </tr>
      <tr>
        <td class="table-num">11</td><td class="table-param">×§×•×“ ×“×’×</td><td id="model-code"></td>
        <td class="table-num split-border">25</td><td class="table-param">××™××™×™×œ ×¡×•×›×Ÿ ×‘×™×˜×•×—</td><td id="insurance-agent-email"></td>
      </tr>
      <tr>
        <td class="table-num">12</td><td class="table-param">×¡×•×’ ×”×¨×›×‘</td><td id="vehicle-type"></td>
        <td class="table-num split-border">26</td><td class="table-param">×¡×•×’ × ×–×§</td><td id="damage-type"></td>
      </tr>
      <tr>
        <td class="table-num">13</td><td class="table-param">×¡×•×’ ×‘×¢×œ×•×ª</td><td id="ownership-type"></td>
        <td class="table-num split-border">27</td><td class="table-param">××§×•× ×‘×“×™×§×”</td><td id="inspection-location"></td>
      </tr>
      <tr>
        <td class="table-num">14</td><td class="table-param">××—×™×¨ ×‘×¡×™×¡</td><td id="base-price"></td>
        <td class="table-num split-border">28</td><td class="table-param"></td><td></td>
      </tr>
    </tbody>
  </table>

  <div class="paragraph">
    <h2 class="section-title">××¤×¨×˜ ×ª×™×§×•×Ÿ - ×”×¢×¨×›×ª × ×–×§ (××‘×œ×™ ×œ×¤×’×•×¢ ×‘×–×›×•×™×•×ª)</h2>
    <div class="damage-centers-container">
      <!-- Damage centers will be populated by JavaScript -->
    </div>
  </div>

  <!-- Multi-Damage Centers Summary -->
  <div class="paragraph summary-section">
    <h2 class="section-title" style="font-size: 16px; text-align: center; color: #dc2626; font-weight: bold;">×¡×™×›×•× ×›×œ×œ ××•×§×“×™ ×”× ×–×§</h2>
    <table class="outer-border keep-together">
      <thead class="header-bottom-bold">
        <tr>
          <th class="table-num"><span>××¡"×“</span></th>
          <th class="table-param">××•×§×“ × ×–×§</th>
          <th class="table-param">×¡×”"×› ×—×œ×§×™×</th>
          <th class="table-param">×¡×”"×› ×¢×‘×•×“×•×ª</th>
          <th class="table-param">×¡×”"×› ×ª×™×§×•× ×™×</th>
          <th class="table-param">×¡×”"×› ×¢×¨×š ××•×§×“</th>
        </tr>
      </thead>
      <tbody class="damage-summary-table">
        <!-- Summary rows will be populated by JavaScript -->
      </tbody>
    </table>
    
    <div style="margin-top: 15px; padding: 12px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px;">
      <div style="font-weight: bold; color: #1e3a8a; margin-bottom: 8px; font-size: 22px;">×¤×™×¨×•×˜ × ×•×¡×£:</div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 16px;">
        <div><strong>××¡×¤×¨ ××•×§×“×™ × ×–×§:</strong> <span id="centers-count"></span></div>
        <div><strong>×¡×›×•× × ×–×§×™× ×œ×œ× ××¢"×:</strong> <span id="before-tax"></span></div>
        <div><strong>××¢"×:</strong> <span id="vat-amount"></span></div>
        <div><strong>×¡×›×•× × ×–×§×™× ×›×•×œ×œ ××¢"×:</strong> <span id="after-tax"></span></div>
      </div>
    </div>
  </div>

  <div class="paragraph page-break-inside-avoid">
    <h2 class="section-title" style="font-size: 24px; font-weight: bold; text-align: center;">×”×¢×¨×›×” ×›×œ×œ×™×ª</h2>
    <div class="text-box">
      <p id="assessment-notes" style="font-size: 20px; line-height: 1.6; margin: 15px 0; text-align: justify;"></p>
    </div>
    <div style="text-align: center; margin: 20px 0;">
      <div style="background: #f8fafc; padding: 10px 15px; border-radius: 8px; border: 2px solid #e2e8f0; display: inline-block; min-width: 300px; max-width: 95%; word-wrap: break-word; white-space: normal;">
      <p style="margin: 6px 0; font-size: 18px; text-align: center;">
        <span style="font-weight:bold; color:#1e3a8a;">×”× ×—×™×™×ª ×ª×™×§:</span>
        <span style="font-weight:bold; color:#dc2626; font-size: 22px;" id="directive-text"></span>
      </p>
      <p id="additional-notes" style="margin: 8px 0; font-size: 17px; display: none; white-space: normal; word-wrap: break-word; line-height: 1.4;">
        <span style="font-weight:bold; color:#1e3a8a;">×”×¢×¨×•×ª × ×•×¡×¤×•×ª:</span>
        <span style="font-weight:bold; color:#000;" id="additional-notes-content"></span>
      </p>
      <p style="margin: 8px 0; font-size: 17px;">
        <span style="font-weight:bold; color:#1e3a8a;">×©×××™:</span>
        <span style="font-weight:bold; color:#000;" id="technician-info"></span>
      </p>
      </div>
    </div>
  </div>

  <div class="paragraph page-break-inside-avoid">
    <h2 class="section-title" style="font-size: 24px; font-weight: bold; text-align: center;">×”×¦×”×¨×”</h2>
    <div style="background: #ffcccc; border: 1px solid #ccc; padding: 6px 12px; font-weight: bold; text-align: center; font-size: 16px; margin: 12px 0;">
      ×›×“×™ ×œ×× ×•×¢ ××™ ×”×‘× ×” - ×©×™× ×œ×‘ ×œ×”×¢×¨×•×ª ×”×¨×´×:
    </div>
    <div style="border: 2px solid #475569; padding: 8px 15px; background: #f8fafc; margin-top: 8px; border-radius: 6px;">
      <ol style="margin: 0; padding-right: 20px; font-size: 16px; line-height: 1.5;">
        <li style="margin-bottom: 6px;">×™×© ×œ×”×•×“×™×¢ ×œ×©×××™ ×¢×œ ×›×œ × ×–×§ × ×•×¡×£.</li>
        <li style="margin-bottom: 6px;">×”×¦×¢×ª ×ª×™×§×•×Ÿ ×–×• ×›×¤×•×¤×” ×œ×¢×™×•×Ÿ ×‘×˜×•×¤×¡ ×”×ª×‘×™×¢×”.</li>
        <li style="margin-bottom: 6px;">×”×—×œ×§×™× ×©×™×¤×•×¨×§×• ××”×¨×›×‘ ×™×¢××“×• ×œ×¨×©×•×ª ×—×‘×¨×ª ×”×‘×™×˜×•×—.</li>
        <li style="margin-bottom: 6px;">×”×¦×¢×” ×–×• ××™× ×” ××—×™×™×‘×ª ××ª ×—×‘×¨×ª ×”×‘×™×˜×•×— ×œ×ª×©×œ×•× ×›×œ×©×”×•.</li>
      </ol>
    </div>
  </div>

  <!-- Control Buttons Section (moved from summary page) -->
  <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin: 30px 0; border: 2px solid #e2e8f0; text-align: center; page-break-inside: avoid;" class="no-print">
    <h3 style="color: #1e3a8a; margin-bottom: 15px;">×¤×¢×•×œ×•×ª ×¢×œ ×”×“×•"×—</h3>
    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ffeaa7;">
      <strong>×”×•×“×¢×” ×—×©×•×‘×”:</strong> ×œ××—×¨ ××™×©×•×¨ ×¡×•×¤×™ ×•×©×œ×™×—×” ×ª×™×¡×’×¨ ×”××§×¡×¤×™×¨×˜×™×–×”, ×™×™×©×œ×— ××™××™×™×œ ×œ××•×¡×š ×•×ª×™×•×•×¦×¨ ×—×•×•×ª ×“×¢×ª ×¡×•×¤×™×ª ×œ×¨×›×‘ ××¡×³ <strong class="warning-plate"></strong> ×‘×ª××¨×™×š <strong class="warning-date"></strong>.
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 15px;">
      <button type="button" class="control-btn edit-btn" onclick="editExpertise()">
        âœï¸ ×¢×¨×™×›×ª × ×ª×•× ×™×
      </button>
      <button type="button" class="control-btn preview-btn" onclick="printPreview()">
        ğŸ–¨ï¸ ×ª×¦×•×’×” ××§×“×™××” ×œ×”×“×¤×¡×”
      </button>
      <button type="button" class="control-btn submit-btn" onclick="submitFinalExpertise()">
        ğŸ“¤ ××™×©×•×¨ ×¡×•×¤×™ ×•×©×œ×™×—×”
      </button>
      <button type="button" class="control-btn home-btn" onclick="window.location.href='selection.html'">
        ğŸ  ×—×–×•×¨ ×œ×“×£ ×”×‘×—×™×¨×”
      </button>
      <button type="button" class="control-btn draft-opinion-btn" onclick="viewDraftOpinion()">
        ğŸ“„ ×¦×¤×™×™×” ×‘×—×•×•×ª ×“×¢×ª ×˜×™×•×˜×”
      </button>
      <button type="button" class="control-btn draft-estimate-btn" onclick="viewDraftEstimate()">
        ğŸ“Š ×¦×¤×™×™×” ×‘××•××“×Ÿ ×˜×™×•×˜×”
      </button>
    </div>
  </div>

  <div class="footer page-break-inside-avoid">
    <div style="text-align: center; font-weight: bold; margin-bottom: 40px; font-size: 20px;">×‘×›×‘×•×“ ×¨×‘,</div>
    <div style="display: flex; flex-direction: row-reverse; align-items: flex-start; justify-content: space-between;">
      <div>
        <img src="https://carmelcayouf.com/wp-content/uploads/2025/04/yaron-signature-transparent-.webp" class="signature-img" alt="×—×ª×™××”" style="width: 180px; height: auto;">
        <div class="signature-date" style="font-size: 16px; font-weight: bold; margin-top: 8px; text-align: center;"></div>
      </div>
      <div>
        <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp"
             alt="Logo"
             style="height: 120px; margin-left: 0; margin-right: 16px; display: block;">
      </div>
    </div>
    <div style="text-align: center; font-size: 14px; color: #64748b; margin-top: 20px; border-top: 1px solid #e2e8f0; padding-top: 15px; font-weight: bold;">
      ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª Â© ×™×¨×•×Ÿ ×›×™×•×£ - ×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©
    </div>
  </div>
  
  <!-- Floating screens integration -->
  <script src="car-details-floating.js"></script>
  <script src="levi-floating.js"></script>
  <script src="parts-search-results-floating.js"></script>
  <script src="internal-browser.js"></script>
  </div>
</body>
</html>
