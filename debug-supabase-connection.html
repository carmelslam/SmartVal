<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Supabase Connection</title>
    <style>
        body { font-family: Arial; margin: 20px; direction: rtl; }
        .test-result { background: #f5f5f5; padding: 15px; margin: 15px 0; border-radius: 8px; }
        .error { background: #ffebee; border-left: 4px solid #f44336; }
        .success { background: #e8f5e9; border-left: 4px solid #4caf50; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; background: #2196F3; color: white; }
        pre { background: #f0f0f0; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîß Debug Supabase Connection</h1>

    <button onclick="testConnection()">Test Basic Connection</button>
    <button onclick="testCatalogTable()">Test catalog_items Table</button>
    <button onclick="testRPCFunction()">Test smart_parts_search RPC</button>
    <button onclick="testToyotaSearch()">Test Toyota Search</button>

    <div id="results"></div>

    <script src="./services/supabaseClient.js"></script>
    <script>
        const results = document.getElementById('results');

        function addResult(title, content, isError = false) {
            const className = isError ? 'test-result error' : 'test-result success';
            results.innerHTML += `<div class="${className}"><h3>${title}</h3><pre>${content}</pre></div>`;
        }

        async function testConnection() {
            results.innerHTML = '';
            try {
                if (!window.supabase) {
                    addResult('‚ùå Connection Test', 'Supabase client not loaded', true);
                    return;
                }

                // Test basic connection
                const { data, error } = await window.supabase
                    .from('catalog_items')
                    .select('count')
                    .limit(1);

                if (error) {
                    addResult('‚ùå Connection Test', `Connection failed: ${error.message}`, true);
                } else {
                    addResult('‚úÖ Connection Test', 'Supabase connection working');
                }
            } catch (err) {
                addResult('‚ùå Connection Test', `Exception: ${err.message}`, true);
            }
        }

        async function testCatalogTable() {
            try {
                // Test if table exists and has data
                const { data, error, count } = await window.supabase
                    .from('catalog_items')
                    .select('*', { count: 'exact' })
                    .limit(3);

                if (error) {
                    addResult('‚ùå catalog_items Test', `Table error: ${error.message}`, true);
                    return;
                }

                if (!data || data.length === 0) {
                    addResult('‚ö†Ô∏è catalog_items Test', 'Table is empty - no data to search!', true);
                    return;
                }

                let result = `Table has data: ${count || data.length} rows\n\n`;
                result += 'Sample data:\n';
                data.forEach((item, i) => {
                    result += `Row ${i + 1}:\n`;
                    result += `  ID: ${item.id}\n`;
                    result += `  Make: ${item.make}\n`;
                    result += `  Model: ${item.model}\n`;
                    result += `  Description: ${item.cat_num_desc}\n`;
                    result += `  PCODE: ${item.pcode}\n\n`;
                });

                addResult('‚úÖ catalog_items Test', result);
            } catch (err) {
                addResult('‚ùå catalog_items Test', `Exception: ${err.message}`, true);
            }
        }

        async function testRPCFunction() {
            try {
                // Test if RPC function exists
                const { data, error } = await window.supabase
                    .rpc('smart_parts_search', {
                        limit_results: 5
                    });

                if (error) {
                    addResult('‚ùå RPC Function Test', `RPC failed: ${error.message}\n\nThis means DEPLOY_FUNCTIONS.sql was not properly deployed or failed.`, true);
                    return;
                }

                if (!data || data.length === 0) {
                    addResult('‚ö†Ô∏è RPC Function Test', 'RPC exists but returns no data - table might be empty');
                    return;
                }

                let result = `RPC function working! Returned ${data.length} results\n\n`;
                result += 'Sample RPC results:\n';
                data.forEach((item, i) => {
                    result += `Result ${i + 1}:\n`;
                    result += `  ID: ${item.id}\n`;
                    result += `  Make: ${item.make}\n`;
                    result += `  Model: ${item.model}\n`;
                    result += `  Description: ${item.cat_num_desc}\n\n`;
                });

                addResult('‚úÖ RPC Function Test', result);
            } catch (err) {
                addResult('‚ùå RPC Function Test', `Exception: ${err.message}`, true);
            }
        }

        async function testToyotaSearch() {
            try {
                // Test Hebrew Toyota search first
                let { data, error } = await window.supabase
                    .rpc('smart_parts_search', {
                        make_param: '◊ò◊ï◊ô◊ï◊ò◊î',
                        limit_results: 10
                    });

                let result = '';
                
                if (error) {
                    result += `Hebrew Toyota search failed: ${error.message}\n\n`;
                } else if (!data || data.length === 0) {
                    result += '‚ö†Ô∏è No Hebrew Toyota (◊ò◊ï◊ô◊ï◊ò◊î) parts found\n\n';
                } else {
                    result += `‚úÖ Found ${data.length} Hebrew Toyota (◊ò◊ï◊ô◊ï◊ò◊î) parts!\n\n`;
                    data.slice(0, 3).forEach((item, i) => {
                        result += `Hebrew Toyota Part ${i + 1}:\n`;
                        result += `  Make: ${item.make}\n`;
                        result += `  Model: ${item.model}\n`;
                        result += `  Description: ${item.cat_num_desc}\n\n`;
                    });
                }

                // Test English Toyota search
                const englishResult = await window.supabase
                    .rpc('smart_parts_search', {
                        make_param: 'Toyota',
                        limit_results: 10
                    });

                if (englishResult.error) {
                    result += `English Toyota search failed: ${englishResult.error.message}\n`;
                } else if (!englishResult.data || englishResult.data.length === 0) {
                    result += '‚ö†Ô∏è No English Toyota parts found\n';
                } else {
                    result += `‚úÖ Found ${englishResult.data.length} English Toyota parts!\n\n`;
                    englishResult.data.slice(0, 3).forEach((item, i) => {
                        result += `English Toyota Part ${i + 1}:\n`;
                        result += `  Make: ${item.make}\n`;
                        result += `  Model: ${item.model}\n`;
                        result += `  Description: ${item.cat_num_desc}\n\n`;
                    });
                }

                const isSuccess = (data && data.length > 0) || (englishResult.data && englishResult.data.length > 0);
                addResult(isSuccess ? '‚úÖ Toyota Search Test' : '‚ö†Ô∏è Toyota Search Test', result, !isSuccess);
            } catch (err) {
                addResult('‚ùå Toyota Search Test', `Exception: ${err.message}`, true);
            }
        }
    </script>
</body>
</html>