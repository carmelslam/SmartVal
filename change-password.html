<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×©×™× ×•×™ ×¡×™×¡××” - ×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª</title>

  <!-- Favicon -->
  <link rel="icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" type="image/webp" />
  
  <style>
    body {
      font-family: sans-serif;
      background: linear-gradient(to bottom right, #1e3a8a, #3b82f6);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      background: white;
      padding: 40px 30px;
      border-radius: 16px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.15);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    .logo {
      width: 100px;
      margin-bottom: 20px;
    }
    h1 {
      font-size: 22px;
      margin: 10px 0;
      color: #1e3a8a;
    }
    h2 {
      font-size: 16px;
      margin-bottom: 20px;
      color: #64748b;
    }
    .info-box {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
      text-align: right;
      font-size: 14px;
      color: #856404;
    }
    label {
      display: block;
      text-align: right;
      margin-bottom: 5px;
      font-weight: bold;
      color: #1e3a8a;
      font-size: 14px;
    }
    input[type="password"] {
      padding: 12px;
      font-size: 16px;
      width: 100%;
      border: 1px solid #64748b;
      border-radius: 8px;
      margin-bottom: 15px;
      box-sizing: border-box;
    }
    input[type="password"]:focus {
      outline: none;
      border-color: #1e3a8a;
      box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
    }
    button {
      padding: 12px;
      font-size: 18px;
      width: 100%;
      background: #1e3a8a;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #3b82f6;
    }
    button:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }
    .error {
      color: #dc3545;
      margin-top: 10px;
      font-size: 14px;
      text-align: center;
    }
    .password-requirements {
      background: #e7f3ff;
      border: 1px solid #2196F3;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 15px;
      text-align: right;
      font-size: 12px;
    }
    .password-requirements ul {
      margin: 5px 0;
      padding-right: 20px;
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo" class="logo">
    <h1>×©×™× ×•×™ ×¡×™×¡××”</h1>
    <h2>× ×“×¨×© ×©×™× ×•×™ ×¡×™×¡××” ×–×× ×™×ª</h2>

    <div class="info-box">
      âš ï¸ ×”×¡×™×¡××” ×©×§×™×‘×œ×ª ×”×™× ×–×× ×™×ª. ×× × ×‘×—×¨ ×¡×™×¡××” ×—×“×©×” ×œ×©×™××•×© ×§×‘×•×¢ ×‘××¢×¨×›×ª.
    </div>

    <form id="changePasswordForm">
      <!-- Hidden email field for browser password manager -->
      <input 
        type="email" 
        id="userEmail" 
        autocomplete="username" 
        style="display: none;"
        readonly
      />
      
      <div style="margin-bottom: 15px;">
        <label for="currentPassword">×¡×™×¡××” × ×•×›×—×™×ª (×–×× ×™×ª):</label>
        <input 
          type="password" 
          id="currentPassword" 
          placeholder="×”×¡×™×¡××” ×”×–×× ×™×ª ×©×§×™×‘×œ×ª"
          autocomplete="current-password"
          required
        />
      </div>

      <div class="password-requirements">
        <strong>×“×¨×™×©×•×ª ×¡×™×¡××”:</strong>
        <ul>
          <li>×œ×¤×—×•×ª 8 ×ª×•×•×™×</li>
          <li>××•××œ×¥: ×©×™×œ×•×‘ ×©×œ ××•×ª×™×•×ª ×•××¡×¤×¨×™×</li>
        </ul>
      </div>

      <div style="margin-bottom: 15px;">
        <label for="newPassword">×¡×™×¡××” ×—×“×©×”:</label>
        <input 
          type="password" 
          id="newPassword" 
          placeholder="×”×–×Ÿ ×¡×™×¡××” ×—×“×©×”"
          minlength="8"
          autocomplete="new-password"
          required
        />
      </div>

      <div style="margin-bottom: 20px;">
        <label for="confirmPassword">××™××•×ª ×¡×™×¡××” ×—×“×©×”:</label>
        <input 
          type="password" 
          id="confirmPassword" 
          placeholder="×”×–×Ÿ ×¡×™×¡××” ×—×“×©×” ×©×•×‘"
          minlength="8"
          autocomplete="new-password"
          required
        />
      </div>

      <button type="submit" id="submitBtn">ğŸ”’ ×©× ×” ×¡×™×¡××”</button>
      <div id="errorMessage" class="error"></div>
    </form>
  </div>

  <script type="module">
    import { authService } from './services/authService.js';
    import { supabase } from './lib/supabaseClient.js';

    const form = document.getElementById('changePasswordForm');
    const submitBtn = document.getElementById('submitBtn');
    const errorDiv = document.getElementById('errorMessage');
    
    let isPasswordResetFlow = false;
    
    // Check for password reset token in URL (both hash and query params)
    (async function checkPasswordResetToken() {
      // Try hash params first (our custom format)
      let hashParams = new URLSearchParams(window.location.hash.substring(1));
      let accessToken = hashParams.get('access_token');
      let refreshToken = hashParams.get('refresh_token');
      let type = hashParams.get('type');
      
      // If not found, try query params (Supabase ConfirmationURL format)
      if (!accessToken) {
        const queryParams = new URLSearchParams(window.location.search);
        accessToken = queryParams.get('token') || queryParams.get('access_token');
        refreshToken = queryParams.get('refresh_token');
        type = queryParams.get('type') || 'recovery'; // Default to recovery for password reset
      }
      
      if (accessToken && (type === 'recovery' || window.location.search.includes('token='))) {
        console.log('ğŸ”‘ Password reset link detected - token hash:', accessToken.substring(0, 20) + '...');
        isPasswordResetFlow = true;
        
        // Store the recovery token for later use when submitting new password
        // DON'T verify it yet - tokens are ONE-TIME USE!
        sessionStorage.setItem('recovery_token', accessToken);
        sessionStorage.setItem('recovery_refresh_token', refreshToken || '');
        
        // Hide current password field (not needed for reset)
        const currentPasswordField = document.getElementById('currentPassword');
        const currentPasswordGroup = currentPasswordField.parentElement;
        currentPasswordGroup.style.display = 'none';
        
        // Remove required attribute and disable field so form validation doesn't fail
        currentPasswordField.removeAttribute('required');
        currentPasswordField.disabled = true;
        
        console.log('âœ… Current password field hidden and disabled');
        
        // Update info box text
        const infoBox = document.querySelector('.info-box');
        if (infoBox) {
          infoBox.textContent = '××¤×¡ ××ª ×¡×™×¡××ª×š ×¢×œ ×™×“×™ ×”×–× ×ª ×¡×™×¡××” ×—×“×©×” ×œ××˜×”.';
        }
        
        // Clear hash from URL for security
        history.replaceState(null, '', 'change-password.html');
        
        console.log('âœ… Password reset flow initialized - ready for new password');
        console.log('âš ï¸ Token saved for one-time use on submit');
      }
    })();

    function showError(message) {
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    function clearError() {
      errorDiv.textContent = '';
      errorDiv.style.display = 'none';
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearError();

      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      // Validate passwords match
      if (newPassword !== confirmPassword) {
        showError('×”×¡×™×¡×××•×ª ××™× ×Ÿ ×ª×•×××•×ª');
        return;
      }

      // Validate password length
      if (newPassword.length < 8) {
        showError('×”×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×™×•×ª ×œ×¤×—×•×ª 8 ×ª×•×•×™×');
        return;
      }

      // Validate not same as current (skip for password reset flow)
      if (!isPasswordResetFlow && newPassword === currentPassword) {
        showError('×”×¡×™×¡××” ×”×—×“×©×” ×—×™×™×‘×ª ×œ×”×™×•×ª ×©×•× ×” ××”×¡×™×¡××” ×”×–×× ×™×ª');
        return;
      }

      // Disable button and show loading
      submitBtn.disabled = true;
      submitBtn.textContent = 'ğŸ”„ ××©× ×” ×¡×™×¡××”...';

      try {
        console.log('ğŸ”„ Starting password change process...');

        let changeResult;
        
        // Check if this is a password reset flow (has recovery token)
        const recoveryToken = sessionStorage.getItem('recovery_token');
        
        if (isPasswordResetFlow && recoveryToken) {
          console.log('ğŸ”‘ Using recovery token to reset password');
          
          // Use Supabase verify API to exchange token for session
          const verifyResult = await supabase.auth.verifyOtp({
            token_hash: recoveryToken,
            type: 'recovery'
          });
          
          if (verifyResult.error) {
            throw new Error(verifyResult.error.message || '×©×’×™××” ×‘××™××•×ª ×˜×•×§×Ÿ ××™×¤×•×¡');
          }
          
          console.log('âœ… Token verified, session established');
          console.log('ğŸ” Session data:', verifyResult.data?.session?.access_token ? 'has access_token' : 'NO access_token');
          
          // Populate email field for password manager AND show it to user
          if (verifyResult.data?.user?.email) {
            const userEmail = verifyResult.data.user.email;
            document.getElementById('userEmail').value = userEmail;
            console.log('ğŸ“§ Email set for password manager:', userEmail);
            
            // Update info box to show which account is being reset
            const infoBox = document.querySelector('.info-box');
            if (infoBox) {
              infoBox.innerHTML = `
                <div style="text-align: right;">
                  <strong>×—×©×‘×•×Ÿ:</strong> ${userEmail}<br>
                  ××¤×¡ ××ª ×¡×™×¡××ª×š ×¢×œ ×™×“×™ ×”×–× ×ª ×¡×™×¡××” ×—×“×©×” ×œ××˜×”.
                </div>
              `;
            }
          }
          
          // Verify session was stored
          const storedAuth = sessionStorage.getItem('auth');
          console.log('ğŸ” Stored auth:', storedAuth ? 'found' : 'MISSING');
          
          // Now update the password using the new session
          console.log('ğŸ”„ Updating password...');
          const updateResult = await supabase.auth.updateUser({ password: newPassword });
          
          if (updateResult.error) {
            console.error('âŒ Update password error:', updateResult.error);
            throw new Error(updateResult.error.message || '×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×™×¡××”');
          }
          
          console.log('âœ… Password updated successfully');
          
          // Get the user profile and clear must_change_password flag
          const userId = verifyResult.data?.user?.id;
          if (userId) {
            // Fetch user profile from database
            const { data: profile, error: profileError } = await supabase
              .from('profiles')
              .select('*')
              .eq('user_id', userId)
              .single();
            
            if (profileError) {
              console.error('âŒ Failed to fetch profile:', profileError);
            } else {
              console.log('âœ… Profile loaded:', profile.name);
              
              // Clear must_change_password flag in database
              try {
                const { data: updateData, error: updateError } = await supabase
                  .from('profiles')
                  .update({ must_change_password: false })
                  .eq('user_id', userId);
                
                if (updateError) {
                  console.error('âŒ Failed to clear must_change_password flag:', updateError);
                } else {
                  console.log('âœ… Cleared must_change_password flag for user:', userId);
                }
                
                // Update profile in memory
                if (profile) {
                  profile.must_change_password = false;
                }
              } catch (err) {
                console.error('âš ï¸ Exception clearing must_change_password flag:', err);
              }
              
              // Update the session storage with complete auth data
              const authData = {
                user: verifyResult.data.user,
                session: verifyResult.data.session,
                profile
              };
              sessionStorage.setItem('auth', JSON.stringify(authData));
            }
          }
          
          changeResult = { success: true };
          
          // Clean up recovery token
          sessionStorage.removeItem('recovery_token');
          sessionStorage.removeItem('recovery_refresh_token');
        } else {
          // Regular password change flow (user is already authenticated)
          changeResult = await authService.changePassword(newPassword);
        }

        if (!changeResult.success) {
          throw new Error(changeResult.error || '×©×’×™××” ×‘×©×™× ×•×™ ×¡×™×¡××”');
        }

        console.log('âœ… Password changed successfully');

        // Success!
        submitBtn.textContent = 'âœ… ×”×¡×™×¡××” ×©×•× ×ª×” ×‘×”×¦×œ×—×”!';
        submitBtn.style.background = '#28a745';

        // Clear pending email
        sessionStorage.removeItem('pendingEmail');

        // Decide where to redirect based on flow type
        const redirectUrl = isPasswordResetFlow ? 'index.html' : 'selection.html';
        const redirectMessage = isPasswordResetFlow ? '××¢×‘×™×¨ ×œ×“×£ ×”×ª×—×‘×¨×•×ª...' : '××¢×‘×™×¨...';
        
        // Show redirect message
        setTimeout(() => {
          submitBtn.textContent = `âœ… ${redirectMessage}`;
        }, 1000);

        // Wait a moment then redirect
        setTimeout(async () => {
          if (isPasswordResetFlow) {
            // Password reset flow - clear session and go to login
            console.log('â¡ï¸ Password reset complete - logging out and redirecting...');
            
            // Sign out from Supabase
            try {
              await supabase.auth.signOut();
            } catch (err) {
              console.warn('Sign out error (ignoring):', err);
            }
            
            // Clear all local storage
            sessionStorage.clear();
            localStorage.clear();
            
            alert('×”×¡×™×¡××” ×©×•× ×ª×” ×‘×”×¦×œ×—×”! × × ×œ×”×ª×—×‘×¨ ×¢× ×”×¡×™×¡××” ×”×—×“×©×”.');
            
            // Force redirect to login
            window.location.replace('index.html'); // Use replace to prevent back button
          } else {
            // Normal password change flow - go to selection
            console.log('â¡ï¸ Redirecting to selection page...');
            window.location.href = 'selection.html';
          }
        }, 2000);

      } catch (error) {
        console.error('âŒ Password change error:', error);
        showError(error.message || '×©×’×™××” ×‘×©×™× ×•×™ ×¡×™×¡××”. × ×¡×” ×©×•×‘.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ”’ ×©× ×” ×¡×™×¡××”';
      }
    });

    // On page load, verify user is authenticated (unless in password reset flow)
    window.addEventListener('load', async () => {
      console.log('ğŸ” Change password page loaded');
      
      // Allow access if there's a recovery token (password reset flow)
      const recoveryToken = sessionStorage.getItem('recovery_token');
      if (recoveryToken) {
        console.log('âœ… Recovery token found - password reset flow active');
        return; // Don't check authentication
      }
      
      // Otherwise, check if user is authenticated (normal password change flow)
      const authData = sessionStorage.getItem('auth');
      if (!authData) {
        console.log('âŒ No auth data and no recovery token, redirecting to login');
        window.location.href = 'index.html';
        return;
      }

      try {
        const auth = JSON.parse(authData);
        console.log('âœ… User authenticated:', auth.user.email);
        
        // Pre-fill email if available
        const pendingEmail = sessionStorage.getItem('pendingEmail') || auth.user.email;
        console.log('ğŸ“§ User email:', pendingEmail);
        
      } catch (error) {
        console.error('âŒ Error parsing auth:', error);
        window.location.href = 'index.html';
      }
    });
  </script>
</body>
</html>
