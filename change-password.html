<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×©×™× ×•×™ ×¡×™×¡××” - ×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª</title>

  <!-- Favicon -->
  <link rel="icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" type="image/webp" />
  
  <style>
    body {
      font-family: sans-serif;
      background: linear-gradient(to bottom right, #1e3a8a, #3b82f6);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      background: white;
      padding: 40px 30px;
      border-radius: 16px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.15);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    .logo {
      width: 100px;
      margin-bottom: 20px;
    }
    h1 {
      font-size: 22px;
      margin: 10px 0;
      color: #1e3a8a;
    }
    h2 {
      font-size: 16px;
      margin-bottom: 20px;
      color: #64748b;
    }
    .info-box {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
      text-align: right;
      font-size: 14px;
      color: #856404;
    }
    label {
      display: block;
      text-align: right;
      margin-bottom: 5px;
      font-weight: bold;
      color: #1e3a8a;
      font-size: 14px;
    }
    input[type="password"] {
      padding: 12px;
      font-size: 16px;
      width: 100%;
      border: 1px solid #64748b;
      border-radius: 8px;
      margin-bottom: 15px;
      box-sizing: border-box;
    }
    input[type="password"]:focus {
      outline: none;
      border-color: #1e3a8a;
      box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
    }
    button {
      padding: 12px;
      font-size: 18px;
      width: 100%;
      background: #1e3a8a;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #3b82f6;
    }
    button:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }
    .error {
      color: #dc3545;
      margin-top: 10px;
      font-size: 14px;
      text-align: center;
    }
    .password-requirements {
      background: #e7f3ff;
      border: 1px solid #2196F3;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 15px;
      text-align: right;
      font-size: 12px;
    }
    .password-requirements ul {
      margin: 5px 0;
      padding-right: 20px;
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo" class="logo">
    <h1>×©×™× ×•×™ ×¡×™×¡××”</h1>
    <h2>× ×“×¨×© ×©×™× ×•×™ ×¡×™×¡××” ×–×× ×™×ª</h2>

    <div class="info-box">
      âš ï¸ ×”×¡×™×¡××” ×©×§×™×‘×œ×ª ×”×™× ×–×× ×™×ª. ×× × ×‘×—×¨ ×¡×™×¡××” ×—×“×©×” ×œ×©×™××•×© ×§×‘×•×¢ ×‘××¢×¨×›×ª.
    </div>

    <form id="changePasswordForm">
      <div style="margin-bottom: 15px;">
        <label for="currentPassword">×¡×™×¡××” × ×•×›×—×™×ª (×–×× ×™×ª):</label>
        <input 
          type="password" 
          id="currentPassword" 
          placeholder="×”×¡×™×¡××” ×”×–×× ×™×ª ×©×§×™×‘×œ×ª"
          required
        />
      </div>

      <div class="password-requirements">
        <strong>×“×¨×™×©×•×ª ×¡×™×¡××”:</strong>
        <ul>
          <li>×œ×¤×—×•×ª 8 ×ª×•×•×™×</li>
          <li>××•××œ×¥: ×©×™×œ×•×‘ ×©×œ ××•×ª×™×•×ª ×•××¡×¤×¨×™×</li>
        </ul>
      </div>

      <div style="margin-bottom: 15px;">
        <label for="newPassword">×¡×™×¡××” ×—×“×©×”:</label>
        <input 
          type="password" 
          id="newPassword" 
          placeholder="×”×–×Ÿ ×¡×™×¡××” ×—×“×©×”"
          minlength="8"
          required
        />
      </div>

      <div style="margin-bottom: 20px;">
        <label for="confirmPassword">××™××•×ª ×¡×™×¡××” ×—×“×©×”:</label>
        <input 
          type="password" 
          id="confirmPassword" 
          placeholder="×”×–×Ÿ ×¡×™×¡××” ×—×“×©×” ×©×•×‘"
          minlength="8"
          required
        />
      </div>

      <button type="submit" id="submitBtn">ğŸ”’ ×©× ×” ×¡×™×¡××”</button>
      <div id="errorMessage" class="error"></div>
    </form>
  </div>

  <script type="module">
    import { authService } from './services/authService.js';

    const form = document.getElementById('changePasswordForm');
    const submitBtn = document.getElementById('submitBtn');
    const errorDiv = document.getElementById('errorMessage');

    function showError(message) {
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    function clearError() {
      errorDiv.textContent = '';
      errorDiv.style.display = 'none';
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearError();

      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      // Validate passwords match
      if (newPassword !== confirmPassword) {
        showError('×”×¡×™×¡×××•×ª ××™× ×Ÿ ×ª×•×××•×ª');
        return;
      }

      // Validate password length
      if (newPassword.length < 8) {
        showError('×”×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×™×•×ª ×œ×¤×—×•×ª 8 ×ª×•×•×™×');
        return;
      }

      // Validate not same as current
      if (newPassword === currentPassword) {
        showError('×”×¡×™×¡××” ×”×—×“×©×” ×—×™×™×‘×ª ×œ×”×™×•×ª ×©×•× ×” ××”×¡×™×¡××” ×”×–×× ×™×ª');
        return;
      }

      // Disable button and show loading
      submitBtn.disabled = true;
      submitBtn.textContent = 'ğŸ”„ ××©× ×” ×¡×™×¡××”...';

      try {
        // First verify current password by attempting login
        const loginResult = await authService.login(
          sessionStorage.getItem('pendingEmail') || '',
          currentPassword
        );

        if (!loginResult.success) {
          throw new Error('×”×¡×™×¡××” ×”× ×•×›×—×™×ª ×©×’×•×™×”');
        }

        // Now change to new password
        const changeResult = await authService.changePassword(newPassword);

        if (!changeResult.success) {
          throw new Error(changeResult.error || '×©×’×™××” ×‘×©×™× ×•×™ ×¡×™×¡××”');
        }

        // Success!
        submitBtn.textContent = 'âœ… ×”×¡×™×¡××” ×©×•× ×ª×” ×‘×”×¦×œ×—×”!';
        submitBtn.style.background = '#28a745';

        // Clear pending email
        sessionStorage.removeItem('pendingEmail');

        // Wait a moment then redirect
        setTimeout(() => {
          window.location.href = 'selection.html';
        }, 1500);

      } catch (error) {
        console.error('Password change error:', error);
        showError(error.message || '×©×’×™××” ×‘×©×™× ×•×™ ×¡×™×¡××”. × ×¡×” ×©×•×‘.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ”’ ×©× ×” ×¡×™×¡××”';
      }
    });

    // On page load, verify user is authenticated
    window.addEventListener('load', async () => {
      const isValid = await authService.validateSession();
      if (!isValid) {
        console.log('No valid session, redirecting to login');
        window.location.href = 'index.html';
      }
    });
  </script>
</body>
</html>
