<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAT System Test - SmartVal</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f5f5f5; }
        .test-container { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .test-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 8px 16px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .code { font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ§ª VAT System Test - SmartVal Estimator</h1>
    
    <div class="test-container">
        <div class="test-title">ğŸ“‹ Test Environment Setup</div>
        <div id="setup-status" class="test-result info">Setting up test environment...</div>
        <button onclick="initializeTestEnvironment()">Initialize Test Environment</button>
        <button onclick="clearTestData()">Clear Test Data</button>
    </div>

    <div class="test-container">
        <div class="test-title">ğŸ”§ VAT Rate Management Tests</div>
        <div>
            <label>Test VAT Rate:</label>
            <input type="number" id="test-vat-rate" value="19" min="0" max="100" step="0.1">
            <button onclick="testVatRateUpdate()">Test VAT Update</button>
            <button onclick="testAdminHubReset()">Test Admin Hub Reset</button>
        </div>
        <div id="vat-test-results"></div>
    </div>

    <div class="test-container">
        <div class="test-title">ğŸ“Š Calculation System Tests</div>
        <button onclick="testCalculationSystem()">Test Complete Recalculation</button>
        <button onclick="testMathEngineIntegration()">Test MathEngine Integration</button>
        <div id="calculation-test-results"></div>
    </div>

    <div class="test-container">
        <div class="test-title">ğŸ“¢ Admin Hub Communication Tests</div>
        <button onclick="testAdminHubMessage()">Test VAT_RATE_UPDATED Message</button>
        <button onclick="testMessageListener()">Test Message Listener</button>
        <div id="communication-test-results"></div>
    </div>

    <div class="test-container">
        <div class="test-title">ğŸ“ˆ Current System Status</div>
        <button onclick="showSystemStatus()">Show Current Status</button>
        <div id="system-status"></div>
    </div>

    <script src="math.js"></script>
    <script>
        // Test Environment Setup
        function initializeTestEnvironment() {
            try {
                // Initialize basic helper structure
                const helper = {
                    estimate: {
                        summary: {
                            vat_rate: {
                                current: 18,
                                source: 'default',
                                modified: null
                            }
                        }
                    },
                    calculations: {
                        vat_rate: 18,
                        vat_rate_source: 'default'
                    }
                };

                sessionStorage.setItem('helper', JSON.stringify(helper));
                window.helper = helper;

                updateTestResult('setup-status', 'success', 
                    'âœ… Test environment initialized successfully\n' +
                    'â€¢ Helper structure created\n' + 
                    'â€¢ Default VAT rate set to 18%\n' +
                    'â€¢ SessionStorage configured'
                );

            } catch (error) {
                updateTestResult('setup-status', 'error', 
                    'âŒ Failed to initialize test environment: ' + error.message);
            }
        }

        function clearTestData() {
            sessionStorage.removeItem('helper');
            sessionStorage.removeItem('globalVAT');
            localStorage.removeItem('globalVAT');
            delete window.helper;
            
            updateTestResult('setup-status', 'info', 
                'ğŸ§¹ Test data cleared\n' +
                'â€¢ SessionStorage helper removed\n' +
                'â€¢ VAT storage cleared\n' +
                'â€¢ Window helper deleted'
            );
        }

        // VAT Rate Tests
        function testVatRateUpdate() {
            const resultsDiv = document.getElementById('vat-test-results');
            const testRate = parseFloat(document.getElementById('test-vat-rate').value);
            
            try {
                // Test the updateVatRateEstimate function logic
                let helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
                
                // Simulate the VAT update process
                if (!helper.estimate) helper.estimate = { summary: { vat_rate: {} } };
                if (!helper.calculations) helper.calculations = {};
                
                const oldRate = helper.calculations.vat_rate || 18;
                
                helper.estimate.summary.vat_rate.modified = testRate !== 18 ? testRate : null;
                helper.estimate.summary.vat_rate.current = testRate;
                helper.estimate.summary.vat_rate.source = 'manual_test';
                helper.calculations.vat_rate = testRate;
                helper.calculations.vat_rate_source = 'manual_test';
                
                sessionStorage.setItem('helper', JSON.stringify(helper));
                window.helper = helper;

                // Test MathEngine integration
                let mathEngineStatus = 'Not available';
                if (typeof MathEngine !== 'undefined' && MathEngine.setVatRate) {
                    MathEngine.setVatRate(testRate);
                    mathEngineStatus = 'âœ… Updated to ' + testRate + '%';
                }

                updateTestResult('vat-test-results', 'success',
                    `âœ… VAT Rate Update Test Passed\n` +
                    `â€¢ Old Rate: ${oldRate}%\n` +
                    `â€¢ New Rate: ${testRate}%\n` +
                    `â€¢ Helper Path: estimate.summary.vat_rate.current\n` +
                    `â€¢ Calculations Path: calculations.vat_rate\n` +
                    `â€¢ MathEngine Integration: ${mathEngineStatus}`
                );

            } catch (error) {
                updateTestResult('vat-test-results', 'error',
                    'âŒ VAT Rate Update Test Failed: ' + error.message);
            }
        }

        function testAdminHubReset() {
            try {
                // Simulate admin hub reset by setting a different rate
                const adminRate = 17;
                
                let helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
                if (!helper.calculations) helper.calculations = {};
                
                // Reset to admin rate
                helper.calculations.vat_rate = adminRate;
                helper.calculations.vat_rate_source = 'admin_hub';
                
                sessionStorage.setItem('globalVAT', adminRate);
                sessionStorage.setItem('helper', JSON.stringify(helper));
                window.helper = helper;

                updateTestResult('vat-test-results', 'success',
                    `âœ… Admin Hub Reset Test Passed\n` +
                    `â€¢ Reset to admin rate: ${adminRate}%\n` +
                    `â€¢ Source updated to: admin_hub\n` +
                    `â€¢ GlobalVAT storage updated`
                );

            } catch (error) {
                updateTestResult('vat-test-results', 'error',
                    'âŒ Admin Hub Reset Test Failed: ' + error.message);
            }
        }

        // Calculation System Tests
        function testCalculationSystem() {
            try {
                // Test calculation dependencies
                const testData = {
                    baseCost: 10000,
                    vatRate: 19,
                    expected: 11900
                };

                let calculationResult = 'Manual calculation test';
                if (typeof MathEngine !== 'undefined') {
                    const withVat = MathEngine.applyVAT(testData.baseCost, testData.vatRate);
                    calculationResult = `MathEngine result: â‚ª${withVat.toLocaleString()}`;
                    
                    if (withVat === testData.expected) {
                        calculationResult += ' âœ… Correct';
                    } else {
                        calculationResult += ` âŒ Expected â‚ª${testData.expected.toLocaleString()}`;
                    }
                }

                updateTestResult('calculation-test-results', 'success',
                    `âœ… Calculation System Test Results\n` +
                    `â€¢ Base Cost: â‚ª${testData.baseCost.toLocaleString()}\n` +
                    `â€¢ VAT Rate: ${testData.vatRate}%\n` +
                    `â€¢ ${calculationResult}\n` +
                    `â€¢ Helper VAT Rate: ${window.helper?.calculations?.vat_rate || 'Not set'}%`
                );

            } catch (error) {
                updateTestResult('calculation-test-results', 'error',
                    'âŒ Calculation System Test Failed: ' + error.message);
            }
        }

        function testMathEngineIntegration() {
            try {
                let results = [];
                
                if (typeof MathEngine === 'undefined') {
                    results.push('âŒ MathEngine not loaded');
                } else {
                    results.push('âœ… MathEngine loaded');
                    
                    // Test VAT functions
                    const testFunctions = [
                        'getVatRate', 'setVatRate', 'applyVAT', 
                        'calculateVatAmount', 'loadAdminHubVatRate'
                    ];
                    
                    testFunctions.forEach(funcName => {
                        if (typeof MathEngine[funcName] === 'function') {
                            results.push(`âœ… ${funcName} available`);
                        } else {
                            results.push(`âŒ ${funcName} missing`);
                        }
                    });
                    
                    // Test current VAT rate
                    if (MathEngine.getVatRate) {
                        const currentRate = MathEngine.getVatRate();
                        results.push(`ğŸ“Š Current MathEngine VAT: ${currentRate}%`);
                    }
                }

                updateTestResult('calculation-test-results', 'success',
                    'MathEngine Integration Test Results:\n' + results.join('\nâ€¢ '));

            } catch (error) {
                updateTestResult('calculation-test-results', 'error',
                    'âŒ MathEngine Integration Test Failed: ' + error.message);
            }
        }

        // Communication Tests
        function testAdminHubMessage() {
            try {
                // Simulate admin hub message
                const testMessage = {
                    type: 'VAT_RATE_UPDATED',
                    vatRate: 20,
                    timestamp: Date.now()
                };

                // Trigger the message event
                const event = new MessageEvent('message', {
                    data: testMessage,
                    origin: window.location.origin
                });

                window.dispatchEvent(event);

                setTimeout(() => {
                    const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
                    const updatedRate = helper.calculations?.vat_rate;

                    updateTestResult('communication-test-results', 'success',
                        `âœ… Admin Hub Message Test\n` +
                        `â€¢ Message sent: VAT_RATE_UPDATED\n` +
                        `â€¢ Test rate: ${testMessage.vatRate}%\n` +
                        `â€¢ Helper rate after message: ${updatedRate || 'Not updated'}%\n` +
                        `â€¢ Message handling: ${updatedRate === testMessage.vatRate ? 'Working' : 'Needs attention'}`
                    );
                }, 100);

            } catch (error) {
                updateTestResult('communication-test-results', 'error',
                    'âŒ Admin Hub Message Test Failed: ' + error.message);
            }
        }

        function testMessageListener() {
            const hasListener = window.addEventListener.toString().includes('message');
            const result = hasListener ? 
                'âœ… Message listener is registered' : 
                'âŒ Message listener not found';

            updateTestResult('communication-test-results', 'info',
                `Message Listener Test:\nâ€¢ ${result}\nâ€¢ Ready to receive VAT_RATE_UPDATED messages`);
        }

        // System Status
        function showSystemStatus() {
            try {
                const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
                const globalVAT = sessionStorage.getItem('globalVAT') || 'Not set';
                
                let status = [
                    'ğŸ“Š Current System Status:',
                    '',
                    'ğŸ—ï¸ Helper Structure:',
                    `â€¢ calculations.vat_rate: ${helper.calculations?.vat_rate || 'Not set'}%`,
                    `â€¢ calculations.vat_rate_source: ${helper.calculations?.vat_rate_source || 'Not set'}`,
                    `â€¢ estimate.summary.vat_rate.current: ${helper.estimate?.summary?.vat_rate?.current || 'Not set'}%`,
                    `â€¢ estimate.summary.vat_rate.source: ${helper.estimate?.summary?.vat_rate?.source || 'Not set'}`,
                    '',
                    'ğŸ’¾ Storage:',
                    `â€¢ sessionStorage.globalVAT: ${globalVAT}%`,
                    `â€¢ window.helper exists: ${window.helper ? 'Yes' : 'No'}`,
                    '',
                    'ğŸ”§ MathEngine:',
                ];

                if (typeof MathEngine !== 'undefined') {
                    status.push(`â€¢ Status: Available`);
                    if (MathEngine.getVatRate) {
                        status.push(`â€¢ Current VAT Rate: ${MathEngine.getVatRate()}%`);
                    }
                } else {
                    status.push(`â€¢ Status: Not loaded`);
                }

                updateTestResult('system-status', 'info', status.join('\n'));

            } catch (error) {
                updateTestResult('system-status', 'error',
                    'âŒ Failed to get system status: ' + error.message);
            }
        }

        // Utility function to update test results
        function updateTestResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = `test-result ${type}`;
                element.innerHTML = `<pre>${message}</pre>`;
            }
        }

        // Initialize on load
        window.addEventListener('load', () => {
            document.getElementById('setup-status').innerHTML = 
                'ğŸš€ VAT System Test Ready\nâ€¢ Click "Initialize Test Environment" to start\nâ€¢ Run individual tests to verify functionality';
        });
    </script>
</body>
</html>