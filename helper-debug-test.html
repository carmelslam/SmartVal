<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Helper System Debug Test</title>
  <style>
    body {
      font-family: 'Assistant', sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .test-section h3 {
      margin-top: 0;
      color: #333;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    .success { background: #28a745; }
    .warning { background: #ffc107; color: black; }
    .danger { background: #dc3545; }
    
    #console {
      background: #000;
      color: #0f0;
      padding: 10px;
      height: 300px;
      overflow-y: scroll;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
    
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-weight: bold;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ Helper System Debug Test</h1>
    <p>Test page for debugging helper data flow and module communication issues.</p>
    
    <div class="test-section">
      <h3>ğŸš€ System Status</h3>
      <div id="systemStatus">Loading...</div>
      <button onclick="checkSystemStatus()">Refresh Status</button>
    </div>
    
    <div class="test-section">
      <h3>ğŸ§ª Quick Tests</h3>
      <button onclick="runAllTests()">Run All Tests</button>
      <button onclick="testBasics()">Test Basics</button>
      <button onclick="testDataReception()">Test Data Reception</button>
      <button onclick="clearAllData()">Clear All Data</button>
    </div>
    
    <div class="test-section">
      <h3>ğŸ“¥ Simulate Data Reception</h3>
      <button onclick="simulateCarData()">Simulate Car Data</button>
      <button onclick="simulateLeviData()">Simulate Levi Data</button>
      <button onclick="simulateURLParams()">Simulate URL Parameters</button>
      <button onclick="simulateMakeWebhook()">Simulate Make.com Response</button>
      <button onclick="testOpenCaseFlow()">Test Open Case Flow</button>
      <button onclick="testSelectionPageFlow()">Test Selection Page</button>
      <button onclick="simulateMakeWebhookResponse()" class="success">Simulate Rich Car Data</button>
      <button onclick="testDirectFloatingScreen()" class="success">Test Direct Floating Screen</button>
      <button onclick="simulateRealMakeData()" style="background: #007bff; color: white;">Simulate Real Make.com Data</button>
    </div>
    
    <div class="test-section">
      <h3>ğŸ” Helper State</h3>
      <button onclick="showHelperState()">Show Helper State</button>
      <button onclick="showStorageState()">Show Storage State</button>
      <button onclick="exportHelper()">Export Helper Data</button>
    </div>
    
    <div class="test-section">
      <h3>ğŸ“Š Console Output</h3>
      <div id="console"></div>
      <button onclick="clearConsole()">Clear Console</button>
    </div>
  </div>

  <script type="module">
    import { helper, updateHelper, saveHelperToStorage, loadHelperFromStorage, checkForIncomingData } from './helper.js';
    import './make-webhook-simulator.js';
    
    // Make functions globally available
    window.helper = helper;
    window.updateHelper = updateHelper;
    window.saveHelperToStorage = saveHelperToStorage;
    window.loadHelperFromStorage = loadHelperFromStorage;
    window.checkForIncomingData = checkForIncomingData;
    
    let consoleOutput = '';
    
    // Override console.log to capture output
    const originalConsoleLog = console.log;
    console.log = function(...args) {
      originalConsoleLog.apply(console, args);
      const message = args.map(arg => 
        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
      ).join(' ');
      consoleOutput += new Date().toLocaleTimeString() + ': ' + message + '\n';
      updateConsoleDisplay();
    };
    
    function updateConsoleDisplay() {
      const consoleEl = document.getElementById('console');
      consoleEl.textContent = consoleOutput;
      consoleEl.scrollTop = consoleEl.scrollHeight;
    }
    
    window.clearConsole = function() {
      consoleOutput = '';
      updateConsoleDisplay();
    };
    
    // System status check
    window.checkSystemStatus = function() {
      const status = document.getElementById('systemStatus');
      let html = '';
      
      // Check helper object
      if (typeof helper === 'object' && helper !== null) {
        html += '<div class="status success">âœ… Helper object loaded</div>';
      } else {
        html += '<div class="status error">âŒ Helper object not found</div>';
      }
      
      // Check functions
      if (typeof updateHelper === 'function') {
        html += '<div class="status success">âœ… updateHelper function available</div>';
      } else {
        html += '<div class="status error">âŒ updateHelper function not available</div>';
      }
      
      // Check storage
      const sessionData = sessionStorage.getItem('helper');
      if (sessionData) {
        html += '<div class="status success">âœ… Helper data in sessionStorage</div>';
      } else {
        html += '<div class="status info">â„¹ï¸ No helper data in sessionStorage</div>';
      }
      
      // Check external data
      const carData = sessionStorage.getItem('carData');
      if (carData) {
        html += '<div class="status info">ğŸ“‹ External car data found</div>';
      }
      
      // Check global functions
      if (typeof window.checkForIncomingData === 'function') {
        html += '<div class="status success">âœ… Data reception functions available</div>';
      } else {
        html += '<div class="status error">âŒ Data reception functions not available</div>';
      }
      
      status.innerHTML = html;
    };
    
    // Run all tests
    window.runAllTests = async function() {
      console.log('ğŸ§ª Running all helper tests...');
      
      if (typeof window.runHelperTests === 'function') {
        try {
          const results = await window.runHelperTests();
          console.log('Test results:', results);
        } catch (error) {
          console.error('Test execution failed:', error);
        }
      } else {
        console.log('Test suite not loaded, running basic tests...');
        testBasics();
      }
    };
    
    // Test basics
    window.testBasics = function() {
      console.log('ğŸ” Testing basic helper functionality...');
      
      // Test helper object
      console.log('Helper object:', typeof helper);
      console.log('Helper keys:', Object.keys(helper));
      
      // Test update function
      try {
        const result = updateHelper('car_details', { test: 'basic_test' });
        console.log('updateHelper result:', result);
        console.log('Helper after update:', helper.car_details.test);
      } catch (error) {
        console.error('updateHelper failed:', error);
      }
      
      // Test storage
      try {
        const saveResult = saveHelperToStorage();
        console.log('saveHelperToStorage result:', saveResult);
      } catch (error) {
        console.error('saveHelperToStorage failed:', error);
      }
    };
    
    // Test data reception
    window.testDataReception = function() {
      console.log('ğŸ“¡ Testing data reception...');
      
      // Test checkForIncomingData
      try {
        checkForIncomingData();
        console.log('checkForIncomingData executed successfully');
      } catch (error) {
        console.error('checkForIncomingData failed:', error);
      }
      
      // Check current helper state
      console.log('Current helper state:', helper);
    };
    
    // Simulate car data
    window.simulateCarData = function() {
      console.log('ğŸš— Simulating car data reception...');
      
      const testCarData = {
        plate: '5785269',
        manufacturer: '×‘×™×•××™×§',
        model: 'LUCERNE',
        owner: '×›×¨××œ ×›×™×•×£',
        date: new Date().toISOString(),
        location: 'UMI ×—×™×¤×”'
      };
      
      sessionStorage.setItem('carData', JSON.stringify(testCarData));
      console.log('Car data stored in sessionStorage');
      
      // Trigger data reception
      checkForIncomingData();
      
      console.log('Helper after car data:', helper.car_details);
    };
    
    // Simulate Levi data
    window.simulateLeviData = function() {
      console.log('ğŸ“Š Simulating Levi data reception...');
      
      const testLeviData = {
        base_price: '100000',
        final_price: '95000',
        adjustments: {
          features: { percent: '5', value: '5000' },
          km: { percent: '-10', value: '-10000' }
        }
      };
      
      sessionStorage.setItem('leviData', JSON.stringify(testLeviData));
      console.log('Levi data stored in sessionStorage');
      
      // Trigger data reception
      checkForIncomingData();
      
      console.log('Helper after Levi data:', helper.expertise.levi_report);
    };
    
    // Simulate URL parameters
    window.simulateURLParams = function() {
      console.log('ğŸ”— Simulating URL parameters...');
      
      const newURL = window.location.origin + window.location.pathname + 
                    '?plate=URL123&manufacturer=URLCar&model=URLModel&owner=URL+Owner';
      
      console.log('Navigate to this URL to test URL parameters:');
      console.log(newURL);
      
      // For testing, manually process the params
      const urlParams = new URLSearchParams('plate=URL123&manufacturer=URLCar&model=URLModel&owner=URL+Owner');
      const allParams = Object.fromEntries(urlParams);
      
      const carDataFields = ['plate', 'manufacturer', 'model', 'owner'];
      const foundCarData = {};
      
      Object.keys(allParams).forEach(key => {
        if (carDataFields.includes(key.toLowerCase())) {
          foundCarData[key.toLowerCase()] = decodeURIComponent(allParams[key]);
        }
      });
      
      if (Object.keys(foundCarData).length > 0) {
        updateHelper('car_details', foundCarData);
        console.log('URL params processed:', foundCarData);
      }
    };
    
    // Simulate Make.com webhook response
    window.simulateMakeWebhook = function() {
      console.log('ğŸŒ Simulating Make.com webhook response...');
      
      const webhookResponse = {
        success: true,
        car_details: {
          plate: 'MAKE123',
          manufacturer: 'WebhookCar',
          model: 'MakeModel'
        },
        status: 'processed'
      };
      
      // Simulate processing webhook response
      if (webhookResponse.car_details) {
        updateHelper('car_details', webhookResponse.car_details);
        console.log('Webhook car data processed:', webhookResponse.car_details);
      }
      
      console.log('Helper after webhook:', helper.car_details);
    };
    
    // Show helper state
    window.showHelperState = function() {
      console.log('ğŸ” Current Helper State:');
      console.log('Meta:', helper.meta);
      console.log('Car Details:', helper.car_details);
      console.log('Vehicle:', helper.vehicle);
      console.log('Expertise:', helper.expertise);
      console.log('Parts Search:', helper.parts_search);
      console.log('Fees:', helper.fees);
      console.log('Invoice:', helper.invoice);
    };
    
    // Show storage state
    window.showStorageState = function() {
      console.log('ğŸ’¾ Storage State:');
      console.log('SessionStorage keys:', Object.keys(sessionStorage));
      console.log('LocalStorage keys:', Object.keys(localStorage));
      
      const helperData = sessionStorage.getItem('helper');
      if (helperData) {
        console.log('Helper data size:', helperData.length, 'characters');
        try {
          const parsed = JSON.parse(helperData);
          console.log('Helper data sections:', Object.keys(parsed));
        } catch (e) {
          console.log('Helper data parse error:', e.message);
        }
      }
      
      const carData = sessionStorage.getItem('carData');
      if (carData) {
        console.log('External car data:', JSON.parse(carData));
      }
    };
    
    // Export helper data
    window.exportHelper = function() {
      const exportData = {
        timestamp: new Date().toISOString(),
        helper: helper,
        sessionStorage: {
          helper: sessionStorage.getItem('helper'),
          carData: sessionStorage.getItem('carData')
        },
        url: window.location.href
      };
      
      console.log('ğŸ“¤ Exported Helper Data:', exportData);
      
      // Create downloadable file
      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `helper-export-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    };
    
    // Test open case flow
    window.testOpenCaseFlow = function() {
      console.log('ğŸ§ª Testing open case flow...');
      
      // Simulate the data that would come back from Make.com after opening a case
      const testCaseData = {
        plate: '5785269',
        manufacturer: '×‘×™×•××™×§',
        model: 'LUCERNE',
        owner: '×›×¨××œ ×›×™×•×£',
        date: new Date().toISOString(),
        location: 'UMI ×—×™×¤×”'
      };
      
      // Store in sessionStorage as Make.com would
      sessionStorage.setItem('carData', JSON.stringify(testCaseData));
      console.log('Car data stored as if from Make.com:', testCaseData);
      
      // Trigger data reception
      checkForIncomingData();
      
      // Simulate navigation to selection page (you can uncomment this to test)
      // window.location.href = 'selection.html';
      
      console.log('Open case flow test completed. Check helper state and sessionStorage.');
    };
    
    // Test selection page data reception
    window.testSelectionPageFlow = function() {
      console.log('ğŸ§ª Testing selection page data flow...');
      
      // Simulate arriving at selection page with car data
      const testCaseData = {
        plate: 'SEL789',
        manufacturer: 'Toyota',
        model: 'Camry',
        owner: 'Selection Test User',
        date: new Date().toISOString(),
        location: 'Test Garage'
      };
      
      // Store data as it would exist when arriving at selection page
      sessionStorage.setItem('carData', JSON.stringify(testCaseData));
      updateHelper('car_details', testCaseData);
      
      console.log('Selection page test data set. The page should detect and show this data.');
      console.log('Test data:', testCaseData);
      
      // Test URL parameter scenario
      const testURL = window.location.origin + window.location.pathname + 
                    '?plate=URL456&manufacturer=URLTest&model=URLCar&owner=URL+Test+User';
      console.log('To test URL parameters, navigate to:', testURL);
    };

    // Clear all data
    window.clearAllData = function() {
      console.log('ğŸ§½ Clearing all helper and storage data...');
      
      // Clear storage
      sessionStorage.removeItem('helper');
      sessionStorage.removeItem('carData');
      sessionStorage.removeItem('leviData');
      localStorage.removeItem('helper_data');
      
      // Clear helper object
      Object.keys(helper).forEach(key => {
        if (typeof helper[key] === 'object' && helper[key] !== null) {
          if (Array.isArray(helper[key])) {
            helper[key] = [];
          } else {
            helper[key] = {};
          }
        } else {
          helper[key] = '';
        }
      });
      
      console.log('All data cleared');
      checkSystemStatus();
    };
    
    // Test direct floating screen
    window.testDirectFloatingScreen = function() {
      console.log('ğŸ” Testing direct floating screen...');
      
      const testData = {
        plate: '5785269',
        manufacturer: '×‘×™×•××™×§', 
        model: 'LUCERNE',
        year: '2009',
        owner: '×›×¨××œ ×›×™×•×£',
        chassis: '1G4HD57258U196450',
        engine_volume: '3791',
        fuel_type: '×‘× ×–×™×Ÿ'
      };
      
      // Store in sessionStorage
      sessionStorage.setItem('makeCarData', JSON.stringify(testData));
      console.log('Test data stored in makeCarData');
      
      // Try to show floating screen directly
      if (typeof window.toggleCarDetails === 'function') {
        window.toggleCarDetails();
        console.log('Floating screen opened via toggleCarDetails');
      } else if (typeof window.showCarDetails === 'function') {
        window.showCarDetails();
        console.log('Floating screen opened via showCarDetails');
      } else {
        console.log('âŒ No floating screen function found');
      }
      
      // Also try to refresh
      if (typeof window.refreshCarData === 'function') {
        setTimeout(() => {
          window.refreshCarData();
          console.log('Floating screen refreshed');
        }, 500);
      }
    };
    
    // Simulate the exact Make.com data we saw in the screenshot
    window.simulateRealMakeData = function() {
      console.log('ğŸŒ Simulating real Make.com Hebrew data...');
      
      const realMakeData = {
        plate: '5785269',
        manufacturer: '×‘×™×•××™×§',
        model: 'LUCERNE', 
        model_type: '×¡×“××Ÿ',
        year: '2009',
        production_date: '05/2009',
        chassis: '1G4HD57258U196450',
        engine_volume: '3791',
        fuel_type: '×‘× ×–×™×Ÿ',
        model_code: 'HD572',
        engine_model: '428',
        drive_type: '4X2',
        office_code: '156-11',
        owner: '×›×¨××œ ×›×™×•×£',
        location: 'UMI ×—×™×¤×”',
        case_id: 'YC-5785269-2025',
        data_source: 'mot_database_real',
        make_com_processed: true
      };
      
      console.log('Real Make.com data:', realMakeData);
      
      // Store in multiple locations
      sessionStorage.setItem('makeCarData', JSON.stringify(realMakeData));
      sessionStorage.setItem('lastWebhookResponse', JSON.stringify(realMakeData));
      
      // Update helper if available
      try {
        if (typeof updateHelper === 'function') {
          updateHelper('car_details', realMakeData);
          updateHelper('vehicle', realMakeData);
          updateHelper('meta', {
            plate: realMakeData.plate,
            case_id: realMakeData.case_id,
            owner_name: realMakeData.owner
          });
          console.log('Helper updated with real Make.com data');
        }
      } catch (error) {
        console.log('Helper update failed:', error);
      }
      
      // Show floating screen
      testDirectFloatingScreen();
      
      console.log('Real Make.com data simulation complete');
    };
    
    // Fixed testDataReception function
    window.testDataReception = function() {
      console.log('ğŸ“¡ Testing data reception...');
      
      try {
        if (typeof checkForIncomingData === 'function') {
          checkForIncomingData();
          console.log('checkForIncomingData executed successfully');
        } else {
          console.log('âŒ checkForIncomingData function not available');
        }
      } catch (error) {
        console.error('checkForIncomingData failed:', error);
      }
      
      // Check current helper state
      console.log('Current helper state:', typeof helper !== 'undefined' ? helper : 'undefined');
    };

    // Initialize page
    window.addEventListener('load', function() {
      console.log('ğŸš€ Helper Debug Test Page Loaded');
      console.log('Helper system loaded:', typeof helper !== 'undefined');
      checkSystemStatus();
    });
  </script>
</body>
</html>