<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×¤×¨×˜×™ ××©×™××” - ×™×¨×•×Ÿ ×›×™×•×£ - ×©×××•×ª ×•×™×™×¢×•×¥</title>
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans Hebrew', Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      direction: rtl;
      line-height: 1.6;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #003366 0%, #004c99 100%);
      padding: 1rem 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 1.3rem;
      font-weight: 600;
      color: white;
    }

    .back-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Noto Sans Hebrew', Arial, sans-serif;
      font-size: 0.9rem;
      transition: background 0.2s;
    }

    .back-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 2rem;
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 2rem;
    }

    .main-content {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .task-info {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1.5rem;
      gap: 1rem;
    }

    .task-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #003366;
      flex: 1;
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-family: 'Noto Sans Hebrew', Arial, sans-serif;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #003366;
      color: white;
    }

    .btn-primary:hover {
      background: #004c99;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .task-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 1.5rem;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .task-description {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid #eee;
      color: #555;
      line-height: 1.8;
    }

    .progress-section {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .progress-label {
      font-weight: 600;
      color: #003366;
    }

    .progress-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #003366;
    }

    .progress-slider {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: #e0e0e0;
      outline: none;
      -webkit-appearance: none;
      margin: 1rem 0;
    }

    .progress-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #003366;
      cursor: pointer;
    }

    .progress-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #003366;
      cursor: pointer;
      border: none;
    }

    .status-section {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .status-label {
      font-weight: 600;
      color: #003366;
      margin-bottom: 1rem;
      display: block;
    }

    .status-select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: 'Noto Sans Hebrew', Arial, sans-serif;
      font-size: 1rem;
      background: white;
      cursor: pointer;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .attachments-section {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .section-title {
      font-weight: 600;
      color: #003366;
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }

    .upload-area {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 1rem;
    }

    .upload-area:hover {
      border-color: #003366;
      background: #f8f9fa;
    }

    .upload-area input {
      display: none;
    }

    .attachments-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .attachment-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background: #f8f9fa;
      border-radius: 8px;
      font-size: 0.85rem;
    }

    .attachment-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .attachment-actions {
      display: flex;
      gap: 0.5rem;
    }

    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      padding: 0.25rem;
      opacity: 0.6;
      transition: opacity 0.2s;
    }

    .icon-btn:hover {
      opacity: 1;
    }

    .conversation-section {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .messages-container {
      max-height: 500px;
      overflow-y: auto;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .message {
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 8px;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .message-author {
      font-weight: 600;
      color: #003366;
    }

    .message-time {
      font-size: 0.75rem;
      color: #999;
    }

    .message-content {
      color: #555;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .message-input-area {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .message-textarea {
      width: 100%;
      min-height: 100px;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: 'Noto Sans Hebrew', Arial, sans-serif;
      font-size: 0.95rem;
      resize: vertical;
    }

    .message-textarea:focus {
      outline: none;
      border-color: #003366;
    }

    .send-message-btn {
      align-self: flex-start;
      padding: 0.75rem 2rem;
      background: #003366;
      color: white;
      border: none;
      border-radius: 8px;
      font-family: 'Noto Sans Hebrew', Arial, sans-serif;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .send-message-btn:hover {
      background: #004c99;
    }

    .send-message-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .loading {
      text-align: center;
      padding: 3rem;
      color: #999;
    }

    .error {
      background: #fee;
      color: #c00;
      padding: 1rem;
      border-radius: 8px;
      margin: 2rem 0;
    }

    .success {
      background: #efe;
      color: #0a0;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }

    .empty-state {
      text-align: center;
      padding: 2rem;
      color: #999;
      font-size: 0.9rem;
    }

    .priority-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .priority-badge.low {
      background: #e3f2fd;
      color: #1976d2;
    }

    .priority-badge.medium {
      background: #fff3e0;
      color: #f57c00;
    }

    .priority-badge.high {
      background: #ffe0e0;
      color: #d32f2f;
    }

    .priority-badge.urgent {
      background: #d32f2f;
      color: white;
    }

    @media (max-width: 1024px) {
      .container {
        grid-template-columns: 1fr;
      }

      .sidebar {
        order: -1;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>ğŸ“‹ ×¤×¨×˜×™ ××©×™××”</h1>
    <button class="back-btn" onclick="goBack()">â† ×—×–×•×¨</button>
  </header>

  <div class="container">
    <div class="main-content">
      <div id="content">
        <div class="loading">×˜×•×¢×Ÿ ×¤×¨×˜×™ ××©×™××”...</div>
      </div>
    </div>
  </div>

  <!-- Follow-up Task Modal -->
  <div id="followUpModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="color: #003366; font-size: 1.3rem;">ğŸ”— ×™×¦×™×¨×ª ××©×™××ª ×”××©×š</h2>
        <button onclick="closeFollowUpModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">âœ•</button>
      </div>

      <form id="followUpForm" style="display: flex; flex-direction: column; gap: 1rem;">
        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #003366;">×›×•×ª×¨×ª ×”××©×™××” *</label>
          <input type="text" id="followUpTitle" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-family: 'Noto Sans Hebrew', Arial, sans-serif;">
        </div>

        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #003366;">×ª×™××•×¨</label>
          <textarea id="followUpDescription" rows="4" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-family: 'Noto Sans Hebrew', Arial, sans-serif; resize: vertical;"></textarea>
        </div>

        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #003366;">×”×§×¦×” ×œ-</label>
          <select id="followUpAssignedTo" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-family: 'Noto Sans Hebrew', Arial, sans-serif;">
            <option value="">×‘×—×¨ ××©×ª××©...</option>
          </select>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #003366;">×¢×“×™×¤×•×ª</label>
            <select id="followUpPriority" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-family: 'Noto Sans Hebrew', Arial, sans-serif;">
              <option value="low">× ××•×›×”</option>
              <option value="medium" selected>×‘×™× ×•× ×™×ª</option>
              <option value="high">×’×‘×•×”×”</option>
              <option value="urgent">×“×—×•×¤×”</option>
            </select>
          </div>

          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #003366;">×ª××¨×™×š ×™×¢×“</label>
            <input type="datetime-local" id="followUpDueDate" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-family: 'Noto Sans Hebrew', Arial, sans-serif;">
          </div>
        </div>

        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">
          <p style="margin: 0; font-size: 0.9rem; color: #666;">
            <strong>××©×™××ª ×”××§×•×¨:</strong> <span id="parentTaskName"></span><br>
            ××©×™××” ×–×• ×ª×™×•×•×¦×¨ ×›×”××©×š ×œ××©×™××” ×”××§×•×¨×™×ª ×•×ª×”×™×” ×—×œ×§ ×××•×ª×• ×©×¨×©×•×¨.
          </p>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
          <button type="submit" style="flex: 1; padding: 0.75rem; background: #003366; color: white; border: none; border-radius: 8px; font-family: 'Noto Sans Hebrew', Arial, sans-serif; font-size: 1rem; cursor: pointer;">
            âœ… ×¦×•×¨ ××©×™××ª ×”××©×š
          </button>
          <button type="button" onclick="closeFollowUpModal()" style="flex: 1; padding: 0.75rem; background: #f0f0f0; color: #333; border: none; border-radius: 8px; font-family: 'Noto Sans Hebrew', Arial, sans-serif; font-size: 1rem; cursor: pointer;">
            ×‘×™×˜×•×œ
          </button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { supabase } from './lib/supabaseClient.js';
    import { taskNotifications } from './task-notifications.js';

    // Get task ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const taskId = urlParams.get('id');

    let currentUser = null;
    let currentTask = null;
    let profileMap = {};
    let notificationManager = null;

    window.goBack = function() {
      window.history.back();
    };

    async function loadTask() {
      if (!taskId) {
        document.getElementById('content').innerHTML = `
          <div class="error">
            âŒ ×œ× ×¦×•×™×Ÿ ××–×”×” ××©×™××”
          </div>
        `;
        return;
      }

      try {
        // Get current user
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          window.location.href = 'index.html';
          return;
        }

        currentUser = user;

        // Initialize notification manager
        notificationManager = taskNotifications;

        // Load profiles
        const { data: profiles, error: profilesError } = await supabase
          .from('profiles')
          .select('user_id, name, role');

        if (profilesError) throw profilesError;

        profileMap = {};
        (profiles || []).forEach(profile => {
          profileMap[profile.user_id] = profile;
        });

        // Load task
        await refreshTask();

        // Set up real-time subscription for messages
        const messageSubscription = supabase
          .channel(`task-messages-${taskId}`)
          .on('postgres_changes', {
            event: '*',
            schema: 'public',
            table: 'task_messages',
            filter: `task_id=eq.${taskId}`
          }, (payload) => {
            console.log('ğŸ“¨ Message change detected:', payload);
            loadMessages();
          })
          .subscribe((status) => {
            console.log('ğŸ“¨ Message subscription status:', status);
            if (status === 'SUBSCRIBED') {
              console.log('âœ… Successfully subscribed to task messages');
            }
          });

        // Set up real-time subscription for task updates
        const taskSubscription = supabase
          .channel(`task-${taskId}`)
          .on('postgres_changes', {
            event: 'UPDATE',
            schema: 'public',
            table: 'tasks',
            filter: `id=eq.${taskId}`
          }, (payload) => {
            console.log('ğŸ“‹ Task change detected:', payload);
            refreshTask();
          })
          .subscribe((status) => {
            console.log('ğŸ“‹ Task subscription status:', status);
          });

        // Set up real-time subscription for attachments
        const attachmentSubscription = supabase
          .channel(`task-attachments-${taskId}`)
          .on('postgres_changes', {
            event: '*',
            schema: 'public',
            table: 'task_attachments',
            filter: `task_id=eq.${taskId}`
          }, (payload) => {
            console.log('ğŸ“ Attachment change detected:', payload);
            loadAttachments();
          })
          .subscribe((status) => {
            console.log('ğŸ“ Attachment subscription status:', status);
          });

      } catch (error) {
        console.error('Error loading task:', error);
        document.getElementById('content').innerHTML = `
          <div class="error">
            âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”××©×™××”: ${error.message}
          </div>
        `;
      }
    }

    async function refreshTask() {
      const { data: task, error: taskError } = await supabase
        .from('tasks')
        .select('*')
        .eq('id', taskId)
        .single();

      if (taskError) throw taskError;

      if (!task) {
        throw new Error('××©×™××” ×œ× × ××¦××”');
      }

      // Add profile data to task
      task.assigned_to_profile = profileMap[task.assigned_to] || null;
      task.assigned_by_profile = profileMap[task.assigned_by] || null;

      currentTask = task;
      renderTask(task);
      loadMessages();
      loadAttachments();
    }

    function renderTask(task) {
      const userProfile = profileMap[currentUser.id];
      const isAdmin = userProfile && (userProfile.role === 'admin' || userProfile.role === 'developer');
      const isAssistant = userProfile && userProfile.role === 'assistant';
      const canEdit = isAdmin || isAssistant;
      const canDelete = isAdmin;

      document.getElementById('content').innerHTML = `
        <div class="task-info">
          <div class="task-header">
            <div class="task-title">${escapeHtml(task.title || '×œ×œ× ×›×•×ª×¨×ª')}</div>
            <div class="action-buttons">
              ${canEdit ? `<button class="btn btn-primary" onclick="openFollowUpModal()">ğŸ”— ××©×™××ª ×”××©×š</button>` : ''}
              ${canEdit ? `<button class="btn btn-secondary" onclick="editTask()">âœï¸ ×¢×¨×•×š</button>` : ''}
              ${canEdit ? `<button class="btn btn-secondary" onclick="archiveTask()">ğŸ“¦ ×”×¢×‘×¨ ×œ××¨×›×™×•×Ÿ</button>` : ''}
              ${canDelete ? `<button class="btn btn-danger" onclick="deleteTask()">ğŸ—‘ï¸ ××—×§</button>` : ''}
            </div>
          </div>

          <div class="task-meta">
            <div class="meta-item">
              <span>ğŸ‘¤ ×”×•×§×¦×” ×œ:</span>
              <strong>${escapeHtml(task.assigned_to_profile?.name || '×œ× ×™×“×•×¢')}</strong>
            </div>
            <div class="meta-item">
              <span>ğŸ‘¤ ×”×•×§×¦×” ×¢×œ ×™×“×™:</span>
              <strong>${escapeHtml(task.assigned_by_profile?.name || '×œ× ×™×“×•×¢')}</strong>
            </div>
            <div class="meta-item">
              <span>ğŸ¯ ×¢×“×™×¤×•×ª:</span>
              <span class="priority-badge ${task.priority}">${getPriorityLabel(task.priority)}</span>
            </div>
            ${task.due_date ? `
              <div class="meta-item">
                <span>ğŸ“… ×ª××¨×™×š ×™×¢×“:</span>
                <strong>${formatDate(task.due_date)}</strong>
              </div>
            ` : ''}
            ${task.plate ? `
              <div class="meta-item">
                <span>ğŸš— ×¨×›×‘:</span>
                <strong>${escapeHtml(task.plate)}</strong>
              </div>
            ` : ''}
            ${task.case_number ? `
              <div class="meta-item">
                <span>ğŸ“‚ ××¡×¤×¨ ×ª×™×§:</span>
                <strong>${escapeHtml(task.case_number)}</strong>
              </div>
            ` : ''}
          </div>

          ${task.description ? `
            <div class="task-description">
              <strong>×ª×™××•×¨:</strong><br>
              ${escapeHtml(task.description).replace(/\n/g, '<br>')}
            </div>
          ` : ''}
        </div>

        <div class="progress-section">
          <div class="progress-header">
            <span class="progress-label">ğŸ“Š ×”×ª×§×“××•×ª</span>
            <span class="progress-value"><span id="progress-display">${task.completion_percentage || 0}</span>%</span>
          </div>
          <input
            type="range"
            min="0"
            max="100"
            value="${task.completion_percentage || 0}"
            class="progress-slider"
            id="progress-slider"
            onchange="updateProgress(this.value)"
          >
        </div>

        <div class="status-section">
          <label class="status-label">ğŸ“‹ ×¡×˜×˜×•×¡ ××©×™××”</label>
          <select class="status-select" id="status-select" onchange="updateStatus(this.value)">
            <option value="pending" ${task.status === 'pending' ? 'selected' : ''}>×××ª×™× ×”</option>
            <option value="in_progress" ${task.status === 'in_progress' ? 'selected' : ''}>×‘×‘×™×¦×•×¢</option>
            <option value="awaiting_response" ${task.status === 'awaiting_response' ? 'selected' : ''}>×××ª×™× ×” ×œ×ª×©×•×‘×”</option>
            <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>×”×•×©×œ××”</option>
            <option value="verified" ${task.status === 'verified' ? 'selected' : ''}>××•×©×¨×”</option>
            <option value="cancelled" ${task.status === 'cancelled' ? 'selected' : ''}>×‘×•×˜×œ×”</option>
          </select>
        </div>

        <div class="conversation-section">
          <h3 class="section-title">ğŸ’¬ ×©×™×—×” ×•×ª×§×©×•×¨×ª</h3>
          <div class="messages-container" id="messages-container">
            <div class="loading">×˜×•×¢×Ÿ ×”×•×“×¢×•×ª...</div>
          </div>
          <div class="message-input-area">
            <textarea
              class="message-textarea"
              id="message-input"
              placeholder="×”×§×œ×“ ×”×•×“×¢×”..."
            ></textarea>
            <button class="send-message-btn" onclick="sendMessage()">ğŸ“¤ ×©×œ×— ×”×•×“×¢×”</button>
          </div>
        </div>
      `;

      // Add sidebar
      const sidebar = document.createElement('div');
      sidebar.className = 'sidebar';
      sidebar.innerHTML = `
        ${task.thread_id ? `
          <div class="attachments-section" id="thread-section">
            <h3 class="section-title">ğŸ§µ ××©×™××•×ª ×§×©×•×¨×•×ª</h3>
            <div id="thread-tasks-list">
              <div class="loading">×˜×•×¢×Ÿ ××©×™××•×ª ×§×©×•×¨×•×ª...</div>
            </div>
          </div>
        ` : ''}
        <div class="attachments-section">
          <h3 class="section-title">ğŸ“ ×§×‘×¦×™× ××¦×•×¨×¤×™×</h3>
          <div class="upload-area" onclick="document.getElementById('file-input').click()">
            <input type="file" id="file-input" onchange="uploadFile(this.files[0])" />
            <p>ğŸ“ ×œ×—×¥ ×œ×”×¢×œ××ª ×§×•×‘×¥</p>
          </div>
          <div class="attachments-list" id="attachments-list">
            <div class="loading">×˜×•×¢×Ÿ ×§×‘×¦×™×...</div>
          </div>
        </div>
      `;

      document.querySelector('.container').appendChild(sidebar);

      // Load thread tasks if task has a thread
      if (task.thread_id) {
        loadThreadTasks();
      }

      // Update progress display dynamically
      const slider = document.getElementById('progress-slider');
      const display = document.getElementById('progress-display');
      slider.addEventListener('input', (e) => {
        display.textContent = e.target.value;
      });
    }

    async function loadMessages() {
      try {
        const { data: messages, error } = await supabase
          .from('task_messages')
          .select('*')
          .eq('task_id', taskId)
          .order('created_at', { ascending: true });

        if (error) throw error;

        const container = document.getElementById('messages-container');

        if (!messages || messages.length === 0) {
          container.innerHTML = '<div class="empty-state">××™×Ÿ ×”×•×“×¢×•×ª ×¢×“×™×™×Ÿ. ×”×™×” ×”×¨××©×•×Ÿ ×œ×›×ª×•×‘!</div>';
          return;
        }

        container.innerHTML = messages.map(msg => {
          const author = profileMap[msg.sender_id];
          return `
            <div class="message">
              <div class="message-header">
                <span class="message-author">${escapeHtml(author?.name || '××©×ª××© ×œ× ×™×“×•×¢')}</span>
                <span class="message-time">${formatDateTime(msg.created_at)}</span>
              </div>
              <div class="message-content">${escapeHtml(msg.message_text)}</div>
            </div>
          `;
        }).join('');

        // Scroll to bottom
        container.scrollTop = container.scrollHeight;

      } catch (error) {
        console.error('Error loading messages:', error);
        document.getElementById('messages-container').innerHTML = `
          <div class="error">×©×’×™××” ×‘×˜×¢×™× ×ª ×”×•×“×¢×•×ª: ${error.message}</div>
        `;
      }
    }

    async function loadAttachments() {
      try {
        const { data: attachments, error } = await supabase
          .from('task_attachments')
          .select('*')
          .eq('task_id', taskId)
          .order('uploaded_at', { ascending: false });

        if (error) throw error;

        const container = document.getElementById('attachments-list');

        if (!attachments || attachments.length === 0) {
          container.innerHTML = '<div class="empty-state">××™×Ÿ ×§×‘×¦×™× ××¦×•×¨×¤×™×</div>';
          return;
        }

        container.innerHTML = attachments.map(att => `
          <div class="attachment-item">
            <span class="attachment-name" title="${escapeHtml(att.file_name)}">
              ğŸ“„ ${escapeHtml(att.file_name)}
            </span>
            <div class="attachment-actions">
              <button class="icon-btn" onclick="downloadAttachment('${att.file_url}', '${escapeHtml(att.file_name)}')" title="×”×•×¨×“">â¬‡ï¸</button>
              ${profileMap[currentUser.id]?.role === 'admin' ? `
                <button class="icon-btn" onclick="deleteAttachment('${att.id}')" title="××—×§">ğŸ—‘ï¸</button>
              ` : ''}
            </div>
          </div>
        `).join('');

      } catch (error) {
        console.error('Error loading attachments:', error);
        document.getElementById('attachments-list').innerHTML = `
          <div class="error">×©×’×™××” ×‘×˜×¢×™× ×ª ×§×‘×¦×™×: ${error.message}</div>
        `;
      }
    }

    async function loadThreadTasks() {
      try {
        const { data: threadTasks, error } = await supabase
          .from('tasks')
          .select('*')
          .eq('thread_id', currentTask.thread_id)
          .order('created_at', { ascending: true });

        if (error) throw error;

        const container = document.getElementById('thread-tasks-list');

        if (!threadTasks || threadTasks.length <= 1) {
          container.innerHTML = '<div class="empty-state">××™×Ÿ ××©×™××•×ª ×§×©×•×¨×•×ª × ×•×¡×¤×•×ª</div>';
          return;
        }

        // Add profile data to tasks
        const tasksWithProfiles = threadTasks.map(t => ({
          ...t,
          assigned_to_profile: profileMap[t.assigned_to]
        }));

        container.innerHTML = tasksWithProfiles.map(t => `
          <div onclick="window.location.href='task-detail.html?id=${t.id}'" style="padding: 0.75rem; margin-bottom: 0.5rem; background: ${t.id === taskId ? '#e3f2fd' : '#f8f9fa'}; border-radius: 8px; cursor: pointer; border-left: 3px solid ${t.id === taskId ? '#003366' : getPriorityColor(t.priority)}; transition: background 0.2s;">
            <div style="font-weight: ${t.id === taskId ? '700' : '500'}; font-size: 0.9rem; margin-bottom: 0.25rem; color: #003366;">
              ${escapeHtml(t.title)}
              ${t.id === taskId ? ' (× ×•×›×—×™)' : ''}
            </div>
            <div style="font-size: 0.75rem; color: #666; display: flex; justify-content: space-between;">
              <span>ğŸ‘¤ ${escapeHtml(t.assigned_to_profile?.name || '×œ× ×™×“×•×¢')}</span>
              <span>ğŸ“Š ${getStatusLabel(t.status)}</span>
            </div>
            ${t.parent_task_id === taskId ? '<div style="font-size: 0.7rem; color: #10B981; margin-top: 0.25rem;">â†³ ×”××©×š ×©×œ ××©×™××” ×–×•</div>' : ''}
            ${t.id === currentTask.parent_task_id ? '<div style="font-size: 0.7rem; color: #3B82F6; margin-top: 0.25rem;">â†‘ ××©×™××ª ×”××§×•×¨</div>' : ''}
          </div>
        `).join('');

      } catch (error) {
        console.error('Error loading thread tasks:', error);
        document.getElementById('thread-tasks-list').innerHTML = `
          <div class="error">×©×’×™××” ×‘×˜×¢×™× ×ª ××©×™××•×ª ×§×©×•×¨×•×ª: ${error.message}</div>
        `;
      }
    }

    function getPriorityColor(priority) {
      const colors = {
        low: '#10B981',
        medium: '#3B82F6',
        high: '#F59E0B',
        urgent: '#EF4444'
      };
      return colors[priority] || '#999';
    }

    window.sendMessage = async function() {
      const input = document.getElementById('message-input');
      const message = input.value.trim();

      if (!message) {
        alert('×× × ×”×§×œ×“ ×”×•×“×¢×”');
        return;
      }

      try {
        const { error } = await supabase
          .from('task_messages')
          .insert({
            task_id: taskId,
            sender_id: currentUser.id,
            message_text: message,
            sender_role: profileMap[currentUser.id]?.role || 'user'
          });

        if (error) throw error;

        // Clear input
        input.value = '';

        // Send notification
        if (notificationManager && currentTask) {
          const senderProfile = profileMap[currentUser.id];
          await notificationManager.notifyNewTaskMessage(currentTask, message, senderProfile);
        }

        // Manually refresh messages (fallback if real-time not enabled)
        await loadMessages();

      } catch (error) {
        console.error('Error sending message:', error);
        alert('×©×’×™××” ×‘×©×œ×™×—×ª ×”×•×“×¢×”: ' + error.message);
      }
    };

    window.updateProgress = async function(value) {
      try {
        const { error } = await supabase
          .from('tasks')
          .update({ completion_percentage: parseInt(value) })
          .eq('id', taskId);

        if (error) throw error;

        // Log to progress history
        await supabase
          .from('task_progress_history')
          .insert({
            task_id: taskId,
            changed_by: currentUser.id,
            change_type: 'progress_update',
            new_value: value.toString()
          });

      } catch (error) {
        console.error('Error updating progress:', error);
        alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×ª×§×“××•×ª: ' + error.message);
      }
    };

    window.updateStatus = async function(newStatus) {
      try {
        const oldStatus = currentTask.status;

        const { error } = await supabase
          .from('tasks')
          .update({ status: newStatus })
          .eq('id', taskId);

        if (error) throw error;

        // Log to progress history
        await supabase
          .from('task_progress_history')
          .insert({
            task_id: taskId,
            changed_by: currentUser.id,
            change_type: 'status_change',
            old_value: oldStatus,
            new_value: newStatus
          });

        // Send notification
        if (notificationManager && currentTask) {
          const changedByProfile = profileMap[currentUser.id];
          await notificationManager.notifyTaskStatusChanged(
            { ...currentTask, status: newStatus },
            oldStatus,
            newStatus,
            changedByProfile
          );
        }

      } catch (error) {
        console.error('Error updating status:', error);
        alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡: ' + error.message);
      }
    };

    window.uploadFile = async function(file) {
      if (!file) return;

      try {
        // Upload to Supabase Storage
        const fileExt = file.name.split('.').pop();
        const fileName = `${taskId}/${Date.now()}.${fileExt}`;

        const { data: uploadData, error: uploadError } = await supabase
          .storage
          .from('task-attachments')
          .upload(fileName, file);

        if (uploadError) throw uploadError;

        // Get public URL
        const { data: { publicUrl } } = supabase
          .storage
          .from('task-attachments')
          .getPublicUrl(fileName);

        // Save to database
        const { error: dbError } = await supabase
          .from('task_attachments')
          .insert({
            task_id: taskId,
            file_name: file.name,
            file_url: publicUrl,
            file_type: file.type,
            uploaded_by: currentUser.id
          });

        if (dbError) throw dbError;

        // Clear file input
        document.getElementById('file-input').value = '';

        // Attachments will auto-refresh via subscription

      } catch (error) {
        console.error('Error uploading file:', error);
        alert('×©×’×™××” ×‘×”×¢×œ××ª ×§×•×‘×¥: ' + error.message);
      }
    };

    window.downloadAttachment = function(url, filename) {
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    };

    window.deleteAttachment = async function(attachmentId) {
      if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×§×•×‘×¥?')) {
        return;
      }

      try {
        const { error } = await supabase
          .from('task_attachments')
          .delete()
          .eq('id', attachmentId);

        if (error) throw error;

        // Attachments will auto-refresh via subscription

      } catch (error) {
        console.error('Error deleting attachment:', error);
        alert('×©×’×™××” ×‘××—×™×§×ª ×§×•×‘×¥: ' + error.message);
      }
    };

    window.editTask = function() {
      // Navigate back with edit flag
      window.location.href = `admin-tasks.html?edit=${taskId}`;
    };

    window.archiveTask = async function() {
      if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×¢×‘×™×¨ ××ª ×”××©×™××” ×œ××¨×›×™×•×Ÿ?')) {
        return;
      }

      try {
        const { error } = await supabase
          .from('tasks')
          .update({
            archived: true,
            archived_at: new Date().toISOString(),
            archived_by: currentUser.id
          })
          .eq('id', taskId);

        if (error) throw error;

        alert('×”××©×™××” ×”×•×¢×‘×¨×” ×œ××¨×›×™×•×Ÿ ×‘×”×¦×œ×—×”');
        window.history.back();

      } catch (error) {
        console.error('Error archiving task:', error);
        alert('×©×’×™××” ×‘×”×¢×‘×¨×” ×œ××¨×›×™×•×Ÿ: ' + error.message);
      }
    };

    window.deleteTask = async function() {
      if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××©×™××”? ×¤×¢×•×œ×” ×–×• ××™× ×” × ×™×ª× ×ª ×œ×‘×™×˜×•×œ!')) {
        return;
      }

      try {
        const { error } = await supabase
          .from('tasks')
          .delete()
          .eq('id', taskId);

        if (error) throw error;

        alert('×”××©×™××” × ××—×§×” ×‘×”×¦×œ×—×”');
        window.history.back();

      } catch (error) {
        console.error('Error deleting task:', error);
        alert('×©×’×™××” ×‘××—×™×§×ª ××©×™××”: ' + error.message);
      }
    };

    function getStatusLabel(status) {
      const labels = {
        pending: '×××ª×™× ×”',
        in_progress: '×‘×‘×™×¦×•×¢',
        awaiting_response: '×××ª×™× ×” ×œ×ª×©×•×‘×”',
        completed: '×”×•×©×œ××”',
        verified: '××•×©×¨×”',
        cancelled: '×‘×•×˜×œ×”'
      };
      return labels[status] || status;
    }

    function getPriorityLabel(priority) {
      const labels = {
        low: '× ××•×›×”',
        medium: '×‘×™× ×•× ×™×ª',
        high: '×’×‘×•×”×”',
        urgent: '×“×—×•×¤×”'
      };
      return labels[priority] || priority;
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('he-IL', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatDateTime(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return '×¢×›×©×™×•';
      if (minutes < 60) return `×œ×¤× ×™ ${minutes} ×“×§×•×ª`;
      if (hours < 24) return `×œ×¤× ×™ ${hours} ×©×¢×•×ª`;
      if (days < 7) return `×œ×¤× ×™ ${days} ×™××™×`;

      return date.toLocaleDateString('he-IL', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Follow-up Task Functions
    window.openFollowUpModal = function() {
      // Populate user dropdown
      const select = document.getElementById('followUpAssignedTo');
      select.innerHTML = '<option value="">×‘×—×¨ ××©×ª××©...</option>' +
        Object.values(profileMap).map(profile =>
          `<option value="${profile.user_id}">${escapeHtml(profile.name)} (${profile.role})</option>`
        ).join('');

      // Set parent task name
      document.getElementById('parentTaskName').textContent = currentTask.title;

      // Show modal
      document.getElementById('followUpModal').style.display = 'flex';
    };

    window.closeFollowUpModal = function() {
      document.getElementById('followUpModal').style.display = 'none';
      document.getElementById('followUpForm').reset();
    };

    // Handle follow-up form submission
    document.getElementById('followUpForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const title = document.getElementById('followUpTitle').value.trim();
      const description = document.getElementById('followUpDescription').value.trim();
      const assignedTo = document.getElementById('followUpAssignedTo').value;
      const priority = document.getElementById('followUpPriority').value;
      const dueDate = document.getElementById('followUpDueDate').value;

      if (!title || !assignedTo) {
        alert('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×”');
        return;
      }

      try {
        let threadId = currentTask.thread_id;

        // If parent task doesn't have a thread, create one
        if (!threadId) {
          const { data: newThread, error: threadError } = await supabase
            .from('task_threads')
            .insert({
              thread_name: `×©×¨×©×•×¨: ${currentTask.title}`,
              thread_description: `×©×¨×©×•×¨ ××©×™××•×ª ×”×§×©×•×¨ ×œ: ${currentTask.title}`,
              case_id: currentTask.case_id,
              plate: currentTask.plate,
              created_by: currentUser.id
            })
            .select()
            .single();

          if (threadError) throw threadError;
          threadId = newThread.id;

          // Update parent task with thread_id
          const { error: updateError } = await supabase
            .from('tasks')
            .update({ thread_id: threadId })
            .eq('id', taskId);

          if (updateError) throw updateError;
        }

        // Create follow-up task
        const { data: newTask, error: taskError } = await supabase
          .from('tasks')
          .insert({
            title: title,
            description: description,
            assigned_to: assignedTo,
            assigned_by: currentUser.id,
            priority: priority,
            due_date: dueDate || null,
            status: 'pending',
            case_id: currentTask.case_id,
            plate: currentTask.plate,
            thread_id: threadId,
            parent_task_id: taskId
          })
          .select()
          .single();

        if (taskError) throw taskError;

        // Add profile data for notification
        newTask.assigned_by_profile = profileMap[currentUser.id];

        // Send notification
        if (notificationManager) {
          await notificationManager.notifyTaskAssigned(newTask, profileMap[assignedTo]);
        }

        // Log to progress history
        await supabase
          .from('task_progress_history')
          .insert({
            task_id: taskId,
            changed_by: currentUser.id,
            change_type: 'created',
            new_value: JSON.stringify({ follow_up_task_id: newTask.id }),
            change_description: `× ×•×¦×¨×” ××©×™××ª ×”××©×š: ${title}`
          });

        alert('âœ… ××©×™××ª ×”××©×š × ×•×¦×¨×” ×‘×”×¦×œ×—×”!');
        closeFollowUpModal();

        // Refresh current task to update thread info
        await refreshTask();

      } catch (error) {
        console.error('Error creating follow-up task:', error);
        alert('âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ××©×™××ª ×”××©×š: ' + error.message);
      }
    });

    // Initialize
    loadTask();
  </script>
</body>
</html>
