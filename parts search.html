<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ירון כיוף שמאות - פורטל - חיפוש חלפים</title>
  <script type="module" src="./parts.js"></script>
  <script type="module" src="./webhook.js"></script>
  <script src="./internal-browser.js"></script>

  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link rel="shortcut icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link rel="apple-touch-icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3a8a 0%, #64748b 100%);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      max-width: 450px;
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
      position: relative;

    }
    .logo img {
      width: 120px;
      margin-bottom: 15px;
    }
    .title { font-size: 24px; font-weight: bold; margin-bottom: 5px; color: #1e3a8a; }
    .subtitle { font-size: 18px; color: #64748b; margin-bottom: 5px; }
    .legal-note {
      color: red;
      font-weight: bold;
      margin-bottom: 15px;
    }
    h2 {
      font-size: 20px;
      color: #1e3a8a;
      margin-bottom: 20px;
    }
  .right-small-heading {
    text-align: right;
    font-size: 18px;
    color: #1e3a8a;
   margin-bottom: 18px;
  }

    input, select {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .btn {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background-color: #3b82f6;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
      Margin-bottom: 10px;
    }
    .footer-btns {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    .footer-btns button {
      width: 48%;
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
    .home-btn { background-color: #6c757d; color: white; }
    .logout-btn { background-color: #dc3545; color: white; }
    .footer { font-size: 12px; color: #475569; margin-top: 15px; text-align: center; }
    #previewImage {
      display: none;
      max-width: 100%;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
  </style>
</head>
<body>
<div class="container">
    <div class="logo">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo">
    </div>
    <div class="title">ירון כיוף שמאות - פורטל</div>
    <div class="subtitle">שמאות והערכת נזקי רכב ורכוש</div>
  <h2>חיפוש חלפים לרכב</h2>
  <form id="partSearchForm">
    <input type="text" id="plate" name="plate" placeholder="מספר רישוי">
    <input type="text" id="manufacturer" name="manufacturer" placeholder="יצרן">
    <input type="text" id="model" name="model" placeholder="דגם">
    <input type="text" id="trim" name="trim" placeholder="רמת גימור">
    <input type="text" id="year" name="year" placeholder="שנה">
    <input type="text" id="engine_volume" name="engine_volume" placeholder="נפח מנוע">
    <input type="text" id="engine_code" name="engine_code" placeholder="דגם מנוע">
    <input type="text" id="engine_type" name="engine_type" placeholder="סוג מנוע">
    <input type="text" id="vin" name="vin" placeholder="מספר שלדה">
 <input type="text" id="free_query" name="free_query" placeholder="חיפוש חופשי">
<h2 class="right-small-heading">העלה/צלם תמונה לחיפוש (אופציונלי)</h2>
    <input type="file" id="part_image" accept="image/*" capture="environment" placeholder="תמונת חלק (אופציונלי)">
    <img id="previewImage" />
    <select id="part_group" onchange="updatePartNameOptions()">
      <option value="" disabled selected hidden>בחר קבוצת חלקים</option>
    </select>
    <select id="part_name">
      <option value="" disabled selected hidden>בחר חלק</option>
    </select>
<select id="part_source">
  <option value="" disabled selected hidden>בחר מקור</option>
  <option value="מקורי">מקורי</option>
  <option value="תחליפי">תחליפי</option>
  <option value="משומש">משומש</option>
  <option value="הכל">הכל</option>
</select>
<input type="number" id="part_quantity" placeholder="כמות" min="1" value="1">

<button type="button" class="btn" onclick="addFullPart()">הוסף חלק לרשימה</button>
<ul id="selected_parts_list" style="text-align:right; padding-right: 0; font-size: 14px;"></ul>

<!-- Enhanced Search Results Display -->
<div id="search_results_display" style="display: none; margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
  <h3 style="color: #007bff; margin-bottom: 10px;">תוצאות חיפוש</h3>
  <div id="search_results_content"></div>
  <button type="button" class="btn" onclick="clearSearchResults()" style="background: #6c757d; margin-top: 10px;">נקה תוצאות</button>
</div>

<h2 style="text-align: right; font-size: 18px;">חיפוש חלפים באתר</h2>
<button type="button" class="btn" onclick="generateExternalForm()" style="background: #10b981; margin-bottom: 10px;">🚀 צור טופס חכם לאתר חיצוני</button>
<button type="button" class="btn" onclick="openSearchSite()">פתח אתר car-part לחיפוש</button>
 <label for="resultFileUpload">העלה תוצאת חיפוש (PDF/תמונה)</label>
<input type="file" id="resultFileUpload" accept=".pdf,.png,.jpg,.jpeg,.html">
<button type="button" class="btn" id="sendResultToOCRBtn">שלח תוצאת חיפוש לניתוח</button>
<h2 style="text-align: right; font-size: 18px;">חיפוש חלפים במערכת</h2>
     <button class="btn" type="submit">🔍 חפש חלקים</button>

<!-- Enhanced Part Management -->
<div style="margin-top: 20px;">
  <button type="button" class="btn" onclick="exportSelectedParts()" style="background: #28a745;">📄 ייצא חלקים לאקסל</button>
  <button type="button" class="btn" onclick="saveToSession()" style="background: #ffc107; color: #000;">💾 שמור להמשך באשף</button>
</div>
  </form>
  <div class="footer-btns">
    <button class="home-btn" onclick="window.location.href='selection.html'">לעמוד הבית</button>
    <button class="logout-btn">יציאה מהמערכת</button>
  </div>
  <div class="footer">All rights reserved © Carmel Cayouf</div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
  // ✅ DEBUG: Check internal browser availability on page load
  console.log('🔍 Parts Search Page Loaded - Debug Info:');
  console.log('  - openInternalBrowser function available:', typeof window.openInternalBrowser === 'function');
  console.log('  - internal-browser.js loaded:', !!document.querySelector('script[src*="internal-browser"]'));
  if (typeof window.openInternalBrowser === 'function') {
    console.log('  ✅ Internal browser is ready');
  } else {
    console.log('  ❌ Internal browser not available');
    console.log('  - Available window functions containing "Internal":', Object.keys(window).filter(k => k.toLowerCase().includes('internal')));
    console.log('  - Available window functions containing "Browser":', Object.keys(window).filter(k => k.toLowerCase().includes('browser')));
    
    // ✅ RETRY: Try to manually load internal browser if not available
    console.log('  🔄 Attempting to manually load internal browser...');
    const scriptExists = document.querySelector('script[src*="internal-browser"]');
    if (!scriptExists) {
      const script = document.createElement('script');
      script.src = './internal-browser.js';
      script.onload = () => {
        console.log('  ✅ Internal browser manually loaded');
      };
      script.onerror = () => {
        console.log('  ❌ Failed to manually load internal browser');
      };
      document.head.appendChild(script);
    }
  }
  
  // ENHANCED: Auto-populate vehicle data from helper
  function populateVehicleDataFromHelper() {
    console.log('🚗 Parts Search: Auto-populating vehicle data from helper...');
    
    try {
      const helperString = sessionStorage.getItem('helper');
      if (helperString) {
        const helper = JSON.parse(helperString);
        console.log('✅ Helper data loaded for parts search:', helper);
        
        // Populate form fields with helper data using field mapping
        const fieldMappings = {
          'plate': helper.vehicle?.plate || helper.meta?.plate,
          'manufacturer': helper.vehicle?.manufacturer,
          'model': helper.vehicle?.model,
          'trim': helper.vehicle?.trim,
          'year': helper.vehicle?.year,
          'engine_volume': helper.vehicle?.engine_volume,
          'engine_code': helper.vehicle?.model_code,
          'engine_type': helper.vehicle?.engine_model,
          'vin': helper.vehicle?.chassis
        };
        
        // Apply the mappings
        Object.entries(fieldMappings).forEach(([fieldId, value]) => {
          const element = document.getElementById(fieldId);
          if (element && value) {
            element.value = value;
            console.log(`  ✅ ${fieldId}: "${value}"`);
          }
        });
        
        console.log('✅ Parts search auto-population completed');
      } else {
        console.log('⚠️ No helper data found in sessionStorage');
      }
    } catch (error) {
      console.error('❌ Error auto-populating vehicle data:', error);
    }
  }
  
  // Auto-populate on page load
  populateVehicleDataFromHelper();
  
  // Listen for helper updates
  window.addEventListener('storage', (e) => {
    if (e.key === 'helper') {
      console.log('🔄 Helper data updated, re-populating parts search...');
      populateVehicleDataFromHelper();
    }
  });

  const groupSelect = document.getElementById('part_group');
  const nameSelect = document.getElementById('part_name');

  if (!window.PARTS_BANK) {
    alert("חסר קובץ חלקים או שהטעינה נכשלה");
    return;
  }

  for (const group in window.PARTS_BANK) {
    const option = document.createElement('option');
    option.value = group;
    option.textContent = group;
    groupSelect.appendChild(option);
  }

  groupSelect.addEventListener('change', () => {
    nameSelect.innerHTML = '<option value="" disabled selected hidden>בחר חלק</option>';
    const selectedCategory = groupSelect.value;
    const parts = window.PARTS_BANK[selectedCategory] || [];
    
    console.log(`🔍 Loading ${parts.length} parts for category: ${selectedCategory}`);
    
    parts.forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      opt.setAttribute('data-category', selectedCategory);
      nameSelect.appendChild(opt);
    });
    
    // 🎯 CREATIVE: Visual feedback for category loading
    showNotification(`נטענו ${parts.length} חלקים עבור ${selectedCategory}`, 'info');
    autoSaveSearchProgress();
  });
  
  // 🎯 CREATIVE ENHANCEMENTS: Smart features for parts search
  
  // Smart notification system
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    const colors = {
      success: '#10b981',
      info: '#3b82f6', 
      warning: '#f59e0b',
      error: '#ef4444'
    };
    
    notification.style.cssText = `
      position: fixed; top: 20px; right: 20px; z-index: 9999;
      background: ${colors[type]}; color: white; padding: 12px 16px;
      border-radius: 8px; font-size: 14px; font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateX(100%); transition: transform 0.3s ease;
      max-width: 300px; direction: rtl;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    setTimeout(() => notification.style.transform = 'translateX(0)', 100);
    setTimeout(() => {
      notification.style.transform = 'translateX(100%)';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }
  
  // Auto-save search progress
  function autoSaveSearchProgress() {
    const searchData = {
      vehicle: {
        plate: document.getElementById('plate').value,
        manufacturer: document.getElementById('manufacturer').value,
        model: document.getElementById('model').value,
        year: document.getElementById('year').value,
        engine_volume: document.getElementById('engine_volume').value
      },
      parts: {
        group: document.getElementById('part_group').value,
        name: document.getElementById('part_name').value,
        source: document.getElementById('part_source').value,
        quantity: document.getElementById('part_quantity').value
      },
      timestamp: new Date().toISOString()
    };
    
    sessionStorage.setItem('partsSearchProgress', JSON.stringify(searchData));
    console.log('💾 Auto-saved search progress');
  }
  
  // 🎯 SMART FORM BUILDER for external sites - ENHANCED to capture ALL parts
  window.generateExternalForm = function() {
    const vehicle = {
      manufacturer: document.getElementById('manufacturer').value,
      model: document.getElementById('model').value,
      year: document.getElementById('year').value,
      engine_volume: document.getElementById('engine_volume').value
    };
    
    // ✅ FIXED: Capture ALL parts from selectedParts array, not just current dropdown
    let partsToExport = [];
    
    // Add all parts from the selected parts list
    if (selectedParts && selectedParts.length > 0) {
      partsToExport = [...selectedParts];
    }
    
    // Also add current form part if it's filled out and not already in the list
    const currentPart = {
      group: document.getElementById('part_group').value,
      name: document.getElementById('part_name').value,
      source: document.getElementById('part_source').value,
      quantity: document.getElementById('part_quantity').value || 1
    };
    
    if (currentPart.group && currentPart.name) {
      // Check if this part is not already in the list
      const isDuplicate = partsToExport.some(p => 
        p.group === currentPart.group && 
        p.name === currentPart.name && 
        p.source === currentPart.source
      );
      
      if (!isDuplicate) {
        partsToExport.push(currentPart);
      }
    }
    
    if (!vehicle.manufacturer || !vehicle.model) {
      showNotification('אנא מלא את פרטי הרכב', 'warning');
      return;
    }
    
    if (partsToExport.length === 0) {
      showNotification('אנא הוסף לפחות חלק אחד לרשימה', 'warning');
      return;
    }
    
    showExternalFormModal(vehicle, partsToExport);
  };
  
  function showExternalFormModal(vehicle, parts) {
    // ✅ ENHANCED: Handle multiple parts in smart form
    const partsArray = Array.isArray(parts) ? parts : [parts];
    const totalParts = partsArray.length;
    
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); display: flex; align-items: center;
      justify-content: center; z-index: 10000; direction: rtl;
    `;
    
    // Generate parts list HTML
    const partsListHTML = partsArray.map((part, index) => `
      <div style="background: #ecfdf5; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #10b981;">
        <strong>חלק ${index + 1}:</strong><br>
        קטגוריה: <strong>${part.group}</strong><br>
        ${part.name ? `שם החלק: <strong>${part.name}</strong><br>` : ''}
        ${part.source ? `מקור: <strong>${part.source}</strong><br>` : ''}
        כמות: <strong>${part.quantity || part.qty || 1}</strong>
        ${part.price ? `<br>מחיר משוער: <strong>${part.price}</strong>` : ''}
        ${part.supplier ? `<br>ספק: <strong>${part.supplier}</strong>` : ''}
      </div>
    `).join('');
    
    modal.innerHTML = `
      <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
        <h3 style="color: #1e3a8a; margin-bottom: 20px; text-align: center;">🔍 טופס חכם לאתר חלפים חיצוני</h3>
        
        <div style="background: #f0f9ff; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
          <strong>פרטי הרכב:</strong><br>
          יצרן: <strong>${vehicle.manufacturer}</strong><br>
          דגם: <strong>${vehicle.model}</strong><br>
          שנה: <strong>${vehicle.year}</strong><br>
          נפח מנוע: <strong>${vehicle.engine_volume}</strong>
        </div>
        
        <div style="margin-bottom: 20px;">
          <strong style="color: #10b981;">חלקים מבוקשים (${totalParts}):</strong><br>
          ${partsListHTML}
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
          <button onclick="copyFormData('${JSON.stringify({vehicle, parts: partsArray}).replace(/"/g, '&quot;')}')" 
                  style="background: #3b82f6; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
            📋 העתק נתונים
          </button>
          <button onclick="openSearchSite(); this.closest('[style*=fixed]').remove();" 
                  style="background: #10b981; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
            🌐 פתח Car-Part
          </button>
          <button onclick="this.closest('[style*=fixed]').remove()" 
                  style="background: #6b7280; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer;">
            ✕ סגור
          </button>
        </div>
      </div>
    `;
    
    modal.onclick = (e) => e.target === modal && modal.remove();
    document.body.appendChild(modal);
  }
  
  window.copyFormData = function(dataStr) {
    const data = JSON.parse(dataStr.replace(/&quot;/g, '"'));
    
    // ✅ ENHANCED: Handle multiple parts in copy function
    let text = `פרטי רכב:
יצרן: ${data.vehicle.manufacturer}
דגם: ${data.vehicle.model}
שנה: ${data.vehicle.year}
נפח מנוע: ${data.vehicle.engine_volume}

חלקים מבוקשים (${data.parts ? data.parts.length : 1}):
`;
    
    if (data.parts && Array.isArray(data.parts)) {
      // Multiple parts
      data.parts.forEach((part, index) => {
        text += `${index + 1}. ${part.group} - ${part.name || ''}
   מקור: ${part.source || ''}
   כמות: ${part.quantity || part.qty || 1}
${part.price ? `   מחיר משוער: ${part.price}` : ''}
${part.supplier ? `   ספק: ${part.supplier}` : ''}

`;
      });
    } else if (data.part) {
      // Single part (legacy support)
      text += `1. ${data.part.group} - ${data.part.name || ''}
   מקור: ${data.part.source || ''}
   כמות: ${data.part.quantity}`;
    }
    
    navigator.clipboard.writeText(text).then(() => {
      showNotification('נתונים הועתקו בהצלחה!', 'success');
    }).catch(() => {
      showNotification('שגיאה בהעתקה', 'error');
    });
  };
  
  // Auto-save on form changes
  document.querySelectorAll('input, select').forEach(element => {
    element.addEventListener('change', autoSaveSearchProgress);
  });
  
  });

  let imageBase64 = null;
  document.getElementById('part_image').addEventListener('change', function () {
    const file = this.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function (e) {
      imageBase64 = e.target.result;
      const img = document.getElementById('previewImage');
      img.src = imageBase64;
      img.style.display = 'block';
    };
    reader.readAsDataURL(file);
  });
</script>
<script>
  const selectedParts = [];
  const listUI = document.getElementById('selected_parts_list');

  function addFullPart() {
    const group = document.getElementById('part_group').value;
    const name = document.getElementById('part_name').value;
    const qty = document.getElementById('part_quantity').value || '1';
    const source = document.getElementById('part_source').value || 'מקורי';

    if (!group || !name) {
      alert("יש לבחור לפחות קבוצת חלקים ושם חלק");
      return;
    }

    const item = { group, name, qty, source };
    selectedParts.push(item);

    const li = document.createElement('li');
    li.textContent = `${group} - ${name} | כמות: ${qty} | מקור: ${source}`;
    li.style.cursor = "pointer";
    li.title = "לחץ להסרה";
    li.onclick = () => {
      const index = selectedParts.indexOf(item);
      if (index !== -1) {
        selectedParts.splice(index, 1);
        updateSelectedPartsList();
      }
    };

    listUI.appendChild(li);

    document.getElementById('part_name').value = '';
    document.getElementById('part_quantity').value = '1';
    document.getElementById('part_source').value = '';
  }
  
  // ✅ NEW: Send current parts list to Make.com for processing
  
  // ✅ FIX 1: Implement missing exportSelectedParts function
  function exportSelectedParts() {
    console.log('📄 Exporting selected parts to Excel...');
    
    if (selectedParts.length === 0) {
      alert('אין חלקים נבחרים לייצוא');
      return;
    }
    
    // Prepare export payload
    const exportData = {
      parts: selectedParts,
      vehicle_context: {
        plate: document.getElementById('plate').value,
        manufacturer: document.getElementById('manufacturer').value,
        model: document.getElementById('model').value,
        year: document.getElementById('year').value,
        trim: document.getElementById('trim').value,
        engine_volume: document.getElementById('engine_volume').value
      },
      export_timestamp: new Date().toISOString(),
      export_type: 'selected_parts_list'
    };
    
    // Send to ADMIN_EXPORT_SEARCH_RESULTS webhook
    fetch('https://hook.eu2.make.com/rocp5ue661qn3597akgptja4ol9cnksy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        task: 'export_parts_list',
        payload: exportData
      })
    })
    .then(response => {
      if (!response.ok) throw new Error('Export failed');
      return response.json();
    })
    .then(result => {
      console.log('✅ Parts exported successfully:', result);
      alert(`✅ ייצוא הושלם בהצלחה!\n${selectedParts.length} חלקים יוצאו לקובץ Excel`);
      
      // If download URL is provided, trigger download
      if (result.download_url) {
        const a = document.createElement('a');
        a.href = result.download_url;
        a.download = `parts_export_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    })
    .catch(error => {
      console.error('❌ Export error:', error);
      alert('שגיאה בייצוא הקובץ');
    });
  }
  
  // ✅ FIX 2: Enhanced helper integration with 3-category system
  function updateHelperWithPartsSearch(searchResults, searchContext) {
    try {
      let helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Initialize enhanced parts_search structure
      if (!helper.parts_search) {
        helper.parts_search = {
          selected_parts: [],
          unselected_parts: [],
          global_parts_bank: { all_parts: [] },
          current_session: { results: [] },
          case_search_history: [],
          case_summary: {
            total_searches: 0,
            total_results: 0,
            selected_count: 0,
            unselected_count: 0,
            last_search: '',
            estimated_total_cost: 0
          }
        };
      }
      
      // Add search results to all categories
      if (searchResults && searchResults.length > 0) {
        // Mark as unselected initially
        const markedResults = searchResults.map(part => ({
          ...part,
          id: `part_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          selected: false,
          search_timestamp: new Date().toISOString(),
          search_context: searchContext
        }));
        
        // Add to unselected_parts and global bank
        helper.parts_search.unselected_parts.push(...markedResults);
        helper.parts_search.global_parts_bank.all_parts.push(...markedResults);
        helper.parts_search.current_session.results = markedResults;
        
        // Update summary
        helper.parts_search.case_summary = {
          ...helper.parts_search.case_summary,
          total_results: helper.parts_search.global_parts_bank.all_parts.length,
          unselected_count: helper.parts_search.unselected_parts.length,
          last_search: new Date().toISOString()
        };
      }
      
      // Save updated helper
      sessionStorage.setItem('helper', JSON.stringify(helper));
      localStorage.setItem('helper_data', JSON.stringify(helper));
      
      console.log('✅ Helper updated with enhanced parts search structure');
      
      return helper;
    } catch (error) {
      console.error('❌ Error updating helper:', error);
      return null;
    }
  }
  
  // ✅ FIX 3: Enhanced validation rules according to architecture
  function validateSearchForm() {
    const selectedPartsCount = selectedParts ? selectedParts.length : 0;
    const freeQuery = document.getElementById('free_query').value.trim();
    const hasImage = imageBase64 !== null;
    const hasVehicleData = document.getElementById('manufacturer').value.trim() !== '';
    const hasPartGroup = document.getElementById('part_group').value.trim() !== '';
    const hasPartName = document.getElementById('part_name').value.trim() !== '';
    
    console.log('🔍 Validation check:', {
      selectedPartsCount,
      freeQuery,
      hasImage,
      hasVehicleData,
      hasPartGroup,
      hasPartName
    });
    
    // Rule 1: External site search - requires parts list
    // (This is handled in the external site functions)
    
    // Rule 2: System/Image search - requires one of: free search field, parts list, part selection, OR image
    const hasSearchCriteria = freeQuery || selectedPartsCount > 0 || hasImage || (hasPartGroup && hasPartName);
    
    if (!hasSearchCriteria) {
      alert('יש למלא לפחות אחד מהשדות הבאים:\n• חיפוש חופשי\n• בחירת חלק מהרשימה\n• רשימת חלקים שנוספה\n• תמונה לחיפוש');
      return false;
    }
    
    // Rule 3: Car details not mandatory but recommended
    if (!hasVehicleData) {
      const confirmSearch = confirm('לא הוזנו פרטי רכב. האם להמשיך בחיפוש כללי?');
      if (!confirmSearch) return false;
    }
    
    console.log('✅ Validation passed');
    return true;
  }
  
  // Make functions globally available
  window.exportSelectedParts = exportSelectedParts;
  window.updateHelperWithPartsSearch = updateHelperWithPartsSearch;
  window.validateSearchForm = validateSearchForm;
  
</script>

<script>
  document.getElementById('partSearchForm').addEventListener('submit', e => {
    e.preventDefault();
    
    // ✅ FIX 4: Apply validation rules before submitting
    if (!validateSearchForm()) {
      return;
    }
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'מחפש...';
    submitBtn.disabled = true;
    
    // Enhanced payload includes selected parts list if available
    const payload = {
      plate: plate.value.trim(),
      manufacturer: manufacturer.value.trim(),
      model: model.value.trim(),
      trim: trim.value.trim(),
      year: year.value.trim(),
      engine_volume: engine_volume.value.trim(),
      engine_code: engine_code.value.trim(),
      engine_type: engine_type.value.trim(),
      vin: vin.value.trim(),
      part_group: part_group.value,
      part_name: part_name.value,
      free_query: free_query.value.trim(),
      part_image_base64: imageBase64 || null,
      selectedParts: selectedParts || [],
      // Include parts list in search if available
      search_type: (selectedParts && selectedParts.length > 0) ? 'enhanced_with_parts_list' : 'standard',
      parts_list: selectedParts || []
    };
    
    sendPartSearch(payload).then(results => {
      if (results && results.parts && results.parts.length > 0) {
        displaySearchResults(results.parts);
        alert(`✅ נמצאו ${results.parts.length} חלקים`);
        
        // ✅ FIXED: Use enhanced helper integration with 3-category system
        try {
          const searchContext = {
            query: {
              plate: plate.value.trim(),
              manufacturer: manufacturer.value.trim(),
              model: model.value.trim(),
              part_group: part_group.value,
              part_name: part_name.value,
              free_query: free_query.value.trim()
            },
            timestamp: new Date().toISOString(),
            results_count: results.parts.length,
            search_type: 'system_search'
          };
          
          // Use enhanced helper integration
          const updatedHelper = updateHelperWithPartsSearch(results.parts, searchContext);
          
          if (updatedHelper) {
            console.log(`✅ Enhanced: Saved ${results.parts.length} search results to helper with 3-category system`);
            
            // Trigger helper update broadcast if available
            if (typeof window.broadcastHelperUpdate === 'function') {
              window.broadcastHelperUpdate(['parts_search'], 'parts_search_module');
            }
            
            // Integration with damage centers if in wizard mode
            if (typeof window.capturePartsWebhookResponse === 'function') {
              window.capturePartsWebhookResponse(results, searchContext);
            }
          }
        } catch (e) {
          console.error('❌ Error saving search results with enhanced system:', e);
        }
      } else {
        alert('לא נמצאו תוצאות מתאימות');
      }
    }).catch(error => {
      console.error('Search error:', error);
      alert('שגיאה בחיפוש חלקים');
    }).finally(() => {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    });
  });
</script>
<script>
document.getElementById('sendResultToOCRBtn').addEventListener('click', function () {
  const fileInput = document.getElementById('resultFileUpload');
  const file = fileInput.files[0];
  if (!file) {
    alert('אנא העלה קובץ חיפוש לפני השליחה');
    return;
  }

  // Show processing indicator
  const btn = document.getElementById('sendResultToOCRBtn');
  const originalText = btn.textContent;
  btn.textContent = 'מעבד...';
  btn.disabled = true;

  sendSearchResultFile(file, {
    plate: sessionStorage.getItem('plate') || '',
    model: sessionStorage.getItem('model') || ''
  }).then(results => {
    if (results && results.parts && results.parts.length > 0) {
      displaySearchResults(results.parts);
      alert(`✅ נמצאו ${results.parts.length} חלקים בקובץ`);
    } else {
      alert('לא נמצאו חלקים בקובץ או שגיאה בעיבוד');
    }
  }).catch(error => {
    console.error('OCR processing error:', error);
    alert('שגיאה בעיבוד הקובץ');
  }).finally(() => {
    btn.textContent = originalText;
    btn.disabled = false;
  });
});

</script>
<script type="module">
  import { sendPartSearch, sendSearchResultFile } from './webhook.js';
  import { dev_credentials } from './credentials-vault.js';

  window.sendPartSearch = sendPartSearch;
  window.sendSearchResultFile = sendSearchResultFile;
  window.dev_credentials = dev_credentials;

  // Enhanced search site opening with better UX
  window.openSearchSite = function () {
    const vehicleData = {
      manufacturer: document.getElementById('manufacturer').value,
      model: document.getElementById('model').value,
      year: document.getElementById('year').value
    };
    
    console.log('🌐 Opening Car-Part in internal browser with vehicle data:', vehicleData);
    
    // ✅ FIXED: Enhanced check and fallback for internal browser
    if (typeof window.openInternalBrowser === 'function') {
      try {
        console.log('✅ Internal browser available, opening car-part.co.il');
        window.openInternalBrowser('car-part.co.il', 'חיפוש חלפים');
        
        // Create toggle popup for parts list visibility
        setTimeout(() => {
          createPartsListTogglePopup();
        }, 2000);
        
      } catch (error) {
        console.error('❌ Failed to open internal browser:', error);
        alert('שגיאה בפתיחת הדפדפן הפנימי: ' + error.message);
        // Fallback to external window
        window.open('https://www.car-part.co.il/Include/Generic/AccessSystem.jsp', '_blank');
      }
    } else {
      console.error('❌ Internal browser function not available');
      console.log('Available window functions:', Object.keys(window).filter(k => k.includes('Internal') || k.includes('Browser')));
      alert('הדפדפן הפנימי לא זמין במערכת, פותח בחלון נפרד');
      // Fallback to external window
      window.open('https://www.car-part.co.il/Include/Generic/AccessSystem.jsp', '_blank');
    }

    const creds = dev_credentials?.carPart;
    if (creds) {
      const message = `📋 פרטי גישה לאתר Car-Part:\nשם משתמש: ${creds.username}\nסיסמה: ${creds.password}\n\n🚗 פרטי הרכב לחיפוש:\n${vehicleData.manufacturer} ${vehicleData.model} ${vehicleData.year}`;
      
      // Copy credentials to clipboard if possible
      if (navigator.clipboard) {
        navigator.clipboard.writeText(`${creds.username}\t${creds.password}`).then(() => {
          alert(message + '\n\n✅ פרטי הגישה הועתקו ללוח');
        }).catch(() => {
          alert(message);
        });
      } else {
        alert(message);
      }
    } else {
      alert('⚠️ לא נמצאו פרטי התחברות');
    }
  };
  
  // Enhanced result display function
  window.displaySearchResults = function(results) {
    const container = document.getElementById('search_results_display');
    const content = document.getElementById('search_results_content');
    
    if (!results || results.length === 0) {
      container.style.display = 'none';
      return;
    }
    
    content.innerHTML = results.map((result, index) => `
      <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 5px; background: white; cursor: pointer;" 
           onclick="selectSearchResult(${index})">
        <strong>${result.name || result.description || 'חלק ללא שם'}</strong>
        ${result.description ? `<br><small>${result.description}</small>` : ''}
        ${result.price ? `<br>מחיר: <span style="color: #28a745; font-weight: bold;">₪${result.price}</span>` : ''}
        ${result.source ? `<br>מקור: ${result.source}` : ''}
        ${result.supplier ? `<br>ספק: ${result.supplier}` : ''}
        <br><small style="color: #007bff;">לחץ להוספה לרשימה</small>
      </div>
    `).join('');
    
    container.style.display = 'block';
    window.currentSearchResults = results;
  };
  
  window.selectSearchResult = function(index) {
    const result = window.currentSearchResults[index];
    if (!result) return;
    
    // Auto-fill form with selected result
    document.getElementById('part_name').value = result.name || result.description || '';
    if (result.source) {
      document.getElementById('part_source').value = result.source;
    }
    
    // Add to selected parts
    const item = { 
      group: result.category || 'מחיפוש', 
      name: result.name || result.description || '', 
      qty: 1, 
      source: result.source || 'תחליפי',
      price: result.price || '',
      supplier: result.supplier || ''
    };
    selectedParts.push(item);
    updateSelectedPartsList();
    
    alert('✅ החלק נוסף לרשימה');
  };
  
  window.clearSearchResults = function() {
    document.getElementById('search_results_display').style.display = 'none';
    window.currentSearchResults = [];
  };
  
  // exportSelectedParts function moved to lines 526-580 (webhook-based Excel export)
  
  window.saveToSession = function() {
    if (selectedParts.length === 0) {
      alert('אין חלקים לשמירה');
      return;
    }
    
    try {
      // ✅ FIXED: Use correct sessionStorage location for helper data
      let helper = {};
      try {
        helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      } catch (e) {
        console.warn('Failed to parse helper from sessionStorage, using empty object');
        helper = {};
      }
      
      // Initialize parts_search structure
      helper.parts_search = helper.parts_search || { 
        results: [], 
        all_results: [], 
        search_history: [],
        selected_parts: [],
        unselected_parts: [],
        summary: {}
      };
      
      // Mark selected parts in all_results
      if (helper.parts_search.all_results) {
        helper.parts_search.all_results.forEach(result => {
          const isSelected = selectedParts.some(selected => 
            (selected.name === result.name || selected.name === result.description) &&
            selected.source === result.source
          );
          if (isSelected) {
            result.selected = true;
            result.selected_timestamp = new Date().toISOString();
          }
        });
      }
      
      // Save selected parts to the dedicated selected_parts array
      helper.parts_search.selected_parts = [...(helper.parts_search.selected_parts || []), ...selectedParts];
      
      // Save selected parts to results (for backward compatibility)
      helper.parts_search.results = [...(helper.parts_search.results || []), ...selectedParts];
      
      // Update summary with comprehensive information
      helper.parts_search.summary = {
        total_results: helper.parts_search.results.length,
        total_all_results: helper.parts_search.all_results?.length || 0,
        selected_count: helper.parts_search.selected_parts.length || selectedParts.length,
        total_searches: helper.parts_search.search_history?.length || 0,
        last_updated: new Date().toISOString()
      };
      
      // Update meta information
      helper.meta = helper.meta || {};
      helper.meta.last_updated = new Date().toISOString();
      
      // ✅ FIXED: Save to correct sessionStorage location
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      // Also save to localStorage for backup compatibility
      localStorage.setItem('helper_data', JSON.stringify(helper));
      
      console.log(`✅ FIXED: Saved ${selectedParts.length} selected parts to helper (sessionStorage)`);
      
      // Trigger helper update broadcast if available
      if (typeof window.broadcastHelperUpdate === 'function') {
        window.broadcastHelperUpdate(['parts_search'], 'parts_save_session');
      }
      
      // Check if opened from estimate builder
      const partSearchTarget = sessionStorage.getItem('partSearchTarget');
      if (partSearchTarget && window.opener) {
        try {
          const target = JSON.parse(partSearchTarget);
          
          // Send selected parts back to estimate builder
          if (selectedParts.length > 0) {
            window.opener.postMessage({
              type: 'PARTS_SELECTED',
              parts: selectedParts,
              target: target
            }, '*');
            
            alert(`✅ נשמרו ${selectedParts.length} חלקים והועברו לאומדן`);
            window.close();
            return;
          }
        } catch (e) {
          console.error('Error communicating with estimate builder:', e);
        }
      }
      
      alert(`✅ נשמרו ${selectedParts.length} חלקים להמשך באשף`);
    } catch (e) {
      console.error('Error saving to session:', e);
      alert('שגיאה בשמירה');
    }
  };
  
  function generatePartsCSV(parts) {
    const headers = ['קטגוריה', 'שם החלק', 'כמות', 'מקור', 'מחיר', 'ספק'];
    const rows = parts.map(part => [
      part.group || '',
      part.name || '',
      part.qty || 1,
      part.source || '',
      part.price || '',
      part.supplier || ''
    ]);
    
    return [headers, ...rows].map(row => 
      row.map(field => `"${field}"`).join(',')
    ).join('\n');
  }
  
  function updateSelectedPartsList() {
    const listUI = document.getElementById('selected_parts_list');
    listUI.innerHTML = selectedParts.map((item, index) => `
      <li style="margin-bottom: 5px; padding: 5px; background: #f0f0f0; border-radius: 3px;">
        ${item.group} - ${item.name} | כמות: ${item.qty} | מקור: ${item.source}
        ${item.price ? ` | מחיר: ₪${item.price}` : ''}
        <button onclick="selectedParts.splice(${index}, 1); updateSelectedPartsList();" 
                style="margin-right: 10px; background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer;">✕</button>
      </li>
    `).join('');
  }

  const autofillFields = [
    'plate', 'manufacturer', 'model', 'trim', 'year',
    'engine_volume', 'engine_code', 'engine_type', 'vin'
  ];
  autofillFields.forEach(key => {
    const val = sessionStorage.getItem(key);
    if (val) {
      const input = document.getElementById(key);
      if (input) {
        input.value = val;
        input.readOnly = true;
      }
    }
  });

  const auth = sessionStorage.getItem("auth");
  if (!auth) {
    alert("הגישה חסומה - אנא התחבר דרך דף הבית");
    window.location.href = "index.html";
  }

  const logoutBtn = document.querySelector(".logout-btn");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", function (e) {
      e.preventDefault();
      sessionStorage.clear();
      window.location.href = "index.html";
    });
  }
  
  // ✅ FIX 5: Create toggle popup for parts list visibility in internal browser
  function createPartsListTogglePopup() {
    console.log('🎯 Creating parts list toggle popup for internal browser');
    
    if (selectedParts.length === 0) {
      console.warn('⚠️ No parts selected for external site search');
      return;
    }
    
    // Remove existing popup if any
    const existingPopup = document.getElementById('partsListTogglePopup');
    if (existingPopup) {
      existingPopup.remove();
    }
    
    // Create toggle popup
    const popup = document.createElement('div');
    popup.id = 'partsListTogglePopup';
    popup.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      width: 300px;
      max-height: 400px;
      background: white;
      border: 2px solid #3b82f6;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 10000;
      font-family: Arial, sans-serif;
      font-size: 14px;
      overflow-y: auto;
    `;
    
    const partsListHTML = selectedParts.map((part, index) => `
      <div style="padding: 8px; border-bottom: 1px solid #eee; background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
        <div style="font-weight: bold; color: #1e40af;">${part.group} - ${part.name}</div>
        <div style="font-size: 12px; color: #6b7280;">
          כמות: ${part.qty} | מקור: ${part.source}
        </div>
      </div>
    `).join('');
    
    popup.innerHTML = `
      <div style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; padding: 12px; border-radius: 10px 10px 0 0; text-align: center;">
        <strong>רשימת חלקים מבוקשים (${selectedParts.length})</strong>
      </div>
      <div style="padding: 12px;">
        <div style="max-height: 250px; overflow-y: auto; margin-bottom: 12px;">
          ${partsListHTML}
        </div>
        <div style="display: flex; gap: 8px; justify-content: center;">
          <button onclick="copyPartsListForSite()" style="
            background: #10b981; color: white; border: none; padding: 8px 12px; 
            border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;
          ">📋 העתק רשימה</button>
          <button onclick="togglePopupVisibility()" style="
            background: #f59e0b; color: white; border: none; padding: 8px 12px; 
            border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;
          ">👁️ הסתר/הצג</button>
          <button onclick="closePartsListPopup()" style="
            background: #ef4444; color: white; border: none; padding: 8px 12px; 
            border-radius: 6px; cursor: pointer; font-size: 12px;
          ">✕</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(popup);
    
    // Make popup draggable
    let isDragging = false;
    let currentX, currentY, initialX, initialY;
    
    popup.addEventListener('mousedown', (e) => {
      if (e.target === popup || e.target.closest('.popup-header')) {
        isDragging = true;
        initialX = e.clientX - popup.offsetLeft;
        initialY = e.clientY - popup.offsetTop;
      }
    });
    
    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;
        popup.style.left = currentX + 'px';
        popup.style.top = currentY + 'px';
        popup.style.right = 'auto';
      }
    });
    
    document.addEventListener('mouseup', () => {
      isDragging = false;
    });
  }
  
  // ✅ Helper functions for toggle popup
  window.copyPartsListForSite = function() {
    const partsText = selectedParts.map(part => 
      `${part.group} - ${part.name} (כמות: ${part.qty}, מקור: ${part.source})`
    ).join('\n');
    
    const vehicleInfo = `פרטי רכב:
יצרן: ${document.getElementById('manufacturer').value}
דגם: ${document.getElementById('model').value}
שנה: ${document.getElementById('year').value}

רשימת חלקים מבוקשים:
${partsText}`;
    
    navigator.clipboard.writeText(vehicleInfo).then(() => {
      alert('✅ רשימת החלקים הועתקה ללוח!');
    }).catch(() => {
      alert('❌ שגיאה בהעתקה');
    });
  };
  
  window.togglePopupVisibility = function() {
    const popup = document.getElementById('partsListTogglePopup');
    if (popup) {
      const content = popup.querySelector('div:last-child');
      if (content.style.display === 'none') {
        content.style.display = 'block';
        popup.style.height = 'auto';
      } else {
        content.style.display = 'none';
        popup.style.height = '44px';
      }
    }
  };
  
  window.closePartsListPopup = function() {
    const popup = document.getElementById('partsListTogglePopup');
    if (popup) {
      popup.remove();
    }
  };
  
  // Make function globally available
  window.createPartsListTogglePopup = createPartsListTogglePopup;

</script>
</body>
</html>
