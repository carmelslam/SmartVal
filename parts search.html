<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×¤×•×¨×˜×œ - ×—×™×¤×•×© ×—×œ×¤×™×</title>
  <script type="module" src="./parts.js"></script>
  <script type="module" src="./webhook.js"></script>
  <script src="./services/supabaseClient.js"></script>
  <script src="./hebrew-text-normalizer.js"></script>
  <script src="./services/smartPartsSearchService.js"></script>
  <script type="module" src="./parts-search-results-pip.js"></script>
  <script type="module" src="./selected-parts-list.js"></script>
  <script type="module" src="./parts-helper-utils.js"></script>
  <script src="./internal-browser.js"></script>

  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link rel="shortcut icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link rel="apple-touch-icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3a8a 0%, #64748b 100%);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      max-width: 450px;
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
      position: relative;

    }
    .logo img {
      width: 120px;
      margin-bottom: 15px;
    }
    .title { font-size: 24px; font-weight: bold; margin-bottom: 5px; color: #1e3a8a; }
    .subtitle { font-size: 18px; color: #64748b; margin-bottom: 5px; }
    .legal-note {
      color: red;
      font-weight: bold;
      margin-bottom: 15px;
    }
    h2 {
      font-size: 20px;
      color: #1e3a8a;
      margin-bottom: 20px;
    }
  .right-small-heading {
    text-align: right;
    font-size: 18px;
    color: #1e3a8a;
   margin-bottom: 18px;
  }

    input, select {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .btn {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background-color: #3b82f6;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
      Margin-bottom: 10px;
    }
    .footer-btns {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    .footer-btns button {
      width: 48%;
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
    .home-btn { background-color: #6c757d; color: white; }
    .logout-btn { background-color: #dc3545; color: white; }
    .footer { font-size: 12px; color: #475569; margin-top: 15px; text-align: center; }
    #previewImage {
      display: none;
      max-width: 100%;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
  </style>
</head>
<body>
<div class="container">
    <div class="logo">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo">
    </div>
    <div class="title">×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×¤×•×¨×˜×œ</div>
    <div class="subtitle">×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</div>
  <h2>×—×™×¤×•×© ×—×œ×¤×™× ×œ×¨×›×‘</h2>
  <form id="partSearchForm">
    <input type="text" id="plate" name="plate" placeholder="××¡×¤×¨ ×¨×™×©×•×™">
    <input type="text" id="manufacturer" name="manufacturer" placeholder="×™×¦×¨×Ÿ">
    <input type="text" id="model" name="model" placeholder="×“×’×">
    <input type="text" id="model_code" name="model_code" placeholder="×§×•×“ ×“×’× (C6, MK7, F30)">
    <input type="text" id="trim" name="trim" placeholder="×¨××ª ×’×™××•×¨">
    <input type="text" id="year" name="year" placeholder="×©× ×”">
    <input type="text" id="engine_volume" name="engine_volume" placeholder="× ×¤×— ×× ×•×¢">
    <input type="text" id="engine_code" name="engine_code" placeholder="×“×’× ×× ×•×¢">
    <input type="text" id="engine_type" name="engine_type" placeholder="×¡×•×’ ×× ×•×¢">
    <input type="text" id="vin" name="vin" placeholder="××¡×¤×¨ ×©×œ×“×”">
    <input type="text" id="oem" name="oem" placeholder="××¡×¤×¨ OEM">
 <input type="text" id="free_query" name="free_query" placeholder="×—×™×¤×•×© ×—×•×¤×©×™">
<h2 class="right-small-heading">×”×¢×œ×”/×¦×œ× ×ª××•× ×” ×œ×—×™×¤×•×© (××•×¤×¦×™×•× ×œ×™)</h2>
    <input type="file" id="part_image" accept="image/*" capture="environment" placeholder="×ª××•× ×ª ×—×œ×§ (××•×¤×¦×™×•× ×œ×™)">
    <img id="previewImage" />
    <select id="part_group" onchange="updatePartNameOptions()">
      <option value="" disabled selected hidden>×‘×—×¨ ×§×‘×•×¦×ª ×—×œ×§×™×</option>
    </select>
    <select id="part_name">
      <option value="" disabled selected hidden>×‘×—×¨ ×—×œ×§</option>
    </select>
<select id="part_source">
  <option value="" disabled selected hidden>×‘×—×¨ ××§×•×¨</option>
  <option value="××§×•×¨×™">××§×•×¨×™</option>
  <option value="×ª×—×œ×™×¤×™">×ª×—×œ×™×¤×™</option>
  <option value="××©×•××©">××©×•××©</option>
  <option value="×”×›×œ">×”×›×œ</option>
</select>
<input type="number" id="part_quantity" placeholder="×›××•×ª" min="1" value="1">

<!-- Supabase Search Button -->
<button class="btn" type="button" onclick="searchSupabase()" style="background: #10b981; width: 100%; margin: 10px 0;">ğŸ” ×—×¤×© ×‘-Supabase</button>

<button type="button" class="btn" onclick="addFullPart()">×”×•×¡×£ ×—×œ×§ ×œ×¨×©×™××”</button>

<!-- Selected Parts List Header and Display (matching screenshot design) -->
<div style="margin-top: 20px; background: #c5f5e8; padding: 15px; border-radius: 8px; border: 1px solid #10b981;">
  <div style="text-align: center; margin-bottom: 10px;">
    <h3 id="selected_parts_header" style="color: #047857; margin: 0; font-size: 16px; font-weight: bold;">
      ×¨×©×™××ª ×—×œ×§×™× × ×‘×—×¨×™× <span id="selected_parts_count">0</span>
    </h3>
    <p style="color: #059669; margin: 5px 0 0 0; font-size: 12px;">×”×—×œ×§×™× ×™×©××¨×• × ×ª×•× ×™× ×œ×¦×•×¨×š ×—×™×¤×•×© ×‘××ª×¨×™× ×”×—×™×¦×•× ×™×™×</p>
  </div>
  <ul id="selected_parts_list" style="text-align:right; padding-right: 0; font-size: 14px; list-style: none; margin: 0;"></ul>
</div>

<!-- Parts List Management Buttons -->
<div id="parts_management_buttons" style="display: none; margin-top: 10px; text-align: center; gap: 10px;">
  <button type="button" class="btn" onclick="clearAllParts()" style="background: #dc3545; font-size: 14px; padding: 8px 16px;">ğŸ—‘ï¸ × ×§×” ××ª ×›×œ ×”×¨×©×™××”</button>
  <button type="button" class="btn" onclick="duplicateSelectedPart()" style="background: #6c757d; font-size: 14px; padding: 8px 16px;">ğŸ“„ ×©×›×¤×œ ×—×œ×§ ××—×¨×•×Ÿ</button>
</div>

<!-- Enhanced Search Results Display -->
<div id="search_results_display" style="display: none; margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
  <h3 style="color: #007bff; margin-bottom: 10px;">×ª×•×¦××•×ª ×—×™×¤×•×©</h3>
  <div id="search_results_content"></div>
  <button type="button" class="btn" onclick="clearSearchResults()" style="background: #6c757d; margin-top: 10px;">× ×§×” ×ª×•×¦××•×ª</button>
</div>

<h2 style="text-align: right; font-size: 18px;">×—×™×¤×•×© ×—×œ×¤×™× ×‘××ª×¨</h2>
<button type="button" class="btn" onclick="generateExternalForm()" style="background: #10b981; margin-bottom: 10px;">ğŸš€ ×¦×•×¨ ×˜×•×¤×¡ ×—×›× ×œ××ª×¨ ×—×™×¦×•× ×™</button>
<button type="button" class="btn" onclick="openSearchSite()">×¤×ª×— ××ª×¨ car-part ×œ×—×™×¤×•×©</button>
 <label for="resultFileUpload">×”×¢×œ×” ×ª×•×¦××ª ×—×™×¤×•×© (PDF/×ª××•× ×”)</label>
<input type="file" id="resultFileUpload" accept=".pdf,.png,.jpg,.jpeg,.html">
<button type="button" class="btn" id="sendResultToOCRBtn">×©×œ×— ×ª×•×¦××ª ×—×™×¤×•×© ×œ× ×™×ª×•×—</button>
<h2 style="text-align: right; font-size: 18px;">×—×™×¤×•×© ×—×œ×¤×™× ×‘××¢×¨×›×ª ×—×™×¦×•× ×™×ª</h2>
<button class="btn" type="submit" style="background: #007bff; width: 100%; margin: 10px 0;">ğŸ” ×—×¤×© ×‘××¢×¨×›×ª ×—×™×¦×•× ×™×ª (Make.com)</button>

<!-- Enhanced Part Management -->
<div style="margin-top: 20px;">
  <button type="button" class="btn" onclick="exportSelectedParts()" style="background: #28a745;">ğŸ“„ ×™×™×¦× ×—×œ×§×™× ×œ××§×¡×œ</button>
  <button type="button" class="btn" onclick="saveToSession()" style="background: #ffc107; color: #000;">ğŸ’¾ ×©××•×¨ ×œ×”××©×š ×‘××©×£</button>
</div>
  </form>
  <div class="footer-btns">
    <button class="home-btn" onclick="window.location.href='selection.html'">×œ×¢××•×“ ×”×‘×™×ª</button>
    <button class="logout-btn">×™×¦×™××” ××”××¢×¨×›×ª</button>
  </div>
  <div class="footer">All rights reserved Â© Carmel Cayouf</div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
  // âœ… DEBUG: Check internal browser availability on page load
  console.log('ğŸ” Parts Search Page Loaded - Debug Info:');
  console.log('  - openInternalBrowser function available:', typeof window.openInternalBrowser === 'function');
  console.log('  - internal-browser.js loaded:', !!document.querySelector('script[src*="internal-browser"]'));
  if (typeof window.openInternalBrowser === 'function') {
    console.log('  âœ… Internal browser is ready');
  } else {
    console.log('  âŒ Internal browser not available');
    console.log('  - Available window functions containing "Internal":', Object.keys(window).filter(k => k.toLowerCase().includes('internal')));
    console.log('  - Available window functions containing "Browser":', Object.keys(window).filter(k => k.toLowerCase().includes('browser')));
    
    // âœ… RETRY: Try to manually load internal browser if not available
    console.log('  ğŸ”„ Attempting to manually load internal browser...');
    const scriptExists = document.querySelector('script[src*="internal-browser"]');
    if (!scriptExists) {
      const script = document.createElement('script');
      script.src = './internal-browser.js';
      script.onload = () => {
        console.log('  âœ… Internal browser manually loaded');
      };
      script.onerror = () => {
        console.log('  âŒ Failed to manually load internal browser');
      };
      document.head.appendChild(script);
    }
  }
  
  // ENHANCED: Auto-populate vehicle data from helper
  function populateVehicleDataFromHelper() {
    console.log('ğŸš— Parts Search: Auto-populating vehicle data from helper...');
    
    try {
      const helperString = sessionStorage.getItem('helper');
      if (helperString) {
        const helper = JSON.parse(helperString);
        console.log('âœ… Helper data loaded for parts search:', helper);
        
        // Populate form fields with helper data using corrected field mapping
        const fieldMappings = {
          'plate': helper.vehicle?.plate || helper.meta?.plate,
          'manufacturer': helper.vehicle?.manufacturer,
          'model': helper.vehicle?.model,
          'model_code': helper.vehicle?.vehicle_model_code || helper.vehicle?.model_code || '', // Fixed: use vehicle_model_code
          'trim': helper.vehicle?.trim,
          'year': helper.vehicle?.year,
          'engine_volume': helper.vehicle?.engine_volume,
          'engine_code': helper.vehicle?.engine_model, // Fixed: use engine_model instead of model_code
          'engine_type': helper.vehicle?.fuel_type, // Fixed: use fuel_type instead of engine_model
          'vin': helper.vehicle?.chassis,
          'oem': helper.vehicle?.oem || ''
        };
        
        // Apply the mappings
        Object.entries(fieldMappings).forEach(([fieldId, value]) => {
          const element = document.getElementById(fieldId);
          if (element && value) {
            element.value = value;
            console.log(`  âœ… ${fieldId}: "${value}"`);
          }
        });
        
        console.log('âœ… Parts search auto-population completed');
      } else {
        console.log('âš ï¸ No helper data found in sessionStorage');
      }
    } catch (error) {
      console.error('âŒ Error auto-populating vehicle data:', error);
    }
  }
  
  // Auto-populate on page load
  populateVehicleDataFromHelper();
  
  // Listen for helper updates
  window.addEventListener('storage', (e) => {
    if (e.key === 'helper') {
      console.log('ğŸ”„ Helper data updated, re-populating parts search...');
      populateVehicleDataFromHelper();
    }
  });

  const groupSelect = document.getElementById('part_group');
  const nameSelect = document.getElementById('part_name');

  if (!window.PARTS_BANK) {
    alert("×—×¡×¨ ×§×•×‘×¥ ×—×œ×§×™× ××• ×©×”×˜×¢×™× ×” × ×›×©×œ×”");
    return;
  }

  for (const group in window.PARTS_BANK) {
    const option = document.createElement('option');
    option.value = group;
    option.textContent = group;
    groupSelect.appendChild(option);
  }

  groupSelect.addEventListener('change', () => {
    nameSelect.innerHTML = '<option value="" disabled selected hidden>×‘×—×¨ ×—×œ×§</option>';
    const selectedCategory = groupSelect.value;
    const parts = window.PARTS_BANK[selectedCategory] || [];
    
    console.log(`ğŸ” Loading ${parts.length} parts for category: ${selectedCategory}`);
    
    parts.forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      opt.setAttribute('data-category', selectedCategory);
      nameSelect.appendChild(opt);
    });
    
    // ğŸ¯ CREATIVE: Visual feedback for category loading
    showNotification(`× ×˜×¢× ×• ${parts.length} ×—×œ×§×™× ×¢×‘×•×¨ ${selectedCategory}`, 'info');
    autoSaveSearchProgress();
  });
  
  // ğŸ¯ CREATIVE ENHANCEMENTS: Smart features for parts search
  
  // Smart notification system
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    const colors = {
      success: '#10b981',
      info: '#3b82f6', 
      warning: '#f59e0b',
      error: '#ef4444'
    };
    
    notification.style.cssText = `
      position: fixed; top: 20px; right: 20px; z-index: 9999;
      background: ${colors[type]}; color: white; padding: 12px 16px;
      border-radius: 8px; font-size: 14px; font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateX(100%); transition: transform 0.3s ease;
      max-width: 300px; direction: rtl;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    setTimeout(() => notification.style.transform = 'translateX(0)', 100);
    setTimeout(() => {
      notification.style.transform = 'translateX(100%)';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }
  
  // Auto-save search progress
  function autoSaveSearchProgress() {
    const searchData = {
      vehicle: {
        plate: document.getElementById('plate').value,
        manufacturer: document.getElementById('manufacturer').value,
        model: document.getElementById('model').value,
        year: document.getElementById('year').value,
        engine_volume: document.getElementById('engine_volume').value
      },
      parts: {
        group: document.getElementById('part_group').value,
        name: document.getElementById('part_name').value,
        source: document.getElementById('part_source').value,
        quantity: document.getElementById('part_quantity').value
      },
      timestamp: new Date().toISOString()
    };
    
    sessionStorage.setItem('partsSearchProgress', JSON.stringify(searchData));
    console.log('ğŸ’¾ Auto-saved search progress');
  }
  
  // ğŸ¯ SMART FORM BUILDER for external sites - ENHANCED to capture ALL parts
  window.generateExternalForm = function() {
    const vehicle = {
      manufacturer: document.getElementById('manufacturer').value,
      model: document.getElementById('model').value,
      year: document.getElementById('year').value,
      engine_volume: document.getElementById('engine_volume').value
    };
    
    // âœ… FIXED: Capture ALL parts from selectedParts array, not just current dropdown
    let partsToExport = [];
    
    // Add all parts from the selected parts list
    if (selectedParts && selectedParts.length > 0) {
      partsToExport = [...selectedParts];
    }
    
    // Also add current form part if it's filled out and not already in the list
    const currentPart = {
      group: document.getElementById('part_group').value,
      name: document.getElementById('part_name').value,
      source: document.getElementById('part_source').value,
      quantity: document.getElementById('part_quantity').value || 1
    };
    
    if (currentPart.group && currentPart.name) {
      // Check if this part is not already in the list
      const isDuplicate = partsToExport.some(p => 
        p.group === currentPart.group && 
        p.name === currentPart.name && 
        p.source === currentPart.source
      );
      
      if (!isDuplicate) {
        partsToExport.push(currentPart);
      }
    }
    
    if (!vehicle.manufacturer || !vehicle.model) {
      showNotification('×× × ××œ× ××ª ×¤×¨×˜×™ ×”×¨×›×‘', 'warning');
      return;
    }
    
    if (partsToExport.length === 0) {
      showNotification('×× × ×”×•×¡×£ ×œ×¤×—×•×ª ×—×œ×§ ××—×“ ×œ×¨×©×™××”', 'warning');
      return;
    }
    
    showExternalFormModal(vehicle, partsToExport);
  };
  
  function showExternalFormModal(vehicle, parts) {
    // âœ… ENHANCED: Handle multiple parts in smart form
    const partsArray = Array.isArray(parts) ? parts : [parts];
    const totalParts = partsArray.length;
    
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); display: flex; align-items: center;
      justify-content: center; z-index: 10000; direction: rtl;
    `;
    
    // Generate parts list HTML
    const partsListHTML = partsArray.map((part, index) => `
      <div style="background: #ecfdf5; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #10b981;">
        <strong>×—×œ×§ ${index + 1}:</strong><br>
        ×§×˜×’×•×¨×™×”: <strong>${part.group}</strong><br>
        ${part.name ? `×©× ×”×—×œ×§: <strong>${part.name}</strong><br>` : ''}
        ${part.source ? `××§×•×¨: <strong>${part.source}</strong><br>` : ''}
        ×›××•×ª: <strong>${part.quantity || part.qty || 1}</strong>
        ${part.price ? `<br>××—×™×¨ ××©×•×¢×¨: <strong>${part.price}</strong>` : ''}
        ${part.supplier ? `<br>×¡×¤×§: <strong>${part.supplier}</strong>` : ''}
      </div>
    `).join('');
    
    modal.innerHTML = `
      <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
        <h3 style="color: #1e3a8a; margin-bottom: 20px; text-align: center;">ğŸ” ×˜×•×¤×¡ ×—×›× ×œ××ª×¨ ×—×œ×¤×™× ×—×™×¦×•× ×™</h3>
        
        <div style="background: #f0f9ff; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
          <strong>×¤×¨×˜×™ ×”×¨×›×‘:</strong><br>
          ×™×¦×¨×Ÿ: <strong>${vehicle.manufacturer}</strong><br>
          ×“×’×: <strong>${vehicle.model}</strong><br>
          ×©× ×”: <strong>${vehicle.year}</strong><br>
          × ×¤×— ×× ×•×¢: <strong>${vehicle.engine_volume}</strong>
        </div>
        
        <div style="margin-bottom: 20px;">
          <strong style="color: #10b981;">×—×œ×§×™× ××‘×•×§×©×™× (${totalParts}):</strong><br>
          ${partsListHTML}
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
          <button onclick="copyFormData('${JSON.stringify({vehicle, parts: partsArray}).replace(/"/g, '&quot;')}')" 
                  style="background: #3b82f6; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
            ğŸ“‹ ×”×¢×ª×§ × ×ª×•× ×™×
          </button>
          <button onclick="openSearchSite(); this.closest('[style*=fixed]').remove();" 
                  style="background: #10b981; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
            ğŸŒ ×¤×ª×— Car-Part
          </button>
          <button onclick="this.closest('[style*=fixed]').remove()" 
                  style="background: #6b7280; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer;">
            âœ• ×¡×’×•×¨
          </button>
        </div>
      </div>
    `;
    
    modal.onclick = (e) => e.target === modal && modal.remove();
    document.body.appendChild(modal);
  }
  
  window.copyFormData = function(dataStr) {
    const data = JSON.parse(dataStr.replace(/&quot;/g, '"'));
    
    // âœ… ENHANCED: Handle multiple parts in copy function
    let text = `×¤×¨×˜×™ ×¨×›×‘:
×™×¦×¨×Ÿ: ${data.vehicle.manufacturer}
×“×’×: ${data.vehicle.model}
×©× ×”: ${data.vehicle.year}
× ×¤×— ×× ×•×¢: ${data.vehicle.engine_volume}

×—×œ×§×™× ××‘×•×§×©×™× (${data.parts ? data.parts.length : 1}):
`;
    
    if (data.parts && Array.isArray(data.parts)) {
      // Multiple parts
      data.parts.forEach((part, index) => {
        text += `${index + 1}. ${part.group} - ${part.name || ''}
   ××§×•×¨: ${part.source || ''}
   ×›××•×ª: ${part.quantity || part.qty || 1}
${part.price ? `   ××—×™×¨ ××©×•×¢×¨: ${part.price}` : ''}
${part.supplier ? `   ×¡×¤×§: ${part.supplier}` : ''}

`;
      });
    } else if (data.part) {
      // Single part (legacy support)
      text += `1. ${data.part.group} - ${data.part.name || ''}
   ××§×•×¨: ${data.part.source || ''}
   ×›××•×ª: ${data.part.quantity}`;
    }
    
    navigator.clipboard.writeText(text).then(() => {
      showNotification('× ×ª×•× ×™× ×”×•×¢×ª×§×• ×‘×”×¦×œ×—×”!', 'success');
    }).catch(() => {
      showNotification('×©×’×™××” ×‘×”×¢×ª×§×”', 'error');
    });
  };
  
  // Auto-save on form changes
  document.querySelectorAll('input, select').forEach(element => {
    element.addEventListener('change', autoSaveSearchProgress);
  });
  
  });

  let imageBase64 = null;
  document.getElementById('part_image').addEventListener('change', function () {
    const file = this.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function (e) {
      imageBase64 = e.target.result;
      const img = document.getElementById('previewImage');
      img.src = imageBase64;
      img.style.display = 'block';
    };
    reader.readAsDataURL(file);
  });
</script>
<script>
  const selectedParts = [];
  const listUI = document.getElementById('selected_parts_list');

  function addFullPart() {
    const group = document.getElementById('part_group').value;
    const name = document.getElementById('part_name').value;
    const qty = document.getElementById('part_quantity').value || '1';
    const source = document.getElementById('part_source').value || '××§×•×¨×™';

    if (!group || !name) {
      alert("×™×© ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ×§×‘×•×¦×ª ×—×œ×§×™× ×•×©× ×—×œ×§");
      return;
    }

    // Check for duplicates
    const isDuplicate = selectedParts.some(existing => 
      existing.group === group && 
      existing.name === name && 
      existing.source === source
    );
    
    if (isDuplicate) {
      alert("×—×œ×§ ×–×” ×›×‘×¨ ×§×™×™× ×‘×¨×©×™××”");
      return;
    }

    const item = { 
      group, 
      name, 
      qty: parseInt(qty), 
      source,
      id: `part_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      added_at: new Date().toISOString()
    };
    
    selectedParts.push(item);

    // âœ… FIXED: Use the proper updateSelectedPartsList function instead of manual DOM manipulation
    updateSelectedPartsList();

    // Clear form for next entry
    document.getElementById('part_name').value = '';
    document.getElementById('part_quantity').value = '1';
    document.getElementById('part_source').value = '';
    
    // Visual feedback
    console.log(`âœ… Added part: ${group} - ${name} (${qty}x ${source})`);
    
    // Show notification if available
    if (typeof showNotification === 'function') {
      showNotification(`× ×•×¡×£ ×—×œ×§: ${name}`, 'success');
    }
  }
  
  // âœ… NEW: Send current parts list to Make.com for processing
  
  // âœ… NEW: Supabase Search Function for PiP Integration
  async function searchSupabase() {
    console.log('ğŸ” Starting Supabase search...');
    
    // Get button reference outside try block
    const supabaseBtn = document.querySelector('button[onclick="searchSupabase()"]');
    const originalText = supabaseBtn ? supabaseBtn.innerHTML : '';
    
    try {
      // Show loading state
      if (supabaseBtn) {
        supabaseBtn.innerHTML = 'â³ ××—×¤×© ×‘-Supabase...';
        supabaseBtn.disabled = true;
      }
      
      // Get form data
      const searchParams = {
        plate: document.getElementById('plate').value,
        manufacturer: document.getElementById('manufacturer').value,
        model: document.getElementById('model').value,
        model_code: document.getElementById('model_code').value,
        trim: document.getElementById('trim').value,
        year: document.getElementById('year').value,
        engine_volume: document.getElementById('engine_volume').value,
        engine_code: document.getElementById('engine_code').value,
        engine_type: document.getElementById('engine_type').value,
        vin: document.getElementById('vin').value,
        oem: document.getElementById('oem').value,
        part_group: document.getElementById('part_group').value,
        part_name: document.getElementById('part_name').value,
        free_query: document.getElementById('free_query').value,
        selectedParts: selectedParts
      };
      
      // Use new simplified search service
      console.log('ğŸ“¦ Initializing SmartPartsSearchService...');
      const searchService = new window.SmartPartsSearchService();
      console.log('âœ… SmartPartsSearchService initialized');
      
      // Show loading notification
      if (typeof showNotification === 'function') {
        showNotification('××—×¤×© ×‘×§×˜×œ×•×’...', 'info');
      }
      console.log('ğŸ”„ About to call smart search...');
      
      // Perform search with new service
      const result = await searchService.searchParts(searchParams);
      
      console.log('ğŸ” Search result:', result);
      
      // Always show PiP window regardless of results
      console.log('ğŸªŸ Checking PiP component:', window.partsResultsPiP);
      if (window.partsResultsPiP) {
        const resultsToShow = result.data || [];
        const searchSuccess = !result.error && resultsToShow.length >= 0;
        console.log(`ğŸ“‹ Showing PiP with ${resultsToShow.length} results...`);
        
        await window.partsResultsPiP.showResults(resultsToShow, {
          plate: searchParams.plate,
          sessionId: searchService.getSessionId() || 'no-session',
          searchType: 'smart_search',
          searchSuccess: searchSuccess,
          errorMessage: result.error ? result.error.message : null,
          searchTime: result.searchTime || 0
        });
        console.log('âœ… PiP showResults completed');
      } else {
        console.error('âŒ PiP component not available');
        alert('×©×’×™××”: ×¨×›×™×‘ ×”×ª×•×¦××•×ª ×œ× ×–××™×Ÿ - window.partsResultsPiP = ' + typeof window.partsResultsPiP);
      }
      
      if (!result.error && result.data && result.data.length > 0) {
        console.log('âœ… Smart search successful:', result.data.length, 'results');
        
        if (typeof showNotification === 'function') {
          showNotification(`× ××¦××• ${result.data.length} ×ª×•×¦××•×ª`, 'success');
        }
      } else {
        console.log('âš ï¸ No results found in Supabase. Result details:', result);
        alert('âš ï¸ No results found - check console for details');
        if (typeof showNotification === 'function') {
          showNotification('×œ× × ××¦××• ×ª×•×¦××•×ª', 'warning');
        }
        
        // Optionally fallback to Make.com search
        if (result.fallbackToMakecom) {
          if (confirm('×œ× × ××¦××• ×ª×•×¦××•×ª ×‘×§×˜×œ×•×’. ×”×× ×œ×—×¤×© ×‘××¢×¨×›×ª ×”×—×™×¦×•× ×™×ª?')) {
            document.getElementById('partSearchForm').dispatchEvent(new Event('submit'));
          }
        }
      }
      
    } catch (error) {
      console.error('âŒ Supabase search error:', error);
      if (typeof showNotification === 'function') {
        showNotification('×©×’×™××” ×‘×—×™×¤×•×©: ' + error.message, 'error');
      }
      
      // Fallback to Make.com on error
      if (confirm('×©×’×™××” ×‘×—×™×¤×•×© ×‘×§×˜×œ×•×’. ×”×× ×œ× ×¡×•×ª ×‘××¢×¨×›×ª ×”×—×™×¦×•× ×™×ª?')) {
        document.getElementById('partSearchForm').dispatchEvent(new Event('submit'));
      }
    } finally {
      // Restore button state
      if (supabaseBtn) {
        supabaseBtn.innerHTML = originalText;
        supabaseBtn.disabled = false;
      }
    }
  }

  // âœ… FIX 1: Implement missing exportSelectedParts function
  function exportSelectedParts() {
    console.log('ğŸ“„ Exporting selected parts to Excel...');
    
    if (selectedParts.length === 0) {
      alert('××™×Ÿ ×—×œ×§×™× × ×‘×—×¨×™× ×œ×™×™×¦×•×');
      return;
    }
    
    // Prepare export payload
    const exportData = {
      parts: selectedParts,
      vehicle_context: {
        plate: document.getElementById('plate').value,
        manufacturer: document.getElementById('manufacturer').value,
        model: document.getElementById('model').value,
        year: document.getElementById('year').value,
        trim: document.getElementById('trim').value,
        engine_volume: document.getElementById('engine_volume').value
      },
      export_timestamp: new Date().toISOString(),
      export_type: 'selected_parts_list'
    };
    
    // Send to ADMIN_EXPORT_SEARCH_RESULTS webhook
    fetch('https://hook.eu2.make.com/rocp5ue661qn3597akgptja4ol9cnksy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        task: 'export_parts_list',
        payload: exportData
      })
    })
    .then(response => {
      if (!response.ok) throw new Error('Export failed');
      return response.json();
    })
    .then(result => {
      console.log('âœ… Parts exported successfully:', result);
      alert(`âœ… ×™×™×¦×•× ×”×•×©×œ× ×‘×”×¦×œ×—×”!\n${selectedParts.length} ×—×œ×§×™× ×™×•×¦××• ×œ×§×•×‘×¥ Excel`);
      
      // If download URL is provided, trigger download
      if (result.download_url) {
        const a = document.createElement('a');
        a.href = result.download_url;
        a.download = `parts_export_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    })
    .catch(error => {
      console.error('âŒ Export error:', error);
      alert('×©×’×™××” ×‘×™×™×¦×•× ×”×§×•×‘×¥');
    });
  }
  
  // âœ… FIX 2: Enhanced helper integration with 3-category system
  function updateHelperWithPartsSearch(searchResults, searchContext) {
    try {
      let helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Initialize enhanced parts_search structure
      if (!helper.parts_search) {
        helper.parts_search = {
          selected_parts: [],
          unselected_parts: [],
          global_parts_bank: { all_parts: [] },
          current_session: { results: [] },
          case_search_history: [],
          case_summary: {
            total_searches: 0,
            total_results: 0,
            selected_count: 0,
            unselected_count: 0,
            last_search: '',
            estimated_total_cost: 0
          }
        };
      }
      
      // Add search results to all categories
      if (searchResults && searchResults.length > 0) {
        // Mark as unselected initially
        const markedResults = searchResults.map(part => ({
          ...part,
          id: `part_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          selected: false,
          search_timestamp: new Date().toISOString(),
          search_context: searchContext
        }));
        
        // Add to unselected_parts and global bank
        helper.parts_search.unselected_parts.push(...markedResults);
        helper.parts_search.global_parts_bank.all_parts.push(...markedResults);
        helper.parts_search.current_session.results = markedResults;
        
        // Update summary
        helper.parts_search.case_summary = {
          ...helper.parts_search.case_summary,
          total_results: helper.parts_search.global_parts_bank.all_parts.length,
          unselected_count: helper.parts_search.unselected_parts.length,
          last_search: new Date().toISOString()
        };
      }
      
      // Save updated helper
      sessionStorage.setItem('helper', JSON.stringify(helper));
      localStorage.setItem('helper_data', JSON.stringify(helper));
      
      console.log('âœ… Helper updated with enhanced parts search structure');
      
      return helper;
    } catch (error) {
      console.error('âŒ Error updating helper:', error);
      return null;
    }
  }
  
  // âœ… FIX 3: Enhanced validation rules according to architecture
  function validateSearchForm() {
    const selectedPartsCount = selectedParts ? selectedParts.length : 0;
    const freeQuery = document.getElementById('free_query').value.trim();
    const hasImage = imageBase64 !== null;
    const hasVehicleData = document.getElementById('manufacturer').value.trim() !== '';
    const hasPartGroup = document.getElementById('part_group').value.trim() !== '';
    const hasPartName = document.getElementById('part_name').value.trim() !== '';
    
    console.log('ğŸ” Validation check:', {
      selectedPartsCount,
      freeQuery,
      hasImage,
      hasVehicleData,
      hasPartGroup,
      hasPartName
    });
    
    // Rule 1: External site search - requires parts list
    // (This is handled in the external site functions)
    
    // Rule 2: System/Image search - requires one of: free search field, parts list, part selection, OR image
    const hasSearchCriteria = freeQuery || selectedPartsCount > 0 || hasImage || (hasPartGroup && hasPartName);
    
    if (!hasSearchCriteria) {
      alert('×™×© ×œ××œ× ×œ×¤×—×•×ª ××—×“ ××”×©×“×•×ª ×”×‘××™×:\nâ€¢ ×—×™×¤×•×© ×—×•×¤×©×™\nâ€¢ ×‘×—×™×¨×ª ×—×œ×§ ××”×¨×©×™××”\nâ€¢ ×¨×©×™××ª ×—×œ×§×™× ×©× ×•×¡×¤×”\nâ€¢ ×ª××•× ×” ×œ×—×™×¤×•×©');
      return false;
    }
    
    // Rule 3: Car details not mandatory but recommended
    if (!hasVehicleData) {
      const confirmSearch = confirm('×œ× ×”×•×–× ×• ×¤×¨×˜×™ ×¨×›×‘. ×”×× ×œ×”××©×™×š ×‘×—×™×¤×•×© ×›×œ×œ×™?');
      if (!confirmSearch) return false;
    }
    
    console.log('âœ… Validation passed');
    return true;
  }
  
  // âœ… NEW: Comprehensive search function with Supabase + Make.com fallback
  async function searchWithSupabaseFallback(payload) {
    console.log('ğŸ” Starting comprehensive search with Supabase + Make.com fallback');
    
    try {
      // Step 1: Try Supabase search first
      console.log('1ï¸âƒ£ Attempting Supabase search...');
      const smartService = new window.SmartPartsSearchService();
      const supabaseResults = await smartService.searchParts(payload);
      
      if (!supabaseResults.error && supabaseResults.data && supabaseResults.data.length > 0) {
        console.log(`âœ… Smart search successful: ${supabaseResults.data.length} results`);
        
        // Convert Supabase results to Make.com compatible format
        const convertedResults = {
          success: true,
          results: [{
            group: '×ª×•×¦××•×ª ×§×˜×œ×•×’ Supabase',
            name: '×—×™×¤×•×© ×‘×××’×¨',
            search_results: supabaseResults.data.map(item => ({
              id: item.id,
              ×ª×™××•×¨: item.cat_num_desc || '×œ×œ× ×ª×™××•×¨',
              ××—×™×¨: item.price ? `â‚ª${item.price}` : '×œ× ×¦×•×™×Ÿ',
              ×¡×¤×§: item.supplier_name || '×œ× ×¦×•×™×Ÿ',
              ××™×§×•×: item.location || '×œ× ×¦×•×™×Ÿ',
              ×–××™× ×•×ª: item.availability || '×œ× ×¦×•×™×Ÿ',
              '××¡×¤×¨ OEM': item.oem || '',
              '×¡×•×’ ×—×œ×§': item.source || '×œ× ×¦×•×™×Ÿ',
              ×”×¢×¨×•×ª: item.comments || '',
              // Keep original data for selection
              _original: item
            }))
          }],
          plate: payload.plate,
          date: new Date().toISOString(),
          source: 'supabase_catalog'
        };
        
        return convertedResults;
      } else {
        console.log('â„¹ï¸ Supabase search returned no results, trying Make.com fallback...');
      }
      
    } catch (error) {
      console.error('âŒ Supabase search error:', error);
      console.log('ğŸ”„ Falling back to Make.com webhook...');
    }
    
    // Step 2: Fallback to Make.com webhook
    console.log('2ï¸âƒ£ Using Make.com webhook fallback...');
    try {
      const makecomResults = await sendPartSearch(payload);
      
      if (makecomResults) {
        console.log('âœ… Make.com webhook returned results');
        return {
          ...makecomResults,
          source: 'makecom_webhook',
          fallback_used: true
        };
      }
      
    } catch (webhookError) {
      console.error('âŒ Make.com webhook also failed:', webhookError);
    }
    
    // Step 3: Return empty results if all methods fail
    console.log('âš ï¸ All search methods failed, returning empty results');
    return {
      success: false,
      results: [],
      error: '×›×œ ×©×™×˜×•×ª ×”×—×™×¤×•×© × ×›×©×œ×•. ×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.',
      no_results: true
    };
  }
  
  
  // Make functions globally available
  window.exportSelectedParts = exportSelectedParts;
  window.updateHelperWithPartsSearch = updateHelperWithPartsSearch;
  window.validateSearchForm = validateSearchForm;
  window.searchSupabase = searchSupabase;
  
</script>

<script>
  document.getElementById('partSearchForm').addEventListener('submit', e => {
    e.preventDefault();
    
    // âœ… FIX 4: Apply validation rules before submitting
    if (!validateSearchForm()) {
      return;
    }
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = '××—×¤×©...';
    submitBtn.disabled = true;
    
    // Enhanced payload includes selected parts list if available
    const payload = {
      plate: plate.value.trim(),
      manufacturer: manufacturer.value.trim(),
      model: model.value.trim(),
      model_code: model_code.value.trim(),
      trim: trim.value.trim(),
      year: year.value.trim(),
      engine_volume: engine_volume.value.trim(),
      engine_code: engine_code.value.trim(),
      engine_type: engine_type.value.trim(),
      vin: vin.value.trim(),
      oem: oem.value.trim(),
      part_group: part_group.value,
      part_name: part_name.value,
      free_query: free_query.value.trim(),
      part_image_base64: imageBase64 || null,
      selectedParts: selectedParts || [],
      // Include parts list in search if available
      search_type: (selectedParts && selectedParts.length > 0) ? 'enhanced_with_parts_list' : 'standard',
      parts_list: selectedParts || []
    };
    
    // âœ… ENHANCED: Try Supabase search first, fallback to Make.com webhook
    searchWithSupabaseFallback(payload).then(results => {
      console.log('ğŸ“¥ Parts search response received:', results);
      
      // Fix: Handle actual webhook structure {plate, date, results}
      if (results && results.results && results.results.length > 0) {
        // âœ… ENHANCED: Display comprehensive search results from Make.com
        displayComprehensiveSearchResults(results.results);
        
        const totalParts = results.results.reduce((sum, group) => {
          return sum + (group.search_results ? group.search_results.length : 0);
        }, 0);
        
        const sourceMsg = results.source === 'supabase_catalog' ? '(××§×˜×œ×•×’ Supabase)' : 
                         results.fallback_used ? '(×“×¨×š Make.com)' : '';
        alert(`âœ… × ××¦××• ${results.results.length} ×§×‘×•×¦×•×ª ×—×œ×§×™× ×¢× ×¡×”"×› ${totalParts} ××¤×©×¨×•×™×•×ª! ${sourceMsg}`);
        
        // Forward webhook results to damage centers wizard
        if (window.parent !== window && window.parent.postMessage) {
          window.parent.postMessage({
            type: 'partsSearchResults',
            results: results.results,
            plate: results.plate,
            date: results.date,
            source: 'parts_search_webhook'
          }, '*');
          console.log('ğŸ“¤ Forwarded webhook results to damage centers wizard');
        }
        
        // âœ… FIXED: Use enhanced helper integration with search results
        try {
          const searchContext = {
            query: payload,
            timestamp: new Date().toISOString(),
            results_count: results.results.length,
            total_parts: totalParts,
            search_type: 'system_search_enhanced',
            plate: results.plate,
            webhook_date: results.date
          };
          
          // Use enhanced helper integration
          const updatedHelper = updateHelperWithPartsSearch(results.results, searchContext);
          
          if (updatedHelper) {
            console.log(`âœ… Enhanced: Saved ${results.results.length} search result groups to helper`);
            
            // Trigger helper update broadcast if available
            if (typeof window.broadcastHelperUpdate === 'function') {
              window.broadcastHelperUpdate(['parts_search'], 'parts_search_module');
            }
          }
        } catch (e) {
          console.error('âŒ Error saving search results with enhanced system:', e);
        }
      } else if (results && results.success && results.message === 'Accepted') {
        // Handle "Accepted" responses (processing started)
        alert('âœ… ×”×—×™×¤×•×© ×”×ª×§×‘×œ ×œ×¢×™×‘×•×“! ×”×ª×•×¦××•×ª ×™×’×™×¢×• ×‘×§×¨×•×‘...');
        console.log('â³ Search accepted for processing');
      } else if (results && results.success && results.no_results) {
        // Handle processing responses - check for embedded JSON
        if (results.message && results.message.includes('"plate"') && results.message.includes('"results"')) {
          try {
            console.log('ğŸ”„ Parsing embedded JSON from response message...');
            const jsonMatch = results.message.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
              const parsedData = JSON.parse(jsonMatch[0]);
              console.log('âœ… Found embedded JSON data:', parsedData);
              
              if (parsedData.results && parsedData.results.length > 0) {
                // Process the actual results
                displayComprehensiveSearchResults(parsedData.results);
                const totalParts = parsedData.results.reduce((sum, group) => {
                  return sum + (group.search_results ? group.search_results.length : 0);
                }, 0);
                alert(`âœ… × ××¦××• ${parsedData.results.length} ×§×‘×•×¦×•×ª ×—×œ×§×™× ×¢× ×¡×”"×› ${totalParts} ××¤×©×¨×•×™×•×ª!`);
                
                // Forward webhook results to damage centers wizard
                if (window.parent !== window && window.parent.postMessage) {
                  window.parent.postMessage({
                    type: 'partsSearchResults',
                    results: parsedData.results,
                    plate: parsedData.plate,
                    date: parsedData.search_date || parsedData.date,
                    source: 'parts_search_webhook'
                  }, '*');
                  console.log('ğŸ“¤ Forwarded webhook results to damage centers wizard');
                }
              } else {
                alert('ğŸ” ×”×—×™×¤×•×© ×”×•×©×œ× ××š ×œ× × ××¦××• ×ª×•×¦××•×ª ××ª××™××•×ª');
                console.log('â„¹ï¸ Search completed with no results');
              }
            }
          } catch (parseError) {
            console.error('âŒ Error parsing embedded JSON:', parseError);
            alert('ğŸ” ×”×—×™×¤×•×© ×”×•×©×œ× ××š ×œ× × ××¦××• ×ª×•×¦××•×ª ××ª××™××•×ª');
          }
        } else {
          alert('ğŸ” ×”×—×™×¤×•×© ×”×•×©×œ× ××š ×œ× × ××¦××• ×ª×•×¦××•×ª ××ª××™××•×ª');
          console.log('â„¹ï¸ Search completed with no results');
        }
      } else if (results && results.plate && results.results && results.results.length === 0) {
        alert('ğŸ” ×”×—×™×¤×•×© ×”×•×©×œ× ××š ×œ× × ××¦××• ×ª×•×¦××•×ª ××ª××™××•×ª');
        console.log('â„¹ï¸ Search completed with no results for plate:', results.plate);
      } else if (results && results.error) {
        alert(`âŒ ×©×’×™××” ×‘×—×™×¤×•×©: ${results.error}`);
        console.error('âŒ Search failed:', results.error);
      } else {
        console.warn('âš ï¸ Unexpected response format:', results);
        alert('âš ï¸ ×”×ª×§×‘×œ×” ×ª×’×•×‘×” ×‘×¤×•×¨××˜ ×œ× ×¦×¤×•×™ ××”×©×¨×ª');
      }
    }).catch(error => {
      console.error('Search error:', error);
      alert('×©×’×™××” ×‘×—×™×¤×•×© ×—×œ×§×™×');
    }).finally(() => {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    });
  });
</script>
<script>
document.getElementById('sendResultToOCRBtn').addEventListener('click', function () {
  const fileInput = document.getElementById('resultFileUpload');
  const file = fileInput.files[0];
  if (!file) {
    alert('×× × ×”×¢×œ×” ×§×•×‘×¥ ×—×™×¤×•×© ×œ×¤× ×™ ×”×©×œ×™×—×”');
    return;
  }

  // Show processing indicator
  const btn = document.getElementById('sendResultToOCRBtn');
  const originalText = btn.textContent;
  btn.textContent = '××¢×‘×“...';
  btn.disabled = true;

  sendSearchResultFile(file, {
    plate: sessionStorage.getItem('plate') || '',
    model: sessionStorage.getItem('model') || ''
  }).then(results => {
    if (results && results.parts && results.parts.length > 0) {
      displaySearchResults(results.parts);
      alert(`âœ… × ××¦××• ${results.parts.length} ×—×œ×§×™× ×‘×§×•×‘×¥`);
    } else {
      alert('×œ× × ××¦××• ×—×œ×§×™× ×‘×§×•×‘×¥ ××• ×©×’×™××” ×‘×¢×™×‘×•×“');
    }
  }).catch(error => {
    console.error('OCR processing error:', error);
    alert('×©×’×™××” ×‘×¢×™×‘×•×“ ×”×§×•×‘×¥');
  }).finally(() => {
    btn.textContent = originalText;
    btn.disabled = false;
  });
  
  // âœ… FIXED: Initialize selected parts list and load saved parts from helper
  loadSavedPartsFromHelper();
  if (typeof updateSelectedPartsList === 'function') {
    updateSelectedPartsList();
  }
});

</script>
<script type="module">
  import { sendPartSearch, sendSearchResultFile } from './webhook.js';
  
  // âœ… NEW: Listen for messages from damage centers wizard
  window.addEventListener('message', function(event) {
    console.log('ğŸ“¨ Parts search received message:', event.data);
    
    switch(event.data.type) {
      case 'damageCenterContext':
        handleWizardContext(event.data);
        break;
      case 'wizardReady':
        console.log('âœ… Wizard is ready, parts search module loaded');
        // Send ready confirmation back
        if (window.parent && window.parent.postMessage) {
          window.parent.postMessage({
            type: 'moduleReady',
            module: 'partsSearch',
            source: 'parts_search_iframe'
          }, '*');
        }
        break;
    }
  });
  
  // âœ… NEW: Handle wizard context data
  function handleWizardContext(contextData) {
    console.log('ğŸ¯ Handling wizard context:', contextData);
    
    try {
      // Pre-fill vehicle data if available
      if (contextData.vehicleData) {
        const vehicle = contextData.vehicleData;
        
        if (vehicle.plate) document.getElementById('plate').value = vehicle.plate;
        if (vehicle.manufacturer) document.getElementById('manufacturer').value = vehicle.manufacturer;
        if (vehicle.model) document.getElementById('model').value = vehicle.model;
        if (vehicle.year) document.getElementById('year').value = vehicle.year;
        if (vehicle.engine_volume) document.getElementById('engine_volume').value = vehicle.engine_volume;
        if (vehicle.chassis) document.getElementById('vin').value = vehicle.chassis;
        
        console.log('âœ… Pre-filled vehicle data from wizard context');
      }
      
      // Show wizard-specific UI hints
      showWizardModeUI(contextData);
      
    } catch (error) {
      console.error('âŒ Failed to handle wizard context:', error);
    }
  }
  
  // âœ… NEW: Show wizard-specific UI
  function showWizardModeUI(contextData) {
    // Add wizard indication to page
    const container = document.querySelector('.container');
    if (container) {
      const wizardIndicator = document.createElement('div');
      wizardIndicator.style.cssText = `
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px;
        text-align: center; font-weight: bold;
      `;
      wizardIndicator.innerHTML = `ğŸ§­ ××•×“×•×œ ×—×™×¤×•×© ×—×œ×¤×™× - ××©×£ ××•×§×“×™ × ×–×§ (××•×§×“ ${contextData.damageCenterId || '×—×“×©'})`;
      
      container.insertBefore(wizardIndicator, container.firstChild);
    }
  }
  import { dev_credentials } from './credentials-vault.js';
  // import { partsSearchService } from './services/partsSearchService.js';
  // Using new SmartPartsSearchService loaded via script tag

  window.sendPartSearch = sendPartSearch;
  window.sendSearchResultFile = sendSearchResultFile;
  window.dev_credentials = dev_credentials;

  // Enhanced search site opening with better UX
  window.openSearchSite = function () {
    const vehicleData = {
      manufacturer: document.getElementById('manufacturer').value,
      model: document.getElementById('model').value,
      year: document.getElementById('year').value
    };
    
    console.log('ğŸŒ Opening Car-Part in internal browser with vehicle data:', vehicleData);
    
    // âœ… FIXED: Enhanced check and fallback for internal browser
    if (typeof window.openInternalBrowser === 'function') {
      try {
        console.log('âœ… Internal browser available, opening car-part.co.il');
        window.openInternalBrowser('car-part.co.il', '×—×™×¤×•×© ×—×œ×¤×™×');
        
        // Create toggle popup for parts list visibility
        setTimeout(() => {
          createPartsListTogglePopup();
        }, 2000);
        
      } catch (error) {
        console.error('âŒ Failed to open internal browser:', error);
        alert('×©×’×™××” ×‘×¤×ª×™×—×ª ×”×“×¤×“×¤×Ÿ ×”×¤× ×™××™: ' + error.message);
        // Fallback to external window
        window.open('https://www.car-part.co.il/Include/Generic/AccessSystem.jsp', '_blank');
      }
    } else {
      console.error('âŒ Internal browser function not available');
      console.log('Available window functions:', Object.keys(window).filter(k => k.includes('Internal') || k.includes('Browser')));
      alert('×”×“×¤×“×¤×Ÿ ×”×¤× ×™××™ ×œ× ×–××™×Ÿ ×‘××¢×¨×›×ª, ×¤×•×ª×— ×‘×—×œ×•×Ÿ × ×¤×¨×“');
      // Fallback to external window
      window.open('https://www.car-part.co.il/Include/Generic/AccessSystem.jsp', '_blank');
    }

    const creds = dev_credentials?.carPart;
    if (creds) {
      const message = `ğŸ“‹ ×¤×¨×˜×™ ×’×™×©×” ×œ××ª×¨ Car-Part:\n×©× ××©×ª××©: ${creds.username}\n×¡×™×¡××”: ${creds.password}\n\nğŸš— ×¤×¨×˜×™ ×”×¨×›×‘ ×œ×—×™×¤×•×©:\n${vehicleData.manufacturer} ${vehicleData.model} ${vehicleData.year}`;
      
      // Copy credentials to clipboard if possible
      if (navigator.clipboard) {
        navigator.clipboard.writeText(`${creds.username}\t${creds.password}`).then(() => {
          alert(message + '\n\nâœ… ×¤×¨×˜×™ ×”×’×™×©×” ×”×•×¢×ª×§×• ×œ×œ×•×—');
        }).catch(() => {
          alert(message);
        });
      } else {
        alert(message);
      }
    } else {
      alert('âš ï¸ ×œ× × ××¦××• ×¤×¨×˜×™ ×”×ª×—×‘×¨×•×ª');
    }
  };
  
  // âœ… ENHANCED: Comprehensive search results display for Make.com response format
  window.displayComprehensiveSearchResults = function(resultGroups) {
    const container = document.getElementById('search_results_display');
    const content = document.getElementById('search_results_content');
    
    if (!resultGroups || resultGroups.length === 0) {
      container.style.display = 'none';
      return;
    }
    
    // Create comprehensive display for grouped results
    const groupsHTML = resultGroups.map((group, groupIndex) => {
      const searchResults = group.search_results || [];
      const groupName = group.group || '×§×‘×•×¦×ª ×—×œ×§×™×';
      const partName = group.name || '×—×œ×§ ×œ×œ× ×©×';
      
      const resultsHTML = searchResults.map((result, resultIndex) => `
        <div style="
          border: 1px solid #e5e7eb; 
          padding: 15px; 
          margin: 8px 0; 
          border-radius: 8px; 
          background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); 
          cursor: pointer;
          transition: all 0.3s ease;
        " 
        onmouseover="this.style.borderColor='#3b82f6'; this.style.transform='translateY(-2px)'"
        onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'"
        onclick="selectComprehensiveSearchResult(${groupIndex}, ${resultIndex})">
          
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
            <div style="flex: 1;">
              <div style="font-weight: bold; color: #1e40af; font-size: 16px; margin-bottom: 5px;">
                ${result.×ª×™××•×¨ || result.description || partName}
              </div>
              <div style="color: #059669; font-weight: bold; font-size: 18px;">
                ${result.××—×™×¨ || result.price || '××—×™×¨ ×œ× ×¦×•×™×Ÿ'}
              </div>
            </div>
            <div style="text-align: left;">
              <div style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                ${result['×¡×•×’ ×—×œ×§'] || result.type || '×œ× ×¦×•×™×Ÿ'}
              </div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 10px;">
            <div>
              <span style="font-weight: bold; color: #4b5563;">×¡×¤×§:</span>
              <span style="color: #374151;">${result.×¡×¤×§ || result.supplier || '×œ× ×¦×•×™×Ÿ'}</span>
            </div>
            <div>
              <span style="font-weight: bold; color: #4b5563;">××™×§×•×:</span>
              <span style="color: #374151;">${result.××™×§×•× || result.location || '×œ× ×¦×•×™×Ÿ'}</span>
            </div>
            <div>
              <span style="font-weight: bold; color: #4b5563;">×–××™× ×•×ª:</span>
              <span style="color: #059669; font-weight: bold;">${result.×–××™× ×•×ª || result.availability || '×œ× ×¦×•×™×Ÿ'}</span>
            </div>
            ${result['××¡×¤×¨ OEM'] || result.oem_number ? `
            <div>
              <span style="font-weight: bold; color: #4b5563;">OEM:</span>
              <span style="color: #374151; font-family: monospace;">${result['××¡×¤×¨ OEM'] || result.oem_number}</span>
            </div>
            ` : ''}
          </div>
          
          ${result.×”×¢×¨×•×ª || result.notes ? `
          <div style="margin-top: 10px; padding: 8px; background: #fef3c7; border-radius: 4px; border-left: 4px solid #f59e0b;">
            <span style="font-weight: bold; color: #92400e;">×”×¢×¨×•×ª:</span>
            <span style="color: #92400e;">${result.×”×¢×¨×•×ª || result.notes}</span>
          </div>
          ` : ''}
          
          <div style="text-align: center; margin-top: 12px;">
            <small style="color: #3b82f6; font-weight: bold;">ğŸ‘† ×œ×—×¥ ×œ×”×•×¡×¤×” ×œ×¨×©×™××ª ×”×—×œ×§×™×</small>
          </div>
        </div>
      `).join('');
      
      return `
        <div style="margin-bottom: 25px; border: 2px solid #3b82f6; border-radius: 12px; overflow: hidden;">
          <div style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; padding: 15px; text-align: center;">
            <h3 style="margin: 0; font-size: 18px;">${groupName}</h3>
            <div style="font-size: 16px; margin-top: 5px; opacity: 0.9;">${partName}</div>
            <div style="font-size: 14px; margin-top: 5px; opacity: 0.8;">${searchResults.length} ××¤×©×¨×•×™×•×ª × ××¦××•</div>
          </div>
          <div style="padding: 15px;">
            ${resultsHTML}
          </div>
        </div>
      `;
    }).join('');
    
    // Update content with comprehensive results
    content.innerHTML = `
      <div style="margin-bottom: 20px; text-align: center; padding: 15px; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-radius: 10px; border: 1px solid #10b981;">
        <h3 style="color: #047857; margin: 0;">ğŸ” ×ª×•×¦××•×ª ×—×™×¤×•×© ××§×™×¤×•×ª</h3>
        <p style="color: #059669; margin: 5px 0 0 0;">× ××¦××• ${resultGroups.length} ×§×‘×•×¦×•×ª ×—×œ×§×™× ×¢× ××¤×©×¨×•×™×•×ª ×¨×›×™×©×” ××’×•×•× ×•×ª</p>
      </div>
      ${groupsHTML}
    `;
    
    container.style.display = 'block';
    window.currentComprehensiveResults = resultGroups;
  };
  
  // Enhanced result display function (backward compatibility)
  window.displaySearchResults = function(results) {
    // Check if this is the new comprehensive format
    if (results && results.length > 0 && results[0].search_results) {
      return displayComprehensiveSearchResults(results);
    }
    
    // Legacy format handling
    const container = document.getElementById('search_results_display');
    const content = document.getElementById('search_results_content');
    
    if (!results || results.length === 0) {
      container.style.display = 'none';
      return;
    }
    
    content.innerHTML = results.map((result, index) => `
      <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 5px; background: white; cursor: pointer;" 
           onclick="selectSearchResult(${index})">
        <strong>${result.name || result.description || '×—×œ×§ ×œ×œ× ×©×'}</strong>
        ${result.description ? `<br><small>${result.description}</small>` : ''}
        ${result.price ? `<br>××—×™×¨: <span style="color: #28a745; font-weight: bold;">â‚ª${result.price}</span>` : ''}
        ${result.source ? `<br>××§×•×¨: ${result.source}` : ''}
        ${result.supplier ? `<br>×¡×¤×§: ${result.supplier}` : ''}
        <br><small style="color: #007bff;">×œ×—×¥ ×œ×”×•×¡×¤×” ×œ×¨×©×™××”</small>
      </div>
    `).join('');
    
    container.style.display = 'block';
    window.currentSearchResults = results;
  };
  
  // âœ… NEW: Select comprehensive search result (for Make.com format)
  window.selectComprehensiveSearchResult = function(groupIndex, resultIndex) {
    const resultGroup = window.currentComprehensiveResults[groupIndex];
    if (!resultGroup || !resultGroup.search_results) return;
    
    const result = resultGroup.search_results[resultIndex];
    if (!result) return;
    
    console.log('ğŸ¯ Selected comprehensive search result:', { groupIndex, resultIndex, result });
    
    // Extract details from Hebrew/English mixed format
    const partName = result.×ª×™××•×¨ || result.description || resultGroup.name || '×—×œ×§ ××ª×•×¦××ª ×—×™×¤×•×©';
    const price = result.××—×™×¨ || result.price || '';
    const supplier = result.×¡×¤×§ || result.supplier || '';
    const partType = result['×¡×•×’ ×—×œ×§'] || result.type || '';
    const oem = result['××¡×¤×¨ OEM'] || result.oem_number || '';
    const location = result.××™×§×•× || result.location || '';
    const availability = result.×–××™× ×•×ª || result.availability || '';
    const notes = result.×”×¢×¨×•×ª || result.notes || '';
    
    // Determine source based on part type
    let source = '×ª×—×œ×™×¤×™';
    if (partType.includes('OEM') || partType.includes('××§×•×¨×™')) {
      source = '××§×•×¨×™';
    } else if (partType.includes('××©×•××©')) {
      source = '××©×•××©';
    }
    
    // Create enhanced part item
    const item = {
      group: resultGroup.group || '×ª×•×¦××ª ×—×™×¤×•×©',
      name: partName,
      qty: 1,
      source: source,
      price: price.replace('â‚ª', '').trim(),
      supplier: supplier,
      id: `search_result_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      added_at: new Date().toISOString(),
      search_metadata: {
        oem_number: oem,
        location: location,
        availability: availability,
        notes: notes,
        part_type: partType,
        from_comprehensive_search: true,
        group_index: groupIndex,
        result_index: resultIndex
      }
    };
    
    // Check for duplicates
    const isDuplicate = selectedParts.some(existing => 
      existing.name === item.name && 
      existing.supplier === item.supplier &&
      existing.source === item.source
    );
    
    if (isDuplicate) {
      alert('âš ï¸ ×—×œ×§ ×–×” ×›×‘×¨ ×§×™×™× ×‘×¨×©×™××”');
      return;
    }
    
    // Add to selected parts
    selectedParts.push(item);
    updateSelectedPartsList();
    
    // Visual feedback
    if (typeof showNotification === 'function') {
      showNotification(`× ×•×¡×£ ×œ×¨×©×™××”: ${partName}`, 'success');
    }
    
    alert(`âœ… × ×•×¡×£ ×œ×¨×©×™××”: ${partName}\n×¡×¤×§: ${supplier}\n××—×™×¨: ${price}`);
    
    console.log('âœ… Added comprehensive search result to selected parts:', item);
  };
  
  // Legacy search result selection (backward compatibility)
  window.selectSearchResult = function(index) {
    const result = window.currentSearchResults[index];
    if (!result) return;
    
    // Auto-fill form with selected result
    document.getElementById('part_name').value = result.name || result.description || '';
    if (result.source) {
      document.getElementById('part_source').value = result.source;
    }
    
    // Add to selected parts
    const item = { 
      group: result.category || '××—×™×¤×•×©', 
      name: result.name || result.description || '', 
      qty: 1, 
      source: result.source || '×ª×—×œ×™×¤×™',
      price: result.price || '',
      supplier: result.supplier || ''
    };
    selectedParts.push(item);
    updateSelectedPartsList();
    
    alert('âœ… ×”×—×œ×§ × ×•×¡×£ ×œ×¨×©×™××”');
  };
  
  window.clearSearchResults = function() {
    document.getElementById('search_results_display').style.display = 'none';
    window.currentSearchResults = [];
  };
  
  // exportSelectedParts function moved to lines 526-580 (webhook-based Excel export)
  
  window.saveToSession = function() {
    if (selectedParts.length === 0) {
      alert('××™×Ÿ ×—×œ×§×™× ×œ×©××™×¨×”');
      return;
    }
    
    try {
      // âœ… FIXED: Use correct sessionStorage location for helper data
      let helper = {};
      try {
        helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      } catch (e) {
        console.warn('Failed to parse helper from sessionStorage, using empty object');
        helper = {};
      }
      
      // Initialize parts_search structure
      helper.parts_search = helper.parts_search || { 
        results: [], 
        all_results: [], 
        search_history: [],
        selected_parts: [],
        unselected_parts: [],
        summary: {}
      };
      
      // Mark selected parts in all_results
      if (helper.parts_search.all_results) {
        helper.parts_search.all_results.forEach(result => {
          const isSelected = selectedParts.some(selected => 
            (selected.name === result.name || selected.name === result.description) &&
            selected.source === result.source
          );
          if (isSelected) {
            result.selected = true;
            result.selected_timestamp = new Date().toISOString();
          }
        });
      }
      
      // Save selected parts to the dedicated selected_parts array
      helper.parts_search.selected_parts = [...(helper.parts_search.selected_parts || []), ...selectedParts];
      
      // Save selected parts to results (for backward compatibility)
      helper.parts_search.results = [...(helper.parts_search.results || []), ...selectedParts];
      
      // Update summary with comprehensive information
      helper.parts_search.summary = {
        total_results: helper.parts_search.results.length,
        total_all_results: helper.parts_search.all_results?.length || 0,
        selected_count: helper.parts_search.selected_parts.length || selectedParts.length,
        total_searches: helper.parts_search.search_history?.length || 0,
        last_updated: new Date().toISOString()
      };
      
      // Update meta information
      helper.meta = helper.meta || {};
      helper.meta.last_updated = new Date().toISOString();
      
      // âœ… FIXED: Save to correct sessionStorage location
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      // Also save to localStorage for backup compatibility
      localStorage.setItem('helper_data', JSON.stringify(helper));
      
      console.log(`âœ… FIXED: Saved ${selectedParts.length} selected parts to helper (sessionStorage)`);
      
      // Trigger helper update broadcast if available
      if (typeof window.broadcastHelperUpdate === 'function') {
        window.broadcastHelperUpdate(['parts_search'], 'parts_save_session');
      }
      
      // Check if opened from estimate builder
      const partSearchTarget = sessionStorage.getItem('partSearchTarget');
      if (partSearchTarget && window.opener) {
        try {
          const target = JSON.parse(partSearchTarget);
          
          // Send selected parts back to estimate builder
          if (selectedParts.length > 0) {
            window.opener.postMessage({
              type: 'PARTS_SELECTED',
              parts: selectedParts,
              target: target
            }, '*');
            
            alert(`âœ… × ×©××¨×• ${selectedParts.length} ×—×œ×§×™× ×•×”×•×¢×‘×¨×• ×œ××•××“×Ÿ`);
            window.close();
            return;
          }
        } catch (e) {
          console.error('Error communicating with estimate builder:', e);
        }
      }
      
      // âœ… NEW: Check if running inside damage centers wizard iframe
      if (window.parent !== window && window.parent.postMessage) {
        try {
          // Send search results back to wizard
          window.parent.postMessage({
            type: 'partsSearchResults',
            results: helper.parts_search?.current_session?.results || [],
            selectedParts: selectedParts,
            query: document.getElementById('free_query')?.value || '',
            source: 'parts_search_iframe'
          }, '*');
          
          console.log(`ğŸ“¤ Sent search results to wizard: ${selectedParts.length} parts selected`);
          alert(`âœ… × ×©××¨×• ${selectedParts.length} ×—×œ×§×™× ×•×”×•×¢×‘×¨×• ×œ××©×£ ××•×§×“×™ ×”× ×–×§`);
          return;
        } catch (e) {
          console.error('Error communicating with damage centers wizard:', e);
        }
      }
      
      alert(`âœ… × ×©××¨×• ${selectedParts.length} ×—×œ×§×™× ×œ×”××©×š ×‘××©×£`);
    } catch (e) {
      console.error('Error saving to session:', e);
      alert('×©×’×™××” ×‘×©××™×¨×”');
    }
  };
  
  function generatePartsCSV(parts) {
    const headers = ['×§×˜×’×•×¨×™×”', '×©× ×”×—×œ×§', '×›××•×ª', '××§×•×¨', '××—×™×¨', '×¡×¤×§'];
    const rows = parts.map(part => [
      part.group || '',
      part.name || '',
      part.qty || 1,
      part.source || '',
      part.price || '',
      part.supplier || ''
    ]);
    
    return [headers, ...rows].map(row => 
      row.map(field => `"${field}"`).join(',')
    ).join('\n');
  }
  
  function updateSelectedPartsList() {
    const listUI = document.getElementById('selected_parts_list');
    const managementButtons = document.getElementById('parts_management_buttons');
    const countDisplay = document.getElementById('selected_parts_count');
    
    // Update count display
    if (countDisplay) {
      countDisplay.textContent = selectedParts.length;
    }
    
    if (selectedParts.length === 0) {
      listUI.innerHTML = '<li style="color: #6b7280; font-style: italic; padding: 10px; text-align: center;">××™×Ÿ ×—×œ×§×™× ×‘×¨×©×™××”</li>';
      managementButtons.style.display = 'none';
      return;
    }
    
    // Show management buttons when there are parts
    managementButtons.style.display = 'block';
    
    listUI.innerHTML = selectedParts.map((item, index) => `
      <li style="
        margin-bottom: 8px; 
        padding: 12px; 
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); 
        border-radius: 8px; 
        border: 1px solid #cbd5e1;
        position: relative;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
      ">
        <div style="flex: 1;">
          <div style="font-weight: bold; color: #1e40af; margin-bottom: 4px;">
            ${item.group} - ${item.name}
          </div>
          <div style="font-size: 12px; color: #64748b;">
            ×›××•×ª: <strong>${item.qty}</strong> | ××§×•×¨: <strong>${item.source}</strong>
            ${item.price ? ` | ××—×™×¨: <strong style="color: #059669;">â‚ª${item.price}</strong>` : ''}
            ${item.supplier ? ` | ×¡×¤×§: <strong>${item.supplier}</strong>` : ''}
          </div>
        </div>
        <div style="display: flex; gap: 5px; align-items: center;">
          <button onclick="editPart(${index})" 
                  style="
                    background: #f59e0b; 
                    color: white; 
                    border: none; 
                    padding: 6px 10px; 
                    border-radius: 5px; 
                    cursor: pointer; 
                    font-size: 12px;
                    font-weight: bold;
                  " 
                  title="×¢×¨×•×š ×—×œ×§">
            âœï¸
          </button>
          <button onclick="deletePart(${index})" 
                  style="
                    background: #dc3545; 
                    color: white; 
                    border: none; 
                    padding: 6px 10px; 
                    border-radius: 5px; 
                    cursor: pointer; 
                    font-size: 12px;
                    font-weight: bold;
                  " 
                  title="××—×§ ×—×œ×§">
            ğŸ—‘ï¸
          </button>
        </div>
      </li>
    `).join('');
  }
  
  // âœ… NEW: Edit part functionality
  function editPart(index) {
    const part = selectedParts[index];
    if (!part) return;
    
    // Create edit modal
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); display: flex; align-items: center;
      justify-content: center; z-index: 10000; direction: rtl;
    `;
    
    modal.innerHTML = `
      <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
        <h3 style="color: #1e3a8a; margin-bottom: 20px; text-align: center;">âœï¸ ×¢×¨×•×š ×—×œ×§</h3>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">×§×‘×•×¦×ª ×—×œ×§×™×:</label>
          <select id="editPartGroup" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
            <option value="">×‘×—×¨ ×§×˜×’×•×¨×™×”</option>
          </select>
        </div>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">×©× ×”×—×œ×§:</label>
          <input type="text" id="editPartName" value="${part.name}" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
        </div>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">×›××•×ª:</label>
          <input type="number" id="editPartQuantity" value="${part.qty}" min="1" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
        </div>
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">××§×•×¨:</label>
          <select id="editPartSource" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
            <option value="××§×•×¨×™" ${part.source === '××§×•×¨×™' ? 'selected' : ''}>××§×•×¨×™</option>
            <option value="×ª×—×œ×™×¤×™" ${part.source === '×ª×—×œ×™×¤×™' ? 'selected' : ''}>×ª×—×œ×™×¤×™</option>
            <option value="××©×•××©" ${part.source === '××©×•××©' ? 'selected' : ''}>××©×•××©</option>
            <option value="×”×›×œ" ${part.source === '×”×›×œ' ? 'selected' : ''}>×”×›×œ</option>
          </select>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button onclick="saveEditedPart(${index})" style="background: #10b981; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
            ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×
          </button>
          <button onclick="this.closest('[style*=fixed]').remove()" style="background: #6b7280; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer;">
            âœ• ×‘×™×˜×•×œ
          </button>
        </div>
      </div>
    `;
    
    modal.onclick = (e) => e.target === modal && modal.remove();
    document.body.appendChild(modal);
    
    // Populate categories
    const groupSelect = modal.querySelector('#editPartGroup');
    if (window.PARTS_BANK) {
      Object.keys(window.PARTS_BANK).forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        if (category === part.group) option.selected = true;
        groupSelect.appendChild(option);
      });
    }
  }
  
  // âœ… NEW: Save edited part
  function saveEditedPart(index) {
    const modal = document.querySelector('[style*="position: fixed"]');
    const group = modal.querySelector('#editPartGroup').value;
    const name = modal.querySelector('#editPartName').value;
    const qty = modal.querySelector('#editPartQuantity').value;
    const source = modal.querySelector('#editPartSource').value;
    
    if (!group || !name) {
      alert('×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™×');
      return;
    }
    
    // Update the part
    selectedParts[index] = {
      ...selectedParts[index],
      group,
      name,
      qty: parseInt(qty),
      source,
      modified_at: new Date().toISOString()
    };
    
    // Update the display
    updateSelectedPartsList();
    
    // Close modal
    modal.remove();
    
    // Show notification
    if (typeof showNotification === 'function') {
      showNotification(`×¢×•×“×›×Ÿ ×—×œ×§: ${name}`, 'success');
    }
    
    console.log(`âœ… Edited part: ${group} - ${name} (${qty}x ${source})`);
  }
  
  // âœ… NEW: Delete part functionality
  function deletePart(index) {
    const part = selectedParts[index];
    if (!part) return;
    
    const confirmDelete = confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×—×œ×§?\n\n${part.group} - ${part.name}\n×›××•×ª: ${part.qty} | ××§×•×¨: ${part.source}`);
    
    if (confirmDelete) {
      selectedParts.splice(index, 1);
      updateSelectedPartsList();
      
      // Show notification
      if (typeof showNotification === 'function') {
        showNotification(`× ××—×§ ×—×œ×§: ${part.name}`, 'success');
      }
      
      console.log(`ğŸ—‘ï¸ Deleted part: ${part.group} - ${part.name}`);
    }
  }
  
  // âœ… NEW: Clear all parts functionality
  function clearAllParts() {
    if (selectedParts.length === 0) {
      alert('××™×Ÿ ×—×œ×§×™× ×‘×¨×©×™××” ×œ××—×™×§×”');
      return;
    }
    
    const confirmClear = confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”×—×œ×§×™× ××”×¨×©×™××”?\n\n×™×™××—×§×• ${selectedParts.length} ×—×œ×§×™×.`);
    
    if (confirmClear) {
      const count = selectedParts.length;
      selectedParts.length = 0; // Clear array
      updateSelectedPartsList();
      
      // Show notification
      if (typeof showNotification === 'function') {
        showNotification(`× ××—×§×• ${count} ×—×œ×§×™× ××”×¨×©×™××”`, 'success');
      }
      
      console.log(`ğŸ—‘ï¸ Cleared all ${count} parts from list`);
    }
  }
  
  // âœ… NEW: Duplicate last part functionality
  function duplicateSelectedPart() {
    if (selectedParts.length === 0) {
      alert('××™×Ÿ ×—×œ×§×™× ×‘×¨×©×™××” ×œ×©×›×¤×•×œ');
      return;
    }
    
    const lastPart = selectedParts[selectedParts.length - 1];
    const duplicatedPart = {
      ...lastPart,
      id: `part_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      added_at: new Date().toISOString(),
      duplicated_from: lastPart.id
    };
    
    selectedParts.push(duplicatedPart);
    updateSelectedPartsList();
    
    // Show notification
    if (typeof showNotification === 'function') {
      showNotification(`×©×•×›×¤×œ ×—×œ×§: ${lastPart.name}`, 'success');
    }
    
    console.log(`ğŸ“„ Duplicated part: ${lastPart.group} - ${lastPart.name}`);
  }
  
  // Make functions globally available
  window.editPart = editPart;
  window.saveEditedPart = saveEditedPart;
  window.deletePart = deletePart;
  window.clearAllParts = clearAllParts;
  window.duplicateSelectedPart = duplicateSelectedPart;

  // âœ… NEW: Load saved selected parts from helper on page initialization
  function loadSavedPartsFromHelper() {
    console.log('ğŸ“¦ Loading saved selected parts from helper...');
    
    try {
      const helperString = sessionStorage.getItem('helper');
      if (helperString) {
        const helper = JSON.parse(helperString);
        
        // Load selected parts from helper.parts_search.selected_parts
        if (helper.parts_search && helper.parts_search.selected_parts && Array.isArray(helper.parts_search.selected_parts)) {
          const savedParts = helper.parts_search.selected_parts;
          console.log(`âœ… Found ${savedParts.length} saved selected parts in helper`);
          
          // Clear current array and load saved parts
          selectedParts.length = 0;
          savedParts.forEach(part => {
            selectedParts.push({
              id: part.id || Date.now() + Math.random(),
              group: part.group || '×œ× ×¦×•×™×Ÿ',
              name: part.name || '×œ× ×¦×•×™×Ÿ',
              qty: part.qty || '1',
              source: part.source || '××§×•×¨×™',
              price: part.price || '',
              supplier: part.supplier || '',
              added_at: part.added_at || new Date().toISOString()
            });
          });
          
          console.log(`ğŸ“¦ Loaded ${selectedParts.length} parts from helper storage`);
        } else {
          console.log('â„¹ï¸ No saved selected parts found in helper');
        }
      } else {
        console.log('â„¹ï¸ No helper data found in session storage');
      }
    } catch (error) {
      console.error('âŒ Error loading saved parts from helper:', error);
    }
  }

  window.loadSavedPartsFromHelper = loadSavedPartsFromHelper;

  // âœ… MISSING FUNCTION: Define updatePartNameOptions for dropdown change
  function updatePartNameOptions() {
    const groupSelect = document.getElementById('part_group');
    const nameSelect = document.getElementById('part_name');
    
    if (!groupSelect || !nameSelect) return;
    
    const selectedGroup = groupSelect.value;
    nameSelect.innerHTML = '<option value="" disabled selected>×‘×—×¨ ×©× ×—×œ×§</option>';
    
    if (selectedGroup && window.PARTS_BANK && window.PARTS_BANK[selectedGroup]) {
      window.PARTS_BANK[selectedGroup].forEach(partName => {
        const option = document.createElement('option');
        option.value = partName;
        option.textContent = partName;
        nameSelect.appendChild(option);
      });
    }
    
    console.log(`ğŸ”„ Updated part name options for group: ${selectedGroup}`);
  }

  // Make functions globally available
  window.updateSelectedPartsList = updateSelectedPartsList;
  window.updatePartNameOptions = updatePartNameOptions;

  const autofillFields = [
    'plate', 'manufacturer', 'model', 'model_code', 'trim', 'year',
    'engine_volume', 'engine_code', 'engine_type', 'vin', 'oem'
  ];
  autofillFields.forEach(key => {
    const val = sessionStorage.getItem(key);
    if (val) {
      const input = document.getElementById(key);
      if (input) {
        input.value = val;
        input.readOnly = true;
      }
    }
  });

  const auth = sessionStorage.getItem("auth");
  if (!auth) {
    alert("×”×’×™×©×” ×—×¡×•××” - ×× × ×”×ª×—×‘×¨ ×“×¨×š ×“×£ ×”×‘×™×ª");
    window.location.href = "index.html";
  }

  const logoutBtn = document.querySelector(".logout-btn");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", function (e) {
      e.preventDefault();
      sessionStorage.clear();
      window.location.href = "index.html";
    });
  }
  
  // âœ… FIX 5: Create toggle popup for parts list visibility in internal browser
  function createPartsListTogglePopup() {
    console.log('ğŸ¯ Creating parts list toggle popup for internal browser');
    
    if (selectedParts.length === 0) {
      console.warn('âš ï¸ No parts selected for external site search');
      return;
    }
    
    // Remove existing popup if any
    const existingPopup = document.getElementById('partsListTogglePopup');
    if (existingPopup) {
      existingPopup.remove();
    }
    
    // Create toggle popup
    const popup = document.createElement('div');
    popup.id = 'partsListTogglePopup';
    popup.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      width: 300px;
      max-height: 400px;
      background: white;
      border: 2px solid #3b82f6;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 10000;
      font-family: Arial, sans-serif;
      font-size: 14px;
      overflow-y: auto;
    `;
    
    const partsListHTML = selectedParts.map((part, index) => `
      <div style="padding: 8px; border-bottom: 1px solid #eee; background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
        <div style="font-weight: bold; color: #1e40af;">${part.group} - ${part.name}</div>
        <div style="font-size: 12px; color: #6b7280;">
          ×›××•×ª: ${part.qty} | ××§×•×¨: ${part.source}
        </div>
      </div>
    `).join('');
    
    popup.innerHTML = `
      <div style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; padding: 12px; border-radius: 10px 10px 0 0; text-align: center;">
        <strong>×¨×©×™××ª ×—×œ×§×™× ××‘×•×§×©×™× (${selectedParts.length})</strong>
      </div>
      <div style="padding: 12px;">
        <div style="max-height: 250px; overflow-y: auto; margin-bottom: 12px;">
          ${partsListHTML}
        </div>
        <div style="display: flex; gap: 8px; justify-content: center;">
          <button onclick="copyPartsListForSite()" style="
            background: #10b981; color: white; border: none; padding: 8px 12px; 
            border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;
          ">ğŸ“‹ ×”×¢×ª×§ ×¨×©×™××”</button>
          <button onclick="togglePopupVisibility()" style="
            background: #f59e0b; color: white; border: none; padding: 8px 12px; 
            border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;
          ">ğŸ‘ï¸ ×”×¡×ª×¨/×”×¦×’</button>
          <button onclick="closePartsListPopup()" style="
            background: #ef4444; color: white; border: none; padding: 8px 12px; 
            border-radius: 6px; cursor: pointer; font-size: 12px;
          ">âœ•</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(popup);
    
    // Make popup draggable
    let isDragging = false;
    let currentX, currentY, initialX, initialY;
    
    popup.addEventListener('mousedown', (e) => {
      if (e.target === popup || e.target.closest('.popup-header')) {
        isDragging = true;
        initialX = e.clientX - popup.offsetLeft;
        initialY = e.clientY - popup.offsetTop;
      }
    });
    
    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;
        popup.style.left = currentX + 'px';
        popup.style.top = currentY + 'px';
        popup.style.right = 'auto';
      }
    });
    
    document.addEventListener('mouseup', () => {
      isDragging = false;
    });
  }
  
  // âœ… Helper functions for toggle popup
  window.copyPartsListForSite = function() {
    const partsText = selectedParts.map(part => 
      `${part.group} - ${part.name} (×›××•×ª: ${part.qty}, ××§×•×¨: ${part.source})`
    ).join('\n');
    
    const vehicleInfo = `×¤×¨×˜×™ ×¨×›×‘:
×™×¦×¨×Ÿ: ${document.getElementById('manufacturer').value}
×“×’×: ${document.getElementById('model').value}
×©× ×”: ${document.getElementById('year').value}

×¨×©×™××ª ×—×œ×§×™× ××‘×•×§×©×™×:
${partsText}`;
    
    navigator.clipboard.writeText(vehicleInfo).then(() => {
      alert('âœ… ×¨×©×™××ª ×”×—×œ×§×™× ×”×•×¢×ª×§×” ×œ×œ×•×—!');
    }).catch(() => {
      alert('âŒ ×©×’×™××” ×‘×”×¢×ª×§×”');
    });
  };
  
  window.togglePopupVisibility = function() {
    const popup = document.getElementById('partsListTogglePopup');
    if (popup) {
      const content = popup.querySelector('div:last-child');
      if (content.style.display === 'none') {
        content.style.display = 'block';
        popup.style.height = 'auto';
      } else {
        content.style.display = 'none';
        popup.style.height = '44px';
      }
    }
  };
  
  window.closePartsListPopup = function() {
    const popup = document.getElementById('partsListTogglePopup');
    if (popup) {
      popup.remove();
    }
  };
  
  // Make function globally available
  window.createPartsListTogglePopup = createPartsListTogglePopup;

</script>
</body>
</html>
