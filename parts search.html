<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×¤×•×¨×˜×œ - ×—×™×¤×•×© ×—×œ×¤×™×</title>
  <script type="module" src="./parts.js"></script>
  <script type="module" src="./webhook.js"></script>
  <script src="./internal-browser.js"></script>

  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link rel="shortcut icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link rel="apple-touch-icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3a8a 0%, #64748b 100%);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      max-width: 450px;
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
      position: relative;

    }
    .logo img {
      width: 120px;
      margin-bottom: 15px;
    }
    .title { font-size: 24px; font-weight: bold; margin-bottom: 5px; color: #1e3a8a; }
    .subtitle { font-size: 18px; color: #64748b; margin-bottom: 5px; }
    .legal-note {
      color: red;
      font-weight: bold;
      margin-bottom: 15px;
    }
    h2 {
      font-size: 20px;
      color: #1e3a8a;
      margin-bottom: 20px;
    }
  .right-small-heading {
    text-align: right;
    font-size: 18px;
    color: #1e3a8a;
   margin-bottom: 18px;
  }

    input, select {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .btn {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background-color: #3b82f6;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
      Margin-bottom: 10px;
    }
    .footer-btns {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    .footer-btns button {
      width: 48%;
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
    .home-btn { background-color: #6c757d; color: white; }
    .logout-btn { background-color: #dc3545; color: white; }
    .footer { font-size: 12px; color: #475569; margin-top: 15px; text-align: center; }
    #previewImage {
      display: none;
      max-width: 100%;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
  </style>
</head>
<body>
<div class="container">
    <div class="logo">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo">
    </div>
    <div class="title">×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×¤×•×¨×˜×œ</div>
    <div class="subtitle">×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</div>
  <h2>×—×™×¤×•×© ×—×œ×¤×™× ×œ×¨×›×‘</h2>
  <form id="partSearchForm">
    <input type="text" id="plate" name="plate" placeholder="××¡×¤×¨ ×¨×™×©×•×™">
    <input type="text" id="manufacturer" name="manufacturer" placeholder="×™×¦×¨×Ÿ">
    <input type="text" id="model" name="model" placeholder="×“×’×">
    <input type="text" id="trim" name="trim" placeholder="×¨××ª ×’×™××•×¨">
    <input type="text" id="year" name="year" placeholder="×©× ×”">
    <input type="text" id="engine_volume" name="engine_volume" placeholder="× ×¤×— ×× ×•×¢">
    <input type="text" id="engine_code" name="engine_code" placeholder="×“×’× ×× ×•×¢">
    <input type="text" id="engine_type" name="engine_type" placeholder="×¡×•×’ ×× ×•×¢">
    <input type="text" id="vin" name="vin" placeholder="××¡×¤×¨ ×©×œ×“×”">
 <input type="text" id="free_query" name="free_query" placeholder="×—×™×¤×•×© ×—×•×¤×©×™">
<h2 class="right-small-heading">×”×¢×œ×”/×¦×œ× ×ª××•× ×” ×œ×—×™×¤×•×© (××•×¤×¦×™×•× ×œ×™)</h2>
    <input type="file" id="part_image" accept="image/*" capture="environment" placeholder="×ª××•× ×ª ×—×œ×§ (××•×¤×¦×™×•× ×œ×™)">
    <img id="previewImage" />
    <select id="part_group" required onchange="updatePartNameOptions()">
      <option value="" disabled selected hidden>×‘×—×¨ ×§×‘×•×¦×ª ×—×œ×§×™×</option>
    </select>
    <select id="part_name" required>
      <option value="" disabled selected hidden>×‘×—×¨ ×—×œ×§</option>
    </select>
<select id="part_source" required>
  <option value="" disabled selected hidden>×‘×—×¨ ××§×•×¨</option>
  <option value="××§×•×¨×™">××§×•×¨×™</option>
  <option value="×ª×—×œ×™×¤×™">×ª×—×œ×™×¤×™</option>
  <option value="××©×•××©">××©×•××©</option>
  <option value="×”×›×œ">×”×›×œ</option>
</select>
<input type="number" id="part_quantity" placeholder="×›××•×ª" min="1" value="1" required>

<button type="button" class="btn" onclick="addFullPart()">×”×•×¡×£ ×—×œ×§ ×œ×¨×©×™××”</button>
<ul id="selected_parts_list" style="text-align:right; padding-right: 0; font-size: 14px;"></ul>

<!-- Enhanced Search Results Display -->
<div id="search_results_display" style="display: none; margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
  <h3 style="color: #007bff; margin-bottom: 10px;">×ª×•×¦××•×ª ×—×™×¤×•×©</h3>
  <div id="search_results_content"></div>
  <button type="button" class="btn" onclick="clearSearchResults()" style="background: #6c757d; margin-top: 10px;">× ×§×” ×ª×•×¦××•×ª</button>
</div>

<h2 style="text-align: right; font-size: 18px;">×—×™×¤×•×© ×—×œ×¤×™× ×‘××ª×¨</h2>
<button type="button" class="btn" onclick="generateExternalForm()" style="background: #10b981; margin-bottom: 10px;">ğŸš€ ×¦×•×¨ ×˜×•×¤×¡ ×—×›× ×œ××ª×¨ ×—×™×¦×•× ×™</button>
<button type="button" class="btn" onclick="openSearchSite()">×¤×ª×— ××ª×¨ car-part ×œ×—×™×¤×•×©</button>
 <label for="resultFileUpload">×”×¢×œ×” ×ª×•×¦××ª ×—×™×¤×•×© (PDF/×ª××•× ×”)</label>
<input type="file" id="resultFileUpload" accept=".pdf,.png,.jpg,.jpeg,.html">
<button type="button" class="btn" id="sendResultToOCRBtn">×©×œ×— ×ª×•×¦××ª ×—×™×¤×•×© ×œ× ×™×ª×•×—</button>
<h2 style="text-align: right; font-size: 18px;">×—×™×¤×•×© ×—×œ×¤×™× ×‘××¢×¨×›×ª</h2>
     <button class="btn" type="submit">ğŸ” ×—×¤×© ×—×œ×§×™×</button>

<!-- Enhanced Part Management -->
<div style="margin-top: 20px;">
  <button type="button" class="btn" onclick="exportSelectedParts()" style="background: #28a745;">ğŸ“„ ×™×™×¦× ×—×œ×§×™× ×œ××§×¡×œ</button>
  <button type="button" class="btn" onclick="saveToSession()" style="background: #ffc107; color: #000;">ğŸ’¾ ×©××•×¨ ×œ×”××©×š ×‘××©×£</button>
</div>
  </form>
  <div class="footer-btns">
    <button class="home-btn" onclick="window.location.href='selection.html'">×œ×¢××•×“ ×”×‘×™×ª</button>
    <button class="logout-btn">×™×¦×™××” ××”××¢×¨×›×ª</button>
  </div>
  <div class="footer">All rights reserved Â© Carmel Cayouf</div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
  // ENHANCED: Auto-populate vehicle data from helper
  function populateVehicleDataFromHelper() {
    console.log('ğŸš— Parts Search: Auto-populating vehicle data from helper...');
    
    try {
      const helperString = sessionStorage.getItem('helper');
      if (helperString) {
        const helper = JSON.parse(helperString);
        console.log('âœ… Helper data loaded for parts search:', helper);
        
        // Populate form fields with helper data using field mapping
        const fieldMappings = {
          'plate': helper.vehicle?.plate || helper.meta?.plate,
          'manufacturer': helper.vehicle?.manufacturer,
          'model': helper.vehicle?.model,
          'trim': helper.vehicle?.trim,
          'year': helper.vehicle?.year,
          'engine_volume': helper.vehicle?.engine_volume,
          'engine_code': helper.vehicle?.model_code,
          'engine_type': helper.vehicle?.engine_model,
          'vin': helper.vehicle?.chassis
        };
        
        // Apply the mappings
        Object.entries(fieldMappings).forEach(([fieldId, value]) => {
          const element = document.getElementById(fieldId);
          if (element && value) {
            element.value = value;
            console.log(`  âœ… ${fieldId}: "${value}"`);
          }
        });
        
        console.log('âœ… Parts search auto-population completed');
      } else {
        console.log('âš ï¸ No helper data found in sessionStorage');
      }
    } catch (error) {
      console.error('âŒ Error auto-populating vehicle data:', error);
    }
  }
  
  // Auto-populate on page load
  populateVehicleDataFromHelper();
  
  // Listen for helper updates
  window.addEventListener('storage', (e) => {
    if (e.key === 'helper') {
      console.log('ğŸ”„ Helper data updated, re-populating parts search...');
      populateVehicleDataFromHelper();
    }
  });

  const groupSelect = document.getElementById('part_group');
  const nameSelect = document.getElementById('part_name');

  if (!window.PARTS_BANK) {
    alert("×—×¡×¨ ×§×•×‘×¥ ×—×œ×§×™× ××• ×©×”×˜×¢×™× ×” × ×›×©×œ×”");
    return;
  }

  for (const group in window.PARTS_BANK) {
    const option = document.createElement('option');
    option.value = group;
    option.textContent = group;
    groupSelect.appendChild(option);
  }

  groupSelect.addEventListener('change', () => {
    nameSelect.innerHTML = '<option value="" disabled selected hidden>×‘×—×¨ ×—×œ×§</option>';
    const selectedCategory = groupSelect.value;
    const parts = window.PARTS_BANK[selectedCategory] || [];
    
    console.log(`ğŸ” Loading ${parts.length} parts for category: ${selectedCategory}`);
    
    parts.forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      opt.setAttribute('data-category', selectedCategory);
      nameSelect.appendChild(opt);
    });
    
    // ğŸ¯ CREATIVE: Visual feedback for category loading
    showNotification(`× ×˜×¢× ×• ${parts.length} ×—×œ×§×™× ×¢×‘×•×¨ ${selectedCategory}`, 'info');
    autoSaveSearchProgress();
  });
  
  // ğŸ¯ CREATIVE ENHANCEMENTS: Smart features for parts search
  
  // Smart notification system
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    const colors = {
      success: '#10b981',
      info: '#3b82f6', 
      warning: '#f59e0b',
      error: '#ef4444'
    };
    
    notification.style.cssText = `
      position: fixed; top: 20px; right: 20px; z-index: 9999;
      background: ${colors[type]}; color: white; padding: 12px 16px;
      border-radius: 8px; font-size: 14px; font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateX(100%); transition: transform 0.3s ease;
      max-width: 300px; direction: rtl;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    setTimeout(() => notification.style.transform = 'translateX(0)', 100);
    setTimeout(() => {
      notification.style.transform = 'translateX(100%)';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }
  
  // Auto-save search progress
  function autoSaveSearchProgress() {
    const searchData = {
      vehicle: {
        plate: document.getElementById('plate').value,
        manufacturer: document.getElementById('manufacturer').value,
        model: document.getElementById('model').value,
        year: document.getElementById('year').value,
        engine_volume: document.getElementById('engine_volume').value
      },
      parts: {
        group: document.getElementById('part_group').value,
        name: document.getElementById('part_name').value,
        source: document.getElementById('part_source').value,
        quantity: document.getElementById('part_quantity').value
      },
      timestamp: new Date().toISOString()
    };
    
    sessionStorage.setItem('partsSearchProgress', JSON.stringify(searchData));
    console.log('ğŸ’¾ Auto-saved search progress');
  }
  
  // ğŸ¯ SMART FORM BUILDER for external sites - ENHANCED to capture ALL parts
  window.generateExternalForm = function() {
    const vehicle = {
      manufacturer: document.getElementById('manufacturer').value,
      model: document.getElementById('model').value,
      year: document.getElementById('year').value,
      engine_volume: document.getElementById('engine_volume').value
    };
    
    // âœ… FIXED: Capture ALL parts from selectedParts array, not just current dropdown
    let partsToExport = [];
    
    // Add all parts from the selected parts list
    if (selectedParts && selectedParts.length > 0) {
      partsToExport = [...selectedParts];
    }
    
    // Also add current form part if it's filled out and not already in the list
    const currentPart = {
      group: document.getElementById('part_group').value,
      name: document.getElementById('part_name').value,
      source: document.getElementById('part_source').value,
      quantity: document.getElementById('part_quantity').value || 1
    };
    
    if (currentPart.group && currentPart.name) {
      // Check if this part is not already in the list
      const isDuplicate = partsToExport.some(p => 
        p.group === currentPart.group && 
        p.name === currentPart.name && 
        p.source === currentPart.source
      );
      
      if (!isDuplicate) {
        partsToExport.push(currentPart);
      }
    }
    
    if (!vehicle.manufacturer || !vehicle.model) {
      showNotification('×× × ××œ× ××ª ×¤×¨×˜×™ ×”×¨×›×‘', 'warning');
      return;
    }
    
    if (partsToExport.length === 0) {
      showNotification('×× × ×”×•×¡×£ ×œ×¤×—×•×ª ×—×œ×§ ××—×“ ×œ×¨×©×™××”', 'warning');
      return;
    }
    
    showExternalFormModal(vehicle, partsToExport);
  };
  
  function showExternalFormModal(vehicle, parts) {
    // âœ… ENHANCED: Handle multiple parts in smart form
    const partsArray = Array.isArray(parts) ? parts : [parts];
    const totalParts = partsArray.length;
    
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); display: flex; align-items: center;
      justify-content: center; z-index: 10000; direction: rtl;
    `;
    
    // Generate parts list HTML
    const partsListHTML = partsArray.map((part, index) => `
      <div style="background: #ecfdf5; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #10b981;">
        <strong>×—×œ×§ ${index + 1}:</strong><br>
        ×§×˜×’×•×¨×™×”: <strong>${part.group}</strong><br>
        ${part.name ? `×©× ×”×—×œ×§: <strong>${part.name}</strong><br>` : ''}
        ${part.source ? `××§×•×¨: <strong>${part.source}</strong><br>` : ''}
        ×›××•×ª: <strong>${part.quantity || part.qty || 1}</strong>
        ${part.price ? `<br>××—×™×¨ ××©×•×¢×¨: <strong>${part.price}</strong>` : ''}
        ${part.supplier ? `<br>×¡×¤×§: <strong>${part.supplier}</strong>` : ''}
      </div>
    `).join('');
    
    modal.innerHTML = `
      <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
        <h3 style="color: #1e3a8a; margin-bottom: 20px; text-align: center;">ğŸ” ×˜×•×¤×¡ ×—×›× ×œ××ª×¨ ×—×œ×¤×™× ×—×™×¦×•× ×™</h3>
        
        <div style="background: #f0f9ff; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
          <strong>×¤×¨×˜×™ ×”×¨×›×‘:</strong><br>
          ×™×¦×¨×Ÿ: <strong>${vehicle.manufacturer}</strong><br>
          ×“×’×: <strong>${vehicle.model}</strong><br>
          ×©× ×”: <strong>${vehicle.year}</strong><br>
          × ×¤×— ×× ×•×¢: <strong>${vehicle.engine_volume}</strong>
        </div>
        
        <div style="margin-bottom: 20px;">
          <strong style="color: #10b981;">×—×œ×§×™× ××‘×•×§×©×™× (${totalParts}):</strong><br>
          ${partsListHTML}
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
          <button onclick="copyFormData('${JSON.stringify({vehicle, parts: partsArray}).replace(/"/g, '&quot;')}')" 
                  style="background: #3b82f6; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
            ğŸ“‹ ×”×¢×ª×§ × ×ª×•× ×™×
          </button>
          <button onclick="window.openInternalBrowser ? window.openInternalBrowser('car-part.co.il', '×—×™×¤×•×© ×—×œ×¤×™×') : window.open('https://www.car-part.co.il/Include/Generic/AccessSystem.jsp', '_blank')" 
                  style="background: #10b981; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
            ğŸŒ ×¤×ª×— Car-Part
          </button>
          <button onclick="this.closest('[style*=fixed]').remove()" 
                  style="background: #6b7280; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer;">
            âœ• ×¡×’×•×¨
          </button>
        </div>
      </div>
    `;
    
    modal.onclick = (e) => e.target === modal && modal.remove();
    document.body.appendChild(modal);
  }
  
  window.copyFormData = function(dataStr) {
    const data = JSON.parse(dataStr.replace(/&quot;/g, '"'));
    
    // âœ… ENHANCED: Handle multiple parts in copy function
    let text = `×¤×¨×˜×™ ×¨×›×‘:
×™×¦×¨×Ÿ: ${data.vehicle.manufacturer}
×“×’×: ${data.vehicle.model}
×©× ×”: ${data.vehicle.year}
× ×¤×— ×× ×•×¢: ${data.vehicle.engine_volume}

×—×œ×§×™× ××‘×•×§×©×™× (${data.parts ? data.parts.length : 1}):
`;
    
    if (data.parts && Array.isArray(data.parts)) {
      // Multiple parts
      data.parts.forEach((part, index) => {
        text += `${index + 1}. ${part.group} - ${part.name || ''}
   ××§×•×¨: ${part.source || ''}
   ×›××•×ª: ${part.quantity || part.qty || 1}
${part.price ? `   ××—×™×¨ ××©×•×¢×¨: ${part.price}` : ''}
${part.supplier ? `   ×¡×¤×§: ${part.supplier}` : ''}

`;
      });
    } else if (data.part) {
      // Single part (legacy support)
      text += `1. ${data.part.group} - ${data.part.name || ''}
   ××§×•×¨: ${data.part.source || ''}
   ×›××•×ª: ${data.part.quantity}`;
    }
    
    navigator.clipboard.writeText(text).then(() => {
      showNotification('× ×ª×•× ×™× ×”×•×¢×ª×§×• ×‘×”×¦×œ×—×”!', 'success');
    }).catch(() => {
      showNotification('×©×’×™××” ×‘×”×¢×ª×§×”', 'error');
    });
  };
  
  // Auto-save on form changes
  document.querySelectorAll('input, select').forEach(element => {
    element.addEventListener('change', autoSaveSearchProgress);
  });
  
  });

  let imageBase64 = null;
  document.getElementById('part_image').addEventListener('change', function () {
    const file = this.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function (e) {
      imageBase64 = e.target.result;
      const img = document.getElementById('previewImage');
      img.src = imageBase64;
      img.style.display = 'block';
    };
    reader.readAsDataURL(file);
  });
</script>
<script>
  const selectedParts = [];
  const listUI = document.getElementById('selected_parts_list');

  function addFullPart() {
    const group = document.getElementById('part_group').value;
    const name = document.getElementById('part_name').value;
    const qty = document.getElementById('part_quantity').value;
    const source = document.getElementById('part_source').value;

    if (!group || !name || !qty || !source) {
      alert("×™×© ×œ××œ× ××ª ×›×œ ×¤×¨×˜×™ ×”×—×œ×§ ×œ×¤× ×™ ×”×”×•×¡×¤×”");
      return;
    }

    const item = { group, name, qty, source };
    selectedParts.push(item);

    const li = document.createElement('li');
    li.textContent = `${group} - ${name} | ×›××•×ª: ${qty} | ××§×•×¨: ${source}`;
    li.style.cursor = "pointer";
    li.title = "×œ×—×¥ ×œ×”×¡×¨×”";
    li.onclick = () => {
      const index = selectedParts.indexOf(item);
      if (index !== -1) {
        selectedParts.splice(index, 1);
        updateSelectedPartsList();
      }
    };

    listUI.appendChild(li);

    document.getElementById('part_name').value = '';
    document.getElementById('part_quantity').value = '1';
    document.getElementById('part_source').value = '';
  }
  
  // âœ… NEW: Send current parts list to Make.com for processing
</script>

<script>
  document.getElementById('partSearchForm').addEventListener('submit', e => {
    e.preventDefault();
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = '××—×¤×©...';
    submitBtn.disabled = true;
    
    // Enhanced payload includes selected parts list if available
    const payload = {
      plate: plate.value.trim(),
      manufacturer: manufacturer.value.trim(),
      model: model.value.trim(),
      trim: trim.value.trim(),
      year: year.value.trim(),
      engine_volume: engine_volume.value.trim(),
      engine_code: engine_code.value.trim(),
      engine_type: engine_type.value.trim(),
      vin: vin.value.trim(),
      part_group: part_group.value,
      part_name: part_name.value,
      free_query: free_query.value.trim(),
      part_image_base64: imageBase64 || null,
      selectedParts: selectedParts || [],
      // Include parts list in search if available
      search_type: (selectedParts && selectedParts.length > 0) ? 'enhanced_with_parts_list' : 'standard',
      parts_list: selectedParts || []
    };
    
    sendPartSearch(payload).then(results => {
      if (results && results.parts && results.parts.length > 0) {
        displaySearchResults(results.parts);
        alert(`âœ… × ××¦××• ${results.parts.length} ×—×œ×§×™×`);
        
        // âœ… FIXED: Save ALL results to helper using correct sessionStorage location
        try {
          // Get helper data from correct location (sessionStorage, not localStorage)
          let helper = {};
          try {
            helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
          } catch (e) {
            console.warn('Failed to parse helper from sessionStorage, using empty object');
            helper = {};
          }
          
          // Initialize parts_search structure if needed
          helper.parts_search = helper.parts_search || { 
            results: [],
            search_history: [],
            all_results: [],
            selected_parts: [],
            unselected_parts: [],
            summary: {}
          };
          
          // Save search context and parameters
          const searchContext = {
            query: {
              plate: plate.value.trim(),
              manufacturer: manufacturer.value.trim(),
              model: model.value.trim(),
              part_group: part_group.value,
              part_name: part_name.value,
              free_query: free_query.value.trim()
            },
            timestamp: new Date().toISOString(),
            results_count: results.parts.length
          };
          
          // Save search to history
          helper.parts_search.search_history.unshift(searchContext);
          if (helper.parts_search.search_history.length > 10) {
            helper.parts_search.search_history = helper.parts_search.search_history.slice(0, 10);
          }
          
          // Mark all results as unselected initially and save them
          const markedResults = results.parts.map(part => ({
            ...part,
            selected: false,
            search_timestamp: new Date().toISOString(),
            search_query: searchContext.query
          }));
          
          // Add to all results (preserve existing + add new)
          helper.parts_search.all_results = [...(helper.parts_search.all_results || []), ...markedResults];
          
          // Update summary
          helper.parts_search.summary = {
            total_searches: helper.parts_search.search_history.length,
            total_results: helper.parts_search.all_results.length,
            selected_count: helper.parts_search.selected_parts.length || 0,
            last_search: new Date().toISOString()
          };
          
          // Update meta information
          helper.meta = helper.meta || {};
          helper.meta.last_updated = new Date().toISOString();
          
          // âœ… FIXED: Save to correct sessionStorage location
          sessionStorage.setItem('helper', JSON.stringify(helper));
          
          // Also save to localStorage for backup (maintaining original functionality)
          localStorage.setItem('helper_data', JSON.stringify(helper));
          
          console.log(`âœ… FIXED: Saved ${markedResults.length} search results to helper (sessionStorage)`);
          
          // Trigger helper update broadcast if available
          if (typeof window.broadcastHelperUpdate === 'function') {
            window.broadcastHelperUpdate(['parts_search'], 'parts_search_module');
          }
        } catch (e) {
          console.warn('Could not save search results:', e);
        }
      } else {
        alert('×œ× × ××¦××• ×ª×•×¦××•×ª ××ª××™××•×ª');
      }
    }).catch(error => {
      console.error('Search error:', error);
      alert('×©×’×™××” ×‘×—×™×¤×•×© ×—×œ×§×™×');
    }).finally(() => {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    });
  });
</script>
<script>
document.getElementById('sendResultToOCRBtn').addEventListener('click', function () {
  const fileInput = document.getElementById('resultFileUpload');
  const file = fileInput.files[0];
  if (!file) {
    alert('×× × ×”×¢×œ×” ×§×•×‘×¥ ×—×™×¤×•×© ×œ×¤× ×™ ×”×©×œ×™×—×”');
    return;
  }

  // Show processing indicator
  const btn = document.getElementById('sendResultToOCRBtn');
  const originalText = btn.textContent;
  btn.textContent = '××¢×‘×“...';
  btn.disabled = true;

  sendSearchResultFile(file, {
    plate: sessionStorage.getItem('plate') || '',
    model: sessionStorage.getItem('model') || ''
  }).then(results => {
    if (results && results.parts && results.parts.length > 0) {
      displaySearchResults(results.parts);
      alert(`âœ… × ××¦××• ${results.parts.length} ×—×œ×§×™× ×‘×§×•×‘×¥`);
    } else {
      alert('×œ× × ××¦××• ×—×œ×§×™× ×‘×§×•×‘×¥ ××• ×©×’×™××” ×‘×¢×™×‘×•×“');
    }
  }).catch(error => {
    console.error('OCR processing error:', error);
    alert('×©×’×™××” ×‘×¢×™×‘×•×“ ×”×§×•×‘×¥');
  }).finally(() => {
    btn.textContent = originalText;
    btn.disabled = false;
  });
});

</script>
<script type="module">
  import { sendPartSearch, sendSearchResultFile } from './webhook.js';
  import { dev_credentials } from './credentials-vault.js';

  window.sendPartSearch = sendPartSearch;
  window.sendSearchResultFile = sendSearchResultFile;
  window.dev_credentials = dev_credentials;

  // Enhanced search site opening with better UX
  window.openSearchSite = function () {
    const vehicleData = {
      manufacturer: document.getElementById('manufacturer').value,
      model: document.getElementById('model').value,
      year: document.getElementById('year').value
    };
    
    // âœ… FIXED: Use internal browser instead of external redirect
    console.log('ğŸŒ Opening Car-Part in internal browser with vehicle data:', vehicleData);
    
    // âœ… FIXED: Use correct site key for internal browser
    if (typeof window.openInternalBrowser === 'function') {
      try {
        // Use correct site key from internal-browser.js siteConfigs
        window.openInternalBrowser('car-part.co.il', '×—×™×¤×•×© ×—×œ×¤×™×');
      } catch (error) {
        console.error('âŒ Failed to open internal browser:', error);
        showNotification('×©×’×™××” ×‘×¤×ª×™×—×ª ×”×“×¤×“×¤×Ÿ ×”×¤× ×™××™', 'error');
      }
    } else {
      console.error('âŒ Internal browser not available');
      showNotification('×”×“×¤×“×¤×Ÿ ×”×¤× ×™××™ ×œ× ×–××™×Ÿ ×‘××¢×¨×›×ª', 'error');
    }

    const creds = dev_credentials?.carPart;
    if (creds) {
      const message = `ğŸ“‹ ×¤×¨×˜×™ ×’×™×©×” ×œ××ª×¨ Car-Part:\n×©× ××©×ª××©: ${creds.username}\n×¡×™×¡××”: ${creds.password}\n\nğŸš— ×¤×¨×˜×™ ×”×¨×›×‘ ×œ×—×™×¤×•×©:\n${vehicleData.manufacturer} ${vehicleData.model} ${vehicleData.year}`;
      
      // Copy credentials to clipboard if possible
      if (navigator.clipboard) {
        navigator.clipboard.writeText(`${creds.username}\t${creds.password}`).then(() => {
          alert(message + '\n\nâœ… ×¤×¨×˜×™ ×”×’×™×©×” ×”×•×¢×ª×§×• ×œ×œ×•×—');
        }).catch(() => {
          alert(message);
        });
      } else {
        alert(message);
      }
    } else {
      alert('âš ï¸ ×œ× × ××¦××• ×¤×¨×˜×™ ×”×ª×—×‘×¨×•×ª');
    }
  };
  
  // Enhanced result display function
  window.displaySearchResults = function(results) {
    const container = document.getElementById('search_results_display');
    const content = document.getElementById('search_results_content');
    
    if (!results || results.length === 0) {
      container.style.display = 'none';
      return;
    }
    
    content.innerHTML = results.map((result, index) => `
      <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 5px; background: white; cursor: pointer;" 
           onclick="selectSearchResult(${index})">
        <strong>${result.name || result.description || '×—×œ×§ ×œ×œ× ×©×'}</strong>
        ${result.description ? `<br><small>${result.description}</small>` : ''}
        ${result.price ? `<br>××—×™×¨: <span style="color: #28a745; font-weight: bold;">â‚ª${result.price}</span>` : ''}
        ${result.source ? `<br>××§×•×¨: ${result.source}` : ''}
        ${result.supplier ? `<br>×¡×¤×§: ${result.supplier}` : ''}
        <br><small style="color: #007bff;">×œ×—×¥ ×œ×”×•×¡×¤×” ×œ×¨×©×™××”</small>
      </div>
    `).join('');
    
    container.style.display = 'block';
    window.currentSearchResults = results;
  };
  
  window.selectSearchResult = function(index) {
    const result = window.currentSearchResults[index];
    if (!result) return;
    
    // Auto-fill form with selected result
    document.getElementById('part_name').value = result.name || result.description || '';
    if (result.source) {
      document.getElementById('part_source').value = result.source;
    }
    
    // Add to selected parts
    const item = { 
      group: result.category || '××—×™×¤×•×©', 
      name: result.name || result.description || '', 
      qty: 1, 
      source: result.source || '×ª×—×œ×™×¤×™',
      price: result.price || '',
      supplier: result.supplier || ''
    };
    selectedParts.push(item);
    updateSelectedPartsList();
    
    alert('âœ… ×”×—×œ×§ × ×•×¡×£ ×œ×¨×©×™××”');
  };
  
  window.clearSearchResults = function() {
    document.getElementById('search_results_display').style.display = 'none';
    window.currentSearchResults = [];
  };
  
  window.exportSelectedParts = function() {
    if (selectedParts.length === 0) {
      alert('××™×Ÿ ×—×œ×§×™× ×œ×™×™×¦×•×');
      return;
    }
    
    const csv = generatePartsCSV(selectedParts);
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `parts_search_${Date.now()}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };
  
  window.saveToSession = function() {
    if (selectedParts.length === 0) {
      alert('××™×Ÿ ×—×œ×§×™× ×œ×©××™×¨×”');
      return;
    }
    
    try {
      // âœ… FIXED: Use correct sessionStorage location for helper data
      let helper = {};
      try {
        helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      } catch (e) {
        console.warn('Failed to parse helper from sessionStorage, using empty object');
        helper = {};
      }
      
      // Initialize parts_search structure
      helper.parts_search = helper.parts_search || { 
        results: [], 
        all_results: [], 
        search_history: [],
        selected_parts: [],
        unselected_parts: [],
        summary: {}
      };
      
      // Mark selected parts in all_results
      if (helper.parts_search.all_results) {
        helper.parts_search.all_results.forEach(result => {
          const isSelected = selectedParts.some(selected => 
            (selected.name === result.name || selected.name === result.description) &&
            selected.source === result.source
          );
          if (isSelected) {
            result.selected = true;
            result.selected_timestamp = new Date().toISOString();
          }
        });
      }
      
      // Save selected parts to the dedicated selected_parts array
      helper.parts_search.selected_parts = [...(helper.parts_search.selected_parts || []), ...selectedParts];
      
      // Save selected parts to results (for backward compatibility)
      helper.parts_search.results = [...(helper.parts_search.results || []), ...selectedParts];
      
      // Update summary with comprehensive information
      helper.parts_search.summary = {
        total_results: helper.parts_search.results.length,
        total_all_results: helper.parts_search.all_results?.length || 0,
        selected_count: helper.parts_search.selected_parts.length || selectedParts.length,
        total_searches: helper.parts_search.search_history?.length || 0,
        last_updated: new Date().toISOString()
      };
      
      // Update meta information
      helper.meta = helper.meta || {};
      helper.meta.last_updated = new Date().toISOString();
      
      // âœ… FIXED: Save to correct sessionStorage location
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      // Also save to localStorage for backup compatibility
      localStorage.setItem('helper_data', JSON.stringify(helper));
      
      console.log(`âœ… FIXED: Saved ${selectedParts.length} selected parts to helper (sessionStorage)`);
      
      // Trigger helper update broadcast if available
      if (typeof window.broadcastHelperUpdate === 'function') {
        window.broadcastHelperUpdate(['parts_search'], 'parts_save_session');
      }
      
      // Check if opened from estimate builder
      const partSearchTarget = sessionStorage.getItem('partSearchTarget');
      if (partSearchTarget && window.opener) {
        try {
          const target = JSON.parse(partSearchTarget);
          
          // Send selected parts back to estimate builder
          if (selectedParts.length > 0) {
            window.opener.postMessage({
              type: 'PARTS_SELECTED',
              parts: selectedParts,
              target: target
            }, '*');
            
            alert(`âœ… × ×©××¨×• ${selectedParts.length} ×—×œ×§×™× ×•×”×•×¢×‘×¨×• ×œ××•××“×Ÿ`);
            window.close();
            return;
          }
        } catch (e) {
          console.error('Error communicating with estimate builder:', e);
        }
      }
      
      alert(`âœ… × ×©××¨×• ${selectedParts.length} ×—×œ×§×™× ×œ×”××©×š ×‘××©×£`);
    } catch (e) {
      console.error('Error saving to session:', e);
      alert('×©×’×™××” ×‘×©××™×¨×”');
    }
  };
  
  function generatePartsCSV(parts) {
    const headers = ['×§×˜×’×•×¨×™×”', '×©× ×”×—×œ×§', '×›××•×ª', '××§×•×¨', '××—×™×¨', '×¡×¤×§'];
    const rows = parts.map(part => [
      part.group || '',
      part.name || '',
      part.qty || 1,
      part.source || '',
      part.price || '',
      part.supplier || ''
    ]);
    
    return [headers, ...rows].map(row => 
      row.map(field => `"${field}"`).join(',')
    ).join('\n');
  }
  
  function updateSelectedPartsList() {
    const listUI = document.getElementById('selected_parts_list');
    listUI.innerHTML = selectedParts.map((item, index) => `
      <li style="margin-bottom: 5px; padding: 5px; background: #f0f0f0; border-radius: 3px;">
        ${item.group} - ${item.name} | ×›××•×ª: ${item.qty} | ××§×•×¨: ${item.source}
        ${item.price ? ` | ××—×™×¨: â‚ª${item.price}` : ''}
        <button onclick="selectedParts.splice(${index}, 1); updateSelectedPartsList();" 
                style="margin-right: 10px; background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer;">âœ•</button>
      </li>
    `).join('');
  }

  const autofillFields = [
    'plate', 'manufacturer', 'model', 'trim', 'year',
    'engine_volume', 'engine_code', 'engine_type', 'vin'
  ];
  autofillFields.forEach(key => {
    const val = sessionStorage.getItem(key);
    if (val) {
      const input = document.getElementById(key);
      if (input) {
        input.value = val;
        input.readOnly = true;
      }
    }
  });

  const auth = sessionStorage.getItem("auth");
  if (!auth) {
    alert("×”×’×™×©×” ×—×¡×•××” - ×× × ×”×ª×—×‘×¨ ×“×¨×š ×“×£ ×”×‘×™×ª");
    window.location.href = "index.html";
  }

  const logoutBtn = document.querySelector(".logout-btn");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", function (e) {
      e.preventDefault();
      sessionStorage.clear();
      window.location.href = "index.html";
    });
  }
</script>
</body>
</html>
