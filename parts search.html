<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×¤×•×¨×˜×œ - ×—×™×¤×•×© ×—×œ×¤×™×</title>
  <script type="module" src="./parts.js"></script>
  <script type="module" src="./webhook.js"></script>
  <script src="./services/supabaseClient.js"></script>
  <script src="./hebrew-text-normalizer.js"></script>
  <script src="./services/simplePartsSearchService.js"></script>
  <script src="./services/partsSearchSupabaseService.js"></script>
  <script type="module" src="./parts-search-results-pip.js"></script>
  <script type="module" src="./selected-parts-list.js"></script>
  <script type="module" src="./parts-helper-utils.js"></script>
  <script src="./internal-browser.js"></script>

  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link rel="shortcut icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link rel="apple-touch-icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3a8a 0%, #64748b 100%);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      max-width: 720px;
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
      position: relative;

    }
    .logo img {
      width: 120px;
      margin-bottom: 15px;
    }
    .title { font-size: 24px; font-weight: bold; margin-bottom: 5px; color: #1e3a8a; }
    .subtitle { font-size: 18px; color: #64748b; margin-bottom: 5px; }
    .legal-note {
      color: red;
      font-weight: bold;
      margin-bottom: 15px;
    }
    h2 {
      font-size: 20px;
      color: #1e3a8a;
      margin-bottom: 20px;
    }
  .right-small-heading {
    text-align: right;
    font-size: 18px;
    color: #1e3a8a;
   margin-bottom: 18px;
  }

    input, select {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .btn {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background-color: #3b82f6;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
      Margin-bottom: 10px;
    }
    .footer-btns {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    .footer-btns button {
      width: 48%;
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
    .home-btn { background-color: #6c757d; color: white; }
    .logout-btn { background-color: #dc3545; color: white; }
    .footer { font-size: 12px; color: #475569; margin-top: 15px; text-align: center; }
    #previewImage {
      display: none;
      max-width: 100%;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
        max-width: 100%;
      }
      
      /* Stack buttons vertically on mobile */
      div[style*="display: flex"] button {
        min-width: 100% !important;
      }
      
      /* Better touch targets */
      button, .btn {
        min-height: 44px !important;
        font-size: 14px !important;
      }
      
      /* Adjust input fields */
      input[type="text"],
      input[type="number"],
      select {
        font-size: 16px !important; /* Prevents zoom on iOS */
        padding: 10px !important;
      }
      
      h2 {
        font-size: 16px !important;
      }
      
      /* Better spacing on mobile */
      div[style*="margin"] {
        margin: 10px 0 !important;
      }
    }

    @media (max-width: 480px) {
      /* Extra small screens */
      .container {
        padding: 10px;
      }
      
      button, .btn {
        padding: 10px 15px !important;
        font-size: 13px !important;
      }
    }
  </style>
</head>
<body>
<div class="container">
    <div class="logo">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo">
    </div>
    <div class="title">×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×¤×•×¨×˜×œ</div>
    <div class="subtitle">×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</div>
  <h2>×—×™×¤×•×© ×—×œ×¤×™× ×œ×¨×›×‘</h2>
  <form id="partSearchForm">
    <input type="text" id="plate" name="plate" placeholder="××¡×¤×¨ ×¨×™×©×•×™">
    <input type="text" id="manufacturer" name="manufacturer" placeholder="×™×¦×¨×Ÿ">
    <input type="text" id="model" name="model" placeholder="×“×’×">
    <input type="text" id="model_code" name="model_code" placeholder="×§×•×“ ×“×’× (C6, MK7, F30)">
    <input type="text" id="trim" name="trim" placeholder="×¨××ª ×’×™××•×¨">
    <input type="text" id="year" name="year" placeholder="×©× ×”">
    <input type="text" id="engine_volume" name="engine_volume" placeholder="× ×¤×— ×× ×•×¢">
    <input type="text" id="engine_code" name="engine_code" placeholder="×“×’× ×× ×•×¢">
    <input type="text" id="engine_type" name="engine_type" placeholder="×¡×•×’ ×× ×•×¢">
    <input type="text" id="vin" name="vin" placeholder="××¡×¤×¨ ×©×œ×“×”">
    <input type="text" id="oem" name="oem" placeholder="××¡×¤×¨ OEM">
 <input type="text" id="free_query" name="free_query" placeholder="×—×™×¤×•×© ×—×•×¤×©×™">
<h2 class="right-small-heading">×”×¢×œ×”/×¦×œ× ×ª××•× ×” ×œ×—×™×¤×•×© (××•×¤×¦×™×•× ×œ×™)</h2>
    <input type="file" id="part_image" accept="image/*" capture="environment" placeholder="×ª××•× ×ª ×—×œ×§ (××•×¤×¦×™×•× ×œ×™)">
    <img id="previewImage" />
    <select id="part_group" onchange="updatePartNameOptions()">
      <option value="" disabled selected hidden>×‘×—×¨ ×§×‘×•×¦×ª ×—×œ×§×™×</option>
    </select>
    <select id="part_name">
      <option value="" disabled selected hidden>×‘×—×¨ ×—×œ×§</option>
    </select>
<select id="part_source">
  <option value="" disabled selected hidden>×‘×—×¨ ××§×•×¨</option>
  <option value="××§×•×¨×™">××§×•×¨×™</option>
  <option value="×ª×—×œ×™×¤×™">×ª×—×œ×™×¤×™</option>
  <option value="××©×•××©">××©×•××©</option>
  <option value="×”×›×œ">×”×›×œ</option>
</select>
<input type="number" id="part_quantity" placeholder="×›××•×ª" min="1" value="1">

<!-- Action Buttons Row -->
<div style="display: flex; gap: 10px; margin: 15px 0;">
  <button type="button" class="btn" onclick="addFullPart()" style="background: #f59e0b; flex: 1; padding: 12px 20px; border: none; border-radius: 8px; color: white; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);" onmouseover="this.style.background='#d97706'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(245, 158, 11, 0.4)';" onmouseout="this.style.background='#f59e0b'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(245, 158, 11, 0.3)';">â• ×”×•×¡×£ ×—×œ×§ ×œ×¨×©×™××”</button>
  
  <button class="btn" type="button" onclick="searchSupabase()" style="background: #10b981; flex: 1; padding: 12px 20px; border: none; border-radius: 8px; color: white; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);" onmouseover="this.style.background='#059669'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(16, 185, 129, 0.4)';" onmouseout="this.style.background='#10b981'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(16, 185, 129, 0.3)';">ğŸ” ×—×¤×© ×‘×××’×¨ ×”× ×ª×•× ×™×</button>
</div>

<!-- Selected Parts List Header and Display (matching screenshot design) -->
<div style="margin-top: 20px; background: #c5f5e8; padding: 15px; border-radius: 8px; border: 1px solid #10b981;">
  <div style="text-align: center; margin-bottom: 10px;">
    <h3 id="selected_parts_header" style="color: #047857; margin: 0; font-size: 16px; font-weight: bold;">
      ×¨×©×™××ª ×—×œ×§×™× × ×‘×—×¨×™× <span id="selected_parts_count">0</span>
    </h3>
    <p style="color: #059669; margin: 5px 0 0 0; font-size: 12px;">×”×—×œ×§×™× ×™×©××¨×• × ×ª×•× ×™× ×œ×¦×•×¨×š ×—×™×¤×•×© ×‘××ª×¨×™× ×”×—×™×¦×•× ×™×™×</p>
  </div>
  <ul id="selected_parts_list" style="text-align:right; padding-right: 0; font-size: 14px; list-style: none; margin: 0;"></ul>
</div>

<!-- Parts List Management Buttons -->
<div id="parts_management_buttons" style="display: none; margin-top: 10px;">
  <div style="display: flex; gap: 10px;">
    <button type="button" class="btn" onclick="clearCurrentList()" style="background: #10b981; flex: 1; padding: 12px 20px; border: none; border-radius: 8px; color: white; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);" onmouseover="this.style.background='#059669'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(16, 185, 129, 0.4)';" onmouseout="this.style.background='#10b981'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(16, 185, 129, 0.3)';">× ×§×” ×¨×©×™××”</button>
    
    <button type="button" class="btn" onclick="saveCurrentToList()" style="background: #3b82f6; flex: 1; padding: 12px 20px; border: none; border-radius: 8px; color: white; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);" onmouseover="this.style.background='#2563eb'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(59, 130, 246, 0.4)';" onmouseout="this.style.background='#3b82f6'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(59, 130, 246, 0.3)';">ğŸ’¾ ×©××•×¨ ×œ×¨×©×™××”</button>
  </div>
</div>


<!-- Enhanced Search Results Display -->
<div id="search_results_display" style="display: none; margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
  <h3 style="color: #007bff; margin-bottom: 10px;">×ª×•×¦××•×ª ×—×™×¤×•×©</h3>
  <div id="search_results_content"></div>
  <button type="button" class="btn" onclick="clearSearchResults()" style="background: #6c757d; margin-top: 10px;">× ×§×” ×ª×•×¦××•×ª</button>
</div>

<h2 style="text-align: right; font-size: 18px; margin-top: 30px;">×—×™×¤×•×© ×—×œ×¤×™× ×‘××ª×¨</h2>

<!-- External Site Buttons Row -->
<div style="display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap;">
  <button type="button" class="btn" onclick="generateExternalForm()" style="background: #10b981; flex: 1; min-width: 200px; padding: 12px 20px; border: none; border-radius: 8px; color: white; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);" onmouseover="this.style.background='#059669'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(16, 185, 129, 0.4)';" onmouseout="this.style.background='#10b981'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(16, 185, 129, 0.3)';">ğŸš€ ×¦×•×¨ ×˜×•×¤×¡ ×—×›× ×œ××ª×¨ ×—×™×¦×•× ×™</button>
  
  <button type="button" class="btn" onclick="openSearchSite()" style="background: #8b5cf6; flex: 1; min-width: 200px; padding: 12px 20px; border: none; border-radius: 8px; color: white; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 4px rgba(139, 92, 246, 0.3);" onmouseover="this.style.background='#7c3aed'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(139, 92, 246, 0.4)';" onmouseout="this.style.background='#8b5cf6'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(139, 92, 246, 0.3)';">ğŸŒ ×¤×ª×— ××ª×¨ car-part ×œ×—×™×¤×•×©</button>
</div>

<!-- File Upload Section -->
<div style="margin: 15px 0; padding: 15px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
  <label for="resultFileUpload" style="display: block; margin-bottom: 10px; font-weight: 600; color: #374151; font-size: 14px;">×”×¢×œ×” ×ª×•×¦××ª ×—×™×¤×•×© (PDF/×ª××•× ×”)</label>
  <input type="file" id="resultFileUpload" accept=".pdf,.png,.jpg,.jpeg,.html" style="display: block; width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
  <button type="button" class="btn" id="sendResultToOCRBtn" onclick="searchOCR()" style="background: #f59e0b; width: 100%; padding: 10px 20px; border: none; border-radius: 8px; color: white; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);" onmouseover="this.style.background='#d97706'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(245, 158, 11, 0.4)';" onmouseout="this.style.background='#f59e0b'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(245, 158, 11, 0.3)';">ğŸ“¤ ×©×œ×— ×ª×•×¦××ª ×—×™×¤×•×© ×œ× ×™×ª×•×—</button>
</div>

<h2 style="text-align: right; font-size: 18px; margin-top: 30px;">×—×™×¤×•×© ×—×œ×¤×™× ×‘××¢×¨×›×ª ×—×™×¦×•× ×™×ª</h2>
<button class="btn" type="button" onclick="searchWebExternal()" style="background: #3b82f6; width: 100%; padding: 12px 20px; border: none; border-radius: 8px; color: white; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3); margin: 10px 0;" onmouseover="this.style.background='#2563eb'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(59, 130, 246, 0.4)';" onmouseout="this.style.background='#3b82f6'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(59, 130, 246, 0.3)';">ğŸ” ×—×¤×© ×‘××¢×¨×›×ª ×—×™×¦×•× ×™×ª (Make.com)</button>

<!-- Enhanced Part Management -->
<div style="margin-top: 20px;">
  <button type="button" class="btn" onclick="window.TEST_showAllSavedParts()" style="background: #10b981;">ğŸ—‚ï¸ ×”×¦×’ ×¨×©×™××ª ×—×œ×§×™× × ×‘×—×¨×™× ×¢×“×›× ×™×ª</button>
  <button type="button" class="btn" onclick="saveToSession()" style="background: #ffc107; color: #000;">ğŸ’¾ ×©××•×¨ ×œ×”××©×š ×‘××©×£</button>
</div>
  </form>
  <div class="footer-btns">
    <button class="home-btn" onclick="window.location.href='selection.html'">×œ×¢××•×“ ×”×‘×™×ª</button>
    <button class="logout-btn">×™×¦×™××” ××”××¢×¨×›×ª</button>
  </div>
  <div class="footer">All rights reserved Â© Carmel Cayouf</div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
  // âœ… DEBUG: Check internal browser availability on page load
  console.log('ğŸ” Parts Search Page Loaded - Debug Info:');
  console.log('  - openInternalBrowser function available:', typeof window.openInternalBrowser === 'function');
  console.log('  - internal-browser.js loaded:', !!document.querySelector('script[src*="internal-browser"]'));
  if (typeof window.openInternalBrowser === 'function') {
    console.log('  âœ… Internal browser is ready');
  } else {
    console.log('  âŒ Internal browser not available');
    console.log('  - Available window functions containing "Internal":', Object.keys(window).filter(k => k.toLowerCase().includes('internal')));
    console.log('  - Available window functions containing "Browser":', Object.keys(window).filter(k => k.toLowerCase().includes('browser')));
    
    // âœ… RETRY: Try to manually load internal browser if not available
    console.log('  ğŸ”„ Attempting to manually load internal browser...');
    const scriptExists = document.querySelector('script[src*="internal-browser"]');
    if (!scriptExists) {
      const script = document.createElement('script');
      script.src = './internal-browser.js';
      script.onload = () => {
        console.log('  âœ… Internal browser manually loaded');
      };
      script.onerror = () => {
        console.log('  âŒ Failed to manually load internal browser');
      };
      document.head.appendChild(script);
    }
  }
  
  // ENHANCED: Auto-populate vehicle data from helper
  function populateVehicleDataFromHelper() {
    console.log('ğŸš— Parts Search: Auto-populating vehicle data from helper...');
    
    try {
      const helperString = sessionStorage.getItem('helper');
      if (helperString) {
        const helper = JSON.parse(helperString);
        console.log('âœ… Helper data loaded for parts search:', helper);
        
        // Populate form fields with helper data using corrected field mapping
        const fieldMappings = {
          'plate': helper.vehicle?.plate || helper.meta?.plate,
          'manufacturer': helper.vehicle?.manufacturer,
          'model': helper.vehicle?.model,
          'model_code': helper.vehicle?.vehicle_model_code || helper.vehicle?.model_code || '', // Fixed: use vehicle_model_code
          'trim': helper.vehicle?.trim,
          'year': helper.vehicle?.year,
          'engine_volume': helper.vehicle?.engine_volume,
          'engine_code': helper.vehicle?.engine_model, // Fixed: use engine_model instead of model_code
          'engine_type': helper.vehicle?.fuel_type, // Fixed: use fuel_type instead of engine_model
          'vin': helper.vehicle?.chassis,
          'oem': helper.vehicle?.oem || ''
        };
        
        // Apply the mappings
        Object.entries(fieldMappings).forEach(([fieldId, value]) => {
          const element = document.getElementById(fieldId);
          if (element && value) {
            element.value = value;
            console.log(`  âœ… ${fieldId}: "${value}"`);
          }
        });
        
        console.log('âœ… Parts search auto-population completed');
      } else {
        console.log('âš ï¸ No helper data found in sessionStorage');
      }
    } catch (error) {
      console.error('âŒ Error auto-populating vehicle data:', error);
    }
  }
  
  // Auto-populate on page load
  populateVehicleDataFromHelper();
  
  // SESSION 20 TASK 4: Auto-sync Supabaseâ†’helper on page load
  setTimeout(async () => {
    console.log('ğŸ”„ SESSION 20: Starting auto-sync from Supabase to helper...');
    
    try {
      // SESSION 24: Ensure window.helper is loaded from sessionStorage first
      if (!window.helper) {
        const helperString = sessionStorage.getItem('helper');
        if (helperString) {
          window.helper = JSON.parse(helperString);
          console.log('âœ… SESSION 24: Loaded window.helper from sessionStorage for sync');
        } else {
          window.helper = {};
          console.log('âš ï¸ SESSION 24: No helper in sessionStorage, initialized empty');
        }
      }
      
      const plate = window.helper?.meta?.plate || window.helper?.meta?.license_plate;
      
      if (plate && window.supabase && typeof getSelectedParts === 'function') {
        console.log('ğŸ“¦ SESSION 20: Loading parts from Supabase for plate:', plate);
        
        const supabaseParts = await getSelectedParts({ plate: plate });
        
        if (!window.helper.parts_search) {
          window.helper.parts_search = {};
        }
        
        if (supabaseParts && supabaseParts.length > 0) {
          console.log(`âœ… SESSION 20: Found ${supabaseParts.length} parts in Supabase`);
          
          // SESSION 20 FIX: Map Supabase fields to helper format (including comments field)
          const mappedParts = supabaseParts.map(part => ({
            ...part,
            // Map part_name/part_family to name/group for helper compatibility
            name: part.part_name || part.name || '',
            group: part.part_family || part.group || '',
            qty: part.quantity || part.qty || 1,
            // Map comments field
            comments: part.comments || '',
            // Keep original Supabase fields too
            part_name: part.part_name,
            part_family: part.part_family,
            quantity: part.quantity
          }));
          
          window.helper.parts_search.selected_parts = mappedParts;
          
          sessionStorage.setItem('helper', JSON.stringify(window.helper));
          console.log(`ğŸ’¾ SESSION 20: Synced ${mappedParts.length} parts from Supabase to helper (with field mapping)`);
        } else {
          // SESSION 24: Clear helper if Supabase has no parts (handles deletions)
          console.log('â„¹ï¸ SESSION 24: No parts in Supabase - clearing helper.parts_search.selected_parts');
          window.helper.parts_search.selected_parts = [];
          sessionStorage.setItem('helper', JSON.stringify(window.helper));
          console.log('ğŸ’¾ SESSION 24: Helper cleared to match empty Supabase state');
        }
      } else {
        console.log('âš ï¸ SESSION 20: Auto-sync skipped - missing plate, Supabase, or getSelectedParts function');
      }
    } catch (error) {
      console.error('âŒ SESSION 20: Error during auto-sync:', error);
    }
    
    // SESSION 17 TASK 2: Update selected parts list UI after helper loads
    if (typeof updateSelectedPartsList === 'function') {
      updateSelectedPartsList();
      console.log('âœ… SESSION 17: Updated selected parts list UI on page load');
    } else {
      console.warn('âš ï¸ SESSION 17: updateSelectedPartsList not available yet');
    }
  }, 100);
  
  // Listen for helper updates
  window.addEventListener('storage', (e) => {
    if (e.key === 'helper') {
      console.log('ğŸ”„ Helper data updated, re-populating parts search...');
      populateVehicleDataFromHelper();
      // SESSION 17 TASK 2: Also update parts list when helper changes
      if (typeof updateSelectedPartsList === 'function') {
        updateSelectedPartsList();
      }
    }
  });

  const groupSelect = document.getElementById('part_group');
  const nameSelect = document.getElementById('part_name');

  if (!window.PARTS_BANK) {
    alert("×—×¡×¨ ×§×•×‘×¥ ×—×œ×§×™× ××• ×©×”×˜×¢×™× ×” × ×›×©×œ×”");
    return;
  }

  for (const group in window.PARTS_BANK) {
    const option = document.createElement('option');
    option.value = group;
    option.textContent = group;
    groupSelect.appendChild(option);
  }

  groupSelect.addEventListener('change', () => {
    nameSelect.innerHTML = '<option value="" disabled selected hidden>×‘×—×¨ ×—×œ×§</option>';
    const selectedCategory = groupSelect.value;
    const parts = window.PARTS_BANK[selectedCategory] || [];
    
    console.log(`ğŸ” Loading ${parts.length} parts for category: ${selectedCategory}`);
    
    parts.forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      opt.setAttribute('data-category', selectedCategory);
      nameSelect.appendChild(opt);
    });
    
    // ğŸ¯ CREATIVE: Visual feedback for category loading
    showNotification(`× ×˜×¢× ×• ${parts.length} ×—×œ×§×™× ×¢×‘×•×¨ ${selectedCategory}`, 'info');
    autoSaveSearchProgress();
  });
  
  // ğŸ¯ CREATIVE ENHANCEMENTS: Smart features for parts search
  
  // Smart notification system
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    const colors = {
      success: '#10b981',
      info: '#3b82f6', 
      warning: '#f59e0b',
      error: '#ef4444'
    };
    
    notification.style.cssText = `
      position: fixed; top: 20px; right: 20px; z-index: 9999;
      background: ${colors[type]}; color: white; padding: 12px 16px;
      border-radius: 8px; font-size: 14px; font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateX(100%); transition: transform 0.3s ease;
      max-width: 300px; direction: rtl;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    setTimeout(() => notification.style.transform = 'translateX(0)', 100);
    setTimeout(() => {
      notification.style.transform = 'translateX(100%)';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }
  
  // Auto-save search progress
  function autoSaveSearchProgress() {
    const plateValue = document.getElementById('plate').value;
    
    // SESSION 14 TASK 3 FIX: Save plate to sessionStorage for page refresh persistence
    if (plateValue) {
      sessionStorage.setItem('lastSearchedPlate', plateValue);
      console.log('ğŸ’¾ SESSION 14: Saved plate to session:', plateValue);
    }
    
    const searchData = {
      vehicle: {
        plate: plateValue,
        manufacturer: document.getElementById('manufacturer').value,
        model: document.getElementById('model').value,
        year: document.getElementById('year').value,
        engine_volume: document.getElementById('engine_volume').value
      },
      parts: {
        group: document.getElementById('part_group').value,
        name: document.getElementById('part_name').value,
        source: document.getElementById('part_source').value,
        quantity: document.getElementById('part_quantity').value
      },
      timestamp: new Date().toISOString()
    };
    
    sessionStorage.setItem('partsSearchProgress', JSON.stringify(searchData));
    console.log('ğŸ’¾ Auto-saved search progress');
  }
  
  // ğŸ¯ SMART FORM BUILDER for external sites - ENHANCED to capture ALL parts
  window.generateExternalForm = function() {
    const vehicle = {
      manufacturer: document.getElementById('manufacturer').value,
      model: document.getElementById('model').value,
      year: document.getElementById('year').value,
      engine_volume: document.getElementById('engine_volume').value
    };
    
    // SESSION 20: Smart form uses search_query_list (parts TO SEARCH)
    // Get all parts from search query list
    let partsToExport = [];
    const searchQueryList = window.helper?.parts_search?.search_query_list || [];
    
    if (searchQueryList.length > 0) {
      partsToExport = [...searchQueryList];
    }
    
    // Also add current form part if filled
    const currentPart = {
      group: document.getElementById('part_group').value,
      name: document.getElementById('part_name').value,
      source: document.getElementById('part_source').value,
      quantity: document.getElementById('part_quantity').value || 1
    };
    
    if (currentPart.group && currentPart.name) {
      // Check if not already in list
      const isDuplicate = partsToExport.some(p => 
        p.group === currentPart.group && 
        p.name === currentPart.name
      );
      if (!isDuplicate) {
        partsToExport.push(currentPart);
      }
    }
    
    if (!vehicle.manufacturer || !vehicle.model) {
      showNotification('×× × ××œ× ××ª ×¤×¨×˜×™ ×”×¨×›×‘', 'warning');
      return;
    }
    
    if (partsToExport.length === 0) {
      showNotification('×× × ×”×•×¡×£ ×œ×¤×—×•×ª ×—×œ×§ ××—×“ ×œ×¨×©×™××”', 'warning');
      return;
    }
    
    showExternalFormModal(vehicle, partsToExport);
  };
  
  function showExternalFormModal(vehicle, parts) {
    // âœ… ENHANCED: Handle multiple parts in smart form
    const partsArray = Array.isArray(parts) ? parts : [parts];
    const totalParts = partsArray.length;
    
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); display: flex; align-items: center;
      justify-content: center; z-index: 10000; direction: rtl;
    `;
    
    // Generate parts list HTML
    const partsListHTML = partsArray.map((part, index) => `
      <div style="background: #ecfdf5; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #10b981;">
        <strong>×—×œ×§ ${index + 1}:</strong><br>
        ×§×˜×’×•×¨×™×”: <strong>${part.group}</strong><br>
        ${part.name ? `×©× ×”×—×œ×§: <strong>${part.name}</strong><br>` : ''}
        ${part.source ? `××§×•×¨: <strong>${part.source}</strong><br>` : ''}
        ×›××•×ª: <strong>${part.quantity || part.qty || 1}</strong>
        ${part.price ? `<br>××—×™×¨ ××©×•×¢×¨: <strong>${part.price}</strong>` : ''}
        ${part.supplier ? `<br>×¡×¤×§: <strong>${part.supplier}</strong>` : ''}
      </div>
    `).join('');
    
    modal.innerHTML = `
      <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
        <h3 style="color: #1e3a8a; margin-bottom: 20px; text-align: center;">ğŸ” ×˜×•×¤×¡ ×—×›× ×œ××ª×¨ ×—×œ×¤×™× ×—×™×¦×•× ×™</h3>
        
        <div style="background: #f0f9ff; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
          <strong>×¤×¨×˜×™ ×”×¨×›×‘:</strong><br>
          ×™×¦×¨×Ÿ: <strong>${vehicle.manufacturer}</strong><br>
          ×“×’×: <strong>${vehicle.model}</strong><br>
          ×©× ×”: <strong>${vehicle.year}</strong><br>
          × ×¤×— ×× ×•×¢: <strong>${vehicle.engine_volume}</strong>
        </div>
        
        <div style="margin-bottom: 20px;">
          <strong style="color: #10b981;">×—×œ×§×™× ××‘×•×§×©×™× (${totalParts}):</strong><br>
          ${partsListHTML}
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
          <button onclick="copyFormData('${JSON.stringify({vehicle, parts: partsArray}).replace(/"/g, '&quot;')}')" 
                  style="background: #3b82f6; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
            ğŸ“‹ ×”×¢×ª×§ × ×ª×•× ×™×
          </button>
          <button onclick="openSearchSite(); this.closest('[style*=fixed]').remove();" 
                  style="background: #10b981; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
            ğŸŒ ×¤×ª×— Car-Part
          </button>
          <button onclick="this.closest('[style*=fixed]').remove()" 
                  style="background: #6b7280; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer;">
            âœ• ×¡×’×•×¨
          </button>
        </div>
      </div>
    `;
    
    modal.onclick = (e) => e.target === modal && modal.remove();
    document.body.appendChild(modal);
  }
  
  window.copyFormData = function(dataStr) {
    const data = JSON.parse(dataStr.replace(/&quot;/g, '"'));
    
    // âœ… ENHANCED: Handle multiple parts in copy function
    let text = `×¤×¨×˜×™ ×¨×›×‘:
×™×¦×¨×Ÿ: ${data.vehicle.manufacturer}
×“×’×: ${data.vehicle.model}
×©× ×”: ${data.vehicle.year}
× ×¤×— ×× ×•×¢: ${data.vehicle.engine_volume}

×—×œ×§×™× ××‘×•×§×©×™× (${data.parts ? data.parts.length : 1}):
`;
    
    if (data.parts && Array.isArray(data.parts)) {
      // Multiple parts
      data.parts.forEach((part, index) => {
        text += `${index + 1}. ${part.group} - ${part.name || ''}
   ××§×•×¨: ${part.source || ''}
   ×›××•×ª: ${part.quantity || part.qty || 1}
${part.price ? `   ××—×™×¨ ××©×•×¢×¨: ${part.price}` : ''}
${part.supplier ? `   ×¡×¤×§: ${part.supplier}` : ''}

`;
      });
    } else if (data.part) {
      // Single part (legacy support)
      text += `1. ${data.part.group} - ${data.part.name || ''}
   ××§×•×¨: ${data.part.source || ''}
   ×›××•×ª: ${data.part.quantity}`;
    }
    
    navigator.clipboard.writeText(text).then(() => {
      showNotification('× ×ª×•× ×™× ×”×•×¢×ª×§×• ×‘×”×¦×œ×—×”!', 'success');
    }).catch(() => {
      showNotification('×©×’×™××” ×‘×”×¢×ª×§×”', 'error');
    });
  };
  
  // Auto-save on form changes
  document.querySelectorAll('input, select').forEach(element => {
    element.addEventListener('change', autoSaveSearchProgress);
  });
  
  });

  let imageBase64 = null;
  document.getElementById('part_image').addEventListener('change', function () {
    const file = this.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function (e) {
      imageBase64 = e.target.result;
      const img = document.getElementById('previewImage');
      img.src = imageBase64;
      img.style.display = 'block';
    };
    reader.readAsDataURL(file);
  });
</script>
<script>
  // ========================================
  // SESSION 19: NEW ARCHITECTURE
  // Two distinct functions replace legacy selectedParts array
  // ========================================

  // FUNCTION 1: captureQueryData()
  // Purpose: Capture search query + car details for search operations
  // Returns: Query object for Supabase search, webhook, and search_session table
  function captureQueryData() {
    console.log('ğŸ“Š SESSION 19: Capturing query data...');
    
    // Primary source: Form DOM elements
    const plateInput = document.getElementById('license_plate');
    const makeInput = document.getElementById('manufacturer');
    const modelInput = document.getElementById('model');
    const yearInput = document.getElementById('year');
    const searchTypeSimple = document.getElementById('simple_search');
    const searchTypeAdvanced = document.getElementById('advanced_search');
    
    // Fallback source: helper object
    const helper = window.helper || {};
    const meta = helper.meta || {};
    const vehicle = helper.vehicle || {};
    
    // Build query object with fallbacks
    const queryData = {
      // Car details
      plate: plateInput?.value || meta.plate || meta.license_plate || '',
      make: makeInput?.value || meta.make || vehicle.manufacturer || '',
      model: modelInput?.value || meta.model || vehicle.model || '',
      year: yearInput?.value || meta.year || vehicle.year || '',
      
      // Search type
      search_type: searchTypeAdvanced?.checked ? 'advanced' : 'simple',
      
      // Search parameters (from active search type)
      search_term: '',
      filters: {},
      
      // Metadata
      timestamp: new Date().toISOString(),
      session_id: helper.session_id || `session_${Date.now()}`
    };
    
    // Get search term based on search type
    if (queryData.search_type === 'simple') {
      const simpleTermInput = document.getElementById('simple_search_term');
      queryData.search_term = simpleTermInput?.value || '';
    } else {
      const advancedTermInput = document.getElementById('advanced_search_term');
      queryData.search_term = advancedTermInput?.value || '';
      
      // Advanced filters (if applicable)
      const partGroupInput = document.getElementById('part_group_filter');
      const partCodeInput = document.getElementById('part_code_filter');
      
      queryData.filters = {
        part_group: partGroupInput?.value || '',
        part_code: partCodeInput?.value || ''
      };
    }
    
    // Validation: Check required fields
    if (!queryData.plate) {
      console.warn('âš ï¸ captureQueryData: Missing plate number');
    }
    
    console.log('âœ… SESSION 19: Query data captured:', queryData);
    return queryData;
  }

  // FUNCTION 2: getSelectedParts()
  // Purpose: Retrieve cumulative selected parts from Supabase (source of truth)
  // Returns: Promise<Array> of parts or empty array
  let partsCache = null;
  let cacheTimestamp = null;
  const CACHE_DURATION = 30000; // 30 seconds

  async function getSelectedParts(options = {}) {
    console.log('ğŸ“¦ SESSION 19: Getting selected parts...', options);
    
    const {
      plate = null,
      filter = null,
      limit = null,
      offset = 0
    } = options;
    
    // Determine plate to query
    const queryPlate = plate || 
                       document.getElementById('license_plate')?.value || 
                       window.helper?.meta?.plate || 
                       window.helper?.meta?.license_plate;
    
    if (!queryPlate) {
      console.warn('âš ï¸ getSelectedParts: No plate number available');
      return [];
    }
    
    // Check cache (30 seconds)
    const now = Date.now();
    if (partsCache && cacheTimestamp && (now - cacheTimestamp) < CACHE_DURATION) {
      console.log('âœ… SESSION 19: Using cached parts data');
      return filterParts(partsCache, filter, limit, offset);
    }
    
    try {
      // Primary source: Supabase selected_parts table
      console.log('ğŸ” SESSION 19: Querying Supabase for plate:', queryPlate);
      
      const { data, error } = await window.supabase
        .from('selected_parts')
        .select('*')
        .eq('plate', queryPlate)
        .order('selected_at', { ascending: false });
      
      if (error) {
        console.error('âŒ SESSION 19: Supabase query error:', error);
        throw error;
      }
      
      console.log(`ğŸ“Š SESSION 24: Supabase query result for plate "${queryPlate}":`, {
        rowCount: data?.length || 0,
        hasData: !!data,
        hasError: !!error
      });
      
      // SESSION 24: If no results, query ALL plates to help debug
      if ((!data || data.length === 0) && !error) {
        try {
          const { data: allPlates } = await window.supabase
            .from('selected_parts')
            .select('plate')
            .limit(20);
          const uniquePlates = [...new Set(allPlates?.map(p => p.plate) || [])];
          console.log('ğŸ” SESSION 24: Found these plates in selected_parts table:', uniquePlates);
          console.log('ğŸ’¡ Your query plate:', queryPlate);
        } catch (e) {
          console.log('âš ï¸ Could not fetch plate list:', e.message);
        }
      }
      
      if (data && data.length > 0) {
        console.log(`âœ… SESSION 19: Retrieved ${data.length} parts from Supabase`);
        console.log('ğŸ“‹ First part sample:', data[0]);
        
        // Update cache
        partsCache = data;
        cacheTimestamp = now;
        
        return filterParts(data, filter, limit, offset);
      }
      
      console.log('â„¹ï¸ SESSION 19: No parts found in Supabase for plate:', queryPlate);
      console.log('ğŸ’¡ TIP: Check if plate format matches (with/without dashes)');
      return [];
      
    } catch (error) {
      console.error('âŒ SESSION 19: Error querying Supabase, falling back to helper:', error);
      
      // Fallback: helper.parts_search.selected_parts
      const helperParts = window.helper?.parts_search?.selected_parts || [];
      
      if (helperParts.length > 0) {
        console.log(`âœ… SESSION 19: Using fallback helper data (${helperParts.length} parts)`);
        return filterParts(helperParts, filter, limit, offset);
      }
      
      console.log('â„¹ï¸ SESSION 19: No parts in fallback helper either');
      return [];
    }
  }

  // SESSION 24: Export to global scope for smart sync access
  window.getSelectedParts = getSelectedParts;

  // Helper function: Filter parts by text and apply pagination
  function filterParts(parts, filter, limit, offset) {
    let filtered = parts;
    
    // Apply text filter if provided
    if (filter && filter.trim() !== '') {
      const filterLower = filter.toLowerCase();
      filtered = parts.filter(part => {
        return (
          (part.name && part.name.toLowerCase().includes(filterLower)) ||
          (part.group && part.group.toLowerCase().includes(filterLower)) ||
          (part.pcode && part.pcode.toLowerCase().includes(filterLower)) ||
          (part.oem && part.oem.toLowerCase().includes(filterLower))
        );
      });
      console.log(`ğŸ” SESSION 19: Filter "${filter}" matched ${filtered.length} parts`);
    }
    
    // Apply pagination if limit provided
    if (limit) {
      filtered = filtered.slice(offset, offset + limit);
    } else if (offset > 0) {
      filtered = filtered.slice(offset);
    }
    
    return filtered;
  }

  // Clear cache function (call when parts are modified)
  function clearPartsCache() {
    console.log('ğŸ—‘ï¸ SESSION 19: Clearing parts cache');
    partsCache = null;
    cacheTimestamp = null;
  }

  // ========================================
  // END SESSION 19 NEW FUNCTIONS
  // ========================================

  const listUI = document.getElementById('selected_parts_list');

  async function addFullPart() {
    const group = document.getElementById('part_group').value;
    const name = document.getElementById('part_name').value;
    const qty = document.getElementById('part_quantity').value || '1';
    const source = document.getElementById('part_source').value || '××§×•×¨×™';

    if (!group || !name) {
      alert("×™×© ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ×§×‘×•×¦×ª ×—×œ×§×™× ×•×©× ×—×œ×§");
      return;
    }

    // SESSION 20: Add to search_query_list (for smart form), NOT to selected parts
    if (!window.helper) window.helper = {};
    if (!window.helper.parts_search) window.helper.parts_search = {};
    if (!window.helper.parts_search.search_query_list) {
      window.helper.parts_search.search_query_list = [];
    }

    // Check for duplicates in search query list
    const searchList = window.helper.parts_search.search_query_list;
    const isDuplicate = searchList.some(existing => 
      existing.group === group && 
      existing.name === name && 
      existing.source === source
    );
    
    if (isDuplicate) {
      alert("×—×œ×§ ×–×” ×›×‘×¨ ×§×™×™× ×‘×¨×©×™××ª ×”×—×™×¤×•×©");
      return;
    }

    const item = { 
      group, 
      name, 
      qty: parseInt(qty), 
      source,
      id: `query_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      added_at: new Date().toISOString()
    };
    
    window.helper.parts_search.search_query_list.push(item);
    
    // Save to sessionStorage
    sessionStorage.setItem('helper', JSON.stringify(window.helper));

    // Clear form for next entry
    document.getElementById('part_name').value = '';
    document.getElementById('part_quantity').value = '1';
    document.getElementById('part_source').value = '';
    
    // Visual feedback
    console.log(`âœ… SESSION 20: Added part to search_query_list (for smart form): ${group} - ${name} (${qty}x ${source})`);
    
    // Show notification
    if (typeof showNotification === 'function') {
      showNotification(`× ×•×¡×£ ×œ×¨×©×™××ª ×—×™×¤×•×©: ${name}`, 'success');
    } else {
      alert(`× ×•×¡×£ ×œ×¨×©×™××ª ×—×™×¤×•×©: ${name}\n\n×›×¢×ª × ×™×ª×Ÿ ×œ×™×¦×•×¨ ×˜×•×¤×¡ ×—×›× ×¢× ${searchList.length} ×—×œ×§×™×`);
    }
  }
  
  // âœ… NEW: Send current parts list to Make.com for processing
  
  // âœ… NEW: Supabase Search Function for PiP Integration
  async function searchSupabase() {
    console.log('ğŸ” Starting Supabase search...');
    console.log('ğŸ” DEBUG: Checking dependencies at search start...');
    console.log('  - window.SmartPartsSearchService:', typeof window.SmartPartsSearchService);
    console.log('  - window.partsResultsPiP:', typeof window.partsResultsPiP);
    console.log('  - window.supabase:', typeof window.supabase);
    
    // Get button reference outside try block
    const supabaseBtn = document.querySelector('button[onclick="searchSupabase()"]');
    const originalText = supabaseBtn ? supabaseBtn.innerHTML : '';
    
    manageSearchButtons('catalog');
    
    try {
      // SESSION 24: Ensure helper structure exists before search
      if (!window.helper) window.helper = {};
      if (!window.helper.parts_search) {
        window.helper.parts_search = {
          results: [],
          current_selected_list: [],
          selected_parts: []
        };
      }
      if (!window.helper.parts_search.current_selected_list) {
        window.helper.parts_search.current_selected_list = [];
      }
      
      // Show loading state
      if (supabaseBtn) {
        supabaseBtn.innerHTML = 'â³ ××—×¤×© ×‘×××’×¨ ×”× ×ª×•× ×™×...';
      }
      
      // Critical dependency check
      if (typeof window.SmartPartsSearchService === 'undefined') {
        throw new Error('SmartPartsSearchService not loaded - check script include');
      }
      
      if (typeof window.partsResultsPiP === 'undefined') {
        throw new Error('PartsResultsPiP not loaded - check script include');
      }
      
      // Get form data
      const searchParams = {
        plate: document.getElementById('plate').value,
        manufacturer: document.getElementById('manufacturer').value,
        model: document.getElementById('model').value,
        model_code: document.getElementById('model_code').value,
        trim: document.getElementById('trim').value,
        year: document.getElementById('year').value,
        engine_volume: document.getElementById('engine_volume').value,
        engine_code: document.getElementById('engine_code').value,
        engine_type: document.getElementById('engine_type').value,
        vin: document.getElementById('vin').value,
        oem: document.getElementById('oem').value,
        part_group: document.getElementById('part_group').value,
        part_name: document.getElementById('part_name').value,
        free_query: document.getElementById('free_query').value,
        selectedParts: window.helper?.parts_search?.current_selected_list || []
      };
      
      console.log('ğŸ“‹ Search params:', searchParams);
      
      // Use new simplified search service
      console.log('ğŸ“¦ Initializing SimplePartsSearchService...');
      const searchService = new window.SimplePartsSearchService();
      console.log('âœ… SimplePartsSearchService initialized');
      
      // Show loading notification
      if (typeof showNotification === 'function') {
        showNotification('××—×¤×© ×‘×§×˜×œ×•×’...', 'info');
      }
      console.log('ğŸ”„ About to call smart search...');
      
      // Perform search with new service
      const result = await searchService.searchParts(searchParams);
      
      console.log('ğŸ” Search result:', result);
      console.log('  - Error:', result.error);
      console.log('  - Data length:', result.data ? result.data.length : 'null');
      console.log('  - Search time:', result.searchTime);
      
      // Always show PiP window regardless of results
      console.log('ğŸªŸ About to show PiP window...');
      console.log('  - PiP component available:', !!window.partsResultsPiP);
      
      if (window.partsResultsPiP) {
        const resultsToShow = result.data || [];
        const searchSuccess = !result.error && resultsToShow.length >= 0;
        console.log(`ğŸ“‹ Showing PiP with ${resultsToShow.length} results...`);
        console.log('  - Search success:', searchSuccess);
        console.log('  - Error message:', result.error ? result.error.message : 'None');
        
        // SESSION 9: Include BOTH metadata AND actual search parameters
        const pipContext = {
          // Metadata
          plate: searchParams.plate,
          sessionId: searchService.getSessionId() || 'no-session',
          searchType: 'smart_search',
          dataSource: '×§×˜×œ×•×’',
          searchSuccess: searchSuccess,
          errorMessage: result.error ? result.error.message : null,
          searchTime: result.searchTime || 0,
          // ACTUAL search parameters for Supabase
          searchParams: searchParams // Include full search params
        };
        
        console.log('ğŸ“‹ PiP context:', pipContext);
        
        await window.partsResultsPiP.showResults(resultsToShow, pipContext);
        console.log('âœ… PiP showResults completed successfully');
        
        // Success feedback
        if (!result.error && result.data && result.data.length > 0) {
          console.log('âœ… Smart search successful:', result.data.length, 'results');
          
          if (typeof showNotification === 'function') {
            showNotification(`× ××¦××• ${result.data.length} ×ª×•×¦××•×ª`, 'success');
          }
        } else if (result.error) {
          console.log('âš ï¸ Search completed with error:', result.error.message);
          if (typeof showNotification === 'function') {
            showNotification(`×©×’×™××”: ${result.error.message}`, 'error');
          }
        } else {
          console.log('â„¹ï¸ Search completed with no results');
          if (typeof showNotification === 'function') {
            showNotification('×œ× × ××¦××• ×ª×•×¦××•×ª', 'warning');
          }
        }
        
      } else {
        console.error('âŒ PiP component not available');
        throw new Error('×¨×›×™×‘ ×”×ª×•×¦××•×ª ×œ× ×–××™×Ÿ - ×‘×“×•×§ ×˜×¢×™× ×ª ×”×¡×§×¨×™×¤×˜×™×');
      }
      
    } catch (error) {
      console.error('âŒ Critical search error:', error);
      console.error('  - Error stack:', error.stack);
      
      // Detailed error reporting
      const errorDetails = {
        message: error.message,
        stack: error.stack,
        dependencies: {
          SmartPartsSearchService: typeof window.SmartPartsSearchService,
          partsResultsPiP: typeof window.partsResultsPiP,
          supabase: typeof window.supabase
        },
        timestamp: new Date().toISOString()
      };
      
      console.error('ğŸ“Š Error details:', errorDetails);
      
      // User-friendly error message
      alert(`×©×’×™××” ×‘×—×™×¤×•×©: ${error.message}\n\n×¤×¨×˜×™× × ×•×¡×¤×™× ×‘×§×•× ×¡×•×œ ×”×“×¤×“×¤×Ÿ (F12)`);
      
      // Fallback option
      if (confirm('×©×’×™××” ×‘×—×™×¤×•×© ×‘×§×˜×œ×•×’. ×”×× ×œ× ×¡×•×ª ×‘××¢×¨×›×ª ×”×—×™×¦×•× ×™×ª?')) {
        try {
          document.getElementById('partSearchForm').dispatchEvent(new Event('submit'));
        } catch (fallbackError) {
          console.error('âŒ Fallback also failed:', fallbackError);
          alert('×’× ×”××¢×¨×›×ª ×”×—×™×¦×•× ×™×ª × ×›×©×œ×”. × ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£.');
        }
      }
    } finally {
      // Restore button state
      console.log('ğŸ”„ Restoring button state...');
      if (supabaseBtn) {
        supabaseBtn.innerHTML = originalText;
      }
      manageSearchButtons(null);
      console.log('âœ… Button state restored');
    }
  }

  // SESSION 21: Excel export functionality removed
  
  // âœ… FIX 2: Enhanced helper integration with 3-category system
  function updateHelperWithPartsSearch(searchResults, searchContext) {
    try {
      let helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Initialize enhanced parts_search structure
      if (!helper.parts_search) {
        helper.parts_search = {
          selected_parts: [],
          unselected_parts: [],
          global_parts_bank: { all_parts: [] },
          current_session: { results: [] },
          case_search_history: [],
          case_summary: {
            total_searches: 0,
            total_results: 0,
            selected_count: 0,
            unselected_count: 0,
            last_search: '',
            estimated_total_cost: 0
          }
        };
      }
      
      // Add search results to all categories
      if (searchResults && searchResults.length > 0) {
        // Mark as unselected initially
        const markedResults = searchResults.map(part => ({
          ...part,
          id: `part_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          selected: false,
          search_timestamp: new Date().toISOString(),
          search_context: searchContext
        }));
        
        // Add to unselected_parts and global bank
        helper.parts_search.unselected_parts.push(...markedResults);
        helper.parts_search.global_parts_bank.all_parts.push(...markedResults);
        helper.parts_search.current_session.results = markedResults;
        
        // Update summary
        helper.parts_search.case_summary = {
          ...helper.parts_search.case_summary,
          total_results: helper.parts_search.global_parts_bank.all_parts.length,
          unselected_count: helper.parts_search.unselected_parts.length,
          last_search: new Date().toISOString()
        };
      }
      
      // Save updated helper
      sessionStorage.setItem('helper', JSON.stringify(helper));
      localStorage.setItem('helper_data', JSON.stringify(helper));
      
      console.log('âœ… Helper updated with enhanced parts search structure');
      
      return helper;
    } catch (error) {
      console.error('âŒ Error updating helper:', error);
      return null;
    }
  }
  
  // SESSION 19: Enhanced validation using current_selected_list
  function validateSearchForm() {
    // SESSION 19: Get parts count from current_selected_list
    const currentList = window.helper?.parts_search?.current_selected_list || [];
    const selectedPartsCount = currentList.length;
    const freeQuery = document.getElementById('free_query').value.trim();
    const hasImage = imageBase64 !== null;
    const hasVehicleData = document.getElementById('manufacturer').value.trim() !== '';
    const hasPartGroup = document.getElementById('part_group').value.trim() !== '';
    const hasPartName = document.getElementById('part_name').value.trim() !== '';
    
    console.log('ğŸ” Validation check:', {
      selectedPartsCount,
      freeQuery,
      hasImage,
      hasVehicleData,
      hasPartGroup,
      hasPartName
    });
    
    // Rule 1: External site search - requires parts list
    // (This is handled in the external site functions)
    
    // Rule 2: System/Image search - requires one of: free search field, parts list, part selection, OR image
    const hasSearchCriteria = freeQuery || selectedPartsCount > 0 || hasImage || (hasPartGroup && hasPartName);
    
    if (!hasSearchCriteria) {
      alert('×™×© ×œ××œ× ×œ×¤×—×•×ª ××—×“ ××”×©×“×•×ª ×”×‘××™×:\nâ€¢ ×—×™×¤×•×© ×—×•×¤×©×™\nâ€¢ ×‘×—×™×¨×ª ×—×œ×§ ××”×¨×©×™××”\nâ€¢ ×¨×©×™××ª ×—×œ×§×™× ×©× ×•×¡×¤×”\nâ€¢ ×ª××•× ×” ×œ×—×™×¤×•×©');
      return false;
    }
    
    // Rule 3: Car details not mandatory but recommended
    if (!hasVehicleData) {
      const confirmSearch = confirm('×œ× ×”×•×–× ×• ×¤×¨×˜×™ ×¨×›×‘. ×”×× ×œ×”××©×™×š ×‘×—×™×¤×•×© ×›×œ×œ×™?');
      if (!confirmSearch) return false;
    }
    
    console.log('âœ… Validation passed');
    return true;
  }
  
  // âœ… NEW: Comprehensive search function with Supabase + Make.com fallback
  async function searchWithSupabaseFallback(payload) {
    console.log('ğŸ” Starting comprehensive search with Supabase + Make.com fallback');
    
    try {
      // Step 1: Try Supabase search first
      console.log('1ï¸âƒ£ Attempting Supabase search...');
      const smartService = new window.SmartPartsSearchService();
      const supabaseResults = await smartService.searchParts(payload);
      
      if (!supabaseResults.error && supabaseResults.data && supabaseResults.data.length > 0) {
        console.log(`âœ… Smart search successful: ${supabaseResults.data.length} results`);
        
        // Convert Supabase results to Make.com compatible format
        const convertedResults = {
          success: true,
          results: [{
            group: '×ª×•×¦××•×ª ×§×˜×œ×•×’ Supabase',
            name: '×—×™×¤×•×© ×‘×××’×¨',
            search_results: supabaseResults.data.map(item => ({
              id: item.id,
              ×ª×™××•×¨: item.cat_num_desc || '×œ×œ× ×ª×™××•×¨',
              ××—×™×¨: item.price ? `â‚ª${item.price}` : '×œ× ×¦×•×™×Ÿ',
              ×¡×¤×§: item.supplier_name || '×œ× ×¦×•×™×Ÿ',
              ××™×§×•×: item.location || '×œ× ×¦×•×™×Ÿ',
              ×–××™× ×•×ª: item.availability || '×œ× ×¦×•×™×Ÿ',
              '××¡×¤×¨ OEM': item.oem || '',
              '×¡×•×’ ×—×œ×§': item.source || '×œ× ×¦×•×™×Ÿ',
              ×”×¢×¨×•×ª: item.comments || '',
              // Keep original data for selection
              _original: item
            }))
          }],
          plate: payload.plate,
          date: new Date().toISOString(),
          source: 'supabase_catalog'
        };
        
        return convertedResults;
      } else {
        console.log('â„¹ï¸ Supabase search returned no results, trying Make.com fallback...');
      }
      
    } catch (error) {
      console.error('âŒ Supabase search error:', error);
      console.log('ğŸ”„ Falling back to Make.com webhook...');
    }
    
    // Step 2: Fallback to Make.com webhook
    console.log('2ï¸âƒ£ Using Make.com webhook fallback...');
    try {
      const makecomResults = await sendPartSearch(payload);
      
      if (makecomResults) {
        console.log('âœ… Make.com webhook returned results');
        return {
          ...makecomResults,
          source: 'makecom_webhook',
          fallback_used: true
        };
      }
      
    } catch (webhookError) {
      console.error('âŒ Make.com webhook also failed:', webhookError);
    }
    
    // Step 3: Return empty results if all methods fail
    console.log('âš ï¸ All search methods failed, returning empty results');
    return {
      success: false,
      results: [],
      error: '×›×œ ×©×™×˜×•×ª ×”×—×™×¤×•×© × ×›×©×œ×•. ×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.',
      no_results: true
    };
  }
  
  
  // SESSION 23: Mutual Button Exclusion for Search Sources
  function manageSearchButtons(activeSource) {
    const catalogBtn = document.querySelector('button[onclick="searchSupabase()"]');
    const webBtn = document.querySelector('button.btn[type="submit"]');
    const ocrBtn = document.getElementById('sendResultToOCRBtn');
    
    if (activeSource === 'catalog') {
      if (catalogBtn) catalogBtn.disabled = true;
      if (webBtn) webBtn.disabled = true;
      if (ocrBtn) ocrBtn.disabled = true;
    } else if (activeSource === 'web') {
      if (catalogBtn) catalogBtn.disabled = true;
      if (webBtn) webBtn.disabled = true;
      if (ocrBtn) ocrBtn.disabled = true;
    } else if (activeSource === 'ocr') {
      if (catalogBtn) catalogBtn.disabled = true;
      if (webBtn) webBtn.disabled = true;
      if (ocrBtn) ocrBtn.disabled = true;
    } else if (activeSource === null) {
      if (catalogBtn) catalogBtn.disabled = false;
      if (webBtn) webBtn.disabled = false;
      if (ocrBtn) ocrBtn.disabled = false;
    }
    
    console.log(`ğŸ”˜ Button state: ${activeSource || 'all enabled'}`);
  }
  
  // SESSION 23: Handle Webhook Response from Make.com (Web Search / OCR)
  async function handleWebhookResponse(webhookData, dataSource) {
    console.log('ğŸ“¥ SESSION 23: Processing webhook response', { dataSource, webhookData });
    
    try {
      const plate = webhookData.plate || document.getElementById('plate').value;
      
      // SESSION 24: Capture RAW webhook data in helper.raw_webhook_data (NOT in parts_search)
      let helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      if (!helper.parts_search) {
        helper.parts_search = {
          results: [],
          current_selected_list: [],
          selected_parts: []
        };
      }
      
      // SESSION 24 FIX: APPEND to raw_webhook_data array, don't replace
      if (!helper.raw_webhook_data) {
        helper.raw_webhook_data = [];
      }
      
      // Add timestamp and source info to webhook entry
      const webhookEntry = {
        timestamp: new Date().toISOString(),
        data_source: dataSource,
        plate: plate,
        webhook: webhookData
      };
      
      helper.raw_webhook_data.push(webhookEntry);
      sessionStorage.setItem('helper', JSON.stringify(helper));
      window.raw_webhook_data = helper.raw_webhook_data; // Keep window copy with ALL webhooks
      console.log(`ğŸ’¾ SESSION 24: Raw webhook appended to helper.raw_webhook_data (total: ${helper.raw_webhook_data.length})`);
      
      // SESSION 24: Extract results from webhook with proper structure handling
      // Webhook can be: Array[{body:{results:[]}}] OR {body:{results:[]}} OR {results:[]}
      let flatResults = [];
      
      console.log('ğŸ” SESSION 24: Analyzing webhook structure...');
      console.log('  - Is Array?', Array.isArray(webhookData));
      console.log('  - Has body?', !!webhookData.body);
      console.log('  - Has results?', !!webhookData.results);
      
      if (Array.isArray(webhookData)) {
        // Webhook is array - get first element
        const firstItem = webhookData[0];
        console.log('  - Array first item has body?', !!firstItem?.body);
        console.log('  - Array first item has results?', !!firstItem?.results);
        flatResults = firstItem?.body?.results || firstItem?.results || [];
        console.log('ğŸ“¦ Webhook is ARRAY, extracted from first element');
      } else if (webhookData.body?.results) {
        // Webhook has body.results
        flatResults = webhookData.body.results;
        console.log('ğŸ“¦ Webhook has body.results structure');
      } else if (webhookData.results) {
        // Webhook has direct results
        flatResults = webhookData.results;
        console.log('ğŸ“¦ Webhook has direct results structure');
      } else {
        console.error('âŒ SESSION 24: Could not extract results from webhook!');
        console.error('  - Webhook structure:', Object.keys(webhookData));
      }
      
      console.log(`ğŸ“¦ Received ${flatResults.length} results from webhook`);
      if (flatResults.length > 0) {
        console.log('ğŸ“‹ First result sample:', flatResults[0]);
        console.log('ğŸ“‹ First result keys:', Object.keys(flatResults[0]));
      } else {
        console.warn('âš ï¸ flatResults is EMPTY - check webhook structure!');
      }
      
      // SESSION 24: Get search params with FULL vehicle data (matching catalog search)
      const searchParams = {
        plate: plate,
        manufacturer: document.getElementById('manufacturer').value,
        model: document.getElementById('model').value,
        model_code: document.getElementById('model_code')?.value,
        trim: document.getElementById('trim')?.value,
        year: document.getElementById('year').value,
        engine_volume: document.getElementById('engine_volume')?.value,
        engine_code: document.getElementById('engine_code')?.value,
        engine_type: document.getElementById('engine_type')?.value,
        vin: document.getElementById('vin')?.value,
        oem: document.getElementById('oem')?.value,
        part_group: document.getElementById('part_group')?.value,
        part_name: document.getElementById('part_name')?.value,
        free_query: document.getElementById('free_query')?.value,
        selectedParts: window.helper?.parts_search?.current_selected_list || []
      };
      
      // SESSION 24: Transform webhook results - try ALL possible field name variations
      console.log('ğŸ”„ SESSION 24: Transforming webhook results...');
      const transformedResults = flatResults.map((item, index) => {
        if (index === 0) {
          console.log('ğŸ“‹ First webhook item keys:', Object.keys(item));
          console.log('ğŸ“‹ First webhook item sample:', item);
        }
        
        return {
          // Primary catalog code - try ALL variations
          pcode: item.×§×•×“_×§×˜×œ×•×’×™ || item['×§×•×“ ×§×˜×œ×•×’×™'] || item.catalog_code || 
                 item.×§×•×“_OEM || item['×§×•×“ OEM'] || item.oem_code || 
                 item.pcode || item.catalogCode || '×œ× ×–××™×Ÿ',
          
          // Part description - try ALL variations
          cat_num_desc: item.×ª×™××•×¨_×—×œ×§ || item['×ª×™××•×¨ ×—×œ×§'] || item.part_description || 
                        item.description || item.partDescription || item.×ª×™××•×¨ || '×œ× ×–××™×Ÿ',
          
          // Supplier name - try ALL variations
          supplier_name: item.×©×_×¡×¤×§ || item['×©× ×¡×¤×§'] || item.×¡×¤×§ || item.supplier_name || 
                        item.supplier || item.supplierName || '×œ× ×–××™×Ÿ',
          
          // Source type (OEM/Aftermarket/Used) - try ALL variations
          availability: item.×¡×•×’_××§×•×¨ || item['×¡×•×’ ××§×•×¨'] || item.×¡×•×’ || item.source_type || 
                       item.sourceType || item.type || '××§×•×¨×™',
          source: item.×¡×•×’_××§×•×¨ || item['×¡×•×’ ××§×•×¨'] || item.×¡×•×’ || item.source_type || 
                  item.sourceType || item.type || '××§×•×¨×™',
          
          // Price - handle both number and string formats with ALL variations
          price: parseFloat((item.××—×™×¨ || item.price || item.Price || '0').toString().replace(/,/g, '')) || 0,
          
          version_date: new Date().toISOString(),
          part_family: searchParams.part_group || '×œ× ××•×’×“×¨',
          model: searchParams.model || '×œ× ××•×’×“×¨',
          extracted_year: searchParams.year || '×œ× ××•×’×“×¨',
          
          // Geographic location - try ALL variations
          location: item.××™×§×•× || item.location || item.Location || '',
          
          // Condition (new/used) - try ALL variations
          condition: item.××¦×‘ || item.condition || item.Condition || '',
          
          // Currency
          currency: item.××˜×‘×¢ || item.currency || item.Currency || 'ILS',
          
          // Notes/comments - try ALL variations
          comments: item.×”×¢×¨×•×ª || item['×”×¢×¨×•×ª'] || item.notes || item.Notes || item.comments || '',
          
          // Stock status (×–××™×Ÿ/×‘××œ××™) - try ALL variations
          stock: item.××œ××™ || item['××œ××™'] || item.availability || item.Availability || 
                 item.stock || item.Stock || '',
          
          // OEM code - try ALL variations
          oem: item.×§×•×“_OEM || item['×§×•×“ OEM'] || item.×§×•×“_×™×¦×¨×Ÿ || item.oem_code || 
               item.oem || item.OEM || item.oemCode || '',
          
          // Keep original item for debugging
          _original: item
        };
      });
      
      console.log(`ğŸ”„ Transformed ${transformedResults.length} results to catalog format`);
      
      // Parallel Path A: Save to Supabase parts_search_results table
      const saveToSupabasePromise = (async () => {
        if (!window.partsSearchSupabaseService) {
          console.warn('âš ï¸ Supabase service not available, skipping save');
          return null;
        }
        
        const sessionId = window.currentSearchSessionId || null;
        
        console.log(`ğŸ’¾ Saving ${transformedResults.length} results to Supabase...`);
        const resultId = await window.partsSearchSupabaseService.saveSearchResults(
          sessionId,
          transformedResults,
          { plate, searchParams, dataSource }
        );
        console.log('âœ… Supabase save completed:', resultId);
        return resultId;
      })();
      
      // Parallel Path B: Update helper.parts_search.results
      const updateHelperPromise = (async () => {
        // SESSION 24: Use the SAME helper object that was already loaded and updated above
        // DON'T re-parse from sessionStorage - use the helper variable from line 1339
        
        if (!helper.parts_search.results) {
          helper.parts_search.results = [];
        }
        
        const newResults = {
          search_date: webhookData.search_date || new Date().toISOString(),
          data_source: dataSource,
          plate: plate,
          results: flatResults // Store ORIGINAL webhook data, not transformed
        };
        
        helper.parts_search.results.push(newResults);
        
        sessionStorage.setItem('helper', JSON.stringify(helper));
        localStorage.setItem('helper_data', JSON.stringify(helper));
        
        console.log('âœ… Helper updated with webhook results');
        return helper;
      })();
      
      await Promise.all([saveToSupabasePromise, updateHelperPromise]);
      
      if (window.partsResultsPiP) {
        const pipContext = {
          plate: plate,
          sessionId: window.currentSearchSessionId || 'no-session',
          searchType: dataSource === '××™× ×˜×¨× ×˜' ? 'web_search' : 'ocr_search',
          dataSource: dataSource,
          searchSuccess: transformedResults.length > 0,
          errorMessage: null,
          searchTime: 0,
          searchParams: searchParams // Includes selectedParts array
        };
        
        await window.partsResultsPiP.showResults(transformedResults, pipContext);
        console.log('âœ… PiP displayed with transformed webhook results');
        
        if (transformedResults.length > 0) {
          if (typeof showNotification === 'function') {
            showNotification(`× ××¦××• ${transformedResults.length} ×ª×•×¦××•×ª ×${dataSource}`, 'success');
          }
        }
      }
      
    } catch (error) {
      console.error('âŒ Error handling webhook response:', error);
      throw error;
    }
  }
  
  // SESSION 23: Web Search Function (Make.com External Search)
  async function searchWebExternal() {
    console.log('ğŸŒ SESSION 23: Starting web external search...');
    
    const webBtn = document.querySelector('button.btn[type="submit"]');
    const originalText = webBtn ? webBtn.innerHTML : '';
    
    manageSearchButtons('web');
    
    try {
      if (webBtn) {
        webBtn.innerHTML = 'â³ ××—×¤×© ×‘××¢×¨×›×ª ×—×™×¦×•× ×™×ª...';
      }
      
      const plate = document.getElementById('plate').value;
      if (!plate) {
        throw new Error('××¡×¤×¨ ×¨×™×©×•×™ ×—×¡×¨');
      }
      
      // DEBUG: Read all form values
      console.log('ğŸ” DEBUG: Reading form values...');
      const formValues = {
        plate: document.getElementById('plate')?.value,
        manufacturer: document.getElementById('manufacturer')?.value,
        model: document.getElementById('model')?.value,
        year: document.getElementById('year')?.value,
        part_name: document.getElementById('part_name')?.value,
        part_group: document.getElementById('part_group')?.value,
        part_source: document.getElementById('part_source')?.value,
        free_query: document.getElementById('free_query')?.value,
        trim: document.getElementById('trim')?.value,
        model_code: document.getElementById('model_code')?.value,
        engine_type: document.getElementById('engine_type')?.value,
        engine_volume: document.getElementById('engine_volume')?.value,
        vin: document.getElementById('vin')?.value
      };
      console.log('ğŸ“‹ Form values:', formValues);
      
      const searchParams = {
        plate: plate,
        manufacturer: formValues.manufacturer,
        model: formValues.model,
        year: formValues.year,
        part_name: formValues.part_name,
        part_group: formValues.part_group,
        free_query: formValues.free_query,
        selectedParts: window.helper?.parts_search?.current_selected_list || []
      };
      
      console.log('ğŸ“¦ Search params assembled:', searchParams);
      
      if (window.partsSearchSupabaseService) {
        const sessionId = await window.partsSearchSupabaseService.createSearchSession(
          plate,
          { searchParams, dataSource: '××™× ×˜×¨× ×˜' }
        );
        window.currentSearchSessionId = sessionId;
        console.log('âœ… Search session created:', sessionId);
      }
      
      const webhookUrl = 'https://hook.eu2.make.com/xenshho1chvd955wpaum5yh51v8klo58';
      
      const webhookPayload = {
        manufacturer: formValues.manufacturer || "",
        model: formValues.model || "",
        trim: formValues.trim || "",
        model_code: formValues.model_code || "",
        year: formValues.year || "",
        engine: formValues.engine_type || "",
        engine_volume: formValues.engine_volume || "",
        engine_model: formValues.engine_type || "",
        engine_type: formValues.engine_type || "",
        vin_number: formValues.vin || "",
        plate: formValues.plate || "",
        
        keyword: formValues.free_query || "",
        part_group: formValues.part_group || "",
        part_name: formValues.part_name || "",
        source: formValues.part_source || "",
        search_type: "web_search",
        
        parts_count: searchParams.selectedParts ? searchParams.selectedParts.length : 0,
        parts_list: searchParams.selectedParts && searchParams.selectedParts.length > 0 ? 
          searchParams.selectedParts.map(part => `${part.group || ''}: ${part.name || ''} (${part.source || '××§×•×¨×™'})`).join('; ') : "",
        
        timestamp: new Date().toISOString()
      };
      
      console.log('ğŸ“¤ Webhook payload assembled:', webhookPayload);
      
      console.log('ğŸ“¤ Sending webhook to Make.com...', webhookPayload);
      
      if (webBtn) {
        webBtn.innerHTML = 'â³ ×××ª×™×Ÿ ×œ×ª×•×¦××•×ª (×¢×“ 5 ×“×§×•×ª)...';
      }
      
      const timeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('×”×–××Ÿ ×”×§×¦×•×‘ ×œ××¢×¨×›×ª ×—×™×¦×•× ×™×ª ×”×¡×ª×™×™× (5 ×“×§×•×ª)')), 300000)
      );
      
      const fetchPromise = fetch(webhookUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(webhookPayload)
      });
      
      const response = await Promise.race([fetchPromise, timeoutPromise]);
      
      if (!response.ok) {
        throw new Error(`×©×’×™××ª ×ª×§×©×•×¨×ª: ${response.status}`);
      }
      
      const responseText = await response.text();
      console.log('ğŸ“¥ Raw webhook response:', responseText);
      
      if (responseText.trim() === 'Accepted' || responseText.trim() === 'accepted') {
        console.log('âœ… Webhook accepted - processing started');
        alert('×”×‘×§×©×” ×”×ª×§×‘×œ×”! ×”×ª×•×¦××•×ª ×™×•×¤×™×¢×• ×›×©×”×—×™×¤×•×© ×™×¡×ª×™×™×.');
        return;
      }
      
      let webhookData;
      try {
        webhookData = JSON.parse(responseText);
        console.log('âœ… Webhook response received:', webhookData);
      } catch (parseError) {
        console.warn('âš ï¸ Response is not JSON:', responseText);
        alert('×”×ª×§×‘×œ×” ×ª×©×•×‘×” ×œ× ×¦×¤×•×™×” ××”××¢×¨×›×ª.');
        return;
      }
      
      await handleWebhookResponse(webhookData, '××™× ×˜×¨× ×˜');
      
    } catch (error) {
      console.error('âŒ Web search error:', error);
      
      if (window.partsSearchSupabaseService && window.currentSearchSessionId) {
        try {
          await window.partsSearchSupabaseService.saveSearchResults(
            window.currentSearchSessionId,
            [],
            { error: error.message, dataSource: '××™× ×˜×¨× ×˜' }
          );
        } catch (logError) {
          console.error('âŒ Failed to log error to Supabase:', logError);
        }
      }
      
      alert(`×©×’×™××” ×‘×—×™×¤×•×© ×—×™×¦×•× ×™: ${error.message}`);
    } finally {
      if (webBtn) {
        webBtn.innerHTML = originalText;
      }
      manageSearchButtons(null);
    }
  }
  
  // SESSION 23: OCR Search Function
  async function searchOCR() {
    console.log('ğŸ“„ SESSION 23: Starting OCR search...');
    
    const ocrBtn = document.getElementById('sendResultToOCRBtn');
    const fileInput = document.getElementById('resultFileUpload');
    const originalText = ocrBtn ? ocrBtn.innerHTML : '';
    
    manageSearchButtons('ocr');
    
    try {
      if (ocrBtn) {
        ocrBtn.innerHTML = 'â³ ××¢×œ×” ×§×•×‘×¥...';
      }
      
      const file = fileInput?.files?.[0];
      if (!file) {
        throw new Error('×œ× × ×‘×—×¨ ×§×•×‘×¥');
      }
      
      const validTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
      if (!validTypes.includes(file.type)) {
        throw new Error('×¡×•×’ ×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ. × ×“×¨×© PDF ××• ×ª××•× ×” (JPG/PNG)');
      }
      
      const maxSize = 10 * 1024 * 1024;
      if (file.size > maxSize) {
        throw new Error('×’×•×“×œ ×”×§×•×‘×¥ ×—×•×¨×’ ×-10MB');
      }
      
      const plate = document.getElementById('plate').value;
      if (!plate) {
        throw new Error('××¡×¤×¨ ×¨×™×©×•×™ ×—×¡×¨');
      }
      
      if (window.partsSearchSupabaseService) {
        const sessionId = await window.partsSearchSupabaseService.createSearchSession(
          plate,
          { searchParams: { plate }, dataSource: 'ocr' }
        );
        window.currentSearchSessionId = sessionId;
        console.log('âœ… OCR session created:', sessionId);
      }
      
      const reader = new FileReader();
      const fileDataPromise = new Promise((resolve, reject) => {
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(new Error('×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥'));
        reader.readAsDataURL(file);
      });
      
      if (ocrBtn) {
        ocrBtn.innerHTML = 'â³ ×©×•×œ×— ×œ× ×™×ª×•×— OCR...';
      }
      
      const fileData = await fileDataPromise;
      
      const webhookUrl = 'https://hook.eu2.make.com/w11tujdfbmq03co3vakb2jfr5vo4k6w6';
      const webhookPayload = {
        plate: plate,
        file_name: file.name,
        file_type: file.type,
        file_data: fileData
      };
      
      console.log('ğŸ“¤ Sending OCR webhook to Make.com...');
      
      if (ocrBtn) {
        ocrBtn.innerHTML = 'â³ ×× ×ª×— ×§×•×‘×¥ (×¢×“ 5 ×“×§×•×ª)...';
      }
      
      const timeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('×”×–××Ÿ ×”×§×¦×•×‘ ×œ× ×™×ª×•×— OCR ×”×¡×ª×™×™× (5 ×“×§×•×ª)')), 300000)
      );
      
      const fetchPromise = fetch(webhookUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(webhookPayload)
      });
      
      const response = await Promise.race([fetchPromise, timeoutPromise]);
      
      if (!response.ok) {
        throw new Error(`×©×’×™××ª ×ª×§×©×•×¨×ª: ${response.status}`);
      }
      
      const webhookData = await response.json();
      console.log('âœ… OCR webhook response received:', webhookData);
      
      await handleWebhookResponse(webhookData, '××—×¨');
      
      fileInput.value = '';
      
    } catch (error) {
      console.error('âŒ OCR search error:', error);
      
      if (window.partsSearchSupabaseService && window.currentSearchSessionId) {
        try {
          await window.partsSearchSupabaseService.saveSearchResults(
            window.currentSearchSessionId,
            [],
            { error: error.message, dataSource: 'ocr' }
          );
        } catch (logError) {
          console.error('âŒ Failed to log error to Supabase:', logError);
        }
      }
      
      alert(`×©×’×™××” ×‘× ×™×ª×•×— OCR: ${error.message}`);
    } finally {
      if (ocrBtn) {
        ocrBtn.innerHTML = originalText;
      }
      manageSearchButtons(null);
    }
  }
  
  // Make functions globally available
  window.updateHelperWithPartsSearch = updateHelperWithPartsSearch;
  window.validateSearchForm = validateSearchForm;
  window.searchSupabase = searchSupabase;
  window.manageSearchButtons = manageSearchButtons;
  window.handleWebhookResponse = handleWebhookResponse;
  window.searchWebExternal = searchWebExternal;
  window.searchOCR = searchOCR;
  
</script>

<script>
  document.getElementById('partSearchForm').addEventListener('submit', e => {
    e.preventDefault();
    
    // âœ… FIX 4: Apply validation rules before submitting
    if (!validateSearchForm()) {
      return;
    }
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = '××—×¤×©...';
    submitBtn.disabled = true;
    
    // Enhanced payload includes selected parts list if available
    const payload = {
      plate: plate.value.trim(),
      manufacturer: manufacturer.value.trim(),
      model: model.value.trim(),
      model_code: model_code.value.trim(),
      trim: trim.value.trim(),
      year: year.value.trim(),
      engine_volume: engine_volume.value.trim(),
      engine_code: engine_code.value.trim(),
      engine_type: engine_type.value.trim(),
      vin: vin.value.trim(),
      oem: oem.value.trim(),
      part_group: part_group.value,
      part_name: part_name.value,
      free_query: free_query.value.trim(),
      part_image_base64: imageBase64 || null,
      selectedParts: window.helper?.parts_search?.current_selected_list || [],
      // Include parts list in search if available
      search_type: (window.helper?.parts_search?.current_selected_list?.length > 0) ? 'enhanced_with_parts_list' : 'standard',
      parts_list: window.helper?.parts_search?.current_selected_list || []
    };
    
    // âœ… ENHANCED: Try Supabase search first, fallback to Make.com webhook
    searchWithSupabaseFallback(payload).then(results => {
      console.log('ğŸ“¥ Parts search response received:', results);
      
      // Fix: Handle actual webhook structure {plate, date, results}
      if (results && results.results && results.results.length > 0) {
        // âœ… ENHANCED: Display comprehensive search results from Make.com
        displayComprehensiveSearchResults(results.results);
        
        const totalParts = results.results.reduce((sum, group) => {
          return sum + (group.search_results ? group.search_results.length : 0);
        }, 0);
        
        const sourceMsg = results.source === 'supabase_catalog' ? '(××§×˜×œ×•×’ Supabase)' : 
                         results.fallback_used ? '(×“×¨×š Make.com)' : '';
        alert(`âœ… × ××¦××• ${results.results.length} ×§×‘×•×¦×•×ª ×—×œ×§×™× ×¢× ×¡×”"×› ${totalParts} ××¤×©×¨×•×™×•×ª! ${sourceMsg}`);
        
        // Forward webhook results to damage centers wizard
        if (window.parent !== window && window.parent.postMessage) {
          window.parent.postMessage({
            type: 'partsSearchResults',
            results: results.results,
            plate: results.plate,
            date: results.date,
            source: 'parts_search_webhook'
          }, '*');
          console.log('ğŸ“¤ Forwarded webhook results to damage centers wizard');
        }
        
        // âœ… FIXED: Use enhanced helper integration with search results
        try {
          const searchContext = {
            query: payload,
            timestamp: new Date().toISOString(),
            results_count: results.results.length,
            total_parts: totalParts,
            search_type: 'system_search_enhanced',
            plate: results.plate,
            webhook_date: results.date
          };
          
          // Use enhanced helper integration
          const updatedHelper = updateHelperWithPartsSearch(results.results, searchContext);
          
          if (updatedHelper) {
            console.log(`âœ… Enhanced: Saved ${results.results.length} search result groups to helper`);
            
            // Trigger helper update broadcast if available
            if (typeof window.broadcastHelperUpdate === 'function') {
              window.broadcastHelperUpdate(['parts_search'], 'parts_search_module');
            }
          }
        } catch (e) {
          console.error('âŒ Error saving search results with enhanced system:', e);
        }
      } else if (results && results.success && results.message === 'Accepted') {
        // Handle "Accepted" responses (processing started)
        alert('âœ… ×”×—×™×¤×•×© ×”×ª×§×‘×œ ×œ×¢×™×‘×•×“! ×”×ª×•×¦××•×ª ×™×’×™×¢×• ×‘×§×¨×•×‘...');
        console.log('â³ Search accepted for processing');
      } else if (results && results.success && results.no_results) {
        // Handle processing responses - check for embedded JSON
        if (results.message && results.message.includes('"plate"') && results.message.includes('"results"')) {
          try {
            console.log('ğŸ”„ Parsing embedded JSON from response message...');
            const jsonMatch = results.message.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
              const parsedData = JSON.parse(jsonMatch[0]);
              console.log('âœ… Found embedded JSON data:', parsedData);
              
              if (parsedData.results && parsedData.results.length > 0) {
                // Process the actual results
                displayComprehensiveSearchResults(parsedData.results);
                const totalParts = parsedData.results.reduce((sum, group) => {
                  return sum + (group.search_results ? group.search_results.length : 0);
                }, 0);
                alert(`âœ… × ××¦××• ${parsedData.results.length} ×§×‘×•×¦×•×ª ×—×œ×§×™× ×¢× ×¡×”"×› ${totalParts} ××¤×©×¨×•×™×•×ª!`);
                
                // Forward webhook results to damage centers wizard
                if (window.parent !== window && window.parent.postMessage) {
                  window.parent.postMessage({
                    type: 'partsSearchResults',
                    results: parsedData.results,
                    plate: parsedData.plate,
                    date: parsedData.search_date || parsedData.date,
                    source: 'parts_search_webhook'
                  }, '*');
                  console.log('ğŸ“¤ Forwarded webhook results to damage centers wizard');
                }
              } else {
                alert('ğŸ” ×”×—×™×¤×•×© ×”×•×©×œ× ××š ×œ× × ××¦××• ×ª×•×¦××•×ª ××ª××™××•×ª');
                console.log('â„¹ï¸ Search completed with no results');
              }
            }
          } catch (parseError) {
            console.error('âŒ Error parsing embedded JSON:', parseError);
            alert('ğŸ” ×”×—×™×¤×•×© ×”×•×©×œ× ××š ×œ× × ××¦××• ×ª×•×¦××•×ª ××ª××™××•×ª');
          }
        } else {
          alert('ğŸ” ×”×—×™×¤×•×© ×”×•×©×œ× ××š ×œ× × ××¦××• ×ª×•×¦××•×ª ××ª××™××•×ª');
          console.log('â„¹ï¸ Search completed with no results');
        }
      } else if (results && results.plate && results.results && results.results.length === 0) {
        alert('ğŸ” ×”×—×™×¤×•×© ×”×•×©×œ× ××š ×œ× × ××¦××• ×ª×•×¦××•×ª ××ª××™××•×ª');
        console.log('â„¹ï¸ Search completed with no results for plate:', results.plate);
      } else if (results && results.error) {
        alert(`âŒ ×©×’×™××” ×‘×—×™×¤×•×©: ${results.error}`);
        console.error('âŒ Search failed:', results.error);
      } else {
        console.warn('âš ï¸ Unexpected response format:', results);
        alert('âš ï¸ ×”×ª×§×‘×œ×” ×ª×’×•×‘×” ×‘×¤×•×¨××˜ ×œ× ×¦×¤×•×™ ××”×©×¨×ª');
      }
    }).catch(error => {
      console.error('Search error:', error);
      alert('×©×’×™××” ×‘×—×™×¤×•×© ×—×œ×§×™×');
    }).finally(() => {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    });
  });
</script>
<script>
document.getElementById('sendResultToOCRBtn').addEventListener('click', function () {
  const fileInput = document.getElementById('resultFileUpload');
  const file = fileInput.files[0];
  if (!file) {
    alert('×× × ×”×¢×œ×” ×§×•×‘×¥ ×—×™×¤×•×© ×œ×¤× ×™ ×”×©×œ×™×—×”');
    return;
  }

  // Show processing indicator
  const btn = document.getElementById('sendResultToOCRBtn');
  const originalText = btn.textContent;
  btn.textContent = '××¢×‘×“...';
  btn.disabled = true;

  sendSearchResultFile(file, {
    plate: sessionStorage.getItem('plate') || '',
    model: sessionStorage.getItem('model') || ''
  }).then(results => {
    if (results && results.parts && results.parts.length > 0) {
      displaySearchResults(results.parts);
      alert(`âœ… × ××¦××• ${results.parts.length} ×—×œ×§×™× ×‘×§×•×‘×¥`);
    } else {
      alert('×œ× × ××¦××• ×—×œ×§×™× ×‘×§×•×‘×¥ ××• ×©×’×™××” ×‘×¢×™×‘×•×“');
    }
  }).catch(error => {
    console.error('OCR processing error:', error);
    alert('×©×’×™××” ×‘×¢×™×‘×•×“ ×”×§×•×‘×¥');
  }).finally(() => {
    btn.textContent = originalText;
    btn.disabled = false;
  });
  
  // SESSION 14 TASK 3: Keep current session list persistent on refresh
  // Load from helper (which is saved to sessionStorage)
  if (window.helper?.parts_search?.selected_parts) {
    console.log('âœ… SESSION 14: Loaded', window.helper.parts_search.selected_parts.length, 'parts from helper');
    if (typeof updateSelectedPartsList === 'function') {
      updateSelectedPartsList();
    }
  } else {
    console.log('â„¹ï¸ SESSION 14: No parts in helper, starting fresh');
  }
});

</script>
<script type="module">
  import { sendPartSearch, sendSearchResultFile } from './webhook.js';
  
  // âœ… NEW: Listen for messages from damage centers wizard
  window.addEventListener('message', function(event) {
    console.log('ğŸ“¨ Parts search received message:', event.data);
    
    switch(event.data.type) {
      case 'damageCenterContext':
        handleWizardContext(event.data);
        break;
      case 'wizardReady':
        console.log('âœ… Wizard is ready, parts search module loaded');
        // Send ready confirmation back
        if (window.parent && window.parent.postMessage) {
          window.parent.postMessage({
            type: 'moduleReady',
            module: 'partsSearch',
            source: 'parts_search_iframe'
          }, '*');
        }
        break;
    }
  });
  
  // âœ… NEW: Handle wizard context data
  function handleWizardContext(contextData) {
    console.log('ğŸ¯ Handling wizard context:', contextData);
    
    try {
      // Pre-fill vehicle data if available
      if (contextData.vehicleData) {
        const vehicle = contextData.vehicleData;
        
        if (vehicle.plate) document.getElementById('plate').value = vehicle.plate;
        if (vehicle.manufacturer) document.getElementById('manufacturer').value = vehicle.manufacturer;
        if (vehicle.model) document.getElementById('model').value = vehicle.model;
        if (vehicle.year) document.getElementById('year').value = vehicle.year;
        if (vehicle.engine_volume) document.getElementById('engine_volume').value = vehicle.engine_volume;
        if (vehicle.chassis) document.getElementById('vin').value = vehicle.chassis;
        
        console.log('âœ… Pre-filled vehicle data from wizard context');
      }
      
      // Show wizard-specific UI hints
      showWizardModeUI(contextData);
      
    } catch (error) {
      console.error('âŒ Failed to handle wizard context:', error);
    }
  }
  
  // âœ… NEW: Show wizard-specific UI
  function showWizardModeUI(contextData) {
    // Add wizard indication to page
    const container = document.querySelector('.container');
    if (container) {
      const wizardIndicator = document.createElement('div');
      wizardIndicator.style.cssText = `
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px;
        text-align: center; font-weight: bold;
      `;
      wizardIndicator.innerHTML = `ğŸ§­ ××•×“×•×œ ×—×™×¤×•×© ×—×œ×¤×™× - ××©×£ ××•×§×“×™ × ×–×§ (××•×§×“ ${contextData.damageCenterId || '×—×“×©'})`;
      
      container.insertBefore(wizardIndicator, container.firstChild);
    }
  }
  import { dev_credentials } from './credentials-vault.js';
  // import { partsSearchService } from './services/partsSearchService.js';
  // Using new SmartPartsSearchService loaded via script tag

  window.sendPartSearch = sendPartSearch;
  window.sendSearchResultFile = sendSearchResultFile;
  window.dev_credentials = dev_credentials;

  // Enhanced search site opening with better UX
  window.openSearchSite = function () {
    const vehicleData = {
      manufacturer: document.getElementById('manufacturer').value,
      model: document.getElementById('model').value,
      year: document.getElementById('year').value,
      plate: document.getElementById('plate')?.value || ''
    };
    
    // Get parts list from search_query_list
    const parts = window.helper?.parts_search?.search_query_list || [];
    
    console.log('ğŸŒ Opening Car-Part with vehicle data and parts:', vehicleData, parts);
    
    // Open in new window with specific size
    const externalWindow = window.open('https://www.car-part.co.il', '_blank', 'width=1400,height=900');
    
    if (!externalWindow) {
      alert('×× × ××¤×©×¨ ×—×œ×•× ×•×ª ×§×•×¤×¦×™× ×‘×“×¤×“×¤×Ÿ');
      return;
    }
    
    // Wait for window to load, then inject floating panel
    setTimeout(() => {
      try {
        // Create floating helper panel HTML
        const panelHTML = createFloatingHelperPanel(vehicleData, parts);
        
        // Try to inject (will fail due to CORS, but window reference stays)
        // Store data in the opener for the panel to access
        window.carPartHelperData = {
          vehicleData,
          parts,
          credentials: {
            username: '×™×¨×•×Ÿ ×›×™×•×£',
            password: '8881'
          },
          returnUrl: window.location.href
        };
        
        // Show instructions popup in our window
        showExternalWindowInstructions(vehicleData, parts);
        
      } catch (error) {
        console.log('Cross-origin restriction (expected):', error);
        showExternalWindowInstructions(vehicleData, parts);
      }
    }, 1000);
  };
  
  function createFloatingHelperPanel(vehicleData, parts) {
    return `
      <div id="smartval-helper" style="position: fixed; top: 20px; left: 20px; width: 350px; max-height: 80vh; background: white; border: 3px solid #10b981; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 999999; overflow: hidden; font-family: Arial, sans-serif; direction: rtl;">
        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0; font-size: 16px;">ğŸ“‹ ××™×“×¢ ×œ×—×™×¤×•×©</h3>
          <button onclick="this.parentElement.parentElement.remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px;">Ã—</button>
        </div>
        
        <div style="padding: 15px; max-height: calc(80vh - 120px); overflow-y: auto;">
          <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
            <h4 style="margin: 0 0 10px 0; color: #1e3a8a; font-size: 14px;">ğŸš— ×¤×¨×˜×™ ×¨×›×‘</h4>
            <div style="font-size: 13px; line-height: 1.6;">
              <div><strong>×™×¦×¨×Ÿ:</strong> ${vehicleData.manufacturer || '×œ× ×¦×•×™×Ÿ'}</div>
              <div><strong>×“×’×:</strong> ${vehicleData.model || '×œ× ×¦×•×™×Ÿ'}</div>
              <div><strong>×©× ×”:</strong> ${vehicleData.year || '×œ× ×¦×•×™×Ÿ'}</div>
              ${vehicleData.plate ? `<div><strong>××¡×¤×¨ ×¨×›×‘:</strong> ${vehicleData.plate}</div>` : ''}
            </div>
          </div>
          
          <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
            <h4 style="margin: 0 0 10px 0; color: #92400e; font-size: 14px;">ğŸ”‘ ×¤×¨×˜×™ ×›× ×™×¡×”</h4>
            <div style="font-size: 13px;">
              <div style="margin-bottom: 5px;"><strong>××©×ª××©:</strong> ×™×¨×•×Ÿ ×›×™×•×£</div>
              <div><strong>×¡×™×¡××”:</strong> 8881</div>
            </div>
          </div>
          
          ${parts.length > 0 ? `
            <div style="background: #dcfce7; padding: 12px; border-radius: 8px; border-left: 4px solid #10b981;">
              <h4 style="margin: 0 0 10px 0; color: #065f46; font-size: 14px;">ğŸ”§ ×—×œ×§×™× ×œ×—×™×¤×•×© (${parts.length})</h4>
              <div style="max-height: 300px; overflow-y: auto;">
                ${parts.map((part, index) => `
                  <div style="background: white; padding: 8px; margin-bottom: 8px; border-radius: 6px; font-size: 12px; border: 1px solid #d1fae5;">
                    <div style="font-weight: bold; color: #059669; margin-bottom: 4px;">${index + 1}. ${part.name || part.part_name || '×—×œ×§'}</div>
                    <div style="color: #6b7280;">
                      ${part.group ? `×§×‘×•×¦×”: ${part.group}<br>` : ''}
                      ${part.qty ? `×›××•×ª: ${part.qty}<br>` : ''}
                      ${part.source ? `××§×•×¨: ${part.source}` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : '<div style="color: #6b7280; text-align: center; padding: 20px;">××™×Ÿ ×—×œ×§×™× ×‘×¨×©×™××”</div>'}
        </div>
        
        <div style="padding: 15px; border-top: 1px solid #e5e7eb; background: #f9fafb;">
          <button onclick="window.close(); window.opener.focus();" style="width: 100%; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px;">ğŸ”™ ×—×–×•×¨ ×œ××¢×¨×›×ª</button>
        </div>
      </div>
    `;
  }
  
  function showExternalWindowInstructions(vehicleData, parts) {
    const popup = document.createElement('div');
    popup.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 3px solid #10b981;
      border-radius: 12px;
      padding: 25px;
      z-index: 10001;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      direction: rtl;
      font-family: Arial, sans-serif;
      max-width: 500px;
    `;
    
    popup.innerHTML = `
      <h3 style="margin-top: 0; color: #10b981; text-align: center;">âœ… ××ª×¨ Car-Part × ×¤×ª×—!</h3>
      
      <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin: 15px 0; border-right: 4px solid #3b82f6;">
        <h4 style="margin: 0 0 10px 0; color: #1e3a8a;">ğŸš— ×¤×¨×˜×™ ×¨×›×‘</h4>
        <div style="font-size: 14px; line-height: 1.8;">
          <div><strong>×™×¦×¨×Ÿ:</strong> ${vehicleData.manufacturer || '×œ× ×¦×•×™×Ÿ'}</div>
          <div><strong>×“×’×:</strong> ${vehicleData.model || '×œ× ×¦×•×™×Ÿ'}</div>
          <div><strong>×©× ×”:</strong> ${vehicleData.year || '×œ× ×¦×•×™×Ÿ'}</div>
        </div>
      </div>
      
      <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin: 15px 0; border-right: 4px solid #f59e0b;">
        <h4 style="margin: 0 0 10px 0; color: #92400e;">ğŸ”‘ ×¤×¨×˜×™ ×›× ×™×¡×”</h4>
        <div style="font-size: 14px; line-height: 1.8;">
          <div><strong>××©×ª××©:</strong> <span id="username-copy">×™×¨×•×Ÿ ×›×™×•×£</span>
            <button onclick="navigator.clipboard.writeText('×™×¨×•×Ÿ ×›×™×•×£').then(() => alert('×”×•×¢×ª×§!'))" style="margin-right: 10px; padding: 4px 8px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ“‹ ×”×¢×ª×§</button>
          </div>
          <div><strong>×¡×™×¡××”:</strong> <span id="password-copy">8881</span>
            <button onclick="navigator.clipboard.writeText('8881').then(() => alert('×”×•×¢×ª×§!'))" style="margin-right: 10px; padding: 4px 8px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ“‹ ×”×¢×ª×§</button>
          </div>
        </div>
      </div>
      
      ${parts.length > 0 ? `
        <div style="background: #dcfce7; padding: 15px; border-radius: 8px; margin: 15px 0; border-right: 4px solid #10b981;">
          <h4 style="margin: 0 0 10px 0; color: #065f46;">ğŸ”§ ×—×œ×§×™× ×œ×—×™×¤×•×© (${parts.length})</h4>
          <div style="max-height: 200px; overflow-y: auto; font-size: 13px;">
            ${parts.map((part, i) => `
              <div style="padding: 6px 0; border-bottom: 1px solid #d1fae5;">
                ${i + 1}. <strong>${part.name || part.part_name}</strong>
                ${part.group ? ` - ${part.group}` : ''}
                ${part.qty ? ` (×›××•×ª: ${part.qty})` : ''}
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
      
      <div style="text-align: center; margin-top: 20px;">
        <button onclick="this.parentElement.parentElement.remove()" style="padding: 12px 30px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px;">×”×‘× ×ª×™, ×¡×’×•×¨</button>
      </div>
    `;
    
    document.body.appendChild(popup);
    
    // Auto-close after 30 seconds
    setTimeout(() => {
      if (popup.parentElement) {
        popup.remove();
      }
    }, 30000);
  }
  
  // âœ… ENHANCED: Comprehensive search results display for Make.com response format
  window.displayComprehensiveSearchResults = function(resultGroups) {
    const container = document.getElementById('search_results_display');
    const content = document.getElementById('search_results_content');
    
    if (!resultGroups || resultGroups.length === 0) {
      container.style.display = 'none';
      return;
    }
    
    // Create comprehensive display for grouped results
    const groupsHTML = resultGroups.map((group, groupIndex) => {
      const searchResults = group.search_results || [];
      const groupName = group.group || '×§×‘×•×¦×ª ×—×œ×§×™×';
      const partName = group.name || '×—×œ×§ ×œ×œ× ×©×';
      
      const resultsHTML = searchResults.map((result, resultIndex) => `
        <div style="
          border: 1px solid #e5e7eb; 
          padding: 15px; 
          margin: 8px 0; 
          border-radius: 8px; 
          background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); 
          cursor: pointer;
          transition: all 0.3s ease;
        " 
        onmouseover="this.style.borderColor='#3b82f6'; this.style.transform='translateY(-2px)'"
        onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'"
        onclick="selectComprehensiveSearchResult(${groupIndex}, ${resultIndex})">
          
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
            <div style="flex: 1;">
              <div style="font-weight: bold; color: #1e40af; font-size: 16px; margin-bottom: 5px;">
                ${result.×ª×™××•×¨ || result.description || partName}
              </div>
              <div style="color: #059669; font-weight: bold; font-size: 18px;">
                ${result.××—×™×¨ || result.price || '××—×™×¨ ×œ× ×¦×•×™×Ÿ'}
              </div>
            </div>
            <div style="text-align: left;">
              <div style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                ${result['×¡×•×’ ×—×œ×§'] || result.type || '×œ× ×¦×•×™×Ÿ'}
              </div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 10px;">
            <div>
              <span style="font-weight: bold; color: #4b5563;">×¡×¤×§:</span>
              <span style="color: #374151;">${result.×¡×¤×§ || result.supplier || '×œ× ×¦×•×™×Ÿ'}</span>
            </div>
            <div>
              <span style="font-weight: bold; color: #4b5563;">××™×§×•×:</span>
              <span style="color: #374151;">${result.××™×§×•× || result.location || '×œ× ×¦×•×™×Ÿ'}</span>
            </div>
            <div>
              <span style="font-weight: bold; color: #4b5563;">×–××™× ×•×ª:</span>
              <span style="color: #059669; font-weight: bold;">${result.×–××™× ×•×ª || result.availability || '×œ× ×¦×•×™×Ÿ'}</span>
            </div>
            ${result['××¡×¤×¨ OEM'] || result.oem_number ? `
            <div>
              <span style="font-weight: bold; color: #4b5563;">OEM:</span>
              <span style="color: #374151; font-family: monospace;">${result['××¡×¤×¨ OEM'] || result.oem_number}</span>
            </div>
            ` : ''}
          </div>
          
          ${result.×”×¢×¨×•×ª || result.notes ? `
          <div style="margin-top: 10px; padding: 8px; background: #fef3c7; border-radius: 4px; border-left: 4px solid #f59e0b;">
            <span style="font-weight: bold; color: #92400e;">×”×¢×¨×•×ª:</span>
            <span style="color: #92400e;">${result.×”×¢×¨×•×ª || result.notes}</span>
          </div>
          ` : ''}
          
          <div style="text-align: center; margin-top: 12px;">
            <small style="color: #3b82f6; font-weight: bold;">ğŸ‘† ×œ×—×¥ ×œ×”×•×¡×¤×” ×œ×¨×©×™××ª ×”×—×œ×§×™×</small>
          </div>
        </div>
      `).join('');
      
      return `
        <div style="margin-bottom: 25px; border: 2px solid #3b82f6; border-radius: 12px; overflow: hidden;">
          <div style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; padding: 15px; text-align: center;">
            <h3 style="margin: 0; font-size: 18px;">${groupName}</h3>
            <div style="font-size: 16px; margin-top: 5px; opacity: 0.9;">${partName}</div>
            <div style="font-size: 14px; margin-top: 5px; opacity: 0.8;">${searchResults.length} ××¤×©×¨×•×™×•×ª × ××¦××•</div>
          </div>
          <div style="padding: 15px;">
            ${resultsHTML}
          </div>
        </div>
      `;
    }).join('');
    
    // Update content with comprehensive results
    content.innerHTML = `
      <div style="margin-bottom: 20px; text-align: center; padding: 15px; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-radius: 10px; border: 1px solid #10b981;">
        <h3 style="color: #047857; margin: 0;">ğŸ” ×ª×•×¦××•×ª ×—×™×¤×•×© ××§×™×¤×•×ª</h3>
        <p style="color: #059669; margin: 5px 0 0 0;">× ××¦××• ${resultGroups.length} ×§×‘×•×¦×•×ª ×—×œ×§×™× ×¢× ××¤×©×¨×•×™×•×ª ×¨×›×™×©×” ××’×•×•× ×•×ª</p>
      </div>
      ${groupsHTML}
    `;
    
    container.style.display = 'block';
    window.currentComprehensiveResults = resultGroups;
  };
  
  // Enhanced result display function (backward compatibility)
  window.displaySearchResults = function(results) {
    // Check if this is the new comprehensive format
    if (results && results.length > 0 && results[0].search_results) {
      return displayComprehensiveSearchResults(results);
    }
    
    // Legacy format handling
    const container = document.getElementById('search_results_display');
    const content = document.getElementById('search_results_content');
    
    if (!results || results.length === 0) {
      container.style.display = 'none';
      return;
    }
    
    content.innerHTML = results.map((result, index) => `
      <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 5px; background: white; cursor: pointer;" 
           onclick="selectSearchResult(${index})">
        <strong>${result.name || result.description || '×—×œ×§ ×œ×œ× ×©×'}</strong>
        ${result.description ? `<br><small>${result.description}</small>` : ''}
        ${result.price ? `<br>××—×™×¨: <span style="color: #28a745; font-weight: bold;">â‚ª${result.price}</span>` : ''}
        ${result.source ? `<br>××§×•×¨: ${result.source}` : ''}
        ${result.supplier ? `<br>×¡×¤×§: ${result.supplier}` : ''}
        <br><small style="color: #007bff;">×œ×—×¥ ×œ×”×•×¡×¤×” ×œ×¨×©×™××”</small>
      </div>
    `).join('');
    
    container.style.display = 'block';
    window.currentSearchResults = results;
  };
  
  // âœ… NEW: Select comprehensive search result (for Make.com format)
  window.selectComprehensiveSearchResult = function(groupIndex, resultIndex) {
    const resultGroup = window.currentComprehensiveResults[groupIndex];
    if (!resultGroup || !resultGroup.search_results) return;
    
    const result = resultGroup.search_results[resultIndex];
    if (!result) return;
    
    console.log('ğŸ¯ Selected comprehensive search result:', { groupIndex, resultIndex, result });
    
    // Extract details from Hebrew/English mixed format
    const partName = result.×ª×™××•×¨ || result.description || resultGroup.name || '×—×œ×§ ××ª×•×¦××ª ×—×™×¤×•×©';
    const price = result.××—×™×¨ || result.price || '';
    const supplier = result.×¡×¤×§ || result.supplier || '';
    const partType = result['×¡×•×’ ×—×œ×§'] || result.type || '';
    const oem = result['××¡×¤×¨ OEM'] || result.oem_number || '';
    const location = result.××™×§×•× || result.location || '';
    const availability = result.×–××™× ×•×ª || result.availability || '';
    const notes = result.×”×¢×¨×•×ª || result.notes || '';
    
    // Determine source based on part type
    let source = '×ª×—×œ×™×¤×™';
    if (partType.includes('OEM') || partType.includes('××§×•×¨×™')) {
      source = '××§×•×¨×™';
    } else if (partType.includes('××©×•××©')) {
      source = '××©×•××©';
    }
    
    // Create enhanced part item
    const item = {
      group: resultGroup.group || '×ª×•×¦××ª ×—×™×¤×•×©',
      name: partName,
      qty: 1,
      source: source,
      price: price.replace('â‚ª', '').trim(),
      supplier: supplier,
      id: `search_result_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      added_at: new Date().toISOString(),
      search_metadata: {
        oem_number: oem,
        location: location,
        availability: availability,
        notes: notes,
        part_type: partType,
        from_comprehensive_search: true,
        group_index: groupIndex,
        result_index: resultIndex
      }
    };
    
    // SESSION 19: Check for duplicates in current_selected_list
    const currentList = window.helper?.parts_search?.current_selected_list || [];
    const isDuplicate = currentList.some(existing => 
      existing.name === item.name && 
      existing.supplier === item.supplier &&
      existing.source === item.source
    );
    
    if (isDuplicate) {
      alert('âš ï¸ ×—×œ×§ ×–×” ×›×‘×¨ ×§×™×™× ×‘×¨×©×™××”');
      return;
    }
    
    // SESSION 19: Add to current_selected_list
    if (!window.helper) window.helper = {};
    if (!window.helper.parts_search) window.helper.parts_search = {};
    if (!window.helper.parts_search.current_selected_list) {
      window.helper.parts_search.current_selected_list = [];
    }
    
    window.helper.parts_search.current_selected_list.push(item);
    sessionStorage.setItem('helper', JSON.stringify(window.helper));
    clearPartsCache();
    updateSelectedPartsList();
    
    // Visual feedback
    if (typeof showNotification === 'function') {
      showNotification(`× ×•×¡×£ ×œ×¨×©×™××”: ${partName}`, 'success');
    }
    
    alert(`âœ… × ×•×¡×£ ×œ×¨×©×™××”: ${partName}\n×¡×¤×§: ${supplier}\n××—×™×¨: ${price}`);
    
    console.log('âœ… Added comprehensive search result to selected parts:', item);
  };
  
  // Legacy search result selection (backward compatibility)
  window.selectSearchResult = function(index) {
    const result = window.currentSearchResults[index];
    if (!result) return;
    
    // Auto-fill form with selected result
    document.getElementById('part_name').value = result.name || result.description || '';
    if (result.source) {
      document.getElementById('part_source').value = result.source;
    }
    
    // SESSION 19: Add to current_selected_list
    const item = { 
      group: result.category || '××—×™×¤×•×©', 
      name: result.name || result.description || '', 
      qty: 1, 
      source: result.source || '×ª×—×œ×™×¤×™',
      price: result.price || '',
      supplier: result.supplier || '',
      id: `search_result_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      added_at: new Date().toISOString()
    };
    
    if (!window.helper) window.helper = {};
    if (!window.helper.parts_search) window.helper.parts_search = {};
    if (!window.helper.parts_search.current_selected_list) {
      window.helper.parts_search.current_selected_list = [];
    }
    
    window.helper.parts_search.current_selected_list.push(item);
    sessionStorage.setItem('helper', JSON.stringify(window.helper));
    clearPartsCache();
    updateSelectedPartsList();
    
    alert('âœ… ×”×—×œ×§ × ×•×¡×£ ×œ×¨×©×™××”');
  };
  
  window.clearSearchResults = function() {
    document.getElementById('search_results_display').style.display = 'none';
    window.currentSearchResults = [];
  };
  
  window.saveToSession = function() {
    // SESSION 19: This function is now deprecated - saveCurrentToList handles saving
    console.warn('âš ï¸ SESSION 19: saveToSession is deprecated - use saveCurrentToList instead');
    
    // Redirect to proper save function
    if (typeof saveCurrentToList === 'function') {
      saveCurrentToList();
    } else {
      alert('×× × ×”×©×ª××© ×‘×›×¤×ª×•×¨ "×©××•×¨ ×œ×¨×©×™××”" ×‘××§×•×');
    }
  };
  
  function generatePartsCSV(parts) {
    const headers = ['×§×˜×’×•×¨×™×”', '×©× ×”×—×œ×§', '×›××•×ª', '××§×•×¨', '××—×™×¨', '×¡×¤×§'];
    const rows = parts.map(part => [
      part.group || '',
      part.name || '',
      part.qty || 1,
      part.source || '',
      part.price || '',
      part.supplier || ''
    ]);
    
    return [headers, ...rows].map(row => 
      row.map(field => `"${field}"`).join(',')
    ).join('\n');
  }
  
  async function updateSelectedPartsList() {
    const listUI = document.getElementById('selected_parts_list');
    const managementButtons = document.getElementById('parts_management_buttons');
    const countDisplay = document.getElementById('selected_parts_count');
    
    // SESSION 19: Display current_selected_list ONLY (temp session parts)
    // DO NOT load from Supabase table here - that's for permanent saved parts
    let partsToDisplay = [];
    
    console.log('ğŸ“‹ SESSION 19: updateSelectedPartsList - showing current_selected_list only');
    
    // SESSION 19: Skip Supabase query - just show current session
    // Supabase selected_parts table = permanent saved parts (read via getSelectedParts when needed)
    // current_selected_list = temporary session parts (displayed here)
    
    if (false && window.supabase) { // SESSION 19: Disabled - use current_selected_list instead
      try {
        const plateInput = document.getElementById('plate');
        const plate = plateInput?.value?.trim() || window.helper?.meta?.plate || window.helper?.vehicle?.plate;
        
        if (plate) {
          console.log('ğŸ” SESSION 17: Loading selected parts from Supabase for plate:', plate);
          const { data, error } = await window.supabase
            .from('selected_parts')
            .select('*')
            .eq('plate', plate)
            .order('selected_at', { ascending: false });
          
          if (error) {
            console.error('âŒ SESSION 17: Error loading from Supabase:', error);
          } else if (data) {
            // SESSION 17: Smart sync - validate and merge differences only
            if (window.helper?.parts_search) {
              const supabaseParts = data || [];
              const helperParts = window.helper.parts_search.selected_parts || [];
              
              console.log('ğŸ” SESSION 17: Smart sync - Supabase:', supabaseParts.length, 'Helper:', helperParts.length);
              
              // Create map of Supabase parts by pcode for quick lookup
              const supabaseMap = new Map();
              supabaseParts.forEach(part => {
                const key = part.pcode || part.oem || part.id;
                supabaseMap.set(key, part);
              });
              
              // Create map of helper parts by pcode
              const helperMap = new Map();
              helperParts.forEach(part => {
                const key = part.pcode || part.oem || part.catalog_code;
                helperMap.set(key, part);
              });
              
              // Find differences
              const toAdd = []; // In Supabase but not in helper
              const toUpdate = []; // In both but with different data
              const toRemove = []; // In helper but not in Supabase
              
              // Check Supabase parts
              supabaseParts.forEach(supabasePart => {
                const key = supabasePart.pcode || supabasePart.oem || supabasePart.id;
                if (!helperMap.has(key)) {
                  toAdd.push(supabasePart);
                } else {
                  // Check if data differs (quantity, comments, etc.)
                  const helperPart = helperMap.get(key);
                  if (helperPart.qty !== supabasePart.quantity || 
                      helperPart.comments !== supabasePart.comments) {
                    toUpdate.push({ key, supabasePart, helperPart });
                  }
                }
              });
              
              // Check helper parts for removals
              helperParts.forEach(helperPart => {
                const key = helperPart.pcode || helperPart.oem || helperPart.catalog_code;
                if (!supabaseMap.has(key)) {
                  toRemove.push(key);
                }
              });
              
              console.log('ğŸ“Š SESSION 17: Differences - Add:', toAdd.length, 'Update:', toUpdate.length, 'Remove:', toRemove.length);
              
              if (toAdd.length > 0 || toUpdate.length > 0 || toRemove.length > 0) {
                // Apply changes
                let updatedParts = [...helperParts];
                
                // Remove parts not in Supabase
                if (toRemove.length > 0) {
                  updatedParts = updatedParts.filter(p => {
                    const key = p.pcode || p.oem || p.catalog_code;
                    return !toRemove.includes(key);
                  });
                  console.log('ğŸ—‘ï¸ SESSION 17: Removed', toRemove.length, 'parts not in Supabase');
                }
                
                // Update existing parts
                toUpdate.forEach(({ key, supabasePart }) => {
                  const index = updatedParts.findIndex(p => 
                    (p.pcode || p.oem || p.catalog_code) === key
                  );
                  if (index !== -1) {
                    updatedParts[index].qty = supabasePart.quantity;
                    updatedParts[index].quantity = supabasePart.quantity;
                    updatedParts[index].comments = supabasePart.comments || '';
                  }
                });
                console.log('âœï¸ SESSION 17: Updated', toUpdate.length, 'parts with Supabase data');
                
                // Add new parts from Supabase
                toAdd.forEach(supabasePart => {
                  updatedParts.push({
                    name: supabasePart.part_name || supabasePart.pcode,
                    pcode: supabasePart.pcode,
                    oem: supabasePart.oem,
                    qty: supabasePart.quantity || 1,
                    quantity: supabasePart.quantity || 1,
                    group: supabasePart.part_family || '',
                    part_family: supabasePart.part_family || '',
                    source: supabasePart.source || '××§×•×¨×™',
                    supplier: supabasePart.supplier_name || '',
                    comments: supabasePart.comments || '',
                    catalog_code: supabasePart.pcode || supabasePart.oem || '',
                    selected_at: supabasePart.selected_at
                  });
                });
                console.log('â• SESSION 17: Added', toAdd.length, 'new parts from Supabase');
                
                // Update helper with merged data (no duplicates)
                window.helper.parts_search.selected_parts = updatedParts;
                
                // Save to sessionStorage
                try {
                  sessionStorage.setItem('helper', JSON.stringify(window.helper));
                  console.log('âœ… SESSION 17: Smart sync complete - no duplicates');
                } catch (e) {
                  console.error('âŒ SESSION 17: Failed to save helper:', e);
                }
              } else {
                console.log('âœ… SESSION 17: Helper and Supabase already in sync - no changes needed');
              }
            } else {
              console.warn('âš ï¸ SESSION 17: helper.parts_search not initialized, skipping sync');
            }
          }
        } else {
          console.log('â„¹ï¸ SESSION 17: No plate number available for Supabase query');
        }
      } catch (error) {
        console.error('âŒ SESSION 17: Exception loading from Supabase:', error);
      }
    }
    
    // SESSION 19: Read from current_selected_list (current session only) for display
    partsToDisplay = window.helper?.parts_search?.current_selected_list || [];
    
    console.log(`âœ… SESSION 19: Displaying ${partsToDisplay.length} parts from current_selected_list`);
    
    // Update count display
    if (countDisplay) {
      countDisplay.textContent = partsToDisplay.length;
      console.log(`ğŸ“Š SESSION 19: Updated count display to ${partsToDisplay.length}`);
    }
    
    if (partsToDisplay.length === 0) {
      listUI.innerHTML = '<li style="color: #6b7280; font-style: italic; padding: 10px; text-align: center;">××™×Ÿ ×—×œ×§×™× ×‘×¨×©×™××”</li>';
      managementButtons.style.display = 'none';
      return;
    }
    
    // Show management buttons when there are parts
    managementButtons.style.display = 'block';
    
    listUI.innerHTML = partsToDisplay.map((item, index) => {
      // SESSION 18: Check if part is from different vehicle (compatibility part)
      const userCarMake = window.helper?.vehicle?.manufacturer || window.helper?.meta?.make;
      const userCarModel = window.helper?.vehicle?.model || window.helper?.meta?.model;
      const isCompatibilityPart = (item.part_make && item.part_make !== userCarMake) || 
                                   (item.part_model && item.part_model !== userCarModel);
      
      const compatibilityBadge = isCompatibilityPart ? `
        <div style="
          background: #fef3c7; 
          border: 1px solid #fbbf24; 
          color: #92400e; 
          padding: 4px 8px; 
          border-radius: 4px; 
          font-size: 11px; 
          margin-top: 4px;
          display: inline-block;
        ">
          â„¹ï¸ ×—×œ×§ ×ª×•×× ×-${item.part_make || ''} ${item.part_model || ''} 
          ${item.part_year_from ? `(${item.part_year_from}${item.part_year_to ? '-' + item.part_year_to : ''})` : ''}
        </div>
      ` : '';
      
      return `
      <li style="
        margin-bottom: 8px; 
        padding: 12px; 
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); 
        border-radius: 8px; 
        border: 1px solid #cbd5e1;
        position: relative;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
      ">
        <div style="flex: 1;">
          <div style="font-weight: bold; color: #1e40af; margin-bottom: 4px;">
            ${item.group} - ${item.name}
          </div>
          <div style="font-size: 12px; color: #64748b;">
            ×›××•×ª: <strong>${item.qty}</strong> | ××§×•×¨: <strong>${item.source}</strong>
            ${item.price ? ` | ××—×™×¨: <strong style="color: #059669;">â‚ª${item.price}</strong>` : ''}
            ${item.supplier ? ` | ×¡×¤×§: <strong>${item.supplier}</strong>` : ''}
          </div>
          ${compatibilityBadge}
        </div>
        <div style="display: flex; gap: 5px; align-items: center;">
          <button type="button" onclick="editPart(${index})" 
                  style="
                    background: #f59e0b; 
                    color: white; 
                    border: none; 
                    padding: 6px 10px; 
                    border-radius: 5px; 
                    cursor: pointer; 
                    font-size: 12px;
                    font-weight: bold;
                  " 
                  title="×¢×¨×•×š ×—×œ×§">
            âœï¸
          </button>
          <button type="button" onclick="handleDeletePart(${index})" 
                  style="
                    background: #dc3545; 
                    color: white; 
                    border: none; 
                    padding: 6px 10px; 
                    border-radius: 5px; 
                    cursor: pointer; 
                    font-size: 12px;
                    font-weight: bold;
                  " 
                  title="××—×§ ×—×œ×§">
            ğŸ—‘ï¸
          </button>
        </div>
      </li>
      `;
    }).join('');
  }
  
  // âœ… NEW: Edit part functionality
  function editPart(index) {
    // SESSION 15: Read from current_selected_list
    const currentList = window.helper?.parts_search?.current_selected_list || [];
    const part = currentList[index];
    if (!part) return;
    
    // Create edit modal
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); display: flex; align-items: center;
      justify-content: center; z-index: 10000; direction: rtl;
    `;
    
    modal.innerHTML = `
      <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
        <h3 style="color: #1e3a8a; margin-bottom: 20px; text-align: center;">âœï¸ ×¢×¨×•×š ×—×œ×§</h3>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">×§×‘×•×¦×ª ×—×œ×§×™×:</label>
          <select id="editPartGroup" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
            <option value="">×‘×—×¨ ×§×˜×’×•×¨×™×”</option>
          </select>
        </div>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">×©× ×”×—×œ×§:</label>
          <input type="text" id="editPartName" value="${part.name}" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
        </div>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">×›××•×ª:</label>
          <input type="number" id="editPartQuantity" value="${part.qty}" min="1" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
        </div>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">××§×•×¨:</label>
          <select id="editPartSource" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
            <option value="××§×•×¨×™" ${part.source === '××§×•×¨×™' ? 'selected' : ''}>××§×•×¨×™</option>
            <option value="×ª×—×œ×™×¤×™" ${part.source === '×ª×—×œ×™×¤×™' ? 'selected' : ''}>×ª×—×œ×™×¤×™</option>
            <option value="××©×•××©" ${part.source === '××©×•××©' ? 'selected' : ''}>××©×•××©</option>
            <option value="×”×›×œ" ${part.source === '×”×›×œ' ? 'selected' : ''}>×”×›×œ</option>
          </select>
        </div>
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">×”×¢×¨×•×ª:</label>
          <textarea id="editPartComments" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; resize: vertical;">${part.comments || ''}</textarea>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button onclick="saveEditedPart(${index})" style="background: #10b981; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
            ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×
          </button>
          <button onclick="this.closest('[style*=fixed]').remove()" style="background: #6b7280; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer;">
            âœ• ×‘×™×˜×•×œ
          </button>
        </div>
      </div>
    `;
    
    modal.onclick = (e) => e.target === modal && modal.remove();
    document.body.appendChild(modal);
    
    // SESSION 17 TASK 1: Populate categories with correct field matching
    const groupSelect = modal.querySelector('#editPartGroup');
    const partGroup = part.group || part.part_family || part['×§×‘×•×¦×”'] || '';
    console.log('ğŸ” SESSION 17: Populating group dropdown, part group:', partGroup);
    
    if (window.PARTS_BANK) {
      Object.keys(window.PARTS_BANK).forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        if (category === partGroup) option.selected = true;
        groupSelect.appendChild(option);
      });
    }
    
    // SESSION 17: If no PARTS_BANK, add part's group as option
    if (!window.PARTS_BANK && partGroup) {
      const option = document.createElement('option');
      option.value = partGroup;
      option.textContent = partGroup;
      option.selected = true;
      groupSelect.appendChild(option);
    }
  }
  
  // SESSION 16: Save edited part - Updates current_selected_list, Supabase, sessionStorage
  async function saveEditedPart(index) {
    const modal = document.querySelector('[style*="position: fixed"]');
    const group = modal.querySelector('#editPartGroup').value;
    const name = modal.querySelector('#editPartName').value;
    const qty = modal.querySelector('#editPartQuantity').value;
    const source = modal.querySelector('#editPartSource').value;
    const comments = modal.querySelector('#editPartComments').value;
    
    if (!group || !name) {
      alert('×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™×');
      return;
    }
    
    try {
      // SESSION 15: Get current part
      const currentList = window.helper?.parts_search?.current_selected_list || [];
      const part = currentList[index];
      if (!part) {
        alert('×©×’×™××”: ×œ× × ××¦× ×—×œ×§ ×œ×¢×¨×™×›×”');
        return;
      }
      
      // SESSION 16: Extract identifiers (needed for Supabase AND helper operations)
      const pcode = part.pcode || part['××¡×¤×¨ ×§×˜×œ×•×’×™'];
      const oem = part.oem || part['××¡×¤×¨ OEM'];
      const selectedAt = part.selected_at;
      
      // SESSION 16: Update Supabase first with correct field mappings
      if (window.supabase) {
        const plateInput = document.getElementById('plate');
        const plate = plateInput?.value?.trim() || window.helper?.meta?.plate;
        
        console.log('ğŸ“‹ SESSION 16: Edit part identifiers:', { plate, pcode, oem, selectedAt });
        
        if (plate && (pcode || oem)) {
          let updateQuery = window.supabase
            .from('selected_parts')
            .update({
              part_family: group,
              part_name: name,
              quantity: parseInt(qty),
              source,
              comments: comments || null
            })
            .eq('plate', plate);
          
          // SESSION 16: Match by pcode OR oem ONLY (no timestamp)
          // Reason: Timestamp gets URL-encoded in helper causing Supabase 400 errors
          // Trade-off: If user has same part multiple times, ALL instances will be updated
          if (pcode) {
            updateQuery = updateQuery.eq('pcode', pcode);
            console.log('âœ… SESSION 16: Matching by pcode:', pcode);
          } else if (oem) {
            updateQuery = updateQuery.eq('oem', oem);
            console.log('âœ… SESSION 16: Matching by oem:', oem);
          }
          
          const { error } = await updateQuery;
          
          if (error) {
            console.error('âŒ SESSION 16: Supabase update failed:', error);
            alert(`×©×’×™××” ×‘×¢×“×›×•×Ÿ ×‘×©×¨×ª: ${error.message}`);
            return;
          }
          
          console.log('âœ… SESSION 16: Part updated in Supabase');
        }
      }
      
      // SESSION 16: Update in current_selected_list
      currentList[index] = {
        ...part,
        group,
        name,
        qty: parseInt(qty),
        quantity: parseInt(qty),
        source,
        comments: comments || '',
        modified_at: new Date().toISOString()
      };
      
      console.log('âœ… SESSION 16: Part updated in current_selected_list');
      
      // SESSION 16: Also update in selected_parts cumulative array if present
      // Match by pcode/oem + timestamp (timestamp safe here - not sent to Supabase)
      const selectedParts = window.helper?.parts_search?.selected_parts || [];
      const cumulativeIndex = selectedParts.findIndex(p => 
        p.selected_at === selectedAt && 
        ((pcode && p.pcode === pcode) || (oem && p.oem === oem))
      );
      
      if (cumulativeIndex !== -1) {
        selectedParts[cumulativeIndex] = {
          ...selectedParts[cumulativeIndex],
          group,
          name,
          qty: parseInt(qty),
          quantity: parseInt(qty),
          source,
          comments: comments || '',
          modified_at: new Date().toISOString()
        };
        console.log('âœ… SESSION 16: Also updated part in selected_parts cumulative array');
      }
      
      // SESSION 16: Save to sessionStorage
      sessionStorage.setItem('helper', JSON.stringify(window.helper));
      console.log('âœ… SESSION 16: Saved helper to sessionStorage');
      
      // Update the display
      updateSelectedPartsList();
      
      // Close modal
      modal.remove();
      
      // Show notification
      if (typeof showNotification === 'function') {
        showNotification(`×¢×•×“×›×Ÿ ×—×œ×§: ${name}`, 'success');
      }
      
      console.log(`âœ… SESSION 15: Edited part: ${group} - ${name} (${qty}x ${source})`);
    } catch (error) {
      console.error('âŒ SESSION 15: Error in saveEditedPart:', error);
      alert(`×©×’×™××” ×‘×©××™×¨×ª ×¢×¨×™×›×”: ${error.message}`);
    }
  }
  
  // SESSION 15: Delete part functionality - Uses current_selected_list + timestamp
  async function deletePart(index) {
    // SESSION 15: Read from current_selected_list (not selected_parts)
    const currentList = window.helper?.parts_search?.current_selected_list || [];
    const part = currentList[index];
    if (!part) {
      console.error('âŒ SESSION 15: No part found at index', index);
      return;
    }
    
    const confirmDelete = confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×—×œ×§?\n\n${part.group || part.part_family || part.name} - ${part.name || part['×ª×™××•×¨']}\n×›××•×ª: ${part.qty || part.quantity} | ××§×•×¨: ${part.source || part['×¡×•×’ ×—×œ×§']}`);
    
    if (confirmDelete) {
      try {
        // SESSION 15: FIRST check if Supabase is available
        if (!window.supabase) {
          console.error('âŒ SESSION 15: Supabase not available');
          alert('×©×’×™××”: ××¢×¨×›×ª ×”× ×ª×•× ×™× ×œ× ×–××™× ×”. ×× × ×¨×¢× ×Ÿ ××ª ×”×“×£.');
          return;
        }
        
        // SESSION 16: Get plate and identifiers
        const plateInput = document.getElementById('plate');
        const plate = plateInput?.value?.trim() || window.helper?.meta?.plate;
        const pcode = part.pcode || part['××¡×¤×¨ ×§×˜×œ×•×’×™'];
        const oem = part.oem || part['××¡×¤×¨ OEM'];
        const selectedAt = part.selected_at;
        
        if (!plate) {
          console.error('âŒ SESSION 16: No plate number available');
          alert('×©×’×™××”: ×œ× × ××¦× ××¡×¤×¨ ×¨×™×©×•×™. ×× × ×”×–×Ÿ ××¡×¤×¨ ×¨×™×©×•×™ ×‘×©×“×” ×”×—×™×¤×•×©.');
          return;
        }
        
        if (!pcode && !oem) {
          console.error('âŒ SESSION 16: No pcode or oem available for part:', part);
          alert('×©×’×™××”: ×—×¡×¨ ××¡×¤×¨ ×§×˜×œ×•×’×™ ××• OEM ×œ×—×œ×§');
          return;
        }
        
        console.log('ğŸ“‹ SESSION 16: Deleting part:', { plate, pcode, oem, selectedAt });
        
        // SESSION 16: STEP 1 - Delete from Supabase using plate + (pcode OR oem) ONLY
        // Reason: Timestamp gets URL-encoded in helper causing Supabase 400 errors
        // Trade-off: If user has same part multiple times, ALL instances will be deleted
        let deleteQuery = window.supabase
          .from('selected_parts')
          .delete()
          .eq('plate', plate);
        
        // Use pcode (catalog code) if available, otherwise oem
        if (pcode) {
          deleteQuery = deleteQuery.eq('pcode', pcode);
          console.log('âœ… SESSION 16: Matching by pcode:', pcode);
        } else if (oem) {
          deleteQuery = deleteQuery.eq('oem', oem);
          console.log('âœ… SESSION 16: Matching by oem:', oem);
        }
        
        const { error } = await deleteQuery;
        
        if (error) {
          console.error('âŒ SESSION 16: Supabase delete failed:', error);
          alert(`×©×’×™××” ×‘××—×™×§×” ××”×©×¨×ª: ${error.message}\n\n×”×—×œ×§ ×œ× × ××—×§.`);
          return;
        }
        
        console.log('âœ… SESSION 16: Part deleted from Supabase successfully');
        
        // SESSION 16: STEP 2 - Delete from current_selected_list
        currentList.splice(index, 1);
        console.log('âœ… SESSION 16: Part removed from current_selected_list');
        
        // SESSION 16: STEP 3 - Also delete from selected_parts cumulative array if present
        // Match by pcode/oem + timestamp (timestamp safe here - not sent to Supabase)
        const selectedParts = window.helper?.parts_search?.selected_parts || [];
        const cumulativeIndex = selectedParts.findIndex(p => 
          p.selected_at === selectedAt && 
          ((pcode && p.pcode === pcode) || (oem && p.oem === oem))
        );
        
        if (cumulativeIndex !== -1) {
          selectedParts.splice(cumulativeIndex, 1);
          console.log('âœ… SESSION 16: Also deleted part from selected_parts cumulative array');
        }
        
        // SESSION 16: STEP 4 - Save to sessionStorage
        sessionStorage.setItem('helper', JSON.stringify(window.helper));
        console.log('âœ… SESSION 16: Saved helper to sessionStorage');
        
        // SESSION 16: STEP 5 - Update UI
        updateSelectedPartsList();
        
        // Show success notification
        if (typeof showNotification === 'function') {
          showNotification(`× ××—×§ ×—×œ×§: ${part.name || part['×ª×™××•×¨']}`, 'success');
        }
        
        console.log(`âœ… SESSION 16: Successfully deleted part from current session`);
      } catch (error) {
        console.error('âŒ SESSION 16: Unexpected error in deletePart:', error);
        alert(`×©×’×™××” ×œ× ×¦×¤×•×™×” ×‘××—×™×§×ª ×”×—×œ×§: ${error.message}`);
      }
    }
  }
  
  // SESSION 14 TASK 2: Clear all parts functionality - MUST delete from Supabase first
  async function clearAllParts() {
    // Read from helper (source of truth)
    const partsCount = window.helper?.parts_search?.selected_parts?.length || 0;
    
    if (partsCount === 0) {
      alert('××™×Ÿ ×—×œ×§×™× ×‘×¨×©×™××” ×œ××—×™×§×”');
      return;
    }
    
    const confirmClear = confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”×—×œ×§×™× ××”×¨×©×™××”?\n\n×™×™××—×§×• ${partsCount} ×—×œ×§×™×.`);
    
    if (confirmClear) {
      try {
        // SESSION 14: FIRST check if Supabase is available
        if (!window.supabase) {
          console.error('âŒ SESSION 14: Supabase not available');
          alert('×©×’×™××”: ××¢×¨×›×ª ×”× ×ª×•× ×™× ×œ× ×–××™× ×”. ×× × ×¨×¢× ×Ÿ ××ª ×”×“×£.');
          return; // STOP - don't clear UI if Supabase not available
        }
        
        // SESSION 14: Get plate from input field (same as deletePart)
        const plateInput = document.getElementById('plate');
        const plate = plateInput?.value?.trim() || window.helper?.plate;
        
        if (!plate) {
          console.error('âŒ SESSION 14: No plate number available');
          alert('×©×’×™××”: ×œ× × ××¦× ××¡×¤×¨ ×¨×™×©×•×™. ×× × ×”×–×Ÿ ××¡×¤×¨ ×¨×™×©×•×™ ×‘×©×“×” ×”×—×™×¤×•×©.');
          return; // STOP
        }
        
        console.log('ğŸ“‹ SESSION 14: Using plate number:', plate);
        
        // SESSION 14: STEP 1 - Delete from Supabase FIRST
        console.log('ğŸ—‘ï¸ SESSION 14: Deleting all parts from Supabase for plate:', plate);
        const { error } = await window.supabase
          .from('selected_parts')
          .delete()
          .eq('plate', plate);
        
        // SESSION 14: Check for errors - STOP if delete failed
        if (error) {
          console.error('âŒ SESSION 14: Supabase delete all failed:', error);
          alert(`×©×’×™××” ×‘××—×™×§×” ××”×©×¨×ª: ${error.message}\n\n×”×—×œ×§×™× ×œ× × ××—×§×•.`);
          return; // STOP - don't clear UI if Supabase failed
        }
        
        console.log('âœ… SESSION 14: All parts deleted from Supabase successfully');
        
        // SESSION 14: STEP 2 - Only now clear helper (after Supabase success)
        if (window.helper?.parts_search) {
          window.helper.parts_search.selected_parts = [];
          window.helper.parts_search.current_selected_list = [];
          window.helper.parts_search.current_list_saved = false;
        }
        console.log('âœ… SESSION 14: Helper arrays cleared (cumulative + current)');
        
        // SESSION 19: No need to clear selectedParts (deprecated array)
        
        // SESSION 14: STEP 4 - Update UI
        updateSelectedPartsList();
        
        // Show success notification
        if (typeof showNotification === 'function') {
          showNotification(`× ××—×§×• ${partsCount} ×—×œ×§×™× ××”×¨×©×™××”`, 'success');
        }
        
        console.log(`âœ… SESSION 14: Successfully cleared all ${partsCount} parts from list`);
      } catch (error) {
        console.error('âŒ SESSION 14: Unexpected error in clearAllParts:', error);
        alert(`×©×’×™××” ×œ× ×¦×¤×•×™×” ×‘××—×™×§×ª ×”×—×œ×§×™×: ${error.message}`);
      }
    }
  }
  
  // SESSION 14 STEP 3: Save current session to cumulative list
  async function saveCurrentToList() {
    const currentList = window.helper?.parts_search?.current_selected_list || [];
    const alreadySaved = window.helper?.parts_search?.current_list_saved || false;
    
    if (currentList.length === 0) {
      alert('××™×Ÿ ×—×œ×§×™× ×‘×¨×©×™××” ×”× ×•×›×—×™×ª ×œ×©××™×¨×”');
      return;
    }
    
    // SESSION 14 FIX 4: Check if already saved
    if (alreadySaved) {
      alert('×”×¨×©×™××” ×”× ×•×›×—×™×ª ×›×‘×¨ × ×©××¨×”. × ×§×” ××ª ×”×¨×©×™××” ×œ×”×ª×—×™×œ ×—×“×©.');
      return;
    }
    
    const confirmSave = confirm(`×”×× ×œ×©××•×¨ ${currentList.length} ×—×œ×§×™× ×œ×¨×©×™××” ×”××¦×˜×‘×¨×ª?`);
    
    if (confirmSave) {
      try {
        const plate = window.helper?.meta?.plate || window.helper?.meta?.license_plate;
        
        // SESSION 20: TASK 3 - Save each part to Supabase FIRST
        if (plate && window.supabase && window.partsSearchSupabaseService) {
          console.log(`ğŸ’¾ SESSION 20: Saving ${currentList.length} parts to Supabase...`);
          let successCount = 0;
          let errorCount = 0;
          
          for (const part of currentList) {
            try {
              const partId = await window.partsSearchSupabaseService.saveSelectedPart(
                plate,
                part,
                {
                  searchResultId: part.search_result_id || null,
                  searchContext: {
                    make: window.helper?.vehicle?.make,
                    model: window.helper?.vehicle?.model,
                    year: window.helper?.vehicle?.year
                  }
                }
              );
              
              if (partId) {
                successCount++;
                console.log(`âœ… SESSION 20: Part ${successCount}/${currentList.length} saved to Supabase:`, partId);
              }
            } catch (error) {
              errorCount++;
              console.error(`âŒ SESSION 20: Error saving part to Supabase:`, error);
            }
          }
          
          console.log(`ğŸ’¾ SESSION 20: Supabase save complete: ${successCount} success, ${errorCount} errors`);
          
          clearPartsCache();
        }
        
        // SESSION 17: Initialize selected_parts if needed
        if (!window.helper.parts_search.selected_parts) {
          window.helper.parts_search.selected_parts = [];
        }
        
        // SESSION 17: Filter out duplicates before appending (smart sync may have already loaded these)
        const existingKeys = new Set(
          window.helper.parts_search.selected_parts.map(p => p.pcode || p.oem || p.catalog_code)
        );
        
        const newParts = currentList.filter(part => {
          const key = part.pcode || part.oem || part.catalog_code;
          return !existingKeys.has(key);
        });
        
        if (newParts.length > 0) {
          window.helper.parts_search.selected_parts.push(...newParts);
          console.log(`âœ… SESSION 17: Added ${newParts.length} new parts (skipped ${currentList.length - newParts.length} duplicates)`);
        } else {
          console.log('â„¹ï¸ SESSION 17: All parts already in cumulative list - no new parts to add');
        }
        
        // Set saved flag (DON'T clear list - user still needs to see it)
        window.helper.parts_search.current_list_saved = true;
        console.log('âœ… SESSION 14: Set current_list_saved flag to true');
        
        // SESSION 15: Save to sessionStorage
        sessionStorage.setItem('helper', JSON.stringify(window.helper));
        console.log('âœ… SESSION 15: Saved helper to sessionStorage');
        
        // Update UI (list remains visible)
        updateSelectedPartsList();
        
        // Show success message
        if (typeof showNotification === 'function') {
          showNotification(`× ×©××¨×• ${currentList.length} ×—×œ×§×™× ×œ×¨×©×™××” ×”××¦×˜×‘×¨×ª`, 'success');
        }
        
        console.log(`âœ… SESSION 14: Saved ${currentList.length} parts to cumulative list, cleared current session`);
      } catch (error) {
        console.error('âŒ SESSION 14: Error in saveCurrentToList:', error);
        alert(`×©×’×™××” ×‘×©××™×¨×”: ${error.message}`);
      }
    }
  }
  
  // SESSION 14 FIX 3: Clear current list with auto-save if not saved
  function clearCurrentList() {
    const currentList = window.helper?.parts_search?.current_selected_list || [];
    const alreadySaved = window.helper?.parts_search?.current_list_saved || false;
    
    if (currentList.length === 0) {
      alert('×”×¨×©×™××” ×›×‘×¨ ×¨×™×§×”');
      return;
    }
    
    const confirmClear = confirm(`×”×× ×œ× ×§×•×ª ××ª ×”×¨×©×™××” (${currentList.length} ×—×œ×§×™×)?`);
    
    if (confirmClear) {
      // If NOT already saved, save first
      if (!alreadySaved && currentList.length > 0) {
        if (!window.helper.parts_search.selected_parts) {
          window.helper.parts_search.selected_parts = [];
        }
        window.helper.parts_search.selected_parts.push(...currentList);
        console.log(`âœ… SESSION 14: Auto-saved ${currentList.length} parts before clearing`);
      }
      
      // Clear current list
      window.helper.parts_search.current_selected_list = [];
      window.helper.parts_search.current_list_saved = false;
      
      // SESSION 15: Save to sessionStorage
      sessionStorage.setItem('helper', JSON.stringify(window.helper));
      console.log('âœ… SESSION 15: Saved helper to sessionStorage after clear');
      
      // Update UI
      updateSelectedPartsList();
      
      if (typeof showNotification === 'function') {
        showNotification('×”×¨×©×™××” × ×•×§×ª×”', 'success');
      }
      
      console.log('âœ… SESSION 14: Cleared current list and reset flag');
    }
  }
  
  // âœ… NEW: Duplicate last part functionality
  async function duplicateSelectedPart() {
    // SESSION 19: Read from current_selected_list
    const currentList = window.helper?.parts_search?.current_selected_list || [];
    
    if (currentList.length === 0) {
      alert('××™×Ÿ ×—×œ×§×™× ×‘×¨×©×™××” ×œ×©×›×¤×•×œ');
      return;
    }
    
    const lastPart = currentList[currentList.length - 1];
    const duplicatedPart = {
      ...lastPart,
      id: `part_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      added_at: new Date().toISOString(),
      duplicated_from: lastPart.id
    };
    
    // SESSION 19: Write to current_selected_list
    currentList.push(duplicatedPart);
    sessionStorage.setItem('helper', JSON.stringify(window.helper));
    clearPartsCache();
    updateSelectedPartsList();
    
    // Show notification
    if (typeof showNotification === 'function') {
      showNotification(`×©×•×›×¤×œ ×—×œ×§: ${lastPart.name}`, 'success');
    }
    
    console.log(`ğŸ“„ SESSION 19: Duplicated part: ${lastPart.group} - ${lastPart.name}`);
  }
  
  // SESSION 14 TASK 1: Async wrapper functions for onclick handlers
  // HTML onclick can't properly await async functions, so we wrap them
  function handleDeletePart(index) {
    deletePart(index).catch(error => {
      console.error('âŒ SESSION 14: Delete failed:', error);
      alert('×©×’×™××” ×‘××—×™×§×ª ×”×—×œ×§: ' + error.message);
    });
  }
  
  function handleClearAll() {
    clearAllParts().catch(error => {
      console.error('âŒ SESSION 14: Clear all failed:', error);
      alert('×©×’×™××” ×‘××—×™×§×ª ×”×¨×©×™××”: ' + error.message);
    });
  }
  
  // Make functions globally available
  window.saveCurrentToList = saveCurrentToList; // SESSION 14: Save button
  window.clearCurrentList = clearCurrentList; // SESSION 14 FIX: Clear current list button
  window.editPart = editPart;
  window.saveEditedPart = saveEditedPart;
  window.deletePart = deletePart;
  window.clearAllParts = clearAllParts;
  window.duplicateSelectedPart = duplicateSelectedPart;
  window.handleDeletePart = handleDeletePart; // SESSION 14: Wrapper function
  window.handleClearAll = handleClearAll; // SESSION 14: Wrapper function

  // âœ… NEW: Load saved selected parts from helper on page initialization
  function loadSavedPartsFromHelper() {
    // SESSION 19: This function is now DEPRECATED
    // Helper is fallback only, not used for loading
    // Parts are loaded from Supabase via getSelectedParts()
    console.log('âš ï¸ SESSION 19: loadSavedPartsFromHelper is deprecated - use getSelectedParts() instead');
    console.log('ğŸ“¦ Helper is fallback only in new architecture');
  }

  window.loadSavedPartsFromHelper = loadSavedPartsFromHelper;

  // SESSION 14 TASK 3: Load selected parts from Supabase on page refresh
  async function loadSelectedPartsFromSupabase() {
    console.log('ğŸ“¦ SESSION 14: Loading selected parts from Supabase...');
    
    // SESSION 14: Get plate from input field (same as delete/clear functions)
    const plateInput = document.getElementById('plate');
    const plate = plateInput?.value?.trim() || window.helper?.plate;
    
    if (!plate) {
      console.log('âš ï¸ SESSION 14: No plate number in input field, skipping Supabase load');
      return;
    }
    
    console.log('ğŸ“‹ SESSION 14: Loading parts for plate:', plate);
    
    try {
      if (!window.supabase) {
        console.log('âš ï¸ SESSION 14: Supabase not available yet, skipping load');
        return;
      }
      
      console.log('ğŸ” SESSION 14 DEBUG: Querying Supabase with plate:', plate);
      
      const { data, error } = await window.supabase
        .from('selected_parts')
        .select('*')
        .eq('plate', plate)
        .order('selected_at', { ascending: false });
      
      console.log('ğŸ” SESSION 14 DEBUG: Supabase query result:', {
        error: error,
        dataCount: data?.length || 0,
        data: data
      });
      
      if (error) {
        console.error('âŒ SESSION 14: Error loading from Supabase:', error);
        return;
      }
      
      if (data && data.length > 0) {
        console.log(`âœ… SESSION 14: Loaded ${data.length} parts from Supabase for plate ${plate}`);
        
        // Convert Supabase data to helper format
        const helperParts = data.map(part => ({
          "name": part.cat_num_desc || part.part_name || "",
          "×ª×™××•×¨": part.cat_num_desc || "",
          "×›××•×ª": part.quantity || 1,
          "qty": part.quantity || 1,
          "group": part.part_family || "",
          "××—×™×¨": part.price ? `â‚ª${parseFloat(part.price).toLocaleString('he-IL')}` : "",
          "×¡×•×’ ×—×œ×§": part.source || "××§×•×¨×™",
          "×¡×¤×§": part.supplier_name || "",
          "supplier": part.supplier_name || "",
          "fromSuggestion": false,
          "entry_method": "catalog_search",
          "××™×§×•×": part.location || "×™×©×¨××œ",
          "×–××™× ×•×ª": part.availability || "×–××™×Ÿ",
          "××¡×¤×¨ OEM": part.oem || "",
          "×”×¢×¨×•×ª": part.comments || "",
          "price": parseFloat(part.price) || 0,
          "quantity": part.quantity || 1,
          "source": part.source || "××§×•×¨×™",
          "××¡×¤×¨ ×§×˜×œ×•×’×™": part.pcode || "",
          "pcode": part.pcode || "",
          "××©×¤×—×ª ×—×œ×§": part.part_family || "",
          "part_family": part.part_family || "",
          "make": part.make || "",
          "model": part.model || "",
          "year_from": part.year_from || null,
          "year_to": part.year_to || null,
          "catalog_item_id": part.catalog_item_id || part.id,
          "selected_at": part.selected_at,
          "plate_number": part.plate
        }));
        
        // Update helper
        if (!window.helper) window.helper = {};
        if (!window.helper.parts_search) window.helper.parts_search = {};
        window.helper.parts_search.selected_parts = helperParts;
        
        console.log('âœ… SESSION 14: Updated helper with loaded parts');
        
        // Update UI
        if (typeof updateSelectedPartsList === 'function') {
          updateSelectedPartsList();
        }
      } else {
        console.log('â„¹ï¸ SESSION 14: No selected parts found in Supabase for plate:', plate);
      }
    } catch (error) {
      console.error('âŒ SESSION 14: Error in loadSelectedPartsFromSupabase:', error);
    }
  }
  
  window.loadSelectedPartsFromSupabase = loadSelectedPartsFromSupabase;

  // âœ… MISSING FUNCTION: Define updatePartNameOptions for dropdown change
  function updatePartNameOptions() {
    const groupSelect = document.getElementById('part_group');
    const nameSelect = document.getElementById('part_name');
    
    if (!groupSelect || !nameSelect) return;
    
    const selectedGroup = groupSelect.value;
    nameSelect.innerHTML = '<option value="" disabled selected>×‘×—×¨ ×©× ×—×œ×§</option>';
    
    if (selectedGroup && window.PARTS_BANK && window.PARTS_BANK[selectedGroup]) {
      window.PARTS_BANK[selectedGroup].forEach(partName => {
        const option = document.createElement('option');
        option.value = partName;
        option.textContent = partName;
        nameSelect.appendChild(option);
      });
    }
    
    console.log(`ğŸ”„ Updated part name options for group: ${selectedGroup}`);
  }

  // Make functions globally available
  window.updateSelectedPartsList = updateSelectedPartsList;
  window.updatePartNameOptions = updatePartNameOptions;
  
  // SESSION 17: Load helper from sessionStorage into window.helper BEFORE refreshing UI
  const helperData = sessionStorage.getItem('helper');
  if (helperData) {
    window.helper = JSON.parse(helperData);
    console.log('âœ… SESSION 17: Loaded helper from sessionStorage:', window.helper);
  } else {
    console.warn('âš ï¸ SESSION 17: No helper data in sessionStorage');
  }
  
  // SESSION 17: Auto-refresh UI list from helper.parts_search.current_selected_list on page load
  console.log('ğŸ”„ SESSION 17: Auto-refreshing UI list from helper...');
  updateSelectedPartsList();

  const autofillFields = [
    'plate', 'manufacturer', 'model', 'model_code', 'trim', 'year',
    'engine_volume', 'engine_code', 'engine_type', 'vin', 'oem'
  ];
  autofillFields.forEach(key => {
    const val = sessionStorage.getItem(key);
    if (val) {
      const input = document.getElementById(key);
      if (input) {
        input.value = val;
        input.readOnly = true;
      }
    }
  });

  const auth = sessionStorage.getItem("auth");
  if (!auth) {
    alert("×”×’×™×©×” ×—×¡×•××” - ×× × ×”×ª×—×‘×¨ ×“×¨×š ×“×£ ×”×‘×™×ª");
    window.location.href = "index.html";
  }

  const logoutBtn = document.querySelector(".logout-btn");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", function (e) {
      e.preventDefault();
      sessionStorage.clear();
      window.location.href = "index.html";
    });
  }
  
  // SESSION 19: Create toggle popup using current_selected_list
  function createPartsListTogglePopup() {
    console.log('ğŸ¯ SESSION 21: Creating parts list toggle popup for internal browser');
    
    // SESSION 21 FIX: Get parts from search_query_list (parts TO SEARCH on external sites)
    // This mirrors the smart form purpose - showing what to search, not what's already selected
    const parts = window.helper?.parts_search?.search_query_list || [];
    
    if (parts.length === 0) {
      console.warn('âš ï¸ SESSION 21: No parts in search_query_list');
      return;
    }
    
    // Remove existing popup if any
    const existingPopup = document.getElementById('partsListTogglePopup');
    if (existingPopup) {
      existingPopup.remove();
    }
    
    // Create toggle popup
    const popup = document.createElement('div');
    popup.id = 'partsListTogglePopup';
    popup.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      width: 300px;
      max-height: 400px;
      background: white;
      border: 2px solid #3b82f6;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 10000;
      font-family: Arial, sans-serif;
      font-size: 14px;
      overflow-y: auto;
    `;
    
    const partsListHTML = parts.map((part, index) => `
      <div style="padding: 8px; border-bottom: 1px solid #eee; background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
        <div style="font-weight: bold; color: #1e40af;">${part.group} - ${part.name}</div>
        <div style="font-size: 12px; color: #6b7280;">
          ×›××•×ª: ${part.qty} | ××§×•×¨: ${part.source}
        </div>
      </div>
    `).join('');
    
    popup.innerHTML = `
      <div style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; padding: 12px; border-radius: 10px 10px 0 0; text-align: center;">
        <strong>×¨×©×™××ª ×—×œ×§×™× ××‘×•×§×©×™× (${parts.length})</strong>
      </div>
      <div style="padding: 12px;">
        <div style="max-height: 250px; overflow-y: auto; margin-bottom: 12px;">
          ${partsListHTML}
        </div>
        <div style="display: flex; gap: 8px; justify-content: center;">
          <button onclick="copyPartsListForSite()" style="
            background: #10b981; color: white; border: none; padding: 8px 12px; 
            border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;
          ">ğŸ“‹ ×”×¢×ª×§ ×¨×©×™××”</button>
          <button onclick="togglePopupVisibility()" style="
            background: #f59e0b; color: white; border: none; padding: 8px 12px; 
            border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;
          ">ğŸ‘ï¸ ×”×¡×ª×¨/×”×¦×’</button>
          <button onclick="closePartsListPopup()" style="
            background: #ef4444; color: white; border: none; padding: 8px 12px; 
            border-radius: 6px; cursor: pointer; font-size: 12px;
          ">âœ•</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(popup);
    
    // Make popup draggable
    let isDragging = false;
    let currentX, currentY, initialX, initialY;
    
    popup.addEventListener('mousedown', (e) => {
      if (e.target === popup || e.target.closest('.popup-header')) {
        isDragging = true;
        initialX = e.clientX - popup.offsetLeft;
        initialY = e.clientY - popup.offsetTop;
      }
    });
    
    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;
        popup.style.left = currentX + 'px';
        popup.style.top = currentY + 'px';
        popup.style.right = 'auto';
      }
    });
    
    document.addEventListener('mouseup', () => {
      isDragging = false;
    });
  }
  
  // âœ… Helper functions for toggle popup
  window.copyPartsListForSite = function() {
    // SESSION 21 FIX: Get parts from search_query_list (parts TO SEARCH)
    const parts = window.helper?.parts_search?.search_query_list || [];
    const partsText = parts.map(part => 
      `${part.group} - ${part.name} (×›××•×ª: ${part.qty}, ××§×•×¨: ${part.source})`
    ).join('\n');
    
    const vehicleInfo = `×¤×¨×˜×™ ×¨×›×‘:
×™×¦×¨×Ÿ: ${document.getElementById('manufacturer').value}
×“×’×: ${document.getElementById('model').value}
×©× ×”: ${document.getElementById('year').value}

×¨×©×™××ª ×—×œ×§×™× ××‘×•×§×©×™×:
${partsText}`;
    
    navigator.clipboard.writeText(vehicleInfo).then(() => {
      alert('âœ… ×¨×©×™××ª ×”×—×œ×§×™× ×”×•×¢×ª×§×” ×œ×œ×•×—!');
    }).catch(() => {
      alert('âŒ ×©×’×™××” ×‘×”×¢×ª×§×”');
    });
  };
  
  window.togglePopupVisibility = function() {
    const popup = document.getElementById('partsListTogglePopup');
    if (popup) {
      const content = popup.querySelector('div:last-child');
      if (content.style.display === 'none') {
        content.style.display = 'block';
        popup.style.height = 'auto';
      } else {
        content.style.display = 'none';
        popup.style.height = '44px';
      }
    }
  };
  
  window.closePartsListPopup = function() {
    const popup = document.getElementById('partsListTogglePopup');
    if (popup) {
      popup.remove();
    }
  };
  
  // Make function globally available
  window.createPartsListTogglePopup = createPartsListTogglePopup;

  // SESSION 19: Show all saved parts from Supabase table
  window.TEST_showAllSavedParts = async function() {
    console.log('ğŸ§ª SESSION 19: Loading all saved parts from Supabase...');
    
    const plate = document.getElementById('license_plate')?.value || 
                  document.getElementById('plate')?.value ||
                  window.helper?.meta?.plate;
    
    if (!plate) {
      alert('âŒ No plate number found!\n\nPlease enter a plate number first.');
      return;
    }
    
    try {
      // Use getSelectedParts to fetch from Supabase
      const parts = await getSelectedParts({ plate: plate });
      
      console.log('ğŸ“¦ SESSION 19: Retrieved parts from Supabase:', parts);
      
      // Store for copy function
      lastLoadedParts = parts;
      
      // Create display
      if (parts.length === 0) {
        alert('â„¹ï¸ No saved parts found in Supabase for plate: ' + plate);
        return;
      }
      
      // Show in modal
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border: 3px solid #10b981;
        border-radius: 16px;
        padding: 20px;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        z-index: 10001;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      `;
      
      // Store parts globally for edit function access
      window.TEST_currentModalParts = parts;
      
      const partsList = parts.map((part, index) => `
        <div style="padding: 10px; border-bottom: 1px solid #e5e7eb; background: ${index % 2 === 0 ? '#f9fafb' : 'white'}; display: flex; justify-content: space-between; align-items: center;">
          <div style="flex: 1;">
            <div style="font-weight: bold; color: #059669;">${part.part_family || part.group || 'N/A'} - ${part.part_name || part.name || 'N/A'}</div>
            <div style="font-size: 12px; color: #6b7280;">
              ×›××•×ª: ${part.quantity || part.qty || 1} | ××§×•×¨: ${part.source || 'N/A'}
            </div>
            <div style="font-size: 11px; color: #9ca3af;">
              ×§×•×“: ${part.pcode || part.oem || 'N/A'} | Created: ${part.created_at ? new Date(part.created_at).toLocaleString('he-IL') : 'N/A'}
            </div>
          </div>
          <div style="display: flex; gap: 5px; margin-right: 10px;">
            <button onclick="window.editPartFromModal(${index})" 
                    style="background: #f59e0b; color: white; border: none; padding: 6px 12px; 
                           border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">
              âœï¸ ×¢×¨×•×š
            </button>
            <button onclick="window.deletePartFromModal('${part.id}', '${part.plate}')" 
                    style="background: #ef4444; color: white; border: none; padding: 6px 12px; 
                           border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">
              ğŸ—‘ï¸ ××—×§
            </button>
          </div>
        </div>
      `).join('');
      
      modal.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h3 style="margin: 0; color: #059669;">ğŸ—‚ï¸ All Saved Parts (${parts.length})</h3>
          <button onclick="this.parentElement.parentElement.remove()" 
                  style="background: #ef4444; color: white; border: none; padding: 8px 16px; 
                         border-radius: 8px; cursor: pointer; font-weight: bold;">
            âœ• Close
          </button>
        </div>
        <div style="font-size: 13px; color: #6b7280; margin-bottom: 15px;">
          Plate: <strong>${plate}</strong>
        </div>
        <div style="max-height: 400px; overflow-y: auto;">
          ${partsList}
        </div>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e5e7eb; text-align: center;">
          <button onclick="window.TEST_syncHelperFromSupabase()" 
                  style="background: #3b82f6; color: white; border: none; padding: 10px 20px; 
                         border-radius: 8px; cursor: pointer; font-weight: bold; margin-right: 10px;">
            ğŸ”„ Sync to Helper
          </button>
          <button onclick="window.TEST_copyPartsJSON()" 
                  style="background: #8b5cf6; color: white; border: none; padding: 10px 20px; 
                         border-radius: 8px; cursor: pointer; font-weight: bold;">
            ğŸ“‹ Copy JSON
          </button>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Add backdrop
      const backdrop = document.createElement('div');
      backdrop.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 10000;
      `;
      backdrop.onclick = () => {
        modal.remove();
        backdrop.remove();
      };
      document.body.appendChild(backdrop);
      
    } catch (error) {
      console.error('âŒ SESSION 19: Error loading saved parts:', error);
      alert('âŒ Error loading parts:\n\n' + error.message);
    }
  };
  
  // SESSION 19: TEST - Copy parts JSON to clipboard
  let lastLoadedParts = [];
  window.TEST_copyPartsJSON = function() {
    navigator.clipboard.writeText(JSON.stringify(lastLoadedParts, null, 2))
      .then(() => alert('âœ… Parts JSON copied to clipboard!'))
      .catch(() => alert('âŒ Failed to copy'));
  };
  
  // SESSION 20: Delete part from test modal
  window.deletePartFromModal = async function(partId, plate) {
    console.log('ğŸ—‘ï¸ SESSION 20: Deleting part from modal:', partId);
    
    if (!partId || !plate) {
      alert('âŒ Missing part ID or plate number');
      return;
    }
    
    if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×—×œ×§ ×–×”?')) {
      return;
    }
    
    try {
      const { error } = await window.supabase
        .from('selected_parts')
        .delete()
        .eq('id', partId)
        .eq('plate', plate);
      
      if (error) {
        console.error('âŒ SESSION 20: Supabase delete error:', error);
        alert('âŒ ×©×’×™××” ×‘××—×™×§×”:\n\n' + error.message);
        return;
      }
      
      console.log('âœ… SESSION 20: Part deleted from Supabase');
      
      clearPartsCache();
      
      alert('âœ… ×”×—×œ×§ × ××—×§ ×‘×”×¦×œ×—×”');
      
      const modal = document.querySelector('[style*="z-index: 10001"]');
      const backdrop = document.querySelector('[style*="z-index: 10000"]');
      if (modal) modal.remove();
      if (backdrop) backdrop.remove();
      
      window.TEST_showAllSavedParts();
      
    } catch (error) {
      console.error('âŒ SESSION 20: Error deleting part:', error);
      alert('âŒ ×©×’×™××” ×‘××—×™×§×”:\n\n' + error.message);
    }
  };
  
  // SESSION 20: Edit part from test modal (copied structure from editPart function)
  window.editPartFromModal = async function(partIndex) {
    console.log('âœï¸ SESSION 20: Editing part from modal, index:', partIndex);
    
    const part = window.TEST_currentModalParts[partIndex];
    if (!part) {
      alert('âŒ ×—×œ×§ ×œ× × ××¦×');
      return;
    }
    console.log('ğŸ“ SESSION 20: Part to edit:', part);
    
    // Close the test modal
    const testModal = document.querySelector('[style*="z-index: 10001"]');
    const testBackdrop = document.querySelector('[style*="z-index: 10000"]');
    if (testModal) testModal.remove();
    if (testBackdrop) testBackdrop.remove();
    
    // Create edit modal (same structure as editPart function)
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); display: flex; align-items: center;
      justify-content: center; z-index: 10000; direction: rtl;
    `;
    
    modal.innerHTML = `
      <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
        <h3 style="color: #1e3a8a; margin-bottom: 20px; text-align: center;">âœï¸ ×¢×¨×•×š ×—×œ×§</h3>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">×§×‘×•×¦×ª ×—×œ×§×™×:</label>
          <select id="editPartGroup" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
            <option value="">×‘×—×¨ ×§×˜×’×•×¨×™×”</option>
          </select>
        </div>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">×©× ×”×—×œ×§:</label>
          <input type="text" id="editPartName" value="${part.part_name || part.name || ''}" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; background: #f9fafb;" readonly>
        </div>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">×›××•×ª:</label>
          <input type="number" id="editPartQuantity" value="${part.quantity || part.qty || 1}" min="1" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
        </div>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">××§×•×¨:</label>
          <select id="editPartSource" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
            <option value="××§×•×¨×™" ${part.source === '××§×•×¨×™' ? 'selected' : ''}>××§×•×¨×™</option>
            <option value="×—×œ×™×¤×™" ${part.source === '×—×œ×™×¤×™' || part.source === '×ª×—×œ×™×¤×™' ? 'selected' : ''}>×—×œ×™×¤×™</option>
            <option value="××©×•××©" ${part.source === '××©×•××©' ? 'selected' : ''}>××©×•××©</option>
            <option value="×”×›×œ" ${part.source === '×”×›×œ' ? 'selected' : ''}>×”×›×œ</option>
          </select>
        </div>
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">×”×¢×¨×•×ª:</label>
          <textarea id="editPartComments" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; resize: vertical;">${part.comments || ''}</textarea>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button onclick="window.saveEditedPartFromModal('${part.id}', '${part.plate}')" style="background: #10b981; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
            ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×
          </button>
          <button onclick="this.closest('[style*=fixed]').remove()" style="background: #6b7280; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer;">
            âœ• ×‘×™×˜×•×œ
          </button>
        </div>
      </div>
    `;
    
    modal.onclick = (e) => e.target === modal && modal.remove();
    document.body.appendChild(modal);
    
    // Populate categories dropdown
    const groupSelect = modal.querySelector('#editPartGroup');
    const partGroup = part.part_family || part.group || '';
    console.log('ğŸ” SESSION 20: Populating group dropdown, part group:', partGroup);
    
    if (window.PARTS_BANK) {
      Object.keys(window.PARTS_BANK).forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        if (category === partGroup) option.selected = true;
        groupSelect.appendChild(option);
      });
    }
    
    // If no PARTS_BANK, add part's group as option
    if (!window.PARTS_BANK && partGroup) {
      const option = document.createElement('option');
      option.value = partGroup;
      option.textContent = partGroup;
      option.selected = true;
      groupSelect.appendChild(option);
    }
  };
  
  // SESSION 20: Save edited part from modal
  window.saveEditedPartFromModal = async function(partId, plate) {
    console.log('ğŸ’¾ SESSION 20: Saving edited part:', partId);
    
    const modal = document.querySelector('[style*="position: fixed"]');
    const group = modal.querySelector('#editPartGroup')?.value;
    const name = modal.querySelector('#editPartName')?.value;
    const quantity = modal.querySelector('#editPartQuantity')?.value;
    const source = modal.querySelector('#editPartSource')?.value;
    const comments = modal.querySelector('#editPartComments')?.value;
    
    if (!group || !name) {
      alert('âŒ ×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™×');
      return;
    }
    
    if (!quantity || quantity < 1) {
      alert('âŒ ×›××•×ª ×œ× ×ª×§×™× ×”');
      return;
    }
    
    try {
      const { error } = await window.supabase
        .from('selected_parts')
        .update({
          part_family: group,
          part_name: name,
          quantity: parseInt(quantity),
          source: source,
          comments: comments || null
        })
        .eq('id', partId)
        .eq('plate', plate);
      
      if (error) {
        console.error('âŒ SESSION 20: Supabase update error:', error);
        alert('âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ:\n\n' + error.message);
        return;
      }
      
      console.log('âœ… SESSION 20: Part updated in Supabase');
      
      clearPartsCache();
      
      alert('âœ… ×”×—×œ×§ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”');
      
      // Close modal
      modal.remove();
      
      // Reopen test modal with updated data
      window.TEST_showAllSavedParts();
      
    } catch (error) {
      console.error('âŒ SESSION 20: Error updating part:', error);
      alert('âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ:\n\n' + error.message);
    }
  };
  
  // SESSION 19: TEST - Sync helper from Supabase
  window.TEST_syncHelperFromSupabase = async function() {
    console.log('ğŸ”„ SESSION 19: Syncing helper from Supabase...');
    
    const plate = document.getElementById('license_plate')?.value || 
                  document.getElementById('plate')?.value ||
                  window.helper?.meta?.plate;
    
    if (!plate) {
      alert('âŒ No plate number!');
      return;
    }
    
    try {
      const supabaseParts = await getSelectedParts({ plate: plate });
      
      if (!window.helper) window.helper = {};
      if (!window.helper.parts_search) window.helper.parts_search = {};
      
      // SESSION 20 FIX: Map Supabase fields to helper format (including comments)
      const mappedParts = supabaseParts.map(part => ({
        ...part,
        name: part.part_name || part.name || '',
        group: part.part_family || part.group || '',
        qty: part.quantity || part.qty || 1,
        comments: part.comments || '',
        part_name: part.part_name,
        part_family: part.part_family,
        quantity: part.quantity
      }));
      
      window.helper.parts_search.selected_parts = mappedParts;
      sessionStorage.setItem('helper', JSON.stringify(window.helper));
      
      console.log(`âœ… SESSION 19: Synced ${mappedParts.length} parts to helper.parts_search.selected_parts (with field mapping)`);
      alert(`âœ… Synced ${mappedParts.length} parts to helper!\n\nHelper is now in sync with Supabase.`);
      
    } catch (error) {
      console.error('âŒ SESSION 19: Sync error:', error);
      alert('âŒ Sync failed:\n\n' + error.message);
    }
  };

</script>
</body>
</html>
