<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
<meta charset="utf-8"/>
<script type="module" src="./webhook.js"></script>
<!-- SESSION 56: Load helper.js as regular script (not ES6 module) -->
<script src="./helper.js"></script>
<title>×”×¢×œ××ª ×ª××•× ×•×ª</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #1e293b 100%);
      background-attachment: fixed;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      direction: rtl;
      position: relative;
      overflow-x: hidden;
    }

    /* Animated background particles */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image:
        radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
      animation: float 20s ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes float {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.1); }
    }

    .container {
      max-width: 850px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(20px);
      padding: 35px;
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      position: relative;
      z-index: 1;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 30px;
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .business-name {
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 10px 0 8px 0;
      letter-spacing: -0.5px;
    }

    .logo {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      margin-bottom: 20px;
      border: 3px solid rgba(99, 102, 241, 0.3);
      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
      animation: logoGlow 3s ease-in-out infinite;
    }

    @keyframes logoGlow {
      0%, 100% { box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3); }
      50% { box-shadow: 0 8px 32px rgba(139, 92, 246, 0.5); }
    }

    h2 {
      font-size: 22px;
      margin: 15px 0 0 0;
      color: #e0e7ff;
      font-weight: 600;
    }

    .subtitle {
      color: #94a3b8;
      font-size: 16px;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .form-section {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 25px;
      margin-bottom: 25px;
    }

    .form-section h3 {
      color: #cbd5e1;
      margin-bottom: 20px;
      font-size: 18px;
      font-weight: 600;
    }

    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    .form-group {
      flex: 1;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #cbd5e1;
      font-size: 14px;
    }

    input[type="text"], input[type="password"], select {
      width: 100%;
      padding: 14px 16px;
      font-size: 15px;
      margin-bottom: 15px;
      border-radius: 12px;
      border: 1.5px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      color: #e2e8f0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-sizing: border-box;
      font-family: inherit;
    }

    input[type="text"]:focus, input[type="password"]:focus, select:focus {
      outline: none;
      border-color: #6366f1;
      background: rgba(255, 255, 255, 0.08);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1), 0 8px 16px rgba(0, 0, 0, 0.2);
      transform: translateY(-2px);
    }
    
    .file-upload-area {
      border: 3px dashed #94a3b8;
      border-radius: 15px;
      padding: 40px 20px;
      text-align: center;
      background: #f8fafc;
      transition: all 0.3s ease;
      margin-bottom: 20px;
      cursor: pointer;
    }
    
    .file-upload-area:hover {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    
    .file-upload-area.dragover {
      border-color: #1e3a8a;
      background: #dbeafe;
    }
    
    .upload-icon {
      font-size: 48px;
      color: #64748b;
      margin-bottom: 15px;
    }
    
    .upload-text {
      font-size: 18px;
      color: #475569;
      margin-bottom: 10px;
    }
    
    .upload-hint {
      font-size: 14px;
      color: #64748b;
    }
    
    #file-input {
      display: none;
    }
    
    .preview-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .preview-item {
      position: relative;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }
    
    .preview-item:hover {
      transform: translateY(-3px);
    }
    
    .preview-image {
      width: 100%;
      height: 120px;
      object-fit: cover;
    }
    
    .preview-info {
      padding: 10px;
      text-align: center;
    }
    
    .preview-filename {
      font-size: 12px;
      color: #7f8c8d;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .preview-size {
      font-size: 11px;
      color: #95a5a6;
    }
    
    .remove-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(231, 76, 60, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease;
    }
    
    .remove-btn:hover {
      background: rgba(192, 57, 43, 1);
    }
    
    /* Quick look modal styles */
    .quick-look-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      backdrop-filter: blur(5px);
    }
    
    .quick-look-content {
      max-width: 90%;
      max-height: 90%;
      position: relative;
    }
    
    .quick-look-image {
      max-width: 100%;
      max-height: 100%;
      border-radius: 10px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }
    
    .quick-look-close {
      position: absolute;
      top: -15px;
      right: -15px;
      background: rgba(231, 76, 60, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease;
    }
    
    .quick-look-close:hover {
      background: rgba(192, 57, 43, 1);
    }
    
    .preview-image {
      cursor: zoom-in;
    }
    
    .damage-center-selector {
      margin-bottom: 20px;
    }
    
    .damage-center-selector select {
      background: white;
    }
    
    .btn {
      padding: 16px 28px;
      font-size: 16px;
      font-weight: 600;
      background: linear-gradient(135deg, #6366f1, #4f46e5);
      color: white;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      margin: 10px 5px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      letter-spacing: 0.3px;
      box-shadow: 0 4px 14px rgba(99, 102, 241, 0.4);
      position: relative;
      overflow: hidden;
      font-family: inherit;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      background: linear-gradient(135deg, #4f46e5, #4338ca);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      background: rgba(148, 163, 184, 0.3);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #64748b, #475569);
      box-shadow: 0 4px 14px rgba(100, 116, 139, 0.4);
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #475569, #334155);
      box-shadow: 0 6px 20px rgba(100, 116, 139, 0.5);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      box-shadow: 0 4px 14px rgba(239, 68, 68, 0.4);
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981, #059669);
      box-shadow: 0 4px 14px rgba(16, 185, 129, 0.4);
    }

    .btn-success:hover {
      background: linear-gradient(135deg, #059669, #047857);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
    }
    
    .footer-btns { 
      display: flex; 
      justify-content: center;
      gap: 15px;
      margin-top: 30px; 
      padding-top: 20px;
      border-top: 1px solid #e1e8ed;
    }
    
    .footer { 
      font-size: 12px; 
      color: #aaa; 
      margin-top: 20px; 
      text-align: center;
    }
    
    .upload-progress {
      display: none;
      margin: 25px 0;
      padding: 20px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .progress-bar {
      width: 100%;
      height: 40px;
      background: #e0e7ff;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      border: 2px solid #6366f1;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #6366f1, #8b5cf6);
      width: 0%;
      transition: width 0.3s ease;
      box-shadow: inset 0 2px 4px rgba(255,255,255,0.3);
    }

    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #1e293b;
      font-weight: 700;
      font-size: 16px;
      text-shadow: 0 1px 2px rgba(255,255,255,0.9);
      z-index: 10;
    }
    
    .stats-container {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin: 15px 0;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15), 
                  0 2px 8px rgba(0, 0, 0, 0.1),
                  inset 0 1px 0 rgba(255, 255, 255, 0.4);
      color: #1e3a8a;
    }
    
    .stat-item {
      text-align: center;
      padding: 4px 8px;
    }
    
    .stat-number {
      font-size: 14px;
      font-weight: 500;
      display: block;
      color: #1e40af;
      margin-bottom: 2px;
      transition: all 0.3s ease;
    }

    #upload-status {
      font-size: 16px;
      font-weight: 700;
      padding: 8px 16px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
    }

    #upload-status.uploading {
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .stat-label {
      font-size: 11px;
      color: #64748b;
      font-weight: 400;
    }
    
    
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        padding: 20px;
      }
      
      .form-row {
        flex-direction: column;
      }
      
      .preview-container {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
      
      .footer-btns {
        flex-direction: column;
      }
      
      .stats-container {
        flex-direction: row;
        justify-content: space-between;
        padding: 8px 12px;
        margin: 10px 0;
      }
      
      .stat-item {
        flex: 1;
        padding: 0 4px;
      }
      
      .stat-number {
        font-size: 13px;
        margin-bottom: 1px;
      }
      
      .stat-label {
        font-size: 10px;
      }
    }
    
    .alert {
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
    }
    
    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .alert.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .alert.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .alert.show {
      display: block;
    }
    
    #more-options-btn {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      animation: pulse 2s infinite;
    }
    
    #more-options-btn:hover {
      background: linear-gradient(135deg, #d97706, #b45309);
    }
    
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(245, 158, 11, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(245, 158, 11, 0);
      }
    }
    
    .main-upload-section {
      text-align: center;
      margin-bottom: 15px;
    }
    
    .upload-main-btn {
      width: 100%;
      max-width: 300px;
      padding: 15px 30px;
      font-size: 18px;
      font-weight: 600;
    }
    
    .more-options-section {
      text-align: center;
    }
    
    .upload-options {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .upload-option-btn {
      flex: 1;
      min-width: 120px;
      max-width: 150px;
      padding: 15px 10px;
      background: linear-gradient(135deg, #3b82f6, #1e40af);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .upload-option-btn:hover {
      background: linear-gradient(135deg, #1e40af, #1e3a8a);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
    }
    
    .desktop-only {
      display: block;
    }
    
    .mobile-only {
      display: none;
    }
    
    @media (max-width: 768px) {
      .desktop-only {
        display: none;
      }
      
      .mobile-only {
        display: block;
      }
      
      .upload-options {
        flex-direction: column;
        gap: 15px;
      }
      
      .upload-option-btn {
        min-width: auto;
        max-width: none;
        padding: 18px 15px;
        font-size: 16px;
      }
    }

    /* ========================================
       GALLERY STYLES
       ======================================== */

    /* Gallery Grid */
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    /* Gallery Image Card */
    .gallery-card {
      position: relative;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      cursor: move;
    }

    .gallery-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .gallery-card.dragging {
      opacity: 0.5;
      transform: rotate(2deg);
    }

    .gallery-card.deleted {
      opacity: 0.4;
      filter: grayscale(100%);
    }

    /* Gallery Image */
    .gallery-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      display: block;
    }

    /* Gallery Card Info */
    .gallery-info {
      padding: 12px;
      background: white;
    }

    .gallery-filename {
      font-size: 12px;
      color: #1e293b;
      font-weight: 600;
      margin-bottom: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .gallery-meta {
      font-size: 10px;
      color: #64748b;
      margin-bottom: 8px;
    }

    .gallery-tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .gallery-tag {
      background: #e0e7ff;
      color: #3730a3;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
    }

    .gallery-tag.damage {
      background: #fee2e2;
      color: #991b1b;
    }

    .gallery-tag.damage-center {
      background: #fef3c7;
      color: #92400e;
    }

    .gallery-tag.category {
      background: #dbeafe;
      color: #1e40af;
    }

    /* Gallery Card Actions */
    .gallery-actions {
      display: flex;
      gap: 8px;
    }

    .gallery-btn {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .gallery-btn.delete {
      background: #fee2e2;
      color: #991b1b;
    }

    .gallery-btn.delete:hover {
      background: #fecaca;
    }

    .gallery-btn.restore {
      background: #d1fae5;
      color: #065f46;
    }

    .gallery-btn.restore:hover {
      background: #a7f3d0;
    }

    .gallery-btn.view {
      background: #dbeafe;
      color: #1e40af;
    }

    .gallery-btn.view:hover {
      background: #bfdbfe;
    }

    .gallery-btn.rename {
      background: #fef3c7;
      color: #92400e;
    }

    .gallery-btn.rename:hover {
      background: #fde68a;
    }

    /* Rename Modal Input Focus States */
    #rename-part-input:focus,
    #rename-damage-input:focus {
      outline: none;
      border-color: #6366f1 !important;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2) !important;
      background: #f8fafc !important;
    }

    #rename-part-input,
    #rename-damage-input {
      color: #000000 !important;
      font-weight: 500 !important;
    }

    #rename-part-input::placeholder,
    #rename-damage-input::placeholder {
      color: #94a3b8 !important;
      font-weight: 400 !important;
    }

    /* Order Badge */
    .order-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      z-index: 10;
    }

    /* Drag Handle */
    .drag-handle {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 6px;
      padding: 6px;
      cursor: move;
      z-index: 10;
      font-size: 16px;
    }

    /* Gallery Controls */
    .gallery-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .gallery-controls select {
      padding: 8px 12px;
      border-radius: 6px;
      border: 2px solid #6366f1;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.9);
      color: #1e293b;
      cursor: pointer;
    }

    #gallery-count {
      color: #64748b;
      font-size: 14px;
      flex: 1;
      text-align: left;
    }

    /* Empty State */
    .gallery-empty {
      text-align: center;
      padding: 60px 20px;
    }

    .gallery-empty-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .gallery-empty-title {
      color: #64748b;
      margin-bottom: 10px;
    }

    .gallery-empty-text {
      color: #94a3b8;
    }

    @media (max-width: 768px) {
      .gallery-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
      }

      .gallery-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .gallery-controls select {
        width: 100%;
      }

      #gallery-count {
        text-align: center;
      }
    }
  </style>
<link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" />
<link rel="shortcut icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" />
<link rel="apple-touch-icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" />
</head>
<body>
<div class="container">
  <div class="header">
    <img class="logo" src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp"/>
    <div class="business-name">×™×¨×•×Ÿ ×›×™×•×£ - ×©×××•×ª ×•×™×™×¢×•×¥</div>
    <div class="subtitle">×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</div>
    <h2>×”×¢×œ××ª ×ª××•× ×•×ª ×œ×ª×™×§</h2>
  </div>

  <div id="alerts-container"></div>

  <form id="upload-form" method="POST" onsubmit="return false;">
    <!-- SESSION 74: Password authentication removed - using Supabase auth only -->

    <!-- Case Information Section -->
    <div class="form-section">
      <h3>×¤×¨×˜×™ ×”×ª×™×§</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="plate">××¡×¤×¨ ×¨×™×©×•×™:</label>
          <input id="plate" name="plate" placeholder="××¡×¤×¨ ×¨×™×©×•×™ ×”×¨×›×‘" required type="text"/>
        </div>
        <div class="form-group">
          <label for="owner">×©× ×‘×¢×œ ×”×¨×›×‘:</label>
          <input id="owner" name="owner" placeholder="×©× ×‘×¢×œ ×”×¨×›×‘" type="text"/>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="damage-center">××•×§×“ × ×–×§:</label>
          <select id="damage-center" name="damage-center">
            <option value="">×›×œ ×”×ª××•× ×•×ª (×œ×œ× ×§×™×©×•×¨ ×œ××•×§×“ ×¡×¤×¦×™×¤×™)</option>
            <option value="custom">×”×–× ×” ×—×•×¤×©×™×ª - ××•×§×“ ×—×“×©</option>
          </select>
        </div>
        <div class="form-group" id="custom-damage-center" style="display: none;">
          <label for="custom-damage-name">×©× ××•×§×“ × ×–×§ ×—×“×©:</label>
          <input id="custom-damage-name" name="custom-damage-name" placeholder="×”×–×Ÿ ×©× ××•×§×“ × ×–×§" type="text"/>
        </div>
        <div class="form-group">
          <label for="image-category">×¡×•×’ ×”×ª××•× ×”:</label>
          <select id="image-category" name="image-category">
            <option value="damage">×ª××•× ×•×ª × ×–×§</option>
            <option value="general">×ª××•× ×•×ª ×›×œ×œ×™×•×ª ×©×œ ×”×¨×›×‘</option>
            <option value="parts">×ª××•× ×•×ª ×—×œ×§×™×</option>
            <option value="documents">××¡××›×™×</option>
            <option value="other">××—×¨</option>
          </select>
        </div>
      </div>
    </div>

    <!-- File Upload Section -->
    <div class="form-section">
      <h3>×”×¢×œ××ª ×ª××•× ×•×ª</h3>
      
      <!-- Upload Options -->
      <div class="upload-options">
        <button type="button" class="upload-option-btn desktop-only" onclick="selectFromFiles()">
          ğŸ“ ×”×¢×œ×” ××”××›×©×™×¨
        </button>
        <button type="button" class="upload-option-btn mobile-only" onclick="selectFromDevice()">
          ğŸ“± ×”×¢×œ×” ×ª××•× ×•×ª
        </button>
      </div>
      
      <!-- Drag and Drop Area -->
      <div class="file-upload-area desktop-only" id="drop-area">
        <div class="upload-icon">ğŸ“·</div>
        <div class="upload-text">××• ×’×¨×•×¨ ×ª××•× ×•×ª ×œ×›××Ÿ</div>
        <div class="upload-hint">×ª×•××š ×‘×§×‘×¦×™ JPG, PNG, HEIC | ×’×•×“×œ ××§×¡×™××œ×™: 10MB ×œ×§×•×‘×¥</div>
      </div>
      
      <!-- Hidden file inputs -->
      <input id="file-input-device" type="file" accept="image/*" multiple style="display: none;">
      
      <!-- Statistics -->
      <div class="stats-container" style="display: none;">
        <div class="stat-item">
          <span class="stat-number" id="files-count">0</span>
          <span class="stat-label">×ª××•× ×•×ª</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="total-size">0 MB</span>
          <span class="stat-label">×’×•×“×œ ×›×•×œ×œ</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="upload-status">××•×›×Ÿ</span>
          <span class="stat-label">×¡×˜×˜×•×¡</span>
        </div>
      </div>
      
      <!-- Preview Container -->
      <div id="preview-container" class="preview-container" style="display: none;"></div>
      
      <!-- Upload Progress -->
      <div class="upload-progress" id="upload-progress">
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
          <div class="progress-text" id="progress-text">0%</div>
        </div>
      </div>
    </div>


    <!-- Action Buttons -->
    <div class="form-section">
      <div class="main-upload-section">
        <button type="submit" class="btn btn-success upload-main-btn" id="upload-btn" disabled>
          ğŸ“¤ ×”×¢×œ×” ×ª××•× ×•×ª
        </button>
      </div>
      
      <!-- More Options Button -->
      <div class="more-options-section">
        <button type="button" class="btn btn-secondary" id="more-options-btn" onclick="toggleMoreOptions()">
          ğŸ”§ ×¢×•×“ ××¤×©×¨×•×™×•×ª
        </button>
      </div>
    </div>

    <!-- More Options (Hidden by default) -->
    <div class="form-section" id="more-options-section" style="display: none;">
      <h3 style="text-align: center; color: #1e3a8a; margin-bottom: 20px;">××¤×©×¨×•×™×•×ª ××ª×§×“××•×ª</h3>
      <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
        <button type="button" class="btn btn-secondary" onclick="processAdvancedOption('pdf')" style="flex: 1; min-width: 200px; max-width: 250px;">
          ğŸ“„ ×™×¦×™×¨×ª PDF
        </button>
      </div>
    </div>
  </form>

  <!-- Image Gallery Section -->
  <div class="form-section" id="gallery-section" style="margin-top: 30px;">
    <h2 style="text-align: center; color: #ffffff; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
      ğŸ“· ×’×œ×¨×™×™×ª ×ª××•× ×•×ª ×§×™×™××•×ª
    </h2>

    <!-- Gallery Controls -->
    <div class="gallery-controls">
      <button type="button" class="btn btn-secondary" onclick="refreshGallery()">
        ğŸ”„ ×¨×¢× ×Ÿ
      </button>
      <button type="button" class="btn btn-secondary" onclick="toggleShowDeleted()">
        <span id="show-deleted-text">ğŸ‘ï¸ ×”×¦×’ ××—×•×§×™×</span>
      </button>

      <!-- Damage Center Filter -->
      <select id="damage-center-filter" onchange="filterByDamageCenter()">
        <option value="">×›×œ ××•×§×“×™ ×”× ×–×§</option>
        <!-- Populated dynamically -->
      </select>

      <button type="button" class="btn btn-primary" onclick="saveImageOrder()">
        ğŸ’¾ ×©××•×¨ ×¡×“×¨
      </button>

      <button type="button" class="btn btn-primary" onclick="pdfGenerator.generate()" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);">
        ğŸ“„ ×ª×¦×•×’×” ××§×“×™××” PDF
      </button>

      <button type="button" class="btn btn-primary" onclick="pdfGenerator.uploadToOneDrive()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
        â˜ï¸ ×”×¢×œ×” PDF ×œ-OneDrive
      </button>

      <div style="flex: 1;">
        <span id="gallery-count">0 ×ª××•× ×•×ª</span>
      </div>
    </div>

    <!-- Gallery Grid -->
    <div id="gallery-grid" class="gallery-grid">
      <!-- Images will be dynamically inserted here -->
    </div>

    <!-- Empty State -->
    <div id="gallery-empty" class="gallery-empty" style="display: none;">
      <div class="gallery-empty-icon">ğŸ“·</div>
      <h3 class="gallery-empty-title">××™×Ÿ ×ª××•× ×•×ª ×‘×’×œ×¨×™×”</h3>
      <p class="gallery-empty-text">×”×¢×œ×” ×ª××•× ×•×ª ×›×“×™ ×œ×”×ª×—×™×œ</p>
    </div>
  </div>

  <!-- Rename Modal -->
  <div id="rename-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
    <div style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); padding: 35px; border-radius: 16px; max-width: 520px; width: 90%; direction: rtl; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 2px solid #e2e8f0;">
      <h3 style="margin-bottom: 25px; color: #1e293b; font-size: 24px; font-weight: 700; text-align: center; border-bottom: 3px solid #6366f1; padding-bottom: 15px;">âœï¸ ×¢×¨×™×›×ª ×©× ×ª××•× ×”</h3>

      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 700; color: #334155; font-size: 15px;">ğŸš— ×—×œ×§ ×¨×›×‘:</label>
        <input type="text" id="rename-part-input"
               placeholder="×œ×“×•×’××”: ×¤×’×•×© ×§×“××™, ×“×œ×ª × ×”×’"
               style="width: 100%; padding: 12px 15px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 16px; color: #000000; background: #ffffff; transition: all 0.3s ease; font-weight: 500;">
      </div>

      <div style="margin-bottom: 25px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 700; color: #334155; font-size: 15px;">âš ï¸ ×¡×•×’ × ×–×§:</label>
        <input type="text" id="rename-damage-input"
               placeholder="×œ×“×•×’××”: ×©×¨×™×˜×” ×¢××•×§×”, ×©×§×¢"
               style="width: 100%; padding: 12px 15px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 16px; color: #000000; background: #ffffff; transition: all 0.3s ease; font-weight: 500;">
      </div>

      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button onclick="galleryManager.closeRenameModal()"
                style="padding: 12px 24px; background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); border: 2px solid #cbd5e1; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px; transition: all 0.3s ease; color: #475569;"
                onmouseover="this.style.background='linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';"
                onmouseout="this.style.background='linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
          âŒ ×‘×™×˜×•×œ
        </button>
        <button onclick="galleryManager.saveRename()"
                style="padding: 12px 24px; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 15px; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);"
                onmouseover="this.style.background='linear-gradient(135deg, #4f46e5 0%, #4338ca 100%)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(99, 102, 241, 0.5)';"
                onmouseout="this.style.background='linear-gradient(135deg, #6366f1 0%, #4f46e5 100%)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(99, 102, 241, 0.4)';">
          ğŸ’¾ ×©××•×¨
        </button>
      </div>
    </div>
  </div>

  <div class="footer-btns">
    <button class="btn btn-secondary" onclick="window.location.href='selection.html'">
      ğŸ  ×—×–×•×¨ ×œ×¢××•×“ ×”×‘×™×ª
    </button>
    <button class="btn btn-danger" onclick="logout()">
      ğŸšª ×™×¦×™××” ××”××¢×¨×›×ª
    </button>
  </div>
  
  <div class="footer">@2025 Carmel Cayouf. All rights reserved. SmartVal Pro System by Evalix Â©</div>
</div>

<!-- Quick Look Modal -->
<div id="quick-look-modal" class="quick-look-modal" onclick="closeQuickLook(event)">
  <div class="quick-look-content">
    <img id="quick-look-image" class="quick-look-image" src="" alt="Quick Look">
    <button class="quick-look-close" onclick="closeQuickLook()">&times;</button>
  </div>
</div>

<!-- SortableJS Library for Drag-and-Drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<!-- PDF Generation Libraries -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script type="module">
import { sendToWebhook, getWebhook } from './webhook.js';
import { caseOwnershipService } from './services/caseOwnershipService.js';
import { fileUploadService } from './lib/fileUploadService.js';
import { supabase } from './lib/supabaseClient.js';
import { generateTransformationUrl } from './lib/cloudinaryTransformService.js';

// Expose getWebhook globally for PDF preview window
window.getWebhook = getWebhook;

// Phase 6: Case ownership check
(async () => {
  const plateNumber = window.helper?.plate || sessionStorage.getItem('currentPlate');
  
  if (plateNumber) {
    const ownershipCheck = await caseOwnershipService.canEditCase(plateNumber);
    
    if (!ownershipCheck.canEdit) {
      alert(ownershipCheck.reason || '××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¢×¨×•×š ×ª×™×§ ×–×”.\n\n×¨×§ ×”×‘×¢×œ×™×, ×× ×”×œ ××• ××¤×ª×— ×™×›×•×œ×™× ×œ×¢×¨×•×š.');
      window.location.href = 'selection.html';
      return;
    }
    
    console.log('âœ… Case ownership verified - user can upload images');
  }
})();

// SESSION 56: helper.js is NOT an ES6 module - use window.updateHelper
// import { updateHelper } from './helper.js';

// Enhanced Image Upload System
class ImageUploadManager {
  constructor() {
    this.files = [];
    this.maxFileSize = 50 * 1024 * 1024; // 50MB (updated for Phase 1A)
    this.allowedTypes = ['image/jpeg', 'image/png', 'image/heic', 'image/webp', 'image/heif'];
    this.uploadInProgress = false;
    
    this.init();
  }

  init() {
    this.setupEventListeners();
    this.loadCaseData();
    this.loadDamageCenters();
    this.setupDragAndDrop();
  }

  setupEventListeners() {
    // File input change listener
    const fileInput = document.getElementById('file-input-device');
    if (fileInput) {
      fileInput.addEventListener('change', (e) => {
        this.handleFileSelection(e.target.files);
        // Clear the input so same file can be selected again
        e.target.value = '';
      });
    }

    // Form submission
    document.getElementById('upload-form').addEventListener('submit', (e) => {
      e.preventDefault();
      this.uploadImages();
    });
  }

  loadCaseData() {
    // Load case data from session storage
    const plate = sessionStorage.getItem('plate');
    const owner = sessionStorage.getItem('owner');
    // SESSION 74: Password loading removed - using Supabase auth only
    
    if (plate) {
      document.getElementById('plate').value = plate;
    }
    if (owner) {
      document.getElementById('owner').value = owner;
    }

    // Load from helper if available
    try {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      if (helper.car_details) {
        document.getElementById('plate').value = helper.car_details.plate || '';
        document.getElementById('owner').value = helper.general_info?.owner_name || '';
      }
    } catch (e) {
      console.warn('Could not load helper data:', e);
    }
  }

  loadDamageCenters() {
    try {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      const damageCenters = helper.damage_centers || [];
      const selector = document.getElementById('damage-center');
      
      // Clear existing options except the first two (all pictures + custom input)
      while (selector.children.length > 2) {
        selector.removeChild(selector.lastChild);
      }
      
      // Check if we have damage centers data
      if (damageCenters.length > 0) {
        // Add damage centers from helper data
        damageCenters.forEach((center, index) => {
          const option = document.createElement('option');
          option.value = `existing_${index}`;
          const centerName = center.location || center.description || center.name || `××•×§×“ ${index + 1}`;
          option.textContent = `××•×§×“ ${index + 1}: ${centerName}`;
          selector.appendChild(option);
        });
      } else {
        // Add "no damage centers" option if no data available
        const noDataOption = document.createElement('option');
        noDataOption.value = 'no_data';
        noDataOption.textContent = '×œ× ×”×•×–× ×• ××•×§×“×™ × ×–×§';
        noDataOption.disabled = true;
        noDataOption.style.fontStyle = 'italic';
        noDataOption.style.color = '#64748b';
        selector.appendChild(noDataOption);
      }
      
      // Add event listener for custom input toggle
      selector.addEventListener('change', (e) => {
        const customDiv = document.getElementById('custom-damage-center');
        if (e.target.value === 'custom') {
          customDiv.style.display = 'block';
          document.getElementById('custom-damage-name').focus();
        } else {
          customDiv.style.display = 'none';
          document.getElementById('custom-damage-name').value = '';
        }
      });
      
    } catch (e) {
      console.warn('Could not load damage centers:', e);
      
      // Fallback: add "no data" option
      const selector = document.getElementById('damage-center');
      const noDataOption = document.createElement('option');
      noDataOption.value = 'no_data';
      noDataOption.textContent = '×œ× ×”×•×–× ×• ××•×§×“×™ × ×–×§';
      noDataOption.disabled = true;
      noDataOption.style.fontStyle = 'italic';
      noDataOption.style.color = '#64748b';
      selector.appendChild(noDataOption);
    }
  }

  setupDragAndDrop() {
    const uploadArea = document.getElementById('drop-area');
    if (!uploadArea) return; // Skip if not desktop
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, this.preventDefaults, false);
      document.body.addEventListener(eventName, this.preventDefaults, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
      uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
    });

    uploadArea.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const files = dt.files;
      this.handleFileSelection(files);
    }, false);
  }

  preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  handleFileSelection(files) {
    const validFiles = Array.from(files).filter(file => this.validateFile(file));
    
    if (validFiles.length !== files.length) {
      this.showAlert('×—×œ×§ ××”×§×‘×¦×™× ×œ× ×ª×§×™× ×™× ×•×œ× × ×•×¡×¤×•', 'warning');
    }

    this.files = [...this.files, ...validFiles];
    this.updateUI();
    this.renderPreviews();
  }

  validateFile(file) {
    if (!this.allowedTypes.includes(file.type)) {
      this.showAlert(`×¡×•×’ ×§×•×‘×¥ ×œ× × ×ª××š: ${file.name}`, 'error');
      return false;
    }

    if (file.size > this.maxFileSize) {
      this.showAlert(`×§×•×‘×¥ ×’×“×•×œ ××“×™: ${file.name} (××§×¡×™××•× 10MB)`, 'error');
      return false;
    }

    return true;
  }

  updateUI() {
    const fileCount = this.files.length;
    const totalSize = this.files.reduce((sum, file) => sum + file.size, 0);
    
    document.getElementById('files-count').textContent = fileCount;
    document.getElementById('total-size').textContent = this.formatFileSize(totalSize);
    document.getElementById('upload-status').textContent = fileCount > 0 ? '××•×›×Ÿ ×œ×”×¢×œ××”' : '×œ×œ× ×§×‘×¦×™×';
    
    // Show/hide elements based on file count
    const statsContainer = document.querySelector('.stats-container');
    const previewContainer = document.getElementById('preview-container');
    const uploadBtn = document.getElementById('upload-btn');
    
    if (fileCount > 0) {
      statsContainer.style.display = 'flex';
      previewContainer.style.display = 'grid';
      uploadBtn.disabled = false;
    } else {
      statsContainer.style.display = 'none';
      previewContainer.style.display = 'none';
      uploadBtn.disabled = true;
    }
    
    // More Options button is always visible - no need to hide/show
  }

  renderPreviews() {
    const container = document.getElementById('preview-container');
    container.innerHTML = '';

    if (this.files.length === 0) {
      container.style.display = 'none';
      return;
    }

    container.style.display = 'grid';

    this.files.forEach((file, index) => {
      const previewItem = document.createElement('div');
      previewItem.className = 'preview-item';

      const img = document.createElement('img');
      img.className = 'preview-image';
      
      // Create object URL for preview
      const objectUrl = URL.createObjectURL(file);
      img.src = objectUrl;
      
      // Add click event for quick look
      img.onclick = (e) => {
        e.stopPropagation();
        this.showQuickLook(objectUrl, file.name);
      };
      
      // Clean up object URL when image loads
      img.onload = () => {
        // Don't revoke immediately - keep for quick look
        img.dataset.objectUrl = objectUrl;
      };

      const info = document.createElement('div');
      info.className = 'preview-info';

      const filename = document.createElement('div');
      filename.className = 'preview-filename';
      filename.textContent = file.name;
      filename.title = file.name; // Show full name on hover

      const size = document.createElement('div');
      size.className = 'preview-size';
      size.textContent = this.formatFileSize(file.size);

      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-btn';
      removeBtn.innerHTML = 'âœ•';
      removeBtn.title = '××—×§ ×ª××•× ×”';
      removeBtn.onclick = (e) => {
        e.stopPropagation();
        this.removeFile(index);
      };

      info.appendChild(filename);
      info.appendChild(size);
      previewItem.appendChild(img);
      previewItem.appendChild(info);
      previewItem.appendChild(removeBtn);
      container.appendChild(previewItem);
    });
  }

  removeFile(index) {
    this.files.splice(index, 1);
    this.updateUI();
    this.renderPreviews();
  }

  async uploadImages() {
    if (this.uploadInProgress || this.files.length === 0) return;

    this.uploadInProgress = true;
    this.showUploadProgress(true);

    // Update status to show uploading with animation
    const statusElement = document.getElementById('upload-status');
    statusElement.textContent = '××¢×œ×” ×ª××•× ×•×ª...';
    statusElement.style.color = '#3498db';
    statusElement.classList.add('uploading');

    try {
      // Get case ID from sessionStorage
      let caseId = sessionStorage.getItem('case_id');

      // If no case_id, try to find/create from plate
      if (!caseId) {
        const plate = document.getElementById('plate').value.trim();
        if (!plate) {
          throw new Error('× ×“×¨×© ××¡×¤×¨ ×¨×™×©×•×™');
        }

        // Try to find existing case
        const { data: cases } = await supabase
          .from('cases')
          .select('id')
          .eq('plate', plate)
          .limit(1);

        if (cases && cases.length > 0) {
          caseId = cases[0].id;
          sessionStorage.setItem('case_id', caseId);
        } else {
          throw new Error('×œ× × ××¦× ×ª×™×§ ×¢×‘×•×¨ ××¡×¤×¨ ×¨×™×©×•×™ ×–×”');
        }
      }

      // Get category and damage center
      const category = document.getElementById('image-category').value;
      const damageCenterSelect = document.getElementById('damage-center').value;

      // Determine damage center ID
      let damageCenterId = null;
      if (damageCenterSelect && damageCenterSelect.startsWith('existing_')) {
        // Extract ID from helper
        const index = parseInt(damageCenterSelect.replace('existing_', ''));
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        if (helper.damage_centers && helper.damage_centers[index]) {
          damageCenterId = helper.damage_centers[index].id;
        }
      } else if (damageCenterSelect === 'custom') {
        // Create new damage center first
        const customName = document.getElementById('custom-damage-name').value.trim();
        if (customName) {
          damageCenterId = await this.createDamageCenter(caseId, customName);
        }
      }

      const uploadedImages = [];
      const totalFiles = this.files.length;

      // Upload each file
      for (let i = 0; i < this.files.length; i++) {
        const file = this.files[i];

        // Update status text to show current file
        document.getElementById('upload-status').textContent = `××¢×œ×” ${i + 1} ××ª×•×š ${totalFiles}`;

        try {
          // Update progress
          const baseProgress = (i / totalFiles) * 100;

          // Upload image (combines file upload + database record)
          const result = await fileUploadService.uploadImage(file, {
            caseId: caseId,
            category: category,
            damageCenterId: damageCenterId,
            onProgress: (percentage) => {
              // Calculate overall progress
              const fileProgress = (percentage / totalFiles);
              const totalProgress = baseProgress + fileProgress;
              this.updateProgressBar(Math.round(totalProgress));
            }
          });

          // Generate Cloudinary transformation URL (INSTANT)
          const plate = document.getElementById('plate').value.trim();

          console.log('ğŸ”§ DEBUG: About to generate transformation URL');
          console.log('ğŸ“¸ result.publicUrl:', result.publicUrl);
          console.log('ğŸš— plate:', plate);
          console.log('ğŸ†” image.id:', result.image.id);

          let transformedUrl = null;
          try {
            transformedUrl = generateTransformationUrl(result.publicUrl, {
              plate: plate
            });

            console.log('âœ… Generated transformation URL:', transformedUrl);
            console.log('ğŸ“ URL length:', transformedUrl?.length || 0);
          } catch (genError) {
            console.error('âŒ Error generating transformation URL:', genError);
            console.error('âŒ Error stack:', genError.stack);
          }

          if (!transformedUrl) {
            console.error('âš ï¸ Transformation URL is null/undefined - skipping database update');
          } else {
            // Update database with transformed URL (both columns for compatibility)
            console.log('ğŸ’¾ Updating database with transformation URL...');
            const { data: updateData, error: updateError } = await supabase
              .from('images')
              .update({
                transformed_url: transformedUrl,
                cloudinary_url: transformedUrl, // Also update legacy column
                optimization_status: 'optimized'
              })
              .eq('id', result.image.id)
              .select();

            if (updateError) {
              console.error('âŒ Error updating transformed URL:', updateError);
              console.error('âŒ Error details:', JSON.stringify(updateError, null, 2));
            } else {
              console.log('âœ… Transformation URL saved to database');
              console.log('âœ… Updated record:', updateData);
            }
          }

          uploadedImages.push({
            id: result.image.id,
            document_id: result.document.id,
            filename: file.name,
            url: result.publicUrl,
            transformed_url: transformedUrl,
            category: category,
            display_order: result.image.display_order,
            size: file.size
          });

          console.log(`âœ… Uploaded and transformed ${i + 1}/${totalFiles}: ${file.name}`);

        } catch (error) {
          console.error(`âŒ Failed to upload ${file.name}:`, error);
          this.showAlert(`×©×’×™××” ×‘×”×¢×œ××ª ${file.name}`, 'warning');
          // Continue with other files
        }
      }

      // Update progress to 100%
      this.updateProgressBar(100);

      if (uploadedImages.length > 0) {
        // Update status to completed
        const statusElement = document.getElementById('upload-status');
        statusElement.classList.remove('uploading');
        statusElement.textContent = 'âœ… ×”×•×©×œ×';
        statusElement.style.color = '#27ae60';

        // Update helper for backward compatibility
        await this.updateHelperWithSupabaseImages(uploadedImages);

        // Trigger OneDrive backup (async, non-blocking)
        this.triggerOneDriveBackup(uploadedImages);

        this.showAlert(`âœ… ${uploadedImages.length} ×ª××•× ×•×ª ×”×•×¢×œ×• ×•×¢×•×‘×“×• ×‘×”×¦×œ×—×”`, 'success');

        // Clear files
        this.files = [];
        this.updateUI();
        this.renderPreviews();
      } else {
        const statusElement = document.getElementById('upload-status');
        statusElement.classList.remove('uploading');
        statusElement.textContent = 'âŒ ×©×’×™××”';
        statusElement.style.color = '#e74c3c';
        this.showAlert('âŒ ×œ× ×”×¦×œ×—× ×• ×œ×”×¢×œ×•×ª ×ª××•× ×•×ª', 'error');
      }

    } catch (error) {
      console.error('Upload error:', error);
      const statusElement = document.getElementById('upload-status');
      statusElement.classList.remove('uploading');
      statusElement.textContent = 'âŒ ×©×’×™××”';
      statusElement.style.color = '#e74c3c';
      this.showAlert(`âŒ ×©×’×™××” ×‘×”×¢×œ××ª ×”×ª××•× ×•×ª: ${error.message}`, 'error');
    } finally {
      this.uploadInProgress = false;
      this.showUploadProgress(false);
      // Make sure animation class is removed
      document.getElementById('upload-status').classList.remove('uploading');
    }
  }

  async createDamageCenter(caseId, name) {
    try {
      const { data, error } = await supabase
        .from('damage_centers')
        .insert({
          case_id: caseId,
          name: name,
          type: 'garage'
        })
        .select()
        .single();

      if (error) throw error;

      // Also add to helper for backward compatibility
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      if (!helper.damage_centers) {
        helper.damage_centers = [];
      }
      helper.damage_centers.push({
        id: data.id,
        name: name,
        type: 'garage'
      });
      sessionStorage.setItem('helper', JSON.stringify(helper));

      return data.id;

    } catch (error) {
      console.error('Error creating damage center:', error);
      throw new Error('×œ× ×”×¦×œ×—× ×• ×œ×™×¦×•×¨ ××•×¡×š ×—×“×©');
    }
  }

  // SESSION 74: validatePassword() removed - using Supabase auth only
  validatePassword() {
    // No password validation needed - Supabase handles authentication
    return true;
  }

  async updateHelperWithSupabaseImages(images) {
    try {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');

      if (!helper.images) {
        helper.images = [];
      }

      // Convert Supabase images to helper format (minimal data to save space)
      const helperImages = images.map(img => ({
        id: img.id,
        url: img.transformed_url || img.url, // Use transformation URL if available
        filename: img.filename,
        source: 'supabase'
      }));

      // Add to helper
      helper.images.push(...helperImages);

      // Try to update session storage (may fail due to quota)
      let quotaExceeded = false;
      try {
        sessionStorage.setItem('helper', JSON.stringify(helper));
        console.log('âœ… Helper updated in sessionStorage:', helperImages.length, 'images');
      } catch (quotaError) {
        quotaExceeded = true;
        console.warn('âš ï¸ SessionStorage quota exceeded - skipping all helper updates');
        console.log('ğŸ“Œ Images are safely stored in Supabase database');
        // Don't try to call window.updateHelper - it will also fail with quota errors
        return;
      }

      // Update via helper system (only if quota not exceeded)
      if (!quotaExceeded && typeof window.updateHelper === 'function') {
        try {
          window.updateHelper('images', helper.images, 'upload-images');
          console.log('âœ… Helper system notified of image upload');
        } catch (updateError) {
          console.warn('âš ï¸ Helper system update failed - ignoring');
          // This is OK - images are in Supabase regardless
        }
      }

    } catch (error) {
      console.warn('âš ï¸ Could not update helper with images:', error.message);
      // Don't throw - helper update failure shouldn't break upload
    }
  }

  async triggerOneDriveBackup(images) {
    try {
      // Send ALL images in one webhook call (Make.com will iterate)
      await this.sendAllImagesToOneDrive(images);

      console.log(`ğŸ”„ Triggered OneDrive backup for ${images.length} images`);

    } catch (error) {
      console.error('Error triggering OneDrive backup:', error);
      // Don't throw - backup is optional
    }
  }

  async sendAllImagesToOneDrive(images) {
    try {
      const plate = document.getElementById('plate').value.trim();

      // Prepare array of all images with URLs
      const imageData = await Promise.all(images.map(async (img) => {
        // Get full image details from database
        const { data: imageRecord } = await supabase
          .from('images')
          .select('*, documents(*)')
          .eq('id', img.id)
          .single();

        if (!imageRecord) return null;

        // Generate signed URL for Make.com to download original
        const { data: urlData } = await supabase.storage
          .from(imageRecord.documents.bucket_name)
          .createSignedUrl(imageRecord.documents.storage_path, 86400); // 24 hours

        return {
          image_id: img.id,
          filename: img.filename,
          original_url: urlData?.signedUrl || imageRecord.original_url,
          transformed_url: img.transformed_url, // Already has Cloudinary URL
          category: img.category,
          case_id: sessionStorage.getItem('case_id'),
          plate: plate
        };
      }));

      // Filter out nulls
      const validImages = imageData.filter(img => img !== null);

      if (validImages.length === 0) {
        console.warn('âš ï¸ No valid images to send to Make.com');
        return;
      }

      // Send as JSON array to Make.com
      const response = await fetch(getWebhook('UPLOAD_PICTURES'), {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          images: validImages, // â† Array of all images
          batch_upload: true,
          total_count: validImages.length
        })
      });

      if (!response.ok) {
        throw new Error(`Make.com webhook failed: ${response.status}`);
      }

      console.log(`âœ… Sent ${validImages.length} images to Make.com webhook`);

    } catch (error) {
      console.error('âŒ Error sending images to OneDrive:', error);
      throw error;
    }
  }

  // OLD FUNCTION REMOVED - Now using batch upload (sendAllImagesToOneDrive)

  async processAdvancedOption(type) {
    // Check for required data - only plate number is needed
    const plate = document.getElementById('plate').value.trim();
    const owner = document.getElementById('owner').value.trim();
    
    if (!plate) {
      this.showAlert('× ×“×¨×© ××¡×¤×¨ ×¨×™×©×•×™ ×œ×‘×™×¦×•×¢ ×¤×¢×•×œ×” ××ª×§×“××ª', 'warning');
      return;
    }

    // Validate password before processing
    // SESSION 74: Password validation removed - using Supabase auth only

    try {
      const formData = new FormData();
      formData.append('plate', plate);
      formData.append('owner', owner);
      // SESSION 74: Password removed from formData - using Supabase auth only
      formData.append('process_type', type);
      formData.append('advanced_mode', 'true'); // Flag to indicate this pulls from case folder
      
      const webhookMap = {
        'transform': 'TRANSFORM_PICTURES',
        'pdf': 'CREATE_PDF'
      };

      this.showAlert(`ğŸ”„ ××ª×—×™×œ ×¢×™×‘×•×“ ${type} ××ª××•× ×•×ª ×§×™×™××•×ª...`, 'info');

      const response = await fetch(getWebhook(webhookMap[type]), {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        const result = await response.json();
        this.showAlert(`âœ… ×¢×™×‘×•×“ ${type} ××ª××•× ×•×ª ×§×™×™××•×ª ×”×•×©×œ× ×‘×”×¦×œ×—×”`, 'success');
      } else {
        throw new Error('Advanced processing failed');
      }
      
    } catch (error) {
      console.error('Advanced processing error:', error);
      this.showAlert(`âŒ ×©×’×™××” ×‘×¢×™×‘×•×“ ××ª×§×“× ${type}`, 'error');
    }
  }

  showUploadProgress(show) {
    const progressElement = document.getElementById('upload-progress');
    if (show) {
      progressElement.style.display = 'block';
      this.updateProgressBar(0);
    } else {
      progressElement.style.display = 'none';
      this.updateProgressBar(0);
    }
  }

  updateProgressBar(percentage) {
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');

    if (progressFill) {
      progressFill.style.width = `${percentage}%`;
    }

    if (progressText) {
      progressText.textContent = `${percentage}%`;
    }
  }

  showAlert(message, type = 'info') {
    const container = document.getElementById('alerts-container');
    const alert = document.createElement('div');
    alert.className = `alert ${type} show`;
    alert.textContent = message;
    
    container.appendChild(alert);
    
    setTimeout(() => {
      alert.remove();
    }, 5000);
  }

  formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  showQuickLook(imageSrc, fileName) {
    const modal = document.getElementById('quick-look-modal');
    const modalImage = document.getElementById('quick-look-image');
    
    modalImage.src = imageSrc;
    modalImage.alt = fileName;
    modal.style.display = 'flex';
    
    // Prevent body scroll when modal is open
    document.body.style.overflow = 'hidden';
  }

}

// Global functions

// Upload selection functions
window.selectFromFiles = function() {
  document.getElementById('file-input-device').click();
};

window.selectFromDevice = function() {
  document.getElementById('file-input-device').click();
};

window.toggleMoreOptions = function() {
  const moreOptionsSection = document.getElementById('more-options-section');
  const moreOptionsBtn = document.getElementById('more-options-btn');
  
  if (moreOptionsSection.style.display === 'none' || moreOptionsSection.style.display === '') {
    moreOptionsSection.style.display = 'block';
    moreOptionsBtn.textContent = 'ğŸ”§ ×”×¡×ª×¨ ××¤×©×¨×•×™×•×ª';
  } else {
    moreOptionsSection.style.display = 'none';
    moreOptionsBtn.textContent = 'ğŸ”§ ×¢×•×“ ××¤×©×¨×•×™×•×ª';
  }
};



window.processAdvancedOption = function(type) {
  window.imageUploadManager.processAdvancedOption(type);
};

window.logout = function() {
  if (typeof window.logoutWithSound === 'function') {
    window.logoutWithSound();
  } else {
    // Fallback - only clear auth-related data, preserve helper for potential saving
    sessionStorage.removeItem('auth');
    sessionStorage.removeItem('loginTime');
    sessionStorage.removeItem('lastActivityTime');
    window.location.href = 'index.html';
  }
};

window.closeQuickLook = function(event) {
  // If event is provided and target is not the modal background, don't close
  if (event && event.target.id !== 'quick-look-modal') {
    return;
  }
  
  const modal = document.getElementById('quick-look-modal');
  modal.style.display = 'none';
  
  // Restore body scroll
  document.body.style.overflow = '';
};

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  // Auth check
  const auth = sessionStorage.getItem("auth");
  if (!auth) {
    alert("×”×’×™×©×” ×—×¡×•××” - ×× × ×”×ª×—×‘×¨ ×“×¨×š ×“×£ ×”×‘×™×ª");
    window.location.href = "index.html";
    return;
  }

  // Initialize upload manager
  window.imageUploadManager = new ImageUploadManager();
  
  // ENHANCED: Auto-populate vehicle data from helper
  function populateVehicleDataFromHelper() {
    console.log('ğŸ“¸ Image Upload: Auto-populating vehicle data from helper...');
    
    try {
      const helperString = sessionStorage.getItem('helper');
      if (helperString) {
        const helper = JSON.parse(helperString);
        console.log('âœ… Helper data loaded for image upload:', helper);
        
        // Populate basic fields
        const fieldMappings = {
          'plate': helper.vehicle?.plate || helper.meta?.plate,
          'owner': helper.stakeholders?.owner?.name
        };
        
        // Apply the mappings
        Object.entries(fieldMappings).forEach(([fieldId, value]) => {
          const element = document.getElementById(fieldId);
          if (element && value) {
            element.value = value;
            console.log(`  âœ… ${fieldId}: "${value}"`);
          }
        });
        
        console.log('âœ… Image upload auto-population completed');
      } else {
        console.log('âš ï¸ No helper data found in sessionStorage');
      }
    } catch (error) {
      console.error('âŒ Error auto-populating image upload vehicle data:', error);
    }
  }
  
  // Auto-populate on page load
  populateVehicleDataFromHelper();

  // Add keyboard support for quick look modal
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const modal = document.getElementById('quick-look-modal');
      if (modal.style.display === 'flex') {
        closeQuickLook();
      }
    }
  });

  // ========================================================================
  // IMAGE GALLERY MANAGER
  // ========================================================================

  class ImageGalleryManager {
    constructor() {
      this.images = [];
      this.allImages = []; // Store unfiltered list
      this.showDeleted = false;
      this.sortableInstance = null;
      this.currentRenameImageId = null; // Track image being renamed
    }

    async loadGallery() {
      const caseId = sessionStorage.getItem('case_id');
      if (!caseId) {
        console.warn('No case_id found for gallery');
        return;
      }

      try {
        // Query ALL images for this case (we'll filter in JavaScript)
        const { data: images, error } = await supabase
          .from('images')
          .select(`
            *,
            damage_centers(
              id,
              name,
              type
            )
          `)
          .eq('case_id', caseId)
          .order('display_order', { ascending: true });

        if (error) {
          console.error('Supabase query error:', error);
          throw error;
        }

        console.log(`Loaded ${images?.length || 0} total images for case ${caseId}`);

        // Store all images
        this.allImages = images || [];

        // Filter based on showDeleted flag (filter in JavaScript, not SQL)
        if (this.showDeleted) {
          this.images = [...this.allImages];
        } else {
          this.images = this.allImages.filter(img => !img.deleted_at);
        }

        console.log(`Displaying ${this.images.length} images (showDeleted: ${this.showDeleted})`);

        this.renderGallery();
        this.initializeSortable();
        await this.loadDamageCenters();

      } catch (error) {
        console.error('Error loading gallery:', error);
        alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×’×œ×¨×™×”: ' + (error.message || 'Unknown error'));
      }
    }

    renderGallery() {
      const grid = document.getElementById('gallery-grid');
      const empty = document.getElementById('gallery-empty');
      const count = document.getElementById('gallery-count');

      if (this.images.length === 0) {
        grid.style.display = 'none';
        empty.style.display = 'block';
        count.textContent = '0 ×ª××•× ×•×ª';
        return;
      }

      grid.style.display = 'grid';
      empty.style.display = 'none';

      const activeCount = this.images.filter(img => !img.deleted_at).length;
      const deletedCount = this.images.filter(img => img.deleted_at).length;
      count.textContent = `${activeCount} ×ª××•× ×•×ª${deletedCount > 0 ? ` (${deletedCount} ××—×•×§×™×)` : ''}`;

      grid.innerHTML = this.images.map((img, index) => {
        const damageCenterName = img.damage_center?.name || img.damage_centers?.name || null;

        // Map category to Hebrew label
        const categoryLabels = {
          'damage': '×ª××•× ×•×ª × ×–×§',
          'general': '×ª××•× ×•×ª ×›×œ×œ×™×•×ª',
          'parts': '×ª××•× ×•×ª ×—×œ×§×™×',
          'documents': '××¡××›×™×',
          'other': '××—×¨'
        };
        const categoryLabel = img.category ? categoryLabels[img.category] || img.category : null;

        // Create AI-generated smart name from recognized damage and part
        let displayName = img.filename; // Default to filename

        // Check if AI data exists and is not "×—×œ×§ ×œ× ×‘×¨×•×¨" (unclear part)
        const hasValidPart = img.recognized_part && img.recognized_part !== '×—×œ×§ ×œ× ×‘×¨×•×¨';
        const hasValidDamage = img.recognized_damage && img.recognized_damage !== '×—×œ×§ ×œ× ×‘×¨×•×¨';

        if (hasValidPart && hasValidDamage) {
          displayName = `${img.recognized_part} - ${img.recognized_damage}`;
        } else if (hasValidPart) {
          displayName = img.recognized_part;
        } else if (hasValidDamage) {
          displayName = img.recognized_damage;
        }
        // Otherwise fallback to filename

        return `
        <div class="gallery-card ${img.deleted_at ? 'deleted' : ''}"
             data-id="${img.id}"
             data-order="${img.display_order}">

          <!-- Order Badge -->
          <div class="order-badge">${img.display_order || index + 1}</div>

          <!-- Drag Handle -->
          <div class="drag-handle">â ¿</div>

          <!-- Image -->
          <img src="${img.transformed_url || img.original_url}"
               alt="${img.filename}"
               class="gallery-image"
               loading="lazy"
               onerror="this.src='${img.original_url}'; this.onerror=null;">

          <!-- Info -->
          <div class="gallery-info">
            <div class="gallery-filename" title="${displayName}">
              ${displayName}
            </div>

            <div class="gallery-meta">
              ${new Date(img.created_at).toLocaleDateString('he-IL')}
            </div>

            ${img.recognized_damage || img.recognized_part || damageCenterName || categoryLabel ? `
              <div class="gallery-tags">
                ${categoryLabel ? `<span class="gallery-tag category">ğŸ“‚ ${categoryLabel}</span>` : ''}
                ${damageCenterName ? `<span class="gallery-tag damage-center">ğŸ¯ ${damageCenterName}</span>` : ''}
                ${img.recognized_damage ? `<span class="gallery-tag damage">${img.recognized_damage}</span>` : ''}
                ${img.recognized_part ? `<span class="gallery-tag">${img.recognized_part}</span>` : ''}
              </div>
            ` : ''}

            <div class="gallery-actions">
              ${img.deleted_at ? `
                <button class="gallery-btn restore" onclick="galleryManager.restoreImage('${img.id}')">
                  â™»ï¸ ×©×—×–×¨
                </button>
              ` : `
                <button class="gallery-btn view" onclick="galleryManager.viewImage('${img.id}')">
                  ğŸ‘ï¸ ×¦×¤×”
                </button>
                <button class="gallery-btn rename" onclick="galleryManager.renameImage('${img.id}', '${(img.recognized_part || '').replace(/'/g, "\\'")}', '${(img.recognized_damage || '').replace(/'/g, "\\'")}')">
                  âœï¸ ×¢×¨×•×š ×©×
                </button>
                <button class="gallery-btn delete" onclick="galleryManager.deleteImage('${img.id}')">
                  ğŸ—‘ï¸ ××—×§
                </button>
              `}
            </div>
          </div>
        </div>
      `;
      }).join('');
    }

    initializeSortable() {
      if (this.sortableInstance) {
        this.sortableInstance.destroy();
      }

      const grid = document.getElementById('gallery-grid');

      // Check if Sortable is available
      if (typeof Sortable === 'undefined') {
        console.error('Sortable library not loaded');
        return;
      }

      this.sortableInstance = Sortable.create(grid, {
        animation: 150,
        handle: '.drag-handle',
        filter: '.deleted',
        ghostClass: 'dragging',
        onEnd: (evt) => {
          this.handleReorder(evt.oldIndex, evt.newIndex);
        }
      });
    }

    handleReorder(oldIndex, newIndex) {
      if (oldIndex === newIndex) return;

      // Move item in array
      const [movedItem] = this.images.splice(oldIndex, 1);
      this.images.splice(newIndex, 0, movedItem);

      // Recalculate display_order for all images
      this.images.forEach((img, idx) => {
        img.display_order = idx + 1;
      });

      this.renderGallery();
      this.initializeSortable();

      // Show save reminder
      console.log('âœ… ×”×¡×“×¨ ×©×•× ×”. ×œ×—×¥ "×©××•×¨ ×¡×“×¨" ×›×“×™ ×œ×©××•×¨ ××ª ×”×©×™× ×•×™×™×.');
    }

    async saveImageOrder() {
      try {
        // Prepare order updates
        const orderUpdates = this.images
          .filter(img => !img.deleted_at)
          .map((img, idx) => ({
            id: img.id,
            display_order: idx + 1
          }));

        console.log('Saving order for', orderUpdates.length, 'images:', orderUpdates);

        // Update each image individually
        const updatePromises = orderUpdates.map(update =>
          supabase
            .from('images')
            .update({ display_order: update.display_order })
            .eq('id', update.id)
        );

        const results = await Promise.all(updatePromises);

        // Check for errors
        const errors = results.filter(r => r.error);
        if (errors.length > 0) {
          console.error('Some updates failed:', errors);
          throw new Error(`Failed to update ${errors.length} images`);
        }

        console.log('All images updated successfully');
        alert('âœ… ×”×¡×“×¨ × ×©××¨ ×‘×”×¦×œ×—×”!');
        await this.loadGallery(); // Reload to confirm

      } catch (error) {
        console.error('Error saving order:', error);
        alert('âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”×¡×“×¨: ' + error.message);
      }
    }

    async deleteImage(imageId) {
      const confirmed = confirm('×”×× ×œ××—×•×§ ×ª××•× ×” ×–×•? (× ×™×ª×Ÿ ×™×”×™×” ×œ×©×—×–×¨)');
      if (!confirmed) return;

      try {
        console.log('Attempting to delete image:', imageId);

        // Try direct update instead of RPC
        const { data, error } = await supabase
          .from('images')
          .update({
            deleted_at: new Date().toISOString(),
            deleted_by: (await supabase.auth.getUser()).data.user?.id
          })
          .eq('id', imageId)
          .select();

        if (error) {
          console.error('Delete error:', error);
          throw error;
        }

        if (!data || data.length === 0) {
          throw new Error('Image not found');
        }

        console.log('Image deleted successfully:', data);
        alert('âœ… ×”×ª××•× ×” × ××—×§×”');
        await this.loadGallery();

      } catch (error) {
        console.error('Error deleting image:', error);
        alert('âŒ ×©×’×™××” ×‘××—×™×§×ª ×”×ª××•× ×”: ' + error.message);
      }
    }

    async restoreImage(imageId) {
      try {
        console.log('Attempting to restore image:', imageId);

        // Try direct update instead of RPC
        const { data, error } = await supabase
          .from('images')
          .update({
            deleted_at: null,
            deleted_by: null
          })
          .eq('id', imageId)
          .select();

        if (error) {
          console.error('Restore error:', error);
          throw error;
        }

        if (!data || data.length === 0) {
          throw new Error('Image not found');
        }

        console.log('Image restored successfully:', data);
        alert('âœ… ×”×ª××•× ×” ×©×•×—×–×¨×”');
        await this.loadGallery();

      } catch (error) {
        console.error('Error restoring image:', error);
        alert('âŒ ×©×’×™××” ×‘×©×—×–×•×¨ ×”×ª××•× ×”: ' + error.message);
      }
    }

    // Rename functionality
    renameImage(imageId, currentPart, currentDamage) {
      this.currentRenameImageId = imageId;

      // Pre-fill inputs with current values
      document.getElementById('rename-part-input').value = currentPart || '';
      document.getElementById('rename-damage-input').value = currentDamage || '';

      // Show modal
      const modal = document.getElementById('rename-modal');
      modal.style.display = 'flex';

      // Focus first input
      setTimeout(() => {
        document.getElementById('rename-part-input').focus();
      }, 100);
    }

    closeRenameModal() {
      document.getElementById('rename-modal').style.display = 'none';
      this.currentRenameImageId = null;
    }

    async saveRename() {
      if (!this.currentRenameImageId) return;

      const newPart = document.getElementById('rename-part-input').value.trim();
      const newDamage = document.getElementById('rename-damage-input').value.trim();

      // Validation: at least one field must have value
      if (!newPart && !newDamage) {
        alert('âŒ × × ×œ××œ× ×œ×¤×—×•×ª ×©×“×” ××—×“ (×—×œ×§ ××• × ×–×§)');
        return;
      }

      try {
        console.log('Updating image:', this.currentRenameImageId);
        console.log('New part:', newPart || null);
        console.log('New damage:', newDamage || null);

        // Update Supabase
        const { data, error } = await supabase
          .from('images')
          .update({
            recognized_part: newPart || null,
            recognized_damage: newDamage || null
          })
          .eq('id', this.currentRenameImageId)
          .select();

        if (error) throw error;

        console.log('âœ… Image renamed successfully:', data);

        // Close modal
        this.closeRenameModal();

        // Show success
        alert('âœ… ×”×©× ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!');

        // Reload gallery to show new name
        await this.loadGallery();

      } catch (error) {
        console.error('âŒ Error renaming image:', error);
        alert('âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×©×: ' + error.message);
      }
    }

    viewImage(imageId) {
      const img = this.images.find(i => i.id === imageId);
      if (!img) return;

      // Open in new tab
      window.open(img.transformed_url || img.original_url, '_blank');
    }

    toggleShowDeleted() {
      this.showDeleted = !this.showDeleted;
      const button = document.getElementById('show-deleted-text');
      button.textContent = this.showDeleted ? 'ğŸ‘ï¸ ×”×¡×ª×¨ ××—×•×§×™×' : 'ğŸ‘ï¸ ×”×¦×’ ××—×•×§×™×';
      this.loadGallery();
    }

    async loadDamageCenters() {
      const caseId = sessionStorage.getItem('case_id');

      try {
        const { data: centers, error } = await supabase
          .from('damage_centers')
          .select('id, name')
          .eq('case_id', caseId)
          .order('name', { ascending: true });

        if (error) throw error;

        const filterSelect = document.getElementById('damage-center-filter');

        if (centers && centers.length > 0) {
          // Show filter if damage centers exist
          filterSelect.style.display = 'block';
          filterSelect.innerHTML = '<option value="">×›×œ ××•×§×“×™ ×”× ×–×§</option>';

          centers.forEach(center => {
            const option = document.createElement('option');
            option.value = center.id;
            option.textContent = center.name;
            filterSelect.appendChild(option);
          });
        } else {
          // Hide filter if no damage centers
          filterSelect.style.display = 'none';
        }

      } catch (error) {
        console.error('Error loading damage centers:', error);
        // Hide filter on error
        const filterSelect = document.getElementById('damage-center-filter');
        if (filterSelect) filterSelect.style.display = 'none';
      }
    }

    filterByDamageCenter(centerId) {
      const selectedCenterId = centerId || document.getElementById('damage-center-filter').value;

      if (!selectedCenterId) {
        // Show all
        this.images = [...this.allImages];
      } else {
        // Filter by damage center
        this.images = this.allImages.filter(img => img.damage_center_id === selectedCenterId);
      }

      this.renderGallery();
      this.initializeSortable();
    }
  }

  // ========================================================================
  // PDF THUMBNAIL GENERATOR
  // ========================================================================

  class PDFThumbnailGenerator {
    constructor() {
      this.galleryManager = null;
    }

    // Global function for child window to call
    async uploadPDFToSupabaseAndMake(pdfBlob, filename, caseId, plate) {
      const storagePath = caseId + '/thumbnails/' + filename;

      // Upload to Supabase Storage
      const { data: uploadData, error: uploadError } = await supabase.storage
        .from('docs')
        .upload(storagePath, pdfBlob, {
          contentType: 'application/pdf',
          upsert: true
        });

      if (uploadError) {
        throw new Error('×©×’×™××” ×‘×”×¢×œ××” ×œ×©×¨×ª: ' + uploadError.message);
      }

      // Get signed URL (valid for 24 hours)
      const { data: urlData, error: urlError } = await supabase.storage
        .from('docs')
        .createSignedUrl(storagePath, 86400);

      if (urlError || !urlData?.signedUrl) {
        throw new Error('×©×’×™××” ×‘×™×¦×™×¨×ª ×§×™×©×•×¨: ' + (urlError?.message || '×œ× × ×•×¦×¨ ×§×™×©×•×¨'));
      }

      // Get webhook URL
      const webhookUrl = window.getWebhook ? window.getWebhook('CREATE_PDF') : null;

      if (!webhookUrl) {
        throw new Error('CREATE_PDF webhook ×œ× ××•×’×“×¨');
      }

      // Send URL to Make.com
      const response = await fetch(webhookUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          pdf_url: urlData.signedUrl,
          filename: filename,
          case_id: caseId,
          plate: plate,
          type: 'thumbnails',
          storage_path: storagePath
        })
      });

      if (!response.ok) {
        throw new Error('Webhook × ×›×©×œ');
      }

      return true;
    }

    async generate() {
      // Get active images
      const activeImages = this.galleryManager.images.filter(img => !img.deleted_at);

      if (activeImages.length === 0) {
        alert('âŒ ××™×Ÿ ×ª××•× ×•×ª ×œ×™×™×¦×•× ×œ-PDF');
        return;
      }

      // Get case ID from session
      const caseId = sessionStorage.getItem('case_id');

      if (!caseId) {
        alert('âŒ ×œ× × ××¦× ××–×”×” ×ª×™×§');
        return;
      }

      // Show loading
      alert(`â³ ××™×™×¦×¨ ×ª×¦×•×’×” ××§×“×™××” ×©×œ PDF ×¢× ${activeImages.length} ×ª××•× ×•×ª ×××•×–×¢×¨×•×ª...\n×× × ×”××ª×Ÿ, ×–×” ×¢×©×•×™ ×œ×§×—×ª ××¡×¤×¨ ×©× ×™×•×ª.`);

      try {
        // Fetch case details and user business name
        const caseDetails = await this.getCaseDetails(caseId);

        if (!caseDetails) {
          throw new Error('×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×¤×¨×˜×™ ×ª×™×§');
        }

        // Build HTML for PDF
        const htmlContent = await this.buildPDFHTML(activeImages, caseDetails);

        // Open preview window with controls - USE UUID NOT filing_case_id
        this.openPDFPreview(htmlContent, caseDetails.plate, caseDetails.id);

      } catch (error) {
        console.error('âŒ Error generating PDF:', error);
        alert('âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª PDF: ' + error.message);
      }
    }

    async uploadToOneDrive() {
      // Get active images
      const activeImages = this.galleryManager.images.filter(img => !img.deleted_at);

      if (activeImages.length === 0) {
        alert('âŒ ××™×Ÿ ×ª××•× ×•×ª ×œ×”×¢×œ××”');
        return;
      }

      // Get case ID from session
      const caseId = sessionStorage.getItem('case_id');

      if (!caseId) {
        alert('âŒ ×œ× × ××¦× ××–×”×” ×ª×™×§');
        return;
      }

      // Show loading
      alert(`â³ ××¢×œ×” PDF ×¢× ${activeImages.length} ×ª××•× ×•×ª ×œ-OneDrive...\n×× × ×”××ª×Ÿ, ×–×” ×¢×©×•×™ ×œ×§×—×ª ××¡×¤×¨ ×©× ×™×•×ª.`);

      try {
        // Fetch case details
        const caseDetails = await this.getCaseDetails(caseId);

        if (!caseDetails) {
          throw new Error('×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×¤×¨×˜×™ ×ª×™×§');
        }

        // Build HTML for PDF
        const htmlContent = await this.buildPDFHTML(activeImages, caseDetails);

        // Generate PDF directly without opening window
        const pdfBlob = await this.generatePDFFromHTML(htmlContent);

        // Upload to Supabase and Make.com
        const filename = `${caseDetails.plate}_thumbnails_${new Date().toISOString().substring(0, 10)}.pdf`;
        await this.uploadPDFToSupabaseAndMake(pdfBlob, filename, caseDetails.id, caseDetails.plate);

        alert('âœ… PDF ×”×•×¢×œ×” ×œ-OneDrive ×‘×”×¦×œ×—×”!');

      } catch (error) {
        console.error('âŒ Error uploading to OneDrive:', error);
        alert('âŒ ×©×’×™××” ×‘×”×¢×œ××” ×œ-OneDrive: ' + error.message);
      }
    }

    async getCaseDetails(caseId) {
      try {
        // Get case details from Supabase
        const { data: caseData, error: caseError } = await supabase
          .from('cases')
          .select('filing_case_id, plate, id')
          .eq('id', caseId)
          .single();

        if (caseError) throw caseError;

        // Get user's business name from user_assets table
        const { data: { user } } = await supabase.auth.getUser();
        let businessName = '×™×¨×•×Ÿ ×›×™×•×£ - ×©×××•×ª ×•×™×™×¢×•×¥ - ×¨×™×©×™×•×Ÿ ××¡×¤×¨ 1097'; // Default fallback

        if (user) {
          const { data: userData } = await supabase
            .from('user_assets')
            .select('business_name')
            .eq('user_id', user.id)
            .single();

          if (userData && userData.business_name) {
            businessName = userData.business_name;
          }
        }

        return {
          id: caseData.id,
          filing_case_id: caseData.filing_case_id || caseData.id,
          plate: caseData.plate || '×œ× ×™×“×•×¢',
          business_name: businessName
        };

      } catch (error) {
        console.error('Error fetching case details:', error);
        return null;
      }
    }

    async buildPDFHTML(images, caseDetails) {
      // Group images by damage center
      const grouped = this.groupByDamageCenter(images);

      // Get user assets (logo, signature)
      const assets = await this.getUserAssets();

      // Build HTML
      let html = `
      <!DOCTYPE html>
      <html dir="rtl">
      <head>
        <meta charset="UTF-8">
        <style>
          body {
            font-family: Arial, sans-serif;
            direction: rtl;
            margin: 0;
            padding: 8px 20px 12px 20px;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
          }
          .header {
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 2px solid #6366f1;
            padding-bottom: 6px;
          }
          .header img {
            height: 125px;
            margin-bottom: 2px;
          }
          .header h1 {
            color: #1e293b;
            font-size: 20px;
            margin: 2px 0;
          }
          .header .subtitle {
            color: #64748b;
            font-size: 12px;
            margin: 2px 0;
          }
          .damage-center-section {
            margin: 12px 0;
            page-break-inside: avoid;
          }
          .damage-center-title {
            background: #6366f1;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 15px;
            font-weight: bold;
            margin-bottom: 10px;
          }
          .thumbnail-row {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
            page-break-inside: avoid;
          }
          .thumbnail-item {
            width: 30%;
            text-align: center;
          }
          .thumbnail-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
          }
          .thumbnail-item .name {
            margin-top: 4px;
            font-size: 12px;
            color: #1e293b;
            font-weight: 600;
          }
          .thumbnail-item .order {
            background: #1e293b;
            color: white;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 3px;
          }
          .footer {
            text-align: center;
            margin-top: auto;
            padding-top: 6px;
            border-top: 2px solid #e2e8f0;
            color: #64748b;
            font-size: 10px;
          }
          /* Hide controls when printing */
          @media print {
            #pdf-controls {
              display: none !important;
            }
            body {
              padding: 8px 15px !important;
              margin: 0 !important;
              display: block !important;
              min-height: auto !important;
            }
            .header {
              margin-bottom: 12px !important;
              padding-bottom: 8px !important;
            }
            .header img {
              height: 75px !important;
              margin-bottom: 5px !important;
            }
            .header h1 {
              font-size: 20px !important;
              margin: 3px 0 !important;
            }
            .header .subtitle {
              font-size: 12px !important;
            }
            .damage-center-section {
              margin: 14px 0 !important;
            }
            .damage-center-title {
              padding: 8px 12px !important;
              font-size: 16px !important;
              margin-bottom: 10px !important;
            }
            .thumbnail-row {
              margin-bottom: 12px !important;
            }
            .thumbnail-item img {
              height: 155px !important;
            }
            .thumbnail-item .name {
              font-size: 12px !important;
            }
            .thumbnail-item .order {
              width: 26px !important;
              height: 26px !important;
              font-size: 12px !important;
            }
            .footer {
              margin-top: 10px !important;
              padding-top: 7px !important;
              font-size: 10px !important;
            }
          }
        </style>
      </head>
      <body>
        <!-- Header -->
        <div class="header">
          ${assets.logo ? `<img src="${assets.logo}" alt="Logo">` : ''}
          <h1>×¨×™×›×•×– ×ª××•× ×•×ª ×œ×¨×›×‘ ××¡×¤×¨ ${caseDetails.plate}</h1>
          <div class="subtitle">
            ×ª×™×§ ××¡×¤×¨: ${caseDetails.filing_case_id} â€¢ ×¡×”"×› ×ª××•× ×•×ª: ${images.length} â€¢ ×ª××¨×™×š: ${new Date().toLocaleDateString('he-IL')}
          </div>
        </div>

        <!-- Content -->
      `;

      // Add grouped sections
      for (const [damageCenter, centerImages] of Object.entries(grouped)) {
        const centerNumber = centerImages[0].damage_centers?.id || '';
        const centerName = damageCenter;

        html += `
          <div class="damage-center-section">
            <div class="damage-center-title">
              ××•×§×“ × ×–×§: ${centerName} ${centerNumber ? `(#${centerNumber})` : ''}
            </div>
        `;

        // Add images in rows of 3
        for (let i = 0; i < centerImages.length; i += 3) {
          const row = centerImages.slice(i, i + 3);
          html += '<div class="thumbnail-row">';

          for (const img of row) {
            const smartName = this.getSmartName(img);
            const imageUrl = img.transformed_url || img.original_url;
            // Use display_order from database (should be 1, 2, 3...)
            const displayNumber = img.display_order != null ? img.display_order : (images.indexOf(img) + 1);

            html += `
              <div class="thumbnail-item">
                <div class="order">${displayNumber}</div>
                <img src="${imageUrl}" alt="${smartName}" crossorigin="anonymous">
                <div class="name">${smartName}</div>
              </div>
            `;
          }

          html += '</div>';
        }

        html += '</div>';
      }

      // Footer
      html += `
        <div class="footer" style="display: flex; justify-content: space-between; align-items: center; direction: rtl;">
          <div style="text-align: left; direction: ltr; color: #94a3b8; font-size: 11px;">× ×•×¦×¨ ×‘×××¦×¢×•×ª SmartVal by Evalix</div>
          <div style="text-align: right;">${caseDetails.business_name} â€¢ ${new Date().toLocaleDateString('he-IL')}</div>
        </div>
      </body>
      </html>
      `;

      return html;
    }

    groupByDamageCenter(images) {
      const grouped = {};

      for (const img of images) {
        const centerName = img.damage_centers?.name || '×›×œ×œ×™';
        if (!grouped[centerName]) {
          grouped[centerName] = [];
        }
        grouped[centerName].push(img);
      }

      return grouped;
    }

    getSmartName(img) {
      const hasValidPart = img.recognized_part && img.recognized_part !== '×—×œ×§ ×œ× ×‘×¨×•×¨';
      const hasValidDamage = img.recognized_damage && img.recognized_damage !== '×—×œ×§ ×œ× ×‘×¨×•×¨';

      if (hasValidPart && hasValidDamage) {
        return `${img.recognized_part} - ${img.recognized_damage}`;
      } else if (hasValidPart) {
        return img.recognized_part;
      } else if (hasValidDamage) {
        return img.recognized_damage;
      } else {
        return img.filename;
      }
    }

    async getUserAssets() {
      try {
        // Try to get from sessionStorage first
        const auth = JSON.parse(sessionStorage.getItem('auth') || '{}');
        if (auth.assets && auth.assets.company_logo_url) {
          return {
            logo: auth.assets.company_logo_url,
            signature: auth.assets.user_signature_url
          };
        }

        // Fallback: fetch from database
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return {};

        const { data } = await supabase
          .from('users')
          .select('company_logo_url, user_signature_url')
          .eq('id', user.id)
          .single();

        return {
          logo: data?.company_logo_url || null,
          signature: data?.user_signature_url || null
        };

      } catch (error) {
        console.warn('Could not load user assets:', error);
        return {};
      }
    }

    openPDFPreview(htmlContent, plate, caseId) {
      // Get webhook URL FIRST before opening preview
      const webhookUrl = window.getWebhook ? window.getWebhook('CREATE_PDF') : null;

      // Open preview window
      const previewWindow = window.open('', '_blank', 'width=900,height=800');

      if (!previewWindow) {
        alert('âŒ ×—×¡×•× ×—×œ×•×Ÿ ×§×•×¤×¥ - ×× × ××¤×©×¨ ×—×œ×•× ×•×ª ×§×•×¤×¦×™× ×‘×“×¤×“×¤×Ÿ');
        return;
      }

      const filename = `${plate}_thumbnails_${new Date().toISOString().substring(0, 10)}.pdf`;

      // Add control panel to HTML
      const htmlWithControls = htmlContent.replace(
        '<body>',
        `<body>
          <!-- Control Panel -->
          <div id="pdf-controls" style="position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap;">
            <button onclick="window.print()" style="padding: 10px 20px; background: white; color: #4f46e5; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
              ğŸ–¨ï¸ ×”×“×¤×¡
            </button>
            <button onclick="downloadPDFFromPreview()" style="padding: 10px 20px; background: white; color: #4f46e5; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
              ğŸ’¾ ×©××•×¨ ×œ××›×©×™×¨
            </button>
            <button onclick="window.close()" style="padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
              âŒ ×¡×’×•×¨
            </button>
          </div>
          <div style="height: 70px;"></div>
        `
      );

      // Write HTML
      previewWindow.document.write(htmlWithControls);

      // Add control functions
      previewWindow.downloadPDFFromPreview = async function() {
        try {
          // Hide controls before generating PDF
          const controls = previewWindow.document.getElementById('pdf-controls');
          controls.style.display = 'none';

          // Wait a bit for reflow
          await new Promise(resolve => setTimeout(resolve, 100));

          // Use html2canvas + jsPDF
          const canvas = await html2canvas(previewWindow.document.body, {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            logging: false,
            imageTimeout: 0
          });

          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
          });

          const imgWidth = 210;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          const pageHeight = 297;

          let heightLeft = imgHeight;
          let position = 0;

          pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;

          while (heightLeft > 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
          }

          // Download
          pdf.save(filename);

          alert('âœ… PDF × ×©××¨ ×‘×”×¦×œ×—×”!');

        } catch (error) {
          console.error('Error downloading PDF:', error);
          alert('âŒ ×©×’×™××” ×‘×©××™×¨×ª PDF: ' + error.message);
          // Show controls again on error
          const controls = previewWindow.document.getElementById('pdf-controls');
          if (controls) controls.style.display = 'flex';
        }
      };

      previewWindow.document.close();
    }

    async generatePDFFromHTML(htmlContent) {
      return new Promise(async (resolve, reject) => {
        try {
          // Create hidden iframe in current document
          const iframe = document.createElement('iframe');
          iframe.style.position = 'fixed';
          iframe.style.top = '-9999px';
          iframe.style.left = '-9999px';
          iframe.style.width = '900px';
          iframe.style.height = '1200px';
          document.body.appendChild(iframe);

          // Write HTML to iframe
          iframe.contentDocument.write(htmlContent);
          iframe.contentDocument.close();

          // Wait for images to load
          await new Promise(resolve => setTimeout(resolve, 2000));

          // Use html2canvas to capture iframe body
          const canvas = await html2canvas(iframe.contentDocument.body, {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            logging: false,
            imageTimeout: 0
          });

          // Convert to PDF using jsPDF
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
          });

          const imgWidth = 210; // A4 width in mm
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          const pageHeight = 297; // A4 height in mm

          let heightLeft = imgHeight;
          let position = 0;

          // Add first page
          pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;

          // Add additional pages if needed
          while (heightLeft > 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
          }

          // Remove iframe
          document.body.removeChild(iframe);

          // Get PDF as blob
          const pdfBlob = pdf.output('blob');
          resolve(pdfBlob);

        } catch (error) {
          reject(error);
        }
      });
    }

    downloadPDF(pdfBlob, filename) {
      const url = URL.createObjectURL(pdfBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    async sendToOneDrive(pdfBlob, filename, caseId, plate) {
      try {
        // Convert blob to base64
        const reader = new FileReader();
        reader.readAsDataURL(pdfBlob);

        await new Promise((resolve) => {
          reader.onloadend = () => resolve();
        });

        const base64 = reader.result.split(',')[1];

        // Get CREATE_PDF webhook URL
        const webhookUrl = window.getWebhook ? window.getWebhook('CREATE_PDF') : null;

        if (!webhookUrl) {
          throw new Error('CREATE_PDF webhook ×œ× ××•×’×“×¨');
        }

        // Send to Make.com
        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            pdf_base64: base64,
            filename: filename,
            case_id: caseId,
            plate: plate,
            type: 'thumbnails'
          })
        });

        if (!response.ok) {
          throw new Error('Webhook × ×›×©×œ');
        }

        alert('âœ… PDF × ×©××¨ ×‘-OneDrive ×‘×”×¦×œ×—×”!');

      } catch (error) {
        console.error('Error sending to OneDrive:', error);
        alert('âš ï¸ ×©×’×™××” ×‘×©××™×¨×” ×œ-OneDrive: ' + error.message);
      }
    }
  }

  // Initialize gallery manager
  window.galleryManager = new ImageGalleryManager();

  // Initialize PDF generator
  window.pdfGenerator = new PDFThumbnailGenerator();

  // Expose upload function globally
  window.uploadPDFToSupabaseAndMake = (pdfBlob, filename, caseId, plate) => {
    return window.pdfGenerator.uploadPDFToSupabaseAndMake(pdfBlob, filename, caseId, plate);
  };

  // Connect PDF generator to gallery manager
  setTimeout(() => {
    if (window.galleryManager) {
      window.pdfGenerator.galleryManager = window.galleryManager;
      console.log('âœ… PDF Generator connected to Gallery Manager');
    }
  }, 500);

  // Expose functions for onclick handlers
  window.refreshGallery = () => galleryManager.loadGallery();
  window.toggleShowDeleted = () => galleryManager.toggleShowDeleted();
  window.saveImageOrder = () => galleryManager.saveImageOrder();
  window.filterByDamageCenter = () => galleryManager.filterByDamageCenter();

  // Load gallery on page load
  galleryManager.loadGallery();
});

</script>
<script src="logout-sound.js"></script>
<script src="password-prefill.js"></script>

</body>
</html>
