<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>××¨×›×– × ×™×”×•×œ - ×™×¨×•×Ÿ ×›×™×•×£ [PHASE 4 UPDATED 23:52]</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <!-- PHASE 4 CACHE BUST: 2025-09-26-23:40 -->
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link href="https://fonts.googleapis.com/css2?family=Assistant&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css">
  <script type="module" src="./admin.js?v=2025092601"></script>
  <script type="module" src="./helper.js?v=2025092601"></script>
  <script type="module" src="./webhook.js?v=2025092601"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #1a1a1a;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: right;
      min-height: 80vh;
      color: #e0e0e0;
    }
    .container {
      max-width:820px;
      width: 100%;
      background: #2a2a2a;
      padding: 10px 10px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      text-align: center;
      position: relative;
      border: 1px solid #444;
    }
    header {
      background-color: #333;
      color: #ff6b35;
      padding: 20px;
      text-align: center;
      font-size: 22px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 2px solid #ff6b35;
    }
    .admin-container {
      display: grid;
      grid-template-columns: 200px 1fr;
      min-height: 80vh;
      max-width: 1800px;
      margin: 0 auto;
      width: 98%;
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
      .admin-container {
        grid-template-columns: 1fr;
        max-width: 100%;
        width: 100%;
      }
      
      nav {
        order: 2;
      }
      
      #adminContent {
        order: 1;
      }
      
      .admin-container .form-container {
        padding: 10px;
        max-width: 100vw;
        width: 100%;
        box-sizing: border-box;
        overflow-x: hidden;
        margin: 0 auto;
      }
      
      .admin-container .form-container > div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
        gap: 10px !important;
        width: 100%;
        max-width: 100%;
      }
      
      /* Ensure date fields container matches other field containers */
      .admin-container .form-container > div[style*="grid-template-columns: 1fr 1fr"] > div {
        width: 100% !important;
        max-width: 100% !important;
      }
      
      .admin-container input, .admin-container select {
        font-size: 16px !important;
        width: 100% !important;
        max-width: 100%;
        box-sizing: border-box !important;
      }
      
      .admin-container input[type="date"] {
        font-size: 16px !important;
        color: #e0e0e0 !important;
        padding: 10px !important;
        height: 44px !important;
        max-width: 100% !important;
        width: 100% !important;
        margin: 0 0 5px 0 !important;
        min-width: 0 !important;
        box-sizing: border-box !important;
      }
      
      /* Fix date input empty state visibility on mobile */
      .admin-container input[type="date"] {
        color: transparent !important;
        position: relative;
      }
      
      .admin-container input[type="date"]:focus,
      .admin-container input[type="date"]:valid {
        color: #e0e0e0 !important;
      }
      
      .admin-container input[type="date"]::-webkit-datetime-edit {
        color: #999 !important;
        opacity: 1 !important;
      }
      
      .admin-container input[type="date"]::-webkit-datetime-edit-text {
        color: #999 !important;
        padding: 0 !important;
      }
      
      .admin-container input[type="date"]::-webkit-datetime-edit-month-field,
      .admin-container input[type="date"]::-webkit-datetime-edit-day-field,
      .admin-container input[type="date"]::-webkit-datetime-edit-year-field {
        color: #999 !important;
      }
      
      .admin-container input[type="date"]::-webkit-calendar-picker-indicator {
        color: #e0e0e0 !important;
        opacity: 1 !important;
        filter: brightness(1.2) !important;
      }
      
      /* Fix button container overflow on mobile */
      .admin-container .form-container div[style*="display: flex"] {
        flex-direction: column !important;
        gap: 10px !important;
        align-items: stretch !important;
      }
      
      .admin-container .form-container button {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        padding: 12px !important;
        font-size: 14px !important;
      }
      
      /* User Management table on mobile */
      #userManagementContent table {
        font-size: 11px !important;
      }
      
      #userManagementContent th,
      #userManagementContent td {
        padding: 6px !important;
        font-size: 10px !important;
      }
      
      #userManagementContent button {
        padding: 4px 8px !important;
        font-size: 10px !important;
      }
    }
    
    .logo img {
      width: 100px;
    }
    .title { font-size: 24px; font-weight: bold; color: #ff6b35; }
    .subtitle { font-size: 18px; color: #ccc; margin-bottom: 5px; }
    .legal-note {
      color: red;
      font-weight: bold;
      margin-bottom: 15px;
    }
    h1 {
      font-size: 24px;
      color: #ff6b35;
      margin-bottom: 20px;
    }
    h2 {
      font-size: 20px;
      color: #ff6b35;
      margin-bottom: 20px;
    }
    nav {
      background: #333;
      padding: 20px;
      border-left: 3px solid #ff6b35;
      border-radius: 8px;
    }
    nav button {
      display: block;
      margin-bottom: 10px;
      width: 100%;
      padding: 10px;
      background: #444;
      color: #ff6b35;
      border: 1px solid #ff6b35;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    nav button:hover {
      background: #ff6b35;
      color: #333;
    }
    .vat-config {
      margin-top: 30px;
      text-align: center;
    }
    .vat-config label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #e0e0e0;
    }
    .vat-config input {
      width: 80%;
      padding: 8px;
      border: 1px solid #666;
      border-radius: 6px;
      margin-bottom: 8px;
      background: #444;
      color: #e0e0e0;
    }
    .vat-config button {
      padding: 8px 16px;
      background-color: #ff6b35;
      color: #333;
      border: 1px solid #ff6b35;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    main {
      padding: 30px;
      background: #2a2a2a;
      border-radius: 8px;
      color: #e0e0e0;
    }
    .notification-panel {
      position: fixed;
      bottom: 20px;
      left: 20px;
      max-width: 320px;
      background: #333;
      border: 1px solid #ff6b35;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
      padding: 10px;
      z-index: 1000;
      font-size: 14px;
      color: #e0e0e0;
    }
    .notification-panel h4 { margin: 0 0 8px 0; font-size: 16px; color: #ff6b35; }
    .notification-item {
      background: #444;
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #666;
    }
    .notification-actions button {
      margin-top: 5px;
      margin-right: 5px;
      font-size: 12px;
      padding: 4px 8px;
    }
    .devButton {
      background-color: #c0392b !important;
      color: white;
      border: 1px solid #922b21;
      font-weight: bold;
    }
    .footer {
      text-align: center;
      font-size: 12px;
      margin-top: 30px;
      color: #ccc;
      border-top: 1px solid #444;
      padding-top: 20px;
    }

    /* Spinner animation for loading logs */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo" style="margin-bottom: 1px;">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo" />
    </div>
    <div class="title">×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×¤×•×¨×˜×œ</div>
    <div class="subtitle">×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</div>
    <header>××¨×›×– × ×™×”×•×œ - ×™×¨×•×Ÿ ×›×™×•×£</header>
    <div class="admin-container">
      <nav>
        <button onclick="loadSection('caseStatus')">×¡×˜×˜×•×¡ ×ª×™×§×™×</button>
        <button onclick="loadSection('tracking')">×¡×§×™×¨×” ×œ×¤×™ ×©×“×•×ª</button>
        <button onclick="loadSection('reminders')">×¨×©×™××ª ×ª×–×›×•×¨×•×ª</button>
        <button onclick="loadSection('override')">×©×™× ×•×™ × ×ª×•× ×™×</button>
        <button onclick="loadSection('logView')">×™×•××Ÿ ×¤×¢×•×œ×•×ª</button>
        <button onclick="loadSection('versionManagement')">ğŸ“š × ×™×”×•×œ ×’×¨×¡××•×ª ×ª×™×§×™×</button>
        <button onclick="loadSection('userManagement')">ğŸ‘¥ × ×™×”×•×œ ××©×ª××©×™×</button>
        <button onclick="loadSection('clearSystem')">ğŸ—‘ï¸ ××—×§ × ×ª×•× ×™ ××¢×¨×›×ª</button>
        <button onclick="window.open('https://ycshamautcoil-my.sharepoint.com/personal/yaron_yc-shamaut_co_il/_layouts/15/onedrive.aspx?id=%2Fpersonal%2Fyaron%5Fyc%2Dshamaut%5Fco%5Fil%2FDocuments%2FYC%20×©×××•×ª%2F×ª×™×§×™×%20×¤×ª×•×—×™×&ga=1', '_blank')">×›× ×™×¡×” ×œ×ª×™×§×™× ×¤×ª×•×—×™×</button>
        <button class="devButton" onclick="window.location.href='validation-dashboard.html'">×œ×•×— ×‘×§×¨×ª ××™××•×ª</button>
        <button class="devButton" onclick="window.location.href='admin-dashboard.html'">×œ×•×— × ×™×”×•×œ ××¨×›×–×™</button>
        <button class="devButton" onclick="loadSection('deleteCase')">ğŸ—‘ï¸ ××—×§ ×ª×™×§</button>
        <div class="vat-config">
          <label for="vat-input">××¢"× ×’×œ×•×‘×œ×™ (%)</label>
          <input id="vat-input" type="number" step="0.01" placeholder="18">
          <button id="save-admin-settings">×©××•×¨ ××¢"×</button>
        </div>
        <button id="devButton" class="devButton" onclick="verifyDevAccess()">Developer Panel</button>
        <button onclick="window.location.href='selection.html'" style="margin-top: 10px; padding: 12px 24px; background: #333; color: #ff6b35; border: 2px solid #ff6b35; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.3s ease; width: 100%;" onmouseover="this.style.background='#ff6b35'; this.style.color='#333';" onmouseout="this.style.background='#333'; this.style.color='#ff6b35';">ğŸ  ×—×–×•×¨ ×œ×“×£ ×‘×—×™×¨×”</button>
      </nav>
      <main id="adminContent">
        <p>×‘×—×¨ ×¤×¢×•×œ×” ××”×ª×¤×¨×™×˜ ×”×™×× ×™ ×›×“×™ ×œ×”×ª×—×™×œ.</p>
      </main>
    </div>
    <div id="notificationPanel" class="notification-panel" style="display:none;">
      <h4>×”×•×“×¢×•×ª ××¢×¨×›×ª</h4>
      <div id="notificationList"></div>
    </div>
    <div class="footer">All rights reserved Â© Carmel Cayouf</div>
    
    <script type="module">
      import { MathEngine } from './math.js';
      import { sendToWebhook } from './webhook.js';
      import { WEBHOOKS } from './webhook.js';
      
      // Security and Audit Functions
      window.verifyAdminAccess = function() {
        const adminAccess = sessionStorage.getItem('admin-access');
        const adminTimestamp = sessionStorage.getItem('admin-timestamp');
        
        if (!adminAccess || adminAccess !== 'granted') {
          alert('âš ï¸ × ×“×¨×©×ª ×”×¨×©××ª ×× ×”×œ\n\n××™×Ÿ ×œ×š ×”×¨×©××•×ª ×× ×”×œ ××• ×©×¤×’×” ×ª×•×§×£ ×”×”×ª×—×‘×¨×•×ª.');
          window.location.href = 'selection.html';
          return false;
        }
        
        // Check if session is expired (30 minutes)
        if (adminTimestamp) {
          const sessionTime = new Date(adminTimestamp);
          const now = new Date();
          const timeDiff = (now - sessionTime) / (1000 * 60); // minutes
          
          if (timeDiff > 30) {
            alert('âš ï¸ ×¤×’ ×ª×•×§×£ ×”×”×ª×—×‘×¨×•×ª\n\n×¤×’ ×ª×•×§×£ ×”×”×ª×—×‘×¨×•×ª ×›×× ×”×œ. × ×“×¨×© ×œ×”×ª×—×‘×¨ ××—×“×©.');
            sessionStorage.removeItem('admin-access');
            sessionStorage.removeItem('admin-timestamp');
            window.location.href = 'selection.html';
            return false;
          }
        }
        
        return true;
      };
      
      window.logAdminAction = async function(action, details = {}) {
        const logEntry = {
          action: action,
          timestamp: new Date().toISOString(),
          admin_session: sessionStorage.getItem('admin-access'),
          session_timestamp: sessionStorage.getItem('admin-timestamp'),
          details: details,
          user_agent: navigator.userAgent,
          page_url: window.location.href
        };
        
        console.log('ğŸ“ Admin Action Log:', logEntry);
        
        // Store locally for immediate access
        let adminLogs = JSON.parse(localStorage.getItem('admin-action-logs') || '[]');
        adminLogs.push(logEntry);
        
        // Keep only last 100 entries
        if (adminLogs.length > 100) {
          adminLogs = adminLogs.slice(-100);
        }
        
        localStorage.setItem('admin-action-logs', JSON.stringify(adminLogs));
        
        // Send to server for permanent storage
        try {
          await fetch(WEBHOOKS.ADMIN_HUB, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'log_admin_action',
              log_entry: logEntry
            })
          });
        } catch (error) {
          console.error('Failed to send admin log to server:', error);
        }
      };
      
      document.addEventListener('DOMContentLoaded', () => {
        const saveBtn = document.getElementById('save-admin-settings');
        if (!saveBtn) {
          console.error('Save admin settings button not found');
          return;
        }
        
        saveBtn.addEventListener('click', async () => {
        const vat = parseFloat(document.getElementById('vat-input').value);
        if (isNaN(vat) || vat < 0 || vat > 100) {
          alert('×¢×¨×š ××¢"× ×œ× ×—×•×§×™');
          return;
        }
        
        const submitBtn = document.getElementById('save-admin-settings');
        const originalText = submitBtn.textContent;
        
        try {
          // Show loading state
          submitBtn.disabled = true;
          submitBtn.textContent = '×©×•××¨ ×”×’×“×¨×•×ª...';
          
          // Save VAT to all storage locations
          MathEngine.setVatRate(vat);
          sessionStorage.setItem('globalVAT', vat.toString());
          localStorage.setItem('globalVAT', vat.toString());
          
          // Update helper data if available
          if (typeof window.updateHelper === 'function') {
            window.updateHelper('fees', { vat_percent: vat });
          }
          
          // Trigger recalculations if updateCalculations is available
          if (typeof window.updateCalculations === 'function') {
            window.updateCalculations();
          }
          
          // Update any visible VAT fields in the UI
          const vatFields = document.querySelectorAll('input[id*="vat"], input[id*="VAT"], input[class*="vat"]');
          vatFields.forEach(field => {
            if (field.id !== 'vat-input' && field.type === 'number') {
              field.value = vat;
            }
          });
          
          // Dispatch custom event for other modules to listen to
          window.dispatchEvent(new CustomEvent('vatUpdated', { 
            detail: { newVatRate: vat }
          }));
          
          submitBtn.textContent = 'âœ… × ×©××¨ ×‘×”×¦×œ×—×”';
          alert(`âœ… ××¢"× ×¢×•×“×›×Ÿ ×œ-${vat}% ×‘××¢×¨×›×ª\n×›×œ ×”×—×™×©×•×‘×™× ×•×”×©×“×•×ª ×™×¢×•×“×›× ×• ××•×˜×•××˜×™×ª`);
          
        } catch (error) {
          console.error('VAT save error:', error);
          alert(`âŒ ×©×’×™××” ×‘×©××™×¨×ª ××¢"×: ${error.message}`);
          
          // Reset button state
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
        
        // Reset button after 2 seconds
        setTimeout(() => {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }, 2000);
        });
      });
    </script>
    
    <script>
    
    // ============================================================================
    // GLOBAL FUNCTIONS - DEFINED EARLY FOR IMMEDIATE AVAILABILITY
    // ============================================================================
    
    // Version history function - defined early for immediate availability
    window.loadCaseVersionHistory = function() {
      console.log('Loading case version history...');
      // This will be overridden by the full implementation later
    };
    
    // Cache-busting mechanism to force reload
    window.VALIDATION_VERSION = 'v2.0.' + Date.now();
    console.log('ğŸ”„ Validation functions version:', window.VALIDATION_VERSION);
    
    // Clear system data function - defined early for immediate availability
    window.confirmSystemClear = function() {
      if (!confirm('âš ï¸ ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™×?\n\n×¤×¢×•×œ×” ×–×• ×ª××—×§ ×œ×¦××™×ª×•×ª:\nâ€¢ ×›×œ ×¤×¨×˜×™ ×”×¨×›×‘\nâ€¢ × ×ª×•× ×™ ×”× ×–×§\nâ€¢ ××•××“× ×™×\nâ€¢ ×—×œ×§×™ ×—×™×œ×•×£\nâ€¢ ×›×œ ×”××™×“×¢ ×”×©××•×¨\n\n×œ×—×¥ OK ×œ××—×™×§×” ××• Cancel ×œ×‘×™×˜×•×œ')) {
        return;
      }
      
      const statusDiv = document.getElementById('clearSystemStatus');
      
      try {
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<div style="color: #ffc107; padding: 10px;">ğŸ”„ ××•×—×§ × ×ª×•× ×™×...</div>';
        
        // Clear all storage
        localStorage.clear();
        sessionStorage.clear();
        
        // Reset helper object if available
        if (window.helper) {
          // Reset all helper sections to empty state
          window.helper = {
            meta: {},
            vehicle: {},
            car_details: {},
            stakeholders: {},
            expertise: {
              damage_blocks: [],
              levi_report: {}
            },
            valuation: {
              adjustments: {}
            },
            parts_search: {
              results: [],
              selected_parts: [],
              unselected_parts: []
            },
            invoice: {},
            estimate: {},
            final_report: {}
          };
          
          // Save the reset helper - use both keys for compatibility
          sessionStorage.setItem('helper', JSON.stringify(window.helper));
          sessionStorage.setItem('currentHelper', JSON.stringify(window.helper)); // PHASE 4 FIX
          sessionStorage.setItem('lastHelperUpdate', new Date().toISOString());
          
          // Broadcast the reset to all modules
          if (typeof window.broadcastHelperUpdate === 'function') {
            window.broadcastHelperUpdate('all', 'data_cleared');
          }
        }
        
        // Clear any other system data
        const keysToRemove = [
        'formData', 'makeCarData', 'carData', 'carDataFromMake', 'auth',
          'lastWebhookResponse', 'helper_data', 'damage_centers_data',
          'parts_data', 'invoice_data', 'estimate_data', 'levi_data',
          'floating_screen_data', 'validation_data', 'final_report_data',
          'plate', 'caseLoaded', 'globalVAT'
        ];
        
        keysToRemove.forEach(key => {
          localStorage.removeItem(key);
          sessionStorage.removeItem(key);
        });
        
        // Show success message
        statusDiv.innerHTML = `
          <div style="color: #28a745; padding: 15px; background: #1a2e1a; border: 1px solid #28a745; border-radius: 6px;">
            <strong>âœ… ×›×œ ×”× ×ª×•× ×™× × ××—×§×• ×‘×”×¦×œ×—×”!</strong><br>
            ×”××¢×¨×›×ª ××™×¤×¡×” ×•×›×¢×ª × ×™×ª×Ÿ ×œ×”×ª×—×™×œ ×ª×™×§ ×—×“×©.<br><br>
            <small style="color: #ffc107;">â„¹ï¸ ×”×™× ×š ×¢×“×™×™×Ÿ ××—×•×‘×¨ ×œ××¢×¨×›×ª. ××™×Ÿ ×¦×•×¨×š ×œ×”×ª×—×‘×¨ ××—×“×©.</small>
          </div>
        `;
        
        console.log('ğŸ—‘ï¸ All stored data cleared successfully from admin panel');
        
      } catch (error) {
        console.error('âŒ Error clearing stored data:', error);
        statusDiv.innerHTML = `
          <div style="color: #dc3545; padding: 15px; background: #2d1a1a; border: 1px solid #dc3545; border-radius: 6px;">
            <strong>âŒ ×©×’×™××” ×‘××—×™×§×ª ×”× ×ª×•× ×™×:</strong><br>
            ${error.message}<br><br>
            <small>× ×¡×” ×©×•×‘ ××• ×¤× ×” ×œ×ª××™×›×” ×˜×›× ×™×ª.</small>
          </div>
        `;
      }
    };
    
    // Initiate case deletion with prompt
    window.initiateCaseDeletion = async function() {
      const plateNumber = document.getElementById('deleteCasePlate').value.trim();
      const statusDiv = document.getElementById('deleteCaseStatus');
      
      // Get selected deletion source
      const deleteSource = document.querySelector('input[name="deleteSource"]:checked')?.value || 'both';
      
      // Validation
      if (!plateNumber) {
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = `
          <div style="color: #dc3545; padding: 15px; background: #2d1a1a; border: 1px solid #dc3545; border-radius: 6px;">
            <strong>âŒ ×©×’×™××”:</strong> ×™×© ×œ×”×›× ×™×¡ ××¡×¤×¨ ×¨×›×‘ ×œ××—×™×§×”
          </div>
        `;
        return;
      }
      
      // Prompt for DELETE confirmation
      const deleteConfirmation = prompt('×”×§×œ×“ "DELETE" ×‘×× ×’×œ×™×ª ×›×“×™ ×œ××©×¨ ××—×™×§×”:');
      
      if (!deleteConfirmation || deleteConfirmation !== 'DELETE') {
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = `
          <div style="color: #dc3545; padding: 15px; background: #2d1a1a; border: 1px solid #dc3545; border-radius: 6px;">
            <strong>âŒ ×©×’×™××”:</strong> ×™×© ×œ×”×§×œ×™×“ "DELETE" ×‘×× ×’×œ×™×ª ×‘×“×™×•×§
          </div>
        `;
        return;
      }
      
      // Set the values for backward compatibility with performCaseDeletion
      document.getElementById('deleteAuth1').value = 'admin';
      document.getElementById('deleteAuth2').value = deleteConfirmation;
      
      // Call the actual deletion function
      await performCaseDeletion();
    };
    
    // Delete case function with double authentication - defined early for immediate availability
    window.performCaseDeletion = async function() {
      const plateNumber = document.getElementById('deleteCasePlate').value.trim();
      const auth1 = document.getElementById('deleteAuth1').value.trim() || 'admin';
      const auth2 = document.getElementById('deleteAuth2').value.trim();
      const statusDiv = document.getElementById('deleteCaseStatus');
      
      // Get selected deletion source
      const deleteSource = document.querySelector('input[name="deleteSource"]:checked')?.value || 'both';
      
      // Validation
      if (!plateNumber) {
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = `
          <div style="color: #dc3545; padding: 15px; background: #2d1a1a; border: 1px solid #dc3545; border-radius: 6px;">
            <strong>âŒ ×©×’×™××”:</strong> ×™×© ×œ×”×›× ×™×¡ ××¡×¤×¨ ×¨×›×‘ ×œ××—×™×§×”
          </div>
        `;
        return;
      }
      
      if (!auth1) {
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = `
          <div style="color: #dc3545; padding: 15px; background: #2d1a1a; border: 1px solid #dc3545; border-radius: 6px;">
            <strong>âŒ ×©×’×™××”:</strong> ×™×© ×œ×”×›× ×™×¡ ×¡×™×¡××ª ×× ×”×œ
          </div>
        `;
        return;
      }
      
      if (auth2 !== 'DELETE') {
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = `
          <div style="color: #dc3545; padding: 15px; background: #2d1a1a; border: 1px solid #dc3545; border-radius: 6px;">
            <strong>âŒ ×©×’×™××”:</strong> ×™×© ×œ×”×§×œ×™×“ "DELETE" ×‘×× ×’×œ×™×ª ×‘×“×™×•×§
          </div>
        `;
        return;
      }
      
      // Admin password validation removed - using DELETE confirmation only
      
      // Final confirmation with source info
      let confirmMessage = '';
      switch(deleteSource) {
        case 'supabase':
          confirmMessage = `âš ï¸ ×”×× ××ª×” ×‘×˜×•×— ×œ×—×œ×•×˜×™×Ÿ ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×ª×™×§ ×©×œ ×¨×›×‘ ${plateNumber} ×-Supabase (×©×¨×ª)?\\n\\n×¤×¢×•×œ×” ×–×• ×‘×œ×ª×™ ×”×¤×™×›×” ×•×ª××—×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×”×§×©×•×¨×™× ×œ×ª×™×§ ×–×” ××”×©×¨×ª!`;
          break;
        case 'onedrive':
          confirmMessage = `âš ï¸ ×”×× ××ª×” ×‘×˜×•×— ×œ×—×œ×•×˜×™×Ÿ ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×ª×™×§ ×©×œ ×¨×›×‘ ${plateNumber} ×-OneDrive?\\n\\n×¤×¢×•×œ×” ×–×• ×‘×œ×ª×™ ×”×¤×™×›×” ×•×ª××—×§ ××ª ×›×œ ×”×§×‘×¦×™× ×”×§×©×•×¨×™× ×œ×ª×™×§ ×–×”!`;
          break;
        case 'both':
          confirmMessage = `âš ï¸ ×”×× ××ª×” ×‘×˜×•×— ×œ×—×œ×•×˜×™×Ÿ ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×ª×™×§ ×©×œ ×¨×›×‘ ${plateNumber} ×’× ×-Supabase ×•×’× ×-OneDrive?\\n\\n×¤×¢×•×œ×” ×–×• ×‘×œ×ª×™ ×”×¤×™×›×” ×•×ª××—×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×•×”×§×‘×¦×™× ×”×§×©×•×¨×™× ×œ×ª×™×§ ×–×”!`;
          break;
      }
      
      if (!confirm(confirmMessage + '\\n\\n×œ×—×¥ OK ×œ××—×™×§×” ×¡×•×¤×™×ª ××• Cancel ×œ×‘×™×˜×•×œ')) {
        return;
      }
      
      // Show loading
      statusDiv.style.display = 'block';
      let loadingMessage = '';
      switch(deleteSource) {
        case 'supabase':
          loadingMessage = 'ğŸ”„ ××•×—×§ ×ª×™×§ ×-Supabase (×©×¨×ª)...';
          break;
        case 'onedrive':
          loadingMessage = 'ğŸ”„ ××•×—×§ ×ª×™×§ ×-OneDrive...';
          break;
        case 'both':
          loadingMessage = 'ğŸ”„ ××•×—×§ ×ª×™×§ ×-Supabase ×•×-OneDrive...';
          break;
      }
      statusDiv.innerHTML = `<div style="color: #ffc107; padding: 10px;">${loadingMessage}</div>`;
      
      try {
        let deleteResults = {
          supabase: null,
          onedrive: null
        };
        
        // Delete from Supabase if needed
        if (deleteSource === 'supabase' || deleteSource === 'both') {
          try {
            statusDiv.innerHTML += '<div style="color: #17a2b8; padding: 5px;">ğŸ” ××—×¤×© ×ª×™×§ ×‘-Supabase...</div>';
            
            // Import Supabase client
            const { supabase } = await import('./lib/supabaseClient.js');
            
            // First find the case
            const { data: cases, error: findError } = await supabase
              .from('cases')
              .select('id')
              .eq('plate', plateNumber);
            
            if (findError) {
              throw new Error(`×©×’×™××” ×‘×—×™×¤×•×© ×ª×™×§: ${findError.message}`);
            }
            
            if (!cases || cases.length === 0) {
              deleteResults.supabase = { success: false, message: '×ª×™×§ ×œ× × ××¦× ×‘-Supabase' };
            } else {
              const caseId = cases[0].id;
              
              // Delete related helpers first (foreign key constraint)
              const { error: helperError } = await supabase
                .from('case_helper')
                .delete()
                .eq('case_id', caseId);
              
              if (helperError) {
                throw new Error(`×©×’×™××” ×‘××—×™×§×ª × ×ª×•× ×™ helper: ${helperError.message}`);
              }
              
              // Delete the case
              const { error: caseError } = await supabase
                .from('cases')
                .delete()
                .eq('id', caseId);
              
              if (caseError) {
                throw new Error(`×©×’×™××” ×‘××—×™×§×ª ×ª×™×§: ${caseError.message}`);
              }
              
              deleteResults.supabase = { success: true };
              console.log(`ğŸ—‘ï¸ Case ${plateNumber} deleted from Supabase successfully`);
            }
          } catch (error) {
            console.error('Error deleting from Supabase:', error);
            deleteResults.supabase = { success: false, message: error.message };
          }
        }
        
        // Delete from OneDrive if needed
        if (deleteSource === 'onedrive' || deleteSource === 'both') {
          try {
            statusDiv.innerHTML += '<div style="color: #ffc107; padding: 5px;">ğŸ”„ ××•×—×§ ×-OneDrive...</div>';
            
            // Call the DELETE_CASE_IN_ONEDRIVE webhook
            const response = await window.sendToWebhook('DELETE_CASE_IN_ONEDRIVE', {
              plate: plateNumber,
              admin_password: auth1,
              confirmation: 'DELETE',
              timestamp: Date.now(),
              action: 'permanent_delete'
            });
            
            if (response && response.success) {
              deleteResults.onedrive = { success: true };
              console.log(`ğŸ—‚ï¸ Case ${plateNumber} deleted from OneDrive successfully`);
            } else {
              deleteResults.onedrive = { 
                success: false, 
                message: response?.message || '×ª×™×§ ×œ× × ××¦× ××• ×©×’×™××” ×‘××¢×¨×›×ª' 
              };
            }
          } catch (error) {
            console.error('Error deleting from OneDrive:', error);
            deleteResults.onedrive = { success: false, message: error.message };
          }
        }
        
        // Display results
        let resultMessage = '';
        let hasSuccess = false;
        let hasFailure = false;
        
        if (deleteResults.supabase) {
          if (deleteResults.supabase.success) {
            resultMessage += '<div style="color: #28a745;">âœ… × ××—×§ ×‘×”×¦×œ×—×” ×-Supabase (×©×¨×ª)</div>';
            hasSuccess = true;
          } else {
            resultMessage += `<div style="color: #dc3545;">âŒ ×©×’×™××” ×‘-Supabase: ${deleteResults.supabase.message}</div>`;
            hasFailure = true;
          }
        }
        
        if (deleteResults.onedrive) {
          if (deleteResults.onedrive.success) {
            resultMessage += '<div style="color: #28a745;">âœ… × ××—×§ ×‘×”×¦×œ×—×” ×-OneDrive</div>';
            hasSuccess = true;
          } else {
            resultMessage += `<div style="color: #dc3545;">âŒ ×©×’×™××” ×‘-OneDrive: ${deleteResults.onedrive.message}</div>`;
            hasFailure = true;
          }
        }
        
        // Final status message
        if (hasSuccess && !hasFailure) {
          statusDiv.innerHTML = `
            <div style="color: #28a745; padding: 15px; background: #1a2e1a; border: 1px solid #28a745; border-radius: 6px;">
              <strong>âœ… ×ª×™×§ × ××—×§ ×‘×”×¦×œ×—×”!</strong><br>
              ×”×ª×™×§ ×©×œ ×¨×›×‘ ${plateNumber} × ××—×§ ×œ×¦××™×ª×•×ª.<br><br>
              ${resultMessage}
              <small style="color: #ffc107;">â„¹ï¸ ×™×™×ª×›×Ÿ ×©×”××—×™×§×” ×ª×™×§×— ××¡×¤×¨ ×“×§×•×ª ×œ×”×¡×ª×™×™× ×‘××œ×•××”.</small>
            </div>
          `;
          
          // Clear form fields
          document.getElementById('deleteCasePlate').value = '';
          document.getElementById('deleteAuth1').value = '';
          document.getElementById('deleteAuth2').value = '';
          
        } else if (hasFailure && hasSuccess) {
          statusDiv.innerHTML = `
            <div style="color: #ffc107; padding: 15px; background: #2e2a1a; border: 1px solid #ffc107; border-radius: 6px;">
              <strong>âš ï¸ ××—×™×§×” ×—×œ×§×™×ª</strong><br>
              ×—×œ×§ ××”××—×™×§×” ×”×¦×œ×™×—×” ×•×—×œ×§ × ×›×©×œ×”:<br><br>
              ${resultMessage}
            </div>
          `;
        } else {
          statusDiv.innerHTML = `
            <div style="color: #dc3545; padding: 15px; background: #2d1a1a; border: 1px solid #dc3545; border-radius: 6px;">
              <strong>âŒ ×©×’×™××” ×‘××—×™×§×ª ×”×ª×™×§:</strong><br>
              ${resultMessage}
              <small>×•×“× ×©××¡×¤×¨ ×”×¨×›×‘ × ×›×•×Ÿ ×•× ×¡×” ×©×•×‘.</small>
            </div>
          `;
        }
        
      } catch (error) {
        console.error('Error deleting case from OneDrive:', error);
        statusDiv.innerHTML = `
          <div style="color: #dc3545; padding: 15px; background: #2d1a1a; border: 1px solid #dc3545; border-radius: 6px;">
            <strong>âŒ ×©×’×™××” ×‘×—×™×‘×•×¨ ×œ××¢×¨×›×ª:</strong><br>
            ${error.message}<br><br>
            <small>× ×¡×” ×©×•×‘ ××• ×¤× ×” ×œ×ª××™×›×” ×˜×›× ×™×ª.</small>
          </div>
        `;
      }
    };
    
    // Load section function - defined early for immediate availability  
    window.loadSection = function(id) {
      const content = document.getElementById('adminContent');
      
      switch(id) {
        case 'caseStatus':
          content.innerHTML = `
            <h2>ğŸ“Š ×¡×˜×˜×•×¡ ×ª×™×§×™×</h2>
            <div style="margin-bottom: 20px;">
              <input type="text" id="plateSearch" placeholder="×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘ ×œ×—×™×¤×•×©" style="padding: 8px; margin-right: 10px; width: 200px;">
              <button onclick="searchCaseStatus()" style="padding: 8px 16px; background: #ff6b35; color: white; border: none; border-radius: 4px;">×—×¤×© ×ª×™×§</button>
              <button onclick="exportCaseStatus()" 
                      onmouseover="this.style.background='#047857'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)';"
                      onmouseout="this.style.background='#059669'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)';"
                      style="padding: 8px 16px; background: #059669; color: white; border: none; border-radius: 4px; margin-right: 10px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                ğŸ“¤ ×™×™×¦×
              </button>
            </div>
            <div id="caseResults">
              <p>×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘ ×œ×¦×¤×™×™×” ×‘×¡×˜×˜×•×¡ ×”×ª×™×§</p>
            </div>`;
          break;
          
        case 'clearSystem':
          content.innerHTML = `
            <h2 style="color: #dc3545; font-size: 18px; margin-bottom: 15px; text-align: center;">ğŸ—‘ï¸ ××—×™×§×ª × ×ª×•× ×™ ××¢×¨×›×ª</h2>
            
            <div style="background: #2a2a2a; color: #e0e0e0; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #dc3545;">
              <h3 style="color: #dc3545; margin-top: 0;">âš ï¸ ××–×”×¨×” ×—××•×¨×”</h3>
              <p style="margin-bottom: 15px;">×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×”×‘××™× ××”××¢×¨×›×ª:</p>
              
              <ul style="text-align: right; margin: 15px 0; color: #f8d7da;">
                <li>×›×œ ×¤×¨×˜×™ ×”×¨×›×‘ ×•×”×‘×¢×œ×™×</li>
                <li>× ×ª×•× ×™ ×”× ×–×§ ×•×”××§×¡×¤×¨×˜×™×–×•×ª</li>
                <li>××•××“× ×™× ×•×—×™×©×•×‘×™ ×¤×™×¦×•×™</li>
                <li>×—×œ×§×™ ×—×™×œ×•×£ ×•××—×™×¨×•× ×™×</li>
                <li>×—×©×‘×•× ×™×•×ª ×•××¡××›×™×</li>
                <li>×“×•×—×•×ª ×¡×•×¤×™×™× ×•× ×ª×•× ×™ ×”×¢×¨×›×ª ×©×•×•×™</li>
                <li>×›×œ ×”××™×“×¢ ×”×©××•×¨ ×‘××¢×¨×›×ª</li>
              </ul>
              
              <div style="background: #450a0a; padding: 15px; border-radius: 6px; margin: 15px 0; border: 1px solid #dc3545;">
                <strong style="color: #dc3545;">×©×™× ×œ×‘:</strong> ×¤×¢×•×œ×” ×–×• ×‘×œ×ª×™ ×”×¤×™×›×” ×•×ª××—×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×œ×¦××™×ª×•×ª!
              </div>
              
              <div style="text-align: center; margin-top: 25px;">
                <button onclick="confirmSystemClear()" 
                        style="padding: 12px 24px; background: #dc3545; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; margin-right: 10px;"
                        onmouseover="this.style.background='#c82333'" 
                        onmouseout="this.style.background='#dc3545'">
                  ğŸ—‘ï¸ ××—×§ ××ª ×›×œ ×”× ×ª×•× ×™×
                </button>
                <button onclick="loadSection('caseStatus')" 
                        style="padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;"
                        onmouseover="this.style.background='#5a6268'" 
                        onmouseout="this.style.background='#6c757d'">
                  ×‘×™×˜×•×œ
                </button>
              </div>
            </div>
            
            <div id="clearSystemStatus" style="margin-top: 15px; text-align: center; display: none;"></div>
          `;
          break;
          
        case 'userManagement':
          content.innerHTML = `
            <h2 style="color: #ff6b35; font-size: 18px; margin-bottom: 15px; text-align: center;">ğŸ‘¥ × ×™×”×•×œ ××©×ª××©×™×</h2>
            <div id="userManagementContent" style="padding: 5px; width: 100%; box-sizing: border-box;"></div>
          `;
          loadUserManagement();
          break;
          
        case 'deleteCase':
          content.innerHTML = `
            <h2 style="color: #e74c3c; font-size: 18px; margin-bottom: 15px; text-align: center;">ğŸ—‘ï¸ ××—×™×§×ª ×ª×™×§</h2>
            
            <div style="background: #2a2a2a; color: #e0e0e0; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e74c3c;">
              <h3 style="color: #e74c3c; margin-top: 0;">âš ï¸ ××—×™×§×ª ×ª×™×§ ×§×‘×•×¢×”</h3>
              <p style="margin-bottom: 15px;">×‘×—×¨ ×××™×¤×” ×œ××—×•×§ ××ª ×”×ª×™×§:</p>
              
              <div style="margin: 20px 0; background: #333; padding: 15px; border-radius: 6px;">
                <label style="display: block; margin-bottom: 10px; cursor: pointer;">
                  <input type="radio" name="deleteSource" value="supabase" style="margin-left: 10px;">
                  ğŸ—„ï¸ ××—×§ ××”×©×¨×ª ×‘×œ×‘×“
                </label>
                <label style="display: block; margin-bottom: 10px; cursor: pointer;">
                  <input type="radio" name="deleteSource" value="onedrive" style="margin-left: 10px;">
                  ğŸ“ ××—×§ ×-OneDrive ×‘×œ×‘×“
                </label>
                <label style="display: block; margin-bottom: 10px; cursor: pointer;">
                  <input type="radio" name="deleteSource" value="both" checked style="margin-left: 10px;">
                  ğŸ—‘ï¸ ××—×§ ××©× ×™ ×”××§×•××•×ª
                </label>
              </div>
              
              <div style="background: #450a0a; padding: 15px; border-radius: 6px; margin: 15px 0; border: 1px solid #e74c3c;">
                <strong style="color: #e74c3c;">×–×”×™×¨×•×ª:</strong> ×¤×¢×•×œ×” ×–×• ×‘×œ×ª×™ ×”×¤×™×›×” ×•×ª××—×§ ××ª ×›×œ × ×ª×•× ×™ ×”×ª×™×§!
              </div>
              
              <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">××¡×¤×¨ ×¨×›×‘ ×œ××—×™×§×”:</label>
                <input type="text" id="deleteCasePlate" placeholder="×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘" 
                       style="width: 100%; padding: 10px; background: #3a3a3a; color: #e0e0e0; border: 1px solid #555; border-radius: 4px; margin-bottom: 15px;">
              </div>
              
              <div style="margin: 20px 0;">
                <p style="color: #ffc107; margin-bottom: 15px;">
                  <strong>×©×œ×‘ 1:</strong> ×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ ×”××—×™×§×”<br>
                  <strong>×©×œ×‘ 2:</strong> ×”×§×œ×“ "DELETE" ×‘×—×œ×•×Ÿ ×©×™×•×¤×™×¢
                </p>
                <input type="hidden" id="deleteAuth1" value="">
                <input type="hidden" id="deleteAuth2" value="">
              </div>
              
              <div style="text-align: center; margin-top: 25px;">
                <button onclick="initiateCaseDeletion()" 
                        style="padding: 12px 24px; background: #e74c3c; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; margin-right: 10px;"
                        onmouseover="this.style.background='#c0392b'" 
                        onmouseout="this.style.background='#e74c3c'">
                  ğŸ—‘ï¸ ×‘×¦×¢ ××—×™×§×”
                </button>
                <button onclick="loadSection('caseStatus')" 
                        style="padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;"
                        onmouseover="this.style.background='#5a6268'" 
                        onmouseout="this.style.background='#6c757d'">
                  ×‘×™×˜×•×œ
                </button>
              </div>
            </div>
            
            <div id="deleteCaseStatus" style="margin-top: 15px; text-align: center; display: none;"></div>
          `;
          break;
          
        case 'versionManagement':
          content.innerHTML = `
            <h2 style="color: #ff6b35; font-size: 18px; margin-bottom: 15px; text-align: center;">ğŸ“š × ×™×”×•×œ ×’×¨×¡××•×ª ×ª×™×§×™×</h2>
            
            <div style="background: #2a2a2a; color: #e0e0e0; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #17a2b8;">
              <h3 style="color: #17a2b8; margin-top: 0;">ğŸ” ×—×™×¤×•×© ×ª×™×§ ×œ× ×™×”×•×œ ×’×¨×¡××•×ª</h3>
              <p style="margin-bottom: 15px;">××•×“×•×œ ×–×” ××™×•×¢×“ ×œ×˜×™×¤×•×œ ×‘××¦×‘×™ ×—×™×¨×•× ×•×§×•× ×¤×œ×™×§×˜×™× ×‘×™×Ÿ ×’×¨×¡××•×ª. ×›××Ÿ ×ª×•×›×œ ×œ×¦×¤×•×ª, ×œ×©×—×–×¨ ×•×œ×”×•×¨×™×“ ×’×¨×¡××•×ª ×§×•×“××•×ª ×©×œ ×ª×™×§×™×.</p>
              
              <div style="background: #1a365d; padding: 15px; border-radius: 6px; margin: 15px 0; border: 1px solid #17a2b8;">
                <strong style="color: #17a2b8;">××˜×¨×ª ×”××•×“×•×œ:</strong> ×©×—×–×•×¨ × ×ª×•× ×™× ×‘××§×¨×” ×©×œ ×©×’×™××•×ª, ×§×•× ×¤×œ×™×§×˜×™× ××• ×¦×•×¨×š ×‘×’×¨×¡×” ×§×•×“××ª ×©×œ ×”×ª×™×§
              </div>
              
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <label style="font-weight: bold; min-width: 120px;">××¡×¤×¨ ×¨×›×‘:</label>
                <input type="text" id="versionPlateSearch" placeholder="×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘ (×œ×“×•×’××”: 12345678)" 
                       style="width: 200px; padding: 8px; background: #3a3a3a; color: #e0e0e0; border: 1px solid #555; border-radius: 4px;">
                <button onclick="loadCaseVersionHistory()" 
                        style="padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                  ğŸ” ×˜×¢×Ÿ ×’×¨×¡××•×ª ×”×ª×™×§
                </button>
              </div>
              
              <div style="font-size: 12px; color: #999; margin-top: 10px;">
                ğŸ’¡ ×˜×™×¤: ×”×ª×™×§ ×™×˜×¢×Ÿ ×¢× ×›×œ ×”×’×¨×¡××•×ª ×”×”×™×¡×˜×•×¨×™×•×ª. ×ª×•×›×œ ×œ×¨××•×ª ××ª×™ ×›×œ ×’×¨×¡×” × ×©××¨×” ×•××” ×”×©×ª× ×” ×‘×”.
              </div>
            </div>
            
            <div id="versionResults" style="display: none;">
              <div style="background: #333; padding: 15px; border-radius: 8px; border: 1px solid #555; margin-bottom: 20px;">
                <div id="caseInfoDisplay" style="margin-bottom: 15px;"></div>
                <div id="versionsList"></div>
              </div>
            </div>
            
            <div id="versionStatus" style="margin-top: 15px; text-align: center;"></div>
          `;
          break;
          
        default:
          content.innerHTML = `<p>×‘×—×¨ ×¤×¢×•×œ×” ××”×ª×¤×¨×™×˜ ×”×™×× ×™ ×›×“×™ ×œ×”×ª×—×™×œ.</p>`;
      }
    };
    
    // ========== USER MANAGEMENT FUNCTIONS ==========
    
    window.loadUserManagement = async function() {
      const container = document.getElementById('userManagementContent');
      if (!container) return;
      
      container.innerHTML = '<p style="text-align: center; color: #999;">×˜×•×¢×Ÿ ××©×ª××©×™×...</p>';
      
      try {
        // Import modules
        const { supabase } = await import('./lib/supabaseClient.js');
        const { authService } = await import('./services/authService.js');
        
        // Get current user role to filter org
        const currentProfile = authService.getCurrentProfile();
        if (!currentProfile) {
          container.innerHTML = '<p style="color: #dc3545;">×©×’×™××”: ×œ× × ××¦× ×¤×¨×•×¤×™×œ ××©×ª××©</p>';
          return;
        }
        
        // Build query - filter by org for non-developers
        let query = supabase
          .from('profiles')
          .select('*, orgs(name)')
          .order('created_at', { ascending: false });
        
        // Filter by organization for admin/assistant
        if (currentProfile.role !== 'developer') {
          query = query.eq('org_id', currentProfile.org_id);
        }
        
        const { data: users, error } = await query;
        
        if (error) {
          container.innerHTML = `<p style="color: #dc3545;">×©×’×™××” ×‘×˜×¢×™× ×ª ××©×ª××©×™×: ${error.message}</p>`;
          return;
        }
        
        if (!users || users.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #999;">×œ× × ××¦××• ××©×ª××©×™×</p>';
          return;
        }
        
        // Build users table
        const roleNames = {
          developer: '××¤×ª×—',
          admin: '××“××™×Ÿ',
          assessor: '×©×××™',
          assistant: '×¢×•×–×¨'
        };
        
        let html = `
          <div style="background: #2a2a2a; border-radius: 8px; border: 2px solid #ff6b35; padding: 15px; max-width: 100%; box-sizing: border-box;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
              <h3 style="color: #ff6b35; margin: 0; font-size: 16px;">×¨×©×™××ª ××©×ª××©×™× (${users.length})</h3>
              <button onclick="showAddUserForm()" 
                      style="padding: 8px 16px; background: #ff6b35; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px;"
                      onmouseover="this.style.background='#e55a2b'" 
                      onmouseout="this.style.background='#ff6b35'">
                â• ×”×•×¡×£ ××©×ª××©
              </button>
            </div>
            
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse; color: #e0e0e0; font-size: 13px;">
                <thead>
                  <tr style="background: #1a1a1a; border-bottom: 2px solid #ff6b35;">
                    <th style="padding: 8px; text-align: right; color: #ff6b35; font-weight: bold; white-space: nowrap; font-size: 12px;">×©×</th>
                    <th style="padding: 8px; text-align: right; color: #ff6b35; font-weight: bold; white-space: nowrap; font-size: 12px;">××™××™×™×œ</th>
                    <th style="padding: 8px; text-align: right; color: #ff6b35; font-weight: bold; white-space: nowrap; font-size: 12px;">×˜×œ×¤×•×Ÿ</th>
                    <th style="padding: 8px; text-align: right; color: #ff6b35; font-weight: bold; white-space: nowrap; font-size: 12px;">×ª×¤×§×™×“</th>
                    <th style="padding: 8px; text-align: right; color: #ff6b35; font-weight: bold; white-space: nowrap; font-size: 12px;">××¨×’×•×Ÿ</th>
                    <th style="padding: 8px; text-align: right; color: #ff6b35; font-weight: bold; white-space: nowrap; font-size: 12px;">×¡×˜×˜×•×¡</th>
                    <th style="padding: 8px; text-align: center; color: #ff6b35; font-weight: bold; white-space: nowrap; font-size: 12px;">×¤×¢×•×œ×•×ª</th>
                  </tr>
                </thead>
                <tbody>`;
        
        users.forEach(user => {
          const statusColor = user.status === 'active' ? '#28a745' : '#dc3545';
          const statusText = user.status === 'active' ? '×¤×¢×™×œ' : '××•×©×”×”';
          
          html += `
            <tr style="border-bottom: 1px solid #444;">
              <td style="padding: 8px; white-space: nowrap; font-size: 11px;">${user.name || '-'}</td>
              <td style="padding: 8px; direction: ltr; text-align: right; font-size: 10px;">${user.email || '-'}</td>
              <td style="padding: 8px; direction: ltr; text-align: right; white-space: nowrap; font-size: 11px;">${user.phone || '-'}</td>
              <td style="padding: 8px;">
                <span style="background: #444; padding: 3px 6px; border-radius: 3px; font-size: 10px; white-space: nowrap;">
                  ${roleNames[user.role] || user.role}
                </span>
              </td>
              <td style="padding: 8px; white-space: nowrap; font-size: 11px;">${user.orgs?.name || '-'}</td>
              <td style="padding: 8px; white-space: nowrap;">
                <span style="color: ${statusColor}; font-weight: bold; font-size: 11px;">${statusText}</span>
              </td>
              <td style="padding: 8px; text-align: center;">
                <button onclick="toggleUserStatus('${user.user_id}', '${user.status}')" 
                        style="padding: 4px 8px; background: ${statusColor}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px; white-space: nowrap;">
                  ${user.status === 'active' ? 'ğŸ”’ ×”×©×”×”' : 'âœ… ×”×¤×¢×œ'}
                </button>
              </td>
            </tr>`;
        });
        
        html += `
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Add User Modal -->
          <div id="userFormModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: #2a2a2a; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; border: 2px solid #ff6b35;">
              <h3 style="color: #ff6b35; margin-top: 0;">×”×•×¡×£ ××©×ª××© ×—×“×©</h3>
              
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">×©× ××œ×:</label>
                <input type="text" id="newUserName" placeholder="×©× ××œ×" 
                       style="width: 100%; padding: 10px; background: #3a3a3a; color: #e0e0e0; border: 1px solid #555; border-radius: 4px; box-sizing: border-box;">
              </div>
              
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">××™××™×™×œ:</label>
                <input type="email" id="newUserEmail" placeholder="email@example.com" 
                       style="width: 100%; padding: 10px; background: #3a3a3a; color: #e0e0e0; border: 1px solid #555; border-radius: 4px; box-sizing: border-box;">
              </div>
              
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">×˜×œ×¤×•×Ÿ:</label>
                <input type="tel" id="newUserPhone" placeholder="050-1234567" 
                       style="width: 100%; padding: 10px; background: #3a3a3a; color: #e0e0e0; border: 1px solid #555; border-radius: 4px; box-sizing: border-box;">
              </div>
              
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">×ª×¤×§×™×“:</label>
                <select id="newUserRole" 
                        style="width: 100%; padding: 10px; background: #3a3a3a; color: #e0e0e0; border: 1px solid #555; border-radius: 4px; box-sizing: border-box;">
                  <option value="assessor">×©×××™ (Assessor)</option>
                  <option value="admin">××“××™×Ÿ (Admin)</option>
                  <option value="assistant">×¢×•×–×¨ (Assistant)</option>
                  ${currentProfile.role === 'developer' ? '<option value="developer">××¤×ª×— (Developer)</option>' : ''}
                </select>
              </div>
              
              <div style="background: #1a365d; padding: 12px; border-radius: 6px; margin: 15px 0; border: 1px solid #3b82f6; font-size: 13px;">
                <strong style="color: #3b82f6;">â„¹ï¸ ×”×¢×¨×”:</strong> ×¡×™×¡××” ×–×× ×™×ª ×ª×™×©×œ×— ×œ××©×ª××© ×‘××™××™×™×œ. ×”××©×ª××© ×™×ª×‘×§×© ×œ×©× ×•×ª ××•×ª×” ×‘×›× ×™×¡×” ×”×¨××©×•× ×”.
              </div>
              
              <div id="userFormStatus" style="margin: 15px 0; text-align: center;"></div>
              
              <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button onclick="createNewUser()" 
                        style="padding: 10px 20px; background: #ff6b35; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;"
                        onmouseover="this.style.background='#e55a2b'" 
                        onmouseout="this.style.background='#ff6b35'">
                  âœ… ×¦×•×¨ ××©×ª××©
                </button>
                <button onclick="closeUserForm()" 
                        style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;"
                        onmouseover="this.style.background='#5a6268'" 
                        onmouseout="this.style.background='#6c757d'">
                  âŒ ×‘×™×˜×•×œ
                </button>
              </div>
            </div>
          </div>`;
        
        container.innerHTML = html;
        
      } catch (error) {
        console.error('Error loading users:', error);
        container.innerHTML = `<p style="color: #dc3545;">×©×’×™××”: ${error.message}</p>`;
      }
    };
    
    window.showAddUserForm = function() {
      const modal = document.getElementById('userFormModal');
      if (modal) {
        modal.style.display = 'flex';
        document.getElementById('newUserName').value = '';
        document.getElementById('newUserEmail').value = '';
        document.getElementById('newUserPhone').value = '';
        document.getElementById('newUserRole').value = 'assessor';
        document.getElementById('userFormStatus').innerHTML = '';
      }
    };
    
    window.closeUserForm = function() {
      const modal = document.getElementById('userFormModal');
      if (modal) modal.style.display = 'none';
    };
    
    window.createNewUser = async function() {
      const name = document.getElementById('newUserName').value.trim();
      const email = document.getElementById('newUserEmail').value.trim();
      const phone = document.getElementById('newUserPhone').value.trim();
      const role = document.getElementById('newUserRole').value;
      const statusDiv = document.getElementById('userFormStatus');
      
      if (!name || !email) {
        statusDiv.innerHTML = '<p style="color: #dc3545;">× × ×œ××œ× ×©× ×•××™××™×™×œ</p>';
        return;
      }
      
      statusDiv.innerHTML = '<p style="color: #17a2b8;">×™×•×¦×¨ ××©×ª××©...</p>';
      
      try {
        const { supabase } = await import('./lib/supabaseClient.js');
        const { authService } = await import('./services/authService.js');
        
        // Get current user profile for org_id
        const currentProfile = authService.getCurrentProfile();
        
        // Generate temporary password
        const tempPassword = Math.random().toString(36).slice(-8) + Math.random().toString(36).toUpperCase().slice(-4);
        
        // Create user in Supabase Auth
        const authResponse = await fetch('https://nvqrptokmwdhvpiufrad.supabase.co/auth/v1/admin/users', {
          method: 'POST',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52cXJwdG9rbXdkaHZwaXVmcmFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzU0ODUsImV4cCI6MjA3MTYxMTQ4NX0.yvFalmZE7Xpvo_j6wzRj44Pa7Bx9LQegcyLzbz3QL5s',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email,
            password: tempPassword,
            email_confirm: true
          })
        });
        
        if (!authResponse.ok) {
          const errorData = await authResponse.json();
          throw new Error(errorData.msg || '×™×¦×™×¨×ª ××©×ª××© × ×›×©×œ×”');
        }
        
        const authData = await authResponse.json();
        
        // Create profile in profiles table
        const { error: profileError } = await supabase
          .from('profiles')
          .insert({
            user_id: authData.id,
            name,
            email,
            phone,
            role,
            org_id: currentProfile.org_id,
            status: 'active',
            must_change_password: true,
            created_by: currentProfile.user_id
          });
        
        if (profileError) {
          statusDiv.innerHTML = `<p style="color: #dc3545;">×©×’×™××” ×‘×™×¦×™×¨×ª ×¤×¨×•×¤×™×œ: ${profileError.message}</p>`;
          return;
        }
        
        statusDiv.innerHTML = `
          <p style="color: #28a745;">âœ… ××©×ª××© × ×•×¦×¨ ×‘×”×¦×œ×—×”!</p>
          <p style="font-size: 12px; color: #17a2b8;">×¡×™×¡××” ×–×× ×™×ª: <strong>${tempPassword}</strong></p>
          <p style="font-size: 12px; color: #999;">×©××•×¨ ×¡×™×¡××” ×–×• ×•×©×œ×— ×œ××©×ª××©</p>
        `;
        
        setTimeout(() => {
          closeUserForm();
          loadUserManagement();
        }, 3000);
        
      } catch (error) {
        console.error('Error creating user:', error);
        statusDiv.innerHTML = `<p style="color: #dc3545;">×©×’×™××”: ${error.message}</p>`;
      }
    };
    
    window.toggleUserStatus = async function(userId, currentStatus) {
      const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
      const confirmMsg = newStatus === 'inactive' 
        ? '×”×× ×œ×”×©×”×•×ª ××©×ª××© ×–×”?' 
        : '×”×× ×œ×”×¤×¢×™×œ ××©×ª××© ×–×”?';
      
      if (!confirm(confirmMsg)) return;
      
      try {
        const { supabase } = await import('./lib/supabaseClient.js');
        
        const { error } = await supabase
          .from('profiles')
          .update({ status: newStatus })
          .eq('user_id', userId);
        
        if (error) {
          alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡: ' + error.message);
          return;
        }
        
        alert('×¡×˜×˜×•×¡ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”');
        loadUserManagement();
        
      } catch (error) {
        console.error('Error toggling user status:', error);
        alert('×©×’×™××”: ' + error.message);
      }
    };
    
    // Global dev access function - defined early to be available for onclick
    async function verifyDevAccess() {
      const password = prompt("Enter developer password:");
      if (!password) return;
      
      // Get button reference
      const submitBtn = document.getElementById('devButton');
      const originalText = submitBtn?.textContent || 'Developer Panel';
      
      try {
        // Show loading state
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = '××ª×—×‘×¨ ×œ××¢×¨×›×ª...';
        }
        
        // Use DEV_HUB webhook directly
        const DEV_HUB_URL = 'https://hook.eu2.make.com/cg8j5gu0wyum6yrbl4rz2myd0pew3znt';
        
        console.log('ğŸ” Attempting DEV_HUB webhook verification...');
        const fetchResponse = await fetch(DEV_HUB_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            password,
            action: 'dev_login',
            timestamp: new Date().toISOString(),
            user_auth: sessionStorage.getItem('auth')
          })
        });
        
        console.log('ğŸ” DEV_HUB fetch response status:', fetchResponse.status);
        
        if (!fetchResponse.ok) {
          throw new Error(`HTTP ${fetchResponse.status}: ${fetchResponse.statusText}`);
        }
        
        let response;
        try {
          response = await fetchResponse.json();
        } catch (jsonError) {
          console.log('Response is not JSON, getting text...');
          response = await fetchResponse.text();
        }
        
        console.log('ğŸ” DEV_HUB webhook response:', response);
        
        // Enhanced dev access validation with multiple patterns
        const isDevAccess = 
          // JSON response patterns
          response?.role === 'dev' || 
          response?.access === 'dev' ||
          response?.status === 'dev' ||
          response?.result === 'dev' ||
          response?.access_granted === true ||
          response?.dev === true ||
          response?.authenticated === true ||
          response?.valid === true ||
          response?.success === true ||
          response?.approved === true ||
          // String response patterns
          (typeof response === 'string' && /^(dev|success|granted|approved|valid|authenticated|true)$/i.test(response.trim())) ||
          response === 'approved' ||
          response === 'dev' ||
          response === 'granted';
        
        console.log('ğŸ” Dev access validation result:', isDevAccess);
        
        if (isDevAccess) {
          console.log('âœ… Dev access granted via webhook');
          sessionStorage.setItem('dev-access', 'granted');
          if (submitBtn) {
            submitBtn.textContent = 'âœ… ×’×™×©×” ××•×©×¨×”';
          }
          setTimeout(() => {
            window.location.href = 'dev-module.html';
          }, 500);
        } else {
          console.error('âŒ Dev access denied');
          console.error('Response details:', response);
          if (submitBtn) {
            submitBtn.textContent = 'âŒ ×’×™×©×” × ×“×—×ª×”';
            setTimeout(() => {
              submitBtn.disabled = false;
              submitBtn.textContent = originalText;
            }, 2000);
          }
          alert('âŒ Access denied: incorrect password or insufficient privileges');
        }
        
      } catch (err) {
        console.error('Dev login failed:', err);
        
        if (submitBtn) {
          submitBtn.textContent = 'âŒ ×©×’×™××ª ×—×™×‘×•×¨';
          setTimeout(() => {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }, 2000);
        }
        
        let errorMessage = '×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª ×”××™××•×ª';
        
        if (err.message.includes('Failed to fetch')) {
          errorMessage = '×©×’×™××ª ×¨×©×ª - ×‘×“×•×§ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜';
        } else if (err.message.includes('timeout')) {
          errorMessage = '×¤×’ ×–××Ÿ ×”×—×™×‘×•×¨ - × ×¡×” ×©×•×‘';
        }
        
        alert(`ğŸš« Verification failed: ${errorMessage}`);
      }
    }
    
    // Make function globally available
    window.verifyDevAccess = verifyDevAccess;
    
    // ============================================================================
    // ACTION LOG FUNCTIONS
    // ============================================================================
    
    // Mock log data for demonstration
    let mockLogData = [
      {
        id: 1,
        timestamp: new Date().toISOString(),
        type: 'user_action',
        level: 'info',
        module: 'admin',
        message: '××©×ª××© × ×›× ×¡ ×œ××¢×¨×›×ª',
        details: { userId: 'admin', ip: '127.0.0.1' },
        plate: ''
      },
      {
        id: 2,
        timestamp: new Date(Date.now() - 3600000).toISOString(),
        type: 'system_event',
        level: 'info',
        module: 'expertise',
        message: '×“×•×— ××§×¡×¤×¨×˜×™×–×” × ×•×¦×¨',
        details: { reportId: 'EXP-001' },
        plate: '1234567'
      },
      {
        id: 3,
        timestamp: new Date(Date.now() - 7200000).toISOString(),
        type: 'error',
        level: 'error',
        module: 'upload',
        message: '×›×©×œ ×‘×”×¢×œ××ª ×§×•×‘×¥',
        details: { fileName: 'image.jpg', error: 'File too large' },
        plate: '9876543'
      },
      {
        id: 4,
        timestamp: new Date(Date.now() - 10800000).toISOString(),
        type: 'audit',
        level: 'warn',
        module: 'reports',
        message: '×“×•×— × ××—×§',
        details: { reportId: 'REP-005', deletedBy: 'admin' },
        plate: '5555555'
      }
    ];
    
    let filteredLogData = [...mockLogData];
    
    // Add log entry function
    function addLogEntry(type, level, module, message, details = {}, plate = '') {
      const newEntry = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        type,
        level,
        module,
        message,
        details,
        plate
      };
      mockLogData.unshift(newEntry);
      if (mockLogData.length > 1000) mockLogData.pop();
    }
    
    // Format timestamp for display
    function formatTimestamp(isoString) {
      const date = new Date(isoString);
      return date.toLocaleString('he-IL');
    }
    
    // Get log level color
    function getLogLevelColor(level) {
      switch(level) {
        case 'info': return '#17a2b8';
        case 'warn': return '#ffc107';
        case 'error': return '#dc3545';
        case 'critical': return '#721c24';
        default: return '#6c757d';
      }
    }
    
    // Get log type icon
    function getLogTypeIcon(type) {
      switch(type) {
        case 'user_action': return 'ğŸ‘¤';
        case 'system_event': return 'âš™ï¸';
        case 'error': return 'âŒ';
        case 'audit': return 'ğŸ”';
        default: return 'ğŸ“';
      }
    }
    
    // Render log entries
    function renderLogEntries() {
      const logContent = document.getElementById('logContent');
      if (!logContent) return;
      
      if (filteredLogData.length === 0) {
        logContent.innerHTML = '<div style="text-align: center; color: #999; padding: 15px; font-size: 12px;">××™×Ÿ ×¨×©×•××•×ª ×™×•××Ÿ ×”×ª×•×××•×ª ×œ×¡×™× ×•×Ÿ</div>';
        return;
      }
      
      const logHtml = filteredLogData.map(entry => `
        <div style="border-bottom: 1px solid #444; padding: 8px 0; margin-bottom: 6px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-size: 11px; color: #999;">${formatTimestamp(entry.timestamp)}</span>
            <div style="display: flex; align-items: center; gap: 6px;">
              <span style="font-size: 12px;">${getLogTypeIcon(entry.type)}</span>
              <span style="background: ${getLogLevelColor(entry.level)}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">${entry.level}</span>
              <span style="background: #495057; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">${entry.module}</span>
              ${entry.plate ? `<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">${entry.plate}</span>` : ''}
            </div>
          </div>
          <div style="font-size: 12px; color: #e0e0e0; margin-bottom: 4px;">${entry.message}</div>
          ${Object.keys(entry.details).length > 0 ? `
            <div style="font-size: 11px; color: #aaa; background: #333; padding: 4px; border-radius: 3px; margin-top: 4px;">
              ${Object.entries(entry.details).map(([key, value]) => `<strong>${key}:</strong> ${JSON.stringify(value)}`).join(' | ')}
            </div>
          ` : ''}
        </div>
      `).join('');
      
      logContent.innerHTML = logHtml;
    }
    
    // Update log statistics
    function updateLogStatistics() {
      const logStatsContent = document.getElementById('logStatsContent');
      if (!logStatsContent) return;
      
      const stats = {
        total: filteredLogData.length,
        user_actions: filteredLogData.filter(e => e.type === 'user_action').length,
        system_events: filteredLogData.filter(e => e.type === 'system_event').length,
        errors: filteredLogData.filter(e => e.type === 'error').length,
        audits: filteredLogData.filter(e => e.type === 'audit').length,
        last_hour: filteredLogData.filter(e => new Date(e.timestamp) > new Date(Date.now() - 3600000)).length
      };
      
      logStatsContent.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; font-size: 11px;">
          <div><strong>×¡×”"×›:</strong> ${stats.total}</div>
          <div><strong>×¤×¢×•×œ×•×ª:</strong> ${stats.user_actions}</div>
          <div><strong>××™×¨×•×¢×™×:</strong> ${stats.system_events}</div>
          <div><strong>×©×’×™××•×ª:</strong> ${stats.errors}</div>
          <div><strong>×‘×™×§×•×¨×ª:</strong> ${stats.audits}</div>
          <div><strong>×©×¢×” ××—×¨×•× ×”:</strong> ${stats.last_hour}</div>
        </div>
      `;
    }
    
    // ACTION LOG FUNCTIONS - DEFINED GLOBALLY AND EARLY
    window.refreshLog = function() {
      addLogEntry('system_event', 'info', 'admin', '×™×•××Ÿ ×¨×•×¢× ×Ÿ ×¢×œ ×™×“×™ ××©×ª××©');
      filteredLogData = [...mockLogData];
      renderLogEntries();
      updateLogStatistics();
      const logContent = document.getElementById('logContent');
      if (logContent) logContent.scrollTop = 0;
      alert('âœ… ×”×™×•××Ÿ ×¨×•×¢× ×Ÿ ×‘×”×¦×œ×—×”!');
    };
    
    window.exportLogCSV = function() {
      addLogEntry('user_action', 'info', 'admin', '×™×¦×•× ×™×•××Ÿ ×œ×§×•×‘×¥ CSV');
      
      try {
        // Create CSV headers in Hebrew
        const headers = ['×ª××¨×™×š ×•×©×¢×”', '×¡×•×’ ×¤×¢×•×œ×”', '×¨××ª ×—×©×™×‘×•×ª', '××•×“×•×œ', '×ª×™××•×¨', '××¡×¤×¨ ×¨×›×‘', '×¤×¨×˜×™× × ×•×¡×¤×™×'];
        
        // Convert log data to CSV format
        const csvRows = [];
        csvRows.push(headers.join(','));
        
        filteredLogData.forEach(entry => {
          const row = [
            `"${formatTimestamp(entry.timestamp)}"`,
            `"${entry.type}"`,
            `"${entry.level}"`,
            `"${entry.module}"`,
            `"${entry.message.replace(/"/g, '""')}"`, // Escape quotes in message
            `"${entry.plate || ''}"`,
            `"${Object.entries(entry.details).map(([key, value]) => `${key}: ${value}`).join('; ').replace(/"/g, '""')}"`
          ];
          csvRows.push(row.join(','));
        });
        
        // Create CSV content with UTF-8 BOM for Hebrew support
        const csvContent = '\uFEFF' + csvRows.join('\n');
        
        // Create and download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        
        const today = new Date().toISOString().split('T')[0];
        const fileName = `action_log_${today}.csv`;
        
        link.href = url;
        link.download = fileName;
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        URL.revokeObjectURL(url);
        
        alert(`âœ… ×™×•××Ÿ ×™×•×¦× ×‘×”×¦×œ×—×” ×›×§×•×‘×¥ CSV!\n×©× ×”×§×•×‘×¥: ${fileName}\n×›××•×ª ×¨×©×•××•×ª: ${filteredLogData.length}`);
        
      } catch (error) {
        console.error('CSV Export failed:', error);
        alert(`âŒ ×©×’×™××” ×‘×™×™×¦×•× ×§×•×‘×¥ CSV: ${error.message}`);
      }
    };
    
    window.clearLogs = function() {
      if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ× ×§×•×ª ××ª ×›×œ ×”×™×•××Ÿ? ×¤×¢×•×œ×” ×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ.')) {
        const originalLength = mockLogData.length;
        mockLogData = [];
        filteredLogData = [];
        addLogEntry('audit', 'warn', 'admin', `×™×•××Ÿ × ×•×§×” - ${originalLength} ×¨×©×•××•×ª × ××—×§×•`);
        renderLogEntries();
        updateLogStatistics();
        alert('âœ… ×”×™×•××Ÿ × ×•×§×” ×‘×”×¦×œ×—×”!');
      }
    };
    
    window.applyLogFilters = function() {
      const typeFilter = document.getElementById('logTypeFilter')?.value;
      const levelFilter = document.getElementById('logLevelFilter')?.value;
      const moduleFilter = document.getElementById('logModuleFilter')?.value;
      const searchText = document.getElementById('logSearchText')?.value?.toLowerCase();
      const dateFrom = document.getElementById('logDateFrom')?.value;
      const dateTo = document.getElementById('logDateTo')?.value;
      
      filteredLogData = mockLogData.filter(entry => {
        if (typeFilter && entry.type !== typeFilter) return false;
        if (levelFilter && entry.level !== levelFilter) return false;
        if (moduleFilter && entry.module !== moduleFilter) return false;
        if (searchText && !entry.message.toLowerCase().includes(searchText)) return false;
        
        const entryDate = new Date(entry.timestamp).toISOString().split('T')[0];
        if (dateFrom && entryDate < dateFrom) return false;
        if (dateTo && entryDate > dateTo) return false;
        
        return true;
      });
      
      addLogEntry('user_action', 'info', 'admin', `×¡×™× ×•×Ÿ ×™×•××Ÿ ×”×•×¤×¢×œ - ${filteredLogData.length} ×¨×©×•××•×ª`);
      renderLogEntries();
      updateLogStatistics();
      alert(`âœ… ×¡×™× ×•×Ÿ ×”×•×¤×¢×œ - × ××¦××• ${filteredLogData.length} ×¨×©×•××•×ª`);
    };
    
    window.clearLogFilters = function() {
      const inputs = ['logTypeFilter', 'logLevelFilter', 'logModuleFilter', 'logSearchText', 'logDateFrom', 'logDateTo'];
      inputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = '';
      });
      
      filteredLogData = [...mockLogData];
      addLogEntry('user_action', 'info', 'admin', '×¡×™× ×•×Ÿ ×™×•××Ÿ × ×•×§×”');
      renderLogEntries();
      updateLogStatistics();
      alert('âœ… ×¡×™× ×•×Ÿ × ×•×§×” ×‘×”×¦×œ×—×”!');
    };
    
    // ============================================================================
    // END OF ACTION LOG FUNCTIONS
    // ============================================================================
    
    // Initialize log system when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Add some initial log entries
      addLogEntry('system_event', 'info', 'admin', '××¢×¨×›×ª ×™×•××Ÿ ×¤×¢×•×œ×•×ª ×”×•×¤×¢×œ×”');
      addLogEntry('user_action', 'info', 'admin', '××©×ª××© × ×›× ×¡ ×œ×××©×§ ×”× ×™×”×•×œ');
      
      // Initial render if log view is visible
      setTimeout(() => {
        if (document.getElementById('logContent')) {
          renderLogEntries();
          updateLogStatistics();
        }
      }, 100);
    });
    
    // Define loadSection globally so it's available immediately
    window.loadSection = function(id) {
      const content = document.getElementById('adminContent');
      
      switch(id) {
        case 'caseStatus':
          content.innerHTML = `
            <h2>ğŸ“Š ×¡×˜×˜×•×¡ ×ª×™×§×™×</h2>
            <div style="margin-bottom: 20px;">
              <input type="text" id="plateSearch" placeholder="×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘ ×œ×—×™×¤×•×©" style="padding: 8px; margin-right: 10px; width: 200px;">
              <button onclick="searchCaseStatus()" style="padding: 8px 16px; background: #ff6b35; color: white; border: none; border-radius: 4px;">×—×¤×© ×ª×™×§</button>
              <button onclick="exportCaseStatus()" 
                      onmouseover="this.style.background='#047857'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)';"
                      onmouseout="this.style.background='#059669'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)';"
                      style="padding: 8px 16px; background: #059669; color: white; border: none; border-radius: 4px; margin-right: 10px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                ğŸ“¤ ×™×™×¦×
              </button>
            </div>
            <div id="caseResults">
              <p>×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘ ×œ×¦×¤×™×™×” ×‘×¡×˜×˜×•×¡ ×”×ª×™×§</p>
            </div>`;
          break;
          
        case 'tracking':
          content.innerHTML = `
            <h2 style="color: #ff6b35; margin-bottom: 15px;">ğŸ“‹ ×¡×§×™×¨×” ×œ×¤×™ ×©×“×•×ª</h2>
            
            <!-- Single Filter Form -->
            <div class="form-container" style="background: #333; padding: 20px; border-radius: 8px; border: 1px solid #555; margin-bottom: 20px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                
                <!-- Date Range -->
                <div>
                  <label style="color: #ff6b35; font-size: 13px; margin-bottom: 5px; display: block;">×˜×•×•×— ×ª××¨×™×›×™×</label>
                  <input type="date" id="dateFrom" style="width: 100%; padding: 10px; margin-bottom: 5px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px; height: 40px;">
                  <input type="date" id="dateTo" style="width: 100%; padding: 10px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px; height: 40px;">
                </div>


                <!-- Manufacturer -->
                <div>
                  <label style="color: #ff6b35; font-size: 13px; margin-bottom: 5px; display: block;">×™×¦×¨×Ÿ</label>
                  <input type="text" id="manufacturerFilter" placeholder="×”×›× ×¡ ×©× ×™×¦×¨×Ÿ" style="width: 100%; padding: 10px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px; height: 40px;">
                </div>

                <!-- Owner -->
                <div>
                  <label style="color: #ff6b35; font-size: 13px; margin-bottom: 5px; display: block;">×‘×¢×œ ×”×¨×›×‘</label>
                  <input type="text" id="ownerFilter" placeholder="×”×›× ×¡ ×©× ×‘×¢×œ ×”×¨×›×‘" style="width: 100%; padding: 10px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px; height: 40px;">
                </div>

                <!-- Garage -->
                <div>
                  <label style="color: #ff6b35; font-size: 13px; margin-bottom: 5px; display: block;">××•×¡×š</label>
                  <input type="text" id="garageFilter" placeholder="×”×›× ×¡ ×©× ××•×¡×š" style="width: 100%; padding: 10px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px; height: 40px;">
                </div>
               
                <!-- Directive  -->
                <div>
                  <label style="color: #ff6b35; font-size: 13px; margin-bottom: 5px; display: block;">×“×™×¨×§×˜×™×‘×”</label>
                  <select id="statusFilter" style="width: 100%; padding: 10px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px; height: 40px;">
                    <option value="">×”×›×œ</option>
                    <option value="×œ×œ× ×“×™×¨×§×˜×™×‘×”">×œ×œ× ×“×™×¨×§×˜×™×‘×”</option>
                    <option value="×œ×ª×™×§×•×Ÿ">×œ×ª×™×§×•×Ÿ</option>
                    <option value="×˜×•×˜××œ×•×¡ TL">×˜×•×˜××œ×•×¡ TL</option>
                    <option value="×œ× ×œ×ª×™×§×•×Ÿ ×‘×©×œ×‘ ×–×” ×œ×”×›×™×Ÿ ×”×¦×¢×ª ××—×™×¨">×œ× ×œ×ª×™×§×•×Ÿ ×‘×©×œ×‘ ×–×” ×œ×”×›×™×Ÿ ×”×¦×¢×ª ××—×™×¨</option>
                    <option value="××•×‘×“×Ÿ ×œ×”×œ×›×”">××•×‘×“×Ÿ ×œ×”×œ×›×”</option>
                    <option value="××›×™×¨×” ×‘××¦×‘×• ×”× ×™×–×•×§">××›×™×¨×” ×‘××¦×‘×• ×”× ×™×–×•×§</option>
                    <option value="×œ×”×›×™×Ÿ ×”×¦×¢×ª ××—×™×¨">×œ×”×›×™×Ÿ ×”×¦×¢×ª ××—×™×¨</option>
                  </select>
                </div>
       
                <!-- Case in Claim -->
                <div>
                  <label style="color: #ff6b35; font-size: 13px; margin-bottom: 5px; display: block;">×ª×™×§ ×‘×ª×‘×™×¢×”</label>
                  <select id="claimFilter" style="width: 100%; padding: 10px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px; height: 40px;">
                    <option value="">×”×›×œ</option>
                    <option value="yes">×›×Ÿ</option>
                    <option value="no">×œ×</option>
                    <option value="pending">×‘×”××ª× ×”</option>
                  </select>
                </div>

                <!-- Invoice Status -->
                <div>
                  <label style="color: #ff6b35; font-size: 13px; margin-bottom: 5px; display: block;">×—×©×‘×•× ×™×ª ×”×ª×§×‘×œ×”</label>
                  <select id="invoiceFilter" style="width: 100%; padding: 10px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px; height: 40px;">
                    <option value="">×”×›×œ</option>
                    <option value="yes">×›×Ÿ</option>
                    <option value="no">×œ×</option>
                  </select>
                </div>

                <!-- Payment Status -->
                <div>
                  <label style="color: #ff6b35; font-size: 13px; margin-bottom: 5px; display: block;">×ª×©×œ×•× ×”×ª×§×‘×œ</label>
                  <select id="paymentFilter" style="width: 100%; padding: 10px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px; height: 40px;">
                    <option value="">×”×›×œ</option>
                    <option value="yes">×›×Ÿ</option>
                    <option value="no">×œ×</option>
                  </select>
                </div>
              </div>

              <!-- Single Action Buttons -->
              <div style="display: flex; justify-content: center; gap: 15px; border-top: 1px solid #555; padding-top: 20px; margin-top: 20px;">
                <button onclick="performSearch()" 
                        onmouseover="this.style.background='#e55a2b'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)';"
                        onmouseout="this.style.background='#ff6b35'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)';"
                        style="padding: 15px 35px; background: #ff6b35; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                  ğŸ” ×—×¤×©
                </button>
                <button onclick="clearAllFilters()"
                        onmouseover="this.style.background='#5a6268'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)';"
                        onmouseout="this.style.background='#6b7280'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)';"
                        style="padding: 15px 30px; background: #6b7280; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                  ğŸ—‘ï¸ × ×§×” ×”×›×œ
                </button>
                <button onclick="exportResults()"
                        onmouseover="this.style.background='#047857'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)';"
                        onmouseout="this.style.background='#059669'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)';"
                        style="padding: 15px 30px; background: #059669; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                  ğŸ“¤ ×™×™×¦×
                </button>
              </div>
            </div>

            <div id="trackingResults" style="margin-top: 20px;">
              <div style="background: #333; padding: 15px; border-radius: 8px; border: 1px solid #555; color: #ccc; text-align: center;">
                <p>×”×’×“×¨ ×¤×¨××˜×¨×™ ×—×™×¤×•×© ×•×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ "×—×¤×©" ×›×“×™ ×œ×¦×¤×•×ª ×‘×ª×•×¦××•×ª</p>
                <p style="font-size: 12px; color: #999;">× ×™×ª×Ÿ ×œ×©×œ×‘ ××¡×¤×¨ ×¤×¨××˜×¨×™× ×œ×—×™×¤×•×© ××“×•×™×§ ×™×•×ª×¨</p>
              </div>
            </div>`;
          break;
          
        case 'reminders':
          content.innerHTML = `
            <h2 style="color: #ff6b35; font-size: 24px; margin-bottom: 20px;">ğŸ”” ×¨×©×™××ª ×ª×–×›×•×¨×•×ª</h2>
            
            <!-- Data Status and Primary Actions -->
            <div style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #555;">
              <div id="dataStatusDisplay" style="margin-bottom: 15px; padding: 10px; border-radius: 6px; background: #2a2a2a; border: 1px solid #444;">
                <div style="color: #ff6b35; font-weight: bold; margin-bottom: 5px;">××¦×‘ × ×ª×•× ×™×:</div>
                <div id="dataStatusText" style="color: #ccc; font-size: 14px;">×œ× × ×˜×¢× ×• ×ª×–×›×•×¨×•×ª - ×‘×—×¨ ×¤×¨××˜×¨×™ ×¡×™× ×•×Ÿ ×•×˜×¢×Ÿ ×ª×–×›×•×¨×•×ª ××”×©×¨×ª</div>
              </div>
              
              <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; justify-content: center;">
                <button onclick="addReminder()" 
                        onmouseover="this.style.background='#059669'; this.style.transform='translateY(-2px)'; this.title='×”×•×¡×£ ×ª×–×›×•×¨×ª ×—×“×©×”';"
                        onmouseout="this.style.background='#16a34a'; this.style.transform='translateY(0)'; this.title='';"
                        style="padding: 10px; background: #16a34a; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 12px; font-weight: bold; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; position: relative;">
                  â•
                </button>
                
                <button onclick="startVoiceReminder()" 
                        onmouseover="this.style.background='#8b5cf6'; this.style.transform='translateY(-2px)'; this.title='×¦×•×¨ ×ª×–×›×•×¨×ª ×‘×××¦×¢×•×ª ×§×•×œ';"
                        onmouseout="this.style.background='#7c3aed'; this.style.transform='translateY(0)'; this.title='';"
                        style="padding: 10px; background: #7c3aed; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 12px; font-weight: bold; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; position: relative;">
                  ğŸ¤
                </button>
                
                <button onclick="showLoadRemindersModal()" 
                        onmouseover="this.style.background='#e55a2b'; this.style.transform='translateY(-2px)'; this.title='×˜×¢×Ÿ ×ª×–×›×•×¨×•×ª ×¢× ×¡×™× ×•×Ÿ ××”×©×¨×ª';"
                        onmouseout="this.style.background='#ff6b35'; this.style.transform='translateY(0)'; this.title='';"
                        style="padding: 10px; background: #ff6b35; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 12px; font-weight: bold; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; position: relative;">
                  ğŸ“¥
                </button>
                
                <button id="refreshDataBtn" onclick="refreshReminders()" disabled
                        onmouseover="if(!this.disabled) { this.style.background='#6366f1'; this.style.transform='translateY(-2px)'; this.title='×¨×¢× ×Ÿ ×¨×©×™××ª ×ª×–×›×•×¨×•×ª'; }"
                        onmouseout="if(!this.disabled) { this.style.background='#4f46e5'; this.style.transform='translateY(0)'; this.title=''; }"
                        style="padding: 10px; background: #4f46e5; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 12px; opacity: 0.5; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; position: relative;">
                  ğŸ”„
                </button>
              </div>
            </div>
            
            <!-- Local Filtering Controls (Initially Disabled) -->
            <div id="localFilterControls" style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #555; opacity: 0.5;">
              <div style="margin-bottom: 10px; color: #ff6b35; font-weight: bold;">×¡×™× ×•×Ÿ ××§×•××™ (×–××™×Ÿ ×œ××—×¨ ×˜×¢×™× ×ª × ×ª×•× ×™×):</div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                  <label style="color: #e0e0e0; font-size: 14px; margin-bottom: 5px; display: block;">×¡×™× ×•×Ÿ ×œ×¤×™ ×¡×˜×˜×•×¡:</label>
                  <select id="localStatusFilter" disabled style="padding: 8px; border-radius: 4px; border: 1px solid #555; background: #444; color: #e0e0e0; width: 100%;">
                    <option value="all">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                    <option value="active">×¤×¢×™×œ</option>
                    <option value="pending">×××ª×™×Ÿ</option>
                    <option value="completed">×”×•×©×œ×</option>
                    <option value="overdue">×¤×’ ×ª×•×§×£</option>
                  </select>
                </div>
                <div>
                  <label style="color: #e0e0e0; font-size: 14px; margin-bottom: 5px; display: block;">×¡×™× ×•×Ÿ ×œ×¤×™ ×§×˜×’×•×¨×™×”:</label>
                  <select id="localCategoryFilter" disabled style="padding: 8px; border-radius: 4px; border: 1px solid #555; background: #444; color: #e0e0e0; width: 100%;">
                    <option value="all">×›×œ ×”×§×˜×’×•×¨×™×•×ª</option>
                    <option value="case_deadline">××•×¢×“ ×¡×’×™×¨×ª ×ª×™×§</option>
                    <option value="payment_reminder">×ª×–×›×•×¨×ª ×ª×©×œ×•×</option>
                    <option value="follow_up">××¢×§×‘</option>
                    <option value="inspection">×‘×“×™×§×”</option>
                    <option value="general">×›×œ×œ×™</option>
                  </select>
                </div>
              </div>
              
              <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap; justify-content: center;">
                <button id="localFilterBtn" onclick="applyLocalFilters()" disabled
                        onmouseover="if(!this.disabled) { this.style.background='#3b82f6'; this.style.transform='translateY(-2px)'; this.title='×¡× ×Ÿ ×ª×–×›×•×¨×•×ª ×œ×¤×™ ×”×§×¨×™×˜×¨×™×•× ×™× ×©× ×‘×—×¨×•'; }"
                        onmouseout="if(!this.disabled) { this.style.background='#1d4ed8'; this.style.transform='translateY(0)'; this.title=''; }"
                        style="padding: 10px; background: #1d4ed8; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 12px; opacity: 0.5; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; position: relative;">
                  ğŸ”
                </button>
                
                <button id="toggleViewBtn" onclick="toggleView()" disabled
                        onmouseover="if(!this.disabled) { this.style.background='#9333ea'; this.style.transform='translateY(-2px)'; this.title='×”×—×œ×£ ×‘×™×Ÿ ×ª×¦×•×’×ª ×¨×©×™××” ×œ×ª×¦×•×’×ª ×™×•××Ÿ'; }"
                        onmouseout="if(!this.disabled) { this.style.background='#7c3aed'; this.style.transform='translateY(0)'; this.title=''; }"
                        style="padding: 10px; background: #7c3aed; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 12px; opacity: 0.5; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; position: relative;">
                  ğŸ“…
                </button>
                
                <button id="exportBtn" onclick="exportReminders()" disabled
                        onmouseover="if(!this.disabled) { this.style.background='#f59e0b'; this.style.transform='translateY(-2px)'; this.title='×™×™×¦× ×ª×–×›×•×¨×•×ª ×œ×§×•×‘×¥ JSON'; }"
                        onmouseout="if(!this.disabled) { this.style.background='#d97706'; this.style.transform='translateY(0)'; this.title=''; }"
                        style="padding: 10px; background: #d97706; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 12px; opacity: 0.5; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; position: relative;">
                  ğŸ“¤
                </button>
                
                <button id="calendarSyncBtn" onclick="showCalendarSyncModal()" disabled
                        onmouseover="if(!this.disabled) { this.style.background='#0ea5e9'; this.style.transform='translateY(-2px)'; this.title='×¡× ×›×¨×Ÿ ×¢× ×™×•××Ÿ ×—×™×¦×•× ×™ (Google/Outlook)'; }"
                        onmouseout="if(!this.disabled) { this.style.background='#0284c7'; this.style.transform='translateY(0)'; this.title=''; }"
                        style="padding: 10px; background: #0284c7; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 12px; opacity: 0.5; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; position: relative;">
                  ğŸ”—
                </button>
              </div>
            </div>
            
            <!-- Reminders List View -->
            <div id="remindersListView" style="display: block;">
              <div id="remindersList">
                <div style="background: #2a2a2a; padding: 15px; border-radius: 8px; margin: 10px 0; border: 1px solid #444;">
                  <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                    <h4 style="color: #4ade80; margin: 0; font-size: 16px;">×ª×–×›×•×¨×ª ×œ×‘×“×™×§×ª ×ª×™×§×™× ×¤×ª×•×—×™×</h4>
                    <span style="background: #16a34a; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">×¤×¢×™×œ</span>
                  </div>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; font-size: 14px; color: #ccc;">
                    <div><strong style="color: #fbbf24;">×ª××¨×™×š ×™×¢×“:</strong> ${new Date(Date.now() + 86400000).toLocaleDateString('he-IL')}</div>
                    <div><strong style="color: #fbbf24;">×§×˜×’×•×¨×™×”:</strong> ××¢×§×‘</div>
                    <div><strong style="color: #fbbf24;">×¢×“×™×¤×•×ª:</strong> ×’×‘×•×”×”</div>
                    <div><strong style="color: #fbbf24;">× ×•×¦×¨:</strong> ${new Date().toLocaleDateString('he-IL')}</div>
                  </div>
                  <p style="color: #e0e0e0; margin: 10px 0; font-size: 14px;">×‘×“×™×§×” ×©×‘×•×¢×™×ª ×©×œ ×ª×™×§×™× ×¤×ª×•×—×™× ×”×¢×•×‘×¨×™× 30 ×™×•× ×œ×œ× ×¤×¢×™×œ×•×ª</p>
                  <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button onclick="editReminder(1)" 
                            onmouseover="this.style.background='#f59e0b'; this.style.transform='translateY(-1px)';"
                            onmouseout="this.style.background='#d97706'; this.style.transform='translateY(0)';"
                            style="padding: 8px 16px; background: #d97706; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 13px;">
                      âœï¸ ×¢×¨×•×š
                    </button>
                    <button onclick="completeReminder(1)" 
                            onmouseover="this.style.background='#059669'; this.style.transform='translateY(-1px)';"
                            onmouseout="this.style.background='#16a34a'; this.style.transform='translateY(0)';"
                            style="padding: 8px 16px; background: #16a34a; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 13px;">
                      âœ… ×¡××Ÿ ×›×”×•×©×œ×
                    </button>
                    <button onclick="deleteReminder(1)" 
                            onmouseover="this.style.background='#dc2626'; this.style.transform='translateY(-1px)';"
                            onmouseout="this.style.background='#991b1b'; this.style.transform='translateY(0)';"
                            style="padding: 8px 16px; background: #991b1b; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 13px;">
                      ğŸ—‘ï¸ ××—×§
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Calendar View (Hidden by default) -->
            <div id="remindersCalendarView" style="display: none;">
              <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; border: 1px solid #444;">
                <h3 style="color: #ff6b35; margin-bottom: 15px; text-align: center;">ğŸ“… ×ª×¦×•×’×ª ×™×•××Ÿ ×ª×–×›×•×¨×•×ª</h3>
                
                <!-- Calendar Navigation -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                  <button onclick="previousMonth()" style="padding: 8px 16px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; cursor: pointer;">â—€ ×”×§×•×“×</button>
                  <h4 id="calendarMonth" style="color: #ff6b35; margin: 0;"></h4>
                  <button onclick="nextMonth()" style="padding: 8px 16px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; cursor: pointer;">×”×‘× â–¶</button>
                </div>
                
                <!-- Calendar Grid -->
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 20px;">
                  <!-- Days of week headers -->
                  <div style="background: #333; color: #ff6b35; padding: 8px; text-align: center; font-weight: bold; border-radius: 4px;">×</div>
                  <div style="background: #333; color: #ff6b35; padding: 8px; text-align: center; font-weight: bold; border-radius: 4px;">×‘</div>
                  <div style="background: #333; color: #ff6b35; padding: 8px; text-align: center; font-weight: bold; border-radius: 4px;">×’</div>
                  <div style="background: #333; color: #ff6b35; padding: 8px; text-align: center; font-weight: bold; border-radius: 4px;">×“</div>
                  <div style="background: #333; color: #ff6b35; padding: 8px; text-align: center; font-weight: bold; border-radius: 4px;">×”</div>
                  <div style="background: #333; color: #ff6b35; padding: 8px; text-align: center; font-weight: bold; border-radius: 4px;">×•</div>
                  <div style="background: #333; color: #ff6b35; padding: 8px; text-align: center; font-weight: bold; border-radius: 4px;">×©</div>
                </div>
                
                <!-- Calendar Days Container -->
                <div id="calendarDays" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 20px;">
                  <!-- Days will be populated by JavaScript -->
                </div>
                
                <!-- Selected Date Reminders -->
                <div id="selectedDateReminders" style="display: none; background: #333; padding: 15px; border-radius: 8px; border: 1px solid #555;">
                  <h4 style="color: #ff6b35; margin: 0 0 10px 0;">×ª×–×›×•×¨×•×ª ×œ×™×•× <span id="selectedDateText"></span></h4>
                  <div id="selectedDateRemindersList"></div>
                </div>
              </div>
            </div>`;
            
          // Initialize reminder section - no automatic fetching
          setTimeout(() => {
            // Initialize with empty state
            const remindersList = document.getElementById('remindersList');
            if (remindersList) {
              remindersList.innerHTML = `
                <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; border: 1px solid #444; text-align: center;">
                  <h3 style="color: #ff6b35;">ğŸ‘† ×”×ª×—×œ ×¢×œ ×™×“×™ ×˜×¢×™× ×ª ×ª×–×›×•×¨×•×ª</h3>
                  <p style="color: #ccc;">×œ×—×¥ ×¢×œ "×˜×¢×Ÿ ×ª×–×›×•×¨×•×ª ×¢× ×¡×™× ×•×Ÿ" ×›×“×™ ×œ×˜×¢×•×Ÿ ×ª×–×›×•×¨×•×ª ×¨×œ×•×•× ×˜×™×•×ª ××”×©×¨×ª</p>
                  <p style="color: #999; font-size: 14px;">×–×” ×™××¤×©×¨ ×œ×š ×œ×‘×—×•×¨ ×¤×¨××˜×¨×™ ×¡×™× ×•×Ÿ ×•×œ×˜×¢×•×Ÿ ×¨×§ ××ª ×”××™×“×¢ ×©××ª×” ×¦×¨×™×š</p>
                </div>`;
            }
          }, 200);
          break;
          
        case 'override':
          content.innerHTML = `
            <h2>âœï¸ ×©×™× ×•×™ × ×ª×•× ×™×</h2>
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeaa7; margin-bottom: 20px;">
              <strong style="color: #dc3545; font-size: 14px;">âš ï¸ ××–×”×¨×”:</strong> <span style="color: #dc3545; font-size: 13px;">×©×™× ×•×™ × ×ª×•× ×™× ×‘××¢×¨×›×ª ×“×•×¨×© ×”×¨×©××•×ª ×× ×”×œ ×•×’×™×‘×•×™ ××•×˜×•××˜×™</span>
              <br><small style="color: #dc3545; font-size: 12px;">××™×•×¢×“ ×œ×ª×™×§×•×Ÿ × ×ª×•× ×™× ××—×¨×™ ×¡×™×•× ×”×ª×™×§ - ×œ× ×œ×”×›× ×ª ×“×•×—×•×ª ×—×“×©×™×</small>
            </div>
            
            <!-- Case Search Section -->
            <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px;">
              <h3>ğŸ” ×—×™×¤×•×© ×ª×™×§ ××•×©×œ× ×œ×¢×¨×™×›×”</h3>
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="editPlateSearch" placeholder="×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘" style="padding: 8px; width: 200px; border: 1px solid #ddd; border-radius: 4px;">
                <button onclick="loadFinalizedCaseForEdit()" style="padding: 8px 16px; background: #ff6b35; color: white; border: none; border-radius: 4px; cursor: pointer;">×˜×¢×Ÿ ×ª×™×§ ××•×©×œ×</button>
              </div>
              <small style="color: #666;">×—×™×¤×•×© ×ª×™×§×™× ××•×©×œ××™× ×¢× ×“×•×— ×¡×•×¤×™ - ×œ×ª×™×§×•× ×™× ×•×”×ª×××•×ª ×‘×œ×‘×“</small>
            </div>
            
            <!-- Quick Actions -->
            <div style="background: #e3f2fd; padding: 20px; border-radius: 12px; border: 1px solid #2196f3; margin-bottom: 20px;">
              <div style="display: flex; gap: 12px; justify-content: center; align-items: center; flex-wrap: wrap;">
                <button onclick="expandAllSections()" style="padding: 12px 24px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3); transition: all 0.3s ease; min-width: 120px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(76, 175, 80, 0.4)';" onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 8px rgba(76, 175, 80, 0.3)';">ğŸ”½ ×¤×ª×— ×”×›×œ</button>
                <button onclick="collapseAllSections()" style="padding: 12px 24px; background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3); transition: all 0.3s ease; min-width: 120px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(108, 117, 125, 0.4)';" onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 8px rgba(108, 117, 125, 0.3)';">ğŸ”¼ ×¡×’×•×¨ ×”×›×œ</button>
                <button onclick="performFullIntegrityCheck()" style="padding: 12px 24px; background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3); transition: all 0.3s ease; min-width: 120px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(23, 162, 184, 0.4)';" onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 8px rgba(23, 162, 184, 0.3)';">ğŸ” ×‘×“×•×§ ×›×œ ×”× ×ª×•× ×™×</button>
              </div>
            </div>
            
            <!-- Results Section -->
            <div id="editResults" style="margin-top: 20px;">
              <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; text-align: center;">
                <h4 style="color: #dc3545; margin-bottom: 10px; font-weight: 600;">ğŸ“‹ ××¨×›×– ×‘×§×¨×ª × ×ª×•× ×™×</h4>
                <p style="color: #6c757d;">×—×¤×© ×ª×™×§ ××•×©×œ× ×›×“×™ ×œ×¢×¨×•×š ××ª ×”× ×ª×•× ×™× ×”×¡×•×¤×™×™×</p>
                <div style="margin-top: 15px;">
                  <strong style="color: #2e7d32;">×ª×™×§×•× ×™× ×–××™× ×™× ×œ×ª×™×§×™× ××•×©×œ××™×:</strong>
                  <ul style="text-align: right; margin-top: 10px; padding-right: 20px; color: #495057;">
                    <li><strong>××¨×›×–×™ × ×–×§:</strong> ×¢×¨×™×›×ª ×¢×‘×•×“×•×ª, ×ª×™×§×•× ×™× ×•×—×œ×§×™× ×œ×›×œ ××¨×›×–</li>
                    <li><strong>×”×ª×××•×ª ×œ×•×™:</strong> ×ª×™×§×•×Ÿ × ×ª×•× ×™ ×©×•×•×™ ×•×™×¨×™×“×ª ×¢×¨×š</li>
                    <li><strong>×¤×—×ª:</strong> ×¢×“×›×•×Ÿ ××—×•×–×™ ×¤×—×ª ×›×œ×œ×™ ×•×œ×¤×™ ××¨×›×–</li>
                    <li><strong>××¢"× ×¡×¤×¦×™×¤×™:</strong> ×©×™× ×•×™ ××¢"× ×œ×ª×™×§ ××¡×•×™×</li>
                    <li><strong>×¡×•×’ ×“×•×—:</strong> ×©×™× ×•×™ ×‘×™×Ÿ ×¤×¨×˜×™/×’×œ×•×‘×œ×™/××•×‘×“×Ÿ/××›×™×¨×”</li>
                    <li><strong>× ×ª×•× ×™× ×¡×˜×˜×™×™×:</strong> ××¡×¤×¨ ×¨×›×‘, ×‘×¢×œ×™× (××§×¨×™× × ×“×™×¨×™×)</li>
                    <li><strong>×”×¢×œ××ª helper.json:</strong> ×”×—×œ×¤×” ××œ××” ×©×œ × ×ª×•× ×™×</li>
                  </ul>
                </div>
              </div>
            </div>`;
          break;
          
        case 'logView':
          content.innerHTML = `
            <h2 style="color: #ff6b35; font-size: 18px; margin-bottom: 15px; text-align: center;">ğŸ“œ ×™×•××Ÿ ×¤×¢×•×œ×•×ª</h2>
            
            <!-- Action Buttons - Centered -->
            <div style="margin-bottom: 15px; display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;">
              <button onclick="window.refreshLog()" style="padding: 6px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">ğŸ”„ ×¨×¢× ×Ÿ ×™×•××Ÿ</button>
              <button onclick="window.exportLogCSV()" style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">ğŸ“Š ×™×¦× CSV</button>
              <button onclick="window.clearLogs()" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">ğŸ—‘ï¸ × ×§×” ×™×•××Ÿ</button>
            </div>
            
            <!-- Log Filters -->
            <div style="background: #2a2a2a; color: #e0e0e0; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #444;">
              <h4 style="color: #ff6b35; font-size: 14px; margin: 0 0 10px 0;">×¡×™× ×•×Ÿ ×™×•××Ÿ</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; margin-bottom: 10px;">
                <select id="logTypeFilter" style="padding: 6px; font-size: 12px; background: #3a3a3a; color: #e0e0e0; border: 1px solid #555; border-radius: 4px;">
                  <option value="">×›×œ ×”×¡×•×’×™×</option>
                  <option value="user_action">×¤×¢×•×œ×•×ª ××©×ª××©</option>
                  <option value="system_event">××™×¨×•×¢×™ ××¢×¨×›×ª</option>
                  <option value="error">×©×’×™××•×ª</option>
                  <option value="audit">×‘×™×§×•×¨×ª</option>
                </select>
                <select id="logLevelFilter" style="padding: 6px; font-size: 12px; background: #3a3a3a; color: #e0e0e0; border: 1px solid #555; border-radius: 4px;">
                  <option value="">×›×œ ×”×¨××•×ª</option>
                  <option value="info">××™×“×¢</option>
                  <option value="warn">××–×”×¨×”</option>
                  <option value="error">×©×’×™××”</option>
                  <option value="critical">×§×¨×™×˜×™</option>
                </select>
                <select id="logModuleFilter" style="padding: 6px; font-size: 12px; background: #3a3a3a; color: #e0e0e0; border: 1px solid #555; border-radius: 4px;">
                  <option value="">×›×œ ×”××•×“×•×œ×™×</option>
                  <option value="admin">× ×™×”×•×œ</option>
                  <option value="expertise">××§×¡×¤×¨×˜×™×–×”</option>
                  <option value="reports">×“×•×—×•×ª</option>
                  <option value="upload">×”×¢×œ××”</option>
                  <option value="auth">××™××•×ª</option>
                </select>
                <input type="text" id="logSearchText" placeholder="×—×™×¤×•×© ×‘×˜×§×¡×˜..." style="padding: 6px; font-size: 12px; background: #3a3a3a; color: #e0e0e0; border: 1px solid #555; border-radius: 4px;">
                <input type="date" id="logDateFrom" style="padding: 6px; font-size: 12px; background: #3a3a3a; color: #e0e0e0; border: 1px solid #555; border-radius: 4px;">
                <input type="date" id="logDateTo" style="padding: 6px; font-size: 12px; background: #3a3a3a; color: #e0e0e0; border: 1px solid #555; border-radius: 4px;">
              </div>
              <div style="text-align: center;">
                <button onclick="window.applyLogFilters()" style="padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; margin-left: 5px;">×”×—×œ ×¡×™× ×•×Ÿ</button>
                <button onclick="window.clearLogFilters()" style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; margin-left: 5px;">× ×§×” ×¡×™× ×•×Ÿ</button>
              </div>
            </div>
            
            <!-- Log Statistics -->
            <div id="logStats" style="background: #2a2a2a; color: #e0e0e0; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #444;">
              <h4 style="color: #ff6b35; font-size: 14px; margin: 0 0 8px 0;">×¡×˜×˜×™×¡×˜×™×§×•×ª ×™×•××Ÿ</h4>
              <div id="logStatsContent" style="font-size: 12px; color: #ccc;">×˜×•×¢×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª...</div>
            </div>
            
            <!-- Log Content -->
            <div id="logContent" style="background: #2a2a2a; color: #e0e0e0; padding: 12px; border-radius: 6px; max-height: 400px; overflow-y: auto; border: 1px solid #444;">
              <div style="text-align: center; color: #999; padding: 15px; font-size: 12px;">
                ×˜×•×¢×Ÿ ×™×•××Ÿ ×¤×¢×•×œ×•×ª...
              </div>
            </div>`;
          break;
          
        case 'clearSystem':
          content.innerHTML = `
            <h2 style="color: #dc3545; font-size: 18px; margin-bottom: 15px; text-align: center;">ğŸ—‘ï¸ ××—×™×§×ª × ×ª×•× ×™ ××¢×¨×›×ª</h2>
            
            <div style="background: #2a2a2a; color: #e0e0e0; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #dc3545;">
              <h3 style="color: #dc3545; margin-top: 0;">âš ï¸ ××–×”×¨×” ×—××•×¨×”</h3>
              <p style="margin-bottom: 15px;">×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×”×‘××™× ××”××¢×¨×›×ª:</p>
              
              <ul style="text-align: right; margin: 15px 0; color: #f8d7da;">
                <li>×›×œ ×¤×¨×˜×™ ×”×¨×›×‘ ×•×”×‘×¢×œ×™×</li>
                <li>× ×ª×•× ×™ ×”× ×–×§ ×•×”××§×¡×¤×¨×˜×™×–×•×ª</li>
                <li>××•××“× ×™× ×•×—×™×©×•×‘×™ ×¤×™×¦×•×™</li>
                <li>×—×œ×§×™ ×—×™×œ×•×£ ×•××—×™×¨×•× ×™×</li>
                <li>×—×©×‘×•× ×™×•×ª ×•××¡××›×™×</li>
                <li>×“×•×—×•×ª ×¡×•×¤×™×™× ×•× ×ª×•× ×™ ×”×¢×¨×›×ª ×©×•×•×™</li>
                <li>×›×œ ×”××™×“×¢ ×”×©××•×¨ ×‘××¢×¨×›×ª</li>
              </ul>
              
              <div style="background: #450a0a; padding: 15px; border-radius: 6px; margin: 15px 0; border: 1px solid #dc3545;">
                <strong style="color: #dc3545;">×©×™× ×œ×‘:</strong> ×¤×¢×•×œ×” ×–×• ×‘×œ×ª×™ ×”×¤×™×›×” ×•×ª××—×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×œ×¦××™×ª×•×ª!
              </div>
              
              <div style="text-align: center; margin-top: 25px;">
                <button onclick="confirmSystemClear()" 
                        style="padding: 12px 24px; background: #dc3545; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; margin-right: 10px;"
                        onmouseover="this.style.background='#c82333'" 
                        onmouseout="this.style.background='#dc3545'">
                  ğŸ—‘ï¸ ××—×§ ××ª ×›×œ ×”× ×ª×•× ×™×
                </button>
                <button onclick="loadSection('caseStatus')" 
                        style="padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;"
                        onmouseover="this.style.background='#5a6268'" 
                        onmouseout="this.style.background='#6c757d'">
                  ×‘×™×˜×•×œ
                </button>
              </div>
            </div>
            
            <div id="clearSystemStatus" style="margin-top: 15px; text-align: center; display: none;"></div>
          `;
          break;
          
        case 'userManagement':
          content.innerHTML = `
            <h2 style="color: #ff6b35; font-size: 18px; margin-bottom: 15px; text-align: center;">ğŸ‘¥ × ×™×”×•×œ ××©×ª××©×™×</h2>
            <div id="userManagementContent" style="padding: 5px; width: 100%; box-sizing: border-box;"></div>
          `;
          loadUserManagement();
          break;
          
        case 'deleteCase':
          content.innerHTML = `
            <h2 style="color: #e74c3c; font-size: 18px; margin-bottom: 15px; text-align: center;">ğŸ—‘ï¸ ××—×™×§×ª ×ª×™×§</h2>
            
            <div style="background: #2a2a2a; color: #e0e0e0; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e74c3c;">
              <h3 style="color: #e74c3c; margin-top: 0;">âš ï¸ ××—×™×§×ª ×ª×™×§ ×§×‘×•×¢×”</h3>
              <p style="margin-bottom: 15px;">×‘×—×¨ ×××™×¤×” ×œ××—×•×§ ××ª ×”×ª×™×§:</p>
              
              <div style="margin: 20px 0; background: #333; padding: 15px; border-radius: 6px;">
                <label style="display: block; margin-bottom: 10px; cursor: pointer;">
                  <input type="radio" name="deleteSource" value="supabase" style="margin-left: 10px;">
                  ğŸ—„ï¸ ××—×§ ××”×©×¨×ª ×‘×œ×‘×“
                </label>
                <label style="display: block; margin-bottom: 10px; cursor: pointer;">
                  <input type="radio" name="deleteSource" value="onedrive" style="margin-left: 10px;">
                  ğŸ“ ××—×§ ×-OneDrive ×‘×œ×‘×“
                </label>
                <label style="display: block; margin-bottom: 10px; cursor: pointer;">
                  <input type="radio" name="deleteSource" value="both" checked style="margin-left: 10px;">
                  ğŸ—‘ï¸ ××—×§ ××©× ×™ ×”××§×•××•×ª
                </label>
              </div>
              
              <div style="background: #450a0a; padding: 15px; border-radius: 6px; margin: 15px 0; border: 1px solid #e74c3c;">
                <strong style="color: #e74c3c;">×–×”×™×¨×•×ª:</strong> ×¤×¢×•×œ×” ×–×• ×‘×œ×ª×™ ×”×¤×™×›×” ×•×ª××—×§ ××ª ×›×œ × ×ª×•× ×™ ×”×ª×™×§!
              </div>
              
              <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">××¡×¤×¨ ×¨×›×‘ ×œ××—×™×§×”:</label>
                <input type="text" id="deleteCasePlate" placeholder="×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘" 
                       style="width: 100%; padding: 10px; background: #3a3a3a; color: #e0e0e0; border: 1px solid #555; border-radius: 4px; margin-bottom: 15px;">
              </div>
              
              <div style="margin: 20px 0;">
                <p style="color: #ffc107; margin-bottom: 15px;">
                  <strong>×©×œ×‘ 1:</strong> ×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ ×”××—×™×§×”<br>
                  <strong>×©×œ×‘ 2:</strong> ×”×§×œ×“ "DELETE" ×‘×—×œ×•×Ÿ ×©×™×•×¤×™×¢
                </p>
                <input type="hidden" id="deleteAuth1" value="">
                <input type="hidden" id="deleteAuth2" value="">
              </div>
              
              <div style="text-align: center; margin-top: 25px;">
                <button onclick="initiateCaseDeletion()" 
                        style="padding: 12px 24px; background: #e74c3c; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; margin-right: 10px;"
                        onmouseover="this.style.background='#c0392b'" 
                        onmouseout="this.style.background='#e74c3c'">
                  ğŸ—‘ï¸ ×‘×¦×¢ ××—×™×§×”
                </button>
                <button onclick="loadSection('caseStatus')" 
                        style="padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;"
                        onmouseover="this.style.background='#5a6268'" 
                        onmouseout="this.style.background='#6c757d'">
                  ×‘×™×˜×•×œ
                </button>
              </div>
            </div>
            
            <div id="deleteCaseStatus" style="margin-top: 15px; text-align: center; display: none;"></div>
          `;
          break;
          
        case 'versionManagement':
          content.innerHTML = `
            <h2 style="color: #ff6b35; font-size: 18px; margin-bottom: 15px; text-align: center;">ğŸ“š × ×™×”×•×œ ×’×¨×¡××•×ª ×ª×™×§×™×</h2>
            
            <div style="background: #2a2a2a; color: #e0e0e0; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #17a2b8;">
              <h3 style="color: #17a2b8; margin-top: 0;">ğŸ” ×—×™×¤×•×© ×ª×™×§ ×œ× ×™×”×•×œ ×’×¨×¡××•×ª</h3>
              <p style="margin-bottom: 15px;">××•×“×•×œ ×–×” ××™×•×¢×“ ×œ×˜×™×¤×•×œ ×‘××¦×‘×™ ×—×™×¨×•× ×•×§×•× ×¤×œ×™×§×˜×™× ×‘×™×Ÿ ×’×¨×¡××•×ª. ×›××Ÿ ×ª×•×›×œ ×œ×¦×¤×•×ª, ×œ×©×—×–×¨ ×•×œ×”×•×¨×™×“ ×’×¨×¡××•×ª ×§×•×“××•×ª ×©×œ ×ª×™×§×™×.</p>
              
              <div style="background: #1a365d; padding: 15px; border-radius: 6px; margin: 15px 0; border: 1px solid #17a2b8;">
                <strong style="color: #17a2b8;">××˜×¨×ª ×”××•×“×•×œ:</strong> ×©×—×–×•×¨ × ×ª×•× ×™× ×‘××§×¨×” ×©×œ ×©×’×™××•×ª, ×§×•× ×¤×œ×™×§×˜×™× ××• ×¦×•×¨×š ×‘×’×¨×¡×” ×§×•×“××ª ×©×œ ×”×ª×™×§
              </div>
              
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <label style="font-weight: bold; min-width: 120px;">××¡×¤×¨ ×¨×›×‘:</label>
                <input type="text" id="versionPlateSearch" placeholder="×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘ (×œ×“×•×’××”: 12345678)" 
                       style="width: 200px; padding: 8px; background: #3a3a3a; color: #e0e0e0; border: 1px solid #555; border-radius: 4px;">
                <button onclick="loadCaseVersionHistory()" 
                        style="padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                  ğŸ” ×˜×¢×Ÿ ×’×¨×¡××•×ª ×”×ª×™×§
                </button>
              </div>
              
              <div style="font-size: 12px; color: #999; margin-top: 10px;">
                ğŸ’¡ ×˜×™×¤: ×”×ª×™×§ ×™×˜×¢×Ÿ ×¢× ×›×œ ×”×’×¨×¡××•×ª ×”×”×™×¡×˜×•×¨×™×•×ª. ×ª×•×›×œ ×œ×¨××•×ª ××ª×™ ×›×œ ×’×¨×¡×” × ×©××¨×” ×•××” ×”×©×ª× ×” ×‘×”.
              </div>
            </div>
            
            <div id="versionResults" style="display: none;">
              <div style="background: #333; padding: 15px; border-radius: 8px; border: 1px solid #555; margin-bottom: 20px;">
                <div id="caseInfoDisplay" style="margin-bottom: 15px;"></div>
                <div id="versionsList"></div>
              </div>
            </div>
            
            <div id="versionStatus" style="margin-top: 15px; text-align: center;"></div>
          `;
          break;
          
        default:
          content.innerHTML = `<p>×˜×•×¢×Ÿ ${id}...</p>`;
      }
    };

    // Define performSearch function globally to be accessible by onclick
    window.performSearch = async function() {
      const resultsDiv = document.getElementById('trackingResults');
      
      // Check if at least one filter is set - ANY field is acceptable
      const hasAnyFilter = document.getElementById('dateFrom')?.value ||
                          document.getElementById('dateTo')?.value ||
                          document.getElementById('statusFilter')?.value ||
                          document.getElementById('manufacturerFilter')?.value?.trim() ||
                          document.getElementById('ownerFilter')?.value?.trim() ||
                          document.getElementById('garageFilter')?.value?.trim() ||
                          document.getElementById('claimFilter')?.value ||
                          document.getElementById('invoiceFilter')?.value ||
                          document.getElementById('paymentFilter')?.value;
                          
      if (!hasAnyFilter) {
        alert('×× × ×‘×—×¨ ×œ×¤×—×•×ª ×¤×™×œ×˜×¨ ××—×“ ×›×“×™ ×œ×‘×¦×¢ ×—×™×¤×•×© (×ª××¨×™×š, ×™×¦×¨×Ÿ, ×“×™×¨×§×˜×™×‘×” ×•×›×•...)');
        resultsDiv.innerHTML = `
          <div style="background: #333; padding: 15px; border-radius: 8px; border: 1px solid #555; color: #ccc; text-align: center;">
            <p>×œ× × ×‘×—×¨×• ×¤×™×œ×˜×¨×™×</p>
            <p style="font-size: 12px; color: #999;">×‘×—×¨ ×œ×¤×—×•×ª ×¤×™×œ×˜×¨ ××—×“ (×›×œ ×©×“×”) ×•× ×¡×” ×©×•×‘</p>
          </div>`;
        return;
      }
      
      resultsDiv.innerHTML = `
        <div style="background: #333; padding: 12px; border-radius: 8px; border: 1px solid #555; color: #e0e0e0; text-align: center;">
          <h4 style="color: #ff6b35; margin-bottom: 8px;">ğŸ” ××—×¤×© ×œ×¤×™ ×”×¤×¨××˜×¨×™× ×©× ×‘×—×¨×•</h4>
          <p>×× × ×”××ª×Ÿ...</p>
        </div>`;
      
      try {
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available - page still loading');
        }
        
        // Ultra simple structure that Make.com can easily parse
        const searchParams = {
          type: 'field_search',
          date_from: document.getElementById('dateFrom')?.value || 'all',
          date_to: document.getElementById('dateTo')?.value || 'all',
          directive: document.getElementById('statusFilter')?.value || 'all',
          manufacturer: document.getElementById('manufacturerFilter')?.value?.trim() || 'all',
          owner: document.getElementById('ownerFilter')?.value?.trim() || 'all',
          garage: document.getElementById('garageFilter')?.value?.trim() || 'all',
          claim_status: document.getElementById('claimFilter')?.value || 'all',
          invoice_received: document.getElementById('invoiceFilter')?.value || 'all',
          payment_received: document.getElementById('paymentFilter')?.value || 'all'
        };
        
        // Send all parameters including empty ones - let the webhook handle filtering
        console.log('ğŸ” Sending search parameters:', searchParams);
        console.log('ğŸŒ Webhook URL:', window.WEBHOOKS?.ADMIN_FETCH_FIELDS);
        console.log('ğŸ”§ sendToWebhook function available:', typeof window.sendToWebhook);
        
        const response = await window.sendToWebhook('ADMIN_FETCH_FIELDS', searchParams);
        console.log('ğŸ“¥ Webhook response:', response);
        
        // Store results and filters for export
        window.lastSearchResults = response && Array.isArray(response) ? response : (response ? [response] : []);
        window.lastSearchFilters = searchParams;
        
        // Create description of active filters (only non-empty ones)
        const activeFilters = [];
        if (searchParams.date_from && searchParams.date_to) activeFilters.push(`×ª××¨×™×›×™×: ${searchParams.date_from} - ${searchParams.date_to}`);
        if (searchParams.directive) activeFilters.push(`×“×™×¨×§×˜×™×‘×”: ${searchParams.directive}`);
        if (searchParams.manufacturer) activeFilters.push(`×™×¦×¨×Ÿ: ${searchParams.manufacturer}`);
        if (searchParams.owner) activeFilters.push(`×‘×¢×œ×™×: ${searchParams.owner}`);
        if (searchParams.garage) activeFilters.push(`××•×¡×š: ${searchParams.garage}`);
        if (searchParams.claim_status) activeFilters.push(`×ª×™×§ ×‘×ª×‘×™×¢×”: ${searchParams.claim_status}`);
        if (searchParams.invoice_received) activeFilters.push(`×—×©×‘×•× ×™×ª: ${searchParams.invoice_received === 'yes' ? '×›×Ÿ' : '×œ×'}`);
        if (searchParams.payment_received) activeFilters.push(`×ª×©×œ×•×: ${searchParams.payment_received === 'yes' ? '×›×Ÿ' : '×œ×'}`);
        
        const filterDescription = activeFilters.length > 0 ? activeFilters.join(', ') : '×—×™×¤×•×© ×›×œ×œ×™';
        window.displayFieldResults('×—×™×¤×•×© ××•×¨×›×‘', filterDescription, response);
        
      } catch (error) {
        console.error('Search error:', error);
        window.displayFieldError('×—×™×¤×•×© ××•×¨×›×‘', error.message);
      }
    };

    // Define clearAllFilters function globally
    window.clearAllFilters = function() {
      // Clear date filters
      const dateFromField = document.getElementById('dateFrom');
      const dateToField = document.getElementById('dateTo');
      if (dateFromField) dateFromField.value = '';
      if (dateToField) dateToField.value = '';
      
      // Clear text filters
      const manufacturerField = document.getElementById('manufacturerFilter');
      const ownerField = document.getElementById('ownerFilter');
      const garageField = document.getElementById('garageFilter');
      if (manufacturerField) manufacturerField.value = '';
      if (ownerField) ownerField.value = '';
      if (garageField) garageField.value = '';
      
      // Clear dropdown filters - statusFilter is now directive
      const statusField = document.getElementById('statusFilter'); // This is actually directive now
      const claimField = document.getElementById('claimFilter');
      const invoiceField = document.getElementById('invoiceFilter');
      const paymentField = document.getElementById('paymentFilter');
      if (statusField) statusField.value = '';
      if (claimField) claimField.value = '';
      if (invoiceField) invoiceField.value = '';
      if (paymentField) paymentField.value = '';
      
      document.getElementById('trackingResults').innerHTML = `
        <div style="background: #333; padding: 15px; border-radius: 8px; border: 1px solid #555; color: #ccc; text-align: center;">
          <p>âœ… ×›×œ ×”×¡×™× ×•× ×™× × ×•×§×•</p>
          <p style="font-size: 12px; color: #999;">×‘×—×¨ ××¤×©×¨×•×™×•×ª ×¡×™× ×•×Ÿ ×—×“×©×•×ª ×›×“×™ ×œ×—×¤×©</p>
        </div>`;
    };

    // Define exportResults function globally
    window.exportResults = async function() {
      // Check if there are any results to export
      const resultsDiv = document.getElementById('trackingResults');
      if (!window.lastSearchResults || !Array.isArray(window.lastSearchResults) || window.lastSearchResults.length === 0) {
        alert('××™×Ÿ ×ª×•×¦××•×ª ×œ×™×™×¦×•× - ×× × ×‘×¦×¢ ×—×™×¤×•×© ×ª×—×™×œ×”');
        return;
      }
      
      // Show loading
      const originalButton = event.target;
      const originalText = originalButton.innerHTML;
      originalButton.innerHTML = 'â³ ××™×™×¦×...';
      originalButton.disabled = true;
      
      try {
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available');
        }
        
        // Prepare export data
        const exportData = {
          sender_id: '×¡×§×™×¨×” ×œ×¤×™ ×©×“×•×ª',
          plate: 'multiple', // Field search can include multiple plates
          query_date: new Date().toISOString(),
          export_date: new Date().toISOString(),
          export_type: 'field_search',
          data_type: '×ª×•×¦××•×ª ×—×™×¤×•×© ×©×“×•×ª',
          total_results: window.lastSearchResults.length,
          search_filters: window.lastSearchFilters || {},
          data: window.lastSearchResults
        };
        
        console.log('ğŸ”„ Exporting search results:', exportData);
        
        const response = await window.sendToWebhook('ADMIN_EXPORT_SEARCH_RESULTS', exportData);
        
        console.log('ğŸ“¤ Export response:', response);
        
        // Show success
        originalButton.innerHTML = 'âœ… ×™×•×¦× ×‘×”×¦×œ×—×”';
        setTimeout(() => {
          originalButton.innerHTML = originalText;
          originalButton.disabled = false;
        }, 2000);
        
        alert('×ª×•×¦××•×ª ×”×—×™×¤×•×© ×™×•×¦××• ×‘×”×¦×œ×—×”!');
        
      } catch (error) {
        console.error('Export error:', error);
        
        // Show error
        originalButton.innerHTML = 'âŒ ×©×’×™××”';
        setTimeout(() => {
          originalButton.innerHTML = originalText;
          originalButton.disabled = false;
        }, 2000);
        
        alert(`×©×’×™××” ×‘×™×™×¦×•×: ${error.message}`);
      }
    };

    // Define exportCaseStatus function globally
    window.exportCaseStatus = async function() {
      // Check if there are any results to export
      if (!window.lastCaseStatusResults || !window.lastCaseStatusPlate) {
        alert('××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•× - ×× × ×‘×¦×¢ ×—×™×¤×•×© ×ª×—×™×œ×”');
        return;
      }
      
      // Show export options dialog
      const exportChoice = prompt(`×‘×—×¨ ××ª ×¡×•×’ ×”× ×ª×•× ×™× ×œ×™×™×¦×•×:
1 - ×ª×"×¦ ×›×œ×œ×™
2 - ××§×¡×¤×™×¨×˜×™×–×”  
3 - ×—×•×•"×“
4 - ×›×œ ×”× ×ª×•× ×™×
      
×”×›× ×¡ ××¡×¤×¨ ×‘×—×™×¨×” (1-4):`);
      
      if (!exportChoice || !['1', '2', '3', '4'].includes(exportChoice)) {
        alert('×‘×—×™×¨×” ×œ× ×ª×§×™× ×”');
        return;
      }
      
      // Show loading
      const originalButton = event.target;
      const originalText = originalButton.innerHTML;
      originalButton.innerHTML = 'â³ ××™×™×¦×...';
      originalButton.disabled = true;
      
      try {
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available');
        }
        
        // Prepare export data based on choice
        let exportData = {
          sender_id: '×¡×˜×˜×•×¡ ×ª×™×§×™×',
          plate: window.lastCaseStatusPlate,
          query_date: new Date().toISOString(),
          export_date: new Date().toISOString(),
          export_type: exportChoice
        };
        
        const caseData = window.lastCaseStatusResults;
        
        switch(exportChoice) {
          case '1':
            exportData.data = caseData['×ª×"×¦ ×›×œ×œ×™'] || {};
            exportData.data_type = '×ª×"×¦ ×›×œ×œ×™';
            break;
          case '2':
            exportData.data = caseData['××§×¡×¤×™×¨×˜×™×–×”'] || {};
            exportData.data_type = '××§×¡×¤×™×¨×˜×™×–×”';
            break;
          case '3':
            exportData.data = caseData['×—×•×•"×“'] || {};
            exportData.data_type = '×—×•×•"×“';
            break;
          case '4':
            exportData.data = caseData;
            exportData.data_type = '×›×œ ×”× ×ª×•× ×™×';
            break;
        }
        
        console.log('ğŸ”„ Exporting case status:', exportData);
        
        const response = await window.sendToWebhook('ADMIN_EXPORT_SEARCH_RESULTS', exportData);
        
        console.log('ğŸ“¤ Export response:', response);
        
        // Show success
        originalButton.innerHTML = 'âœ… ×™×•×¦× ×‘×”×¦×œ×—×”';
        setTimeout(() => {
          originalButton.innerHTML = originalText;
          originalButton.disabled = false;
        }, 2000);
        
        alert('× ×ª×•× ×™ ×”×ª×™×§ ×™×•×¦××• ×‘×”×¦×œ×—×”!');
        
      } catch (error) {
        console.error('Export error:', error);
        
        // Show error
        originalButton.innerHTML = 'âŒ ×©×’×™××”';
        setTimeout(() => {
          originalButton.innerHTML = originalText;
          originalButton.disabled = false;
        }, 2000);
        
        alert(`×©×’×™××” ×‘×™×™×¦×•×: ${error.message}`);
      }
    };
    </script>
    
   <script type="module">
  import { sendToWebhook } from './webhook.js';
  
  // Make sendToWebhook globally available immediately
  window.sendToWebhook = sendToWebhook;
  
  // Make sure it's available before any functions try to use it
  window.webhookReady = true;
  
  // Merge with existing DOMContentLoaded event - do not create duplicate
  // The admin functionality will be added to the existing DOMContentLoaded below
  
  // Define admin helper functions here when needed
  
  // Add to existing DOMContentLoaded event from first script
  document.addEventListener('DOMContentLoaded', () => {
    // Check if user has basic authentication
    const auth = sessionStorage.getItem('auth');
    if (!auth) {
      console.log('âŒ No auth token found in admin.html, redirecting to login');
      alert('×”×’×™×©×” ×—×¡×•××” - ×× × ×”×ª×—×‘×¨ ×“×¨×š ×“×£ ×”×‘×™×ª');
      window.location.href = 'index.html';
      return;
    }
    
    // Check for admin-specific access
    const adminAccess = sessionStorage.getItem('admin-access');
    const adminTimestamp = sessionStorage.getItem('admin-timestamp');
    
    if (!adminAccess || !adminAccess.includes('granted')) {
      console.log('âŒ No admin access token found, redirecting to selection');
      alert('×’×™×©×ª ×× ×”×œ × ×“×¨×©×ª - ×× × ×××ª ××ª ×”×–×”×•×ª ×©×œ×š ×“×¨×š ×¢××•×“ ×”×‘×—×™×¨×”');
      window.location.href = 'selection.html';
      return;
    }
    
    // Check if admin session is still valid (24 hours)
    if (adminTimestamp) {
      const sessionAge = Date.now() - new Date(adminTimestamp).getTime();
      const maxAge = 24 * 60 * 60 * 1000; // 24 hours
      
      if (sessionAge > maxAge) {
        console.log('âŒ Admin session expired, redirecting to selection');
        sessionStorage.removeItem('admin-access');
        sessionStorage.removeItem('admin-timestamp');
        alert('×ª×•×§×£ ×’×™×©×ª ×”×× ×”×œ ×¤×’ - ×× × ×”×ª×—×‘×¨ ××—×“×©');
        window.location.href = 'selection.html';
        return;
      }
    }
    
    console.log('âœ… Admin access verified, loading admin panel');
    console.log('Admin access type:', adminAccess);
    
    // Load VAT from session
    const existingVat = sessionStorage.getItem('globalVAT');
    if (existingVat) {
      document.getElementById('vat-input').value = existingVat;
    }
    
    // PHASE 4 FIX: Initialize helper from sessionStorage
    try {
      const currentHelper = sessionStorage.getItem('currentHelper') || sessionStorage.getItem('helper');
      if (currentHelper) {
        window.helper = JSON.parse(currentHelper);
        console.log('âœ… Helper loaded from sessionStorage:', window.helper?.plate || 'No plate');
      } else {
        window.helper = {};
        console.log('âš ï¸ No helper found in sessionStorage, initialized empty helper');
      }
    } catch (e) {
      console.error('Error loading helper from sessionStorage:', e);
      window.helper = {};
    }
    
    // Listen for helper updates from other modules
    window.addEventListener('storage', (e) => {
      if (e.key === 'currentHelper' || e.key === 'helper') {
        try {
          const updatedHelper = JSON.parse(e.newValue);
          window.helper = updatedHelper;
          console.log('âœ… Helper updated from storage event:', window.helper?.plate);
        } catch (err) {
          console.error('Error updating helper from storage event:', err);
        }
      }
    });
  });

    // Helper functions for admin sections
    window.searchCaseStatus = async function() {
      const plate = document.getElementById('plateSearch').value.trim();
      if (!plate) {
        alert('×× × ×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘');
        return;
      }
      
      const resultsDiv = document.getElementById('caseResults');
      resultsDiv.innerHTML = `
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeaa7;">
          <h4>ğŸ” ××—×¤×© × ×ª×•× ×™× ×¢×‘×•×¨ ×¨×›×‘: ${plate}</h4>
          <p>×× × ×”××ª×Ÿ...</p>
        </div>`;
      
      try {
        // Wait for webhook to be ready with a small delay
        await new Promise(resolve => setTimeout(resolve, 100));
        
        if (!window.sendToWebhook || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available - please refresh the page');
        }
        
        const response = await window.sendToWebhook('ADMIN_FETCH_TRACKING_TABLE', {
          plate: plate,
          action: 'get_case_status'
        });
        
        console.log('Case status response:', response);
        
        if (response && Array.isArray(response) && response.length > 0) {
          const caseData = response[0];
          // Store results for export
          window.lastCaseStatusResults = caseData;
          window.lastCaseStatusPlate = plate;
          displayCaseStatus(plate, caseData);
        } else {
          resultsDiv.innerHTML = `
            <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb; color: #721c24;">
              <h4>âŒ ×œ× × ××¦××• × ×ª×•× ×™×</h4>
              <p>×œ× × ××¦××• × ×ª×•× ×™× ×¢×‘×•×¨ ×¨×›×‘ ××¡×¤×¨: ${plate}</p>
              <p>×× × ×‘×“×•×§ ××ª ××¡×¤×¨ ×”×¨×›×‘ ×•× ×¡×” ×©×•×‘</p>
            </div>`;
        }
      } catch (error) {
        console.error('Error fetching case status:', error);
        resultsDiv.innerHTML = `
          <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb; color: #721c24;">
            <h4>âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×</h4>
            <p>×©×’×™××”: ${error.message}</p>
            <p>×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨</p>
          </div>`;
      }
    };

    window.displayCaseStatus = function(plate, caseData) {
      const resultsDiv = document.getElementById('caseResults');
      
      // Extract the three categories from the response
      const generalInfo = caseData['×ª×"×¦ ×›×œ×œ×™'] || {};
      const expertise = caseData['××§×¡×¤×™×¨×˜×™×–×”'] || {};
      const opinion = caseData['×—×•×•"×“'] || {};
      
      resultsDiv.innerHTML = `
        <div style="background: #333; padding: 12px; border-radius: 8px; border: 1px solid #555; color: #e0e0e0; font-size: 13px;">
          <h4 style="margin: 0 0 8px 0; font-size: 16px; color: #ff6b35;">ğŸ“Š ×¡×˜×˜×•×¡ ×ª×™×§: ${plate}</h4>
          <div style="margin-bottom: 12px; font-size: 12px; color: #ccc;">
            <span><strong>××¡×¤×¨ ×ª×™×§:</strong> ${generalInfo['××¡×¤×¨ ×ª×™×§'] || '×œ× ×–××™×Ÿ'}</span> | 
            <span><strong>×¢×“×›×•×Ÿ:</strong> ${new Date().toLocaleDateString('he-IL')}</span>
          </div>
          
          <!-- ×ª×"×¦ ×›×œ×œ×™ Section -->
          <div style="margin-bottom: 8px;">
            <button onclick="toggleSection('general')" onmouseover="this.style.background='#4ade80'; this.style.color='#1a1a1a'" onmouseout="this.style.background='#444'; this.style.color='#4ade80'" style="width: 100%; padding: 8px; background: #444; color: #4ade80; border: 1px solid #4ade80; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.3s;">
              ğŸ“‹ ×ª×"×¦ ×›×œ×œ×™
            </button>
            <div id="general-section" style="display: none; background: #2a2a2a; padding: 10px; border-radius: 6px; margin-top: 5px; border: 1px solid #444; font-size: 12px;">
              ${formatGeneralInfo(generalInfo)}
            </div>
          </div>
          
          <!-- ××§×¡×¤×™×¨×˜×™×–×” Section -->
          <div style="margin-bottom: 8px;">
            <button onclick="toggleSection('expertise')" onmouseover="this.style.background='#fbbf24'; this.style.color='#1a1a1a'" onmouseout="this.style.background='#444'; this.style.color='#fbbf24'" style="width: 100%; padding: 8px; background: #444; color: #fbbf24; border: 1px solid #fbbf24; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.3s;">
              ğŸ”§ ××§×¡×¤×™×¨×˜×™×–×”
            </button>
            <div id="expertise-section" style="display: none; background: #2a2a2a; padding: 10px; border-radius: 6px; margin-top: 5px; border: 1px solid #444; font-size: 12px;">
              ${formatExpertiseInfo(expertise)}
            </div>
          </div>
          
          <!-- ×—×•×•"×“ Section -->
          <div style="margin-bottom: 8px;">
            <button onclick="toggleSection('opinion')" onmouseover="this.style.background='#f87171'; this.style.color='#1a1a1a'" onmouseout="this.style.background='#444'; this.style.color='#f87171'" style="width: 100%; padding: 8px; background: #444; color: #f87171; border: 1px solid #f87171; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.3s;">
              ğŸ“ ×—×•×•"×“
            </button>
            <div id="opinion-section" style="display: none; background: #2a2a2a; padding: 10px; border-radius: 6px; margin-top: 5px; border: 1px solid #444; font-size: 12px;">
              ${formatOpinionInfo(opinion)}
            </div>
          </div>
        </div>`;
    };

    window.toggleSection = function(sectionId) {
      const section = document.getElementById(sectionId + '-section');
      if (section.style.display === 'none') {
        section.style.display = 'block';
      } else {
        section.style.display = 'none';
      }
    };

    window.formatGeneralInfo = function(info) {
      return `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; color: #ccc;">
          <div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">××¡×¤×¨ ×ª×™×§:</strong> ${info['××¡×¤×¨ ×ª×™×§'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">×ª××¨×™×š ×‘×“×™×§×”:</strong> ${info['×ª××¨×™×š ×”×‘×“×™×§×”'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">×ª××¨×™×š ×—×•×•"×“:</strong> ${info['×ª××¨×™×š ×—×•×•"×“'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">××¡. ×¨×›×‘:</strong> ${info['××¡.×¨×›×‘'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">×©× ×”×™×¦×¨×Ÿ:</strong> ${info['×©× ×”×™×¦×¨×Ÿ'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">×©× ×ª ×™×™×¦×•×¨:</strong> ${info['×©× ×ª ×™×™×¦×•×¨'] || '×œ× ×–××™×Ÿ'}</div>
          </div>
          <div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">×¢×¨×š ×”×¨×›×‘:</strong> ${info['×¢×¨×š ×”×¨×›×‘'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">×‘×¢×œ ×”×¨×›×‘:</strong> ${info['×©× ×‘×¢×œ ×”×¨×›×‘'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">×˜×œ×¤×•×Ÿ:</strong> ${info['×˜×œ×¤×•×Ÿ'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">××•×¡×š:</strong> ${info['××•×¡×š'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">×˜×œ×¤×•×Ÿ ××•×¡×š:</strong> ${info['×˜×œ×¤×•×Ÿ ××•×¡×š'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">×¡×˜×˜×•×¡ ×›×œ×œ×™:</strong> ${info['×¡×˜×˜×•×¡ ×›×œ×œ×™'] || '×œ× ×–××™×Ÿ'}</div>
          </div>
        </div>
        <div style="margin-top: 8px; border-top: 1px solid #444; padding-top: 8px;">
          <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">×“×™×¨×§×˜×™×‘×”:</strong> ${info['×“×™×¨×§×˜×™×‘×”'] || '×œ× ×–××™×Ÿ'}</div>
          <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">×”×¢×¨×•×ª ×›×œ×œ×™×•×ª:</strong> ${info['×”×¢×¨×•×ª ×›×œ×œ×™×•×ª'] || '××™×Ÿ ×”×¢×¨×•×ª'}</div>
        </div>`;
    };

    window.formatExpertiseInfo = function(info) {
      return `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; color: #ccc;">
          <div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">××¡×¤×¨ ×ª×™×§:</strong> ${info['××¡×¤×¨ ×ª×™×§'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">××¡×¤×¨ ×¨×›×‘:</strong> ${info['××¡×¤×¨ ×¨×›×‘'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">××¡. ××•×§×“×™ × ×–×§:</strong> ${info['××¡ ××•×§×“×™ × ×–×§'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">××•×§×“ × ×–×§:</strong> ${info['××•×§×“ × ×–×§'] || '×œ× ×–××™×Ÿ'}</div>
          </div>
          <div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">×ª×™××•×¨:</strong> ${info['×ª×™××•×¨'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">×ª×™×§×•× ×™× ××ª×•×›× × ×™×:</strong> ${info['×ª×™×§×•× ×™× ××ª×•×›× × ×™×'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">×—×œ×§×™× ××ª×•×›× × ×™×:</strong> ${info['×—×œ×§×™× ××ª×•×›× × ×™×'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">×¢×‘×•×“×•×ª ××ª×•×›× × ×•×ª:</strong> ${info['×¢×‘×•×“×•×ª ××ª×•×›× × ×•×ª'] || '×œ× ×–××™×Ÿ'}</div>
          </div>
        </div>
        <div style="margin-top: 8px; border-top: 1px solid #444; padding-top: 8px;">
          <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">×”× ×—×™×™×”:</strong> ${info['×”× ×—×™×™×”'] || '××™×Ÿ ×”× ×—×™×•×ª'}</div>
          <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">×”×¢×¨×•×ª:</strong> ${info['×”×¢×¨×•×ª'] || '××™×Ÿ ×”×¢×¨×•×ª'}</div>
        </div>`;
    };

    window.formatOpinionInfo = function(info) {
      return `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; color: #ccc;">
          <div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">××¡×¤×¨ ×¨×›×‘:</strong> ${info['××¡×¤×¨ ×¨×›×‘'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">××¡. ××•×§×“×™ × ×–×§:</strong> ${info['××¡ ××•×§×“×™ × ×–×§'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">××•×§×“ × ×–×§:</strong> ${info['××•×§×“ × ×–×§'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">×ª×™×§×•× ×™× ×‘×¤×•×¢×œ:</strong> ${info['×ª×™×§×•× ×™× ×‘×¤×•×¢×œ'] || '×œ× ×–××™×Ÿ'}</div>
          </div>
          <div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">×¡×”"×› ×—×œ×§×™× ×‘×¤×•×¢×œ:</strong> ${info['×¡×”"×› ×—×œ×§×™× ×‘×¤×•×¢×œ'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">×¡×”"×› ×¢×‘×•×“×•×ª ×‘×¤×•×¢×œ:</strong> ${info['×¡×”"×› ×¢×‘×•×“×•×ª ×‘×¤×•×¢×œ'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">×¡×›×•× ×œ×ª×‘×™×¢×”:</strong> ${info['×¡×›×•× ×œ×ª×‘×™×¢×”'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">×™×¨×™×“×ª ×¢×¨×š:</strong> ${info['×™×¨×™×“×ª ×¢×¨×š'] || '×œ× ×–××™×Ÿ'}</div>
          </div>
        </div>
        <div style="margin-top: 8px; border-top: 1px solid #444; padding-top: 8px;">
          <div style="margin-bottom: 4px;"><strong style="color: #f87171;">×¤×™×¦×•×™ ×¡×•×¤×™:</strong> ${info['×¤×™×¦×•×™ ×¡×•×¤×™'] || '×œ× ×–××™×Ÿ'}</div>
          <div style="margin-bottom: 4px;"><strong style="color: #f87171;">×”×¢×¨×•×ª:</strong> ${info['×”×¢×¨×•×ª'] || '××™×Ÿ ×”×¢×¨×•×ª'}</div>
        </div>`;
    };

    window.filterByDate = async function() {
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;
      
      if (!dateFrom || !dateTo) {
        alert('×× × ×‘×—×¨ ×˜×•×•×— ×ª××¨×™×›×™× ××œ×');
        return;
      }
      
      const resultsDiv = document.getElementById('trackingResults');
      resultsDiv.innerHTML = `
        <div style="background: #333; padding: 12px; border-radius: 8px; border: 1px solid #555; color: #e0e0e0; text-align: center;">
          <h4 style="color: #ff6b35; margin-bottom: 8px;">ğŸ” ××—×¤×© ×ª×™×§×™× ×œ×ª×§×•×¤×”: ${dateFrom} - ${dateTo}</h4>
          <p>×× × ×”××ª×Ÿ...</p>
        </div>`;
      
      try {
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available - page still loading');
        }
        
        const response = await window.sendToWebhook('ADMIN_FETCH_FIELDS', {
          filter_type: 'date_range',
          date_from: dateFrom,
          date_to: dateTo,
          action: 'field_review'
        });
        
        displayFieldResults('×ª×™×§×™× ×œ×ª×§×•×¤×”', `${dateFrom} - ${dateTo}`, response);
      } catch (error) {
        displayFieldError('×¡×™× ×•×Ÿ ×œ×¤×™ ×ª××¨×™×š', error.message);
      }
    };

    // filterByStatus function removed - functionality consolidated into filterByDirective

    // filterByPlate removed - use main search button instead

    // Individual filter functions removed - use main search button instead

    // filterByDirective removed - use main search button instead

    // All individual filter functions removed - use main unified search button instead

    // Functions removed - they are now defined globally above

    window.performFieldFilter = async function(filterType, filterValue, displayName) {
      const resultsDiv = document.getElementById('trackingResults');
      resultsDiv.innerHTML = `
        <div style="background: #333; padding: 12px; border-radius: 8px; border: 1px solid #555; color: #e0e0e0; text-align: center;">
          <h4 style="color: #ff6b35; margin-bottom: 8px;">ğŸ” ××—×¤×©: ${displayName}</h4>
          <p>×× × ×”××ª×Ÿ...</p>
        </div>`;
      
      try {
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available - page still loading');
        }
        
        const response = await window.sendToWebhook('ADMIN_FETCH_FIELDS', {
          filter_type: filterType,
          filter_value: filterValue,
          action: 'field_review'
        });
        
        displayFieldResults(filterType, displayName, response);
      } catch (error) {
        displayFieldError(displayName, error.message);
      }
    };

    window.displayFieldResults = function(filterType, filterDesc, data) {
      const resultsDiv = document.getElementById('trackingResults');
      
      if (!data || (Array.isArray(data) && data.length === 0)) {
        resultsDiv.innerHTML = `
          <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb; color: #721c24;">
            <h4>âŒ ×œ× × ××¦××• ×ª×™×§×™×</h4>
            <p>×œ× × ××¦××• ×ª×™×§×™× ×”×ª×•×××™× ×œ×§×¨×™×˜×¨×™×•× ×™×: ${filterDesc}</p>
            <p>×× × × ×¡×” ×œ×©× ×•×ª ××ª ×”×¤×™×œ×˜×¨×™× ×•× ×¡×” ×©×•×‘</p>
          </div>`;
        return;
      }
      
      const results = Array.isArray(data) ? data : [data];
      const resultCount = results.length;
      
      let resultsHtml = `
        <div style="background: #333; padding: 12px; border-radius: 8px; border: 1px solid #555; color: #e0e0e0; font-size: 13px;">
          <h4 style="margin: 0 0 8px 0; font-size: 16px; color: #ff6b35;">ğŸ“Š ×ª×•×¦××•×ª ×—×™×¤×•×© ×©×“×•×ª</h4>
          <div style="margin-bottom: 12px; font-size: 12px; color: #ccc;">
            <span><strong>× ××¦××•:</strong> ${resultCount} ×ª×™×§×™×</span> | 
            <span><strong>×¡×•× ×Ÿ ×œ×¤×™:</strong> ${filterDesc}</span> | 
            <span><strong>×¢×“×›×•×Ÿ:</strong> ${new Date().toLocaleDateString('he-IL')}</span>
          </div>`;
      
      results.forEach((result, index) => {
        const generalInfo = result['×ª×"×¦ ×›×œ×œ×™'] || result;
        const expertise = result['××§×¡×¤×™×¨×˜×™×–×”'] || {};
        const opinion = result['×—×•×•"×“'] || {};
        
        const caseNumber = generalInfo['××¡×¤×¨ ×ª×™×§'] || `×ª×™×§-${index + 1}`;
        const plate = generalInfo['××¡.×¨×›×‘'] || generalInfo['plate'] || '×œ× ×–××™×Ÿ';
        const manufacturer = generalInfo['×©× ×”×™×¦×¨×Ÿ'] || '×œ× ×–××™×Ÿ';
        const owner = generalInfo['×©× ×‘×¢×œ ×”×¨×›×‘'] || '×œ× ×–××™×Ÿ';
        const status = generalInfo['×¡×˜×˜×•×¡ ×›×œ×œ×™'] || '×œ× ×–××™×Ÿ';
        const directive = generalInfo['×“×™×¨×§×˜×™×‘×”'] || '×œ× ×–××™×Ÿ';
        
        resultsHtml += `
          <div style="background: #2a2a2a; padding: 10px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #444;">
            <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #444;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px;">
                <div>
                  <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">××¡×¤×¨ ×ª×™×§:</strong> ${caseNumber}</div>
                  <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">××¡. ×¨×›×‘:</strong> ${plate}</div>
                  <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">×™×¦×¨×Ÿ:</strong> ${manufacturer}</div>
                </div>
                <div>
                  <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">×‘×¢×œ ×”×¨×›×‘:</strong> ${owner}</div>
                  <div style="margin-bottom: 4px;"><strong style="color: #f87171;">×¡×˜×˜×•×¡:</strong> ${status}</div>
                  <div style="margin-bottom: 4px;"><strong style="color: #f87171;">×“×™×¨×§×˜×™×‘×”:</strong> ${directive}</div>
                </div>
              </div>
            </div>
            
            <!-- Quick Action Buttons -->
            <div style="display: flex; gap: 8px; justify-content: center;">
              <button onclick="loadCaseDetailsFromResult('${plate}')" 
                      onmouseover="this.style.background='#e55a2b'" 
                      onmouseout="this.style.background='#ff6b35'"
                      style="padding: 6px 12px; background: #ff6b35; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; transition: all 0.3s;">
                ğŸ“‹ ×¤×¨×˜×™× ××œ××™×
              </button>
              <button onclick="toggleCaseDetails('case-${index}')" 
                      onmouseover="this.style.background='#4ade80'; this.style.color='#1a1a1a'" 
                      onmouseout="this.style.background='#444'; this.style.color='#4ade80'"
                      style="padding: 6px 12px; background: #444; color: #4ade80; border: 1px solid #4ade80; border-radius: 4px; font-size: 11px; cursor: pointer; transition: all 0.3s;">
                ğŸ” ×”×¦×’ ×›××Ÿ
              </button>
            </div>
            
            <!-- Expandable Details -->
            <div id="case-${index}" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #444;">
              <div style="margin-bottom: 6px;">
                <button onclick="toggleSection('general-${index}')" 
                        onmouseover="this.style.background='#4ade80'; this.style.color='#1a1a1a'" 
                        onmouseout="this.style.background='#444'; this.style.color='#4ade80'" 
                        style="width: 100%; padding: 6px; background: #444; color: #4ade80; border: 1px solid #4ade80; border-radius: 4px; font-size: 11px; cursor: pointer; transition: all 0.3s;">
                  ğŸ“‹ ×ª×"×¦ ×›×œ×œ×™
                </button>
                <div id="general-${index}-section" style="display: none; background: #1a1a1a; padding: 8px; border-radius: 4px; margin-top: 4px; border: 1px solid #444; font-size: 11px;">
                  ${formatGeneralInfo(generalInfo)}
                </div>
              </div>
              
              <div style="margin-bottom: 6px;">
                <button onclick="toggleSection('expertise-${index}')" 
                        onmouseover="this.style.background='#fbbf24'; this.style.color='#1a1a1a'" 
                        onmouseout="this.style.background='#444'; this.style.color='#fbbf24'" 
                        style="width: 100%; padding: 6px; background: #444; color: #fbbf24; border: 1px solid #fbbf24; border-radius: 4px; font-size: 11px; cursor: pointer; transition: all 0.3s;">
                  ğŸ”§ ××§×¡×¤×™×¨×˜×™×–×”
                </button>
                <div id="expertise-${index}-section" style="display: none; background: #1a1a1a; padding: 8px; border-radius: 4px; margin-top: 4px; border: 1px solid #444; font-size: 11px;">
                  ${formatExpertiseInfo(expertise)}
                </div>
              </div>
              
              <div style="margin-bottom: 6px;">
                <button onclick="toggleSection('opinion-${index}')" 
                        onmouseover="this.style.background='#f87171'; this.style.color='#1a1a1a'" 
                        onmouseout="this.style.background='#444'; this.style.color='#f87171'" 
                        style="width: 100%; padding: 6px; background: #444; color: #f87171; border: 1px solid #f87171; border-radius: 4px; font-size: 11px; cursor: pointer; transition: all 0.3s;">
                  ğŸ“ ×—×•×•"×“
                </button>
                <div id="opinion-${index}-section" style="display: none; background: #1a1a1a; padding: 8px; border-radius: 4px; margin-top: 4px; border: 1px solid #444; font-size: 11px;">
                  ${formatOpinionInfo(opinion)}
                </div>
              </div>
            </div>
          </div>`;
      });
      
      resultsHtml += `</div>`;
      resultsDiv.innerHTML = resultsHtml;
    };
    
    window.toggleCaseDetails = function(caseId) {
      const caseDiv = document.getElementById(caseId);
      if (caseDiv.style.display === 'none') {
        caseDiv.style.display = 'block';
      } else {
        caseDiv.style.display = 'none';
      }
    };

    window.displayFieldError = function(filterName, errorMessage) {
      const resultsDiv = document.getElementById('trackingResults');
      resultsDiv.innerHTML = `
        <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb; color: #721c24;">
          <h4>âŒ ×©×’×™××” ×‘×—×™×¤×•×© ×©×“×•×ª</h4>
          <p><strong>×©×’×™××”:</strong> ${errorMessage}</p>
          <p>×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨ ××• ×‘×“×•×§ ××ª ×”×§×¨×™×˜×¨×™×•× ×™×</p>
        </div>`;
    };

    window.loadCaseDetailsFromResult = function(plate) {
      // Switch to case status section and search for the plate
      loadSection('caseStatus');
      setTimeout(() => {
        document.getElementById('plateSearch').value = plate;
        searchCaseStatus();
      }, 100);
    };

    // Enhanced Reminders Management System with Modern Features
    window.remindersData = window.remindersData || [];
    window.currentServerFilters = {};
    window.dataLoadedTimestamp = null;
    
    // Show server-side filter modal
    window.showLoadRemindersModal = function() {
      const modalHtml = `
        <div id="loadRemindersModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
          <div style="background: #2a2a2a; padding: 25px; border-radius: 12px; width: 600px; max-width: 90%; border: 2px solid #ff6b35; max-height: 80vh; overflow-y: auto;">
            <h3 style="color: #ff6b35; margin-bottom: 20px; text-align: center;">ğŸ“¥ ×˜×¢×™× ×ª ×ª×–×›×•×¨×•×ª ×¢× ×¡×™× ×•×Ÿ ××ª×§×“×</h3>
            
            <div style="margin-bottom: 15px; padding: 10px; background: #333; border-radius: 6px; border: 1px solid #555;">
              <div style="color: #e0e0e0; font-size: 14px; margin-bottom: 5px;">â„¹ï¸ ×‘×—×¨ ×¤×¨××˜×¨×™ ×¡×™× ×•×Ÿ ×œ×˜×¢×™× ×ª ×ª×–×›×•×¨×•×ª ×¨×œ×•×•× ×˜×™×•×ª ×‘×œ×‘×“ ××”×©×¨×ª</div>
              <div style="color: #999; font-size: 12px;">×–×” ×™×§×˜×™×Ÿ ××ª ×–××Ÿ ×”×˜×¢×™× ×” ×•×™×¦×™×’ ×¨×§ ××ª ×”××™×“×¢ ×”×¨×œ×•×•× ×˜×™</div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">×¡×˜×˜×•×¡:</label>
                <select id="serverStatusFilter" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
                  <option value="all">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                  <option value="active">×¤×¢×™×œ</option>
                  <option value="pending">×××ª×™×Ÿ</option>
                  <option value="completed">×”×•×©×œ×</option>
                  <option value="overdue">×¤×’ ×ª×•×§×£</option>
                </select>
              </div>
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">×§×˜×’×•×¨×™×”:</label>
                <select id="serverCategoryFilter" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
                  <option value="all">×›×œ ×”×§×˜×’×•×¨×™×•×ª</option>
                  <option value="case_deadline">××•×¢×“ ×¡×’×™×¨×ª ×ª×™×§</option>
                  <option value="payment_reminder">×ª×–×›×•×¨×ª ×ª×©×œ×•×</option>
                  <option value="follow_up">××¢×§×‘</option>
                  <option value="inspection">×‘×“×™×§×”</option>
                  <option value="general">×›×œ×œ×™</option>
                </select>
              </div>
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">××¡×¤×¨ ×¨×›×‘ (××•×¤×¦×™×•× ×œ×™):</label>
              <input type="text" id="serverPlateFilter" placeholder="×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘ ×œ×¡×™× ×•×Ÿ ×ª×–×›×•×¨×•×ª ×¡×¤×¦×™×¤×™×•×ª" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
              <div style="color: #999; font-size: 12px; margin-top: 5px;">×”×©××¨ ×¨×™×§ ×›×“×™ ×œ×˜×¢×•×Ÿ ×ª×–×›×•×¨×•×ª ×©×œ ×›×œ ×”×¨×›×‘×™×</div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">××ª××¨×™×š:</label>
                <input type="date" id="serverDateFrom" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
              </div>
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">×¢×“ ×ª××¨×™×š:</label>
                <input type="date" id="serverDateTo" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
              </div>
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">××’×‘×œ×ª ×ª×•×¦××•×ª:</label>
              <select id="serverLimitFilter" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
                <option value="50">50 ×ª×–×›×•×¨×•×ª ××—×¨×•× ×•×ª</option>
                <option value="100">100 ×ª×–×›×•×¨×•×ª ××—×¨×•× ×•×ª</option>
                <option value="200">200 ×ª×–×›×•×¨×•×ª ××—×¨×•× ×•×ª</option>
                <option value="500">500 ×ª×–×›×•×¨×•×ª ××—×¨×•× ×•×ª</option>
                <option value="all">×›×œ ×”×ª×–×›×•×¨×•×ª (×œ× ××•××œ×¥)</option>
              </select>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: center;">
              <button onclick="loadRemindersWithFilters()" 
                      onmouseover="this.style.background='#e55a2b'; this.style.transform='translateY(-2px)';"
                      onmouseout="this.style.background='#ff6b35'; this.style.transform='translateY(0)';"
                      style="padding: 12px 24px; background: #ff6b35; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">
                ğŸ“¥ ×˜×¢×Ÿ ×ª×–×›×•×¨×•×ª
              </button>
              <button onclick="closeLoadRemindersModal()" 
                      onmouseover="this.style.background='#dc2626'; this.style.transform='translateY(-2px)';"
                      onmouseout="this.style.background='#991b1b'; this.style.transform='translateY(0)';"
                      style="padding: 12px 24px; background: #991b1b; color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                âŒ ×‘×™×˜×•×œ
              </button>
            </div>
          </div>
        </div>`;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Set default date range (last 30 days)
      const today = new Date();
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(today.getDate() - 30);
      
      document.getElementById('serverDateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
      document.getElementById('serverDateTo').value = today.toISOString().split('T')[0];
    };
    
    window.closeLoadRemindersModal = function() {
      const modal = document.getElementById('loadRemindersModal');
      if (modal) modal.remove();
    };
    
    // Load reminders with server-side filtering
    window.loadRemindersWithFilters = async function() {
      try {
        // Get filter values from modal
        const serverFilters = {
          status: document.getElementById('serverStatusFilter').value,
          category: document.getElementById('serverCategoryFilter').value,
          plate_number: document.getElementById('serverPlateFilter').value.trim(),
          date_from: document.getElementById('serverDateFrom').value,
          date_to: document.getElementById('serverDateTo').value,
          limit: document.getElementById('serverLimitFilter').value
        };
        
        // Close modal
        closeLoadRemindersModal();
        
        // Update data status to loading
        updateDataStatus('loading', '×˜×•×¢×Ÿ ×ª×–×›×•×¨×•×ª ×-Make.com ×¢× ×”×¤×¨××˜×¨×™× ×©× ×‘×—×¨×•...');
        
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available');
        }
        
        console.log('ğŸ”„ Loading reminders with server filters:', serverFilters);
        
        const response = await window.sendToWebhook('ADMIN_FETCH_REMINDERS', {
          action: 'fetch_reminders',
          server_filters: serverFilters,
          pagination: {
            limit: serverFilters.limit === 'all' ? null : parseInt(serverFilters.limit),
            offset: 0
          },
          timestamp: new Date().toISOString()
        });
        
        console.log('ğŸ“¥ Fetched reminders with server filters:', response);
        
        // Update local data with fetched reminders
        if (response && Array.isArray(response)) {
          window.remindersData = response;
        } else if (response && response.reminders && Array.isArray(response.reminders)) {
          window.remindersData = response.reminders;
        } else {
          console.warn('No reminders found in response');
          window.remindersData = [];
        }
        
        // Store current filters and timestamp
        window.currentServerFilters = serverFilters;
        window.dataLoadedTimestamp = new Date();
        
        // Enable local filtering controls
        enableLocalControls();
        
        // Update data status
        const filterDesc = createFilterDescription(serverFilters);
        updateDataStatus('loaded', `× ×˜×¢× ×• ${window.remindersData.length} ×ª×–×›×•×¨×•×ª (${filterDesc}) - ×¢×•×“×›×Ÿ: ${new Date().toLocaleTimeString('he-IL')}`);
        
        // Refresh display
        renderReminders();
        
        return window.remindersData;
        
      } catch (error) {
        console.error('Error loading reminders:', error);
        updateDataStatus('error', `×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×–×›×•×¨×•×ª: ${error.message}`);
        throw error;
      }
    };
    
    // Create filter description for display
    window.createFilterDescription = function(filters) {
      const parts = [];
      if (filters.status !== 'all') parts.push(`×¡×˜×˜×•×¡: ${filters.status}`);
      if (filters.category !== 'all') parts.push(`×§×˜×’×•×¨×™×”: ${filters.category}`);
      if (filters.plate_number) parts.push(`×¨×›×‘: ${filters.plate_number}`);
      if (filters.date_from || filters.date_to) {
        const dateRange = `${filters.date_from || ''} - ${filters.date_to || ''}`;
        parts.push(`×ª××¨×™×›×™×: ${dateRange}`);
      }
      if (filters.limit !== 'all') parts.push(`××•×’×‘×œ ×œ-${filters.limit}`);
      
      return parts.length > 0 ? parts.join(', ') : '×œ×œ× ×¡×™× ×•×Ÿ';
    };
    
    // Update data status display
    window.updateDataStatus = function(status, message) {
      const statusText = document.getElementById('dataStatusText');
      if (statusText) {
        statusText.textContent = message;
        
        // Update styling based on status
        const statusDisplay = document.getElementById('dataStatusDisplay');
        if (statusDisplay) {
          switch (status) {
            case 'loading':
              statusDisplay.style.borderColor = '#f59e0b';
              statusDisplay.style.backgroundColor = '#451a03';
              break;
            case 'loaded':
              statusDisplay.style.borderColor = '#16a34a';
              statusDisplay.style.backgroundColor = '#0f3424';
              break;
            case 'error':
              statusDisplay.style.borderColor = '#dc2626';
              statusDisplay.style.backgroundColor = '#450a0a';
              break;
            default:
              statusDisplay.style.borderColor = '#444';
              statusDisplay.style.backgroundColor = '#2a2a2a';
          }
        }
      }
    };
    
    // Enable local filtering controls
    window.enableLocalControls = function() {
      const localControls = document.getElementById('localFilterControls');
      const buttons = ['refreshDataBtn', 'localFilterBtn', 'toggleViewBtn', 'exportBtn', 'calendarSyncBtn'];
      const selects = ['localStatusFilter', 'localCategoryFilter'];
      
      if (localControls) {
        localControls.style.opacity = '1';
      }
      
      buttons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
          btn.disabled = false;
          btn.style.opacity = '1';
        }
      });
      
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
          select.disabled = false;
        }
      });
    };
    
    // Refresh reminders with same server filters
    window.refreshReminders = async function() {
      if (!window.currentServerFilters || Object.keys(window.currentServerFilters).length === 0) {
        alert('××™×Ÿ ×¤×¨××˜×¨×™ ×¡×™× ×•×Ÿ ×©××•×¨×™× - ×× × ×˜×¢×Ÿ ×ª×–×›×•×¨×•×ª ×ª×—×™×œ×”');
        return;
      }
      
      try {
        updateDataStatus('loading', '××¨×¢× ×Ÿ ×ª×–×›×•×¨×•×ª ×-Make.com...');
        
        const response = await window.sendToWebhook('ADMIN_FETCH_REMINDERS', {
          action: 'fetch_reminders',
          server_filters: window.currentServerFilters,
          pagination: {
            limit: window.currentServerFilters.limit === 'all' ? null : parseInt(window.currentServerFilters.limit),
            offset: 0
          },
          timestamp: new Date().toISOString()
        });
        
        // Update data
        if (response && Array.isArray(response)) {
          window.remindersData = response;
        } else if (response && response.reminders && Array.isArray(response.reminders)) {
          window.remindersData = response.reminders;
        } else {
          window.remindersData = [];
        }
        
        window.dataLoadedTimestamp = new Date();
        
        // Update status
        const filterDesc = createFilterDescription(window.currentServerFilters);
        updateDataStatus('loaded', `×¨×•×¢× ×Ÿ - ${window.remindersData.length} ×ª×–×›×•×¨×•×ª (${filterDesc}) - ×¢×•×“×›×Ÿ: ${new Date().toLocaleTimeString('he-IL')}`);
        
        // Refresh display
        renderReminders();
        
      } catch (error) {
        console.error('Error refreshing reminders:', error);
        updateDataStatus('error', `×©×’×™××” ×‘×¨×¢× ×•×Ÿ: ${error.message}`);
      }
    };
    
    // Apply local filters (client-side)
    window.applyLocalFilters = function() {
      const localStatus = document.getElementById('localStatusFilter').value;
      const localCategory = document.getElementById('localCategoryFilter').value;
      
      console.log('ğŸ” Applying local filters:', { localStatus, localCategory });
      
      // This will filter the already-loaded data
      renderReminders(localStatus, localCategory);
    };
    
    // Legacy fetch reminders function (for backward compatibility)
    window.fetchReminders = async function(statusFilter = 'all', categoryFilter = 'all') {
      console.warn('fetchReminders() is deprecated. Use loadRemindersWithFilters() instead.');
      return window.remindersData;
    };
    
    window.addReminder = function() {
      // Create modern form dialog
      const formHtml = `
        <div id="reminderFormOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;">
          <div style="background: #2a2a2a; padding: 25px; border-radius: 12px; width: 500px; max-width: 90%; border: 2px solid #ff6b35;">
            <h3 style="color: #ff6b35; margin-bottom: 20px; text-align: center;">â• ×”×•×¡×¤×ª ×ª×–×›×•×¨×ª ×—×“×©×”</h3>
            
            <div style="margin-bottom: 15px;">
              <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">×›×•×ª×¨×ª ×”×ª×–×›×•×¨×ª:</label>
              <input type="text" id="reminderTitle" placeholder="×”×›× ×¡ ×›×•×ª×¨×ª ×”×ª×–×›×•×¨×ª" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">×ª×™××•×¨:</label>
              <textarea id="reminderDescription" placeholder="×”×›× ×¡ ×ª×™××•×¨ ××¤×•×¨×˜" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0; height: 80px; resize: vertical;"></textarea>
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">××¡×¤×¨ ×¨×›×‘ (××•×¤×¦×™×•× ×œ×™):</label>
              <input type="text" id="reminderPlate" placeholder="×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘ (×× ×¨×œ×•×•× ×˜×™)" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">×ª××¨×™×š ×™×¢×“:</label>
                <input type="date" id="reminderDate" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
              </div>
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">×©×¢×”:</label>
                <input type="time" id="reminderTime" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">×§×˜×’×•×¨×™×”:</label>
                <select id="reminderCategory" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
                  <option value="case_deadline">××•×¢×“ ×¡×’×™×¨×ª ×ª×™×§</option>
                  <option value="payment_reminder">×ª×–×›×•×¨×ª ×ª×©×œ×•×</option>
                  <option value="follow_up">××¢×§×‘</option>
                  <option value="inspection">×‘×“×™×§×”</option>
                  <option value="general">×›×œ×œ×™</option>
                </select>
              </div>
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">×¢×“×™×¤×•×ª:</label>
                <select id="reminderPriority" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
                  <option value="high">×’×‘×•×”×”</option>
                  <option value="medium">×‘×™× ×•× ×™×ª</option>
                  <option value="low">× ××•×›×”</option>
                </select>
              </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: center;">
              <button onclick="saveReminder()" style="padding: 12px 24px; background: #16a34a; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">ğŸ’¾ ×©××•×¨ ×•×©×œ×—</button>
              <button onclick="closeReminderForm()" style="padding: 12px 24px; background: #991b1b; color: white; border: none; border-radius: 8px; cursor: pointer;">âŒ ×‘×™×˜×•×œ</button>
            </div>
          </div>
        </div>`;
      
      document.body.insertAdjacentHTML('beforeend', formHtml);
      
      // Set default date to tomorrow
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      document.getElementById('reminderDate').value = tomorrow.toISOString().split('T')[0];
      document.getElementById('reminderTime').value = '09:00';
    };
    
    window.closeReminderForm = function() {
      const overlay = document.getElementById('reminderFormOverlay');
      if (overlay) overlay.remove();
    };
    
    window.saveReminder = async function() {
      const title = document.getElementById('reminderTitle').value.trim();
      const description = document.getElementById('reminderDescription').value.trim();
      const plate = document.getElementById('reminderPlate').value.trim();
      const date = document.getElementById('reminderDate').value;
      const time = document.getElementById('reminderTime').value;
      const category = document.getElementById('reminderCategory').value;
      const priority = document.getElementById('reminderPriority').value;
      
      if (!title || !date) {
        alert('×× × ××œ× ×›×•×ª×¨×ª ×•×ª××¨×™×š ×œ×ª×–×›×•×¨×ª');
        return;
      }
      
      const reminderData = {
        id: Date.now(),
        title,
        description,
        plate: plate || null,
        date,
        time,
        category,
        priority,
        status: 'active',
        created: new Date().toISOString()
      };
      
      try {
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available');
        }
        
        const response = await window.sendToWebhook('ADMIN_CREATE_REMINDER', {
          action: 'create_reminder',
          reminder: reminderData,
          timestamp: new Date().toISOString()
        });
        
        console.log('Reminder created:', response);
        
        // Add to local data
        window.remindersData.push(reminderData);
        
        // Refresh display
        renderReminders();
        
        // Close form
        closeReminderForm();
        
        alert('×”×ª×–×›×•×¨×ª × ×•×¦×¨×” ×•× ×©×œ×—×” ×‘×”×¦×œ×—×”!');
        
      } catch (error) {
        console.error('Error creating reminder:', error);
        alert(`×©×’×™××” ×‘×™×¦×™×¨×ª ×”×ª×–×›×•×¨×ª: ${error.message}`);
      }
    };
    
    window.editReminder = function(id) {
      const reminder = window.remindersData.find(r => r.id === id) || {
        id: id,
        title: '×ª×–×›×•×¨×ª ×œ×¢×¨×™×›×”',
        description: '×ª×™××•×¨ ×”×ª×–×›×•×¨×ª',
        plate: null,
        date: new Date().toISOString().split('T')[0],
        time: '09:00',
        category: 'general',
        priority: 'medium',
        status: 'active'
      };
      
      const formHtml = `
        <div id="reminderFormOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;">
          <div style="background: #2a2a2a; padding: 25px; border-radius: 12px; width: 500px; max-width: 90%; border: 2px solid #f59e0b;">
            <h3 style="color: #f59e0b; margin-bottom: 20px; text-align: center;">âœï¸ ×¢×¨×™×›×ª ×ª×–×›×•×¨×ª</h3>
            
            <div style="margin-bottom: 15px;">
              <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">×›×•×ª×¨×ª ×”×ª×–×›×•×¨×ª:</label>
              <input type="text" id="reminderTitle" value="${reminder.title}" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">×ª×™××•×¨:</label>
              <textarea id="reminderDescription" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0; height: 80px; resize: vertical;">${reminder.description}</textarea>
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">××¡×¤×¨ ×¨×›×‘ (××•×¤×¦×™×•× ×œ×™):</label>
              <input type="text" id="reminderPlate" value="${reminder.plate || ''}" placeholder="×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘ (×× ×¨×œ×•×•× ×˜×™)" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">×ª××¨×™×š ×™×¢×“:</label>
                <input type="date" id="reminderDate" value="${reminder.date}" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
              </div>
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">×©×¢×”:</label>
                <input type="time" id="reminderTime" value="${reminder.time}" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">×§×˜×’×•×¨×™×”:</label>
                <select id="reminderCategory" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
                  <option value="case_deadline" ${reminder.category === 'case_deadline' ? 'selected' : ''}>××•×¢×“ ×¡×’×™×¨×ª ×ª×™×§</option>
                  <option value="payment_reminder" ${reminder.category === 'payment_reminder' ? 'selected' : ''}>×ª×–×›×•×¨×ª ×ª×©×œ×•×</option>
                  <option value="follow_up" ${reminder.category === 'follow_up' ? 'selected' : ''}>××¢×§×‘</option>
                  <option value="inspection" ${reminder.category === 'inspection' ? 'selected' : ''}>×‘×“×™×§×”</option>
                  <option value="general" ${reminder.category === 'general' ? 'selected' : ''}>×›×œ×œ×™</option>
                </select>
              </div>
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">×¢×“×™×¤×•×ª:</label>
                <select id="reminderPriority" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
                  <option value="high" ${reminder.priority === 'high' ? 'selected' : ''}>×’×‘×•×”×”</option>
                  <option value="medium" ${reminder.priority === 'medium' ? 'selected' : ''}>×‘×™× ×•× ×™×ª</option>
                  <option value="low" ${reminder.priority === 'low' ? 'selected' : ''}>× ××•×›×”</option>
                </select>
              </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: center;">
              <button onclick="updateReminder(${id})" style="padding: 12px 24px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">ğŸ’¾ ×¢×“×›×Ÿ</button>
              <button onclick="closeReminderForm()" style="padding: 12px 24px; background: #991b1b; color: white; border: none; border-radius: 8px; cursor: pointer;">âŒ ×‘×™×˜×•×œ</button>
            </div>
          </div>
        </div>`;
      
      document.body.insertAdjacentHTML('beforeend', formHtml);
    };
    
    window.updateReminder = async function(id) {
      const title = document.getElementById('reminderTitle').value.trim();
      const description = document.getElementById('reminderDescription').value.trim();
      const plate = document.getElementById('reminderPlate').value.trim();
      const date = document.getElementById('reminderDate').value;
      const time = document.getElementById('reminderTime').value;
      const category = document.getElementById('reminderCategory').value;
      const priority = document.getElementById('reminderPriority').value;
      
      if (!title || !date) {
        alert('×× × ××œ× ×›×•×ª×¨×ª ×•×ª××¨×™×š ×œ×ª×–×›×•×¨×ª');
        return;
      }
      
      const reminderData = {
        id,
        title,
        description,
        plate: plate || null,
        date,
        time,
        category,
        priority,
        status: 'active',
        updated: new Date().toISOString()
      };
      
      try {
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available');
        }
        
        const response = await window.sendToWebhook('ADMIN_CREATE_REMINDER', {
          action: 'update_reminder',
          reminder: reminderData,
          timestamp: new Date().toISOString()
        });
        
        console.log('Reminder updated:', response);
        
        // Update local data
        const index = window.remindersData.findIndex(r => r.id === id);
        if (index !== -1) {
          window.remindersData[index] = reminderData;
        }
        
        // Refresh display
        renderReminders();
        
        // Close form
        closeReminderForm();
        
        alert('×”×ª×–×›×•×¨×ª ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!');
        
      } catch (error) {
        console.error('Error updating reminder:', error);
        alert(`×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×ª×–×›×•×¨×ª: ${error.message}`);
      }
    };
    
    window.completeReminder = async function(id) {
      if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×¡××Ÿ ××ª ×”×ª×–×›×•×¨×ª ×›×”×•×©×œ××”?')) {
        return;
      }
      
      try {
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available');
        }
        
        const response = await window.sendToWebhook('ADMIN_CREATE_REMINDER', {
          action: 'complete_reminder',
          reminder_id: id,
          timestamp: new Date().toISOString()
        });
        
        console.log('Reminder completed:', response);
        
        // Update local data
        const reminder = window.remindersData.find(r => r.id === id);
        if (reminder) {
          reminder.status = 'completed';
          reminder.completed = new Date().toISOString();
        }
        
        // Refresh display
        renderReminders();
        
        alert('×”×ª×–×›×•×¨×ª ×¡×•×× ×” ×›×”×•×©×œ××”!');
        
      } catch (error) {
        console.error('Error completing reminder:', error);
        alert(`×©×’×™××” ×‘×¡×™××•×Ÿ ×”×ª×–×›×•×¨×ª: ${error.message}`);
      }
    };
    
    window.deleteReminder = async function(id) {
      if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×ª×–×›×•×¨×ª? ×¤×¢×•×œ×” ×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ.')) {
        return;
      }
      
      try {
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available');
        }
        
        const response = await window.sendToWebhook('ADMIN_CREATE_REMINDER', {
          action: 'delete_reminder',
          reminder_id: id,
          timestamp: new Date().toISOString()
        });
        
        console.log('Reminder deleted:', response);
        
        // Remove from local data
        window.remindersData = window.remindersData.filter(r => r.id !== id);
        
        // Refresh display
        renderReminders();
        
        alert('×”×ª×–×›×•×¨×ª × ××—×§×” ×‘×”×¦×œ×—×”!');
        
      } catch (error) {
        console.error('Error deleting reminder:', error);
        alert(`×©×’×™××” ×‘××—×™×§×ª ×”×ª×–×›×•×¨×ª: ${error.message}`);
      }
    };
    
    // Legacy function - redirects to local filtering
    window.filterReminders = function() {
      console.warn('filterReminders() is deprecated. Use applyLocalFilters() instead.');
      applyLocalFilters();
    };
    
    window.toggleView = function() {
      const listView = document.getElementById('remindersListView');
      const calendarView = document.getElementById('remindersCalendarView');
      const toggleText = document.getElementById('viewToggleText');
      
      if (listView.style.display === 'none') {
        listView.style.display = 'block';
        calendarView.style.display = 'none';
        toggleText.textContent = '×ª×¦×•×’×ª ×™×•××Ÿ';
      } else {
        listView.style.display = 'none';
        calendarView.style.display = 'block';
        toggleText.textContent = '×ª×¦×•×’×ª ×¨×©×™××”';
        
        // Render calendar when switching to calendar view
        setTimeout(() => {
          renderCalendar();
        }, 100);
      }
    };
    
    window.exportReminders = async function() {
      // Check if data is loaded
      if (!window.remindersData || window.remindersData.length === 0) {
        alert('××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•× - ×× × ×˜×¢×Ÿ ×ª×–×›×•×¨×•×ª ×ª×—×™×œ×”');
        return;
      }
      
      try {
        // Show loading
        const originalButton = event.target;
        const originalText = originalButton.innerHTML;
        originalButton.innerHTML = 'â³ ××™×™×¦×...';
        originalButton.disabled = true;
        
        // Get current local filters
        const localStatus = document.getElementById('localStatusFilter').value;
        const localCategory = document.getElementById('localCategoryFilter').value;
        
        // Apply local filters to data for export
        let exportData = [...window.remindersData];
        
        if (localStatus !== 'all') {
          exportData = exportData.filter(r => r.status === localStatus);
        }
        if (localCategory !== 'all') {
          exportData = exportData.filter(r => r.category === localCategory);
        }
        
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available');
        }
        
        // Create comprehensive filter description
        const serverFilterDesc = createFilterDescription(window.currentServerFilters);
        const localFilterDesc = [];
        if (localStatus !== 'all') localFilterDesc.push(`×¡×˜×˜×•×¡ ××§×•××™: ${localStatus}`);
        if (localCategory !== 'all') localFilterDesc.push(`×§×˜×’×•×¨×™×” ××§×•××™×ª: ${localCategory}`);
        
        const fullFilterDesc = [serverFilterDesc, ...localFilterDesc].join(' + ');
        
        // Prepare export data in standardized format
        const exportPayload = {
          sender_id: '×¨×©×™××ª ×ª×–×›×•×¨×•×ª',
          export_date: new Date().toISOString(),
          export_type: 'filtered_reminders',
          data_type: `×ª×–×›×•×¨×•×ª ××¡×•× × ×•×ª - ${fullFilterDesc}`,
          server_filters: window.currentServerFilters,
          local_filters: { status: localStatus, category: localCategory },
          total_reminders: exportData.length,
          data: exportData
        };
        
        console.log('ğŸ”„ Exporting reminders:', exportPayload);
        
        // Send to export webhook
        const response = await window.sendToWebhook('ADMIN_EXPORT_SEARCH_RESULTS', exportPayload);
        
        console.log('ğŸ“¤ Export response:', response);
        
        // Show success
        originalButton.innerHTML = 'âœ… ×™×•×¦× ×‘×”×¦×œ×—×”';
        setTimeout(() => {
          originalButton.innerHTML = originalText;
          originalButton.disabled = false;
        }, 2000);
        
        alert(`× ×ª×•× ×™ ×”×ª×–×›×•×¨×•×ª ×™×•×¦××• ×‘×”×¦×œ×—×”! (${exportData.length} ×ª×–×›×•×¨×•×ª)`);
        
      } catch (error) {
        console.error('Export error:', error);
        
        // Show error
        const originalButton = event.target;
        const originalText = originalButton.innerHTML;
        originalButton.innerHTML = 'âŒ ×©×’×™××”';
        setTimeout(() => {
          originalButton.innerHTML = originalText;
          originalButton.disabled = false;
        }, 2000);
        
        alert(`×©×’×™××” ×‘×™×™×¦×•×: ${error.message}`);
      }
    };
    
    window.renderReminders = function(statusFilter = 'all', categoryFilter = 'all') {
      const remindersList = document.getElementById('remindersList');
      if (!remindersList) return;
      
      let filteredData = window.remindersData;
      
      if (statusFilter !== 'all') {
        filteredData = filteredData.filter(r => r.status === statusFilter);
      }
      
      if (categoryFilter !== 'all') {
        filteredData = filteredData.filter(r => r.category === categoryFilter);
      }
      
      if (filteredData.length === 0) {
        remindersList.innerHTML = `
          <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; border: 1px solid #444; text-align: center;">
            <h3 style="color: #ff6b35;">××™×Ÿ ×ª×–×›×•×¨×•×ª ××ª××™××•×ª</h3>
            <p style="color: #ccc;">×œ× × ××¦××• ×ª×–×›×•×¨×•×ª ×”×ª×•×××•×ª ×œ×§×¨×™×˜×¨×™×•× ×™× ×©× ×‘×—×¨×•</p>
          </div>`;
        return;
      }
      
      remindersList.innerHTML = filteredData.map(reminder => {
        const statusColors = {
          active: { bg: '#16a34a', text: '×¤×¢×™×œ' },
          pending: { bg: '#f59e0b', text: '×××ª×™×Ÿ' },
          completed: { bg: '#6b7280', text: '×”×•×©×œ×' },
          overdue: { bg: '#dc2626', text: '×¤×’ ×ª×•×§×£' }
        };
        
        const categoryNames = {
          case_deadline: '××•×¢×“ ×¡×’×™×¨×ª ×ª×™×§',
          payment_reminder: '×ª×–×›×•×¨×ª ×ª×©×œ×•×',
          follow_up: '××¢×§×‘',
          inspection: '×‘×“×™×§×”',
          general: '×›×œ×œ×™'
        };
        
        const priorityNames = {
          high: '×’×‘×•×”×”',
          medium: '×‘×™× ×•× ×™×ª',
          low: '× ××•×›×”'
        };
        
        const statusInfo = statusColors[reminder.status];
        
        return `
          <div style="background: #2a2a2a; padding: 15px; border-radius: 8px; margin: 10px 0; border: 1px solid #444;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <h4 style="color: #4ade80; margin: 0; font-size: 16px;">${reminder.title}</h4>
              <span style="background: ${statusInfo.bg}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${statusInfo.text}</span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; font-size: 14px; color: #ccc;">
              <div><strong style="color: #fbbf24;">×ª××¨×™×š ×™×¢×“:</strong> ${new Date(reminder.date).toLocaleDateString('he-IL')}</div>
              <div><strong style="color: #fbbf24;">×§×˜×’×•×¨×™×”:</strong> ${categoryNames[reminder.category]}</div>
              <div><strong style="color: #fbbf24;">×¢×“×™×¤×•×ª:</strong> ${priorityNames[reminder.priority]}</div>
              <div><strong style="color: #fbbf24;">× ×•×¦×¨:</strong> ${new Date(reminder.created).toLocaleDateString('he-IL')}</div>
              ${reminder.plate ? `<div><strong style="color: #fbbf24;">××¡×¤×¨ ×¨×›×‘:</strong> ${reminder.plate}</div>` : ''}
            </div>
            <p style="color: #e0e0e0; margin: 10px 0; font-size: 14px;">${reminder.description}</p>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
              <button onclick="editReminder(${reminder.id})" 
                      onmouseover="this.style.background='#f59e0b'; this.style.transform='translateY(-1px)';"
                      onmouseout="this.style.background='#d97706'; this.style.transform='translateY(0)';"
                      style="padding: 8px 16px; background: #d97706; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 13px;">
                âœï¸ ×¢×¨×•×š
              </button>
              ${reminder.status !== 'completed' ? `
                <button onclick="completeReminder(${reminder.id})" 
                        onmouseover="this.style.background='#059669'; this.style.transform='translateY(-1px)';"
                        onmouseout="this.style.background='#16a34a'; this.style.transform='translateY(0)';"
                        style="padding: 8px 16px; background: #16a34a; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 13px;">
                  âœ… ×¡××Ÿ ×›×”×•×©×œ×
                </button>
              ` : ''}
              <button onclick="deleteReminder(${reminder.id})" 
                      onmouseover="this.style.background='#dc2626'; this.style.transform='translateY(-1px)';"
                      onmouseout="this.style.background='#991b1b'; this.style.transform='translateY(0)';"
                      style="padding: 8px 16px; background: #991b1b; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 13px;">
                ğŸ—‘ï¸ ××—×§
              </button>
            </div>
          </div>`;
      }).join('');
      
      // Update calendar if it's currently visible
      const calendarView = document.getElementById('remindersCalendarView');
      if (calendarView && calendarView.style.display !== 'none') {
        setTimeout(() => {
          renderCalendar();
        }, 100);
      }
    };

    // Calendar functionality
    window.currentCalendarDate = new Date();
    
    window.renderCalendar = function() {
      const calendarDays = document.getElementById('calendarDays');
      const calendarMonth = document.getElementById('calendarMonth');
      
      if (!calendarDays || !calendarMonth) return;
      
      const year = window.currentCalendarDate.getFullYear();
      const month = window.currentCalendarDate.getMonth();
      
      // Hebrew month names
      const monthNames = [
        '×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™',
        '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'
      ];
      
      calendarMonth.textContent = `${monthNames[month]} ${year}`;
      
      // Get first day of month and days in month
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      
      // Get the day of week for the first day (0 = Sunday, 6 = Saturday)
      // Hebrew calendar starts with Sunday, so we need to adjust
      const startingDayOfWeek = firstDay.getDay();
      
      // Clear calendar
      calendarDays.innerHTML = '';
      
      // Add empty cells for days before the first day of the month
      for (let i = 0; i < startingDayOfWeek; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.style.cssText = 'background: #1a1a1a; padding: 12px; border-radius: 4px; min-height: 40px;';
        calendarDays.appendChild(emptyDay);
      }
      
      // Add days of the month
      for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        const currentDate = new Date(year, month, day);
        const dateString = currentDate.toISOString().split('T')[0];
        
        // Check if this date has reminders
        const dayReminders = window.remindersData.filter(r => r.date === dateString);
        const hasReminders = dayReminders.length > 0;
        
        // Style based on whether it has reminders
        const dayStyle = hasReminders 
          ? 'background: #ff6b35; color: white; padding: 12px; border-radius: 4px; min-height: 40px; cursor: pointer; text-align: center; font-weight: bold; position: relative;'
          : 'background: #444; color: #e0e0e0; padding: 12px; border-radius: 4px; min-height: 40px; cursor: pointer; text-align: center; hover:background: #555;';
        
        dayElement.style.cssText = dayStyle;
        dayElement.innerHTML = `
          <div>${day}</div>
          ${hasReminders ? `<div style="position: absolute; top: 2px; right: 2px; background: #16a34a; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center;">${dayReminders.length}</div>` : ''}
        `;
        
        // Add click handler
        dayElement.onclick = () => showDateReminders(dateString, day);
        
        // Add hover effect
        dayElement.onmouseover = () => {
          if (!hasReminders) {
            dayElement.style.background = '#555';
          }
        };
        dayElement.onmouseout = () => {
          if (!hasReminders) {
            dayElement.style.background = '#444';
          }
        };
        
        calendarDays.appendChild(dayElement);
      }
    };
    
    window.previousMonth = function() {
      window.currentCalendarDate.setMonth(window.currentCalendarDate.getMonth() - 1);
      renderCalendar();
    };
    
    window.nextMonth = function() {
      window.currentCalendarDate.setMonth(window.currentCalendarDate.getMonth() + 1);
      renderCalendar();
    };
    
    window.showDateReminders = function(dateString, day) {
      const dateReminders = window.remindersData.filter(r => r.date === dateString);
      const selectedDateReminders = document.getElementById('selectedDateReminders');
      const selectedDateText = document.getElementById('selectedDateText');
      const selectedDateRemindersList = document.getElementById('selectedDateRemindersList');
      
      if (!selectedDateReminders || !selectedDateText || !selectedDateRemindersList) return;
      
      selectedDateText.textContent = `${day}/${window.currentCalendarDate.getMonth() + 1}/${window.currentCalendarDate.getFullYear()}`;
      
      if (dateReminders.length === 0) {
        selectedDateRemindersList.innerHTML = '<p style="color: #ccc; text-align: center; margin: 10px 0;">××™×Ÿ ×ª×–×›×•×¨×•×ª ×œ×™×•× ×–×”</p>';
      } else {
        selectedDateRemindersList.innerHTML = dateReminders.map(reminder => {
          const categoryNames = {
            case_deadline: '××•×¢×“ ×¡×’×™×¨×ª ×ª×™×§',
            payment_reminder: '×ª×–×›×•×¨×ª ×ª×©×œ×•×',
            follow_up: '××¢×§×‘',
            inspection: '×‘×“×™×§×”',
            general: '×›×œ×œ×™'
          };
          
          const priorityColors = {
            high: '#dc2626',
            medium: '#f59e0b',
            low: '#16a34a'
          };
          
          return `
            <div style="background: #2a2a2a; padding: 10px; border-radius: 6px; margin: 5px 0; border: 1px solid #555;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                <strong style="color: #4ade80;">${reminder.title}</strong>
                <span style="background: ${priorityColors[reminder.priority]}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">${reminder.priority}</span>
              </div>
              <div style="font-size: 12px; color: #ccc; margin-bottom: 5px;">${reminder.time || '09:00'} | ${categoryNames[reminder.category]}</div>
              <div style="color: #e0e0e0; font-size: 13px;">${reminder.description}</div>
              ${reminder.plate ? `<div style="color: #fbbf24; font-size: 12px; margin-top: 5px;">×¨×›×‘: ${reminder.plate}</div>` : ''}
            </div>
          `;
        }).join('');
      }
      
      selectedDateReminders.style.display = 'block';
    };

    window.loadFinalizedCaseForEdit = async function() {
      // Check admin authentication
      if (!verifyAdminAccess()) {
        return;
      }
      
      const plate = document.getElementById('editPlateSearch').value.trim();
      if (!plate) {
        alert('×× × ×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘');
        return;
      }
      
      // Log action for audit trail
      logAdminAction('load_finalized_case_for_edit', { plate: plate });
      
      const editResults = document.getElementById('editResults');
      editResults.innerHTML = `
        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border: 1px solid #2196f3;">
          <h4>ğŸ” ×˜×•×¢×Ÿ ×ª×™×§ ××•×©×œ×: ${plate}</h4>
          <p>××—×¤×© ×ª×™×§ ××•×©×œ× ×¢× ×“×•×— ×¡×•×¤×™...</p>
        </div>`;
      
      try {
        const response = await fetch(WEBHOOKS.ADMIN_FETCH_CASE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            plate: plate,
            action: 'load_finalized_case_for_edit',
            require_finalized: true,
            admin_session: sessionStorage.getItem('admin-access'),
            timestamp: new Date().toISOString()
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.found && data.case_data.finalized) {
          displayFinalizedCaseForEdit(data.case_data, plate);
        } else if (data.found && !data.case_data.finalized) {
          editResults.innerHTML = `
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffc107;">
              <h4>âš ï¸ ×ª×™×§ ×œ× ××•×©×œ×</h4>
              <p>×ª×™×§ ${plate} × ××¦× ××š ×¢×“×™×™×Ÿ ×œ× ×”×•×©×œ×</p>
              <p>×™×© ×œ×”×©×œ×™× ××ª ×”×ª×™×§ ×‘×–×¨×™××ª ×”×¢×‘×•×“×” ×”×¨×’×™×œ×” ×œ×¤× ×™ ×¢×¨×™×›×” ×›××Ÿ</p>
            </div>`;
        } else {
          editResults.innerHTML = `
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffc107;">
              <h4>âš ï¸ ×ª×™×§ ×œ× × ××¦×</h4>
              <p>×œ× × ××¦× ×ª×™×§ ××•×©×œ× ×¢×‘×•×¨ ××¡×¤×¨ ×¨×›×‘: ${plate}</p>
              <p>×‘×“×•×§ ×©×”××¡×¤×¨ × ×›×•×Ÿ ××• ×©×”×ª×™×§ ×”×•×©×œ×</p>
            </div>`;
        }
      } catch (error) {
        console.error('Error loading finalized case:', error);
        logAdminAction('load_finalized_case_error', { plate: plate, error: error.message });
        editResults.innerHTML = `
          <div style="background: #f8d7da; padding: 20px; border-radius: 12px; border: 2px solid #dc3545; box-shadow: 0 4px 12px rgba(220, 53, 69, 0.15);">
            <h4 style="color: #721c24; font-weight: 700; font-size: 18px; margin-bottom: 12px; text-align: center;">âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×ª×™×§</h4>
            <p style="color: #721c24; font-weight: 600; font-size: 16px; margin-bottom: 8px; text-align: center; line-height: 1.5;">××™×¨×¢×” ×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”×ª×™×§ ×”××•×©×œ×</p>
            <p style="color: #721c24; font-weight: 500; font-size: 14px; margin-bottom: 0; text-align: center; line-height: 1.4;">× ×¡×” ×©×•×‘ ××• ×¤× ×” ×œ×× ×”×œ ×”××¢×¨×›×ª</p>
          </div>`;
      }
    };

    window.displayFinalizedCaseForEdit = function(caseData, plate) {
      const editResults = document.getElementById('editResults');
      
      // Parse helper.json if it exists
      let helperData = {};
      try {
        if (caseData.helper_json) {
          helperData = typeof caseData.helper_json === 'string' ? JSON.parse(caseData.helper_json) : caseData.helper_json;
        }
      } catch (e) {
        console.error('Error parsing helper.json:', e);
      }
      
      editResults.innerHTML = `
        <div style="background: #d4edda; padding: 15px; border-radius: 8px; border: 1px solid #28a745; margin-bottom: 20px;">
          <h4>âœ… ×ª×™×§ ××•×©×œ× × ×˜×¢×Ÿ: ${plate}</h4>
          <p>×‘×¢×œ ×”×¨×›×‘: ${helperData.owner || '×œ× ××¦×•×™×Ÿ'} | ×¡×•×’ ×“×•×—: ${helperData.report_type || '×œ× ××¢×•×“×›×Ÿ'}</p>
          <p>×ª××¨×™×š ×”×©×œ××”: ${helperData.finalized_date || '×œ× ×–××™×Ÿ'}</p>
        </div>
        
        <!-- Damage Centers Section (MAIN FOCUS) -->
        <div class="collapsible-section" data-section="damage-centers">
          <div class="section-header" onclick="toggleSection('damage-centers')" style="background: #ff6b35; color: white; padding: 15px; border-radius: 8px 8px 0 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">ğŸ—ï¸ ××¨×›×–×™ × ×–×§ - ×¢×‘×•×“×•×ª, ×ª×™×§×•× ×™× ×•×—×œ×§×™×</h3>
            <span class="toggle-icon" id="damage-centers-icon">ğŸ”½</span>
          </div>
          <div class="section-content" id="damage-centers-content" style="background: white; border: 1px solid #ff6b35; border-top: none; border-radius: 0 0 8px 8px; padding: 20px;">
            <div id="damageCentersEditor">
              ${generateDamageCentersEditor(helperData.damage_centers || [])}
            </div>
            <button onclick="addNewDamageCenter('${plate}')" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; margin-top: 15px;">â• ×”×•×¡×£ ××¨×›×– × ×–×§</button>
          </div>
        </div>
        
        <!-- Levi Adjustments Section -->
        <div class="collapsible-section" data-section="levi-adjustments" style="margin-top: 15px;">
          <div class="section-header" onclick="toggleSection('levi-adjustments')" style="background: #6f42c1; color: white; padding: 15px; border-radius: 8px 8px 0 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">ğŸ“Š ×”×ª×××•×ª ×œ×•×™ - ×©×•×•×™ ×•×™×¨×™×“×ª ×¢×¨×š</h3>
            <span class="toggle-icon" id="levi-adjustments-icon">ğŸ”½</span>
          </div>
          <div class="section-content" id="levi-adjustments-content" style="background: white; border: 1px solid #6f42c1; border-top: none; border-radius: 0 0 8px 8px; padding: 20px; display: none;">
            ${generateLeviAdjustmentsEditor(helperData.levi_report || {})}
          </div>
        </div>
        
        <!-- Depreciation Section -->
        <div class="collapsible-section" data-section="depreciation" style="margin-top: 15px;">
          <div class="section-header" onclick="toggleSection('depreciation')" style="background: #dc3545; color: white; padding: 15px; border-radius: 8px 8px 0 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">ğŸ“‰ ×¤×—×ª - ×›×œ×œ×™ ×•×œ×¤×™ ××¨×›×–</h3>
            <span class="toggle-icon" id="depreciation-icon">ğŸ”½</span>
          </div>
          <div class="section-content" id="depreciation-content" style="background: white; border: 1px solid #dc3545; border-top: none; border-radius: 0 0 8px 8px; padding: 20px; display: none;">
            ${generateDepreciationEditor(helperData)}
          </div>
        </div>
        
        <!-- Case-Specific VAT Section -->
        <div class="collapsible-section" data-section="case-vat" style="margin-top: 15px;">
          <div class="section-header" onclick="toggleSection('case-vat')" style="background: #007bff; color: white; padding: 15px; border-radius: 8px 8px 0 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">ğŸ’° ××¢"× ×¡×¤×¦×™×¤×™ ×œ×ª×™×§</h3>
            <span class="toggle-icon" id="case-vat-icon">ğŸ”½</span>
          </div>
          <div class="section-content" id="case-vat-content" style="background: white; border: 1px solid #007bff; border-top: none; border-radius: 0 0 8px 8px; padding: 20px; display: none;">
            ${generateCaseVatEditor(helperData)}
          </div>
        </div>
        
        <!-- Report Type Section -->
        <div class="collapsible-section" data-section="report-type" style="margin-top: 15px;">
          <div class="section-header" onclick="toggleSection('report-type')" style="background: #17a2b8; color: white; padding: 15px; border-radius: 8px 8px 0 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">ğŸ“‹ ×¡×•×’ ×“×•×—</h3>
            <span class="toggle-icon" id="report-type-icon">ğŸ”½</span>
          </div>
          <div class="section-content" id="report-type-content" style="background: white; border: 1px solid #17a2b8; border-top: none; border-radius: 0 0 8px 8px; padding: 20px; display: none;">
            ${generateReportTypeEditor(helperData)}
          </div>
        </div>
        
        <!-- Static Data Section (Rare Cases) -->
        <div class="collapsible-section" data-section="static-data" style="margin-top: 15px;">
          <div class="section-header" onclick="toggleSection('static-data')" style="background: #6c757d; color: white; padding: 15px; border-radius: 8px 8px 0 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">ğŸ“ × ×ª×•× ×™× ×¡×˜×˜×™×™× (××§×¨×™× × ×“×™×¨×™×)</h3>
            <span class="toggle-icon" id="static-data-icon">ğŸ”½</span>
          </div>
          <div class="section-content" id="static-data-content" style="background: white; border: 1px solid #6c757d; border-top: none; border-radius: 0 0 8px 8px; padding: 20px; display: none;">
            ${generateStaticDataEditor(helperData, plate)}
          </div>
        </div>
        
        <!-- File Upload Section -->
        <div class="collapsible-section" data-section="file-upload" style="margin-top: 15px;">
          <div class="section-header" onclick="toggleSection('file-upload')" style="background: #28a745; color: white; padding: 15px; border-radius: 8px 8px 0 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">ğŸ“ ×”×¢×œ××ª helper.json</h3>
            <span class="toggle-icon" id="file-upload-icon">ğŸ”½</span>
          </div>
          <div class="section-content" id="file-upload-content" style="background: white; border: 1px solid #28a745; border-top: none; border-radius: 0 0 8px 8px; padding: 20px; display: none;">
            ${generateFileUploadEditor(plate)}
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
          <button onclick="saveAllFinalizedChanges('${plate}')" style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 4px; font-weight: bold; font-size: 16px;">ğŸ’¾ ×©××•×¨ ×›×œ ×”×©×™× ×•×™×™×</button>
          <button onclick="createFinalizedBackup('${plate}')" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px;">ğŸ“¦ ×¦×•×¨ ×’×™×‘×•×™</button>
          <button onclick="resetFinalizedCase('${plate}')" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 4px;">ğŸ”„ ××¤×¡ ×©×™× ×•×™×™×</button>
        </div>
      `;
      
      // Store original data for reset functionality
      window.originalFinalizedCaseData = caseData;
      
      // Initialize collapsed state from sessionStorage
      restoreCollapsedStates();
    };

    window.displayCaseForEdit = function(caseData, plate) {
      const editResults = document.getElementById('editResults');
      
      // Parse helper.json if it exists
      let helperData = {};
      try {
        if (caseData.helper_json) {
          helperData = typeof caseData.helper_json === 'string' ? JSON.parse(caseData.helper_json) : caseData.helper_json;
        }
      } catch (e) {
        console.error('Error parsing helper.json:', e);
      }
      
      editResults.innerHTML = `
        <div style="background: #d4edda; padding: 15px; border-radius: 8px; border: 1px solid #28a745; margin-bottom: 20px;">
          <h4>âœ… ×ª×™×§ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”: ${plate}</h4>
          <p>×‘×¢×œ ×”×¨×›×‘: ${helperData.owner || '×œ× ××¦×•×™×Ÿ'}</p>
          <p>×¡×˜×˜×•×¡: ${helperData.status || '×œ× ××¢×•×“×›×Ÿ'}</p>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
          <h3>ğŸ“ ×¢×¨×™×›×ª × ×ª×•× ×™ ×”×ª×™×§</h3>
          
          <!-- VAT Override Section -->
          <div style="border: 1px solid #007bff; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h4 style="color: #007bff; margin-top: 0;">ğŸ’° ×©×™× ×•×™ ××¢"×</h4>
            <div style="display: flex; align-items: center; gap: 10px;">
              <label for="vatOverride">××—×•×– ××¢"×:</label>
              <input type="number" id="vatOverride" value="${helperData.vat_rate || 18}" min="0" max="50" step="0.1" style="width: 80px; padding: 5px;">
              <span>%</span>
              <button onclick="applyVatOverride('${plate}')" style="padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 4px;">×”×—×œ ×©×™× ×•×™</button>
            </div>
            <small style="color: #666;">×”×©×™× ×•×™ ×™×—×•×œ ×¢×œ ×”×ª×™×§ ×”× ×•×›×—×™ ×‘×œ×‘×“</small>
          </div>
          
          <!-- File Upload Section -->
          <div style="border: 1px solid #28a745; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h4 style="color: #28a745; margin-top: 0;">ğŸ“ ×”×¢×œ××ª ×§×•×‘×¥ helper.json</h4>
            <input type="file" id="helperJsonUpload" accept=".json" style="margin-bottom: 10px;">
            <button onclick="uploadHelperJson('${plate}')" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px;">×”×¢×œ×” ×§×•×‘×¥</button>
            <small style="display: block; color: #666; margin-top: 5px;">×”×¢×œ×” ×§×•×‘×¥ helper.json ×—×“×© ×œ×©×›×ª×•×‘ × ×ª×•× ×™ ×”×ª×™×§</small>
          </div>
          
          <!-- Basic Case Data Edit -->
          <div style="border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h4 style="color: #e0a800; margin-top: 0;">âœï¸ ×¢×¨×™×›×ª × ×ª×•× ×™× ×‘×¡×™×¡×™×™×</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div>
                <label style="display: block; margin-bottom: 5px;">××¡×¤×¨ ×¨×›×‘:</label>
                <input type="text" id="editPlate" value="${helperData.plate || plate}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 5px;">×©× ×‘×¢×œ ×”×¨×›×‘:</label>
                <input type="text" id="editOwner" value="${helperData.owner || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 5px;">×ª××¨×™×š ×‘×“×™×§×”:</label>
                <input type="date" id="editDate" value="${helperData.inspection_date || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 5px;">××™×§×•×:</label>
                <input type="text" id="editLocation" value="${helperData.location || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
            </div>
          </div>
          
          <!-- Report Type Selection -->
          <div style="border: 1px solid #6f42c1; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h4 style="color: #6f42c1; margin-top: 0;">ğŸ“‹ ×¡×•×’ ×“×•×—</h4>
            <select id="reportTypeSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="private" ${helperData.report_type === 'private' ? 'selected' : ''}>×¤×¨×˜×™ (Private)</option>
              <option value="global" ${helperData.report_type === 'global' ? 'selected' : ''}>×’×œ×•×‘×œ×™ (Global Opinion)</option>
              <option value="total_loss" ${helperData.report_type === 'total_loss' ? 'selected' : ''}>××•×‘×“×Ÿ ××•×—×œ×˜ (Total Loss)</option>
              <option value="sale" ${helperData.report_type === 'sale' ? 'selected' : ''}>××›×™×¨×” ×‘××¦×‘ × ×™×–×•×§ (Sale)</option>
            </select>
          </div>
          
          <!-- Action Buttons -->
          <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
            <button onclick="saveAllChanges('${plate}')" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; font-weight: bold;">ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×</button>
            <button onclick="performIntegrityCheck('${plate}')" style="padding: 10px 20px; background: #17a2b8; color: white; border: none; border-radius: 4px;">ğŸ” ×‘×“×•×§ × ×ª×•× ×™×</button>
            <button onclick="createBackup('${plate}')" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px;">ğŸ“¦ ×¦×•×¨ ×’×™×‘×•×™</button>
            <button onclick="resetCase('${plate}')" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 4px;">ğŸ”„ ××¤×¡ ×©×™× ×•×™×™×</button>
          </div>
        </div>
      `;
      
      // Store original data for reset functionality
      window.originalCaseData = caseData;
      
      // Add real-time validation to input fields
      addValidationListeners(plate);
    };
    
    window.addValidationListeners = function(plate) {
      // VAT validation
      const vatInput = document.getElementById('vatOverride');
      if (vatInput) {
        vatInput.addEventListener('input', function() {
          validateVatInput(this);
        });
        vatInput.addEventListener('blur', function() {
          validateVatInput(this, true);
        });
      }
      
      // Plate number validation
      const plateInput = document.getElementById('editPlate');
      if (plateInput) {
        plateInput.addEventListener('blur', function() {
          validatePlateNumber(this);
        });
      }
      
      // Owner name validation
      const ownerInput = document.getElementById('editOwner');
      if (ownerInput) {
        ownerInput.addEventListener('blur', function() {
          validateOwnerName(this);
        });
      }
      
      // Date validation
      const dateInput = document.getElementById('editDate');
      if (dateInput) {
        dateInput.addEventListener('change', function() {
          validateInspectionDate(this);
        });
      }
    };
    
    window.validateVatInput = function(input, showWarnings = false) {
      const value = parseFloat(input.value);
      const warningDiv = getOrCreateWarningDiv(input, 'vat-warning');
      
      // Clear previous styling
      input.style.borderColor = '';
      warningDiv.innerHTML = '';
      
      if (isNaN(value) || value < 0 || value > 50) {
        input.style.borderColor = '#dc3545';
        warningDiv.innerHTML = '<small style="color: #dc3545;">âŒ ×¢×¨×š ××¢"× ×—×™×™×‘ ×œ×”×™×•×ª ×‘×™×Ÿ 0 ×œ-50%</small>';
        return false;
      }
      
      if (showWarnings) {
        if (value < 15 || value > 20) {
          input.style.borderColor = '#ffc107';
          warningDiv.innerHTML = '<small style="color: #e0a800;">âš ï¸ ×¢×¨×š ××¢"× ×—×¨×™×’ - ×‘×“×•×§ ×©×”×¢×¨×š × ×›×•×Ÿ</small>';
        }
        
        if (value === 0) {
          input.style.borderColor = '#ffc107';
          warningDiv.innerHTML = '<small style="color: #e0a800;">âš ï¸ ××¢"× 0% - ×•×•×“× ×©×–×” × ×›×•×Ÿ ×¢×‘×•×¨ ×ª×™×§ ×–×”</small>';
        }
      }
      
      return true;
    };
    
    window.validatePlateNumber = function(input) {
      const value = input.value.trim();
      const warningDiv = getOrCreateWarningDiv(input, 'plate-warning');
      
      // Clear previous styling
      input.style.borderColor = '';
      warningDiv.innerHTML = '';
      
      if (!value) {
        input.style.borderColor = '#dc3545';
        warningDiv.innerHTML = '<small style="color: #dc3545;">âŒ ××¡×¤×¨ ×¨×›×‘ ×”×•× ×©×“×” ×—×•×‘×”</small>';
        return false;
      }
      
      // Israeli license plate format validation (basic)
      const platePattern = /^[\d\u05d0-\u05ea]{2,3}[-]?[\d\u05d0-\u05ea]{2,3}[-]?[\d\u05d0-\u05ea]{2,3}$/;
      if (!platePattern.test(value)) {
        input.style.borderColor = '#ffc107';
        warningDiv.innerHTML = '<small style="color: #e0a800;">âš ï¸ ×¤×•×¨××˜ ××¡×¤×¨ ×¨×›×‘ ×œ× ×¡×˜× ×“×¨×˜×™</small>';
      }
      
      return true;
    };
    
    window.validateOwnerName = function(input) {
      const value = input.value.trim();
      const warningDiv = getOrCreateWarningDiv(input, 'owner-warning');
      
      // Clear previous styling
      input.style.borderColor = '';
      warningDiv.innerHTML = '';
      
      if (!value) {
        input.style.borderColor = '#dc3545';
        warningDiv.innerHTML = '<small style="color: #dc3545;">âŒ ×©× ×‘×¢×œ ×”×¨×›×‘ ×”×•× ×©×“×” ×—×•×‘×”</small>';
        return false;
      }
      
      if (value.length < 2) {
        input.style.borderColor = '#ffc107';
        warningDiv.innerHTML = '<small style="color: #e0a800;">âš ï¸ ×©× ×§×¦×¨ ××“×™ - ×‘×“×•×§ ×©×”×©× ××œ×</small>';
      }
      
      // Check for Hebrew/English mixed inappropriately
      const hasHebrew = /[\u05d0-\u05ea]/.test(value);
      const hasEnglish = /[a-zA-Z]/.test(value);
      if (hasHebrew && hasEnglish) {
        input.style.borderColor = '#ffc107';
        warningDiv.innerHTML = '<small style="color: #e0a800;">âš ï¸ ×©× ××›×™×œ ×¢×‘×¨×™×ª ×•×× ×’×œ×™×ª - ×‘×“×•×§ ×¢×§×‘×™×•×ª</small>';
      }
      
      return true;
    };
    
    window.validateInspectionDate = function(input) {
      const value = input.value;
      const warningDiv = getOrCreateWarningDiv(input, 'date-warning');
      
      // Clear previous styling
      input.style.borderColor = '';
      warningDiv.innerHTML = '';
      
      if (!value) {
        input.style.borderColor = '#ffc107';
        warningDiv.innerHTML = '<small style="color: #e0a800;">âš ï¸ ×ª××¨×™×š ×‘×“×™×§×” ×œ× ××¦×•×™×Ÿ</small>';
        return true; // Not critical
      }
      
      const inspectionDate = new Date(value);
      const today = new Date();
      const oneYearAgo = new Date();
      oneYearAgo.setFullYear(today.getFullYear() - 1);
      const oneMonthFromNow = new Date();
      oneMonthFromNow.setMonth(today.getMonth() + 1);
      
      if (inspectionDate > oneMonthFromNow) {
        input.style.borderColor = '#ffc107';
        warningDiv.innerHTML = '<small style="color: #e0a800;">âš ï¸ ×ª××¨×™×š ×‘×¢×ª×™×“ ×¨×—×•×§ - ×‘×“×•×§ ×©×”×ª××¨×™×š × ×›×•×Ÿ</small>';
      } else if (inspectionDate < oneYearAgo) {
        input.style.borderColor = '#ffc107';
        warningDiv.innerHTML = '<small style="color: #e0a800;">âš ï¸ ×ª××¨×™×š ×™×©×Ÿ ××“×™ - ×‘×“×•×§ ×©×”×ª××¨×™×š × ×›×•×Ÿ</small>';
      }
      
      return true;
    };
    
    window.getOrCreateWarningDiv = function(input, warningId) {
      let warningDiv = document.getElementById(warningId);
      if (!warningDiv) {
        warningDiv = document.createElement('div');
        warningDiv.id = warningId;
        warningDiv.style.marginTop = '2px';
        input.parentNode.appendChild(warningDiv);
      }
      return warningDiv;
    };
    
    window.performIntegrityCheck = function(plate) {
      const issues = [];
      
      // Check all validation functions
      const vatInput = document.getElementById('vatOverride');
      const plateInput = document.getElementById('editPlate');
      const ownerInput = document.getElementById('editOwner');
      const dateInput = document.getElementById('editDate');
      
      if (vatInput && !validateVatInput(vatInput, true)) {
        issues.push('×¢×¨×š ××¢"× ×œ× ×ª×§×™×Ÿ');
      }
      
      if (plateInput && !validatePlateNumber(plateInput)) {
        issues.push('××¡×¤×¨ ×¨×›×‘ ×œ× ×ª×§×™×Ÿ');
      }
      
      if (ownerInput && !validateOwnerName(ownerInput)) {
        issues.push('×©× ×‘×¢×œ ×”×¨×›×‘ ×œ× ×ª×§×™×Ÿ');
      }
      
      if (dateInput) {
        validateInspectionDate(dateInput);
      }
      
      // Display integrity check results
      if (issues.length > 0) {
        alert(`âš ï¸ ×‘×¢×™×•×ª ×‘××™×›×•×ª ×”× ×ª×•× ×™×:\n\n${issues.join('\n')}\n\n×× × ×ª×§×Ÿ ××ª ×”×‘×¢×™×•×ª ×œ×¤× ×™ ×”×©××™×¨×”.`);
        return false;
      } else {
        // Show success message only when called directly (not from saveAllChanges)
        const currentFunction = (new Error()).stack.split('\n')[2];
        if (!currentFunction.includes('saveAllChanges')) {
          alert('âœ… ×‘×“×™×§×ª × ×ª×•× ×™× ×”×•×©×œ××” ×‘×”×¦×œ×—×”!\n\n×›×œ ×”× ×ª×•× ×™× ×ª×§×™× ×™× ×•× ×™×ª×Ÿ ×œ×©××•×¨.');
        }
      }
      
      return true;
    };

    window.applyVatOverride = async function(plate) {
      // Verify admin access
      if (!verifyAdminAccess()) {
        return;
      }
      
      const vatValue = document.getElementById('vatOverride').value;
      
      if (!vatValue || isNaN(vatValue) || vatValue < 0 || vatValue > 50) {
        alert('×× × ×”×›× ×¡ ×¢×¨×š ××¢"× ×ª×§×™×Ÿ (0-50%)');
        return;
      }
      
      // Critical action confirmation
      if (!confirm(`âš ï¸ ××™×©×•×¨ ×©×™× ×•×™ ××¢"×\n\n××ª×” ×¢×•××“ ×œ×©× ×•×ª ××ª ××—×•×– ×”××¢"× ×œ-${vatValue}% ×¢×‘×•×¨ ×ª×™×§ ${plate}.\n\n×”×× ××ª×” ×‘×˜×•×—?`)) {
        return;
      }
      
      // Log action for audit trail
      logAdminAction('vat_override', { 
        plate: plate, 
        old_vat: document.getElementById('vatOverride').defaultValue || 'unknown',
        new_vat: vatValue 
      });
      
      try {
        const response = await fetch(WEBHOOKS.ADMIN_HUB, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'vat_override',
            plate: plate,
            vat_rate: parseFloat(vatValue),
            admin_session: sessionStorage.getItem('admin-access'),
            admin_timestamp: sessionStorage.getItem('admin-timestamp'),
            timestamp: new Date().toISOString()
          })
        });
        
        if (response.ok) {
          alert(`âœ… ××¢"× ×¢×•×“×›×Ÿ ×œ-${vatValue}% ×¢×‘×•×¨ ×ª×™×§ ${plate}`);
          logAdminAction('vat_override_success', { plate: plate, vat_rate: vatValue });
        } else {
          throw new Error('Failed to update VAT');
        }
      } catch (error) {
        console.error('Error applying VAT override:', error);
        logAdminAction('vat_override_error', { plate: plate, error: error.message });
        alert('âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ××¢"×');
      }
    };

    window.uploadHelperJson = async function(plate) {
      // Verify admin access
      if (!verifyAdminAccess()) {
        return;
      }
      
      const fileInput = document.getElementById('helperJsonUpload');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('×× × ×‘×—×¨ ×§×•×‘×¥ JSON');
        return;
      }
      
      if (!file.name.endsWith('.json')) {
        alert('×× × ×‘×—×¨ ×§×•×‘×¥ JSON ×‘×œ×‘×“');
        return;
      }
      
      // Critical action confirmation
      if (!confirm(`âš ï¸ ××™×©×•×¨ ×”×¢×œ××ª ×§×•×‘×¥ helper.json\n\n××ª×” ×¢×•××“ ×œ×”×—×œ×™×£ ××ª × ×ª×•× ×™ ×”×ª×™×§ ×¢× ×§×•×‘×¥: ${file.name}\n\n×¤×¢×•×œ×” ×–×• ×ª×©×›×ª×‘ ××ª ×›×œ ×”× ×ª×•× ×™× ×”×§×™×™××™×!\n\n×”×× ××ª×” ×‘×˜×•×—?`)) {
        return;
      }
      
      try {
        const fileText = await file.text();
        const jsonData = JSON.parse(fileText);
        
        // Validate basic structure
        if (!jsonData.plate && !jsonData.owner) {
          if (!confirm('×”×§×•×‘×¥ ×œ× ××›×™×œ ××¡×¤×¨ ×¨×›×‘ ××• ×‘×¢×œ ×¨×›×‘. ×œ×”××©×™×š?')) {
            return;
          }
        }
        
        // Log action for audit trail
        logAdminAction('upload_helper_json', { 
          plate: plate,
          file_name: file.name,
          file_size: file.size,
          json_keys: Object.keys(jsonData)
        });
        
        const response = await fetch(WEBHOOKS.ADMIN_HUB, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'upload_helper_json',
            plate: plate,
            helper_data: jsonData,
            admin_session: sessionStorage.getItem('admin-access'),
            admin_timestamp: sessionStorage.getItem('admin-timestamp'),
            timestamp: new Date().toISOString()
          })
        });
        
        if (response.ok) {
          alert('âœ… ×§×•×‘×¥ helper.json ×”×•×¢×œ×” ×‘×”×¦×œ×—×”');
          logAdminAction('upload_helper_json_success', { plate: plate, file_name: file.name });
          // Reload the case to show updated data
          loadCaseForEdit();
        } else {
          throw new Error('Failed to upload helper.json');
        }
      } catch (error) {
        console.error('Error uploading helper.json:', error);
        logAdminAction('upload_helper_json_error', { plate: plate, error: error.message });
        alert('âŒ ×©×’×™××” ×‘×”×¢×œ××ª ×”×§×•×‘×¥ - ×‘×“×•×§ ×©×”×§×•×‘×¥ ×ª×§×™×Ÿ');
      }
    };

    window.saveAllChanges = async function(plate) {
      // Verify admin access
      if (!verifyAdminAccess()) {
        return;
      }
      
      // Perform data integrity check
      if (!performIntegrityCheck(plate)) {
        return;
      }
      
      const changes = {
        plate: document.getElementById('editPlate').value,
        owner: document.getElementById('editOwner').value,
        inspection_date: document.getElementById('editDate').value,
        location: document.getElementById('editLocation').value,
        vat_rate: parseFloat(document.getElementById('vatOverride').value),
        report_type: document.getElementById('reportTypeSelect').value
      };
      
      if (!changes.plate || !changes.owner) {
        alert('×× × ××œ× ××ª ×”×©×“×•×ª ×”×—×•×‘×”: ××¡×¤×¨ ×¨×›×‘ ×•×©× ×‘×¢×œ ×”×¨×›×‘');
        return;
      }
      
      // Critical action confirmation
      const changesText = Object.entries(changes)
        .map(([key, value]) => `${key}: ${value}`)
        .join('\n');
      
      if (!confirm(`âš ï¸ ××™×©×•×¨ ×©××™×¨×ª ×©×™× ×•×™×™×\n\n××ª×” ×¢×•××“ ×œ×©××•×¨ ××ª ×”×©×™× ×•×™×™× ×”×‘××™×:\n\n${changesText}\n\n×”×× ××ª×” ×‘×˜×•×—?`)) {
        return;
      }
      
      // Log action for audit trail
      logAdminAction('save_all_changes', { 
        original_plate: plate,
        changes: changes
      });
      
      try {
        const response = await fetch(WEBHOOKS.ADMIN_HUB, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'save_all_changes',
            original_plate: plate,
            changes: changes,
            admin_session: sessionStorage.getItem('admin-access'),
            admin_timestamp: sessionStorage.getItem('admin-timestamp'),
            timestamp: new Date().toISOString()
          })
        });
        
        if (response.ok) {
          alert('âœ… ×›×œ ×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”');
          logAdminAction('save_all_changes_success', { plate: plate });
        } else {
          throw new Error('Failed to save changes');
        }
      } catch (error) {
        console.error('Error saving changes:', error);
        logAdminAction('save_all_changes_error', { plate: plate, error: error.message });
        alert('âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”×©×™× ×•×™×™×');
      }
    };

    window.createBackup = async function(plate) {
      try {
        const response = await fetch(WEBHOOKS.ADMIN_HUB, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'create_backup',
            plate: plate,
            timestamp: new Date().toISOString()
          })
        });
        
        if (response.ok) {
          alert('âœ… ×’×™×‘×•×™ × ×•×¦×¨ ×‘×”×¦×œ×—×”');
        } else {
          throw new Error('Failed to create backup');
        }
      } catch (error) {
        console.error('Error creating backup:', error);
        alert('âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×’×™×‘×•×™');
      }
    };

    window.resetCase = function(plate) {
      if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×‘×˜×œ ××ª ×›×œ ×”×©×™× ×•×™×™×?')) {
        return;
      }
      
      if (window.originalCaseData) {
        displayCaseForEdit(window.originalCaseData, plate);
        alert('âœ… ×”×©×™× ×•×™×™× ×‘×•×˜×œ×•');
      } else {
        alert('âŒ ×œ× × ×™×ª×Ÿ ×œ×‘×˜×œ - × ×ª×•× ×™× ××§×•×¨×™×™× ×œ× ×–××™× ×™×');
      }
    };

    // Collapsible Section Management
    window.toggleSection = function(sectionId) {
      const content = document.getElementById(sectionId + '-content');
      const icon = document.getElementById(sectionId + '-icon');
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = 'ğŸ”½';
        sessionStorage.setItem(`section-${sectionId}`, 'expanded');
      } else {
        content.style.display = 'none';
        icon.textContent = 'ğŸ”¼';
        sessionStorage.setItem(`section-${sectionId}`, 'collapsed');
      }
    };

    window.expandAllSections = function() {
      const sections = ['damage-centers', 'levi-adjustments', 'depreciation', 'case-vat', 'report-type', 'static-data', 'file-upload'];
      sections.forEach(sectionId => {
        const content = document.getElementById(sectionId + '-content');
        const icon = document.getElementById(sectionId + '-icon');
        if (content) {
          content.style.display = 'block';
          icon.textContent = 'ğŸ”½';
          sessionStorage.setItem(`section-${sectionId}`, 'expanded');
        }
      });
    };

    window.collapseAllSections = function() {
      const sections = ['damage-centers', 'levi-adjustments', 'depreciation', 'case-vat', 'report-type', 'static-data', 'file-upload'];
      sections.forEach(sectionId => {
        const content = document.getElementById(sectionId + '-content');
        const icon = document.getElementById(sectionId + '-icon');
        if (content) {
          content.style.display = 'none';
          icon.textContent = 'ğŸ”¼';
          sessionStorage.setItem(`section-${sectionId}`, 'collapsed');
        }
      });
    };

    window.restoreCollapsedStates = function() {
      const sections = ['damage-centers', 'levi-adjustments', 'depreciation', 'case-vat', 'report-type', 'static-data', 'file-upload'];
      sections.forEach(sectionId => {
        const state = sessionStorage.getItem(`section-${sectionId}`);
        const content = document.getElementById(sectionId + '-content');
        const icon = document.getElementById(sectionId + '-icon');
        
        if (content && icon) {
          if (state === 'collapsed') {
            content.style.display = 'none';
            icon.textContent = 'ğŸ”¼';
          } else {
            // Default to expanded for damage-centers (main focus), collapsed for others
            if (sectionId === 'damage-centers') {
              content.style.display = 'block';
              icon.textContent = 'ğŸ”½';
            } else {
              content.style.display = 'none';
              icon.textContent = 'ğŸ”¼';
            }
          }
        }
      });
    };

    // Content Generation Functions
    window.generateDamageCentersEditor = function(damageCenters = []) {
      if (!damageCenters.length) {
        return `
          <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
            <h4 style="color: #6c757d;">××™×Ÿ ××¨×›×–×™ × ×–×§</h4>
            <p style="color: #6c757d;">×œ×—×¥ ×¢×œ "×”×•×¡×£ ××¨×›×– × ×–×§" ×›×“×™ ×œ×”×ª×—×™×œ</p>
          </div>`;
      }
      
      return damageCenters.map((center, index) => `
        <div class="damage-center-editor" data-center-id="${center.center_id || index}" style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h4>××¨×›×– × ×–×§ ${center.center_id || index + 1}: ${center.location || '×œ× ××•×’×“×¨'}</h4>
            <button onclick="removeDamageCenter(${center.center_id || index})" style="padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px;">ğŸ—‘ï¸ ××—×§</button>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label>××™×§×•×:</label>
              <input type="text" id="center-${center.center_id || index}-location" value="${center.location || ''}" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label>×¤×—×ª (%):</label>
              <input type="number" id="center-${center.center_id || index}-depreciation" value="${center.depreciation || 0}" min="0" max="100" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label>×ª×™××•×¨:</label>
            <textarea id="center-${center.center_id || index}-description" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; height: 60px;">${center.description || ''}</textarea>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
            <div>
              <label>×ª×™×§×•× ×™×:</label>
              <textarea id="center-${center.center_id || index}-repairs" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; height: 80px;" placeholder="×¨×©×™××ª ×ª×™×§×•× ×™×...">${(center.repairs || []).map(r => `${r.name}: ${r.cost || 0}â‚ª`).join('\n')}</textarea>
            </div>
            <div>
              <label>×—×œ×§×™×:</label>
              <textarea id="center-${center.center_id || index}-parts" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; height: 80px;" placeholder="×¨×©×™××ª ×—×œ×§×™×...">${(center.parts || []).map(p => `${p.name}: ${p.source || '×œ× ××•×’×“×¨'}`).join('\n')}</textarea>
            </div>
            <div>
              <label>×¢×‘×•×“×•×ª:</label>
              <textarea id="center-${center.center_id || index}-works" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; height: 80px;" placeholder="×¨×©×™××ª ×¢×‘×•×“×•×ª...">${(center.works || []).join('\n')}</textarea>
            </div>
          </div>
        </div>
      `).join('');
    };

    window.generateLeviAdjustmentsEditor = function(leviData = {}) {
      return `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div>
            <h4>× ×ª×•× ×™× ×‘×¡×™×¡×™×™×</h4>
            <div style="margin-bottom: 15px;">
              <label>×§×•×“ ×“×’×:</label>
              <input type="text" id="levi-model-code" value="${leviData.model_code || ''}" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 15px;">
              <label>××—×™×¨ ×‘×¡×™×¡:</label>
              <input type="number" id="levi-base-price" value="${leviData.base_price || ''}" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>
          <div>
            <h4>×”×ª×××•×ª</h4>
            ${Object.entries(leviData.adjustments || {}).map(([key, adj]) => `
              <div style="margin-bottom: 10px; padding: 10px; border: 1px solid #eee; border-radius: 4px;">
                <strong>${key}:</strong>
                <div style="display: flex; gap: 10px; margin-top: 5px;">
                  <input type="number" placeholder="%" value="${adj.percent || ''}" style="width: 60px; padding: 4px;">
                  <input type="number" placeholder="×¢×¨×š" value="${adj.value || ''}" style="flex: 1; padding: 4px;">
                </div>
              </div>
            `).join('')}
          </div>
        </div>`;
    };

    window.generateDepreciationEditor = function(helperData = {}) {
      return `
        <div>
          <div style="margin-bottom: 20px;">
            <label for="global-depreciation">×¤×—×ª ×›×œ×œ×™ (%):</label>
            <input type="number" id="global-depreciation" value="${helperData.global_depreciation || 0}" min="0" max="100" step="0.1" style="width: 100px; padding: 8px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <small style="color: #666;">×¤×—×ª ×›×œ×œ×™ ×”×—×œ ×¢×œ ×›×œ ×”××§×¨×”</small>
          </div>
          <div>
            <h4>×¤×—×ª ×œ×¤×™ ××¨×›×– × ×–×§</h4>
            <p style="color: #666; margin-bottom: 15px;">×¤×—×ª ×¡×¤×¦×™×¤×™ ×œ×›×œ ××¨×›×– × ×–×§ ××•×’×“×¨ ×‘×¡×¢×™×£ ××¨×›×–×™ ×”× ×–×§ ×œ××¢×œ×”</p>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
              <strong>×¡×™×›×•× ×¤×—×ª:</strong>
              <ul style="margin: 10px 0; padding-right: 20px;">
                <li>×¤×—×ª ×›×œ×œ×™: <span id="depreciation-summary-global">${helperData.global_depreciation || 0}%</span></li>
                <li>×¤×—×ª ×××•×¦×¢ ×œ××¨×›×–: <span id="depreciation-summary-average">×—×™×©×•×‘ ××•×˜×•××˜×™</span></li>
              </ul>
            </div>
          </div>
        </div>`;
    };

    window.generateCaseVatEditor = function(helperData = {}) {
      return `
        <div>
          <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeaa7; margin-bottom: 15px;">
            <strong>×”×¢×¨×”:</strong> ×©×™× ×•×™ ×–×” ××©×¤×™×¢ ×¨×§ ×¢×œ ×”×ª×™×§ ×”× ×•×›×—×™ ×•×œ× ×¢×œ ×”××¢×¨×›×ª ×”×›×œ×œ×™×ª
          </div>
          <div style="display: flex; align-items: center; gap: 15px;">
            <label for="case-specific-vat">××¢"× ×œ×ª×™×§ ×–×” (%):</label>
            <input type="number" id="case-specific-vat" value="${helperData.vat_rate || 18}" min="0" max="30" step="0.1" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <button onclick="applyCaseVat()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px;">×”×—×œ ×©×™× ×•×™</button>
          </div>
          <small style="color: #666; display: block; margin-top: 10px;">
            ××¢"× ××¢×¨×›×ª×™ ×›×œ×œ×™: ${sessionStorage.getItem('globalVAT') || '18'}% (×œ× ××©×ª× ×”)
          </small>
        </div>`;
    };

    window.generateReportTypeEditor = function(helperData = {}) {
      return `
        <div>
          <div style="margin-bottom: 15px;">
            <label for="report-type-select">×¡×•×’ ×“×•×—:</label>
            <select id="report-type-select" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="private" ${helperData.report_type === 'private' ? 'selected' : ''}>×¤×¨×˜×™ (Private)</option>
              <option value="global" ${helperData.report_type === 'global' ? 'selected' : ''}>×’×œ×•×‘×œ×™ (Global Opinion)</option>
              <option value="total_loss" ${helperData.report_type === 'total_loss' ? 'selected' : ''}>××•×‘×“×Ÿ ××•×—×œ×˜ (Total Loss)</option>
              <option value="sale" ${helperData.report_type === 'sale' ? 'selected' : ''}>××›×™×¨×” ×‘××¦×‘ × ×™×–×•×§ (Sale)</option>
            </select>
          </div>
          <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
            <h5>×”×©×¤×¢×ª ×©×™× ×•×™ ×¡×•×’ ×“×•×—:</h5>
            <ul style="margin: 10px 0; padding-right: 20px; color: #495057;">
              <li><strong>×¤×¨×˜×™:</strong> ×“×•×— ××œ× ×¢× ×¤×™×¨×•×˜ ×¢×œ×•×™×•×ª ×œ×—×•×–×” ×¤×¨×˜×™</li>
              <li><strong>×’×œ×•×‘×œ×™:</strong> ×”×¢×¨×›×” ×›×•×œ×œ×ª ×œ×œ× ×¤×™×¨×•×˜ × ×–×§</li>
              <li><strong>××•×‘×“×Ÿ ××•×—×œ×˜:</strong> × ×–×§ ××¢×œ 60%, ×”××›×•× ×™×ª ×œ×¤×™×¨×•×§</li>
              <li><strong>××›×™×¨×” ×‘××¦×‘ × ×™×–×•×§:</strong> ×œ××›×™×¨×ª ×¨×›×‘ ×œ×œ× ×ª×™×§×•×Ÿ</li>
            </ul>
          </div>
        </div>`;
    };

    window.generateStaticDataEditor = function(helperData = {}, plate) {
      return `
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeaa7; margin-bottom: 15px;">
          <strong>âš ï¸ ××–×”×¨×”:</strong> ×©×™× ×•×™ × ×ª×•× ×™× ×¡×˜×˜×™×™× ××©×¤×™×¢ ×¢×œ ×–×”×•×ª ×”×ª×™×§. ×”×©×ª××© ×¨×§ ×‘××§×¨×™× × ×“×™×¨×™×!
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label for="static-plate">××¡×¤×¨ ×¨×›×‘:</label>
            <input type="text" id="static-plate" value="${helperData.plate || plate}" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            <small style="color: #dc3545;">×©×™× ×•×™ ××¡×¤×¨ ×¨×›×‘ ×¢×œ×•×œ ×œ×©×‘×•×¨ ×§×™×©×•×¨×™×!</small>
          </div>
          <div>
            <label for="static-owner">×©× ×‘×¢×œ ×”×¨×›×‘:</label>
            <input type="text" id="static-owner" value="${helperData.owner || ''}" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div>
            <label for="static-inspection-date">×ª××¨×™×š ×‘×“×™×§×”:</label>
            <input type="date" id="static-inspection-date" value="${helperData.inspection_date || ''}" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div>
            <label for="static-location">××™×§×•×:</label>
            <input type="text" id="static-location" value="${helperData.location || ''}" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
        </div>`;
    };

    window.generateFileUploadEditor = function(plate) {
      return `
        <div>
          <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #dc3545; margin-bottom: 15px;">
            <strong>âš ï¸ ××–×”×¨×” ×§×¨×™×˜×™×ª:</strong> ×”×¢×œ××ª helper.json ×—×“×© ×ª×—×œ×™×£ ××ª ×›×œ × ×ª×•× ×™ ×”×ª×™×§!
          </div>
          <div style="margin-bottom: 15px;">
            <label for="helper-json-upload">×‘×—×¨ ×§×•×‘×¥ helper.json:</label>
            <input type="file" id="helper-json-upload" accept=".json" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div style="display: flex; gap: 10px;">
            <button onclick="uploadHelperJsonForFinalized('${plate}')" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px;">ğŸ“ ×”×¢×œ×” ×§×•×‘×¥</button>
            <button onclick="downloadCurrentHelper('${plate}')" style="padding: 10px 20px; background: #17a2b8; color: white; border: none; border-radius: 4px;">ğŸ’¾ ×”×•×¨×“ × ×•×›×—×™</button>
          </div>
        </div>`;
    };

    window.refreshLog = function() {
      document.getElementById('logContent').innerHTML = `
        <div style="border-bottom: 1px solid #ddd; padding: 10px 0;">
          <strong>${new Date().toLocaleString('he-IL')}</strong> - ×™×•××Ÿ ×¨×•×¢× ×Ÿ ×¢×œ ×™×“×™ ×× ×”×œ
        </div>
        <div style="border-bottom: 1px solid #ddd; padding: 10px 0;">
          <strong>${new Date().toLocaleString('he-IL')}</strong> - ××©×ª××© × ×›× ×¡ ×œ××¢×¨×›×ª ×”× ×™×”×•×œ
        </div>
        <div style="border-bottom: 1px solid #ddd; padding: 10px 0;">
          <strong>${new Date(Date.now() - 3600000).toLocaleString('he-IL')}</strong> - ×¢×•×“×›×Ÿ ××¢"× ×’×œ×•×‘×œ×™ ×œ-18%
        </div>`;
    };

    window.exportLog = function() {
      alert('×™×•××Ÿ ×™×•×¦× ×œ×§×•×‘×¥ CSV - ×¤×•× ×§×¦×™×” ×ª×”×™×” ×–××™× ×” ×‘×’×¨×¡×” ×”×‘××”');
    };

    // Voice Reminder Functionality - STT Integration for Reminder Creation
    window.startVoiceReminder = function() {
      console.log('ğŸ¤ Voice reminder button clicked');
      console.log('Browser support check:', {
        webkitSpeechRecognition: 'webkitSpeechRecognition' in window,
        SpeechRecognition: 'SpeechRecognition' in window,
        userAgent: navigator.userAgent
      });
      
      // Check if speech recognition is available
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        console.error('âŒ Speech recognition not supported in this browser');
        alert('×–×™×”×•×™ ×§×•×œ ×œ× × ×ª××š ×‘×“×¤×“×¤×Ÿ ×–×”\n×× × ×”×©×ª××© ×‘×›×¨×•× ××• ××“×’\'');
        return;
      }
      
      console.log('âœ… Speech recognition supported, showing modal...');
      
      // Show voice recording modal
      const modalHtml = `
        <div id="voiceReminderModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 20px; box-sizing: border-box;">
          <div style="background: #2a2a2a; border-radius: 12px; max-width: 500px; width: 90%; border: 2px solid #7c3aed; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column;">
            <div style="padding: 30px; flex: 1; overflow-y: auto;">
            <div style="text-align: center; margin-bottom: 20px;">
              <h3 style="color: #7c3aed; margin: 0 0 10px 0;">ğŸ¤ ×™×¦×™×¨×ª ×ª×–×›×•×¨×ª ×§×•×œ×™×ª</h3>
              <p style="color: #ccc; font-size: 14px; margin: 0;">×“×‘×¨ ×‘×¢×‘×¨×™×ª - ×”××¢×¨×›×ª ×ª×–×”×” ×ª××¨×™×š, ×©×¢×” ×•××¡×¤×¨ ×¨×›×‘ ××•×˜×•××˜×™×ª</p>
            </div>
            
            <!-- Recording Status -->
            <div id="voiceReminderStatus" style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #555; text-align: center;">
              <div id="recordingIndicator" style="color: #ff6b6b; font-size: 18px; margin-bottom: 10px;">ğŸ”´ ×œ×—×¥ ×¢×œ "×”×ª×—×œ ×”×§×œ×˜×”" ×›×“×™ ×œ×”×ª×—×™×œ</div>
              <div id="speechText" style="color: #e0e0e0; font-size: 16px; min-height: 50px; font-style: italic;">×”××ª×Ÿ ×œ×˜×§×¡×˜ ×”××–×•×”×”...</div>
            </div>
            
            <!-- Voice Controls -->
            <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
              <button id="startRecordingBtn" onclick="startRecordingVoiceReminder()" 
                      style="padding: 12px 24px; background: #7c3aed; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                ğŸ¤ ×”×ª×—×œ ×”×§×œ×˜×”
              </button>
              <button id="stopRecordingBtn" onclick="stopRecordingVoiceReminder()" disabled
                      style="padding: 12px 24px; background: #dc2626; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; opacity: 0.5;">
                â¹ï¸ ×¢×¦×•×¨
              </button>
            </div>
            
            <!-- Processed Results -->
            <div id="voiceReminderResults" style="display: none; background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #444;">
              <div style="color: #4ade80; font-weight: bold; margin-bottom: 10px;">ğŸ“ ×ª×•×¦××•×ª ×–×™×”×•×™:</div>
              <div id="extractedData" style="color: #e0e0e0; font-size: 14px;"></div>
              <div style="margin-top: 15px;">
                <button onclick="confirmVoiceReminder()" 
                        style="padding: 10px 20px; background: #16a34a; color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px;">
                  âœ… ×¦×•×¨ ×ª×–×›×•×¨×ª
                </button>
                <button onclick="retryVoiceRecording()" 
                        style="padding: 10px 20px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer;">
                  ğŸ”„ × ×¡×” ×©×•×‘
                </button>
              </div>
            </div>
            
            <!-- Modal Controls -->
            <div style="display: flex; gap: 10px; justify-content: center;">
              <button onclick="closeVoiceReminderModal()" 
                      style="padding: 12px 24px; background: #991b1b; color: white; border: none; border-radius: 8px; cursor: pointer;">
                âŒ ×‘×™×˜×•×œ
              </button>
            </div>
            </div>
          </div>
        </div>`;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    };

    // Voice Recording Control Functions
    window.startRecordingVoiceReminder = function() {
      const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
      const recognition = new SpeechRecognition();
      
      // Configure recognition for Hebrew
      recognition.lang = 'he-IL';
      recognition.interimResults = true;
      recognition.maxAlternatives = 1;
      recognition.continuous = true;
      
      // Update UI for recording state
      const indicator = document.getElementById('recordingIndicator');
      const speechText = document.getElementById('speechText');
      const startBtn = document.getElementById('startRecordingBtn');
      const stopBtn = document.getElementById('stopRecordingBtn');
      
      if (indicator) indicator.textContent = 'ğŸ”´ ××§×œ×™×˜... ×“×‘×¨ ×¢×›×©×™×•';
      if (speechText) speechText.textContent = '××§×©×™×‘...';
      if (startBtn) { startBtn.disabled = true; startBtn.style.opacity = '0.5'; }
      if (stopBtn) { stopBtn.disabled = false; stopBtn.style.opacity = '1'; }
      
      // Store recognition instance for stopping
      window.currentVoiceRecognition = recognition;
      
      // Handle speech results
      recognition.addEventListener('result', (event) => {
        let finalTranscript = '';
        let interimTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript + ' ';
          } else {
            interimTranscript += transcript;
          }
        }
        
        // Update speech text display
        const displayText = finalTranscript + interimTranscript;
        if (speechText) {
          speechText.textContent = displayText || '××§×©×™×‘...';
        }
        
        // Store the transcript
        window.voiceReminderTranscript = finalTranscript.trim();
      });
      
      // Handle recognition end
      recognition.addEventListener('end', () => {
        if (indicator) indicator.textContent = 'âœ… ×”×§×œ×˜×” ×”×¡×ª×™×™××”';
        if (startBtn) { startBtn.disabled = false; startBtn.style.opacity = '1'; }
        if (stopBtn) { stopBtn.disabled = true; stopBtn.style.opacity = '0.5'; }
        
        // Process the recorded speech
        processVoiceReminderText();
      });
      
      // Handle errors
      recognition.addEventListener('error', (event) => {
        console.error('Voice recognition error:', event.error);
        if (indicator) indicator.textContent = 'âŒ ×©×’×™××” ×‘×–×™×”×•×™ ×§×•×œ: ' + event.error;
        if (startBtn) { startBtn.disabled = false; startBtn.style.opacity = '1'; }
        if (stopBtn) { stopBtn.disabled = true; stopBtn.style.opacity = '0.5'; }
      });
      
      // Start recognition
      try {
        recognition.start();
        console.log('ğŸ¤ Voice recognition started for reminder creation');
      } catch (error) {
        console.error('Failed to start voice recognition:', error);
        if (indicator) indicator.textContent = 'âŒ × ×›×©×œ ×œ×”×ª×—×™×œ ×–×™×”×•×™ ×§×•×œ';
      }
    };

    window.stopRecordingVoiceReminder = function() {
      if (window.currentVoiceRecognition) {
        window.currentVoiceRecognition.stop();
        window.currentVoiceRecognition = null;
      }
    };

    // Process voice text and extract reminder data
    window.processVoiceReminderText = function() {
      const transcript = window.voiceReminderTranscript || '';
      
      if (!transcript) {
        document.getElementById('recordingIndicator').textContent = 'âŒ ×œ× ×–×•×”×” ×˜×§×¡×˜ - × ×¡×” ×©×•×‘';
        return;
      }
      
      console.log('ğŸ” Processing voice reminder text:', transcript);
      
      // Hebrew date/time extraction patterns
      const extractedData = {
        title: '',
        description: transcript,
        date: null,
        time: null,
        plate: null,
        category: 'general',
        priority: 'medium'
      };
      
      // Extract plate number patterns (Israeli format)
      const platePatterns = [
        /(\d{7,8})/g, // 7-8 digits
        /(\d{3}[-\s]?\d{2}[-\s]?\d{3})/g, // xxx-xx-xxx format
        /×¨×›×‘\s*:?\s*(\d+)/gi, // "×¨×›×‘: 123456"
        /××¡×¤×¨\s*:?\s*(\d+)/gi, // "××¡×¤×¨: 123456"
        /×œ×•×—×™×ª\s*:?\s*(\d+)/gi // "×œ×•×—×™×ª: 123456"
      ];
      
      for (const pattern of platePatterns) {
        const match = transcript.match(pattern);
        if (match) {
          extractedData.plate = match[0].replace(/[-\s]/g, '');
          break;
        }
      }
      
      // Extract Hebrew dates and times
      const today = new Date();
      
      // Date patterns
      const datePatterns = [
        { pattern: /×”×™×•×/gi, offset: 0 },
        { pattern: /××—×¨/gi, offset: 1 },
        { pattern: /××—×¨×ª×™×™×/gi, offset: 2 },
        { pattern: /×”×©×‘×•×¢ ×”×‘×/gi, offset: 7 },
        { pattern: /×‘×¢×•×“ ×©×‘×•×¢/gi, offset: 7 },
        { pattern: /×‘×¢×•×“ (\d+) ×™××™×/gi, offset: 'dynamic' },
        { pattern: /×ª××¨×™×š ×™×¢×“[:\s]*×”×™×•×/gi, offset: 0 },
        { pattern: /×ª××¨×™×š ×™×¢×“[:\s]*××—×¨/gi, offset: 1 },
        { pattern: /×ª××¨×™×š ×™×¢×“[:\s]*××—×¨×ª×™×™×/gi, offset: 2 },
        { pattern: /×¢×“ ×”×™×•×/gi, offset: 0 },
        { pattern: /×¢×“ ××—×¨/gi, offset: 1 },
        { pattern: /×¢×“ ×ª××¨×™×š[:\s]*×”×™×•×/gi, offset: 0 },
        { pattern: /×¢×“ ×ª××¨×™×š[:\s]*××—×¨/gi, offset: 1 },
        { pattern: /×¢×“ ×ª××¨×™×š[:\s]*××—×¨×ª×™×™×/gi, offset: 2 },
        { pattern: /×ª××¨×™×š ×™×¢×“[:\s]*(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})/gi, offset: 'date' },
        { pattern: /×¢×“[:\s]*(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})/gi, offset: 'date' },
        { pattern: /×¢×“ ×ª××¨×™×š[:\s]*(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})/gi, offset: 'date' }
      ];
      
      for (const { pattern, offset } of datePatterns) {
        const match = transcript.match(pattern);
        if (match) {
          const targetDate = new Date(today);
          if (offset === 'dynamic') {
            const days = parseInt(match[1]);
            targetDate.setDate(today.getDate() + days);
          } else if (offset === 'date') {
            // Handle DD/MM/YYYY format
            const day = parseInt(match[1]);
            const month = parseInt(match[2]) - 1; // Month is 0-indexed
            const year = parseInt(match[3]);
            targetDate.setFullYear(year, month, day);
          } else {
            targetDate.setDate(today.getDate() + offset);
          }
          extractedData.date = targetDate.toISOString().split('T')[0];
          break;
        }
      }
      
      // Time patterns
      const timePatterns = [
        /(\d{1,2}):(\d{2})/g, // HH:MM format
        /(\d{1,2}) ×•(\d{2})/g, // Hebrew "X ×•Y" format  
        /×‘×©×¢×”\s*(\d{1,2})/gi, // "×‘×©×¢×” X"
        /×‘(\d{1,2})/gi // "×‘X" (at X o'clock)
      ];
      
      for (const pattern of timePatterns) {
        const match = transcript.match(pattern);
        if (match) {
          let hour = parseInt(match[1]);
          let minute = match[2] ? parseInt(match[2]) : 0;
          
          // Handle PM/AM context in Hebrew
          if (transcript.includes('××—×”"×¦') || transcript.includes('××—×¨×™ ×”×¦×”×¨×™×™×') || transcript.includes('×‘×¢×¨×‘')) {
            if (hour < 12) hour += 12;
          }
          
          extractedData.time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
          break;
        }
      }
      
      // Set default date/time if not found
      if (!extractedData.date) {
        extractedData.date = today.toISOString().split('T')[0];
      }
      if (!extractedData.time) {
        extractedData.time = '09:00';
      }
      
      // Generate title from description (first 50 chars)
      extractedData.title = transcript.substring(0, 50) + (transcript.length > 50 ? '...' : '');
      
      // Determine category based on keywords
      const categoryKeywords = {
        payment_reminder: ['×ª×©×œ×•×', '×—×™×•×‘', '×›×¡×£', '×—×©×‘×•×Ÿ'],
        case_deadline: ['×ª×™×§', '×¡×’×™×¨×”', '×“×“×œ×™×™×Ÿ', '××•×¢×“'],
        follow_up: ['××¢×§×‘', '×‘×“×™×§×”', '×¢×“×›×•×Ÿ', '×˜×œ×¤×•×Ÿ'],
        inspection: ['×‘×“×™×§×”', '×‘×™×§×•×¨×ª', '××§×¡×¤×¨×˜×™×–×”']
      };
      
      for (const [category, keywords] of Object.entries(categoryKeywords)) {
        if (keywords.some(keyword => transcript.includes(keyword))) {
          extractedData.category = category;
          break;
        }
      }
      
      // Determine priority based on keywords
      if (transcript.includes('×“×—×•×£') || transcript.includes('×—×©×•×‘') || transcript.includes('××™×™×“×™')) {
        extractedData.priority = 'high';
      } else if (transcript.includes('×¨×’×™×œ') || transcript.includes('× ××•×š')) {
        extractedData.priority = 'low';
      }
      
      // Store extracted data globally
      window.extractedVoiceReminderData = extractedData;
      
      // Display results
      displayVoiceReminderResults(extractedData);
    };

    // Display extracted data for user confirmation
    window.displayVoiceReminderResults = function(data) {
      const resultsDiv = document.getElementById('voiceReminderResults');
      const extractedDataDiv = document.getElementById('extractedData');
      
      if (!resultsDiv || !extractedDataDiv) return;
      
      const categoryNames = {
        case_deadline: '××•×¢×“ ×¡×’×™×¨×ª ×ª×™×§',
        payment_reminder: '×ª×–×›×•×¨×ª ×ª×©×œ×•×', 
        follow_up: '××¢×§×‘',
        inspection: '×‘×“×™×§×”',
        general: '×›×œ×œ×™'
      };
      
      const priorityNames = {
        high: '×’×‘×•×”×”',
        medium: '×‘×™× ×•× ×™×ª',
        low: '× ××•×›×”'
      };
      
      extractedDataDiv.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
          <div>
            <label style="color: #fbbf24; font-weight: bold; display: block; margin-bottom: 5px;">×›×•×ª×¨×ª:</label>
            <input type="text" id="editVoiceTitle" value="${data.title}" style="width: 100%; padding: 8px; border: 1px solid #555; border-radius: 4px; background: #444; color: #e0e0e0;">
          </div>
          <div>
            <label style="color: #fbbf24; font-weight: bold; display: block; margin-bottom: 5px;">×ª××¨×™×š ×™×¦×™×¨×”:</label>
            <input type="date" id="editVoiceCreated" value="${new Date().toISOString().split('T')[0]}" readonly style="width: 100%; padding: 8px; border: 1px solid #555; border-radius: 4px; background: #333; color: #999; cursor: not-allowed;">
          </div>
          <div>
            <label style="color: #fbbf24; font-weight: bold; display: block; margin-bottom: 5px;">ğŸ“… ×ª××¨×™×š ×™×¢×“:</label>
            <input type="date" id="editVoiceDueDate" value="${data.date}" style="width: 100%; padding: 8px; border: 1px solid #555; border-radius: 4px; background: #444; color: #e0e0e0;">
          </div>
          <div>
            <label style="color: #fbbf24; font-weight: bold; display: block; margin-bottom: 5px;">â° ×©×¢×ª ×™×¢×“:</label>
            <input type="time" id="editVoiceDueTime" value="${data.time}" style="width: 100%; padding: 8px; border: 1px solid #555; border-radius: 4px; background: #444; color: #e0e0e0;">
          </div>
          <div>
            <label style="color: #fbbf24; font-weight: bold; display: block; margin-bottom: 5px;">×§×˜×’×•×¨×™×”:</label>
            <select id="editVoiceCategory" style="width: 100%; padding: 8px; border: 1px solid #555; border-radius: 4px; background: #444; color: #e0e0e0;">
              <option value="general" ${data.category === 'general' ? 'selected' : ''}>×›×œ×œ×™</option>
              <option value="case_deadline" ${data.category === 'case_deadline' ? 'selected' : ''}>××•×¢×“ ×¡×’×™×¨×ª ×ª×™×§</option>
              <option value="payment_reminder" ${data.category === 'payment_reminder' ? 'selected' : ''}>×ª×–×›×•×¨×ª ×ª×©×œ×•×</option>
              <option value="follow_up" ${data.category === 'follow_up' ? 'selected' : ''}>××¢×§×‘</option>
              <option value="inspection" ${data.category === 'inspection' ? 'selected' : ''}>×‘×“×™×§×”</option>
            </select>
          </div>
          <div>
            <label style="color: #fbbf24; font-weight: bold; display: block; margin-bottom: 5px;">×¢×“×™×¤×•×ª:</label>
            <select id="editVoicePriority" style="width: 100%; padding: 8px; border: 1px solid #555; border-radius: 4px; background: #444; color: #e0e0e0;">
              <option value="low" ${data.priority === 'low' ? 'selected' : ''}>× ××•×›×”</option>
              <option value="medium" ${data.priority === 'medium' ? 'selected' : ''}>×‘×™× ×•× ×™×ª</option>
              <option value="high" ${data.priority === 'high' ? 'selected' : ''}>×’×‘×•×”×”</option>
            </select>
          </div>
          <div>
            <label style="color: #fbbf24; font-weight: bold; display: block; margin-bottom: 5px;">×¨×›×‘:</label>
            <input type="text" id="editVoicePlate" value="${data.plate || ''}" placeholder="××¡×¤×¨ ×¨×›×‘" style="width: 100%; padding: 8px; border: 1px solid #555; border-radius: 4px; background: #444; color: #e0e0e0;">
          </div>
        </div>
        <div style="margin-bottom: 15px;">
          <label style="color: #fbbf24; font-weight: bold; display: block; margin-bottom: 5px;">×ª×™××•×¨ ××œ×:</label>
          <textarea id="editVoiceDescription" rows="3" style="width: 100%; padding: 8px; border: 1px solid #555; border-radius: 4px; background: #444; color: #e0e0e0; resize: vertical;">${data.description}</textarea>
        </div>
        <div style="background: #1a1a1a; padding: 10px; border-radius: 4px; margin-bottom: 15px; border: 1px solid #555;">
          <strong style="color: #4ade80;">ğŸ¤ ×˜×§×¡×˜ ××§×•×¨×™ ××”×§×•×œ:</strong>
          <div style="margin-top: 5px; color: #ccc; font-style: italic; font-size: 13px;">"${data.description}"</div>
        </div>
      `;
      
      resultsDiv.style.display = 'block';
    };

    // Confirm and create the voice reminder
    window.confirmVoiceReminder = async function() {
      const originalData = window.extractedVoiceReminderData;
      if (!originalData) {
        alert('××™×Ÿ × ×ª×•× ×™× ×œ×™×¦×™×¨×ª ×ª×–×›×•×¨×ª');
        return;
      }
      
      // Get edited values from the form
      const editedData = {
        title: document.getElementById('editVoiceTitle')?.value?.trim() || originalData.title,
        description: document.getElementById('editVoiceDescription')?.value?.trim() || originalData.description,
        plate: document.getElementById('editVoicePlate')?.value?.trim() || originalData.plate || null,
        date: document.getElementById('editVoiceDueDate')?.value || originalData.date,
        time: document.getElementById('editVoiceDueTime')?.value || originalData.time,
        category: document.getElementById('editVoiceCategory')?.value || originalData.category,
        priority: document.getElementById('editVoicePriority')?.value || originalData.priority,
        createdDate: document.getElementById('editVoiceCreatedDate')?.value || new Date().toISOString().split('T')[0]
      };
      
      // Validate required fields
      if (!editedData.title || !editedData.date) {
        alert('×× × ××œ× ×›×•×ª×¨×ª ×•×ª××¨×™×š ×œ×ª×–×›×•×¨×ª');
        return;
      }
      
      try {
        console.log('ğŸ”„ Starting voice reminder creation process...');
        console.log('Original data:', originalData);
        console.log('Edited data:', editedData);
        console.log('Webhook ready:', window.webhookReady);
        console.log('sendToWebhook available:', typeof window.sendToWebhook);
        
        // Wait for webhook to be ready with better timing handling
        if (!window.webhookReady) {
          console.log('â³ Webhook not ready, waiting for initialization...');
          // Wait a bit for webhook to initialize
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          console.error('âŒ Webhook system not available');
          console.log('Available functions:', Object.keys(window).filter(k => k.includes('webhook')));
          throw new Error('××¢×¨×›×ª ×”×§×™×©×•×¨ ×œ×©×¨×ª ×œ× ×–××™× ×” - × ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£');
        }
        
        console.log('ğŸ”„ Creating voice reminder with edited data:', editedData);
        
        // Use the same data structure as regular reminder creation
        const reminderData = {
          id: Date.now(),
          title: editedData.title,
          description: editedData.description,
          plate: editedData.plate,
          date: editedData.date,
          time: editedData.time,
          category: editedData.category,
          priority: editedData.priority,
          status: 'active',
          created: new Date().toISOString(),
          created_date: editedData.createdDate,
          due_date: editedData.date,
          due_time: editedData.time,
          created_via: 'voice_stt',
          voice_transcript: window.voiceReminderTranscript || ''
        };
        
        console.log('ğŸ“¤ Sending voice reminder payload:', reminderData);
        
        const response = await window.sendToWebhook('ADMIN_CREATE_REMINDER', {
          action: 'create_reminder',
          reminder: reminderData,
          timestamp: new Date().toISOString()
        });
        
        console.log('âœ… Voice reminder created successfully:', response);
        
        // Add to local data if available
        if (window.remindersData && Array.isArray(window.remindersData)) {
          window.remindersData.push(reminderData);
          console.log('ğŸ”„ Refreshing reminders display...');
          renderReminders();
        } else {
          console.log('â„¹ï¸ No reminders data loaded, skipping refresh');
        }
        
        // Close modal and show success
        closeVoiceReminderModal();
        alert('âœ… ×ª×–×›×•×¨×ª ×§×•×œ×™×ª × ×•×¦×¨×” ×‘×”×¦×œ×—×”!');
        
      } catch (error) {
        console.error('âŒ Failed to create voice reminder:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          webhookReady: window.webhookReady,
          sendToWebhookType: typeof window.sendToWebhook
        });
        alert(`âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×ª×–×›×•×¨×ª: ${error.message}`);
      }
    };

    // Retry voice recording
    window.retryVoiceRecording = function() {
      // Hide results and reset
      const resultsDiv = document.getElementById('voiceReminderResults');
      const speechText = document.getElementById('speechText');
      const indicator = document.getElementById('recordingIndicator');
      
      if (resultsDiv) resultsDiv.style.display = 'none';
      if (speechText) speechText.textContent = '×”××ª×Ÿ ×œ×˜×§×¡×˜ ×”××–×•×”×”...';
      if (indicator) indicator.textContent = 'ğŸ”´ ×œ×—×¥ ×¢×œ "×”×ª×—×œ ×”×§×œ×˜×”" ×›×“×™ ×œ×”×ª×—×™×œ';
      
      // Clear stored data
      window.voiceReminderTranscript = '';
      window.extractedVoiceReminderData = null;
    };

    // Close voice reminder modal
    window.closeVoiceReminderModal = function() {
      // Stop any ongoing recording
      if (window.currentVoiceRecognition) {
        window.currentVoiceRecognition.stop();
        window.currentVoiceRecognition = null;
      }
      
      // Remove modal
      const modal = document.getElementById('voiceReminderModal');
      if (modal) modal.remove();
      
      // Clear stored data
      window.voiceReminderTranscript = '';
      window.extractedVoiceReminderData = null;
    };

  
  // Add to existing DOMContentLoaded event from first script
  document.addEventListener('DOMContentLoaded', () => {
    // Check if user has basic authentication
    const auth = sessionStorage.getItem('auth');
    if (!auth) {
      console.log('âŒ No auth token found in admin.html, redirecting to login');
      alert('×”×’×™×©×” ×—×¡×•××” - ×× × ×”×ª×—×‘×¨ ×“×¨×š ×“×£ ×”×‘×™×ª');
      window.location.href = 'index.html';
      return;
    }
    
    // Check for admin-specific access
    const adminAccess = sessionStorage.getItem('admin-access');
    const adminTimestamp = sessionStorage.getItem('admin-timestamp');
    
    if (!adminAccess || !adminAccess.includes('granted')) {
      console.log('âŒ No admin access token found, redirecting to selection');
      alert('×’×™×©×ª ×× ×”×œ × ×“×¨×©×ª - ×× × ×××ª ××ª ×”×–×”×•×ª ×©×œ×š ×“×¨×š ×¢××•×“ ×”×‘×—×™×¨×”');
      window.location.href = 'selection.html';
      return;
    }
    
    // Check if admin session is still valid (24 hours)
    if (adminTimestamp) {
      const sessionAge = Date.now() - new Date(adminTimestamp).getTime();
      const maxAge = 24 * 60 * 60 * 1000; // 24 hours
      
      if (sessionAge > maxAge) {
        console.log('âŒ Admin session expired, redirecting to selection');
        sessionStorage.removeItem('admin-access');
        sessionStorage.removeItem('admin-timestamp');
        alert('×ª×•×§×£ ×’×™×©×ª ×”×× ×”×œ ×¤×’ - ×× × ×”×ª×—×‘×¨ ××—×“×©');
        window.location.href = 'selection.html';
        return;
      }
    }
    
    console.log('âœ… Admin access verified, loading admin panel');
    console.log('Admin access type:', adminAccess);
    
    // Load VAT from session
    const existingVat = sessionStorage.getItem('globalVAT');
    if (existingVat) {
      document.getElementById('vat-input').value = existingVat;
    }
    
    // PHASE 4 FIX: Initialize helper from sessionStorage
    try {
      const currentHelper = sessionStorage.getItem('currentHelper') || sessionStorage.getItem('helper');
      if (currentHelper) {
        window.helper = JSON.parse(currentHelper);
        console.log('âœ… Helper loaded from sessionStorage:', window.helper?.plate || 'No plate');
      } else {
        window.helper = {};
        console.log('âš ï¸ No helper found in sessionStorage, initialized empty helper');
      }
    } catch (e) {
      console.error('Error loading helper from sessionStorage:', e);
      window.helper = {};
    }
    
    // Listen for helper updates from other modules
    window.addEventListener('storage', (e) => {
      if (e.key === 'currentHelper' || e.key === 'helper') {
        try {
          const updatedHelper = JSON.parse(e.newValue);
          window.helper = updatedHelper;
          console.log('âœ… Helper updated from storage event:', window.helper?.plate);
        } catch (err) {
          console.error('Error updating helper from storage event:', err);
        }
      }
    });
  });
</script>

<script>
// External Calendar Integration Template - Google/Outlook Sync Placeholder
/*
  // DISABLED BROKEN CODE - Previously caused await syntax errors
  try {
    // Show loading state
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = '××ª×—×‘×¨ ×œ××¢×¨×›×ª...';
    }
    
    // Import webhooks dynamically with fallback
    let sendToWebhook;
    let WEBHOOKS;
    try {
      // Removed broken await import
      sendToWebhook = webhookModule.sendToWebhook;
      WEBHOOKS = webhookModule.WEBHOOKS;
      console.log('âœ… Successfully imported webhook module');
    } catch (importError) {
      console.error('Failed to import webhook module:', importError);
      // Fallback webhook URL
      WEBHOOKS = {
        DEV_HUB: 'https://hook.eu2.make.com/cg8j5gu0wyum6yrbl4rz2myd0pew3znt'
      };
      console.log('âš ï¸ Using fallback webhook URL');
    }
    
    // Use direct fetch if sendToWebhook is not available
    let response;
    if (sendToWebhook) {
      console.log('ğŸ” Attempting DEV_HUB webhook verification via sendToWebhook...');
      // Removed broken await sendToWebhook 
        password,
        action: 'dev_login',
        timestamp: new Date().toISOString(),
        user_auth: sessionStorage.getItem('auth')
      });
    } else {
      console.log('ğŸ” Attempting DEV_HUB webhook verification via direct fetch...');
      // Removed broken await fetch
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          password,
          action: 'dev_login',
          timestamp: new Date().toISOString(),
          user_auth: sessionStorage.getItem('auth')
        })
      });
      
      console.log('ğŸ” DEV_HUB fetch response status:', fetchResponse.status);
      
      if (!fetchResponse.ok) {
        throw new Error(`HTTP ${fetchResponse.status}: ${fetchResponse.statusText}`);
      }
      
      try {
        response = await fetchResponse.json();
      } catch (jsonError) {
        console.log('Response is not JSON, getting text...');
        response = await fetchResponse.text();
      }
    }
    
    console.log('ğŸ” DEV_HUB webhook response:', response);
    
    // Enhanced dev access validation with multiple patterns
    const isDevAccess = 
      // JSON response patterns
      response?.role === 'dev' || 
      response?.access === 'dev' ||
      response?.status === 'dev' ||
      response?.result === 'dev' ||
      response?.access_granted === true ||
      response?.dev === true ||
      response?.authenticated === true ||
      response?.valid === true ||
      
      // Check for success indicators
      response?.success === true ||
      response?.approved === true ||
      
      // String response patterns (if response is just a string) - FIXED
      (typeof response === 'string' && /^(dev|success|granted|approved|valid|authenticated|true)$/i.test(response.trim())) ||
      
      // Handle webhook response that returns "approved" as seen in console
      response === 'approved' ||
      response === 'dev' ||
      response === 'granted';
    
    console.log('ğŸ” Dev access validation result:', isDevAccess);
    console.log('ğŸ” Response details:', {
      response,
      type: typeof response,
      stringValue: typeof response === 'string' ? response.trim() : 'not a string',
      regexTest: typeof response === 'string' ? /^(dev|success|granted|approved|valid|authenticated|true)$/i.test(response.trim()) : 'not tested'
    });
    
    if (isDevAccess) {
      console.log('âœ… Dev access granted via webhook');
      sessionStorage.setItem('dev-access', 'granted');
      if (submitBtn) {
        submitBtn.textContent = 'âœ… ×’×™×©×” ××•×©×¨×”';
      }
      setTimeout(() => {
        window.location.href = 'dev-module.html';
      }, 500);
    } else {
      console.error('âŒ Dev access denied');
      console.error('Response details:', response);
      if (submitBtn) {
        submitBtn.textContent = 'âŒ ×’×™×©×” × ×“×—×ª×”';
        setTimeout(() => {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }, 2000);
      }
      alert('âŒ Access denied: incorrect password or insufficient privileges');
    }
    
  } catch (err) {
    console.error('Dev login failed:', err);
    
    if (submitBtn) {
      submitBtn.textContent = 'âŒ ×©×’×™××ª ×—×™×‘×•×¨';
      setTimeout(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }, 2000);
    }
    
    let errorMessage = '×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª ×”××™××•×ª';
    
    if (err.message.includes('Failed to fetch')) {
      errorMessage = '×©×’×™××ª ×¨×©×ª - ×‘×“×•×§ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜';
    } else if (err.message.includes('timeout')) {
      errorMessage = '×¤×’ ×–××Ÿ ×”×—×™×‘×•×¨ - × ×¡×” ×©×•×‘';
    }
    
    alert(`ğŸš« Verification failed: ${errorMessage}`);
    
    // No offline fallback - always require webhook validation
  }
}

// Ensure function is globally available
window.verifyDevAccess = verifyDevAccess;

// Ensure function is available when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  if (typeof window.verifyDevAccess !== 'function') {
    console.warn('âš ï¸ verifyDevAccess not available on DOMContentLoaded');
  } else {
    console.log('âœ… verifyDevAccess function ready');
  }
});

*/

// External Calendar Integration Template - Google/Outlook Sync Placeholder
window.showCalendarSyncModal = function() {
  // Show calendar provider selection modal
  const modalHtml = `
    <div id="calendarSyncModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000;">
      <div style="background: #2a2a2a; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; border: 2px solid #0284c7;">
        <div style="text-align: center; margin-bottom: 20px;">
          <h3 style="color: #0284c7; margin: 0 0 10px 0;">ğŸ”— ×¡× ×›×¨×•×Ÿ ×™×•××Ÿ ×—×™×¦×•× ×™</h3>
          <p style="color: #ccc; font-size: 14px; margin: 0;">×‘×—×¨ ×¡×¤×§ ×™×•××Ÿ ×›×“×™ ×œ×¡× ×›×¨×Ÿ ×ª×–×›×•×¨×•×ª ×¢× ×™×•××Ÿ ×—×™×¦×•× ×™</p>
        </div>
        
        <!-- Calendar Provider Selection -->
        <div style="background: #333; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #555;">
          <div style="color: #0284c7; font-weight: bold; margin-bottom: 15px;">×‘×—×¨ ×¡×¤×§ ×™×•××Ÿ:</div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <!-- Google Calendar Option -->
            <button id="googleCalendarBtn" onclick="selectCalendarProvider('google')" 
                    style="padding: 20px; background: #1a1a1a; border: 2px solid #4285f4; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
              <div style="text-align: center;">
                <div style="font-size: 32px; margin-bottom: 10px;">ğŸ“…</div>
                <div style="color: #4285f4; font-weight: bold; margin-bottom: 5px;">Google Calendar</div>
                <div style="color: #ccc; font-size: 12px;">×¡× ×›×¨×•×Ÿ ×¢× ×’×•×’×œ ×§×œ× ×“×¨</div>
              </div>
            </button>
            
            <!-- Outlook Calendar Option -->
            <button id="outlookCalendarBtn" onclick="selectCalendarProvider('outlook')" 
                    style="padding: 20px; background: #1a1a1a; border: 2px solid #0078d4; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
              <div style="text-align: center;">
                <div style="font-size: 32px; margin-bottom: 10px;">ğŸ“†</div>
                <div style="color: #0078d4; font-weight: bold; margin-bottom: 5px;">Outlook Calendar</div>
                <div style="color: #ccc; font-size: 12px;">×¡× ×›×¨×•×Ÿ ×¢× ×××•×˜×œ×•×§</div>
              </div>
            </button>
          </div>
          
          <!-- Selected Provider Info -->
          <div id="selectedProviderInfo" style="display: none; background: #1a1a1a; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
            <div style="color: #4ade80; font-weight: bold; margin-bottom: 10px;">âœ… × ×‘×—×¨: <span id="selectedProviderName"></span></div>
            <div id="providerInstructions" style="color: #e0e0e0; font-size: 14px; margin-bottom: 15px;"></div>
            
            <!-- Sync Options -->
            <div style="border-top: 1px solid #444; padding-top: 15px; margin-top: 15px;">
              <div style="color: #fbbf24; font-weight: bold; margin-bottom: 10px;">××¤×©×¨×•×™×•×ª ×¡× ×›×¨×•×Ÿ:</div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <label style="color: #e0e0e0; cursor: pointer;">
                  <input type="checkbox" id="syncActiveReminders" checked style="margin-left: 8px;">
                  ×ª×–×›×•×¨×•×ª ×¤×¢×™×œ×•×ª
                </label>
                <label style="color: #e0e0e0; cursor: pointer;">
                  <input type="checkbox" id="syncPendingReminders" checked style="margin-left: 8px;">
                  ×ª×–×›×•×¨×•×ª ×××ª×™× ×•×ª
                </label>
                <label style="color: #e0e0e0; cursor: pointer;">
                  <input type="checkbox" id="syncCompletedReminders" style="margin-left: 8px;">
                  ×ª×–×›×•×¨×•×ª ×©×”×•×©×œ××•
                </label>
                <label style="color: #e0e0e0; cursor: pointer;">
                  <input type="checkbox" id="syncOverdueReminders" checked style="margin-left: 8px;">
                  ×ª×–×›×•×¨×•×ª ×©×¤×’ ×ª×•×§×¤×Ÿ
                </label>
              </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="margin-top: 20px; text-align: center;">
              <button onclick="initializeCalendarSync()" 
                      style="padding: 12px 24px; background: #16a34a; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-left: 10px;">
                ğŸ”— ×”×ª×—×œ ×¡× ×›×¨×•×Ÿ
              </button>
              <button onclick="testCalendarConnection()" 
                      style="padding: 12px 24px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                ğŸ§ª ×‘×“×•×§ ×—×™×‘×•×¨
              </button>
            </div>
          </div>
        </div>
        
        <!-- Status Display -->
        <div id="calendarSyncStatus" style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #444;">
          <div style="color: #fbbf24; font-weight: bold; margin-bottom: 10px;">××¦×‘:</div>
          <div id="syncStatusText" style="color: #e0e0e0; font-size: 14px;">×‘×—×¨ ×¡×¤×§ ×™×•××Ÿ ×›×“×™ ×œ×”×ª×—×™×œ</div>
        </div>
        
        <!-- Modal Controls -->
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button onclick="closeCalendarSyncModal()" 
                  style="padding: 12px 24px; background: #991b1b; color: white; border: none; border-radius: 8px; cursor: pointer;">
            âŒ ×¡×’×•×¨
          </button>
        </div>
      </div>
    </div>`;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
};

// Calendar Provider Selection
window.selectCalendarProvider = function(provider) {
  const providerInfo = document.getElementById('selectedProviderInfo');
  const providerName = document.getElementById('selectedProviderName');
  const instructions = document.getElementById('providerInstructions');
  const statusText = document.getElementById('syncStatusText');
  
  // Reset button styles
  document.getElementById('googleCalendarBtn').style.background = '#1a1a1a';
  document.getElementById('outlookCalendarBtn').style.background = '#1a1a1a';
  
  if (provider === 'google') {
    providerName.textContent = 'Google Calendar';
    instructions.innerHTML = `
      <strong>×”×•×¨××•×ª ×—×™×‘×•×¨ ×œ×’×•×’×œ ×§×œ× ×“×¨:</strong><br>
      1. ×”××¢×¨×›×ª ×ª×¤×ª×— ×—×œ×•×Ÿ ×”×ª×—×‘×¨×•×ª ×œ×’×•×’×œ<br>
      2. ×”×ª×—×‘×¨ ×¢× ×—×©×‘×•×Ÿ ×”×’×•×’×œ ×©×œ×š<br>
      3. ××©×¨ ×”×¨×©××•×ª ×’×™×©×” ×œ×™×•××Ÿ<br>
      4. ×”×ª×–×›×•×¨×•×ª ×™×¡× ×›×¨× ×• ××•×˜×•××˜×™×ª<br><br>
      <em style="color: #f59e0b;">×”×¢×¨×”: × ×“×¨×©×ª ×”×¨×©××ª ×× ×”×œ ×œ×”×¤×¢×œ×ª ×”×¡× ×›×¨×•×Ÿ</em>
    `;
    document.getElementById('googleCalendarBtn').style.background = '#2a4a2a';
    statusText.textContent = '× ×‘×—×¨ Google Calendar - ××•×›×Ÿ ×œ×—×™×‘×•×¨';
  } else if (provider === 'outlook') {
    providerName.textContent = 'Outlook Calendar';
    instructions.innerHTML = `
      <strong>×”×•×¨××•×ª ×—×™×‘×•×¨ ×œ×××•×˜×œ×•×§:</strong><br>
      1. ×”××¢×¨×›×ª ×ª×¤×ª×— ×—×œ×•×Ÿ ×”×ª×—×‘×¨×•×ª ×œ××™×§×¨×•×¡×•×¤×˜<br>
      2. ×”×ª×—×‘×¨ ×¢× ×—×©×‘×•×Ÿ Microsoft 365 ××• Outlook.com<br>
      3. ××©×¨ ×”×¨×©××•×ª ×’×™×©×” ×œ×™×•××Ÿ<br>
      4. ×”×ª×–×›×•×¨×•×ª ×™×¡× ×›×¨× ×• ××•×˜×•××˜×™×ª<br><br>
      <em style="color: #f59e0b;">×”×¢×¨×”: × ×“×¨×©×ª ×”×¨×©××ª ×× ×”×œ ×œ×”×¤×¢×œ×ª ×”×¡× ×›×¨×•×Ÿ</em>
    `;
    document.getElementById('outlookCalendarBtn').style.background = '#2a2a4a';
    statusText.textContent = '× ×‘×—×¨ Outlook Calendar - ××•×›×Ÿ ×œ×—×™×‘×•×¨';
  }
  
  // Store selected provider
  window.selectedCalendarProvider = provider;
  
  // Show provider info
  providerInfo.style.display = 'block';
};

// Initialize Calendar Sync (Template - requires API integration)
window.initializeCalendarSync = function() {
  const provider = window.selectedCalendarProvider;
  const statusText = document.getElementById('syncStatusText');
  
  if (!provider) {
    alert('×× × ×‘×—×¨ ×¡×¤×§ ×™×•××Ÿ ×ª×—×™×œ×”');
    return;
  }
  
  statusText.textContent = '××ª×—×™×œ ×¡× ×›×¨×•×Ÿ...';
  
  // Get sync options
  const syncOptions = {
    active: document.getElementById('syncActiveReminders').checked,
    pending: document.getElementById('syncPendingReminders').checked,
    completed: document.getElementById('syncCompletedReminders').checked,
    overdue: document.getElementById('syncOverdueReminders').checked
  };
  
  console.log(`ğŸ”— Initializing calendar sync with ${provider}`, syncOptions);
  
  // Template implementation - in actual deployment this would:
  // 1. Open OAuth2 flow for selected provider
  // 2. Handle authentication callback
  // 3. Store access tokens securely
  // 4. Sync reminders based on selected options
  
  setTimeout(() => {
    statusText.innerHTML = `
      <div style="color: #f59e0b;">âš ï¸ ×¨×›×™×‘ ×”×¡× ×›×¨×•×Ÿ ×‘××¦×‘ ×¤×™×ª×•×—</div>
      <div style="font-size: 12px; margin-top: 5px;">
        × ×‘×—×¨: ${provider === 'google' ? 'Google Calendar' : 'Outlook Calendar'}<br>
        ××¤×©×¨×•×™×•×ª: ${Object.entries(syncOptions).filter(([k,v]) => v).map(([k]) => k).join(', ')}<br>
        <em>API ×™×•×¤×¢×œ ×¢×œ ×™×“×™ ×”×× ×”×œ</em>
      </div>
    `;
    
    alert(`âœ… ×”×’×“×¨×•×ª ×¡× ×›×¨×•×Ÿ × ×©××¨×• ×¢×‘×•×¨ ${provider === 'google' ? 'Google Calendar' : 'Outlook Calendar'}!\n×”×× ×”×œ ×™×¤×¢×™×œ ××ª ×”-API ×‘×”×ª×× ×œ×”×¢×“×¤×•×ª ×©×œ×š.`);
  }, 1500);
};

// Test Calendar Connection (Template)
window.testCalendarConnection = function() {
  const provider = window.selectedCalendarProvider;
  const statusText = document.getElementById('syncStatusText');
  
  if (!provider) {
    alert('×× × ×‘×—×¨ ×¡×¤×§ ×™×•××Ÿ ×ª×—×™×œ×”');
    return;
  }
  
  statusText.textContent = '×‘×•×“×§ ×—×™×‘×•×¨...';
  
  console.log(`ğŸ§ª Testing calendar connection for ${provider}`);
  
  // Template implementation - would test actual API connection
  setTimeout(() => {
    statusText.innerHTML = `
      <div style="color: #4ade80;">âœ… ×‘×“×™×§×ª ×—×™×‘×•×¨ ×”×¦×œ×™×—×”</div>
      <div style="font-size: 12px; margin-top: 5px; color: #ccc;">
        ×¡×¤×§: ${provider === 'google' ? 'Google Calendar API' : 'Microsoft Graph API'}<br>
        ×¡×˜×˜×•×¡: ××•×›×Ÿ ×œ×¡× ×›×¨×•×Ÿ (×¨×§ ×œ××—×¨ ×”×¤×¢×œ×ª API)
      </div>
    `;
  }, 1000);
};

// Close Calendar Sync Modal
window.closeCalendarSyncModal = function() {
  const modal = document.getElementById('calendarSyncModal');
  if (modal) modal.remove();
  
  // Clear selection
  window.selectedCalendarProvider = null;
};

// Voice Reminder Functionality - STT Integration for Reminder Creation
window.startVoiceReminder = function() {
  console.log('ğŸ¤ Voice reminder button clicked');
  console.log('Browser support check:', {
    webkitSpeechRecognition: 'webkitSpeechRecognition' in window,
    SpeechRecognition: 'SpeechRecognition' in window,
    userAgent: navigator.userAgent
  });
  
  // Check if speech recognition is available
  if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
    console.error('âŒ Speech recognition not supported in this browser');
    alert('×–×™×”×•×™ ×§×•×œ ×œ× × ×ª××š ×‘×“×¤×“×¤×Ÿ ×–×”\n×× × ×”×©×ª××© ×‘×›×¨×•× ××• ××“×’\'');
    return;
  }
  
  console.log('âœ… Speech recognition supported, showing modal...');
  
  // Show voice recording modal
  const modalHtml = `
    <div id="voiceReminderModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000;">
      <div style="background: #2a2a2a; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; border: 2px solid #7c3aed;">
        <div style="text-align: center; margin-bottom: 20px;">
          <h3 style="color: #7c3aed; margin: 0 0 10px 0;">ğŸ¤ ×™×¦×™×¨×ª ×ª×–×›×•×¨×ª ×§×•×œ×™×ª</h3>
          <p style="color: #ccc; font-size: 14px; margin: 0;">×“×‘×¨ ×‘×¢×‘×¨×™×ª - ×”××¢×¨×›×ª ×ª×–×”×” ×ª××¨×™×š, ×©×¢×” ×•××¡×¤×¨ ×¨×›×‘ ××•×˜×•××˜×™×ª</p>
        </div>
        
        <!-- Recording Status -->
        <div id="voiceReminderStatus" style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #555; text-align: center;">
          <div id="recordingIndicator" style="color: #ff6b6b; font-size: 18px; margin-bottom: 10px;">ğŸ”´ ×œ×—×¥ ×¢×œ "×”×ª×—×œ ×”×§×œ×˜×”" ×›×“×™ ×œ×”×ª×—×™×œ</div>
          <div id="speechText" style="color: #e0e0e0; font-size: 16px; min-height: 50px; font-style: italic;">×”××ª×Ÿ ×œ×˜×§×¡×˜ ×”××–×•×”×”...</div>
        </div>
        
        <!-- Voice Controls -->
        <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
          <button id="startRecordingBtn" onclick="startRecordingVoiceReminder()" 
                  style="padding: 12px 24px; background: #7c3aed; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
            ğŸ¤ ×”×ª×—×œ ×”×§×œ×˜×”
          </button>
          <button id="stopRecordingBtn" onclick="stopRecordingVoiceReminder()" disabled
                  style="padding: 12px 24px; background: #dc2626; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; opacity: 0.5;">
            â¹ï¸ ×¢×¦×•×¨
          </button>
        </div>
        
        <!-- Processed Results -->
        <div id="voiceReminderResults" style="display: none; background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #444;">
          <div style="color: #4ade80; font-weight: bold; margin-bottom: 10px;">ğŸ“ ×ª×•×¦××•×ª ×–×™×”×•×™:</div>
          <div id="extractedData" style="color: #e0e0e0; font-size: 14px;"></div>
          <div style="margin-top: 15px;">
            <button onclick="confirmVoiceReminder()" 
                    style="padding: 10px 20px; background: #16a34a; color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px;">
              âœ… ×¦×•×¨ ×ª×–×›×•×¨×ª
            </button>
            <button onclick="retryVoiceRecording()" 
                    style="padding: 10px 20px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer;">
              ğŸ”„ × ×¡×” ×©×•×‘
            </button>
          </div>
        </div>
        
        <!-- Modal Controls -->
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button onclick="closeVoiceReminderModal()" 
                  style="padding: 12px 24px; background: #991b1b; color: white; border: none; border-radius: 8px; cursor: pointer;">
            âŒ ×‘×™×˜×•×œ
          </button>
        </div>
      </div>
    </div>`;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
};

// Voice Recording Control Functions
window.startRecordingVoiceReminder = function() {
  const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
  const recognition = new SpeechRecognition();
  
  // Configure recognition for Hebrew
  recognition.lang = 'he-IL';
  recognition.interimResults = true;
  recognition.maxAlternatives = 1;
  recognition.continuous = true;
  
  // Update UI for recording state
  const indicator = document.getElementById('recordingIndicator');
  const speechText = document.getElementById('speechText');
  const startBtn = document.getElementById('startRecordingBtn');
  const stopBtn = document.getElementById('stopRecordingBtn');
  
  if (indicator) indicator.textContent = 'ğŸ”´ ××§×œ×™×˜... ×“×‘×¨ ×¢×›×©×™×•';
  if (speechText) speechText.textContent = '××§×©×™×‘...';
  if (startBtn) { startBtn.disabled = true; startBtn.style.opacity = '0.5'; }
  if (stopBtn) { stopBtn.disabled = false; stopBtn.style.opacity = '1'; }
  
  // Store recognition instance for stopping
  window.currentVoiceRecognition = recognition;
  
  // Handle speech results
  recognition.addEventListener('result', (event) => {
    let finalTranscript = '';
    let interimTranscript = '';
    
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const transcript = event.results[i][0].transcript;
      if (event.results[i].isFinal) {
        finalTranscript += transcript + ' ';
      } else {
        interimTranscript += transcript;
      }
    }
    
    // Update speech text display
    const displayText = finalTranscript + interimTranscript;
    if (speechText) {
      speechText.textContent = displayText || '××§×©×™×‘...';
    }
    
    // Store the transcript
    window.voiceReminderTranscript = finalTranscript.trim();
  });
  
  // Handle recognition end
  recognition.addEventListener('end', () => {
    if (indicator) indicator.textContent = 'âœ… ×”×§×œ×˜×” ×”×¡×ª×™×™××”';
    if (startBtn) { startBtn.disabled = false; startBtn.style.opacity = '1'; }
    if (stopBtn) { stopBtn.disabled = true; stopBtn.style.opacity = '0.5'; }
    
    // Process the recorded speech
    processVoiceReminderText();
  });
  
  // Handle errors
  recognition.addEventListener('error', (event) => {
    console.error('Voice recognition error:', event.error);
    if (indicator) indicator.textContent = 'âŒ ×©×’×™××” ×‘×–×™×”×•×™ ×§×•×œ: ' + event.error;
    if (startBtn) { startBtn.disabled = false; startBtn.style.opacity = '1'; }
    if (stopBtn) { stopBtn.disabled = true; stopBtn.style.opacity = '0.5'; }
  });
  
  // Start recognition
  try {
    recognition.start();
    console.log('ğŸ¤ Voice recognition started for reminder creation');
  } catch (error) {
    console.error('Failed to start voice recognition:', error);
    if (indicator) indicator.textContent = 'âŒ × ×›×©×œ ×œ×”×ª×—×™×œ ×–×™×”×•×™ ×§×•×œ';
  }
};

window.stopRecordingVoiceReminder = function() {
  if (window.currentVoiceRecognition) {
    window.currentVoiceRecognition.stop();
    window.currentVoiceRecognition = null;
  }
};

// Process voice text and extract reminder data
window.processVoiceReminderText = function() {
  const transcript = window.voiceReminderTranscript || '';
  
  if (!transcript) {
    document.getElementById('recordingIndicator').textContent = 'âŒ ×œ× ×–×•×”×” ×˜×§×¡×˜ - × ×¡×” ×©×•×‘';
    return;
  }
  
  console.log('ğŸ” Processing voice reminder text:', transcript);
  
  // Hebrew date/time extraction patterns
  const extractedData = {
    title: '',
    description: transcript,
    date: null,
    time: null,
    plate: null,
    category: 'general',
    priority: 'medium'
  };
  
  // Extract plate number patterns (Israeli format)
  const platePatterns = [
    /(\d{7,8})/g, // 7-8 digits
    /(\d{3}[-\s]?\d{2}[-\s]?\d{3})/g, // xxx-xx-xxx format
    /×¨×›×‘\s*:?\s*(\d+)/gi, // "×¨×›×‘: 123456"
    /××¡×¤×¨\s*:?\s*(\d+)/gi, // "××¡×¤×¨: 123456"
    /×œ×•×—×™×ª\s*:?\s*(\d+)/gi // "×œ×•×—×™×ª: 123456"
  ];
  
  for (const pattern of platePatterns) {
    const match = transcript.match(pattern);
    if (match) {
      extractedData.plate = match[0].replace(/[-\s]/g, '');
      break;
    }
  }
  
  // Extract Hebrew dates and times
  const today = new Date();
  
  // Date patterns
  const datePatterns = [
    { pattern: /×”×™×•×/gi, offset: 0 },
    { pattern: /××—×¨/gi, offset: 1 },
    { pattern: /××—×¨×ª×™×™×/gi, offset: 2 },
    { pattern: /×”×©×‘×•×¢ ×”×‘×/gi, offset: 7 },
    { pattern: /×‘×¢×•×“ ×©×‘×•×¢/gi, offset: 7 },
    { pattern: /×‘×¢×•×“ (\d+) ×™××™×/gi, offset: 'dynamic' }
  ];
  
  for (const { pattern, offset } of datePatterns) {
    const match = transcript.match(pattern);
    if (match) {
      const targetDate = new Date(today);
      if (offset === 'dynamic') {
        const days = parseInt(match[1]);
        targetDate.setDate(today.getDate() + days);
      } else {
        targetDate.setDate(today.getDate() + offset);
      }
      extractedData.date = targetDate.toISOString().split('T')[0];
      break;
    }
  }
  
  // Time patterns
  const timePatterns = [
    /(\d{1,2}):(\d{2})/g, // HH:MM format
    /(\d{1,2}) ×•(\d{2})/g, // Hebrew "X ×•Y" format  
    /×‘×©×¢×”\s*(\d{1,2})/gi, // "×‘×©×¢×” X"
    /×‘(\d{1,2})/gi // "×‘X" (at X o'clock)
  ];
  
  for (const pattern of timePatterns) {
    const match = transcript.match(pattern);
    if (match) {
      let hour = parseInt(match[1]);
      let minute = match[2] ? parseInt(match[2]) : 0;
      
      // Handle PM/AM context in Hebrew
      if (transcript.includes('××—×”"×¦') || transcript.includes('××—×¨×™ ×”×¦×”×¨×™×™×') || transcript.includes('×‘×¢×¨×‘')) {
        if (hour < 12) hour += 12;
      }
      
      extractedData.time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
      break;
    }
  }
  
  // Set default date/time if not found
  if (!extractedData.date) {
    extractedData.date = today.toISOString().split('T')[0];
  }
  if (!extractedData.time) {
    extractedData.time = '09:00';
  }
  
  // Generate title from description (first 50 chars)
  extractedData.title = transcript.substring(0, 50) + (transcript.length > 50 ? '...' : '');
  
  // Determine category based on keywords
  const categoryKeywords = {
    payment_reminder: ['×ª×©×œ×•×', '×—×™×•×‘', '×›×¡×£', '×—×©×‘×•×Ÿ'],
    case_deadline: ['×ª×™×§', '×¡×’×™×¨×”', '×“×“×œ×™×™×Ÿ', '××•×¢×“'],
    follow_up: ['××¢×§×‘', '×‘×“×™×§×”', '×¢×“×›×•×Ÿ', '×˜×œ×¤×•×Ÿ'],
    inspection: ['×‘×“×™×§×”', '×‘×™×§×•×¨×ª', '××§×¡×¤×¨×˜×™×–×”']
  };
  
  for (const [category, keywords] of Object.entries(categoryKeywords)) {
    if (keywords.some(keyword => transcript.includes(keyword))) {
      extractedData.category = category;
      break;
    }
  }
  
  // Determine priority based on keywords
  if (transcript.includes('×“×—×•×£') || transcript.includes('×—×©×•×‘') || transcript.includes('××™×™×“×™')) {
    extractedData.priority = 'high';
  } else if (transcript.includes('×¨×’×™×œ') || transcript.includes('× ××•×š')) {
    extractedData.priority = 'low';
  }
  
  // Store extracted data globally
  window.extractedVoiceReminderData = extractedData;
  
  // Display results
  displayVoiceReminderResults(extractedData);
};

// Display extracted data for user confirmation
window.displayVoiceReminderResults = function(data) {
  const resultsDiv = document.getElementById('voiceReminderResults');
  const extractedDataDiv = document.getElementById('extractedData');
  
  if (!resultsDiv || !extractedDataDiv) return;
  
  const categoryNames = {
    case_deadline: '××•×¢×“ ×¡×’×™×¨×ª ×ª×™×§',
    payment_reminder: '×ª×–×›×•×¨×ª ×ª×©×œ×•×', 
    follow_up: '××¢×§×‘',
    inspection: '×‘×“×™×§×”',
    general: '×›×œ×œ×™'
  };
  
  const priorityNames = {
    high: '×’×‘×•×”×”',
    medium: '×‘×™× ×•× ×™×ª',
    low: '× ××•×›×”'
  };
  
  extractedDataDiv.innerHTML = `
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
      <div><strong style="color: #fbbf24;">×›×•×ª×¨×ª:</strong> ${data.title}</div>
      <div><strong style="color: #fbbf24;">×ª××¨×™×š:</strong> ${new Date(data.date).toLocaleDateString('he-IL')}</div>
      <div><strong style="color: #fbbf24;">×©×¢×”:</strong> ${data.time}</div>
      <div><strong style="color: #fbbf24;">×§×˜×’×•×¨×™×”:</strong> ${categoryNames[data.category]}</div>
      <div><strong style="color: #fbbf24;">×¢×“×™×¤×•×ª:</strong> ${priorityNames[data.priority]}</div>
      <div><strong style="color: #fbbf24;">×¨×›×‘:</strong> ${data.plate || '×œ× ×–×•×”×”'}</div>
    </div>
    <div style="margin-top: 10px;"><strong style="color: #fbbf24;">×ª×™××•×¨ ××œ×:</strong></div>
    <div style="background: #333; padding: 8px; border-radius: 4px; margin-top: 5px; font-style: italic;">${data.description}</div>
  `;
  
  resultsDiv.style.display = 'block';
};

// Confirm and create the voice reminder
window.confirmVoiceReminder = async function() {
  const data = window.extractedVoiceReminderData;
  if (!data) {
    alert('××™×Ÿ × ×ª×•× ×™× ×œ×™×¦×™×¨×ª ×ª×–×›×•×¨×ª');
    return;
  }
  
  try {
    console.log('ğŸ”„ Starting voice reminder creation process...');
    console.log('Webhook ready:', window.webhookReady);
    console.log('sendToWebhook available:', typeof window.sendToWebhook);
    
    // Wait for webhook to be ready with better timing handling
    if (!window.webhookReady) {
      console.log('â³ Webhook not ready, waiting for initialization...');
      // Wait a bit for webhook to initialize
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
    
    if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
      console.error('âŒ Webhook system not available');
      console.log('Available functions:', Object.keys(window).filter(k => k.includes('webhook')));
      throw new Error('××¢×¨×›×ª ×”×§×™×©×•×¨ ×œ×©×¨×ª ×œ× ×–××™× ×” - × ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£');
    }
    
    console.log('ğŸ”„ Creating voice reminder with data:', data);
    
    const reminderPayload = {
      action: 'create_reminder',
      title: data.title,
      description: data.description,
      due_date: data.date,
      due_time: data.time,
      category: data.category,
      priority: data.priority,
      plate: data.plate || '',
      status: 'active',
      created_via: 'voice_stt',
      created_at: new Date().toISOString(),
      voice_transcript: window.voiceReminderTranscript || ''
    };
    
    console.log('ğŸ“¤ Sending voice reminder payload:', reminderPayload);
    
    const response = await window.sendToWebhook('ADMIN_CREATE_REMINDER', reminderPayload);
    
    console.log('âœ… Voice reminder created successfully:', response);
    
    // Close modal and show success
    closeVoiceReminderModal();
    alert('âœ… ×ª×–×›×•×¨×ª ×§×•×œ×™×ª × ×•×¦×¨×” ×‘×”×¦×œ×—×”!');
    
    // Refresh reminders list if data is loaded
    if (window.remindersData && Array.isArray(window.remindersData)) {
      console.log('ğŸ”„ Refreshing reminders display...');
      renderReminders();
    } else {
      console.log('â„¹ï¸ No reminders data loaded, skipping refresh');
    }
    
  } catch (error) {
    console.error('âŒ Failed to create voice reminder:', error);
    console.error('Error details:', {
      message: error.message,
      stack: error.stack,
      webhookReady: window.webhookReady,
      sendToWebhookType: typeof window.sendToWebhook
    });
    alert(`âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×ª×–×›×•×¨×ª: ${error.message}`);
  }
};

// Retry voice recording
window.retryVoiceRecording = function() {
  // Hide results and reset
  const resultsDiv = document.getElementById('voiceReminderResults');
  const speechText = document.getElementById('speechText');
  const indicator = document.getElementById('recordingIndicator');
  
  if (resultsDiv) resultsDiv.style.display = 'none';
  if (speechText) speechText.textContent = '×”××ª×Ÿ ×œ×˜×§×¡×˜ ×”××–×•×”×”...';
  if (indicator) indicator.textContent = 'ğŸ”´ ×œ×—×¥ ×¢×œ "×”×ª×—×œ ×”×§×œ×˜×”" ×›×“×™ ×œ×”×ª×—×™×œ';
  
  // Clear stored data
  window.voiceReminderTranscript = '';
  window.extractedVoiceReminderData = null;
};

// Close voice reminder modal
window.closeVoiceReminderModal = function() {
  // Stop any ongoing recording
  if (window.currentVoiceRecognition) {
    window.currentVoiceRecognition.stop();
    window.currentVoiceRecognition = null;
  }
  
  // Remove modal
  const modal = document.getElementById('voiceReminderModal');
  if (modal) modal.remove();
  
  // Clear stored data
  window.voiceReminderTranscript = '';
  window.extractedVoiceReminderData = null;
};

// Hook into navigation to refresh log display when logView is selected
const originalShowContent = window.showContent;
window.showContent = function(id) {
  originalShowContent(id);
  if (id === 'logView') {
    setTimeout(() => {
      renderLogEntries();
      updateLogStatistics();
    }, 50);
  }
};

// ============================================================================
// VERSION MANAGEMENT FUNCTIONS - User-friendly for non-technical users
// ============================================================================

// Supabase configuration for admin operations
const SUPABASE_URL = 'https://nvqrptokmwdhvpiufrad.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52cXJwdG9rbXdkaHZwaXVmcmFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzU0ODUsImV4cCI6MjA3MTYxMTQ4NX0.yvFalmZE7Xpvo_j6wzRj44Pa7Bx9LQegcyLzbz3QL5s';

// Helper function to show version operation status
function showVersionStatus(message, type) {
  const statusDiv = document.getElementById('versionStatus');
  if (!statusDiv) {
    console.log(`Version Status: ${message}`);
    return;
  }
  
  const colorMap = {
    loading: '#17a2b8',
    success: '#28a745',
    error: '#dc3545',
    warning: '#ffc107'
  };
  
  const bgMap = {
    loading: '#1a365d',
    success: '#0f2419',
    error: '#450a0a',
    warning: '#332701'
  };
  
  statusDiv.innerHTML = `
    <div style="color: ${colorMap[type] || '#e0e0e0'}; padding: 15px; background: ${bgMap[type] || '#2a2a2a'}; border: 1px solid ${colorMap[type] || '#555'}; border-radius: 6px;">
      <strong>${type === 'loading' ? 'ğŸ”„' : type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'âš ï¸'} ${message}</strong>
    </div>`;
}

// Load case version history - user-friendly with date-based navigation
window.loadCaseVersionHistory = async function() {
  const plate = document.getElementById('versionPlateSearch').value.trim();
  if (!plate) {
    alert('×× × ×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘');
    return;
  }
  
  const statusDiv = document.getElementById('versionStatus');
  const resultsDiv = document.getElementById('versionResults');
  
  statusDiv.innerHTML = `
    <div style="color: #17a2b8; padding: 15px; background: #1a365d; border: 1px solid #17a2b8; border-radius: 6px;">
      <strong>ğŸ”„ ××—×¤×© ××ª ×”×ª×™×§ ×©×œ×š...</strong><br>
      ×‘×•×“×§ ×‘×‘×¡×™×¡ ×”× ×ª×•× ×™× ×¢×‘×•×¨ ×¨×›×‘: ${plate}
    </div>`;
    
  resultsDiv.style.display = 'none';
  
  try {
    // Find case by plate
    const caseResponse = await fetch(`${SUPABASE_URL}/rest/v1/cases?plate=eq.${plate}&order=created_at.desc`, {
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      }
    });
    
    if (!caseResponse.ok) {
      throw new Error(`HTTP error! status: ${caseResponse.status}`);
    }
    
    const cases = await caseResponse.json();
    
    if (!cases || cases.length === 0) {
      statusDiv.innerHTML = `
        <div style="color: #dc3545; padding: 15px; background: #450a0a; border: 1px solid #dc3545; border-radius: 6px;">
          <strong>âŒ ×”×ª×™×§ ×œ× × ××¦×</strong><br>
          ×œ× ××¦××ª×™ ×ª×™×§ ×¢×‘×•×¨ ×¨×›×‘ ××¡×¤×¨: ${plate}<br>
          <small>×‘×“×•×§ ×©×”××¡×¤×¨ × ×›×•×Ÿ ××• ×©×”×ª×™×§ ××›×Ÿ ×§×™×™× ×‘××¢×¨×›×ª</small>
        </div>`;
      return;
    }
    
    const case_ = cases[0]; // Most recent case
    
    // Get all versions for this case
    // PHASE 4 FIX: Explicitly select is_current field to ensure proper boolean handling
    const versionsResponse = await fetch(`${SUPABASE_URL}/rest/v1/case_helper?case_id=eq.${case_.id}&select=id,case_id,version,is_current,helper_name,helper_json,source,updated_by,updated_at&order=updated_at.desc`, {
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      }
    });
    
    if (!versionsResponse.ok) {
      throw new Error(`HTTP error! status: ${versionsResponse.status}`);
    }
    
    const versions = await versionsResponse.json();
    
    if (!versions || versions.length === 0) {
      statusDiv.innerHTML = `
        <div style="color: #ffc107; padding: 15px; background: #332701; border: 1px solid #ffc107; border-radius: 6px;">
          <strong>âš ï¸ ××™×Ÿ × ×ª×•× ×™× ×œ×ª×™×§</strong><br>
          ××¦××ª×™ ××ª ×”×ª×™×§ ${plate} ××š ××™×Ÿ ×¢×“×™×™×Ÿ × ×ª×•× ×™ ×¢×‘×•×“×” ×©××•×¨×™×
        </div>`;
      return;
    }
    
    // Debug logging to check is_current values
    console.log('ğŸ” DEBUG: Versions fetched from database:', versions.length);
    versions.forEach((version, index) => {
      console.log(`ğŸ” Version ${index + 1}:`, {
        id: version.id,
        helper_name: version.helper_name,
        version: version.version,
        is_current: version.is_current,
        updated_at: version.updated_at
      });
    });
    
    // Display results
    displayVersionHistoryForUser(case_, versions);
    statusDiv.innerHTML = `
      <div style="color: #28a745; padding: 15px; background: #0f2419; border: 1px solid #28a745; border-radius: 6px;">
        <strong>âœ… ××¦××ª×™ ${versions.length} ×’×™×‘×•×™×™× ×¢×‘×•×¨ ×ª×™×§ ${plate}</strong><br>
        ×›×œ ×©××™×¨×” ×©×¢×©×™×ª × ×©××¨×” ×›×’×™×‘×•×™ × ×¤×¨×“ - ×ª×•×›×œ ×œ×¨××•×ª ××ª×™ ×•×œ×—×–×•×¨ ×œ×›×œ × ×§×•×“×”
      </div>`;
      
  } catch (error) {
    console.error('Error loading version history:', error);
    statusDiv.innerHTML = `
      <div style="color: #dc3545; padding: 15px; background: #450a0a; border: 1px solid #dc3545; border-radius: 6px;">
        <strong>âŒ ×©×’×™××” ×‘×—×™×¤×•×©</strong><br>
        ××©×”×• ×”×©×ª×‘×© ×‘×—×™×¤×•×© ×”×ª×™×§. × ×¡×” ×©×•×‘ ××• ×¦×•×¨ ×§×©×¨ ×œ×ª××™×›×”.
      </div>`;
  }
};

// Display version history in user-friendly format with dates
function displayVersionHistoryForUser(case_, versions) {
  console.log('ğŸ”§ PHASE 4 ADMIN VERSION MANAGEMENT - Starting display');
  console.log('ğŸ“Š Case:', case_.plate, 'Versions:', versions.length);
  
  const resultsDiv = document.getElementById('versionResults');
  const caseInfoDiv = document.getElementById('caseInfoDisplay');
  const versionsListDiv = document.getElementById('versionsList');
  
  // Case information - user friendly
  caseInfoDiv.innerHTML = `
    <div style="background: #1a365d; padding: 15px; border-radius: 6px; border: 1px solid #17a2b8;">
      <h3 style="color: #17a2b8; margin-top: 0;">ğŸ“‹ ×¤×¨×˜×™ ×”×ª×™×§</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
        <div><strong>××¡×¤×¨ ×¨×›×‘:</strong> ${case_.plate}</div>
        <div><strong>××¦×‘ ×”×ª×™×§:</strong> <span style="color: ${getStatusColor(case_.status)};">${getStatusDisplay(case_.status)}</span></div>
        <div><strong>×‘×¢×œ ×”×¨×›×‘:</strong> ${case_.owner_name || '×œ× ×¨×©×•×'}</div>
        <div><strong>×”×ª×™×§ × ×¤×ª×—:</strong> ${formatDate(case_.created_at)}</div>
        <div><strong>×¢×“×›×•×Ÿ ××—×¨×•×Ÿ:</strong> ${formatDate(case_.updated_at)}</div>
        <div><strong>×¡×”"×› ×’×™×‘×•×™×™×:</strong> ${versions.length}</div>
      </div>
    </div>`;
  
  // Check if all versions are incorrectly marked as current
  const allMarkedCurrent = versions.every(v => v.is_current === true || v.is_current === 'true' || v.is_current === 1);
  
  // PHASE 4 FIX: Check if only one version exists
  const hasOnlyOneVersion = versions.length === 1;
  
  // Versions list - focus on dates, not technical versions
  let versionsHtml = `
    <h3 style="color: #ff6b35; margin-bottom: 15px;">ğŸ“š ×’×™×‘×•×™×™× ×©×œ ×”×ª×™×§ (×œ×¤×™ ×ª××¨×™×š)</h3>
    <div style="color: #ccc; font-size: 13px; margin-bottom: 15px; background: #1a1a1a; padding: 10px; border-radius: 4px;">
      ğŸ’¡ <strong>×”×¡×‘×¨:</strong> ×›×œ ×¤×¢× ×©×¢×‘×“×ª ×¢×œ ×”×ª×™×§ ×•×©××¨×ª ××•×ª×•, ×”××¢×¨×›×ª ×™×¦×¨×” ×’×™×‘×•×™ ××•×˜×•××˜×™. 
      ××ª×” ×™×›×•×œ ×œ×¨××•×ª ×‘×“×™×•×§ ××ª×™ ×¢×‘×“×ª ×¢×œ ×”×ª×™×§ ×•×œ×—×–×•×¨ ×œ×›×œ × ×§×•×“×ª ×–××Ÿ.
    </div>`;
  
  if (hasOnlyOneVersion) {
    versionsHtml += `
      <div style="color: #17a2b8; font-size: 13px; margin-bottom: 15px; background: #1a365d; padding: 10px; border-radius: 4px; border: 1px solid #17a2b8;">
        â„¹ï¸ <strong>×©×™× ×œ×‘:</strong> ×–×•×”×™ ×”×’×¨×¡×” ×”×™×—×™×“×” ×©×œ ×”×ª×™×§. ××™×Ÿ ×’×¨×¡××•×ª ×§×•×“××•×ª ×œ×”×©×•×•××” ××• ×©×—×–×•×¨.
        ×”×›×¤×ª×•×¨×™× ×©×œ × ×™×”×•×œ ×’×¨×¡××•×ª ×™×•×¦×’×• ××š ×™×”×™×• ××•×©×‘×ª×™×.
      </div>`;
  } else if (allMarkedCurrent) {
    versionsHtml += `
      <div style="color: #ffc107; font-size: 13px; margin-bottom: 15px; background: #332701; padding: 10px; border-radius: 4px; border: 1px solid #ffc107;">
        âš ï¸ <strong>×–×•×”×ª×” ×‘×¢×™×”:</strong> ×›×œ ×”×’×¨×¡××•×ª ××¡×•×× ×•×ª ×›"× ×•×›×—×™×•×ª" ×‘××¡×“ ×”× ×ª×•× ×™×. 
        ×”××¢×¨×›×ª ×ª×©×ª××© ×‘×’×¨×¡×” ×”××—×¨×•× ×” (×”×¨××©×•× ×” ×‘×¨×©×™××”) ×›×’×¨×¡×” ×”× ×•×›×—×™×ª.
        <br><a href="fix-is-current.html" target="_blank" style="color: #ffc107;">×œ×—×¥ ×›××Ÿ ×œ×ª×™×§×•×Ÿ ×”×‘×¢×™×”</a>
      </div>`;
  }
  
  versions.forEach((version, index) => {
    // PHASE 4 FIX: Determine current version by position (first in list) as a fallback
    // If all versions have is_current = true (database issue), only treat the first as current
    const allVersionsMarkedCurrent = versions.every(v => v.is_current === true || v.is_current === 'true' || v.is_current === 1);
    
    let isCurrentVersion;
    if (allVersionsMarkedCurrent) {
      console.log('âš ï¸ PHASE 4: All versions marked as current - using position-based logic');
      isCurrentVersion = index === 0; // Only first (most recent) is current
    } else {
      isCurrentVersion = version.is_current === true || version.is_current === 'true' || version.is_current === 1;
    }
    const versionDate = formatDateWithTime(version.updated_at);
    const timeAgo = getTimeAgo(new Date(version.updated_at));
    const dayName = getDayName(new Date(version.updated_at));
    
    console.log('ğŸ”§ PROCESSING VERSION:', version.helper_name, 'isCurrent:', isCurrentVersion);
    console.log('ğŸ”§ Should show 5 buttons?', !isCurrentVersion);
    console.log('ğŸ”§ Raw version.is_current value:', version.is_current);
    console.log('ğŸ”§ Type of is_current:', typeof version.is_current);
    console.log('ğŸ”§ Version full object:', JSON.stringify(version, null, 2));
    console.log('ğŸ”§ Strict equality check: version.is_current === true?', version.is_current === true);
    console.log('ğŸ”§ Strict equality check: version.is_current === false?', version.is_current === false);
    console.log('ğŸ”§ Truthy check: !!version.is_current?', !!version.is_current);
    
    versionsHtml += `
      <div style="background: ${isCurrentVersion ? '#0f2419' : '#2a2a2a'}; border: 1px solid ${isCurrentVersion ? '#28a745' : '#555'}; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
              <h4 style="margin: 0; color: ${isCurrentVersion ? '#28a745' : '#ff6b35'}; font-size: 16px;">
                ${isCurrentVersion ? 'ğŸ“Œ ×”×’×¨×¡×” ×”× ×•×›×—×™×ª' : `ğŸ“… ${dayName}`}
              </h4>
              ${isCurrentVersion ? '<span style="background: #28a745; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px;">×¢×•×‘×“ ×¢×œ×™×” ×¢×›×©×™×•</span>' : ''}
            </div>
            
            <div style="font-size: 14px; color: #e0e0e0; margin-bottom: 8px;">
              <div style="margin-bottom: 4px;"><strong>ğŸ“… ×ª××¨×™×š ×•×©×¢×”:</strong> ${versionDate}</div>
              <div style="margin-bottom: 4px;"><strong>â° ×œ×¤× ×™:</strong> ${timeAgo}</div>
              <div><strong>ğŸ’¾ × ×©××¨:</strong> ${getSourceDisplayForUser(version.source)}</div>
            </div>
          </div>
        </div>
        
        <div style="display: flex; gap: 8px; justify-content: flex-start; flex-wrap: wrap; border-top: 1px solid #444; padding-top: 10px;">
          <!-- PHASE 4 BUTTONS START - Should show 5 buttons total -->
          <button onclick="previewVersionForUser('${version.id}', '${dayName}', '${versionDate}')" 
                  style="padding: 8px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; font-size: 13px; cursor: pointer;">
            ğŸ‘ï¸ ×¨××” ××” ×”×™×” ×‘×ª×™×§
          </button>
          <button onclick="downloadVersionReportForUser('${version.id}', '${case_.plate}', '${dayName}')" 
                  style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 13px; cursor: pointer;">
            ğŸ“„ ×”×•×¨×“ ×›×§×•×‘×¥
          </button>
          ${!isCurrentVersion ? `
            <button onclick="confirmRestoreVersion('${version.id}', '${dayName}', '${versionDate}', '${case_.plate}')" 
                    style="padding: 8px 12px; background: #ffc107; color: black; border: none; border-radius: 4px; font-size: 13px; cursor: pointer; font-weight: bold;">
              ğŸ”„ ×—×–×•×¨ ×œ×ª××¨×™×š ×–×”
            </button>
            <button onclick="loadVersionToCurrentHelper('${version.id}', '${dayName}', '${case_.plate}')" 
                    style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 13px; cursor: pointer;">
              ğŸ“¥ ×˜×¢×Ÿ ×œ×¢×‘×•×“×” × ×•×›×—×™×ª
            </button>
            <button onclick="compareVersionWithCurrent('${version.id}', '${dayName}', '${case_.plate}')" 
                    style="padding: 8px 12px; background: #6f42c1; color: white; border: none; border-radius: 4px; font-size: 13px; cursor: pointer;">
              ğŸ†š ×”×©×•×•×” ×œ× ×•×›×—×™
            </button>
          ` : hasOnlyOneVersion ? `
            <!-- PHASE 4: Show disabled buttons when only one version exists -->
            <button disabled title="××™×Ÿ ×’×¨×¡××•×ª ×§×•×“××•×ª ×œ×©×—×–×•×¨" 
                    style="padding: 8px 12px; background: #6c757d; color: #ccc; border: none; border-radius: 4px; font-size: 13px; cursor: not-allowed; opacity: 0.5;">
              ğŸ”„ ×—×–×•×¨ ×œ×ª××¨×™×š ×–×”
            </button>
            <button disabled title="××™×Ÿ ×’×¨×¡××•×ª ×§×•×“××•×ª ×œ×˜×¢×™× ×”" 
                    style="padding: 8px 12px; background: #6c757d; color: #ccc; border: none; border-radius: 4px; font-size: 13px; cursor: not-allowed; opacity: 0.5;">
              ğŸ“¥ ×˜×¢×Ÿ ×œ×¢×‘×•×“×” × ×•×›×—×™×ª
            </button>
            <button disabled title="××™×Ÿ ×’×¨×¡××•×ª ×œ×”×©×•×•××”" 
                    style="padding: 8px 12px; background: #6c757d; color: #ccc; border: none; border-radius: 4px; font-size: 13px; cursor: not-allowed; opacity: 0.5;">
              ğŸ†š ×”×©×•×•×” ×œ× ×•×›×—×™
            </button>
            <div style="margin-top: 8px; font-size: 11px; color: #999;">
              ×¤×¢×•×œ×•×ª ×’×¨×¡××•×ª ×œ× ×–××™× ×•×ª - ×–×•×”×™ ×”×’×¨×¡×” ×”×™×—×™×“×”
            </div>
          ` : ''}
        </div>
      </div>`;
  });
  
  versionsListDiv.innerHTML = versionsHtml;
  resultsDiv.style.display = 'block';
}

// Helper functions - user-friendly versions
function getDayName(date) {
  const days = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
  const today = new Date();
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);
  
  if (date.toDateString() === today.toDateString()) {
    return '×”×™×•×';
  } else if (date.toDateString() === yesterday.toDateString()) {
    return '××ª××•×œ';
  } else {
    return `×™×•× ${days[date.getDay()]}`;
  }
}

function getSourceDisplayForUser(source) {
  const displays = {
    'system': '××•×˜×•××˜×™×ª ×¢×œ ×™×“×™ ×”××¢×¨×›×ª',
    'realtime_test': '×‘××”×œ×š ×‘×“×™×§×”',
    'version_restore': '×©×•×—×–×¨ ××’×™×‘×•×™ ×§×•×“×',
    'manual': '× ×©××¨ ×™×“× ×™×ª',
    'dual_write': '× ×©××¨ ×‘××”×œ×š ×”×¢×‘×•×“×”'
  };
  return displays[source] || '×¢×œ ×™×“×™ ×”××¢×¨×›×ª';
}

// User-friendly preview function
window.previewVersionForUser = async function(versionId, dayName, versionDate) {
  try {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/case_helper?id=eq.${versionId}`, {
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      }
    });
    
    const versions = await response.json();
    if (!versions || versions.length === 0) {
      alert('×œ× ×”×¦×œ×—×ª×™ ×œ×˜×¢×•×Ÿ ××ª ×”×’×™×‘×•×™');
      return;
    }
    
    const version = versions[0];
    console.log('ğŸ”§ PREVIEW: Raw helper_json structure:', Object.keys(version.helper_json || {}));
    console.log('ğŸ”§ PREVIEW: Has helper_data wrapper?', !!(version.helper_json?.helper_data));
    
    // Get case ID for Supabase queries
    const caseId = version.case_id || version.helper_json?.meta?.caseId || version.helper_json?.case_info?.id;
    
    // Perform Supabase queries for additional data
    let supabaseData = {
      hasParts: false,
      hasInvoice: false,
      feeStatus: '×œ× ×–××™×Ÿ'
    };
    
    // Skip Supabase queries for now since these tables don't exist yet
    // This prevents 404 errors in the console
    // TODO: Enable these queries when Phase 5 tables are created
    
    /*
    if (caseId) {
      try {
        // Check for parts - will be enabled when selected_parts table is created
        const partsResponse = await fetch(`${SUPABASE_URL}/rest/v1/selected_parts?case_id=eq.${caseId}&limit=1`, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          }
        });
        if (partsResponse.ok) {
          const partsData = await partsResponse.json();
          supabaseData.hasParts = partsData && partsData.length > 0;
        }
        
        // Check for invoice - will be enabled when invoices table is created
        const invoiceResponse = await fetch(`${SUPABASE_URL}/rest/v1/invoices?case_id=eq.${caseId}&limit=1`, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          }
        });
        if (invoiceResponse.ok) {
          const invoiceData = await invoiceResponse.json();
          supabaseData.hasInvoice = invoiceData && invoiceData.length > 0;
        }
        
        // Check for fee payment status - will be enabled when fees table is created
        const feeResponse = await fetch(`${SUPABASE_URL}/rest/v1/fees?case_id=eq.${caseId}&select=payment_status&limit=1`, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          }
        });
        if (feeResponse.ok) {
          const feeData = await feeResponse.json();
          if (feeData && feeData.length > 0) {
            supabaseData.feeStatus = feeData[0].payment_status === 'paid' ? '×©×•×œ×' : '×œ× ×©×•×œ×';
          }
        }
      } catch (error) {
        console.error('Error fetching Supabase data:', error);
      }
    }
    */
    
    const readableContent = generateUserFriendlyReport(version.helper_json, supabaseData);
    
    // Create user-friendly modal
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.8); z-index: 1000; display: flex; 
      justify-content: center; align-items: center; direction: rtl;
    `;
    
    modal.innerHTML = `
      <div style="background: #2a2a2a; padding: 20px; border-radius: 10px; max-width: 80%; max-height: 80%; overflow-y: auto; color: #e0e0e0; border: 2px solid #17a2b8;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #555; padding-bottom: 10px;">
          <h3 style="color: #17a2b8; margin: 0;">ğŸ‘ï¸ ××™×š × ×¨××” ×”×ª×™×§ ${dayName}</h3>
          <button onclick="document.body.removeChild(this.parentElement.parentElement.parentElement)" 
                  style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">
            âœ• ×¡×’×•×¨
          </button>
        </div>
        <div style="color: #ccc; font-size: 12px; margin-bottom: 15px; text-align: center;">
          × ×©××¨ ×‘: ${versionDate}
        </div>
        <div style="background: #1a1a1a; padding: 15px; border-radius: 5px; white-space: pre-wrap; font-family: Arial, sans-serif; font-size: 13px; line-height: 1.5; max-height: 60vh; overflow-y: auto;">
${readableContent.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
  } catch (error) {
    alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×’×™×‘×•×™: ' + error.message);
  }
};

// User-friendly download function
window.downloadVersionReportForUser = async function(versionId, plate, dayName) {
  try {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/case_helper?id=eq.${versionId}`, {
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      }
    });
    
    const versions = await response.json();
    if (!versions || versions.length === 0) {
      alert('×œ× ×”×¦×œ×—×ª×™ ×œ×˜×¢×•×Ÿ ××ª ×”×’×™×‘×•×™');
      return;
    }
    
    const version = versions[0];
    const readableContent = generateUserFriendlyReport(version.helper_json);
    
    // Create and download file
    const blob = new Blob([readableContent], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const dateStr = new Date().toISOString().split('T')[0];
    a.download = `×ª×™×§_${plate}_×’×™×‘×•×™_${dayName}_${dateStr}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert(`×”×§×•×‘×¥ ×”×•×¨×“ ×‘×”×¦×œ×—×”!`);
    
  } catch (error) {
    alert('×©×’×™××” ×‘×”×•×¨×“×ª ×”×§×•×‘×¥: ' + error.message);
  }
};

// User-friendly confirmation for restore
window.confirmRestoreVersion = async function(versionId, dayName, versionDate, plate) {
  const confirmed = confirm(
    `×”×× ××ª×” ×‘×˜×•×— ×©××ª×” ×¨×•×¦×” ×œ×—×–×•×¨ ×œ××™×š ×©×”×ª×™×§ × ×¨××” ${dayName}?\n\n` +
    `×ª××¨×™×š ×”×’×™×‘×•×™: ${versionDate}\n` +
    `×ª×™×§: ${plate}\n\n` +
    `×–×” ×™×©××•×¨ ××ª ×”×¢×‘×•×“×” ×”× ×•×›×—×™×ª ×•×™×—×–×•×¨ ××•×ª×š ×œ× ×§×•×“×ª ×”×–××Ÿ ×”×–×•.\n` +
    `×ª×•×›×œ ×ª××™×“ ×œ×—×–×•×¨ ×œ×’×¨×¡×” ×”× ×•×›×—×™×ª ××—×¨ ×›×š.\n\n` +
    `×œ×”××©×™×š?`
  );
  
  if (!confirmed) return;
  
  try {
    showVersionStatus('××—×–×™×¨ ×’×¨×¡×” ×-' + dayName + '...', 'loading');
    
    // Step 1: Get the version data with case_id
    const versionResponse = await fetch(`${SUPABASE_URL}/rest/v1/case_helper?id=eq.${versionId}&select=helper_json,version,helper_name,case_id`, {
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      }
    });
    
    if (!versionResponse.ok) {
      throw new Error('×©×’×™××” ×‘×©×œ×™×¤×ª × ×ª×•× ×™ ×”×’×¨×¡×”');
    }
    
    const versionData = await versionResponse.json();
    if (!versionData || versionData.length === 0) {
      throw new Error('×œ× × ××¦××• × ×ª×•× ×™ ×’×¨×¡×”');
    }
    
    const versionHelper = versionData[0];
    const caseId = versionHelper.case_id || window.currentCaseId;
    
    // Step 2: Create backup of current version
    showVersionStatus('×™×•×¦×¨ ×’×™×‘×•×™ ×©×œ ×”×’×¨×¡×” ×”× ×•×›×—×™×ª...', 'loading');
    
    const currentTime = new Date().toISOString();
    const backupResponse = await fetch(`${SUPABASE_URL}/rest/v1/case_helper`, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      },
      body: JSON.stringify({
        case_id: caseId,
        helper_name: `${plate}_backup_${Date.now()}`,
        helper_json: window.helper || {},
        version: Date.now(),
        is_current: false,
        source: 'admin_backup',
        updated_at: currentTime
      })
    });
    
    if (!backupResponse.ok) {
      console.warn('âš ï¸ Failed to create backup, continuing with restore...');
    }
    
    // Step 3: Update current helper to the restored version
    showVersionStatus('××¢×“×›×Ÿ ××ª ×”×’×¨×¡×” ×”× ×•×›×—×™×ª...', 'loading');
    
    // First, set all versions to is_current = false
    await fetch(`${SUPABASE_URL}/rest/v1/case_helper?case_id=eq.${caseId}`, {
      method: 'PATCH',
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ is_current: false })
    });
    
    // Create new current version from restored data
    const restoreResponse = await fetch(`${SUPABASE_URL}/rest/v1/case_helper`, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      },
      body: JSON.stringify({
        case_id: window.currentCaseId,
        helper_name: `${plate}_restored_${Date.now()}`,
        helper_json: versionHelper.helper_json,
        version: Date.now(),
        is_current: true,
        source: 'admin_restore',
        updated_at: currentTime
      })
    });
    
    if (!restoreResponse.ok) {
      throw new Error('×©×’×™××” ×‘×©×—×–×•×¨ ×”×’×¨×¡×”');
    }
    
    // Step 4: Update global helper and notify UI
    let restoredHelper = versionHelper.helper_json;
    
    // Unwrap helper_data if needed
    if (restoredHelper.helper_data && typeof restoredHelper.helper_data === 'object') {
      restoredHelper = restoredHelper.helper_data;
    }
    
    window.helper = restoredHelper;
    
    // Dispatch event for UI modules
    const restoreEvent = new CustomEvent('helperDataRestored', {
      detail: { helper: restoredHelper, source: 'admin_restore', fromDate: versionDate }
    });
    document.dispatchEvent(restoreEvent);
    
    showVersionStatus(`âœ… ×”×’×¨×¡×” ×©×•×—×–×¨×” ×‘×”×¦×œ×—×” ×-${dayName}`, 'success');
    
    // Show success confirmation
    alert(`×”×’×¨×¡×” ×©×•×—×–×¨×” ×‘×”×¦×œ×—×”!\n\n×”×ª×™×§ ×—×–×¨ ×œ××¦×‘ ×©×‘×• ×”×™×” ${dayName}\n×’×™×‘×•×™ ×©×œ ×”×’×¨×¡×” ×”×§×•×“××ª × ×©××¨ ××•×˜×•××˜×™×ª\n\n×”×“×£ ×™×˜×¢×Ÿ ××—×“×© ×›×“×™ ×œ×”×¦×™×’ ××ª ×”× ×ª×•× ×™× ×”××©×•×—×–×¨×™×.`);
    
    // Refresh the page to show restored data
    setTimeout(() => {
      window.location.reload();
    }, 2000);
    
  } catch (error) {
    console.error('âŒ Restore error:', error);
    showVersionStatus(`âŒ ×©×’×™××” ×‘×©×—×–×•×¨: ${error.message}`, 'error');
  }
};

// Load version to current helper (merge without restore)
window.loadVersionToCurrentHelper = async function(versionId, dayName, plate) {
  const confirmed = confirm(
    `×”×× ××ª×” ×¨×•×¦×” ×œ×˜×¢×•×Ÿ × ×ª×•× ×™× ×-${dayName} ×œ×¢×‘×•×“×” ×”× ×•×›×—×™×ª?\n\n` +
    `×–×” ×™×•×¡×™×£ ××ª ×”× ×ª×•× ×™× ××”×ª××¨×™×š ×”×–×” ×œ×¢×‘×•×“×” ×”× ×•×›×—×™×ª ×©×œ×š,\n` +
    `××‘×œ×™ ×œ××—×•×§ ××ª ××” ×©×›×‘×¨ ×¢×©×™×ª.\n\n` +
    `×œ×”××©×™×š?`
  );
  
  if (!confirmed) return;
  
  try {
    showVersionStatus(`×˜×•×¢×Ÿ × ×ª×•× ×™× ×-${dayName}...`, 'loading');
    
    // Get the version data
    const response = await fetch(`${SUPABASE_URL}/rest/v1/case_helper?id=eq.${versionId}&select=helper_json`, {
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      }
    });
    
    if (!response.ok) {
      throw new Error('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”×’×¨×¡×”');
    }
    
    const data = await response.json();
    if (!data || data.length === 0) {
      throw new Error('×œ× × ××¦××• × ×ª×•× ×™× ×œ×˜×¢×™× ×”');
    }
    
    let versionHelper = data[0].helper_json;
    
    // Unwrap helper_data if needed
    if (versionHelper.helper_data && typeof versionHelper.helper_data === 'object') {
      versionHelper = versionHelper.helper_data;
    }
    
    // Merge with current helper (preserving current work)
    if (!window.helper) {
      window.helper = {};
    }
    
    // Smart merge - only add missing data
    mergeHelperData(window.helper, versionHelper);
    
    // Update sessionStorage with merged helper - use both keys for compatibility
    try {
      sessionStorage.setItem('currentHelper', JSON.stringify(window.helper));
      sessionStorage.setItem('helper', JSON.stringify(window.helper)); // PHASE 4 FIX: Also save to 'helper' key
      sessionStorage.setItem('lastHelperUpdate', new Date().toISOString());
      sessionStorage.setItem('helperName', window.helper.plate ? `${window.helper.plate}_helper_v1` : 'helper');
      console.log('âœ… Helper saved to sessionStorage after version load (both keys)');
    } catch (e) {
      console.error('Failed to save helper to sessionStorage:', e);
    }
    
    // Dispatch event for UI update
    const loadEvent = new CustomEvent('helperDataLoaded', {
      detail: { helper: window.helper, source: 'admin_load', fromDate: dayName }
    });
    document.dispatchEvent(loadEvent);
    
    // Also dispatch storage event for cross-module communication
    window.dispatchEvent(new StorageEvent('storage', {
      key: 'currentHelper',
      newValue: JSON.stringify(window.helper),
      url: window.location.href
    }));
    
    // PHASE 4 FIX: Also dispatch for 'helper' key
    window.dispatchEvent(new StorageEvent('storage', {
      key: 'helper',
      newValue: JSON.stringify(window.helper),
      url: window.location.href
    }));
    
    showVersionStatus(`âœ… × ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×” ×-${dayName}`, 'success');
    alert(`× ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×” ×-${dayName}!\n\n×”× ×ª×•× ×™× × ×•×¡×¤×• ×œ×¢×‘×•×“×” ×”× ×•×›×—×™×ª ×©×œ×š.\n×›×“×™ ×œ×¨××•×ª ××ª ×”×©×™× ×•×™×™× ×‘××•×“×•×œ×™× ××—×¨×™×, ×™×© ×œ×¨×¢× ×Ÿ ××ª ×”×“×£.`);
    
  } catch (error) {
    console.error('âŒ Load error:', error);
    showVersionStatus(`âŒ ×©×’×™××” ×‘×˜×¢×™× ×”: ${error.message}`, 'error');
  }
};

// Compare version with current helper
window.compareVersionWithCurrent = async function(versionId, dayName, plate) {
  try {
    showVersionStatus(`×™×•×¦×¨ ×”×©×•×•××” ×¢× ${dayName}...`, 'loading');
    
    // Get the version data
    const response = await fetch(`${SUPABASE_URL}/rest/v1/case_helper?id=eq.${versionId}&select=helper_json,updated_at`, {
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      }
    });
    
    if (!response.ok) {
      throw new Error('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”×’×¨×¡×”');
    }
    
    const data = await response.json();
    if (!data || data.length === 0) {
      throw new Error('×œ× × ××¦××• × ×ª×•× ×™× ×œ×”×©×•×•××”');
    }
    
    let versionHelper = data[0].helper_json;
    
    // Unwrap helper_data if needed
    if (versionHelper.helper_data && typeof versionHelper.helper_data === 'object') {
      versionHelper = versionHelper.helper_data;
    }
    
    const currentHelper = window.helper || {};
    const comparison = generateComparisonReport(currentHelper, versionHelper, dayName);
    
    showVersionStatus(`âœ… ×”×©×•×•××” ×”×•×©×œ××”`, 'success');
    
    // Show comparison in modal
    showComparisonModal(comparison, dayName);
    
  } catch (error) {
    console.error('âŒ Comparison error:', error);
    showVersionStatus(`âŒ ×©×’×™××” ×‘×”×©×•×•××”: ${error.message}`, 'error');
  }
};

// Helper function to merge helper data intelligently
function mergeHelperData(current, version) {
  for (const key in version) {
    if (version.hasOwnProperty(key)) {
      if (!current[key] || (typeof current[key] === 'object' && Object.keys(current[key]).length === 0)) {
        // Current is empty or doesn't exist - take from version
        current[key] = JSON.parse(JSON.stringify(version[key]));
      } else if (typeof current[key] === 'object' && typeof version[key] === 'object') {
        // Both are objects - merge recursively
        mergeHelperData(current[key], version[key]);
      }
      // If current has data and version has data, keep current (preserve work)
    }
  }
}

// Generate comparison report
function generateComparisonReport(current, version, dayName) {
  const differences = [];
  const sections = ['vehicle', 'damage_assessment', 'final_report', 'case_info'];
  
  sections.forEach(section => {
    const currentData = current[section] || {};
    const versionData = version[section] || {};
    
    if (JSON.stringify(currentData) !== JSON.stringify(versionData)) {
      differences.push({
        section,
        current: currentData,
        version: versionData,
        hasCurrentData: Object.keys(currentData).length > 0,
        hasVersionData: Object.keys(versionData).length > 0
      });
    }
  });
  
  return { differences, dayName, totalSections: sections.length };
}

// Show comparison modal
function showComparisonModal(comparison, dayName) {
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
    background: rgba(0,0,0,0.8); z-index: 10000; 
    display: flex; align-items: center; justify-content: center;
    direction: rtl; font-family: Arial, sans-serif;
  `;
  
  const content = document.createElement('div');
  content.style.cssText = `
    background: #2a2a2a; color: #e0e0e0; padding: 30px; 
    border-radius: 12px; max-width: 80vw; max-height: 80vh; 
    overflow-y: auto; border: 2px solid #6f42c1;
  `;
  
  let html = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 style="color: #6f42c1; margin: 0;">ğŸ†š ×”×©×•×•××”: × ×•×›×—×™ ×œ×¢×•××ª ${dayName}</h2>
      <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" 
              style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">
        âœ–ï¸ ×¡×’×•×¨
      </button>
    </div>
  `;
  
  if (comparison.differences.length === 0) {
    html += `<p style="color: #28a745; font-size: 18px;">âœ… ××™×Ÿ ×”×‘×“×œ×™× - ×”×’×¨×¡××•×ª ×–×”×•×ª!</p>`;
  } else {
    html += `<p style="margin-bottom: 20px;">× ××¦××• ${comparison.differences.length} ×”×‘×“×œ×™× ××ª×•×š ${comparison.totalSections} ××§×˜×’×•×ª:</p>`;
    
    comparison.differences.forEach((diff, index) => {
      html += `
        <div style="background: #1a1a1a; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #444;">
          <h3 style="color: #17a2b8; margin-top: 0;">ğŸ“ ${getSectionName(diff.section)}</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <h4 style="color: #28a745; margin-bottom: 10px;">ğŸŸ¢ ×’×¨×¡×” × ×•×›×—×™×ª:</h4>
              <div style="background: #0d4b0d; padding: 10px; border-radius: 4px; font-size: 12px; white-space: pre-wrap;">${diff.hasCurrentData ? JSON.stringify(diff.current, null, 2) : '××™×Ÿ × ×ª×•× ×™×'}</div>
            </div>
            <div>
              <h4 style="color: #ffc107; margin-bottom: 10px;">ğŸŸ¡ ×’×¨×¡×” ×-${dayName}:</h4>
              <div style="background: #4b3d00; padding: 10px; border-radius: 4px; font-size: 12px; white-space: pre-wrap;">${diff.hasVersionData ? JSON.stringify(diff.version, null, 2) : '××™×Ÿ × ×ª×•× ×™×'}</div>
            </div>
          </div>
        </div>
      `;
    });
  }
  
  content.innerHTML = html;
  modal.appendChild(content);
  document.body.appendChild(modal);
}

// Get Hebrew section names
function getSectionName(section) {
  const names = {
    vehicle: '×¤×¨×˜×™ ×¨×›×‘',
    damage_assessment: '×”×¢×¨×›×ª × ×–×§×™×',
    final_report: '×“×•×— ×¡×•×¤×™',
    case_info: '××™×“×¢ ×›×œ×œ×™'
  };
  return names[section] || section;
}

// Generate professional case status snapshot using ACTUAL VALIDATION LOGS
function generateUserFriendlyReport(helper, supabaseData = {}) {
  // ğŸ”§ PHASE 4 FIX: Unwrap helper_data if it exists
  let unwrappedHelper = helper;
  if (helper && helper.helper_data && typeof helper.helper_data === 'object') {
    console.log('ğŸ”§ PREVIEW: Unwrapping helper_data structure for display');
    unwrappedHelper = helper.helper_data;
  }
  
  console.log('ğŸ”§ VALIDATION SCAN: Scanning helper for validation logs...');
  console.log('ğŸ”§ VALIDATION SCAN: Helper structure:', Object.keys(unwrappedHelper || {}));
  
  let report = '';
  
  // Extract case ID for Supabase queries
  const caseId = unwrappedHelper.meta?.caseId || unwrappedHelper.case_info?.id || null;
  
  // Determine case status based on workflow completion
  const workflowStatus = analyzeWorkflowValidations(unwrappedHelper, caseId);
  let caseStatus = '×¤×ª×•×—';
  if (workflowStatus.completionPercentage === 100) {
    caseStatus = '×”×•×©×œ×';
  } else if (workflowStatus.completionPercentage >= 80) {
    caseStatus = '×›××¢×˜ ×”×•×©×œ×';
  } else if (workflowStatus.completionPercentage >= 50) {
    caseStatus = '×‘×˜×™×¤×•×œ ××ª×§×“×';
  } else if (workflowStatus.validatedCount > 0) {
    caseStatus = '×‘×˜×™×¤×•×œ';
  }
  
  // Professional Header with actual status
  report += `ğŸ“‹ ××¦×‘ ×”×ª×™×§: ${caseStatus}\n`;
  report += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
  
  // ğŸš— VEHICLE ID TABLE (from validation data)
  const vehicleData = extractVehicleFromValidation(unwrappedHelper);
  
  report += `ğŸš— ×¤×¨×˜×™ ×”×¨×›×‘:\n`;
  report += `â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n`;
  report += `â”‚ ××¡×¤×¨ ×¨×›×‘: ${vehicleData.plate.toString().padEnd(20)} â”‚\n`;
  report += `â”‚ ×™×¦×¨×Ÿ:     ${vehicleData.make.toString().padEnd(20)} â”‚\n`;
  report += `â”‚ ×“×’×:      ${vehicleData.model.toString().padEnd(20)} â”‚\n`;
  report += `â”‚ ×©× ×”:      ${vehicleData.year.toString().padEnd(20)} â”‚\n`;
  report += `â”‚ ×‘×¢×œ ×”×¨×›×‘: ${vehicleData.ownerName.toString().padEnd(20)} â”‚\n`;
  report += `â”‚ ×ª××¨×™×š ×‘×“×™×§×”: ${vehicleData.inspectionDate.toString().padEnd(17)} â”‚\n`;
  report += `â”‚ ××•×¡×š:      ${vehicleData.garageName.toString().padEnd(20)} â”‚\n`;
  report += `â”‚ ×—×‘×¨×ª ×‘×™×˜×•×—: ${vehicleData.insuranceCompany.toString().padEnd(18)} â”‚\n`;
  report += `â”‚ ×¡×•×›×Ÿ:      ${vehicleData.agentName.toString().padEnd(20)} â”‚\n`;
  report += `â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\n`;
  
  // ğŸ“Š WORKFLOW STATUS (based on ACTUAL validations)
  report += `ğŸ“Š ××¦×‘ ×–×¨×™××ª ×”×¢×‘×•×“×”:\n`;
  report += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
  
  // workflowStatus already declared above, no need to redeclare
  
  // Update Supabase stages with actual data
  workflowStatus.stages.forEach(stage => {
    if (stage.requiresSupabase && supabaseData) {
      if (stage.supabaseCheck === 'parts') {
        stage.validated = supabaseData.hasParts;
        stage.started = supabaseData.hasParts;
      } else if (stage.supabaseCheck === 'invoice') {
        stage.validated = supabaseData.hasInvoice;
        stage.started = supabaseData.hasInvoice;
      } else if (stage.supabaseCheck === 'fee') {
        stage.validated = supabaseData.feeStatus === '×©×•×œ×';
        stage.started = supabaseData.feeStatus !== '×œ× ×–××™×Ÿ';
        if (stage.started) {
          stage.details = supabaseData.feeStatus;
        }
      }
    }
  });
  
  // Recalculate completion percentage with updated data
  const validatedCount = workflowStatus.stages.filter(s => s.validated).length;
  const completionPercentage = Math.round((validatedCount / workflowStatus.stages.length) * 100);
  workflowStatus.completionPercentage = completionPercentage;
  
  // Show each workflow stage with validation status
  workflowStatus.stages.forEach(stage => {
    const icon = stage.validated ? 'âœ…' : stage.started ? 'ğŸ”„' : 'â³';
    const status = stage.validated ? '×”×•×©×œ× ×•××•××ª' : stage.started ? '×‘×ª×”×œ×™×š' : '×œ× ×”×ª×—×™×œ';
    const date = stage.validationDate ? ` (${stage.validationDate})` : '';
    
    report += `${icon} ${stage.name}: ${status}${date}\n`;
    
    if (stage.details) {
      report += `   ${stage.details}\n`;
    }
  });
  
  report += `\n××—×•×– ×”×©×œ××”: ${workflowStatus.completionPercentage}%\n\n`;
  
  // ğŸ’° FINANCIAL SUMMARY (from validation logs)
  const financialSummary = extractFinancialFromValidations(unwrappedHelper);
  if (financialSummary.hasData) {
    report += `ğŸ’° ×¡×™×›×•× ×›×¡×¤×™:\n`;
    report += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
    
    if (financialSummary.estimateTotal) {
      report += `××•××“×Ÿ ×××•××ª: â‚ª${Number(financialSummary.estimateTotal).toLocaleString('he-IL')}\n`;
      if (financialSummary.estimateDate) {
        report += `   ×ª××¨×™×š ××™×©×•×¨: ${financialSummary.estimateDate}\n`;
      }
    }
    
    if (financialSummary.finalTotal) {
      report += `×¡×›×•× ×¡×•×¤×™: â‚ª${Number(financialSummary.finalTotal).toLocaleString('he-IL')}\n`;
      if (financialSummary.finalDate) {
        report += `   ×ª××¨×™×š ××™×©×•×¨: ${financialSummary.finalDate}\n`;
      }
    }
    
    if (financialSummary.depreciationAmount) {
      report += `×¤×—×ª: â‚ª${Number(financialSummary.depreciationAmount).toLocaleString('he-IL')}\n`;
    }
    
    report += `\n`;
  } else {
    report += `ğŸ’° ××¦×‘ ×›×¡×¤×™: ×˜×¨× ×”×•×©×œ××• ×—×™×©×•×‘×™× ×›×¡×¤×™×™×\n\n`;
  }
  
  // ğŸ¥ GENERAL HEALTH ASSESSMENT
  // Use updated workflow status with recalculated percentage
  workflowStatus.validatedCount = validatedCount;
  workflowStatus.completionPercentage = completionPercentage;
  const healthAssessment = calculateHealthAssessment(workflowStatus, unwrappedHelper);
  
  report += `ğŸ¥ ×”×¢×¨×›×ª ×‘×¨×™××•×ª ×”×ª×™×§:\n`;
  report += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
  report += `${healthAssessment}\n\n`;
  
  // ğŸ“„ REPORTS STATUS (from actual validation logs)
  const reportsStatus = analyzeReportsValidations(unwrappedHelper);
  
  report += `ğŸ“„ ×¡×˜×˜×•×¡ ×“×•×—×•×ª:\n`;
  report += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
  
  reportsStatus.forEach(reportItem => {
    const icon = reportItem.validated ? 'âœ…' : reportItem.generated ? 'ğŸ“„' : 'â³';
    const status = reportItem.validated ? '××•××ª ×•××•×›×Ÿ' : reportItem.generated ? '×”×•×¤×§ (×˜×¨× ××•××ª)' : '×œ× ×”×•×¤×§';
    const date = reportItem.date ? ` (${reportItem.date})` : '';
    
    report += `${icon} ${reportItem.name}: ${status}${date}\n`;
  });
  
  report += `\n`;
  
  // ğŸ“… TIMELINE (from validation timestamps)
  const caseCreatedDate = unwrappedHelper.case_info?.created_at || 
                          unwrappedHelper.meta?.created_at || 
                          unwrappedHelper.case_info?.inspection_date ||
                          unwrappedHelper.created_at;
  
  report += `ğŸ“… ×œ×•×— ×–×× ×™×:\n`;
  report += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
  
  if (caseCreatedDate) {
    const created = new Date(caseCreatedDate);
    const now = new Date();
    const diffMs = now - created;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const diffWeeks = Math.floor(diffDays / 7);
    const diffMonths = Math.floor(diffDays / 30);
    
    let duration = '';
    if (diffMonths > 0) {
      duration = `${diffMonths} ×—×•×“×©×™× ×•-${diffDays % 30} ×™××™×`;
    } else if (diffWeeks > 0) {
      duration = `${diffWeeks} ×©×‘×•×¢×•×ª ×•-${diffDays % 7} ×™××™×`;
    } else {
      duration = `${diffDays} ×™××™×`;
    }
    
    report += `× ×¤×ª×—: ${created.toLocaleDateString('he-IL')}\n`;
    report += `××©×š ×˜×™×¤×•×œ: ${duration}\n`;
  } else {
    report += `×œ× × ××¦× ×ª××¨×™×š ×¤×ª×™×—×”\n`;
  }
  
  report += `\nğŸ“Š ×“×•×— × ×•×¦×¨: ${new Date().toLocaleString('he-IL')}`;
  
  return report;
}

// VALIDATION SCANNING FUNCTIONS - Extract real workflow status

// Extract vehicle data from validation sources
function extractVehicleFromValidation(helper) {
  console.log('ğŸ”§ VEHICLE SCAN: Looking for vehicle validation data...');
  
  // Look for validation data in multiple locations
  const validationSources = [
    helper.validation_log?.vehicle,
    helper.validations?.vehicle_validation,
    helper.car_details,
    helper.vehicle,
    helper.general_info,
    helper.meta,
    helper.case_info,
    helper.stakeholders
  ].filter(Boolean);
  
  console.log('ğŸ”§ VEHICLE SCAN: Found validation sources:', validationSources.length);
  
  let vehicleData = {
    plate: '×œ× ×–××™×Ÿ',
    make: '×œ× ×–××™×Ÿ', 
    model: '×œ× ×–××™×Ÿ',
    year: '×œ× ×–××™×Ÿ',
    ownerName: '×œ× ×–××™×Ÿ',
    inspectionDate: '×œ× ×–××™×Ÿ',
    garageName: '×œ× ×–××™×Ÿ',
    insuranceCompany: '×œ× ×–××™×Ÿ',
    agentName: '×œ× ×–××™×Ÿ'
  };
  
  validationSources.forEach(source => {
    if (source.plate || source.license_plate) vehicleData.plate = source.plate || source.license_plate;
    if (source.make || source.manufacturer) vehicleData.make = source.make || source.manufacturer;
    if (source.model || source.car_model) vehicleData.model = source.model || source.car_model;
    if (source.year || source.manufacture_year) vehicleData.year = source.year || source.manufacture_year;
  });
  
  // Extract additional fields
  if (helper.case_info?.owner_name || helper.stakeholders?.owner?.name) {
    vehicleData.ownerName = helper.case_info.owner_name || helper.stakeholders.owner.name;
  }
  
  if (helper.case_info?.inspection_date) {
    vehicleData.inspectionDate = new Date(helper.case_info.inspection_date).toLocaleDateString('he-IL');
  } else if (helper.case_info?.created_at) {
    vehicleData.inspectionDate = new Date(helper.case_info.created_at).toLocaleDateString('he-IL');
  }
  
  if (helper.case_info?.garage_name || helper.stakeholders?.garage?.name) {
    vehicleData.garageName = helper.case_info.garage_name || helper.stakeholders.garage.name;
  }
  
  if (helper.case_info?.insurance_company || helper.stakeholders?.insurance?.name) {
    vehicleData.insuranceCompany = helper.case_info.insurance_company || helper.stakeholders.insurance.name;
  } else if (helper.stakeholders?.insurance_company) {
    vehicleData.insuranceCompany = helper.stakeholders.insurance_company.name || helper.stakeholders.insurance_company;
  }
  
  if (helper.case_info?.agent_name || helper.stakeholders?.agent?.name) {
    vehicleData.agentName = helper.case_info.agent_name || helper.stakeholders.agent.name;
  } else if (helper.stakeholders?.insurance_agent) {
    vehicleData.agentName = helper.stakeholders.insurance_agent.name || helper.stakeholders.insurance_agent;
  }
  
  return vehicleData;
}

// Analyze workflow validations to determine real completion status
function analyzeWorkflowValidations(helper, caseId) {
  console.log('ğŸ”§ WORKFLOW SCAN: Analyzing validation logs...');
  
  const stages = [
    {
      name: '×¤×¨×˜×™ ×¨×›×‘',
      validated: checkVehicleValidation(helper),
      started: checkVehicleStarted(helper),
      validationDate: getValidationDate(helper, 'vehicle'),
      details: getVehicleValidationDetails(helper)
    },
    {
      name: '× ×ª×•× ×™ ×œ×•×™ ×™×¦×—×§',
      validated: checkLeviValidation(helper),
      started: checkLeviStarted(helper),
      validationDate: helper.levi_summary?.report_date ? new Date(helper.levi_summary.report_date).toLocaleDateString('he-IL') : null,
      details: getLeviValidationDetails(helper)
    },
    {
      name: '×”×¢×¨×›×ª × ×–×§×™×',
      validated: checkDamageValidation(helper),
      started: checkDamageStarted(helper), 
      validationDate: getValidationDate(helper, 'damage'),
      details: getDamageValidationDetails(helper)
    },
    {
      name: '××•××“×Ÿ ×¢×œ×•×™×•×ª',
      validated: checkCostEstimateValidation(helper),
      started: checkCostEstimateStarted(helper),
      validationDate: getValidationDate(helper, 'cost_estimate'),
      details: getCostEstimateValidationDetails(helper)
    },
    {
      name: '××§×¡×¤×¨×˜×™×–×”',
      validated: checkExpertiseValidation(helper),
      started: checkExpertiseStarted(helper),
      validationDate: getValidationDate(helper, 'expertise'),
      details: getExpertiseValidationDetails(helper)
    },
    {
      name: '× ×ª×•× ×™ ×™×¨×™×“×ª ×¢×¨×š',
      validated: checkDepreciationValidation(helper),
      started: checkDepreciationStarted(helper),
      validationDate: getValidationDate(helper, 'depreciation'),
      details: getDepreciationValidationDetails(helper)
    },
    {
      name: '××•××“×Ÿ ×¨××©×•× ×™',
      validated: checkInitialEstimateValidation(helper),
      started: checkInitialEstimateStarted(helper),
      validationDate: helper.estimate?.validation?.validated_at ? new Date(helper.estimate.validation.validated_at).toLocaleDateString('he-IL') : null,
      details: getInitialEstimateValidationDetails(helper)
    },
    {
      name: '×—×•×•×ª ×“×¢×ª',
      validated: checkFinalReportValidation(helper),
      started: checkFinalReportStarted(helper),
      validationDate: helper.final_report?.validation?.validated_at ? new Date(helper.final_report.validation.validated_at).toLocaleDateString('he-IL') : null,
      details: getFinalReportValidationDetails(helper)
    },
    {
      name: '×‘×“×™×§×ª ×—×œ×§×™×',
      validated: false, // Will be set by Supabase query
      started: false, // Will be set by Supabase query
      validationDate: null,
      details: null,
      requiresSupabase: true,
      supabaseCheck: 'parts'
    },
    {
      name: '×—×©×‘×•× ×™×ª ×ª×™×§×•×Ÿ',
      validated: false, // Will be set by Supabase query
      started: false, // Will be set by Supabase query
      validationDate: null,
      details: null,
      requiresSupabase: true,
      supabaseCheck: 'invoice'
    },
    {
      name: '×©×›×¨ ×˜×¨×—×”',
      validated: false, // Will be set by Supabase query
      started: false, // Will be set by Supabase query
      validationDate: null,
      details: null,
      requiresSupabase: true,
      supabaseCheck: 'fee'
    }
  ];
  
  const validatedCount = stages.filter(s => s.validated).length;
  const completionPercentage = Math.round((validatedCount / stages.length) * 100);
  
  console.log('ğŸ”§ WORKFLOW SCAN: Validation results:', { validatedCount, total: stages.length, completionPercentage });
  
  return {
    stages,
    completionPercentage,
    validatedCount,
    totalStages: stages.length,
    caseId
  };
}

// Validation check functions - read from ACTUAL validation locations

// Define validation functions BEFORE they are used
function checkVehicleValidation(helper) {
  // Check if we have complete vehicle data
  const hasPlate = !!(helper.vehicle?.plate || helper.car_details?.plate || helper.case_info?.plate);
  const hasMake = !!(helper.vehicle?.make || helper.car_details?.manufacturer || helper.case_info?.vehicle_make);
  const hasModel = !!(helper.vehicle?.model || helper.car_details?.model || helper.case_info?.vehicle_model);
  const hasYear = !!(helper.vehicle?.year || helper.car_details?.year || helper.case_info?.vehicle_year);
  
  const isValidated = hasPlate && hasMake && hasModel && hasYear;
  console.log('ğŸ”§ VEHICLE VALIDATION CHECK:', { hasPlate, hasMake, hasModel, hasYear, isValidated });
  return isValidated;
}

function checkVehicleStarted(helper) {
  return !!(helper.car_details || helper.vehicle || helper.general_info || helper.case_info?.vehicle_info);
}

// New validation check functions for additional workflow stages
function checkLeviValidation(helper) {
  // Levi is validated if we have levi_summary with data OR levi_data exists
  const hasLeviSummary = !!(helper.levi_summary && Object.keys(helper.levi_summary).length > 0);
  const hasLeviData = !!(helper.levi_data && Object.keys(helper.levi_data).length > 0);
  const hasLeviInExpertise = !!(helper.expertise?.levi_report);
  
  return hasLeviSummary || hasLeviData || hasLeviInExpertise;
}

function checkLeviStarted(helper) {
  // Check multiple possible locations for Levi data
  return !!(helper.levi_summary || helper.levi_data || helper.leviData || helper.expertise?.levi_report);
}

function getLeviValidationDetails(helper) {
  if (helper.levi_summary?.report_date) {
    return `×ª××¨×™×š ×“×•×—: ${new Date(helper.levi_summary.report_date).toLocaleDateString('he-IL')}`;
  }
  return null;
}

function checkCostEstimateValidation(helper) {
  return !!(helper.damage_assessment?.totals && Object.keys(helper.damage_assessment.totals).length > 0);
}

function checkCostEstimateStarted(helper) {
  return !!(helper.damage_assessment?.totals || helper.estimate_totals || helper.costs);
}

function getCostEstimateValidationDetails(helper) {
  if (helper.damage_assessment?.totals?.total_cost) {
    return `×¡×”"×›: â‚ª${Number(helper.damage_assessment.totals.total_cost).toLocaleString('he-IL')}`;
  }
  return null;
}

function checkDepreciationValidation(helper) {
  return !!(helper.depreciation?.globalDep1 !== undefined && helper.depreciation.globalDep1 !== null);
}

function checkDepreciationStarted(helper) {
  return !!(helper.depreciation || helper.depreciation_data);
}

function getDepreciationValidationDetails(helper) {
  if (helper.depreciation?.globalDep1) {
    return `×™×¨×™×“×ª ×¢×¨×š: ${helper.depreciation.globalDep1}%`;
  }
  return null;
}

function checkInitialEstimateValidation(helper) {
  // Initial estimate is validated if we have totals with actual numbers
  const hasEstimateTotals = !!(helper.estimate?.totals && 
                               typeof helper.estimate.totals === 'object' && 
                               Object.keys(helper.estimate.totals).length > 0);
  const hasValidation = !!(helper.estimate?.validation?.validated_at);
  
  return hasEstimateTotals || hasValidation;
}

function checkInitialEstimateStarted(helper) {
  return !!(helper.estimate || helper.initial_estimate || helper.estimate_totals);
}

function getInitialEstimateValidationDetails(helper) {
  if (helper.estimate?.validation?.validated_at && helper.estimate?.type) {
    return `×¡×•×’ ××•××“×Ÿ: ${helper.estimate.type}`;
  }
  return null;
}

function checkDamageValidation(helper) {
  // Damage is validated if we have damage centers with ACTUAL CONTENT
  const centers = helper.damage_assessment?.centers || [];
  
  // Check if centers have real content, not just empty objects
  const hasValidCenters = centers.length > 0 && centers.every(center => {
    // Check for required fields with actual values
    const hasName = !!(center.name && center.name.trim());
    const hasParts = (center.parts > 0) || (center.parts_count > 0) || (center.partsCount > 0);
    const hasLabor = (center.labor_hours > 0) || (center.work_hours > 0) || (center.laborHours > 0) || (center.workHours > 0);
    
    // A center is valid if it has a name and either parts or labor
    return hasName && (hasParts || hasLabor);
  });
  
  // Also check if we have valid totals
  const totals = helper.damage_assessment?.totals || {};
  const hasValidTotals = (totals.total_cost > 0) || (totals.totalCost > 0) || 
                        (totals.total_parts > 0) || (totals.total_labor > 0);
  
  // Damage is validated if we have valid centers AND valid totals
  const damageValidated = hasValidCenters && hasValidTotals;
  
  console.log('ğŸ”§ DAMAGE VALIDATION:', damageValidated, {
    centers_count: centers.length,
    valid_centers: hasValidCenters,
    valid_totals: hasValidTotals,
    totals: totals
  });
  
  return damageValidated;
}

function checkDamageStarted(helper) {
  return !!(helper.damage_assessment?.centers?.length || 
           helper.damage_centers?.length ||
           helper.damages?.length);
}

function checkEstimateValidation(helper) {
  // Check estimate.validation structure
  const estimateValidated = !!(helper.estimate?.validation?.validated_at || 
                              helper.validation_progress?.fees === true);
  console.log('ğŸ”§ ESTIMATE VALIDATION:', estimateValidated, {
    estimate_validation: helper.estimate?.validation,
    validation_progress_fees: helper.validation_progress?.fees
  });
  return estimateValidated;
}

function checkEstimateStarted(helper) {
  return !!(helper.estimate_totals || helper.estimate || helper.financial);
}

function checkExpertiseValidation(helper) {
  // Expertise is NOT validated unless we have actual expertise data
  // Just having an expertise object doesn't mean it's validated
  const hasExpertiseData = !!(helper.expertise && Object.keys(helper.expertise).length > 0 && 
                             (helper.expertise.findings || helper.expertise.report || helper.expertise.summary));
  const hasExpertiseSummary = !!(helper.expertise_summary && Object.keys(helper.expertise_summary).length > 0);
  
  const expertiseValidated = hasExpertiseData || hasExpertiseSummary;
  console.log('ğŸ”§ EXPERTISE VALIDATION:', expertiseValidated, {
    expertise: helper.expertise,
    expertise_summary: helper.expertise_summary
  });
  return expertiseValidated;
}

function checkExpertiseStarted(helper) {
  return !!(helper.expertise_data || helper.expertise || helper.expert_report);
}

function checkFinalReportValidation(helper) {
  // Check final_report.validation structure
  const finalReportValidated = !!(helper.final_report?.validation?.validated_at || 
                                 helper.validation?.validated_at);
  console.log('ğŸ”§ FINAL REPORT VALIDATION:', finalReportValidated, {
    final_report_validation: helper.final_report?.validation,
    main_validation: helper.validation
  });
  return finalReportValidated;
}

function checkFinalReportStarted(helper) {
  return !!(helper.final_report || helper.report || helper.final_data);
}

// Get validation dates from ACTUAL validation locations
function getValidationDate(helper, type) {
  let validationDate = null;
  
  // Read from actual validation structure locations
  switch(type) {
    case 'final_report':
      validationDate = helper.final_report?.validation?.validated_at || helper.validation?.validated_at;
      break;
    case 'estimate':
      validationDate = helper.estimate?.validation?.validated_at;
      break;
    case 'expertise':
      validationDate = helper.expertise?.validation?.validated_at;
      break;
    case 'vehicle':
    case 'damage':
      // These might not have specific validation dates, use main validation if available
      validationDate = helper.validation?.validated_at;
      break;
  }
  
  if (validationDate) {
    try {
      return new Date(validationDate).toLocaleDateString('he-IL');
    } catch (e) {
      console.warn('Error parsing validation date:', validationDate);
      return null;
    }
  }
  
  return null;
}

// Get validation details from ACTUAL validation locations
function getVehicleValidationDetails(helper) {
  if (helper.validation_progress?.vehicle === true && helper.validation?.validated_by) {
    return `×××•××ª ×¢×œ ×™×“×™: ${helper.validation.validated_by}`;
  }
  return null;
}

function getDamageValidationDetails(helper) {
  if (helper.validation_progress?.damage === true && helper.validation?.validated_by) {
    return `×××•××ª ×¢×œ ×™×“×™: ${helper.validation.validated_by}`;
  }
  return null;
}

function getEstimateValidationDetails(helper) {
  const estimateValidation = helper.estimate?.validation;
  if (estimateValidation?.validated_at && estimateValidation?.validated_by) {
    return `×××•××ª ×¢×œ ×™×“×™: ${estimateValidation.validated_by}`;
  }
  return null;
}

function getExpertiseValidationDetails(helper) {
  const expertiseValidation = helper.expertise?.validation;
  if (expertiseValidation?.validated_at && expertiseValidation?.validated_by) {
    return `×××•××ª ×¢×œ ×™×“×™: ${expertiseValidation.validated_by}`;
  }
  return null;
}

function getFinalReportValidationDetails(helper) {
  const finalValidation = helper.final_report?.validation || helper.validation;
  if (finalValidation?.validated_at && finalValidation?.validated_by) {
    return `×××•××ª ×¢×œ ×™×“×™: ${finalValidation.validated_by}`;
  }
  return null;
}


// Extract financial data from validation logs
function extractFinancialFromValidations(helper) {
  console.log('ğŸ”§ FINANCIAL SCAN: Looking for validated financial data...');
  
  const financialData = {
    hasData: false,
    estimateTotal: null,
    estimateDate: null,
    finalTotal: null,
    finalDate: null,
    depreciationAmount: null
  };
  
  // Look for validated estimate data
  const estimateValidation = helper.validation_log?.estimate;
  if (estimateValidation?.validated && estimateValidation.total) {
    financialData.estimateTotal = estimateValidation.total;
    financialData.estimateDate = getValidationDate(helper, 'estimate');
    financialData.hasData = true;
  }
  
  // Look for validated final costs
  const finalValidation = helper.validation_log?.final_report;
  if (finalValidation?.validated && finalValidation.total) {
    financialData.finalTotal = finalValidation.total;
    financialData.finalDate = getValidationDate(helper, 'final_report');
    financialData.hasData = true;
  }
  
  // Look for depreciation data
  const depreciation = helper.depreciation || helper.validation_log?.depreciation;
  if (depreciation?.amount || depreciation?.depreciation_amount) {
    financialData.depreciationAmount = depreciation.amount || depreciation.depreciation_amount;
    financialData.hasData = true;
  }
  
  return financialData;
}

// Analyze reports validation status
function analyzeReportsValidations(helper) {
  console.log('ğŸ”§ REPORTS SCAN: Analyzing report validation logs...');
  
  return [
    {
      name: '××§×¡×¤×¨×˜×™×–×”',
      validated: checkExpertiseValidation(helper),
      generated: !!(helper.expertise_data || helper.expertise),
      date: getValidationDate(helper, 'expertise')
    },
    {
      name: '××•××“×Ÿ ×¢×œ×•×™×•×ª',
      validated: checkEstimateValidation(helper),
      generated: !!(helper.estimate_totals || helper.estimate),
      date: getValidationDate(helper, 'estimate')
    },
    {
      name: '×“×•×— ×¡×•×¤×™',
      validated: checkFinalReportValidation(helper),
      generated: !!(helper.final_report || helper.report),
      date: getValidationDate(helper, 'final_report')
    }
  ];
}

// Calculate general health assessment
function calculateHealthAssessment(workflowStatus, helper) {
  const factors = [];
  
  // Factor 1: Completion percentage
  if (workflowStatus.completionPercentage >= 80) {
    factors.push('âœ… ×”×ª×§×“××•×ª ××¦×•×™× ×ª');
  } else if (workflowStatus.completionPercentage >= 50) {
    factors.push('ğŸŸ¡ ×”×ª×§×“××•×ª ×¡×‘×™×¨×”');
  } else {
    factors.push('ğŸ”´ ×“×•×¨×© ×”×ª×§×“××•×ª');
  }
  
  // Factor 2: Critical stages with specific details
  const hasVehicleData = workflowStatus.stages.find(s => s.name === '×¤×¨×˜×™ ×¨×›×‘')?.validated;
  const hasDamageData = workflowStatus.stages.find(s => s.name === '×”×¢×¨×›×ª × ×–×§×™×')?.validated;
  const hasLeviData = workflowStatus.stages.find(s => s.name === '× ×ª×•× ×™ ×œ×•×™ ×™×¦×—×§')?.validated;
  const hasInitialEstimate = workflowStatus.stages.find(s => s.name === '××•××“×Ÿ ×¨××©×•× ×™')?.validated;
  const hasExpertise = workflowStatus.stages.find(s => s.name === '××§×¡×¤×¨×˜×™×–×”')?.validated;
  
  const criticalStages = [];
  const missingCritical = [];
  
  // Check which critical stages are complete/missing
  if (hasVehicleData) criticalStages.push('×¤×¨×˜×™ ×¨×›×‘'); else missingCritical.push('×¤×¨×˜×™ ×¨×›×‘');
  if (hasDamageData) criticalStages.push('×”×¢×¨×›×ª × ×–×§×™×'); else missingCritical.push('×”×¢×¨×›×ª × ×–×§×™×');
  if (hasLeviData) criticalStages.push('× ×ª×•× ×™ ×œ×•×™'); else missingCritical.push('× ×ª×•× ×™ ×œ×•×™');
  if (hasInitialEstimate) criticalStages.push('××•××“×Ÿ ×¨××©×•× ×™'); else missingCritical.push('××•××“×Ÿ ×¨××©×•× ×™');
  
  // Expertise is optional - only show if missing and expected
  if (!hasExpertise && helper.expertise) {
    missingCritical.push('××§×¡×¤×¨×˜×™×–×”');
  }
  
  if (criticalStages.length >= 4) {
    factors.push('âœ… ×›×œ ×”×©×œ×‘×™× ×”×§×¨×™×˜×™×™× ×”×•×©×œ××•');
  } else if (criticalStages.length >= 2) {
    factors.push(`ğŸŸ¡ ${criticalStages.length} ××ª×•×š 4 ×©×œ×‘×™× ×§×¨×™×˜×™×™× ×”×•×©×œ××•`);
  } else {
    factors.push(`ğŸ”´ ×¨×§ ${criticalStages.length} ×©×œ×‘×™× ×§×¨×™×˜×™×™× ×”×•×©×œ××•`);
  }
  
  // Factor 3: Data quality
  const hasFinancialData = !!(helper.damage_assessment?.totals || helper.estimate?.totals);
  const hasDepreciation = !!helper.depreciation?.globalDep1;
  
  if (hasFinancialData && hasDepreciation) {
    factors.push('âœ… × ×ª×•× ×™× ×›×¡×¤×™×™× ××œ××™×');
  } else if (hasFinancialData) {
    factors.push('ğŸŸ¡ × ×ª×•× ×™× ×›×¡×¤×™×™× ×—×œ×§×™×™×');
  } else {
    factors.push('ğŸ”´ ×—×¡×¨×™× × ×ª×•× ×™× ×›×¡×¤×™×™×');
  }
  
  // Overall assessment
  const greenCount = factors.filter(f => f.includes('âœ…')).length;
  const yellowCount = factors.filter(f => f.includes('ğŸŸ¡')).length;
  
  let overall = '';
  if (greenCount >= 2) {
    overall = 'ğŸŸ¢ ××¦×‘ ×›×œ×œ×™: ×ª×§×™×Ÿ';
  } else if (yellowCount >= 2 || greenCount + yellowCount >= 2) {
    overall = 'ğŸŸ¡ ××¦×‘ ×›×œ×œ×™: ×“×•×¨×© ×”×©×œ××”';
  } else {
    overall = 'ğŸ”´ ××¦×‘ ×›×œ×œ×™: ×“×•×¨×© ×˜×™×¤×•×œ';
  }
  
  return `${overall}\n${factors.join('\n')}`;
}

// Extract timeline from validation logs
function extractTimelineFromValidations(helper) {
  console.log('ğŸ”§ TIMELINE SCAN: Extracting validation timeline...');
  
  const events = [];
  
  // Check for validation timestamps across different workflow stages
  const validationLog = helper.validation_log || {};
  
  Object.keys(validationLog).forEach(stage => {
    const stageData = validationLog[stage];
    if (stageData.validated_at) {
      events.push({
        date: new Date(stageData.validated_at).toLocaleDateString('he-IL'),
        description: `${stage} ××•××ª ×•××•×©×œ×`
      });
    }
  });
  
  // Sort events by date
  events.sort((a, b) => new Date(a.date) - new Date(b.date));
  
  return events;
}

// Helper function to calculate case completion
function calculateCaseCompletion(helper) {
  // Smart detection of completion status
  const hasVehicleData = () => {
    const vehiclePaths = [helper.vehicle, helper.car_details, helper.general_info].filter(Boolean);
    return vehiclePaths.some(v => v.make || v.manufacturer || (v.model || v.car_model));
  };
  
  const hasDamageCenters = () => {
    const damagePaths = [
      helper.damage_assessment?.centers,
      helper.damage_centers,
      helper.damages,
      helper.centers
    ].filter(Boolean);
    return damagePaths.some(path => Array.isArray(path) && path.length > 0);
  };
  
  const hasEstimate = () => {
    const estimatePaths = [helper.estimate_totals, helper.estimate, helper.totals, helper.financial].filter(Boolean);
    return estimatePaths.some(e => e.total_estimate || e.total || e.grand_total);
  };
  
  const hasExpertise = () => {
    const expertisePaths = [helper.expertise_data, helper.expertise, helper.expert_report].filter(Boolean);
    return expertisePaths.some(e => e.completed || e.finished || e.done);
  };
  
  const hasFinalReport = () => {
    const reportPaths = [helper.final_report, helper.report, helper.final_data].filter(Boolean);
    return reportPaths.some(r => r.completed || r.finished || r.generated);
  };
  
  const stages = [
    { name: '×¤×¨×˜×™ ×¨×›×‘', completed: hasVehicleData() },
    { name: '××•×§×“×™ × ×–×§', completed: hasDamageCenters() },
    { name: '××•××“×Ÿ', completed: hasEstimate() },
    { name: '××§×¡×¤×¨×˜×™×–×”', completed: hasExpertise() },
    { name: '×“×•×— ×¡×•×¤×™', completed: hasFinalReport() }
  ];
  
  const completed = stages.filter(s => s.completed).length;
  const total = stages.length;
  const percentage = Math.round((completed / total) * 100);
  
  return { completed, total, percentage, stages };
}

// Helper function to get report status
function getReportStatus(helper, reportType) {
  switch (reportType) {
    case 'expertise':
      if (helper.expertise_data?.completed) return { icon: 'âœ…', text: '×”×•×©×œ×' };
      if (helper.expertise_data?.started) return { icon: 'ğŸ”„', text: '×‘×ª×”×œ×™×š' };
      return { icon: 'â³', text: '×œ× ×”×ª×—×™×œ' };
      
    case 'estimate':
      if (helper.estimate_totals?.total_estimate) return { icon: 'âœ…', text: '×”×•×©×œ×' };
      if (helper.estimate?.started) return { icon: 'ğŸ”„', text: '×‘×ª×”×œ×™×š' };
      return { icon: 'â³', text: '×œ× ×”×ª×—×™×œ' };
      
    case 'final_report':
      if (helper.final_report?.completed) return { icon: 'âœ…', text: '×”×•×©×œ×' };
      if (helper.final_report?.started) return { icon: 'ğŸ”„', text: '×‘×ª×”×œ×™×š' };
      return { icon: 'â³', text: '×œ× ×”×ª×—×™×œ' };
      
    default:
      return { icon: 'â“', text: '×œ× ×™×“×•×¢' };
  }
}

// Helper functions (keeping existing ones for compatibility)
function getStatusColor(status) {
  const colors = {
    'OPEN': '#28a745',
    'IN_PROGRESS': '#ffc107',
    'CLOSED': '#6c757d',
    'ARCHIVED': '#dc3545'
  };
  return colors[status] || '#999';
}

function getStatusDisplay(status) {
  const displays = {
    'OPEN': '×¤×ª×•×—',
    'IN_PROGRESS': '×‘×¢×‘×•×“×”', 
    'CLOSED': '×¡×’×•×¨',
    'ARCHIVED': '×‘××¨×›×™×•×Ÿ'
  };
  return displays[status] || status;
}

function formatDate(dateString) {
  return new Date(dateString).toLocaleDateString('he-IL');
}

function formatDateWithTime(dateString) {
  return new Date(dateString).toLocaleString('he-IL');
}

function getTimeAgo(date) {
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMins / 60);
  const diffDays = Math.floor(diffHours / 24);
  
  if (diffMins < 1) return '×–×” ×¢×ª×”';
  if (diffMins < 60) return `${diffMins} ×“×§×•×ª`;
  if (diffHours < 24) return `${diffHours} ×©×¢×•×ª`;
  if (diffDays < 7) return `${diffDays} ×™××™×`;
  
  return formatDate(date);
}


</script>

  </div>
</body>
</html>
