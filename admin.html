<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>××¨×›×– × ×™×”×•×œ - ×™×¨×•×Ÿ ×›×™×•×£</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link href="https://fonts.googleapis.com/css2?family=Assistant&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css">
  <script type="module" src="./admin.js"></script>
  <script type="module" src="./helper.js"></script>
  <script type="module" src="./webhook.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #1a1a1a;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: right;
      min-height: 80vh;
      color: #e0e0e0;
    }
    .container {
      max-width: 550px;
      width: 100%;
      background: #2a2a2a;
      padding: 10px 10px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      text-align: center;
      position: relative;
      border: 1px solid #444;
    }
    header {
      background-color: #333;
      color: #ff6b35;
      padding: 20px;
      text-align: center;
      font-size: 22px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 2px solid #ff6b35;
    }
    .admin-container {
      display: grid;
      grid-template-columns: 1fr 2fr;
      min-height: 80vh;
    }
    .logo img {
      width: 100px;
    }
    .title { font-size: 24px; font-weight: bold; color: #ff6b35; }
    .subtitle { font-size: 18px; color: #ccc; margin-bottom: 5px; }
    .legal-note {
      color: red;
      font-weight: bold;
      margin-bottom: 15px;
    }
    h1 {
      font-size: 24px;
      color: #ff6b35;
      margin-bottom: 20px;
    }
    h2 {
      font-size: 20px;
      color: #ff6b35;
      margin-bottom: 20px;
    }
    nav {
      background: #333;
      padding: 20px;
      border-left: 3px solid #ff6b35;
      border-radius: 8px;
    }
    nav button {
      display: block;
      margin-bottom: 10px;
      width: 100%;
      padding: 10px;
      background: #444;
      color: #ff6b35;
      border: 1px solid #ff6b35;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    nav button:hover {
      background: #ff6b35;
      color: #333;
    }
    .vat-config {
      margin-top: 30px;
      text-align: center;
    }
    .vat-config label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #e0e0e0;
    }
    .vat-config input {
      width: 80%;
      padding: 8px;
      border: 1px solid #666;
      border-radius: 6px;
      margin-bottom: 8px;
      background: #444;
      color: #e0e0e0;
    }
    .vat-config button {
      padding: 8px 16px;
      background-color: #ff6b35;
      color: #333;
      border: 1px solid #ff6b35;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    main {
      padding: 30px;
      background: #2a2a2a;
      border-radius: 8px;
      color: #e0e0e0;
    }
    .notification-panel {
      position: fixed;
      bottom: 20px;
      left: 20px;
      max-width: 320px;
      background: #333;
      border: 1px solid #ff6b35;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
      padding: 10px;
      z-index: 1000;
      font-size: 14px;
      color: #e0e0e0;
    }
    .notification-panel h4 { margin: 0 0 8px 0; font-size: 16px; color: #ff6b35; }
    .notification-item {
      background: #444;
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #666;
    }
    .notification-actions button {
      margin-top: 5px;
      margin-right: 5px;
      font-size: 12px;
      padding: 4px 8px;
    }
    .devButton {
      background-color: #c0392b !important;
      color: white;
      border: 1px solid #922b21;
      font-weight: bold;
    }
    .footer {
      text-align: center;
      font-size: 12px;
      margin-top: 30px;
      color: #ccc;
      border-top: 1px solid #444;
      padding-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo" style="margin-bottom: 1px;">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo" />
    </div>
    <div class="title">×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×¤×•×¨×˜×œ</div>
    <div class="subtitle">×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</div>
    <header>××¨×›×– × ×™×”×•×œ - ×™×¨×•×Ÿ ×›×™×•×£</header>
    <div class="admin-container">
      <nav>
        <button onclick="loadSection('caseStatus')">×¡×˜×˜×•×¡ ×ª×™×§×™×</button>
        <button onclick="loadSection('tracking')">×¡×§×™×¨×” ×œ×¤×™ ×©×“×•×ª</button>
        <button onclick="loadSection('reminders')">×¨×©×™××ª ×ª×–×›×•×¨×•×ª</button>
        <button onclick="loadSection('override')">×©×™× ×•×™ × ×ª×•× ×™×</button>
        <button onclick="loadSection('logView')">×™×•××Ÿ ×¤×¢×•×œ×•×ª</button>
        <button onclick="window.open('https://ycshamautcoil-my.sharepoint.com/personal/yaron_yc-shamaut_co_il/_layouts/15/onedrive.aspx?id=%2Fpersonal%2Fyaron%5Fyc%2Dshamaut%5Fco%5Fil%2FDocuments%2FYC%20×©×××•×ª%2F×ª×™×§×™×%20×¤×ª×•×—×™×&ga=1', '_blank')">×›× ×™×¡×” ×œ×ª×™×§×™× ×¤×ª×•×—×™×</button>
        <button class="devButton" onclick="window.location.href='validation-dashboard.html'">×œ×•×— ×‘×§×¨×ª ××™××•×ª</button>
        <div class="vat-config">
          <label for="vat-input">××¢"× ×’×œ×•×‘×œ×™ (%)</label>
          <input id="vat-input" type="number" step="0.01" placeholder="18">
          <button id="save-admin-settings">×©××•×¨ ××¢"×</button>
        </div>
        <button id="devButton" class="devButton" onclick="verifyDevAccess()">Developer Panel</button>
      </nav>
      <main id="adminContent">
        <p>×‘×—×¨ ×¤×¢×•×œ×” ××”×ª×¤×¨×™×˜ ×”×™×× ×™ ×›×“×™ ×œ×”×ª×—×™×œ.</p>
      </main>
    </div>
    <div id="notificationPanel" class="notification-panel" style="display:none;">
      <h4>×”×•×“×¢×•×ª ××¢×¨×›×ª</h4>
      <div id="notificationList"></div>
    </div>
    <div class="footer">All rights reserved Â© Carmel Cayouf</div>
    <script type="module">
      import { MathEngine } from './math.js';
      import { sendToWebhook } from './webhook.js';
      
      document.addEventListener('DOMContentLoaded', () => {
        const saveBtn = document.getElementById('save-admin-settings');
        if (!saveBtn) {
          console.error('Save admin settings button not found');
          return;
        }
        
        saveBtn.addEventListener('click', async () => {
        const vat = parseFloat(document.getElementById('vat-input').value);
        if (isNaN(vat) || vat < 0 || vat > 100) {
          alert('×¢×¨×š ××¢"× ×œ× ×—×•×§×™');
          return;
        }
        
        const submitBtn = document.getElementById('save-admin-settings');
        const originalText = submitBtn.textContent;
        
        try {
          // Show loading state
          submitBtn.disabled = true;
          submitBtn.textContent = '×©×•××¨ ×”×’×“×¨×•×ª...';
          
          // Save to server with validation
          const adminSettings = {
            vat_rate: vat,
            timestamp: new Date().toISOString(),
            admin_user: sessionStorage.getItem('auth') || 'admin'
          };
          
          const response = await sendToWebhook('ADMIN_HUB', {
            action: 'update_settings',
            settings: adminSettings
          });
          
          // If server validation passes, save locally
          MathEngine.setVatRate(vat);
          sessionStorage.setItem('globalVAT', vat.toString());
          
          submitBtn.textContent = 'âœ… × ×©××¨ ×‘×”×¦×œ×—×”';
          alert(`âœ… ××¢"× ×¢×•×“×›×Ÿ ×œ-${vat}% ×‘××¢×¨×›×ª ×•×‘×©×¨×ª`);
          
        } catch (error) {
          console.error('Admin settings save error:', error);
          alert(`âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”×’×“×¨×•×ª: ${error.message}`);
          
          // Reset button state
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
        
        // Reset button after 2 seconds
        setTimeout(() => {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }, 2000);
        });
      });
    </script>
    
    <script>
    // Define loadSection globally so it's available immediately
    window.loadSection = function(id) {
      const content = document.getElementById('adminContent');
      
      switch(id) {
        case 'caseStatus':
          content.innerHTML = `
            <h2>ğŸ“Š ×¡×˜×˜×•×¡ ×ª×™×§×™×</h2>
            <div style="margin-bottom: 20px;">
              <input type="text" id="plateSearch" placeholder="×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘ ×œ×—×™×¤×•×©" style="padding: 8px; margin-right: 10px; width: 200px;">
              <button onclick="searchCaseStatus()" style="padding: 8px 16px; background: #ff6b35; color: white; border: none; border-radius: 4px;">×—×¤×© ×ª×™×§</button>
            </div>
            <div id="caseResults">
              <p>×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘ ×œ×¦×¤×™×™×” ×‘×¡×˜×˜×•×¡ ×”×ª×™×§</p>
            </div>`;
          break;
          
        case 'tracking':
          content.innerHTML = `
            <h2 style="color: #ff6b35; margin-bottom: 15px;">ğŸ“‹ ×¡×§×™×¨×” ×œ×¤×™ ×©×“×•×ª</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
              
              <!-- Date Filtering -->
              <div style="background: #333; padding: 10px; border-radius: 6px; border: 1px solid #555;">
                <h3 style="color: #ff6b35; font-size: 14px; margin-bottom: 8px;">×¡×™× ×•×Ÿ ×œ×¤×™ ×ª××¨×™×š</h3>
                <input type="date" id="dateFrom" style="width: 100%; padding: 6px; margin-bottom: 5px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px;">
                <input type="date" id="dateTo" style="width: 100%; padding: 6px; margin-bottom: 8px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px;">
                <button onclick="filterByDate()" style="width: 100%; padding: 6px; background: #ff6b35; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">×¡× ×Ÿ ×œ×¤×™ ×ª××¨×™×š</button>
              </div>

              <!-- Plate Number Filter -->
              <div style="background: #333; padding: 10px; border-radius: 6px; border: 1px solid #555;">
                <h3 style="color: #ff6b35; font-size: 14px; margin-bottom: 8px;">×—×™×¤×•×© ×œ×¤×™ ××¡. ×¨×›×‘</h3>
                <input type="text" id="plateFilter" placeholder="×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘" style="width: 100%; padding: 6px; margin-bottom: 8px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px;">
                <button onclick="filterByPlate()" style="width: 100%; padding: 6px; background: #4ade80; color: #1a1a1a; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">×—×¤×© ×¨×›×‘</button>
              </div>

              <!-- Status Filter -->
              <div style="background: #333; padding: 10px; border-radius: 6px; border: 1px solid #555;">
                <h3 style="color: #ff6b35; font-size: 14px; margin-bottom: 8px;">×¡×™× ×•×Ÿ ×œ×¤×™ ×¡×˜×˜×•×¡</h3>
                <select id="statusFilter" style="width: 100%; padding: 6px; margin-bottom: 5px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px;">
                  <option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                  <option value="open">×¤×ª×•×—</option>
                  <option value="in_progress">×‘×˜×™×¤×•×œ</option>
                  <option value="completed">×”×•×©×œ×</option>
                  <option value="pending">×××ª×™×Ÿ</option>
                </select>
                <button onclick="filterByStatus()" style="width: 100%; padding: 6px; background: #fbbf24; color: #1a1a1a; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">×¡× ×Ÿ ×¡×˜×˜×•×¡</button>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
              
              <!-- Manufacturer Filter -->
              <div style="background: #333; padding: 10px; border-radius: 6px; border: 1px solid #555;">
                <h3 style="color: #ff6b35; font-size: 14px; margin-bottom: 8px;">×©× ×”×™×¦×¨×Ÿ</h3>
                <input type="text" id="manufacturerFilter" placeholder="×”×›× ×¡ ×©× ×™×¦×¨×Ÿ" style="width: 100%; padding: 6px; margin-bottom: 8px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px;">
                <button onclick="filterByManufacturer()" style="width: 100%; padding: 6px; background: #8b5cf6; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">×—×¤×© ×™×¦×¨×Ÿ</button>
              </div>

              <!-- Owner Filter -->
              <div style="background: #333; padding: 10px; border-radius: 6px; border: 1px solid #555;">
                <h3 style="color: #ff6b35; font-size: 14px; margin-bottom: 8px;">×©× ×‘×¢×œ ×”×¨×›×‘</h3>
                <input type="text" id="ownerFilter" placeholder="×”×›× ×¡ ×©× ×‘×¢×œ×™×" style="width: 100%; padding: 6px; margin-bottom: 8px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px;">
                <button onclick="filterByOwner()" style="width: 100%; padding: 6px; background: #06b6d4; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">×—×¤×© ×‘×¢×œ×™×</button>
              </div>

              <!-- Garage Filter -->
              <div style="background: #333; padding: 10px; border-radius: 6px; border: 1px solid #555;">
                <h3 style="color: #ff6b35; font-size: 14px; margin-bottom: 8px;">××•×¡×š</h3>
                <input type="text" id="garageFilter" placeholder="×”×›× ×¡ ×©× ××•×¡×š" style="width: 100%; padding: 6px; margin-bottom: 8px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px;">
                <button onclick="filterByGarage()" style="width: 100%; padding: 6px; background: #ec4899; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">×—×¤×© ××•×¡×š</button>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
              
              <!-- Directive Filter -->
              <div style="background: #333; padding: 10px; border-radius: 6px; border: 1px solid #555;">
                <h3 style="color: #ff6b35; font-size: 14px; margin-bottom: 8px;">×“×™×¨×§×˜×™×‘×”</h3>
                <select id="directiveFilter" style="width: 100%; padding: 6px; margin-bottom: 5px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px;">
                  <option value="">×›×œ ×”×“×™×¨×§×˜×™×‘×•×ª</option>
                  <option value="total_loss">×”×¤×¡×“ ××•×—×œ×˜</option>
                  <option value="repair">×ª×™×§×•×Ÿ</option>
                  <option value="evaluation">×”×¢×¨×›×”</option>
                  <option value="inspection">×‘×“×™×§×”</option>
                </select>
                <button onclick="filterByDirective()" style="width: 100%; padding: 6px; background: #f59e0b; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">×¡× ×Ÿ ×“×™×¨×§×˜×™×‘×”</button>
              </div>

              <!-- Case in Claim Filter -->
              <div style="background: #333; padding: 10px; border-radius: 6px; border: 1px solid #555;">
                <h3 style="color: #ff6b35; font-size: 14px; margin-bottom: 8px;">×ª×™×§ ×‘×ª×‘×™×¢×”</h3>
                <select id="claimFilter" style="width: 100%; padding: 6px; margin-bottom: 5px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px;">
                  <option value="">×”×›×œ</option>
                  <option value="yes">×›×Ÿ</option>
                  <option value="no">×œ×</option>
                  <option value="pending">×‘×”××ª× ×”</option>
                </select>
                <button onclick="filterByClaim()" style="width: 100%; padding: 6px; background: #ef4444; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">×¡× ×Ÿ ×ª×‘×™×¢×•×ª</button>
              </div>

              <!-- Combined Yes/No Filters -->
              <div style="background: #333; padding: 10px; border-radius: 6px; border: 1px solid #555;">
                <h3 style="color: #ff6b35; font-size: 14px; margin-bottom: 8px;">×—×©×‘×•× ×™×•×ª ×•×ª×©×œ×•××™×</h3>
                <select id="invoiceFilter" style="width: 100%; padding: 4px; margin-bottom: 4px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 11px;">
                  <option value="">×”×ª×§×‘×œ×” ×—×©×‘×•× ×™×ª</option>
                  <option value="yes">×›×Ÿ</option>
                  <option value="no">×œ×</option>
                </select>
                <select id="paymentFilter" style="width: 100%; padding: 4px; margin-bottom: 6px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 11px;">
                  <option value="">×”×ª×§×‘×œ ×ª×©×œ×•×</option>
                  <option value="yes">×›×Ÿ</option>
                  <option value="no">×œ×</option>
                </select>
                <button onclick="filterByInvoicePayment()" style="width: 100%; padding: 6px; background: #10b981; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">×¡× ×Ÿ ××¡××›×™×</button>
              </div>
            </div>

            <div style="text-align: center; margin-bottom: 15px;">
              <button onclick="clearAllFilters()" style="padding: 8px 20px; background: #6b7280; color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; margin-left: 10px;">× ×§×” ×›×œ ×”×¡×™× ×•× ×™×</button>
              <button onclick="exportResults()" style="padding: 8px 20px; background: #059669; color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer;">×™×™×¦× ×ª×•×¦××•×ª</button>
            </div>

            <div id="trackingResults" style="margin-top: 20px;">
              <div style="background: #333; padding: 15px; border-radius: 8px; border: 1px solid #555; color: #ccc; text-align: center;">
                <p>×‘×—×¨ ××¤×©×¨×•×™×•×ª ×¡×™× ×•×Ÿ ×•×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ ×”×—×™×¤×•×© ×”××ª××™× ×›×“×™ ×œ×¦×¤×•×ª ×‘× ×ª×•× ×™×</p>
                <p style="font-size: 12px; color: #999;">×”×©×ª××© ×‘××¡×¤×¨ ×¡×™× ×•× ×™× ×™×—×“ ×›×“×™ ×œ×¦××¦× ××ª ×”×ª×•×¦××•×ª</p>
              </div>
            </div>`;
          break;
          
        case 'reminders':
          content.innerHTML = `
            <h2>ğŸ”” ×¨×©×™××ª ×ª×–×›×•×¨×•×ª</h2>
            <div style="margin-bottom: 20px;">
              <button onclick="addReminder()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px;">â• ×”×•×¡×£ ×ª×–×›×•×¨×ª ×—×“×©×”</button>
            </div>
            <div id="remindersList">
              <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                <h4>×ª×–×›×•×¨×ª ×œ×‘×“×™×§×ª ×ª×™×§×™× ×¤×ª×•×—×™×</h4>
                <p>×ª××¨×™×š: ${new Date().toLocaleDateString('he-IL')}</p>
                <p>×¡×˜×˜×•×¡: ×¤×¢×™×œ</p>
                <button onclick="editReminder(1)" style="padding: 5px 10px; background: #ffc107; color: black; border: none; border-radius: 4px; margin-left: 5px;">×¢×¨×•×š</button>
                <button onclick="deleteReminder(1)" style="padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px;">××—×§</button>
              </div>
            </div>`;
          break;
          
        case 'override':
          content.innerHTML = `
            <h2>âœï¸ ×©×™× ×•×™ × ×ª×•× ×™×</h2>
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeaa7; margin-bottom: 20px;">
              <strong>âš ï¸ ××–×”×¨×”:</strong> ×©×™× ×•×™ × ×ª×•× ×™× ×‘××¢×¨×›×ª ×“×•×¨×© ×”×¨×©××•×ª ×× ×”×œ ×•×’×™×‘×•×™ ××•×˜×•××˜×™
            </div>
            <div>
              <h3>×—×™×¤×•×© ×ª×™×§ ×œ×¢×¨×™×›×”</h3>
              <input type="text" id="editPlateSearch" placeholder="×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘" style="padding: 8px; margin-right: 10px; width: 200px;">
              <button onclick="loadCaseForEdit()" style="padding: 8px 16px; background: #ff6b35; color: white; border: none; border-radius: 4px;">×˜×¢×Ÿ ×ª×™×§ ×œ×¢×¨×™×›×”</button>
            </div>
            <div id="editResults" style="margin-top: 20px;">
              <p>×˜×¢×Ÿ ×ª×™×§ ×›×“×™ ×œ×”×ª×—×™×œ ×¢×¨×™×›×”</p>
            </div>`;
          break;
          
        case 'logView':
          content.innerHTML = `
            <h2>ğŸ“œ ×™×•××Ÿ ×¤×¢×•×œ×•×ª</h2>
            <div style="margin-bottom: 20px;">
              <button onclick="refreshLog()" style="padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 4px;">ğŸ”„ ×¨×¢× ×Ÿ ×™×•××Ÿ</button>
              <button onclick="exportLog()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; margin-right: 10px;">ğŸ“¤ ×™×¦× ×™×•××Ÿ</button>
            </div>
            <div id="logContent" style="background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto;">
              <div style="border-bottom: 1px solid #ddd; padding: 10px 0;">
                <strong>${new Date().toLocaleString('he-IL')}</strong> - ××©×ª××© × ×›× ×¡ ×œ××¢×¨×›×ª ×”× ×™×”×•×œ
              </div>
              <div style="border-bottom: 1px solid #ddd; padding: 10px 0;">
                <strong>${new Date(Date.now() - 3600000).toLocaleString('he-IL')}</strong> - ×¢×•×“×›×Ÿ ××¢"× ×’×œ×•×‘×œ×™ ×œ-18%
              </div>
              <div style="border-bottom: 1px solid #ddd; padding: 10px 0;">
                <strong>${new Date(Date.now() - 7200000).toLocaleString('he-IL')}</strong> - × ×•×¦×¨ ×ª×™×§ ×—×“×© ×¢×‘×•×¨ ×¨×›×‘ 123-45-678
              </div>
            </div>`;
          break;
          
        default:
          content.innerHTML = `<p>×˜×•×¢×Ÿ ${id}...</p>`;
      }
    };
    </script>
    
   <script type="module">
  import { sendToWebhook } from './webhook.js';
  
  // Make sendToWebhook globally available immediately
  window.sendToWebhook = sendToWebhook;
  
  // Make sure it's available before any functions try to use it
  window.webhookReady = true;
  
  // Merge with existing DOMContentLoaded event - do not create duplicate
  // The admin functionality will be added to the existing DOMContentLoaded below
  
  // Define admin helper functions here when needed
  
  // Add to existing DOMContentLoaded event from first script
  document.addEventListener('DOMContentLoaded', () => {
    // Check if user has basic authentication
    const auth = sessionStorage.getItem('auth');
    if (!auth) {
      console.log('âŒ No auth token found in admin.html, redirecting to login');
      alert('×”×’×™×©×” ×—×¡×•××” - ×× × ×”×ª×—×‘×¨ ×“×¨×š ×“×£ ×”×‘×™×ª');
      window.location.href = 'index.html';
      return;
    }
    
    // Check for admin-specific access
    const adminAccess = sessionStorage.getItem('admin-access');
    const adminTimestamp = sessionStorage.getItem('admin-timestamp');
    
    if (!adminAccess || !adminAccess.includes('granted')) {
      console.log('âŒ No admin access token found, redirecting to selection');
      alert('×’×™×©×ª ×× ×”×œ × ×“×¨×©×ª - ×× × ×××ª ××ª ×”×–×”×•×ª ×©×œ×š ×“×¨×š ×¢××•×“ ×”×‘×—×™×¨×”');
      window.location.href = 'selection.html';
      return;
    }
    
    // Check if admin session is still valid (24 hours)
    if (adminTimestamp) {
      const sessionAge = Date.now() - new Date(adminTimestamp).getTime();
      const maxAge = 24 * 60 * 60 * 1000; // 24 hours
      
      if (sessionAge > maxAge) {
        console.log('âŒ Admin session expired, redirecting to selection');
        sessionStorage.removeItem('admin-access');
        sessionStorage.removeItem('admin-timestamp');
        alert('×ª×•×§×£ ×’×™×©×ª ×”×× ×”×œ ×¤×’ - ×× × ×”×ª×—×‘×¨ ××—×“×©');
        window.location.href = 'selection.html';
        return;
      }
    }
    
    console.log('âœ… Admin access verified, loading admin panel');
    console.log('Admin access type:', adminAccess);
    
    // Load VAT from session
    const existingVat = sessionStorage.getItem('globalVAT');
    if (existingVat) {
      document.getElementById('vat-input').value = existingVat;
    }
  });

    // Helper functions for admin sections
    window.searchCaseStatus = async function() {
      const plate = document.getElementById('plateSearch').value.trim();
      if (!plate) {
        alert('×× × ×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘');
        return;
      }
      
      const resultsDiv = document.getElementById('caseResults');
      resultsDiv.innerHTML = `
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeaa7;">
          <h4>ğŸ” ××—×¤×© × ×ª×•× ×™× ×¢×‘×•×¨ ×¨×›×‘: ${plate}</h4>
          <p>×× × ×”××ª×Ÿ...</p>
        </div>`;
      
      try {
        // Wait for webhook to be ready with a small delay
        await new Promise(resolve => setTimeout(resolve, 100));
        
        if (!window.sendToWebhook || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available - please refresh the page');
        }
        
        const response = await window.sendToWebhook('ADMIN_FETCH_TRACKING_TABLE', {
          plate: plate,
          action: 'get_case_status'
        });
        
        console.log('Case status response:', response);
        
        if (response && Array.isArray(response) && response.length > 0) {
          const caseData = response[0];
          displayCaseStatus(plate, caseData);
        } else {
          resultsDiv.innerHTML = `
            <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb; color: #721c24;">
              <h4>âŒ ×œ× × ××¦××• × ×ª×•× ×™×</h4>
              <p>×œ× × ××¦××• × ×ª×•× ×™× ×¢×‘×•×¨ ×¨×›×‘ ××¡×¤×¨: ${plate}</p>
              <p>×× × ×‘×“×•×§ ××ª ××¡×¤×¨ ×”×¨×›×‘ ×•× ×¡×” ×©×•×‘</p>
            </div>`;
        }
      } catch (error) {
        console.error('Error fetching case status:', error);
        resultsDiv.innerHTML = `
          <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb; color: #721c24;">
            <h4>âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×</h4>
            <p>×©×’×™××”: ${error.message}</p>
            <p>×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨</p>
          </div>`;
      }
    };

    window.displayCaseStatus = function(plate, caseData) {
      const resultsDiv = document.getElementById('caseResults');
      
      // Extract the three categories from the response
      const generalInfo = caseData['×ª×"×¦ ×›×œ×œ×™'] || {};
      const expertise = caseData['××§×¡×¤×™×¨×˜×™×–×”'] || {};
      const opinion = caseData['×—×•×•"×“'] || {};
      
      resultsDiv.innerHTML = `
        <div style="background: #333; padding: 12px; border-radius: 8px; border: 1px solid #555; color: #e0e0e0; font-size: 13px;">
          <h4 style="margin: 0 0 8px 0; font-size: 16px; color: #ff6b35;">ğŸ“Š ×¡×˜×˜×•×¡ ×ª×™×§: ${plate}</h4>
          <div style="margin-bottom: 12px; font-size: 12px; color: #ccc;">
            <span><strong>××¡×¤×¨ ×ª×™×§:</strong> ${generalInfo['××¡×¤×¨ ×ª×™×§'] || '×œ× ×–××™×Ÿ'}</span> | 
            <span><strong>×¢×“×›×•×Ÿ:</strong> ${new Date().toLocaleDateString('he-IL')}</span>
          </div>
          
          <!-- ×ª×"×¦ ×›×œ×œ×™ Section -->
          <div style="margin-bottom: 8px;">
            <button onclick="toggleSection('general')" onmouseover="this.style.background='#4ade80'; this.style.color='#1a1a1a'" onmouseout="this.style.background='#444'; this.style.color='#4ade80'" style="width: 100%; padding: 8px; background: #444; color: #4ade80; border: 1px solid #4ade80; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.3s;">
              ğŸ“‹ ×ª×"×¦ ×›×œ×œ×™
            </button>
            <div id="general-section" style="display: none; background: #2a2a2a; padding: 10px; border-radius: 6px; margin-top: 5px; border: 1px solid #444; font-size: 12px;">
              ${formatGeneralInfo(generalInfo)}
            </div>
          </div>
          
          <!-- ××§×¡×¤×™×¨×˜×™×–×” Section -->
          <div style="margin-bottom: 8px;">
            <button onclick="toggleSection('expertise')" onmouseover="this.style.background='#fbbf24'; this.style.color='#1a1a1a'" onmouseout="this.style.background='#444'; this.style.color='#fbbf24'" style="width: 100%; padding: 8px; background: #444; color: #fbbf24; border: 1px solid #fbbf24; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.3s;">
              ğŸ”§ ××§×¡×¤×™×¨×˜×™×–×”
            </button>
            <div id="expertise-section" style="display: none; background: #2a2a2a; padding: 10px; border-radius: 6px; margin-top: 5px; border: 1px solid #444; font-size: 12px;">
              ${formatExpertiseInfo(expertise)}
            </div>
          </div>
          
          <!-- ×—×•×•"×“ Section -->
          <div style="margin-bottom: 8px;">
            <button onclick="toggleSection('opinion')" onmouseover="this.style.background='#f87171'; this.style.color='#1a1a1a'" onmouseout="this.style.background='#444'; this.style.color='#f87171'" style="width: 100%; padding: 8px; background: #444; color: #f87171; border: 1px solid #f87171; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.3s;">
              ğŸ“ ×—×•×•"×“
            </button>
            <div id="opinion-section" style="display: none; background: #2a2a2a; padding: 10px; border-radius: 6px; margin-top: 5px; border: 1px solid #444; font-size: 12px;">
              ${formatOpinionInfo(opinion)}
            </div>
          </div>
        </div>`;
    };

    window.toggleSection = function(sectionId) {
      const section = document.getElementById(sectionId + '-section');
      if (section.style.display === 'none') {
        section.style.display = 'block';
      } else {
        section.style.display = 'none';
      }
    };

    window.formatGeneralInfo = function(info) {
      return `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; color: #ccc;">
          <div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">××¡×¤×¨ ×ª×™×§:</strong> ${info['××¡×¤×¨ ×ª×™×§'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">×ª××¨×™×š ×‘×“×™×§×”:</strong> ${info['×ª××¨×™×š ×”×‘×“×™×§×”'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">×ª××¨×™×š ×—×•×•"×“:</strong> ${info['×ª××¨×™×š ×—×•×•"×“'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">××¡. ×¨×›×‘:</strong> ${info['××¡.×¨×›×‘'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">×©× ×”×™×¦×¨×Ÿ:</strong> ${info['×©× ×”×™×¦×¨×Ÿ'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">×©× ×ª ×™×™×¦×•×¨:</strong> ${info['×©× ×ª ×™×™×¦×•×¨'] || '×œ× ×–××™×Ÿ'}</div>
          </div>
          <div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">×¢×¨×š ×”×¨×›×‘:</strong> ${info['×¢×¨×š ×”×¨×›×‘'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">×‘×¢×œ ×”×¨×›×‘:</strong> ${info['×©× ×‘×¢×œ ×”×¨×›×‘'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">×˜×œ×¤×•×Ÿ:</strong> ${info['×˜×œ×¤×•×Ÿ'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">××•×¡×š:</strong> ${info['××•×¡×š'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">×˜×œ×¤×•×Ÿ ××•×¡×š:</strong> ${info['×˜×œ×¤×•×Ÿ ××•×¡×š'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">×¡×˜×˜×•×¡ ×›×œ×œ×™:</strong> ${info['×¡×˜×˜×•×¡ ×›×œ×œ×™'] || '×œ× ×–××™×Ÿ'}</div>
          </div>
        </div>
        <div style="margin-top: 8px; border-top: 1px solid #444; padding-top: 8px;">
          <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">×“×™×¨×§×˜×™×‘×”:</strong> ${info['×“×™×¨×§×˜×™×‘×”'] || '×œ× ×–××™×Ÿ'}</div>
          <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">×”×¢×¨×•×ª ×›×œ×œ×™×•×ª:</strong> ${info['×”×¢×¨×•×ª ×›×œ×œ×™×•×ª'] || '××™×Ÿ ×”×¢×¨×•×ª'}</div>
        </div>`;
    };

    window.formatExpertiseInfo = function(info) {
      return `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; color: #ccc;">
          <div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">××¡×¤×¨ ×ª×™×§:</strong> ${info['××¡×¤×¨ ×ª×™×§'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">××¡×¤×¨ ×¨×›×‘:</strong> ${info['××¡×¤×¨ ×¨×›×‘'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">××¡. ××•×§×“×™ × ×–×§:</strong> ${info['××¡ ××•×§×“×™ × ×–×§'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">××•×§×“ × ×–×§:</strong> ${info['××•×§×“ × ×–×§'] || '×œ× ×–××™×Ÿ'}</div>
          </div>
          <div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">×ª×™××•×¨:</strong> ${info['×ª×™××•×¨'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">×ª×™×§×•× ×™× ××ª×•×›× × ×™×:</strong> ${info['×ª×™×§×•× ×™× ××ª×•×›× × ×™×'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">×—×œ×§×™× ××ª×•×›× × ×™×:</strong> ${info['×—×œ×§×™× ××ª×•×›× × ×™×'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">×¢×‘×•×“×•×ª ××ª×•×›× × ×•×ª:</strong> ${info['×¢×‘×•×“×•×ª ××ª×•×›× × ×•×ª'] || '×œ× ×–××™×Ÿ'}</div>
          </div>
        </div>
        <div style="margin-top: 8px; border-top: 1px solid #444; padding-top: 8px;">
          <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">×”× ×—×™×™×”:</strong> ${info['×”× ×—×™×™×”'] || '××™×Ÿ ×”× ×—×™×•×ª'}</div>
          <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">×”×¢×¨×•×ª:</strong> ${info['×”×¢×¨×•×ª'] || '××™×Ÿ ×”×¢×¨×•×ª'}</div>
        </div>`;
    };

    window.formatOpinionInfo = function(info) {
      return `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; color: #ccc;">
          <div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">××¡×¤×¨ ×¨×›×‘:</strong> ${info['××¡×¤×¨ ×¨×›×‘'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">××¡. ××•×§×“×™ × ×–×§:</strong> ${info['××¡ ××•×§×“×™ × ×–×§'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">××•×§×“ × ×–×§:</strong> ${info['××•×§×“ × ×–×§'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">×ª×™×§×•× ×™× ×‘×¤×•×¢×œ:</strong> ${info['×ª×™×§×•× ×™× ×‘×¤×•×¢×œ'] || '×œ× ×–××™×Ÿ'}</div>
          </div>
          <div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">×¡×”"×› ×—×œ×§×™× ×‘×¤×•×¢×œ:</strong> ${info['×¡×”"×› ×—×œ×§×™× ×‘×¤×•×¢×œ'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">×¡×”"×› ×¢×‘×•×“×•×ª ×‘×¤×•×¢×œ:</strong> ${info['×¡×”"×› ×¢×‘×•×“×•×ª ×‘×¤×•×¢×œ'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">×¡×›×•× ×œ×ª×‘×™×¢×”:</strong> ${info['×¡×›×•× ×œ×ª×‘×™×¢×”'] || '×œ× ×–××™×Ÿ'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">×™×¨×™×“×ª ×¢×¨×š:</strong> ${info['×™×¨×™×“×ª ×¢×¨×š'] || '×œ× ×–××™×Ÿ'}</div>
          </div>
        </div>
        <div style="margin-top: 8px; border-top: 1px solid #444; padding-top: 8px;">
          <div style="margin-bottom: 4px;"><strong style="color: #f87171;">×¤×™×¦×•×™ ×¡×•×¤×™:</strong> ${info['×¤×™×¦×•×™ ×¡×•×¤×™'] || '×œ× ×–××™×Ÿ'}</div>
          <div style="margin-bottom: 4px;"><strong style="color: #f87171;">×”×¢×¨×•×ª:</strong> ${info['×”×¢×¨×•×ª'] || '××™×Ÿ ×”×¢×¨×•×ª'}</div>
        </div>`;
    };

    window.filterByDate = async function() {
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;
      
      if (!dateFrom || !dateTo) {
        alert('×× × ×‘×—×¨ ×˜×•×•×— ×ª××¨×™×›×™× ××œ×');
        return;
      }
      
      const resultsDiv = document.getElementById('trackingResults');
      resultsDiv.innerHTML = `
        <div style="background: #333; padding: 12px; border-radius: 8px; border: 1px solid #555; color: #e0e0e0; text-align: center;">
          <h4 style="color: #ff6b35; margin-bottom: 8px;">ğŸ” ××—×¤×© ×ª×™×§×™× ×œ×ª×§×•×¤×”: ${dateFrom} - ${dateTo}</h4>
          <p>×× × ×”××ª×Ÿ...</p>
        </div>`;
      
      try {
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available - page still loading');
        }
        
        const response = await window.sendToWebhook('ADMIN_FETCH_FIELDS', {
          filter_type: 'date_range',
          date_from: dateFrom,
          date_to: dateTo,
          action: 'field_review'
        });
        
        displayFieldResults('×ª×™×§×™× ×œ×ª×§×•×¤×”', `${dateFrom} - ${dateTo}`, response);
      } catch (error) {
        displayFieldError('×¡×™× ×•×Ÿ ×œ×¤×™ ×ª××¨×™×š', error.message);
      }
    };

    window.filterByStatus = async function() {
      const status = document.getElementById('statusFilter').value;
      const statusText = document.getElementById('statusFilter').selectedOptions[0].text;
      
      if (!status) {
        alert('×× × ×‘×—×¨ ×¡×˜×˜×•×¡');
        return;
      }
      
      await performFieldFilter('status', status, `×¡×˜×˜×•×¡: ${statusText}`);
    };

    window.filterByPlate = async function() {
      const plate = document.getElementById('plateFilter').value.trim();
      if (!plate) {
        alert('×× × ×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘');
        return;
      }
      
      await performFieldFilter('plate', plate, `××¡×¤×¨ ×¨×›×‘: ${plate}`);
    };

    window.filterByManufacturer = async function() {
      const manufacturer = document.getElementById('manufacturerFilter').value.trim();
      if (!manufacturer) {
        alert('×× × ×”×›× ×¡ ×©× ×™×¦×¨×Ÿ');
        return;
      }
      
      await performFieldFilter('manufacturer', manufacturer, `×™×¦×¨×Ÿ: ${manufacturer}`);
    };

    window.filterByOwner = async function() {
      const owner = document.getElementById('ownerFilter').value.trim();
      if (!owner) {
        alert('×× × ×”×›× ×¡ ×©× ×‘×¢×œ ×”×¨×›×‘');
        return;
      }
      
      await performFieldFilter('owner', owner, `×‘×¢×œ ×”×¨×›×‘: ${owner}`);
    };

    window.filterByGarage = async function() {
      const garage = document.getElementById('garageFilter').value.trim();
      if (!garage) {
        alert('×× × ×”×›× ×¡ ×©× ××•×¡×š');
        return;
      }
      
      await performFieldFilter('garage', garage, `××•×¡×š: ${garage}`);
    };

    window.filterByDirective = async function() {
      const directive = document.getElementById('directiveFilter').value;
      const directiveText = document.getElementById('directiveFilter').selectedOptions[0].text;
      
      if (!directive) {
        alert('×× × ×‘×—×¨ ×“×™×¨×§×˜×™×‘×”');
        return;
      }
      
      await performFieldFilter('directive', directive, `×“×™×¨×§×˜×™×‘×”: ${directiveText}`);
    };

    window.filterByClaim = async function() {
      const claim = document.getElementById('claimFilter').value;
      const claimText = document.getElementById('claimFilter').selectedOptions[0].text;
      
      if (!claim) {
        alert('×× × ×‘×—×¨ ×¡×˜×˜×•×¡ ×ª×‘×™×¢×”');
        return;
      }
      
      await performFieldFilter('claim', claim, `×ª×™×§ ×‘×ª×‘×™×¢×”: ${claimText}`);
    };

    window.filterByInvoicePayment = async function() {
      const invoice = document.getElementById('invoiceFilter').value;
      const payment = document.getElementById('paymentFilter').value;
      
      if (!invoice && !payment) {
        alert('×× × ×‘×—×¨ ×œ×¤×—×•×ª ××—×“ ××”×¡×™× ×•× ×™×');
        return;
      }
      
      const resultsDiv = document.getElementById('trackingResults');
      resultsDiv.innerHTML = `
        <div style="background: #333; padding: 12px; border-radius: 8px; border: 1px solid #555; color: #e0e0e0; text-align: center;">
          <h4 style="color: #ff6b35; margin-bottom: 8px;">ğŸ” ××—×¤×© ×ª×™×§×™× ×œ×¤×™ ××¡××›×™×</h4>
          <p>×× × ×”××ª×Ÿ...</p>
        </div>`;
      
      try {
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available - page still loading');
        }
        
        const response = await window.sendToWebhook('ADMIN_FETCH_FIELDS', {
          filter_type: 'documents',
          invoice_received: invoice,
          payment_received: payment,
          action: 'field_review'
        });
        
        const filterDesc = `${invoice ? '×—×©×‘×•× ×™×ª: ' + (invoice === 'yes' ? '×›×Ÿ' : '×œ×') : ''}${invoice && payment ? ', ' : ''}${payment ? '×ª×©×œ×•×: ' + (payment === 'yes' ? '×›×Ÿ' : '×œ×') : ''}`;
        displayFieldResults('××¡××›×™×', filterDesc, response);
      } catch (error) {
        displayFieldError('×¡×™× ×•×Ÿ ××¡××›×™×', error.message);
      }
    };

    window.clearAllFilters = function() {
      document.getElementById('dateFrom').value = '';
      document.getElementById('dateTo').value = '';
      document.getElementById('plateFilter').value = '';
      document.getElementById('statusFilter').value = '';
      document.getElementById('manufacturerFilter').value = '';
      document.getElementById('ownerFilter').value = '';
      document.getElementById('garageFilter').value = '';
      document.getElementById('directiveFilter').value = '';
      document.getElementById('claimFilter').value = '';
      document.getElementById('invoiceFilter').value = '';
      document.getElementById('paymentFilter').value = '';
      
      document.getElementById('trackingResults').innerHTML = `
        <div style="background: #333; padding: 15px; border-radius: 8px; border: 1px solid #555; color: #ccc; text-align: center;">
          <p>âœ… ×›×œ ×”×¡×™× ×•× ×™× × ×•×§×•</p>
          <p style="font-size: 12px; color: #999;">×‘×—×¨ ××¤×©×¨×•×™×•×ª ×¡×™× ×•×Ÿ ×—×“×©×•×ª ×›×“×™ ×œ×—×¤×©</p>
        </div>`;
    };

    window.exportResults = function() {
      alert('×¤×•× ×§×¦×™×™×ª ×™×™×¦×•× ×ª×”×™×” ×–××™× ×” ×‘×’×¨×¡×” ×”×‘××” - ×™×¦×•× ×œ×§×•×‘×¥ Excel/CSV');
    };

    window.performFieldFilter = async function(filterType, filterValue, displayName) {
      const resultsDiv = document.getElementById('trackingResults');
      resultsDiv.innerHTML = `
        <div style="background: #333; padding: 12px; border-radius: 8px; border: 1px solid #555; color: #e0e0e0; text-align: center;">
          <h4 style="color: #ff6b35; margin-bottom: 8px;">ğŸ” ××—×¤×©: ${displayName}</h4>
          <p>×× × ×”××ª×Ÿ...</p>
        </div>`;
      
      try {
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available - page still loading');
        }
        
        const response = await window.sendToWebhook('ADMIN_FETCH_FIELDS', {
          filter_type: filterType,
          filter_value: filterValue,
          action: 'field_review'
        });
        
        displayFieldResults(filterType, displayName, response);
      } catch (error) {
        displayFieldError(displayName, error.message);
      }
    };

    window.displayFieldResults = function(filterType, filterDesc, data) {
      const resultsDiv = document.getElementById('trackingResults');
      
      if (!data || (Array.isArray(data) && data.length === 0)) {
        resultsDiv.innerHTML = `
          <div style="background: #333; padding: 12px; border-radius: 8px; border: 1px solid #666; color: #e0e0e0;">
            <h4 style="color: #fbbf24; margin-bottom: 8px;">ğŸ” ×ª×•×¦××•×ª ×—×™×¤×•×©: ${filterDesc}</h4>
            <div style="background: #2a2a2a; padding: 10px; border-radius: 6px; margin-top: 8px; border: 1px solid #444; text-align: center;">
              <p style="color: #999;">âŒ ×œ× × ××¦××• ×ª×™×§×™× ×”×ª×•×××™× ×œ×§×¨×™×˜×¨×™×•× ×™×</p>
            </div>
          </div>`;
        return;
      }
      
      const results = Array.isArray(data) ? data : [data];
      const resultCount = results.length;
      
      let resultsHtml = `
        <div style="background: #333; padding: 12px; border-radius: 8px; border: 1px solid #555; color: #e0e0e0; font-size: 13px;">
          <h4 style="color: #ff6b35; margin-bottom: 8px;">ğŸ“Š ×ª×•×¦××•×ª: ${filterDesc}</h4>
          <div style="margin-bottom: 12px; font-size: 12px; color: #ccc;">
            <span><strong>× ××¦××•:</strong> ${resultCount} ×ª×™×§×™×</span> | 
            <span><strong>×¡×•× ×Ÿ ×œ×¤×™:</strong> ${filterDesc}</span>
          </div>`;
      
      results.forEach((result, index) => {
        const generalInfo = result['×ª×"×¦ ×›×œ×œ×™'] || result;
        const caseNumber = generalInfo['××¡×¤×¨ ×ª×™×§'] || `×ª×™×§-${index + 1}`;
        const plate = generalInfo['××¡.×¨×›×‘'] || generalInfo['plate'] || '×œ× ×–××™×Ÿ';
        const manufacturer = generalInfo['×©× ×”×™×¦×¨×Ÿ'] || '×œ× ×–××™×Ÿ';
        const owner = generalInfo['×©× ×‘×¢×œ ×”×¨×›×‘'] || '×œ× ×–××™×Ÿ';
        const status = generalInfo['×¡×˜×˜×•×¡ ×›×œ×œ×™'] || '×œ× ×–××™×Ÿ';
        
        resultsHtml += `
          <div style="background: #2a2a2a; padding: 10px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #444;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 12px;">
              <div>
                <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">××¡×¤×¨ ×ª×™×§:</strong> ${caseNumber}</div>
                <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">××¡. ×¨×›×‘:</strong> ${plate}</div>
              </div>
              <div>
                <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">×™×¦×¨×Ÿ:</strong> ${manufacturer}</div>
                <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">×‘×¢×œ×™×:</strong> ${owner}</div>
              </div>
              <div>
                <div style="margin-bottom: 4px;"><strong style="color: #f87171;">×¡×˜×˜×•×¡:</strong> ${status}</div>
                <button onclick="loadCaseDetailsFromResult('${plate}')" style="padding: 4px 8px; background: #ff6b35; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">×¤×¨×˜×™× ××œ××™×</button>
              </div>
            </div>
          </div>`;
      });
      
      resultsHtml += `</div>`;
      resultsDiv.innerHTML = resultsHtml;
    };

    window.displayFieldError = function(filterName, errorMessage) {
      const resultsDiv = document.getElementById('trackingResults');
      resultsDiv.innerHTML = `
        <div style="background: #333; padding: 12px; border-radius: 8px; border: 1px solid #666; color: #e0e0e0;">
          <h4 style="color: #ef4444; margin-bottom: 8px;">âŒ ×©×’×™××” ×‘${filterName}</h4>
          <div style="background: #2a2a2a; padding: 10px; border-radius: 6px; margin-top: 8px; border: 1px solid #666; color: #f87171;">
            <p><strong>×©×’×™××”:</strong> ${errorMessage}</p>
            <p style="font-size: 12px; color: #ccc;">×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨ ××• ×‘×“×•×§ ××ª ×”×§×¨×™×˜×¨×™×•× ×™×</p>
          </div>
        </div>`;
    };

    window.loadCaseDetailsFromResult = function(plate) {
      // Switch to case status section and search for the plate
      loadSection('caseStatus');
      setTimeout(() => {
        document.getElementById('plateSearch').value = plate;
        searchCaseStatus();
      }, 100);
    };

    window.addReminder = function() {
      const newReminder = prompt('×”×›× ×¡ ×ª×•×›×Ÿ ×”×ª×–×›×•×¨×ª:');
      if (newReminder) {
        const remindersList = document.getElementById('remindersList');
        remindersList.innerHTML += `
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
            <h4>${newReminder}</h4>
            <p>×ª××¨×™×š: ${new Date().toLocaleDateString('he-IL')}</p>
            <p>×¡×˜×˜×•×¡: ×¤×¢×™×œ</p>
            <button onclick="editReminder(${Date.now()})" style="padding: 5px 10px; background: #ffc107; color: black; border: none; border-radius: 4px; margin-left: 5px;">×¢×¨×•×š</button>
            <button onclick="deleteReminder(${Date.now()})" style="padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px;">××—×§</button>
          </div>`;
      }
    };

    window.editReminder = function(id) {
      alert('×¤×•× ×§×¦×™×™×ª ×¢×¨×™×›×” ×ª×–×›×•×¨×ª - ID: ' + id);
    };

    window.deleteReminder = function(id) {
      if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×ª×–×›×•×¨×ª?')) {
        alert('×”×ª×–×›×•×¨×ª × ××—×§×”');
      }
    };

    window.loadCaseForEdit = function() {
      const plate = document.getElementById('editPlateSearch').value.trim();
      if (!plate) {
        alert('×× × ×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘');
        return;
      }
      
      document.getElementById('editResults').innerHTML = `
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeaa7;">
          <h4>×¢×¨×™×›×ª ×ª×™×§: ${plate}</h4>
          <p>×¤×•× ×§×¦×™×™×ª ×¢×¨×™×›×” × ×ª×•× ×™× ×ª×”×™×” ×–××™× ×” ×‘×’×¨×¡×” ×”×‘××”</p>
          <p>× ×›×•×Ÿ ×œ×¢×›×©×™×• × ×™×ª×Ÿ ×œ×¦×¤×•×ª ×‘× ×ª×•× ×™× ×‘×œ×‘×“</p>
        </div>`;
    };

    window.refreshLog = function() {
      document.getElementById('logContent').innerHTML = `
        <div style="border-bottom: 1px solid #ddd; padding: 10px 0;">
          <strong>${new Date().toLocaleString('he-IL')}</strong> - ×™×•××Ÿ ×¨×•×¢× ×Ÿ ×¢×œ ×™×“×™ ×× ×”×œ
        </div>
        <div style="border-bottom: 1px solid #ddd; padding: 10px 0;">
          <strong>${new Date().toLocaleString('he-IL')}</strong> - ××©×ª××© × ×›× ×¡ ×œ××¢×¨×›×ª ×”× ×™×”×•×œ
        </div>
        <div style="border-bottom: 1px solid #ddd; padding: 10px 0;">
          <strong>${new Date(Date.now() - 3600000).toLocaleString('he-IL')}</strong> - ×¢×•×“×›×Ÿ ××¢"× ×’×œ×•×‘×œ×™ ×œ-18%
        </div>`;
    };

    window.exportLog = function() {
      alert('×™×•××Ÿ ×™×•×¦× ×œ×§×•×‘×¥ CSV - ×¤×•× ×§×¦×™×” ×ª×”×™×” ×–××™× ×” ×‘×’×¨×¡×” ×”×‘××”');
    };

  
  // Add to existing DOMContentLoaded event from first script
  document.addEventListener('DOMContentLoaded', () => {
    // Check if user has basic authentication
    const auth = sessionStorage.getItem('auth');
    if (!auth) {
      console.log('âŒ No auth token found in admin.html, redirecting to login');
      alert('×”×’×™×©×” ×—×¡×•××” - ×× × ×”×ª×—×‘×¨ ×“×¨×š ×“×£ ×”×‘×™×ª');
      window.location.href = 'index.html';
      return;
    }
    
    // Check for admin-specific access
    const adminAccess = sessionStorage.getItem('admin-access');
    const adminTimestamp = sessionStorage.getItem('admin-timestamp');
    
    if (!adminAccess || !adminAccess.includes('granted')) {
      console.log('âŒ No admin access token found, redirecting to selection');
      alert('×’×™×©×ª ×× ×”×œ × ×“×¨×©×ª - ×× × ×××ª ××ª ×”×–×”×•×ª ×©×œ×š ×“×¨×š ×¢××•×“ ×”×‘×—×™×¨×”');
      window.location.href = 'selection.html';
      return;
    }
    
    // Check if admin session is still valid (24 hours)
    if (adminTimestamp) {
      const sessionAge = Date.now() - new Date(adminTimestamp).getTime();
      const maxAge = 24 * 60 * 60 * 1000; // 24 hours
      
      if (sessionAge > maxAge) {
        console.log('âŒ Admin session expired, redirecting to selection');
        sessionStorage.removeItem('admin-access');
        sessionStorage.removeItem('admin-timestamp');
        alert('×ª×•×§×£ ×’×™×©×ª ×”×× ×”×œ ×¤×’ - ×× × ×”×ª×—×‘×¨ ××—×“×©');
        window.location.href = 'selection.html';
        return;
      }
    }
    
    console.log('âœ… Admin access verified, loading admin panel');
    console.log('Admin access type:', adminAccess);
    
    // Load VAT from session
    const existingVat = sessionStorage.getItem('globalVAT');
    if (existingVat) {
      document.getElementById('vat-input').value = existingVat;
    }
  });
</script>

<script>
// Global dev access function - non-module script for immediate availability
async function verifyDevAccess() {
  const password = prompt("Enter developer password:");
  if (!password) return;
  
  // Get button reference
  const submitBtn = document.getElementById('devButton');
  const originalText = submitBtn?.textContent || 'Developer Panel';
  
  try {
    // Show loading state
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = '××ª×—×‘×¨ ×œ××¢×¨×›×ª...';
    }
    
    // Check for direct dev module access
    if (password === 'dev_admin_2025') {
      sessionStorage.setItem('dev-access', 'granted');
      if (submitBtn) {
        submitBtn.textContent = 'âœ… ×’×™×©×” ××•×©×¨×”';
      }
      setTimeout(() => {
        window.location.href = 'dev-module.html';
      }, 500);
      return;
    }
    
    // Import webhooks dynamically with fallback
    let sendToWebhook;
    let WEBHOOKS;
    try {
      const webhookModule = await import('./webhook.js');
      sendToWebhook = webhookModule.sendToWebhook;
      WEBHOOKS = webhookModule.WEBHOOKS;
      console.log('âœ… Successfully imported webhook module');
    } catch (importError) {
      console.error('Failed to import webhook module:', importError);
      // Fallback webhook URL
      WEBHOOKS = {
        DEV_HUB: 'https://hook.eu2.make.com/cg8j5gu0wyum6yrbl4rz2myd0pew3znt'
      };
      console.log('âš ï¸ Using fallback webhook URL');
    }
    
    // Use direct fetch if sendToWebhook is not available
    let response;
    if (sendToWebhook) {
      console.log('ğŸ” Attempting DEV_HUB webhook verification via sendToWebhook...');
      response = await sendToWebhook('DEV_HUB', { 
        password,
        action: 'dev_login',
        timestamp: new Date().toISOString(),
        user_auth: sessionStorage.getItem('auth')
      });
    } else {
      console.log('ğŸ” Attempting DEV_HUB webhook verification via direct fetch...');
      const fetchResponse = await fetch(WEBHOOKS.DEV_HUB, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          password,
          action: 'dev_login',
          timestamp: new Date().toISOString(),
          user_auth: sessionStorage.getItem('auth')
        })
      });
      
      console.log('ğŸ” DEV_HUB fetch response status:', fetchResponse.status);
      
      if (!fetchResponse.ok) {
        throw new Error(`HTTP ${fetchResponse.status}: ${fetchResponse.statusText}`);
      }
      
      try {
        response = await fetchResponse.json();
      } catch (jsonError) {
        console.log('Response is not JSON, getting text...');
        response = await fetchResponse.text();
      }
    }
    
    console.log('ğŸ” DEV_HUB webhook response:', response);
    
    // Enhanced dev access validation with multiple patterns
    const isDevAccess = 
      // JSON response patterns
      response?.role === 'dev' || 
      response?.access === 'dev' ||
      response?.status === 'dev' ||
      response?.result === 'dev' ||
      response?.access_granted === true ||
      response?.dev === true ||
      response?.authenticated === true ||
      response?.valid === true ||
      
      // Check for success indicators
      response?.success === true ||
      response?.approved === true ||
      
      // String response patterns (if response is just a string) - FIXED
      (typeof response === 'string' && /^(dev|success|granted|approved|valid|authenticated|true)$/i.test(response.trim())) ||
      
      // Handle webhook response that returns "approved" as seen in console
      response === 'approved' ||
      response === 'dev' ||
      response === 'granted';
    
    console.log('ğŸ” Dev access validation result:', isDevAccess);
    console.log('ğŸ” Response details:', {
      response,
      type: typeof response,
      stringValue: typeof response === 'string' ? response.trim() : 'not a string',
      regexTest: typeof response === 'string' ? /^(dev|success|granted|approved|valid|authenticated|true)$/i.test(response.trim()) : 'not tested'
    });
    
    if (isDevAccess) {
      console.log('âœ… Dev access granted via webhook');
      sessionStorage.setItem('dev-access', 'granted');
      if (submitBtn) {
        submitBtn.textContent = 'âœ… ×’×™×©×” ××•×©×¨×”';
      }
      setTimeout(() => {
        window.location.href = 'dev-module.html';
      }, 500);
    } else {
      console.error('âŒ Dev access denied');
      console.error('Response details:', response);
      if (submitBtn) {
        submitBtn.textContent = 'âŒ ×’×™×©×” × ×“×—×ª×”';
        setTimeout(() => {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }, 2000);
      }
      alert('âŒ Access denied: incorrect password or insufficient privileges');
    }
    
  } catch (err) {
    console.error('Dev login failed:', err);
    
    if (submitBtn) {
      submitBtn.textContent = 'âŒ ×©×’×™××ª ×—×™×‘×•×¨';
      setTimeout(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }, 2000);
    }
    
    let errorMessage = '×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª ×”××™××•×ª';
    
    if (err.message.includes('Failed to fetch')) {
      errorMessage = '×©×’×™××ª ×¨×©×ª - ×‘×“×•×§ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜';
    } else if (err.message.includes('timeout')) {
      errorMessage = '×¤×’ ×–××Ÿ ×”×—×™×‘×•×¨ - × ×¡×” ×©×•×‘';
    }
    
    alert(`ğŸš« Verification failed: ${errorMessage}`);
    
    // Emergency fallback only if it's a network error
    if (err.message.includes('HTTP') || err.message.includes('network')) {
      const fallbackAccess = confirm('Server connection failed. Use offline emergency access?');
      if (fallbackAccess && password === 'dev_admin_2025') {
        sessionStorage.setItem('dev-access', 'granted-offline');
        window.location.href = 'dev-module.html';
      }
    }
  }
}

// Ensure function is globally available
window.verifyDevAccess = verifyDevAccess;
</script>

  </div>
</body>
</html>
