<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>מרכז ניהול - ירון כיוף</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link href="https://fonts.googleapis.com/css2?family=Assistant&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css">
  <script type="module" src="./admin.js?v=2025070901"></script>
  <script type="module" src="./helper.js?v=2025070901"></script>
  <script type="module" src="./webhook.js?v=2025070901"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #1a1a1a;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: right;
      min-height: 80vh;
      color: #e0e0e0;
    }
    .container {
      max-width: 550px;
      width: 100%;
      background: #2a2a2a;
      padding: 10px 10px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      text-align: center;
      position: relative;
      border: 1px solid #444;
    }
    header {
      background-color: #333;
      color: #ff6b35;
      padding: 20px;
      text-align: center;
      font-size: 22px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 2px solid #ff6b35;
    }
    .admin-container {
      display: grid;
      grid-template-columns: 1fr 2fr;
      min-height: 80vh;
    }
    
    /* Mobile-only fix for tracking form overflow */
    @media (max-width: 768px) {
      .admin-container .form-container {
        padding: 10px;
        max-width: 100vw;
        width: 100%;
        box-sizing: border-box;
        overflow-x: hidden;
      }
      
      .admin-container .form-container > div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
        gap: 10px !important;
        width: 100%;
        max-width: 100%;
      }
      
      .admin-container input, .admin-container select {
        font-size: 16px !important;
        width: 100% !important;
        max-width: 100%;
        box-sizing: border-box !important;
      }
      
      .admin-container input[type="date"] {
        font-size: 16px !important;
        color: #e0e0e0 !important;
        padding: 10px !important;
        height: 44px !important;
        max-width: 100%;
      }
    }
    
    .logo img {
      width: 100px;
    }
    .title { font-size: 24px; font-weight: bold; color: #ff6b35; }
    .subtitle { font-size: 18px; color: #ccc; margin-bottom: 5px; }
    .legal-note {
      color: red;
      font-weight: bold;
      margin-bottom: 15px;
    }
    h1 {
      font-size: 24px;
      color: #ff6b35;
      margin-bottom: 20px;
    }
    h2 {
      font-size: 20px;
      color: #ff6b35;
      margin-bottom: 20px;
    }
    nav {
      background: #333;
      padding: 20px;
      border-left: 3px solid #ff6b35;
      border-radius: 8px;
    }
    nav button {
      display: block;
      margin-bottom: 10px;
      width: 100%;
      padding: 10px;
      background: #444;
      color: #ff6b35;
      border: 1px solid #ff6b35;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    nav button:hover {
      background: #ff6b35;
      color: #333;
    }
    .vat-config {
      margin-top: 30px;
      text-align: center;
    }
    .vat-config label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #e0e0e0;
    }
    .vat-config input {
      width: 80%;
      padding: 8px;
      border: 1px solid #666;
      border-radius: 6px;
      margin-bottom: 8px;
      background: #444;
      color: #e0e0e0;
    }
    .vat-config button {
      padding: 8px 16px;
      background-color: #ff6b35;
      color: #333;
      border: 1px solid #ff6b35;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    main {
      padding: 30px;
      background: #2a2a2a;
      border-radius: 8px;
      color: #e0e0e0;
    }
    .notification-panel {
      position: fixed;
      bottom: 20px;
      left: 20px;
      max-width: 320px;
      background: #333;
      border: 1px solid #ff6b35;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
      padding: 10px;
      z-index: 1000;
      font-size: 14px;
      color: #e0e0e0;
    }
    .notification-panel h4 { margin: 0 0 8px 0; font-size: 16px; color: #ff6b35; }
    .notification-item {
      background: #444;
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #666;
    }
    .notification-actions button {
      margin-top: 5px;
      margin-right: 5px;
      font-size: 12px;
      padding: 4px 8px;
    }
    .devButton {
      background-color: #c0392b !important;
      color: white;
      border: 1px solid #922b21;
      font-weight: bold;
    }
    .footer {
      text-align: center;
      font-size: 12px;
      margin-top: 30px;
      color: #ccc;
      border-top: 1px solid #444;
      padding-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo" style="margin-bottom: 1px;">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo" />
    </div>
    <div class="title">ירון כיוף שמאות - פורטל</div>
    <div class="subtitle">שמאות והערכת נזקי רכב ורכוש</div>
    <header>מרכז ניהול - ירון כיוף</header>
    <div class="admin-container">
      <nav>
        <button onclick="loadSection('caseStatus')">סטטוס תיקים</button>
        <button onclick="loadSection('tracking')">סקירה לפי שדות</button>
        <button onclick="loadSection('reminders')">רשימת תזכורות</button>
        <button onclick="loadSection('override')">שינוי נתונים</button>
        <button onclick="loadSection('logView')">יומן פעולות</button>
        <button onclick="window.open('https://ycshamautcoil-my.sharepoint.com/personal/yaron_yc-shamaut_co_il/_layouts/15/onedrive.aspx?id=%2Fpersonal%2Fyaron%5Fyc%2Dshamaut%5Fco%5Fil%2FDocuments%2FYC%20שמאות%2Fתיקים%20פתוחים&ga=1', '_blank')">כניסה לתיקים פתוחים</button>
        <button class="devButton" onclick="window.location.href='validation-dashboard.html'">לוח בקרת אימות</button>
        <div class="vat-config">
          <label for="vat-input">מע"מ גלובלי (%)</label>
          <input id="vat-input" type="number" step="0.01" placeholder="18">
          <button id="save-admin-settings">שמור מע"מ</button>
        </div>
        <button id="devButton" class="devButton" onclick="verifyDevAccess()">Developer Panel</button>
        <button onclick="window.location.href='selection.html'" style="margin-top: 10px; padding: 12px 24px; background: #333; color: #ff6b35; border: 2px solid #ff6b35; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.3s ease; width: 100%;" onmouseover="this.style.background='#ff6b35'; this.style.color='#333';" onmouseout="this.style.background='#333'; this.style.color='#ff6b35';">🏠 חזור לדף בחירה</button>
      </nav>
      <main id="adminContent">
        <p>בחר פעולה מהתפריט הימני כדי להתחיל.</p>
      </main>
    </div>
    <div id="notificationPanel" class="notification-panel" style="display:none;">
      <h4>הודעות מערכת</h4>
      <div id="notificationList"></div>
    </div>
    <div class="footer">All rights reserved © Carmel Cayouf</div>
    <script type="module">
      import { MathEngine } from './math.js';
      import { sendToWebhook } from './webhook.js';
      
      document.addEventListener('DOMContentLoaded', () => {
        const saveBtn = document.getElementById('save-admin-settings');
        if (!saveBtn) {
          console.error('Save admin settings button not found');
          return;
        }
        
        saveBtn.addEventListener('click', async () => {
        const vat = parseFloat(document.getElementById('vat-input').value);
        if (isNaN(vat) || vat < 0 || vat > 100) {
          alert('ערך מע"מ לא חוקי');
          return;
        }
        
        const submitBtn = document.getElementById('save-admin-settings');
        const originalText = submitBtn.textContent;
        
        try {
          // Show loading state
          submitBtn.disabled = true;
          submitBtn.textContent = 'שומר הגדרות...';
          
          // Save to server with validation
          const adminSettings = {
            vat_rate: vat,
            timestamp: new Date().toISOString(),
            admin_user: sessionStorage.getItem('auth') || 'admin'
          };
          
          const response = await sendToWebhook('ADMIN_HUB', {
            action: 'update_settings',
            settings: adminSettings
          });
          
          // If server validation passes, save locally
          MathEngine.setVatRate(vat);
          sessionStorage.setItem('globalVAT', vat.toString());
          
          submitBtn.textContent = '✅ נשמר בהצלחה';
          alert(`✅ מע"מ עודכן ל-${vat}% במערכת ובשרת`);
          
        } catch (error) {
          console.error('Admin settings save error:', error);
          alert(`❌ שגיאה בשמירת הגדרות: ${error.message}`);
          
          // Reset button state
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
        
        // Reset button after 2 seconds
        setTimeout(() => {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }, 2000);
        });
      });
    </script>
    
    <script>
    // Define loadSection globally so it's available immediately
    window.loadSection = function(id) {
      const content = document.getElementById('adminContent');
      
      switch(id) {
        case 'caseStatus':
          content.innerHTML = `
            <h2>📊 סטטוס תיקים</h2>
            <div style="margin-bottom: 20px;">
              <input type="text" id="plateSearch" placeholder="הכנס מספר רכב לחיפוש" style="padding: 8px; margin-right: 10px; width: 200px;">
              <button onclick="searchCaseStatus()" style="padding: 8px 16px; background: #ff6b35; color: white; border: none; border-radius: 4px;">חפש תיק</button>
              <button onclick="exportCaseStatus()" 
                      onmouseover="this.style.background='#047857'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)';"
                      onmouseout="this.style.background='#059669'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)';"
                      style="padding: 8px 16px; background: #059669; color: white; border: none; border-radius: 4px; margin-right: 10px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                📤 ייצא
              </button>
            </div>
            <div id="caseResults">
              <p>הכנס מספר רכב לצפייה בסטטוס התיק</p>
            </div>`;
          break;
          
        case 'tracking':
          content.innerHTML = `
            <h2 style="color: #ff6b35; margin-bottom: 15px;">📋 סקירה לפי שדות</h2>
            
            <!-- Single Filter Form -->
            <div class="form-container" style="background: #333; padding: 20px; border-radius: 8px; border: 1px solid #555; margin-bottom: 20px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                
                <!-- Date Range -->
                <div>
                  <label style="color: #ff6b35; font-size: 13px; margin-bottom: 5px; display: block;">טווח תאריכים</label>
                  <input type="date" id="dateFrom" style="width: 100%; padding: 10px; margin-bottom: 5px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px; height: 40px;">
                  <input type="date" id="dateTo" style="width: 100%; padding: 10px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px; height: 40px;">
                </div>


                <!-- Manufacturer -->
                <div>
                  <label style="color: #ff6b35; font-size: 13px; margin-bottom: 5px; display: block;">יצרן</label>
                  <input type="text" id="manufacturerFilter" placeholder="הכנס שם יצרן" style="width: 100%; padding: 10px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px; height: 40px;">
                </div>

                <!-- Owner -->
                <div>
                  <label style="color: #ff6b35; font-size: 13px; margin-bottom: 5px; display: block;">בעל הרכב</label>
                  <input type="text" id="ownerFilter" placeholder="הכנס שם בעל הרכב" style="width: 100%; padding: 10px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px; height: 40px;">
                </div>

                <!-- Garage -->
                <div>
                  <label style="color: #ff6b35; font-size: 13px; margin-bottom: 5px; display: block;">מוסך</label>
                  <input type="text" id="garageFilter" placeholder="הכנס שם מוסך" style="width: 100%; padding: 10px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px; height: 40px;">
                </div>
               
                <!-- Directive  -->
                <div>
                  <label style="color: #ff6b35; font-size: 13px; margin-bottom: 5px; display: block;">דירקטיבה</label>
                  <select id="statusFilter" style="width: 100%; padding: 10px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px; height: 40px;">
                    <option value="">הכל</option>
                    <option value="ללא דירקטיבה">ללא דירקטיבה</option>
                    <option value="לתיקון">לתיקון</option>
                    <option value="טוטאלוס TL">טוטאלוס TL</option>
                    <option value="לא לתיקון בשלב זה להכין הצעת מחיר">לא לתיקון בשלב זה להכין הצעת מחיר</option>
                    <option value="אובדן להלכה">אובדן להלכה</option>
                    <option value="מכירה במצבו הניזוק">מכירה במצבו הניזוק</option>
                    <option value="להכין הצעת מחיר">להכין הצעת מחיר</option>
                  </select>
                </div>
       
                <!-- Case in Claim -->
                <div>
                  <label style="color: #ff6b35; font-size: 13px; margin-bottom: 5px; display: block;">תיק בתביעה</label>
                  <select id="claimFilter" style="width: 100%; padding: 10px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px; height: 40px;">
                    <option value="">הכל</option>
                    <option value="yes">כן</option>
                    <option value="no">לא</option>
                    <option value="pending">בהמתנה</option>
                  </select>
                </div>

                <!-- Invoice Status -->
                <div>
                  <label style="color: #ff6b35; font-size: 13px; margin-bottom: 5px; display: block;">חשבונית התקבלה</label>
                  <select id="invoiceFilter" style="width: 100%; padding: 10px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px; height: 40px;">
                    <option value="">הכל</option>
                    <option value="yes">כן</option>
                    <option value="no">לא</option>
                  </select>
                </div>

                <!-- Payment Status -->
                <div>
                  <label style="color: #ff6b35; font-size: 13px; margin-bottom: 5px; display: block;">תשלום התקבל</label>
                  <select id="paymentFilter" style="width: 100%; padding: 10px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 12px; height: 40px;">
                    <option value="">הכל</option>
                    <option value="yes">כן</option>
                    <option value="no">לא</option>
                  </select>
                </div>
              </div>

              <!-- Single Action Buttons -->
              <div style="display: flex; justify-content: center; gap: 15px; border-top: 1px solid #555; padding-top: 20px; margin-top: 20px;">
                <button onclick="performSearch()" 
                        onmouseover="this.style.background='#e55a2b'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)';"
                        onmouseout="this.style.background='#ff6b35'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)';"
                        style="padding: 15px 35px; background: #ff6b35; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                  🔍 חפש
                </button>
                <button onclick="clearAllFilters()"
                        onmouseover="this.style.background='#5a6268'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)';"
                        onmouseout="this.style.background='#6b7280'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)';"
                        style="padding: 15px 30px; background: #6b7280; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                  🗑️ נקה הכל
                </button>
                <button onclick="exportResults()"
                        onmouseover="this.style.background='#047857'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)';"
                        onmouseout="this.style.background='#059669'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)';"
                        style="padding: 15px 30px; background: #059669; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                  📤 ייצא
                </button>
              </div>
            </div>

            <div id="trackingResults" style="margin-top: 20px;">
              <div style="background: #333; padding: 15px; border-radius: 8px; border: 1px solid #555; color: #ccc; text-align: center;">
                <p>הגדר פרמטרי חיפוש ולחץ על כפתור "חפש" כדי לצפות בתוצאות</p>
                <p style="font-size: 12px; color: #999;">ניתן לשלב מספר פרמטרים לחיפוש מדויק יותר</p>
              </div>
            </div>`;
          break;
          
        case 'reminders':
          content.innerHTML = `
            <h2 style="color: #ff6b35; font-size: 24px; margin-bottom: 20px;">🔔 רשימת תזכורות</h2>
            
            <!-- Data Status and Primary Actions -->
            <div style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #555;">
              <div id="dataStatusDisplay" style="margin-bottom: 15px; padding: 10px; border-radius: 6px; background: #2a2a2a; border: 1px solid #444;">
                <div style="color: #ff6b35; font-weight: bold; margin-bottom: 5px;">מצב נתונים:</div>
                <div id="dataStatusText" style="color: #ccc; font-size: 14px;">לא נטענו תזכורות - בחר פרמטרי סינון וטען תזכורות מהשרת</div>
              </div>
              
              <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; justify-content: center;">
                <button onclick="addReminder()" 
                        onmouseover="this.style.background='#059669'; this.style.transform='translateY(-2px)'; this.title='הוסף תזכורת חדשה';"
                        onmouseout="this.style.background='#16a34a'; this.style.transform='translateY(0)'; this.title='';"
                        style="padding: 10px; background: #16a34a; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 12px; font-weight: bold; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; position: relative;">
                  ➕
                </button>
                
                <button onclick="startVoiceReminder()" 
                        onmouseover="this.style.background='#8b5cf6'; this.style.transform='translateY(-2px)'; this.title='צור תזכורת באמצעות קול';"
                        onmouseout="this.style.background='#7c3aed'; this.style.transform='translateY(0)'; this.title='';"
                        style="padding: 10px; background: #7c3aed; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 12px; font-weight: bold; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; position: relative;">
                  🎤
                </button>
                
                <button onclick="showLoadRemindersModal()" 
                        onmouseover="this.style.background='#e55a2b'; this.style.transform='translateY(-2px)'; this.title='טען תזכורות עם סינון מהשרת';"
                        onmouseout="this.style.background='#ff6b35'; this.style.transform='translateY(0)'; this.title='';"
                        style="padding: 10px; background: #ff6b35; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 12px; font-weight: bold; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; position: relative;">
                  📥
                </button>
                
                <button id="refreshDataBtn" onclick="refreshReminders()" disabled
                        onmouseover="if(!this.disabled) { this.style.background='#6366f1'; this.style.transform='translateY(-2px)'; this.title='רענן רשימת תזכורות'; }"
                        onmouseout="if(!this.disabled) { this.style.background='#4f46e5'; this.style.transform='translateY(0)'; this.title=''; }"
                        style="padding: 10px; background: #4f46e5; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 12px; opacity: 0.5; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; position: relative;">
                  🔄
                </button>
              </div>
            </div>
            
            <!-- Local Filtering Controls (Initially Disabled) -->
            <div id="localFilterControls" style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #555; opacity: 0.5;">
              <div style="margin-bottom: 10px; color: #ff6b35; font-weight: bold;">סינון מקומי (זמין לאחר טעינת נתונים):</div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                  <label style="color: #e0e0e0; font-size: 14px; margin-bottom: 5px; display: block;">סינון לפי סטטוס:</label>
                  <select id="localStatusFilter" disabled style="padding: 8px; border-radius: 4px; border: 1px solid #555; background: #444; color: #e0e0e0; width: 100%;">
                    <option value="all">כל הסטטוסים</option>
                    <option value="active">פעיל</option>
                    <option value="pending">ממתין</option>
                    <option value="completed">הושלם</option>
                    <option value="overdue">פג תוקף</option>
                  </select>
                </div>
                <div>
                  <label style="color: #e0e0e0; font-size: 14px; margin-bottom: 5px; display: block;">סינון לפי קטגוריה:</label>
                  <select id="localCategoryFilter" disabled style="padding: 8px; border-radius: 4px; border: 1px solid #555; background: #444; color: #e0e0e0; width: 100%;">
                    <option value="all">כל הקטגוריות</option>
                    <option value="case_deadline">מועד סגירת תיק</option>
                    <option value="payment_reminder">תזכורת תשלום</option>
                    <option value="follow_up">מעקב</option>
                    <option value="inspection">בדיקה</option>
                    <option value="general">כללי</option>
                  </select>
                </div>
              </div>
              
              <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap; justify-content: center;">
                <button id="localFilterBtn" onclick="applyLocalFilters()" disabled
                        onmouseover="if(!this.disabled) { this.style.background='#3b82f6'; this.style.transform='translateY(-2px)'; this.title='סנן תזכורות לפי הקריטריונים שנבחרו'; }"
                        onmouseout="if(!this.disabled) { this.style.background='#1d4ed8'; this.style.transform='translateY(0)'; this.title=''; }"
                        style="padding: 10px; background: #1d4ed8; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 12px; opacity: 0.5; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; position: relative;">
                  🔍
                </button>
                
                <button id="toggleViewBtn" onclick="toggleView()" disabled
                        onmouseover="if(!this.disabled) { this.style.background='#9333ea'; this.style.transform='translateY(-2px)'; this.title='החלף בין תצוגת רשימה לתצוגת יומן'; }"
                        onmouseout="if(!this.disabled) { this.style.background='#7c3aed'; this.style.transform='translateY(0)'; this.title=''; }"
                        style="padding: 10px; background: #7c3aed; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 12px; opacity: 0.5; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; position: relative;">
                  📅
                </button>
                
                <button id="exportBtn" onclick="exportReminders()" disabled
                        onmouseover="if(!this.disabled) { this.style.background='#f59e0b'; this.style.transform='translateY(-2px)'; this.title='ייצא תזכורות לקובץ JSON'; }"
                        onmouseout="if(!this.disabled) { this.style.background='#d97706'; this.style.transform='translateY(0)'; this.title=''; }"
                        style="padding: 10px; background: #d97706; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 12px; opacity: 0.5; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; position: relative;">
                  📤
                </button>
                
                <button id="calendarSyncBtn" onclick="showCalendarSyncModal()" disabled
                        onmouseover="if(!this.disabled) { this.style.background='#0ea5e9'; this.style.transform='translateY(-2px)'; this.title='סנכרן עם יומן חיצוני (Google/Outlook)'; }"
                        onmouseout="if(!this.disabled) { this.style.background='#0284c7'; this.style.transform='translateY(0)'; this.title=''; }"
                        style="padding: 10px; background: #0284c7; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 12px; opacity: 0.5; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; position: relative;">
                  🔗
                </button>
              </div>
            </div>
            
            <!-- Reminders List View -->
            <div id="remindersListView" style="display: block;">
              <div id="remindersList">
                <div style="background: #2a2a2a; padding: 15px; border-radius: 8px; margin: 10px 0; border: 1px solid #444;">
                  <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                    <h4 style="color: #4ade80; margin: 0; font-size: 16px;">תזכורת לבדיקת תיקים פתוחים</h4>
                    <span style="background: #16a34a; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">פעיל</span>
                  </div>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; font-size: 14px; color: #ccc;">
                    <div><strong style="color: #fbbf24;">תאריך יעד:</strong> ${new Date(Date.now() + 86400000).toLocaleDateString('he-IL')}</div>
                    <div><strong style="color: #fbbf24;">קטגוריה:</strong> מעקב</div>
                    <div><strong style="color: #fbbf24;">עדיפות:</strong> גבוהה</div>
                    <div><strong style="color: #fbbf24;">נוצר:</strong> ${new Date().toLocaleDateString('he-IL')}</div>
                  </div>
                  <p style="color: #e0e0e0; margin: 10px 0; font-size: 14px;">בדיקה שבועית של תיקים פתוחים העוברים 30 יום ללא פעילות</p>
                  <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button onclick="editReminder(1)" 
                            onmouseover="this.style.background='#f59e0b'; this.style.transform='translateY(-1px)';"
                            onmouseout="this.style.background='#d97706'; this.style.transform='translateY(0)';"
                            style="padding: 8px 16px; background: #d97706; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 13px;">
                      ✏️ ערוך
                    </button>
                    <button onclick="completeReminder(1)" 
                            onmouseover="this.style.background='#059669'; this.style.transform='translateY(-1px)';"
                            onmouseout="this.style.background='#16a34a'; this.style.transform='translateY(0)';"
                            style="padding: 8px 16px; background: #16a34a; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 13px;">
                      ✅ סמן כהושלם
                    </button>
                    <button onclick="deleteReminder(1)" 
                            onmouseover="this.style.background='#dc2626'; this.style.transform='translateY(-1px)';"
                            onmouseout="this.style.background='#991b1b'; this.style.transform='translateY(0)';"
                            style="padding: 8px 16px; background: #991b1b; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 13px;">
                      🗑️ מחק
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Calendar View (Hidden by default) -->
            <div id="remindersCalendarView" style="display: none;">
              <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; border: 1px solid #444;">
                <h3 style="color: #ff6b35; margin-bottom: 15px; text-align: center;">📅 תצוגת יומן תזכורות</h3>
                
                <!-- Calendar Navigation -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                  <button onclick="previousMonth()" style="padding: 8px 16px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; cursor: pointer;">◀ הקודם</button>
                  <h4 id="calendarMonth" style="color: #ff6b35; margin: 0;"></h4>
                  <button onclick="nextMonth()" style="padding: 8px 16px; background: #444; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; cursor: pointer;">הבא ▶</button>
                </div>
                
                <!-- Calendar Grid -->
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 20px;">
                  <!-- Days of week headers -->
                  <div style="background: #333; color: #ff6b35; padding: 8px; text-align: center; font-weight: bold; border-radius: 4px;">א</div>
                  <div style="background: #333; color: #ff6b35; padding: 8px; text-align: center; font-weight: bold; border-radius: 4px;">ב</div>
                  <div style="background: #333; color: #ff6b35; padding: 8px; text-align: center; font-weight: bold; border-radius: 4px;">ג</div>
                  <div style="background: #333; color: #ff6b35; padding: 8px; text-align: center; font-weight: bold; border-radius: 4px;">ד</div>
                  <div style="background: #333; color: #ff6b35; padding: 8px; text-align: center; font-weight: bold; border-radius: 4px;">ה</div>
                  <div style="background: #333; color: #ff6b35; padding: 8px; text-align: center; font-weight: bold; border-radius: 4px;">ו</div>
                  <div style="background: #333; color: #ff6b35; padding: 8px; text-align: center; font-weight: bold; border-radius: 4px;">ש</div>
                </div>
                
                <!-- Calendar Days Container -->
                <div id="calendarDays" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 20px;">
                  <!-- Days will be populated by JavaScript -->
                </div>
                
                <!-- Selected Date Reminders -->
                <div id="selectedDateReminders" style="display: none; background: #333; padding: 15px; border-radius: 8px; border: 1px solid #555;">
                  <h4 style="color: #ff6b35; margin: 0 0 10px 0;">תזכורות ליום <span id="selectedDateText"></span></h4>
                  <div id="selectedDateRemindersList"></div>
                </div>
              </div>
            </div>`;
            
          // Initialize reminder section - no automatic fetching
          setTimeout(() => {
            // Initialize with empty state
            const remindersList = document.getElementById('remindersList');
            if (remindersList) {
              remindersList.innerHTML = `
                <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; border: 1px solid #444; text-align: center;">
                  <h3 style="color: #ff6b35;">👆 התחל על ידי טעינת תזכורות</h3>
                  <p style="color: #ccc;">לחץ על "טען תזכורות עם סינון" כדי לטעון תזכורות רלוונטיות מהשרת</p>
                  <p style="color: #999; font-size: 14px;">זה יאפשר לך לבחור פרמטרי סינון ולטעון רק את המידע שאתה צריך</p>
                </div>`;
            }
          }, 200);
          break;
          
        case 'override':
          content.innerHTML = `
            <h2>✏️ שינוי נתונים</h2>
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeaa7; margin-bottom: 20px;">
              <strong>⚠️ אזהרה:</strong> שינוי נתונים במערכת דורש הרשאות מנהל וגיבוי אוטומטי
            </div>
            <div>
              <h3>חיפוש תיק לעריכה</h3>
              <input type="text" id="editPlateSearch" placeholder="הכנס מספר רכב" style="padding: 8px; margin-right: 10px; width: 200px;">
              <button onclick="loadCaseForEdit()" style="padding: 8px 16px; background: #ff6b35; color: white; border: none; border-radius: 4px;">טען תיק לעריכה</button>
            </div>
            <div id="editResults" style="margin-top: 20px;">
              <p>טען תיק כדי להתחיל עריכה</p>
            </div>`;
          break;
          
        case 'logView':
          content.innerHTML = `
            <h2>📜 יומן פעולות</h2>
            <div style="margin-bottom: 20px;">
              <button onclick="refreshLog()" style="padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 4px;">🔄 רענן יומן</button>
              <button onclick="exportLog()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; margin-right: 10px;">📤 יצא יומן</button>
            </div>
            <div id="logContent" style="background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto;">
              <div style="border-bottom: 1px solid #ddd; padding: 10px 0;">
                <strong>${new Date().toLocaleString('he-IL')}</strong> - משתמש נכנס למערכת הניהול
              </div>
              <div style="border-bottom: 1px solid #ddd; padding: 10px 0;">
                <strong>${new Date(Date.now() - 3600000).toLocaleString('he-IL')}</strong> - עודכן מע"מ גלובלי ל-18%
              </div>
              <div style="border-bottom: 1px solid #ddd; padding: 10px 0;">
                <strong>${new Date(Date.now() - 7200000).toLocaleString('he-IL')}</strong> - נוצר תיק חדש עבור רכב 123-45-678
              </div>
            </div>`;
          break;
          
        default:
          content.innerHTML = `<p>טוען ${id}...</p>`;
      }
    };

    // Define performSearch function globally to be accessible by onclick
    window.performSearch = async function() {
      const resultsDiv = document.getElementById('trackingResults');
      
      // Check if at least one filter is set - ANY field is acceptable
      const hasAnyFilter = document.getElementById('dateFrom')?.value ||
                          document.getElementById('dateTo')?.value ||
                          document.getElementById('statusFilter')?.value ||
                          document.getElementById('manufacturerFilter')?.value?.trim() ||
                          document.getElementById('ownerFilter')?.value?.trim() ||
                          document.getElementById('garageFilter')?.value?.trim() ||
                          document.getElementById('claimFilter')?.value ||
                          document.getElementById('invoiceFilter')?.value ||
                          document.getElementById('paymentFilter')?.value;
                          
      if (!hasAnyFilter) {
        alert('אנא בחר לפחות פילטר אחד כדי לבצע חיפוש (תאריך, יצרן, דירקטיבה וכו...)');
        resultsDiv.innerHTML = `
          <div style="background: #333; padding: 15px; border-radius: 8px; border: 1px solid #555; color: #ccc; text-align: center;">
            <p>לא נבחרו פילטרים</p>
            <p style="font-size: 12px; color: #999;">בחר לפחות פילטר אחד (כל שדה) ונסה שוב</p>
          </div>`;
        return;
      }
      
      resultsDiv.innerHTML = `
        <div style="background: #333; padding: 12px; border-radius: 8px; border: 1px solid #555; color: #e0e0e0; text-align: center;">
          <h4 style="color: #ff6b35; margin-bottom: 8px;">🔍 מחפש לפי הפרמטרים שנבחרו</h4>
          <p>אנא המתן...</p>
        </div>`;
      
      try {
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available - page still loading');
        }
        
        // Ultra simple structure that Make.com can easily parse
        const searchParams = {
          type: 'field_search',
          date_from: document.getElementById('dateFrom')?.value || 'all',
          date_to: document.getElementById('dateTo')?.value || 'all',
          directive: document.getElementById('statusFilter')?.value || 'all',
          manufacturer: document.getElementById('manufacturerFilter')?.value?.trim() || 'all',
          owner: document.getElementById('ownerFilter')?.value?.trim() || 'all',
          garage: document.getElementById('garageFilter')?.value?.trim() || 'all',
          claim_status: document.getElementById('claimFilter')?.value || 'all',
          invoice_received: document.getElementById('invoiceFilter')?.value || 'all',
          payment_received: document.getElementById('paymentFilter')?.value || 'all'
        };
        
        // Send all parameters including empty ones - let the webhook handle filtering
        console.log('🔍 Sending search parameters:', searchParams);
        console.log('🌐 Webhook URL:', window.WEBHOOKS?.ADMIN_FETCH_FIELDS);
        console.log('🔧 sendToWebhook function available:', typeof window.sendToWebhook);
        
        const response = await window.sendToWebhook('ADMIN_FETCH_FIELDS', searchParams);
        console.log('📥 Webhook response:', response);
        
        // Store results and filters for export
        window.lastSearchResults = response && Array.isArray(response) ? response : (response ? [response] : []);
        window.lastSearchFilters = searchParams;
        
        // Create description of active filters (only non-empty ones)
        const activeFilters = [];
        if (searchParams.date_from && searchParams.date_to) activeFilters.push(`תאריכים: ${searchParams.date_from} - ${searchParams.date_to}`);
        if (searchParams.directive) activeFilters.push(`דירקטיבה: ${searchParams.directive}`);
        if (searchParams.manufacturer) activeFilters.push(`יצרן: ${searchParams.manufacturer}`);
        if (searchParams.owner) activeFilters.push(`בעלים: ${searchParams.owner}`);
        if (searchParams.garage) activeFilters.push(`מוסך: ${searchParams.garage}`);
        if (searchParams.claim_status) activeFilters.push(`תיק בתביעה: ${searchParams.claim_status}`);
        if (searchParams.invoice_received) activeFilters.push(`חשבונית: ${searchParams.invoice_received === 'yes' ? 'כן' : 'לא'}`);
        if (searchParams.payment_received) activeFilters.push(`תשלום: ${searchParams.payment_received === 'yes' ? 'כן' : 'לא'}`);
        
        const filterDescription = activeFilters.length > 0 ? activeFilters.join(', ') : 'חיפוש כללי';
        window.displayFieldResults('חיפוש מורכב', filterDescription, response);
        
      } catch (error) {
        console.error('Search error:', error);
        window.displayFieldError('חיפוש מורכב', error.message);
      }
    };

    // Define clearAllFilters function globally
    window.clearAllFilters = function() {
      // Clear date filters
      const dateFromField = document.getElementById('dateFrom');
      const dateToField = document.getElementById('dateTo');
      if (dateFromField) dateFromField.value = '';
      if (dateToField) dateToField.value = '';
      
      // Clear text filters
      const manufacturerField = document.getElementById('manufacturerFilter');
      const ownerField = document.getElementById('ownerFilter');
      const garageField = document.getElementById('garageFilter');
      if (manufacturerField) manufacturerField.value = '';
      if (ownerField) ownerField.value = '';
      if (garageField) garageField.value = '';
      
      // Clear dropdown filters - statusFilter is now directive
      const statusField = document.getElementById('statusFilter'); // This is actually directive now
      const claimField = document.getElementById('claimFilter');
      const invoiceField = document.getElementById('invoiceFilter');
      const paymentField = document.getElementById('paymentFilter');
      if (statusField) statusField.value = '';
      if (claimField) claimField.value = '';
      if (invoiceField) invoiceField.value = '';
      if (paymentField) paymentField.value = '';
      
      document.getElementById('trackingResults').innerHTML = `
        <div style="background: #333; padding: 15px; border-radius: 8px; border: 1px solid #555; color: #ccc; text-align: center;">
          <p>✅ כל הסינונים נוקו</p>
          <p style="font-size: 12px; color: #999;">בחר אפשרויות סינון חדשות כדי לחפש</p>
        </div>`;
    };

    // Define exportResults function globally
    window.exportResults = async function() {
      // Check if there are any results to export
      const resultsDiv = document.getElementById('trackingResults');
      if (!window.lastSearchResults || !Array.isArray(window.lastSearchResults) || window.lastSearchResults.length === 0) {
        alert('אין תוצאות לייצוא - אנא בצע חיפוש תחילה');
        return;
      }
      
      // Show loading
      const originalButton = event.target;
      const originalText = originalButton.innerHTML;
      originalButton.innerHTML = '⏳ מייצא...';
      originalButton.disabled = true;
      
      try {
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available');
        }
        
        // Prepare export data
        const exportData = {
          sender_id: 'סקירה לפי שדות',
          plate: 'multiple', // Field search can include multiple plates
          query_date: new Date().toISOString(),
          export_date: new Date().toISOString(),
          export_type: 'field_search',
          data_type: 'תוצאות חיפוש שדות',
          total_results: window.lastSearchResults.length,
          search_filters: window.lastSearchFilters || {},
          data: window.lastSearchResults
        };
        
        console.log('🔄 Exporting search results:', exportData);
        
        const response = await window.sendToWebhook('ADMIN_EXPORT_SEARCH_RESULTS', exportData);
        
        console.log('📤 Export response:', response);
        
        // Show success
        originalButton.innerHTML = '✅ יוצא בהצלחה';
        setTimeout(() => {
          originalButton.innerHTML = originalText;
          originalButton.disabled = false;
        }, 2000);
        
        alert('תוצאות החיפוש יוצאו בהצלחה!');
        
      } catch (error) {
        console.error('Export error:', error);
        
        // Show error
        originalButton.innerHTML = '❌ שגיאה';
        setTimeout(() => {
          originalButton.innerHTML = originalText;
          originalButton.disabled = false;
        }, 2000);
        
        alert(`שגיאה בייצוא: ${error.message}`);
      }
    };

    // Define exportCaseStatus function globally
    window.exportCaseStatus = async function() {
      // Check if there are any results to export
      if (!window.lastCaseStatusResults || !window.lastCaseStatusPlate) {
        alert('אין נתונים לייצוא - אנא בצע חיפוש תחילה');
        return;
      }
      
      // Show export options dialog
      const exportChoice = prompt(`בחר את סוג הנתונים לייצוא:
1 - תמ"צ כללי
2 - אקספירטיזה  
3 - חוו"ד
4 - כל הנתונים
      
הכנס מספר בחירה (1-4):`);
      
      if (!exportChoice || !['1', '2', '3', '4'].includes(exportChoice)) {
        alert('בחירה לא תקינה');
        return;
      }
      
      // Show loading
      const originalButton = event.target;
      const originalText = originalButton.innerHTML;
      originalButton.innerHTML = '⏳ מייצא...';
      originalButton.disabled = true;
      
      try {
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available');
        }
        
        // Prepare export data based on choice
        let exportData = {
          sender_id: 'סטטוס תיקים',
          plate: window.lastCaseStatusPlate,
          query_date: new Date().toISOString(),
          export_date: new Date().toISOString(),
          export_type: exportChoice
        };
        
        const caseData = window.lastCaseStatusResults;
        
        switch(exportChoice) {
          case '1':
            exportData.data = caseData['תמ"צ כללי'] || {};
            exportData.data_type = 'תמ"צ כללי';
            break;
          case '2':
            exportData.data = caseData['אקספירטיזה'] || {};
            exportData.data_type = 'אקספירטיזה';
            break;
          case '3':
            exportData.data = caseData['חוו"ד'] || {};
            exportData.data_type = 'חוו"ד';
            break;
          case '4':
            exportData.data = caseData;
            exportData.data_type = 'כל הנתונים';
            break;
        }
        
        console.log('🔄 Exporting case status:', exportData);
        
        const response = await window.sendToWebhook('ADMIN_EXPORT_SEARCH_RESULTS', exportData);
        
        console.log('📤 Export response:', response);
        
        // Show success
        originalButton.innerHTML = '✅ יוצא בהצלחה';
        setTimeout(() => {
          originalButton.innerHTML = originalText;
          originalButton.disabled = false;
        }, 2000);
        
        alert('נתוני התיק יוצאו בהצלחה!');
        
      } catch (error) {
        console.error('Export error:', error);
        
        // Show error
        originalButton.innerHTML = '❌ שגיאה';
        setTimeout(() => {
          originalButton.innerHTML = originalText;
          originalButton.disabled = false;
        }, 2000);
        
        alert(`שגיאה בייצוא: ${error.message}`);
      }
    };
    </script>
    
   <script type="module">
  import { sendToWebhook } from './webhook.js';
  
  // Make sendToWebhook globally available immediately
  window.sendToWebhook = sendToWebhook;
  
  // Make sure it's available before any functions try to use it
  window.webhookReady = true;
  
  // Merge with existing DOMContentLoaded event - do not create duplicate
  // The admin functionality will be added to the existing DOMContentLoaded below
  
  // Define admin helper functions here when needed
  
  // Add to existing DOMContentLoaded event from first script
  document.addEventListener('DOMContentLoaded', () => {
    // Check if user has basic authentication
    const auth = sessionStorage.getItem('auth');
    if (!auth) {
      console.log('❌ No auth token found in admin.html, redirecting to login');
      alert('הגישה חסומה - אנא התחבר דרך דף הבית');
      window.location.href = 'index.html';
      return;
    }
    
    // Check for admin-specific access
    const adminAccess = sessionStorage.getItem('admin-access');
    const adminTimestamp = sessionStorage.getItem('admin-timestamp');
    
    if (!adminAccess || !adminAccess.includes('granted')) {
      console.log('❌ No admin access token found, redirecting to selection');
      alert('גישת מנהל נדרשת - אנא אמת את הזהות שלך דרך עמוד הבחירה');
      window.location.href = 'selection.html';
      return;
    }
    
    // Check if admin session is still valid (24 hours)
    if (adminTimestamp) {
      const sessionAge = Date.now() - new Date(adminTimestamp).getTime();
      const maxAge = 24 * 60 * 60 * 1000; // 24 hours
      
      if (sessionAge > maxAge) {
        console.log('❌ Admin session expired, redirecting to selection');
        sessionStorage.removeItem('admin-access');
        sessionStorage.removeItem('admin-timestamp');
        alert('תוקף גישת המנהל פג - אנא התחבר מחדש');
        window.location.href = 'selection.html';
        return;
      }
    }
    
    console.log('✅ Admin access verified, loading admin panel');
    console.log('Admin access type:', adminAccess);
    
    // Load VAT from session
    const existingVat = sessionStorage.getItem('globalVAT');
    if (existingVat) {
      document.getElementById('vat-input').value = existingVat;
    }
  });

    // Helper functions for admin sections
    window.searchCaseStatus = async function() {
      const plate = document.getElementById('plateSearch').value.trim();
      if (!plate) {
        alert('אנא הכנס מספר רכב');
        return;
      }
      
      const resultsDiv = document.getElementById('caseResults');
      resultsDiv.innerHTML = `
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeaa7;">
          <h4>🔍 מחפש נתונים עבור רכב: ${plate}</h4>
          <p>אנא המתן...</p>
        </div>`;
      
      try {
        // Wait for webhook to be ready with a small delay
        await new Promise(resolve => setTimeout(resolve, 100));
        
        if (!window.sendToWebhook || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available - please refresh the page');
        }
        
        const response = await window.sendToWebhook('ADMIN_FETCH_TRACKING_TABLE', {
          plate: plate,
          action: 'get_case_status'
        });
        
        console.log('Case status response:', response);
        
        if (response && Array.isArray(response) && response.length > 0) {
          const caseData = response[0];
          // Store results for export
          window.lastCaseStatusResults = caseData;
          window.lastCaseStatusPlate = plate;
          displayCaseStatus(plate, caseData);
        } else {
          resultsDiv.innerHTML = `
            <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb; color: #721c24;">
              <h4>❌ לא נמצאו נתונים</h4>
              <p>לא נמצאו נתונים עבור רכב מספר: ${plate}</p>
              <p>אנא בדוק את מספר הרכב ונסה שוב</p>
            </div>`;
        }
      } catch (error) {
        console.error('Error fetching case status:', error);
        resultsDiv.innerHTML = `
          <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb; color: #721c24;">
            <h4>❌ שגיאה בטעינת נתונים</h4>
            <p>שגיאה: ${error.message}</p>
            <p>אנא נסה שוב מאוחר יותר</p>
          </div>`;
      }
    };

    window.displayCaseStatus = function(plate, caseData) {
      const resultsDiv = document.getElementById('caseResults');
      
      // Extract the three categories from the response
      const generalInfo = caseData['תמ"צ כללי'] || {};
      const expertise = caseData['אקספירטיזה'] || {};
      const opinion = caseData['חוו"ד'] || {};
      
      resultsDiv.innerHTML = `
        <div style="background: #333; padding: 12px; border-radius: 8px; border: 1px solid #555; color: #e0e0e0; font-size: 13px;">
          <h4 style="margin: 0 0 8px 0; font-size: 16px; color: #ff6b35;">📊 סטטוס תיק: ${plate}</h4>
          <div style="margin-bottom: 12px; font-size: 12px; color: #ccc;">
            <span><strong>מספר תיק:</strong> ${generalInfo['מספר תיק'] || 'לא זמין'}</span> | 
            <span><strong>עדכון:</strong> ${new Date().toLocaleDateString('he-IL')}</span>
          </div>
          
          <!-- תמ"צ כללי Section -->
          <div style="margin-bottom: 8px;">
            <button onclick="toggleSection('general')" onmouseover="this.style.background='#4ade80'; this.style.color='#1a1a1a'" onmouseout="this.style.background='#444'; this.style.color='#4ade80'" style="width: 100%; padding: 8px; background: #444; color: #4ade80; border: 1px solid #4ade80; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.3s;">
              📋 תמ"צ כללי
            </button>
            <div id="general-section" style="display: none; background: #2a2a2a; padding: 10px; border-radius: 6px; margin-top: 5px; border: 1px solid #444; font-size: 12px;">
              ${formatGeneralInfo(generalInfo)}
            </div>
          </div>
          
          <!-- אקספירטיזה Section -->
          <div style="margin-bottom: 8px;">
            <button onclick="toggleSection('expertise')" onmouseover="this.style.background='#fbbf24'; this.style.color='#1a1a1a'" onmouseout="this.style.background='#444'; this.style.color='#fbbf24'" style="width: 100%; padding: 8px; background: #444; color: #fbbf24; border: 1px solid #fbbf24; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.3s;">
              🔧 אקספירטיזה
            </button>
            <div id="expertise-section" style="display: none; background: #2a2a2a; padding: 10px; border-radius: 6px; margin-top: 5px; border: 1px solid #444; font-size: 12px;">
              ${formatExpertiseInfo(expertise)}
            </div>
          </div>
          
          <!-- חוו"ד Section -->
          <div style="margin-bottom: 8px;">
            <button onclick="toggleSection('opinion')" onmouseover="this.style.background='#f87171'; this.style.color='#1a1a1a'" onmouseout="this.style.background='#444'; this.style.color='#f87171'" style="width: 100%; padding: 8px; background: #444; color: #f87171; border: 1px solid #f87171; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.3s;">
              📝 חוו"ד
            </button>
            <div id="opinion-section" style="display: none; background: #2a2a2a; padding: 10px; border-radius: 6px; margin-top: 5px; border: 1px solid #444; font-size: 12px;">
              ${formatOpinionInfo(opinion)}
            </div>
          </div>
        </div>`;
    };

    window.toggleSection = function(sectionId) {
      const section = document.getElementById(sectionId + '-section');
      if (section.style.display === 'none') {
        section.style.display = 'block';
      } else {
        section.style.display = 'none';
      }
    };

    window.formatGeneralInfo = function(info) {
      return `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; color: #ccc;">
          <div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">מספר תיק:</strong> ${info['מספר תיק'] || 'לא זמין'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">תאריך בדיקה:</strong> ${info['תאריך הבדיקה'] || 'לא זמין'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">תאריך חוו"ד:</strong> ${info['תאריך חוו"ד'] || 'לא זמין'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">מס. רכב:</strong> ${info['מס.רכב'] || 'לא זמין'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">שם היצרן:</strong> ${info['שם היצרן'] || 'לא זמין'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">שנת ייצור:</strong> ${info['שנת ייצור'] || 'לא זמין'}</div>
          </div>
          <div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">ערך הרכב:</strong> ${info['ערך הרכב'] || 'לא זמין'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">בעל הרכב:</strong> ${info['שם בעל הרכב'] || 'לא זמין'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">טלפון:</strong> ${info['טלפון'] || 'לא זמין'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">מוסך:</strong> ${info['מוסך'] || 'לא זמין'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">טלפון מוסך:</strong> ${info['טלפון מוסך'] || 'לא זמין'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">סטטוס כללי:</strong> ${info['סטטוס כללי'] || 'לא זמין'}</div>
          </div>
        </div>
        <div style="margin-top: 8px; border-top: 1px solid #444; padding-top: 8px;">
          <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">דירקטיבה:</strong> ${info['דירקטיבה'] || 'לא זמין'}</div>
          <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">הערות כלליות:</strong> ${info['הערות כלליות'] || 'אין הערות'}</div>
        </div>`;
    };

    window.formatExpertiseInfo = function(info) {
      return `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; color: #ccc;">
          <div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">מספר תיק:</strong> ${info['מספר תיק'] || 'לא זמין'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">מספר רכב:</strong> ${info['מספר רכב'] || 'לא זמין'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">מס. מוקדי נזק:</strong> ${info['מס מוקדי נזק'] || 'לא זמין'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">מוקד נזק:</strong> ${info['מוקד נזק'] || 'לא זמין'}</div>
          </div>
          <div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">תיאור:</strong> ${info['תיאור'] || 'לא זמין'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">תיקונים מתוכננים:</strong> ${info['תיקונים מתוכננים'] || 'לא זמין'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">חלקים מתוכננים:</strong> ${info['חלקים מתוכננים'] || 'לא זמין'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">עבודות מתוכננות:</strong> ${info['עבודות מתוכננות'] || 'לא זמין'}</div>
          </div>
        </div>
        <div style="margin-top: 8px; border-top: 1px solid #444; padding-top: 8px;">
          <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">הנחייה:</strong> ${info['הנחייה'] || 'אין הנחיות'}</div>
          <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">הערות:</strong> ${info['הערות'] || 'אין הערות'}</div>
        </div>`;
    };

    window.formatOpinionInfo = function(info) {
      return `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; color: #ccc;">
          <div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">מספר רכב:</strong> ${info['מספר רכב'] || 'לא זמין'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">מס. מוקדי נזק:</strong> ${info['מס מוקדי נזק'] || 'לא זמין'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">מוקד נזק:</strong> ${info['מוקד נזק'] || 'לא זמין'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">תיקונים בפועל:</strong> ${info['תיקונים בפועל'] || 'לא זמין'}</div>
          </div>
          <div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">סה"כ חלקים בפועל:</strong> ${info['סה"כ חלקים בפועל'] || 'לא זמין'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">סה"כ עבודות בפועל:</strong> ${info['סה"כ עבודות בפועל'] || 'לא זמין'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">סכום לתביעה:</strong> ${info['סכום לתביעה'] || 'לא זמין'}</div>
            <div style="margin-bottom: 4px;"><strong style="color: #f87171;">ירידת ערך:</strong> ${info['ירידת ערך'] || 'לא זמין'}</div>
          </div>
        </div>
        <div style="margin-top: 8px; border-top: 1px solid #444; padding-top: 8px;">
          <div style="margin-bottom: 4px;"><strong style="color: #f87171;">פיצוי סופי:</strong> ${info['פיצוי סופי'] || 'לא זמין'}</div>
          <div style="margin-bottom: 4px;"><strong style="color: #f87171;">הערות:</strong> ${info['הערות'] || 'אין הערות'}</div>
        </div>`;
    };

    window.filterByDate = async function() {
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;
      
      if (!dateFrom || !dateTo) {
        alert('אנא בחר טווח תאריכים מלא');
        return;
      }
      
      const resultsDiv = document.getElementById('trackingResults');
      resultsDiv.innerHTML = `
        <div style="background: #333; padding: 12px; border-radius: 8px; border: 1px solid #555; color: #e0e0e0; text-align: center;">
          <h4 style="color: #ff6b35; margin-bottom: 8px;">🔍 מחפש תיקים לתקופה: ${dateFrom} - ${dateTo}</h4>
          <p>אנא המתן...</p>
        </div>`;
      
      try {
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available - page still loading');
        }
        
        const response = await window.sendToWebhook('ADMIN_FETCH_FIELDS', {
          filter_type: 'date_range',
          date_from: dateFrom,
          date_to: dateTo,
          action: 'field_review'
        });
        
        displayFieldResults('תיקים לתקופה', `${dateFrom} - ${dateTo}`, response);
      } catch (error) {
        displayFieldError('סינון לפי תאריך', error.message);
      }
    };

    // filterByStatus function removed - functionality consolidated into filterByDirective

    // filterByPlate removed - use main search button instead

    // Individual filter functions removed - use main search button instead

    // filterByDirective removed - use main search button instead

    // All individual filter functions removed - use main unified search button instead

    // Functions removed - they are now defined globally above

    window.performFieldFilter = async function(filterType, filterValue, displayName) {
      const resultsDiv = document.getElementById('trackingResults');
      resultsDiv.innerHTML = `
        <div style="background: #333; padding: 12px; border-radius: 8px; border: 1px solid #555; color: #e0e0e0; text-align: center;">
          <h4 style="color: #ff6b35; margin-bottom: 8px;">🔍 מחפש: ${displayName}</h4>
          <p>אנא המתן...</p>
        </div>`;
      
      try {
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available - page still loading');
        }
        
        const response = await window.sendToWebhook('ADMIN_FETCH_FIELDS', {
          filter_type: filterType,
          filter_value: filterValue,
          action: 'field_review'
        });
        
        displayFieldResults(filterType, displayName, response);
      } catch (error) {
        displayFieldError(displayName, error.message);
      }
    };

    window.displayFieldResults = function(filterType, filterDesc, data) {
      const resultsDiv = document.getElementById('trackingResults');
      
      if (!data || (Array.isArray(data) && data.length === 0)) {
        resultsDiv.innerHTML = `
          <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb; color: #721c24;">
            <h4>❌ לא נמצאו תיקים</h4>
            <p>לא נמצאו תיקים התואמים לקריטריונים: ${filterDesc}</p>
            <p>אנא נסה לשנות את הפילטרים ונסה שוב</p>
          </div>`;
        return;
      }
      
      const results = Array.isArray(data) ? data : [data];
      const resultCount = results.length;
      
      let resultsHtml = `
        <div style="background: #333; padding: 12px; border-radius: 8px; border: 1px solid #555; color: #e0e0e0; font-size: 13px;">
          <h4 style="margin: 0 0 8px 0; font-size: 16px; color: #ff6b35;">📊 תוצאות חיפוש שדות</h4>
          <div style="margin-bottom: 12px; font-size: 12px; color: #ccc;">
            <span><strong>נמצאו:</strong> ${resultCount} תיקים</span> | 
            <span><strong>סונן לפי:</strong> ${filterDesc}</span> | 
            <span><strong>עדכון:</strong> ${new Date().toLocaleDateString('he-IL')}</span>
          </div>`;
      
      results.forEach((result, index) => {
        const generalInfo = result['תמ"צ כללי'] || result;
        const expertise = result['אקספירטיזה'] || {};
        const opinion = result['חוו"ד'] || {};
        
        const caseNumber = generalInfo['מספר תיק'] || `תיק-${index + 1}`;
        const plate = generalInfo['מס.רכב'] || generalInfo['plate'] || 'לא זמין';
        const manufacturer = generalInfo['שם היצרן'] || 'לא זמין';
        const owner = generalInfo['שם בעל הרכב'] || 'לא זמין';
        const status = generalInfo['סטטוס כללי'] || 'לא זמין';
        const directive = generalInfo['דירקטיבה'] || 'לא זמין';
        
        resultsHtml += `
          <div style="background: #2a2a2a; padding: 10px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #444;">
            <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #444;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px;">
                <div>
                  <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">מספר תיק:</strong> ${caseNumber}</div>
                  <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">מס. רכב:</strong> ${plate}</div>
                  <div style="margin-bottom: 4px;"><strong style="color: #4ade80;">יצרן:</strong> ${manufacturer}</div>
                </div>
                <div>
                  <div style="margin-bottom: 4px;"><strong style="color: #fbbf24;">בעל הרכב:</strong> ${owner}</div>
                  <div style="margin-bottom: 4px;"><strong style="color: #f87171;">סטטוס:</strong> ${status}</div>
                  <div style="margin-bottom: 4px;"><strong style="color: #f87171;">דירקטיבה:</strong> ${directive}</div>
                </div>
              </div>
            </div>
            
            <!-- Quick Action Buttons -->
            <div style="display: flex; gap: 8px; justify-content: center;">
              <button onclick="loadCaseDetailsFromResult('${plate}')" 
                      onmouseover="this.style.background='#e55a2b'" 
                      onmouseout="this.style.background='#ff6b35'"
                      style="padding: 6px 12px; background: #ff6b35; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; transition: all 0.3s;">
                📋 פרטים מלאים
              </button>
              <button onclick="toggleCaseDetails('case-${index}')" 
                      onmouseover="this.style.background='#4ade80'; this.style.color='#1a1a1a'" 
                      onmouseout="this.style.background='#444'; this.style.color='#4ade80'"
                      style="padding: 6px 12px; background: #444; color: #4ade80; border: 1px solid #4ade80; border-radius: 4px; font-size: 11px; cursor: pointer; transition: all 0.3s;">
                🔍 הצג כאן
              </button>
            </div>
            
            <!-- Expandable Details -->
            <div id="case-${index}" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #444;">
              <div style="margin-bottom: 6px;">
                <button onclick="toggleSection('general-${index}')" 
                        onmouseover="this.style.background='#4ade80'; this.style.color='#1a1a1a'" 
                        onmouseout="this.style.background='#444'; this.style.color='#4ade80'" 
                        style="width: 100%; padding: 6px; background: #444; color: #4ade80; border: 1px solid #4ade80; border-radius: 4px; font-size: 11px; cursor: pointer; transition: all 0.3s;">
                  📋 תמ"צ כללי
                </button>
                <div id="general-${index}-section" style="display: none; background: #1a1a1a; padding: 8px; border-radius: 4px; margin-top: 4px; border: 1px solid #444; font-size: 11px;">
                  ${formatGeneralInfo(generalInfo)}
                </div>
              </div>
              
              <div style="margin-bottom: 6px;">
                <button onclick="toggleSection('expertise-${index}')" 
                        onmouseover="this.style.background='#fbbf24'; this.style.color='#1a1a1a'" 
                        onmouseout="this.style.background='#444'; this.style.color='#fbbf24'" 
                        style="width: 100%; padding: 6px; background: #444; color: #fbbf24; border: 1px solid #fbbf24; border-radius: 4px; font-size: 11px; cursor: pointer; transition: all 0.3s;">
                  🔧 אקספירטיזה
                </button>
                <div id="expertise-${index}-section" style="display: none; background: #1a1a1a; padding: 8px; border-radius: 4px; margin-top: 4px; border: 1px solid #444; font-size: 11px;">
                  ${formatExpertiseInfo(expertise)}
                </div>
              </div>
              
              <div style="margin-bottom: 6px;">
                <button onclick="toggleSection('opinion-${index}')" 
                        onmouseover="this.style.background='#f87171'; this.style.color='#1a1a1a'" 
                        onmouseout="this.style.background='#444'; this.style.color='#f87171'" 
                        style="width: 100%; padding: 6px; background: #444; color: #f87171; border: 1px solid #f87171; border-radius: 4px; font-size: 11px; cursor: pointer; transition: all 0.3s;">
                  📝 חוו"ד
                </button>
                <div id="opinion-${index}-section" style="display: none; background: #1a1a1a; padding: 8px; border-radius: 4px; margin-top: 4px; border: 1px solid #444; font-size: 11px;">
                  ${formatOpinionInfo(opinion)}
                </div>
              </div>
            </div>
          </div>`;
      });
      
      resultsHtml += `</div>`;
      resultsDiv.innerHTML = resultsHtml;
    };
    
    window.toggleCaseDetails = function(caseId) {
      const caseDiv = document.getElementById(caseId);
      if (caseDiv.style.display === 'none') {
        caseDiv.style.display = 'block';
      } else {
        caseDiv.style.display = 'none';
      }
    };

    window.displayFieldError = function(filterName, errorMessage) {
      const resultsDiv = document.getElementById('trackingResults');
      resultsDiv.innerHTML = `
        <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb; color: #721c24;">
          <h4>❌ שגיאה בחיפוש שדות</h4>
          <p><strong>שגיאה:</strong> ${errorMessage}</p>
          <p>אנא נסה שוב מאוחר יותר או בדוק את הקריטריונים</p>
        </div>`;
    };

    window.loadCaseDetailsFromResult = function(plate) {
      // Switch to case status section and search for the plate
      loadSection('caseStatus');
      setTimeout(() => {
        document.getElementById('plateSearch').value = plate;
        searchCaseStatus();
      }, 100);
    };

    // Enhanced Reminders Management System with Modern Features
    window.remindersData = window.remindersData || [];
    window.currentServerFilters = {};
    window.dataLoadedTimestamp = null;
    
    // Show server-side filter modal
    window.showLoadRemindersModal = function() {
      const modalHtml = `
        <div id="loadRemindersModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
          <div style="background: #2a2a2a; padding: 25px; border-radius: 12px; width: 600px; max-width: 90%; border: 2px solid #ff6b35; max-height: 80vh; overflow-y: auto;">
            <h3 style="color: #ff6b35; margin-bottom: 20px; text-align: center;">📥 טעינת תזכורות עם סינון מתקדם</h3>
            
            <div style="margin-bottom: 15px; padding: 10px; background: #333; border-radius: 6px; border: 1px solid #555;">
              <div style="color: #e0e0e0; font-size: 14px; margin-bottom: 5px;">ℹ️ בחר פרמטרי סינון לטעינת תזכורות רלוונטיות בלבד מהשרת</div>
              <div style="color: #999; font-size: 12px;">זה יקטין את זמן הטעינה ויציג רק את המידע הרלוונטי</div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">סטטוס:</label>
                <select id="serverStatusFilter" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
                  <option value="all">כל הסטטוסים</option>
                  <option value="active">פעיל</option>
                  <option value="pending">ממתין</option>
                  <option value="completed">הושלם</option>
                  <option value="overdue">פג תוקף</option>
                </select>
              </div>
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">קטגוריה:</label>
                <select id="serverCategoryFilter" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
                  <option value="all">כל הקטגוריות</option>
                  <option value="case_deadline">מועד סגירת תיק</option>
                  <option value="payment_reminder">תזכורת תשלום</option>
                  <option value="follow_up">מעקב</option>
                  <option value="inspection">בדיקה</option>
                  <option value="general">כללי</option>
                </select>
              </div>
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">מספר רכב (אופציונלי):</label>
              <input type="text" id="serverPlateFilter" placeholder="הכנס מספר רכב לסינון תזכורות ספציפיות" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
              <div style="color: #999; font-size: 12px; margin-top: 5px;">השאר ריק כדי לטעון תזכורות של כל הרכבים</div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">מתאריך:</label>
                <input type="date" id="serverDateFrom" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
              </div>
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">עד תאריך:</label>
                <input type="date" id="serverDateTo" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
              </div>
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">מגבלת תוצאות:</label>
              <select id="serverLimitFilter" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
                <option value="50">50 תזכורות אחרונות</option>
                <option value="100">100 תזכורות אחרונות</option>
                <option value="200">200 תזכורות אחרונות</option>
                <option value="500">500 תזכורות אחרונות</option>
                <option value="all">כל התזכורות (לא מומלץ)</option>
              </select>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: center;">
              <button onclick="loadRemindersWithFilters()" 
                      onmouseover="this.style.background='#e55a2b'; this.style.transform='translateY(-2px)';"
                      onmouseout="this.style.background='#ff6b35'; this.style.transform='translateY(0)';"
                      style="padding: 12px 24px; background: #ff6b35; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">
                📥 טען תזכורות
              </button>
              <button onclick="closeLoadRemindersModal()" 
                      onmouseover="this.style.background='#dc2626'; this.style.transform='translateY(-2px)';"
                      onmouseout="this.style.background='#991b1b'; this.style.transform='translateY(0)';"
                      style="padding: 12px 24px; background: #991b1b; color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                ❌ ביטול
              </button>
            </div>
          </div>
        </div>`;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Set default date range (last 30 days)
      const today = new Date();
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(today.getDate() - 30);
      
      document.getElementById('serverDateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
      document.getElementById('serverDateTo').value = today.toISOString().split('T')[0];
    };
    
    window.closeLoadRemindersModal = function() {
      const modal = document.getElementById('loadRemindersModal');
      if (modal) modal.remove();
    };
    
    // Load reminders with server-side filtering
    window.loadRemindersWithFilters = async function() {
      try {
        // Get filter values from modal
        const serverFilters = {
          status: document.getElementById('serverStatusFilter').value,
          category: document.getElementById('serverCategoryFilter').value,
          plate_number: document.getElementById('serverPlateFilter').value.trim(),
          date_from: document.getElementById('serverDateFrom').value,
          date_to: document.getElementById('serverDateTo').value,
          limit: document.getElementById('serverLimitFilter').value
        };
        
        // Close modal
        closeLoadRemindersModal();
        
        // Update data status to loading
        updateDataStatus('loading', 'טוען תזכורות מ-Make.com עם הפרמטרים שנבחרו...');
        
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available');
        }
        
        console.log('🔄 Loading reminders with server filters:', serverFilters);
        
        const response = await window.sendToWebhook('ADMIN_FETCH_REMINDERS', {
          action: 'fetch_reminders',
          server_filters: serverFilters,
          pagination: {
            limit: serverFilters.limit === 'all' ? null : parseInt(serverFilters.limit),
            offset: 0
          },
          timestamp: new Date().toISOString()
        });
        
        console.log('📥 Fetched reminders with server filters:', response);
        
        // Update local data with fetched reminders
        if (response && Array.isArray(response)) {
          window.remindersData = response;
        } else if (response && response.reminders && Array.isArray(response.reminders)) {
          window.remindersData = response.reminders;
        } else {
          console.warn('No reminders found in response');
          window.remindersData = [];
        }
        
        // Store current filters and timestamp
        window.currentServerFilters = serverFilters;
        window.dataLoadedTimestamp = new Date();
        
        // Enable local filtering controls
        enableLocalControls();
        
        // Update data status
        const filterDesc = createFilterDescription(serverFilters);
        updateDataStatus('loaded', `נטענו ${window.remindersData.length} תזכורות (${filterDesc}) - עודכן: ${new Date().toLocaleTimeString('he-IL')}`);
        
        // Refresh display
        renderReminders();
        
        return window.remindersData;
        
      } catch (error) {
        console.error('Error loading reminders:', error);
        updateDataStatus('error', `שגיאה בטעינת תזכורות: ${error.message}`);
        throw error;
      }
    };
    
    // Create filter description for display
    window.createFilterDescription = function(filters) {
      const parts = [];
      if (filters.status !== 'all') parts.push(`סטטוס: ${filters.status}`);
      if (filters.category !== 'all') parts.push(`קטגוריה: ${filters.category}`);
      if (filters.plate_number) parts.push(`רכב: ${filters.plate_number}`);
      if (filters.date_from || filters.date_to) {
        const dateRange = `${filters.date_from || ''} - ${filters.date_to || ''}`;
        parts.push(`תאריכים: ${dateRange}`);
      }
      if (filters.limit !== 'all') parts.push(`מוגבל ל-${filters.limit}`);
      
      return parts.length > 0 ? parts.join(', ') : 'ללא סינון';
    };
    
    // Update data status display
    window.updateDataStatus = function(status, message) {
      const statusText = document.getElementById('dataStatusText');
      if (statusText) {
        statusText.textContent = message;
        
        // Update styling based on status
        const statusDisplay = document.getElementById('dataStatusDisplay');
        if (statusDisplay) {
          switch (status) {
            case 'loading':
              statusDisplay.style.borderColor = '#f59e0b';
              statusDisplay.style.backgroundColor = '#451a03';
              break;
            case 'loaded':
              statusDisplay.style.borderColor = '#16a34a';
              statusDisplay.style.backgroundColor = '#0f3424';
              break;
            case 'error':
              statusDisplay.style.borderColor = '#dc2626';
              statusDisplay.style.backgroundColor = '#450a0a';
              break;
            default:
              statusDisplay.style.borderColor = '#444';
              statusDisplay.style.backgroundColor = '#2a2a2a';
          }
        }
      }
    };
    
    // Enable local filtering controls
    window.enableLocalControls = function() {
      const localControls = document.getElementById('localFilterControls');
      const buttons = ['refreshDataBtn', 'localFilterBtn', 'toggleViewBtn', 'exportBtn', 'calendarSyncBtn'];
      const selects = ['localStatusFilter', 'localCategoryFilter'];
      
      if (localControls) {
        localControls.style.opacity = '1';
      }
      
      buttons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
          btn.disabled = false;
          btn.style.opacity = '1';
        }
      });
      
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
          select.disabled = false;
        }
      });
    };
    
    // Refresh reminders with same server filters
    window.refreshReminders = async function() {
      if (!window.currentServerFilters || Object.keys(window.currentServerFilters).length === 0) {
        alert('אין פרמטרי סינון שמורים - אנא טען תזכורות תחילה');
        return;
      }
      
      try {
        updateDataStatus('loading', 'מרענן תזכורות מ-Make.com...');
        
        const response = await window.sendToWebhook('ADMIN_FETCH_REMINDERS', {
          action: 'fetch_reminders',
          server_filters: window.currentServerFilters,
          pagination: {
            limit: window.currentServerFilters.limit === 'all' ? null : parseInt(window.currentServerFilters.limit),
            offset: 0
          },
          timestamp: new Date().toISOString()
        });
        
        // Update data
        if (response && Array.isArray(response)) {
          window.remindersData = response;
        } else if (response && response.reminders && Array.isArray(response.reminders)) {
          window.remindersData = response.reminders;
        } else {
          window.remindersData = [];
        }
        
        window.dataLoadedTimestamp = new Date();
        
        // Update status
        const filterDesc = createFilterDescription(window.currentServerFilters);
        updateDataStatus('loaded', `רוענן - ${window.remindersData.length} תזכורות (${filterDesc}) - עודכן: ${new Date().toLocaleTimeString('he-IL')}`);
        
        // Refresh display
        renderReminders();
        
      } catch (error) {
        console.error('Error refreshing reminders:', error);
        updateDataStatus('error', `שגיאה ברענון: ${error.message}`);
      }
    };
    
    // Apply local filters (client-side)
    window.applyLocalFilters = function() {
      const localStatus = document.getElementById('localStatusFilter').value;
      const localCategory = document.getElementById('localCategoryFilter').value;
      
      console.log('🔍 Applying local filters:', { localStatus, localCategory });
      
      // This will filter the already-loaded data
      renderReminders(localStatus, localCategory);
    };
    
    // Legacy fetch reminders function (for backward compatibility)
    window.fetchReminders = async function(statusFilter = 'all', categoryFilter = 'all') {
      console.warn('fetchReminders() is deprecated. Use loadRemindersWithFilters() instead.');
      return window.remindersData;
    };
    
    window.addReminder = function() {
      // Create modern form dialog
      const formHtml = `
        <div id="reminderFormOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;">
          <div style="background: #2a2a2a; padding: 25px; border-radius: 12px; width: 500px; max-width: 90%; border: 2px solid #ff6b35;">
            <h3 style="color: #ff6b35; margin-bottom: 20px; text-align: center;">➕ הוספת תזכורת חדשה</h3>
            
            <div style="margin-bottom: 15px;">
              <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">כותרת התזכורת:</label>
              <input type="text" id="reminderTitle" placeholder="הכנס כותרת התזכורת" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">תיאור:</label>
              <textarea id="reminderDescription" placeholder="הכנס תיאור מפורט" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0; height: 80px; resize: vertical;"></textarea>
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">מספר רכב (אופציונלי):</label>
              <input type="text" id="reminderPlate" placeholder="הכנס מספר רכב (אם רלוונטי)" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">תאריך יעד:</label>
                <input type="date" id="reminderDate" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
              </div>
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">שעה:</label>
                <input type="time" id="reminderTime" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">קטגוריה:</label>
                <select id="reminderCategory" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
                  <option value="case_deadline">מועד סגירת תיק</option>
                  <option value="payment_reminder">תזכורת תשלום</option>
                  <option value="follow_up">מעקב</option>
                  <option value="inspection">בדיקה</option>
                  <option value="general">כללי</option>
                </select>
              </div>
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">עדיפות:</label>
                <select id="reminderPriority" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
                  <option value="high">גבוהה</option>
                  <option value="medium">בינונית</option>
                  <option value="low">נמוכה</option>
                </select>
              </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: center;">
              <button onclick="saveReminder()" style="padding: 12px 24px; background: #16a34a; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">💾 שמור ושלח</button>
              <button onclick="closeReminderForm()" style="padding: 12px 24px; background: #991b1b; color: white; border: none; border-radius: 8px; cursor: pointer;">❌ ביטול</button>
            </div>
          </div>
        </div>`;
      
      document.body.insertAdjacentHTML('beforeend', formHtml);
      
      // Set default date to tomorrow
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      document.getElementById('reminderDate').value = tomorrow.toISOString().split('T')[0];
      document.getElementById('reminderTime').value = '09:00';
    };
    
    window.closeReminderForm = function() {
      const overlay = document.getElementById('reminderFormOverlay');
      if (overlay) overlay.remove();
    };
    
    window.saveReminder = async function() {
      const title = document.getElementById('reminderTitle').value.trim();
      const description = document.getElementById('reminderDescription').value.trim();
      const plate = document.getElementById('reminderPlate').value.trim();
      const date = document.getElementById('reminderDate').value;
      const time = document.getElementById('reminderTime').value;
      const category = document.getElementById('reminderCategory').value;
      const priority = document.getElementById('reminderPriority').value;
      
      if (!title || !date) {
        alert('אנא מלא כותרת ותאריך לתזכורת');
        return;
      }
      
      const reminderData = {
        id: Date.now(),
        title,
        description,
        plate: plate || null,
        date,
        time,
        category,
        priority,
        status: 'active',
        created: new Date().toISOString()
      };
      
      try {
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available');
        }
        
        const response = await window.sendToWebhook('ADMIN_CREATE_REMINDER', {
          action: 'create_reminder',
          reminder: reminderData,
          timestamp: new Date().toISOString()
        });
        
        console.log('Reminder created:', response);
        
        // Add to local data
        window.remindersData.push(reminderData);
        
        // Refresh display
        renderReminders();
        
        // Close form
        closeReminderForm();
        
        alert('התזכורת נוצרה ונשלחה בהצלחה!');
        
      } catch (error) {
        console.error('Error creating reminder:', error);
        alert(`שגיאה ביצירת התזכורת: ${error.message}`);
      }
    };
    
    window.editReminder = function(id) {
      const reminder = window.remindersData.find(r => r.id === id) || {
        id: id,
        title: 'תזכורת לעריכה',
        description: 'תיאור התזכורת',
        plate: null,
        date: new Date().toISOString().split('T')[0],
        time: '09:00',
        category: 'general',
        priority: 'medium',
        status: 'active'
      };
      
      const formHtml = `
        <div id="reminderFormOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;">
          <div style="background: #2a2a2a; padding: 25px; border-radius: 12px; width: 500px; max-width: 90%; border: 2px solid #f59e0b;">
            <h3 style="color: #f59e0b; margin-bottom: 20px; text-align: center;">✏️ עריכת תזכורת</h3>
            
            <div style="margin-bottom: 15px;">
              <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">כותרת התזכורת:</label>
              <input type="text" id="reminderTitle" value="${reminder.title}" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">תיאור:</label>
              <textarea id="reminderDescription" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0; height: 80px; resize: vertical;">${reminder.description}</textarea>
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">מספר רכב (אופציונלי):</label>
              <input type="text" id="reminderPlate" value="${reminder.plate || ''}" placeholder="הכנס מספר רכב (אם רלוונטי)" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">תאריך יעד:</label>
                <input type="date" id="reminderDate" value="${reminder.date}" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
              </div>
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">שעה:</label>
                <input type="time" id="reminderTime" value="${reminder.time}" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">קטגוריה:</label>
                <select id="reminderCategory" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
                  <option value="case_deadline" ${reminder.category === 'case_deadline' ? 'selected' : ''}>מועד סגירת תיק</option>
                  <option value="payment_reminder" ${reminder.category === 'payment_reminder' ? 'selected' : ''}>תזכורת תשלום</option>
                  <option value="follow_up" ${reminder.category === 'follow_up' ? 'selected' : ''}>מעקב</option>
                  <option value="inspection" ${reminder.category === 'inspection' ? 'selected' : ''}>בדיקה</option>
                  <option value="general" ${reminder.category === 'general' ? 'selected' : ''}>כללי</option>
                </select>
              </div>
              <div>
                <label style="color: #e0e0e0; display: block; margin-bottom: 5px;">עדיפות:</label>
                <select id="reminderPriority" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 6px; background: #444; color: #e0e0e0;">
                  <option value="high" ${reminder.priority === 'high' ? 'selected' : ''}>גבוהה</option>
                  <option value="medium" ${reminder.priority === 'medium' ? 'selected' : ''}>בינונית</option>
                  <option value="low" ${reminder.priority === 'low' ? 'selected' : ''}>נמוכה</option>
                </select>
              </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: center;">
              <button onclick="updateReminder(${id})" style="padding: 12px 24px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">💾 עדכן</button>
              <button onclick="closeReminderForm()" style="padding: 12px 24px; background: #991b1b; color: white; border: none; border-radius: 8px; cursor: pointer;">❌ ביטול</button>
            </div>
          </div>
        </div>`;
      
      document.body.insertAdjacentHTML('beforeend', formHtml);
    };
    
    window.updateReminder = async function(id) {
      const title = document.getElementById('reminderTitle').value.trim();
      const description = document.getElementById('reminderDescription').value.trim();
      const plate = document.getElementById('reminderPlate').value.trim();
      const date = document.getElementById('reminderDate').value;
      const time = document.getElementById('reminderTime').value;
      const category = document.getElementById('reminderCategory').value;
      const priority = document.getElementById('reminderPriority').value;
      
      if (!title || !date) {
        alert('אנא מלא כותרת ותאריך לתזכורת');
        return;
      }
      
      const reminderData = {
        id,
        title,
        description,
        plate: plate || null,
        date,
        time,
        category,
        priority,
        status: 'active',
        updated: new Date().toISOString()
      };
      
      try {
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available');
        }
        
        const response = await window.sendToWebhook('ADMIN_CREATE_REMINDER', {
          action: 'update_reminder',
          reminder: reminderData,
          timestamp: new Date().toISOString()
        });
        
        console.log('Reminder updated:', response);
        
        // Update local data
        const index = window.remindersData.findIndex(r => r.id === id);
        if (index !== -1) {
          window.remindersData[index] = reminderData;
        }
        
        // Refresh display
        renderReminders();
        
        // Close form
        closeReminderForm();
        
        alert('התזכורת עודכנה בהצלחה!');
        
      } catch (error) {
        console.error('Error updating reminder:', error);
        alert(`שגיאה בעדכון התזכורת: ${error.message}`);
      }
    };
    
    window.completeReminder = async function(id) {
      if (!confirm('האם אתה בטוח שברצונך לסמן את התזכורת כהושלמה?')) {
        return;
      }
      
      try {
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available');
        }
        
        const response = await window.sendToWebhook('ADMIN_CREATE_REMINDER', {
          action: 'complete_reminder',
          reminder_id: id,
          timestamp: new Date().toISOString()
        });
        
        console.log('Reminder completed:', response);
        
        // Update local data
        const reminder = window.remindersData.find(r => r.id === id);
        if (reminder) {
          reminder.status = 'completed';
          reminder.completed = new Date().toISOString();
        }
        
        // Refresh display
        renderReminders();
        
        alert('התזכורת סומנה כהושלמה!');
        
      } catch (error) {
        console.error('Error completing reminder:', error);
        alert(`שגיאה בסימון התזכורת: ${error.message}`);
      }
    };
    
    window.deleteReminder = async function(id) {
      if (!confirm('האם אתה בטוח שברצונך למחוק את התזכורת? פעולה זו לא ניתנת לביטול.')) {
        return;
      }
      
      try {
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available');
        }
        
        const response = await window.sendToWebhook('ADMIN_CREATE_REMINDER', {
          action: 'delete_reminder',
          reminder_id: id,
          timestamp: new Date().toISOString()
        });
        
        console.log('Reminder deleted:', response);
        
        // Remove from local data
        window.remindersData = window.remindersData.filter(r => r.id !== id);
        
        // Refresh display
        renderReminders();
        
        alert('התזכורת נמחקה בהצלחה!');
        
      } catch (error) {
        console.error('Error deleting reminder:', error);
        alert(`שגיאה במחיקת התזכורת: ${error.message}`);
      }
    };
    
    // Legacy function - redirects to local filtering
    window.filterReminders = function() {
      console.warn('filterReminders() is deprecated. Use applyLocalFilters() instead.');
      applyLocalFilters();
    };
    
    window.toggleView = function() {
      const listView = document.getElementById('remindersListView');
      const calendarView = document.getElementById('remindersCalendarView');
      const toggleText = document.getElementById('viewToggleText');
      
      if (listView.style.display === 'none') {
        listView.style.display = 'block';
        calendarView.style.display = 'none';
        toggleText.textContent = 'תצוגת יומן';
      } else {
        listView.style.display = 'none';
        calendarView.style.display = 'block';
        toggleText.textContent = 'תצוגת רשימה';
        
        // Render calendar when switching to calendar view
        setTimeout(() => {
          renderCalendar();
        }, 100);
      }
    };
    
    window.exportReminders = async function() {
      // Check if data is loaded
      if (!window.remindersData || window.remindersData.length === 0) {
        alert('אין נתונים לייצוא - אנא טען תזכורות תחילה');
        return;
      }
      
      try {
        // Show loading
        const originalButton = event.target;
        const originalText = originalButton.innerHTML;
        originalButton.innerHTML = '⏳ מייצא...';
        originalButton.disabled = true;
        
        // Get current local filters
        const localStatus = document.getElementById('localStatusFilter').value;
        const localCategory = document.getElementById('localCategoryFilter').value;
        
        // Apply local filters to data for export
        let exportData = [...window.remindersData];
        
        if (localStatus !== 'all') {
          exportData = exportData.filter(r => r.status === localStatus);
        }
        if (localCategory !== 'all') {
          exportData = exportData.filter(r => r.category === localCategory);
        }
        
        // Wait for webhook to be ready
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          throw new Error('Webhook function not available');
        }
        
        // Create comprehensive filter description
        const serverFilterDesc = createFilterDescription(window.currentServerFilters);
        const localFilterDesc = [];
        if (localStatus !== 'all') localFilterDesc.push(`סטטוס מקומי: ${localStatus}`);
        if (localCategory !== 'all') localFilterDesc.push(`קטגוריה מקומית: ${localCategory}`);
        
        const fullFilterDesc = [serverFilterDesc, ...localFilterDesc].join(' + ');
        
        // Prepare export data in standardized format
        const exportPayload = {
          sender_id: 'רשימת תזכורות',
          export_date: new Date().toISOString(),
          export_type: 'filtered_reminders',
          data_type: `תזכורות מסוננות - ${fullFilterDesc}`,
          server_filters: window.currentServerFilters,
          local_filters: { status: localStatus, category: localCategory },
          total_reminders: exportData.length,
          data: exportData
        };
        
        console.log('🔄 Exporting reminders:', exportPayload);
        
        // Send to export webhook
        const response = await window.sendToWebhook('ADMIN_EXPORT_SEARCH_RESULTS', exportPayload);
        
        console.log('📤 Export response:', response);
        
        // Show success
        originalButton.innerHTML = '✅ יוצא בהצלחה';
        setTimeout(() => {
          originalButton.innerHTML = originalText;
          originalButton.disabled = false;
        }, 2000);
        
        alert(`נתוני התזכורות יוצאו בהצלחה! (${exportData.length} תזכורות)`);
        
      } catch (error) {
        console.error('Export error:', error);
        
        // Show error
        const originalButton = event.target;
        const originalText = originalButton.innerHTML;
        originalButton.innerHTML = '❌ שגיאה';
        setTimeout(() => {
          originalButton.innerHTML = originalText;
          originalButton.disabled = false;
        }, 2000);
        
        alert(`שגיאה בייצוא: ${error.message}`);
      }
    };
    
    window.renderReminders = function(statusFilter = 'all', categoryFilter = 'all') {
      const remindersList = document.getElementById('remindersList');
      if (!remindersList) return;
      
      let filteredData = window.remindersData;
      
      if (statusFilter !== 'all') {
        filteredData = filteredData.filter(r => r.status === statusFilter);
      }
      
      if (categoryFilter !== 'all') {
        filteredData = filteredData.filter(r => r.category === categoryFilter);
      }
      
      if (filteredData.length === 0) {
        remindersList.innerHTML = `
          <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; border: 1px solid #444; text-align: center;">
            <h3 style="color: #ff6b35;">אין תזכורות מתאימות</h3>
            <p style="color: #ccc;">לא נמצאו תזכורות התואמות לקריטריונים שנבחרו</p>
          </div>`;
        return;
      }
      
      remindersList.innerHTML = filteredData.map(reminder => {
        const statusColors = {
          active: { bg: '#16a34a', text: 'פעיל' },
          pending: { bg: '#f59e0b', text: 'ממתין' },
          completed: { bg: '#6b7280', text: 'הושלם' },
          overdue: { bg: '#dc2626', text: 'פג תוקף' }
        };
        
        const categoryNames = {
          case_deadline: 'מועד סגירת תיק',
          payment_reminder: 'תזכורת תשלום',
          follow_up: 'מעקב',
          inspection: 'בדיקה',
          general: 'כללי'
        };
        
        const priorityNames = {
          high: 'גבוהה',
          medium: 'בינונית',
          low: 'נמוכה'
        };
        
        const statusInfo = statusColors[reminder.status];
        
        return `
          <div style="background: #2a2a2a; padding: 15px; border-radius: 8px; margin: 10px 0; border: 1px solid #444;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <h4 style="color: #4ade80; margin: 0; font-size: 16px;">${reminder.title}</h4>
              <span style="background: ${statusInfo.bg}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${statusInfo.text}</span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; font-size: 14px; color: #ccc;">
              <div><strong style="color: #fbbf24;">תאריך יעד:</strong> ${new Date(reminder.date).toLocaleDateString('he-IL')}</div>
              <div><strong style="color: #fbbf24;">קטגוריה:</strong> ${categoryNames[reminder.category]}</div>
              <div><strong style="color: #fbbf24;">עדיפות:</strong> ${priorityNames[reminder.priority]}</div>
              <div><strong style="color: #fbbf24;">נוצר:</strong> ${new Date(reminder.created).toLocaleDateString('he-IL')}</div>
              ${reminder.plate ? `<div><strong style="color: #fbbf24;">מספר רכב:</strong> ${reminder.plate}</div>` : ''}
            </div>
            <p style="color: #e0e0e0; margin: 10px 0; font-size: 14px;">${reminder.description}</p>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
              <button onclick="editReminder(${reminder.id})" 
                      onmouseover="this.style.background='#f59e0b'; this.style.transform='translateY(-1px)';"
                      onmouseout="this.style.background='#d97706'; this.style.transform='translateY(0)';"
                      style="padding: 8px 16px; background: #d97706; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 13px;">
                ✏️ ערוך
              </button>
              ${reminder.status !== 'completed' ? `
                <button onclick="completeReminder(${reminder.id})" 
                        onmouseover="this.style.background='#059669'; this.style.transform='translateY(-1px)';"
                        onmouseout="this.style.background='#16a34a'; this.style.transform='translateY(0)';"
                        style="padding: 8px 16px; background: #16a34a; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 13px;">
                  ✅ סמן כהושלם
                </button>
              ` : ''}
              <button onclick="deleteReminder(${reminder.id})" 
                      onmouseover="this.style.background='#dc2626'; this.style.transform='translateY(-1px)';"
                      onmouseout="this.style.background='#991b1b'; this.style.transform='translateY(0)';"
                      style="padding: 8px 16px; background: #991b1b; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 13px;">
                🗑️ מחק
              </button>
            </div>
          </div>`;
      }).join('');
      
      // Update calendar if it's currently visible
      const calendarView = document.getElementById('remindersCalendarView');
      if (calendarView && calendarView.style.display !== 'none') {
        setTimeout(() => {
          renderCalendar();
        }, 100);
      }
    };

    // Calendar functionality
    window.currentCalendarDate = new Date();
    
    window.renderCalendar = function() {
      const calendarDays = document.getElementById('calendarDays');
      const calendarMonth = document.getElementById('calendarMonth');
      
      if (!calendarDays || !calendarMonth) return;
      
      const year = window.currentCalendarDate.getFullYear();
      const month = window.currentCalendarDate.getMonth();
      
      // Hebrew month names
      const monthNames = [
        'ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני',
        'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'
      ];
      
      calendarMonth.textContent = `${monthNames[month]} ${year}`;
      
      // Get first day of month and days in month
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      
      // Get the day of week for the first day (0 = Sunday, 6 = Saturday)
      // Hebrew calendar starts with Sunday, so we need to adjust
      const startingDayOfWeek = firstDay.getDay();
      
      // Clear calendar
      calendarDays.innerHTML = '';
      
      // Add empty cells for days before the first day of the month
      for (let i = 0; i < startingDayOfWeek; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.style.cssText = 'background: #1a1a1a; padding: 12px; border-radius: 4px; min-height: 40px;';
        calendarDays.appendChild(emptyDay);
      }
      
      // Add days of the month
      for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        const currentDate = new Date(year, month, day);
        const dateString = currentDate.toISOString().split('T')[0];
        
        // Check if this date has reminders
        const dayReminders = window.remindersData.filter(r => r.date === dateString);
        const hasReminders = dayReminders.length > 0;
        
        // Style based on whether it has reminders
        const dayStyle = hasReminders 
          ? 'background: #ff6b35; color: white; padding: 12px; border-radius: 4px; min-height: 40px; cursor: pointer; text-align: center; font-weight: bold; position: relative;'
          : 'background: #444; color: #e0e0e0; padding: 12px; border-radius: 4px; min-height: 40px; cursor: pointer; text-align: center; hover:background: #555;';
        
        dayElement.style.cssText = dayStyle;
        dayElement.innerHTML = `
          <div>${day}</div>
          ${hasReminders ? `<div style="position: absolute; top: 2px; right: 2px; background: #16a34a; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center;">${dayReminders.length}</div>` : ''}
        `;
        
        // Add click handler
        dayElement.onclick = () => showDateReminders(dateString, day);
        
        // Add hover effect
        dayElement.onmouseover = () => {
          if (!hasReminders) {
            dayElement.style.background = '#555';
          }
        };
        dayElement.onmouseout = () => {
          if (!hasReminders) {
            dayElement.style.background = '#444';
          }
        };
        
        calendarDays.appendChild(dayElement);
      }
    };
    
    window.previousMonth = function() {
      window.currentCalendarDate.setMonth(window.currentCalendarDate.getMonth() - 1);
      renderCalendar();
    };
    
    window.nextMonth = function() {
      window.currentCalendarDate.setMonth(window.currentCalendarDate.getMonth() + 1);
      renderCalendar();
    };
    
    window.showDateReminders = function(dateString, day) {
      const dateReminders = window.remindersData.filter(r => r.date === dateString);
      const selectedDateReminders = document.getElementById('selectedDateReminders');
      const selectedDateText = document.getElementById('selectedDateText');
      const selectedDateRemindersList = document.getElementById('selectedDateRemindersList');
      
      if (!selectedDateReminders || !selectedDateText || !selectedDateRemindersList) return;
      
      selectedDateText.textContent = `${day}/${window.currentCalendarDate.getMonth() + 1}/${window.currentCalendarDate.getFullYear()}`;
      
      if (dateReminders.length === 0) {
        selectedDateRemindersList.innerHTML = '<p style="color: #ccc; text-align: center; margin: 10px 0;">אין תזכורות ליום זה</p>';
      } else {
        selectedDateRemindersList.innerHTML = dateReminders.map(reminder => {
          const categoryNames = {
            case_deadline: 'מועד סגירת תיק',
            payment_reminder: 'תזכורת תשלום',
            follow_up: 'מעקב',
            inspection: 'בדיקה',
            general: 'כללי'
          };
          
          const priorityColors = {
            high: '#dc2626',
            medium: '#f59e0b',
            low: '#16a34a'
          };
          
          return `
            <div style="background: #2a2a2a; padding: 10px; border-radius: 6px; margin: 5px 0; border: 1px solid #555;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                <strong style="color: #4ade80;">${reminder.title}</strong>
                <span style="background: ${priorityColors[reminder.priority]}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">${reminder.priority}</span>
              </div>
              <div style="font-size: 12px; color: #ccc; margin-bottom: 5px;">${reminder.time || '09:00'} | ${categoryNames[reminder.category]}</div>
              <div style="color: #e0e0e0; font-size: 13px;">${reminder.description}</div>
              ${reminder.plate ? `<div style="color: #fbbf24; font-size: 12px; margin-top: 5px;">רכב: ${reminder.plate}</div>` : ''}
            </div>
          `;
        }).join('');
      }
      
      selectedDateReminders.style.display = 'block';
    };

    window.loadCaseForEdit = function() {
      const plate = document.getElementById('editPlateSearch').value.trim();
      if (!plate) {
        alert('אנא הכנס מספר רכב');
        return;
      }
      
      document.getElementById('editResults').innerHTML = `
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeaa7;">
          <h4>עריכת תיק: ${plate}</h4>
          <p>פונקציית עריכה נתונים תהיה זמינה בגרסה הבאה</p>
          <p>נכון לעכשיו ניתן לצפות בנתונים בלבד</p>
        </div>`;
    };

    window.refreshLog = function() {
      document.getElementById('logContent').innerHTML = `
        <div style="border-bottom: 1px solid #ddd; padding: 10px 0;">
          <strong>${new Date().toLocaleString('he-IL')}</strong> - יומן רוענן על ידי מנהל
        </div>
        <div style="border-bottom: 1px solid #ddd; padding: 10px 0;">
          <strong>${new Date().toLocaleString('he-IL')}</strong> - משתמש נכנס למערכת הניהול
        </div>
        <div style="border-bottom: 1px solid #ddd; padding: 10px 0;">
          <strong>${new Date(Date.now() - 3600000).toLocaleString('he-IL')}</strong> - עודכן מע"מ גלובלי ל-18%
        </div>`;
    };

    window.exportLog = function() {
      alert('יומן יוצא לקובץ CSV - פונקציה תהיה זמינה בגרסה הבאה');
    };

    // Voice Reminder Functionality - STT Integration for Reminder Creation
    window.startVoiceReminder = function() {
      console.log('🎤 Voice reminder button clicked');
      console.log('Browser support check:', {
        webkitSpeechRecognition: 'webkitSpeechRecognition' in window,
        SpeechRecognition: 'SpeechRecognition' in window,
        userAgent: navigator.userAgent
      });
      
      // Check if speech recognition is available
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        console.error('❌ Speech recognition not supported in this browser');
        alert('זיהוי קול לא נתמך בדפדפן זה\nאנא השתמש בכרום או אדג\'');
        return;
      }
      
      console.log('✅ Speech recognition supported, showing modal...');
      
      // Show voice recording modal
      const modalHtml = `
        <div id="voiceReminderModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 20px; box-sizing: border-box;">
          <div style="background: #2a2a2a; border-radius: 12px; max-width: 500px; width: 90%; border: 2px solid #7c3aed; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column;">
            <div style="padding: 30px; flex: 1; overflow-y: auto;">
            <div style="text-align: center; margin-bottom: 20px;">
              <h3 style="color: #7c3aed; margin: 0 0 10px 0;">🎤 יצירת תזכורת קולית</h3>
              <p style="color: #ccc; font-size: 14px; margin: 0;">דבר בעברית - המערכת תזהה תאריך, שעה ומספר רכב אוטומטית</p>
            </div>
            
            <!-- Recording Status -->
            <div id="voiceReminderStatus" style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #555; text-align: center;">
              <div id="recordingIndicator" style="color: #ff6b6b; font-size: 18px; margin-bottom: 10px;">🔴 לחץ על "התחל הקלטה" כדי להתחיל</div>
              <div id="speechText" style="color: #e0e0e0; font-size: 16px; min-height: 50px; font-style: italic;">המתן לטקסט המזוהה...</div>
            </div>
            
            <!-- Voice Controls -->
            <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
              <button id="startRecordingBtn" onclick="startRecordingVoiceReminder()" 
                      style="padding: 12px 24px; background: #7c3aed; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                🎤 התחל הקלטה
              </button>
              <button id="stopRecordingBtn" onclick="stopRecordingVoiceReminder()" disabled
                      style="padding: 12px 24px; background: #dc2626; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; opacity: 0.5;">
                ⏹️ עצור
              </button>
            </div>
            
            <!-- Processed Results -->
            <div id="voiceReminderResults" style="display: none; background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #444;">
              <div style="color: #4ade80; font-weight: bold; margin-bottom: 10px;">📝 תוצאות זיהוי:</div>
              <div id="extractedData" style="color: #e0e0e0; font-size: 14px;"></div>
              <div style="margin-top: 15px;">
                <button onclick="confirmVoiceReminder()" 
                        style="padding: 10px 20px; background: #16a34a; color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px;">
                  ✅ צור תזכורת
                </button>
                <button onclick="retryVoiceRecording()" 
                        style="padding: 10px 20px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer;">
                  🔄 נסה שוב
                </button>
              </div>
            </div>
            
            <!-- Modal Controls -->
            <div style="display: flex; gap: 10px; justify-content: center;">
              <button onclick="closeVoiceReminderModal()" 
                      style="padding: 12px 24px; background: #991b1b; color: white; border: none; border-radius: 8px; cursor: pointer;">
                ❌ ביטול
              </button>
            </div>
            </div>
          </div>
        </div>`;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    };

    // Voice Recording Control Functions
    window.startRecordingVoiceReminder = function() {
      const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
      const recognition = new SpeechRecognition();
      
      // Configure recognition for Hebrew
      recognition.lang = 'he-IL';
      recognition.interimResults = true;
      recognition.maxAlternatives = 1;
      recognition.continuous = true;
      
      // Update UI for recording state
      const indicator = document.getElementById('recordingIndicator');
      const speechText = document.getElementById('speechText');
      const startBtn = document.getElementById('startRecordingBtn');
      const stopBtn = document.getElementById('stopRecordingBtn');
      
      if (indicator) indicator.textContent = '🔴 מקליט... דבר עכשיו';
      if (speechText) speechText.textContent = 'מקשיב...';
      if (startBtn) { startBtn.disabled = true; startBtn.style.opacity = '0.5'; }
      if (stopBtn) { stopBtn.disabled = false; stopBtn.style.opacity = '1'; }
      
      // Store recognition instance for stopping
      window.currentVoiceRecognition = recognition;
      
      // Handle speech results
      recognition.addEventListener('result', (event) => {
        let finalTranscript = '';
        let interimTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript + ' ';
          } else {
            interimTranscript += transcript;
          }
        }
        
        // Update speech text display
        const displayText = finalTranscript + interimTranscript;
        if (speechText) {
          speechText.textContent = displayText || 'מקשיב...';
        }
        
        // Store the transcript
        window.voiceReminderTranscript = finalTranscript.trim();
      });
      
      // Handle recognition end
      recognition.addEventListener('end', () => {
        if (indicator) indicator.textContent = '✅ הקלטה הסתיימה';
        if (startBtn) { startBtn.disabled = false; startBtn.style.opacity = '1'; }
        if (stopBtn) { stopBtn.disabled = true; stopBtn.style.opacity = '0.5'; }
        
        // Process the recorded speech
        processVoiceReminderText();
      });
      
      // Handle errors
      recognition.addEventListener('error', (event) => {
        console.error('Voice recognition error:', event.error);
        if (indicator) indicator.textContent = '❌ שגיאה בזיהוי קול: ' + event.error;
        if (startBtn) { startBtn.disabled = false; startBtn.style.opacity = '1'; }
        if (stopBtn) { stopBtn.disabled = true; stopBtn.style.opacity = '0.5'; }
      });
      
      // Start recognition
      try {
        recognition.start();
        console.log('🎤 Voice recognition started for reminder creation');
      } catch (error) {
        console.error('Failed to start voice recognition:', error);
        if (indicator) indicator.textContent = '❌ נכשל להתחיל זיהוי קול';
      }
    };

    window.stopRecordingVoiceReminder = function() {
      if (window.currentVoiceRecognition) {
        window.currentVoiceRecognition.stop();
        window.currentVoiceRecognition = null;
      }
    };

    // Process voice text and extract reminder data
    window.processVoiceReminderText = function() {
      const transcript = window.voiceReminderTranscript || '';
      
      if (!transcript) {
        document.getElementById('recordingIndicator').textContent = '❌ לא זוהה טקסט - נסה שוב';
        return;
      }
      
      console.log('🔍 Processing voice reminder text:', transcript);
      
      // Hebrew date/time extraction patterns
      const extractedData = {
        title: '',
        description: transcript,
        date: null,
        time: null,
        plate: null,
        category: 'general',
        priority: 'medium'
      };
      
      // Extract plate number patterns (Israeli format)
      const platePatterns = [
        /(\d{7,8})/g, // 7-8 digits
        /(\d{3}[-\s]?\d{2}[-\s]?\d{3})/g, // xxx-xx-xxx format
        /רכב\s*:?\s*(\d+)/gi, // "רכב: 123456"
        /מספר\s*:?\s*(\d+)/gi, // "מספר: 123456"
        /לוחית\s*:?\s*(\d+)/gi // "לוחית: 123456"
      ];
      
      for (const pattern of platePatterns) {
        const match = transcript.match(pattern);
        if (match) {
          extractedData.plate = match[0].replace(/[-\s]/g, '');
          break;
        }
      }
      
      // Extract Hebrew dates and times
      const today = new Date();
      
      // Date patterns
      const datePatterns = [
        { pattern: /היום/gi, offset: 0 },
        { pattern: /מחר/gi, offset: 1 },
        { pattern: /מחרתיים/gi, offset: 2 },
        { pattern: /השבוע הבא/gi, offset: 7 },
        { pattern: /בעוד שבוע/gi, offset: 7 },
        { pattern: /בעוד (\d+) ימים/gi, offset: 'dynamic' },
        { pattern: /תאריך יעד[:\s]*היום/gi, offset: 0 },
        { pattern: /תאריך יעד[:\s]*מחר/gi, offset: 1 },
        { pattern: /תאריך יעד[:\s]*מחרתיים/gi, offset: 2 },
        { pattern: /עד היום/gi, offset: 0 },
        { pattern: /עד מחר/gi, offset: 1 },
        { pattern: /עד תאריך[:\s]*היום/gi, offset: 0 },
        { pattern: /עד תאריך[:\s]*מחר/gi, offset: 1 },
        { pattern: /עד תאריך[:\s]*מחרתיים/gi, offset: 2 },
        { pattern: /תאריך יעד[:\s]*(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})/gi, offset: 'date' },
        { pattern: /עד[:\s]*(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})/gi, offset: 'date' },
        { pattern: /עד תאריך[:\s]*(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})/gi, offset: 'date' }
      ];
      
      for (const { pattern, offset } of datePatterns) {
        const match = transcript.match(pattern);
        if (match) {
          const targetDate = new Date(today);
          if (offset === 'dynamic') {
            const days = parseInt(match[1]);
            targetDate.setDate(today.getDate() + days);
          } else if (offset === 'date') {
            // Handle DD/MM/YYYY format
            const day = parseInt(match[1]);
            const month = parseInt(match[2]) - 1; // Month is 0-indexed
            const year = parseInt(match[3]);
            targetDate.setFullYear(year, month, day);
          } else {
            targetDate.setDate(today.getDate() + offset);
          }
          extractedData.date = targetDate.toISOString().split('T')[0];
          break;
        }
      }
      
      // Time patterns
      const timePatterns = [
        /(\d{1,2}):(\d{2})/g, // HH:MM format
        /(\d{1,2}) ו(\d{2})/g, // Hebrew "X וY" format  
        /בשעה\s*(\d{1,2})/gi, // "בשעה X"
        /ב(\d{1,2})/gi // "בX" (at X o'clock)
      ];
      
      for (const pattern of timePatterns) {
        const match = transcript.match(pattern);
        if (match) {
          let hour = parseInt(match[1]);
          let minute = match[2] ? parseInt(match[2]) : 0;
          
          // Handle PM/AM context in Hebrew
          if (transcript.includes('אחה"צ') || transcript.includes('אחרי הצהריים') || transcript.includes('בערב')) {
            if (hour < 12) hour += 12;
          }
          
          extractedData.time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
          break;
        }
      }
      
      // Set default date/time if not found
      if (!extractedData.date) {
        extractedData.date = today.toISOString().split('T')[0];
      }
      if (!extractedData.time) {
        extractedData.time = '09:00';
      }
      
      // Generate title from description (first 50 chars)
      extractedData.title = transcript.substring(0, 50) + (transcript.length > 50 ? '...' : '');
      
      // Determine category based on keywords
      const categoryKeywords = {
        payment_reminder: ['תשלום', 'חיוב', 'כסף', 'חשבון'],
        case_deadline: ['תיק', 'סגירה', 'דדליין', 'מועד'],
        follow_up: ['מעקב', 'בדיקה', 'עדכון', 'טלפון'],
        inspection: ['בדיקה', 'ביקורת', 'אקספרטיזה']
      };
      
      for (const [category, keywords] of Object.entries(categoryKeywords)) {
        if (keywords.some(keyword => transcript.includes(keyword))) {
          extractedData.category = category;
          break;
        }
      }
      
      // Determine priority based on keywords
      if (transcript.includes('דחוף') || transcript.includes('חשוב') || transcript.includes('מיידי')) {
        extractedData.priority = 'high';
      } else if (transcript.includes('רגיל') || transcript.includes('נמוך')) {
        extractedData.priority = 'low';
      }
      
      // Store extracted data globally
      window.extractedVoiceReminderData = extractedData;
      
      // Display results
      displayVoiceReminderResults(extractedData);
    };

    // Display extracted data for user confirmation
    window.displayVoiceReminderResults = function(data) {
      const resultsDiv = document.getElementById('voiceReminderResults');
      const extractedDataDiv = document.getElementById('extractedData');
      
      if (!resultsDiv || !extractedDataDiv) return;
      
      const categoryNames = {
        case_deadline: 'מועד סגירת תיק',
        payment_reminder: 'תזכורת תשלום', 
        follow_up: 'מעקב',
        inspection: 'בדיקה',
        general: 'כללי'
      };
      
      const priorityNames = {
        high: 'גבוהה',
        medium: 'בינונית',
        low: 'נמוכה'
      };
      
      extractedDataDiv.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
          <div>
            <label style="color: #fbbf24; font-weight: bold; display: block; margin-bottom: 5px;">כותרת:</label>
            <input type="text" id="editVoiceTitle" value="${data.title}" style="width: 100%; padding: 8px; border: 1px solid #555; border-radius: 4px; background: #444; color: #e0e0e0;">
          </div>
          <div>
            <label style="color: #fbbf24; font-weight: bold; display: block; margin-bottom: 5px;">תאריך יצירה:</label>
            <input type="date" id="editVoiceCreated" value="${new Date().toISOString().split('T')[0]}" readonly style="width: 100%; padding: 8px; border: 1px solid #555; border-radius: 4px; background: #333; color: #999; cursor: not-allowed;">
          </div>
          <div>
            <label style="color: #fbbf24; font-weight: bold; display: block; margin-bottom: 5px;">📅 תאריך יעד:</label>
            <input type="date" id="editVoiceDueDate" value="${data.date}" style="width: 100%; padding: 8px; border: 1px solid #555; border-radius: 4px; background: #444; color: #e0e0e0;">
          </div>
          <div>
            <label style="color: #fbbf24; font-weight: bold; display: block; margin-bottom: 5px;">⏰ שעת יעד:</label>
            <input type="time" id="editVoiceDueTime" value="${data.time}" style="width: 100%; padding: 8px; border: 1px solid #555; border-radius: 4px; background: #444; color: #e0e0e0;">
          </div>
          <div>
            <label style="color: #fbbf24; font-weight: bold; display: block; margin-bottom: 5px;">קטגוריה:</label>
            <select id="editVoiceCategory" style="width: 100%; padding: 8px; border: 1px solid #555; border-radius: 4px; background: #444; color: #e0e0e0;">
              <option value="general" ${data.category === 'general' ? 'selected' : ''}>כללי</option>
              <option value="case_deadline" ${data.category === 'case_deadline' ? 'selected' : ''}>מועד סגירת תיק</option>
              <option value="payment_reminder" ${data.category === 'payment_reminder' ? 'selected' : ''}>תזכורת תשלום</option>
              <option value="follow_up" ${data.category === 'follow_up' ? 'selected' : ''}>מעקב</option>
              <option value="inspection" ${data.category === 'inspection' ? 'selected' : ''}>בדיקה</option>
            </select>
          </div>
          <div>
            <label style="color: #fbbf24; font-weight: bold; display: block; margin-bottom: 5px;">עדיפות:</label>
            <select id="editVoicePriority" style="width: 100%; padding: 8px; border: 1px solid #555; border-radius: 4px; background: #444; color: #e0e0e0;">
              <option value="low" ${data.priority === 'low' ? 'selected' : ''}>נמוכה</option>
              <option value="medium" ${data.priority === 'medium' ? 'selected' : ''}>בינונית</option>
              <option value="high" ${data.priority === 'high' ? 'selected' : ''}>גבוהה</option>
            </select>
          </div>
          <div>
            <label style="color: #fbbf24; font-weight: bold; display: block; margin-bottom: 5px;">רכב:</label>
            <input type="text" id="editVoicePlate" value="${data.plate || ''}" placeholder="מספר רכב" style="width: 100%; padding: 8px; border: 1px solid #555; border-radius: 4px; background: #444; color: #e0e0e0;">
          </div>
        </div>
        <div style="margin-bottom: 15px;">
          <label style="color: #fbbf24; font-weight: bold; display: block; margin-bottom: 5px;">תיאור מלא:</label>
          <textarea id="editVoiceDescription" rows="3" style="width: 100%; padding: 8px; border: 1px solid #555; border-radius: 4px; background: #444; color: #e0e0e0; resize: vertical;">${data.description}</textarea>
        </div>
        <div style="background: #1a1a1a; padding: 10px; border-radius: 4px; margin-bottom: 15px; border: 1px solid #555;">
          <strong style="color: #4ade80;">🎤 טקסט מקורי מהקול:</strong>
          <div style="margin-top: 5px; color: #ccc; font-style: italic; font-size: 13px;">"${data.description}"</div>
        </div>
      `;
      
      resultsDiv.style.display = 'block';
    };

    // Confirm and create the voice reminder
    window.confirmVoiceReminder = async function() {
      const originalData = window.extractedVoiceReminderData;
      if (!originalData) {
        alert('אין נתונים ליצירת תזכורת');
        return;
      }
      
      // Get edited values from the form
      const editedData = {
        title: document.getElementById('editVoiceTitle')?.value?.trim() || originalData.title,
        description: document.getElementById('editVoiceDescription')?.value?.trim() || originalData.description,
        plate: document.getElementById('editVoicePlate')?.value?.trim() || originalData.plate || null,
        date: document.getElementById('editVoiceDueDate')?.value || originalData.date,
        time: document.getElementById('editVoiceDueTime')?.value || originalData.time,
        category: document.getElementById('editVoiceCategory')?.value || originalData.category,
        priority: document.getElementById('editVoicePriority')?.value || originalData.priority,
        createdDate: document.getElementById('editVoiceCreatedDate')?.value || new Date().toISOString().split('T')[0]
      };
      
      // Validate required fields
      if (!editedData.title || !editedData.date) {
        alert('אנא מלא כותרת ותאריך לתזכורת');
        return;
      }
      
      try {
        console.log('🔄 Starting voice reminder creation process...');
        console.log('Original data:', originalData);
        console.log('Edited data:', editedData);
        console.log('Webhook ready:', window.webhookReady);
        console.log('sendToWebhook available:', typeof window.sendToWebhook);
        
        // Wait for webhook to be ready with better timing handling
        if (!window.webhookReady) {
          console.log('⏳ Webhook not ready, waiting for initialization...');
          // Wait a bit for webhook to initialize
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
          console.error('❌ Webhook system not available');
          console.log('Available functions:', Object.keys(window).filter(k => k.includes('webhook')));
          throw new Error('מערכת הקישור לשרת לא זמינה - נסה לרענן את הדף');
        }
        
        console.log('🔄 Creating voice reminder with edited data:', editedData);
        
        // Use the same data structure as regular reminder creation
        const reminderData = {
          id: Date.now(),
          title: editedData.title,
          description: editedData.description,
          plate: editedData.plate,
          date: editedData.date,
          time: editedData.time,
          category: editedData.category,
          priority: editedData.priority,
          status: 'active',
          created: new Date().toISOString(),
          created_date: editedData.createdDate,
          due_date: editedData.date,
          due_time: editedData.time,
          created_via: 'voice_stt',
          voice_transcript: window.voiceReminderTranscript || ''
        };
        
        console.log('📤 Sending voice reminder payload:', reminderData);
        
        const response = await window.sendToWebhook('ADMIN_CREATE_REMINDER', {
          action: 'create_reminder',
          reminder: reminderData,
          timestamp: new Date().toISOString()
        });
        
        console.log('✅ Voice reminder created successfully:', response);
        
        // Add to local data if available
        if (window.remindersData && Array.isArray(window.remindersData)) {
          window.remindersData.push(reminderData);
          console.log('🔄 Refreshing reminders display...');
          renderReminders();
        } else {
          console.log('ℹ️ No reminders data loaded, skipping refresh');
        }
        
        // Close modal and show success
        closeVoiceReminderModal();
        alert('✅ תזכורת קולית נוצרה בהצלחה!');
        
      } catch (error) {
        console.error('❌ Failed to create voice reminder:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          webhookReady: window.webhookReady,
          sendToWebhookType: typeof window.sendToWebhook
        });
        alert(`❌ שגיאה ביצירת תזכורת: ${error.message}`);
      }
    };

    // Retry voice recording
    window.retryVoiceRecording = function() {
      // Hide results and reset
      const resultsDiv = document.getElementById('voiceReminderResults');
      const speechText = document.getElementById('speechText');
      const indicator = document.getElementById('recordingIndicator');
      
      if (resultsDiv) resultsDiv.style.display = 'none';
      if (speechText) speechText.textContent = 'המתן לטקסט המזוהה...';
      if (indicator) indicator.textContent = '🔴 לחץ על "התחל הקלטה" כדי להתחיל';
      
      // Clear stored data
      window.voiceReminderTranscript = '';
      window.extractedVoiceReminderData = null;
    };

    // Close voice reminder modal
    window.closeVoiceReminderModal = function() {
      // Stop any ongoing recording
      if (window.currentVoiceRecognition) {
        window.currentVoiceRecognition.stop();
        window.currentVoiceRecognition = null;
      }
      
      // Remove modal
      const modal = document.getElementById('voiceReminderModal');
      if (modal) modal.remove();
      
      // Clear stored data
      window.voiceReminderTranscript = '';
      window.extractedVoiceReminderData = null;
    };

  
  // Add to existing DOMContentLoaded event from first script
  document.addEventListener('DOMContentLoaded', () => {
    // Check if user has basic authentication
    const auth = sessionStorage.getItem('auth');
    if (!auth) {
      console.log('❌ No auth token found in admin.html, redirecting to login');
      alert('הגישה חסומה - אנא התחבר דרך דף הבית');
      window.location.href = 'index.html';
      return;
    }
    
    // Check for admin-specific access
    const adminAccess = sessionStorage.getItem('admin-access');
    const adminTimestamp = sessionStorage.getItem('admin-timestamp');
    
    if (!adminAccess || !adminAccess.includes('granted')) {
      console.log('❌ No admin access token found, redirecting to selection');
      alert('גישת מנהל נדרשת - אנא אמת את הזהות שלך דרך עמוד הבחירה');
      window.location.href = 'selection.html';
      return;
    }
    
    // Check if admin session is still valid (24 hours)
    if (adminTimestamp) {
      const sessionAge = Date.now() - new Date(adminTimestamp).getTime();
      const maxAge = 24 * 60 * 60 * 1000; // 24 hours
      
      if (sessionAge > maxAge) {
        console.log('❌ Admin session expired, redirecting to selection');
        sessionStorage.removeItem('admin-access');
        sessionStorage.removeItem('admin-timestamp');
        alert('תוקף גישת המנהל פג - אנא התחבר מחדש');
        window.location.href = 'selection.html';
        return;
      }
    }
    
    console.log('✅ Admin access verified, loading admin panel');
    console.log('Admin access type:', adminAccess);
    
    // Load VAT from session
    const existingVat = sessionStorage.getItem('globalVAT');
    if (existingVat) {
      document.getElementById('vat-input').value = existingVat;
    }
  });
</script>

<script>
// Global dev access function - non-module script for immediate availability
async function verifyDevAccess() {
  const password = prompt("Enter developer password:");
  if (!password) return;
  
  // Get button reference
  const submitBtn = document.getElementById('devButton');
  const originalText = submitBtn?.textContent || 'Developer Panel';
  
  try {
    // Show loading state
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = 'מתחבר למערכת...';
    }
    
    // Check for direct dev module access
    if (password === 'dev_admin_2025') {
      sessionStorage.setItem('dev-access', 'granted');
      if (submitBtn) {
        submitBtn.textContent = '✅ גישה אושרה';
      }
      setTimeout(() => {
        window.location.href = 'dev-module.html';
      }, 500);
      return;
    }
    
    // Import webhooks dynamically with fallback
    let sendToWebhook;
    let WEBHOOKS;
    try {
      const webhookModule = await import('./webhook.js');
      sendToWebhook = webhookModule.sendToWebhook;
      WEBHOOKS = webhookModule.WEBHOOKS;
      console.log('✅ Successfully imported webhook module');
    } catch (importError) {
      console.error('Failed to import webhook module:', importError);
      // Fallback webhook URL
      WEBHOOKS = {
        DEV_HUB: 'https://hook.eu2.make.com/cg8j5gu0wyum6yrbl4rz2myd0pew3znt'
      };
      console.log('⚠️ Using fallback webhook URL');
    }
    
    // Use direct fetch if sendToWebhook is not available
    let response;
    if (sendToWebhook) {
      console.log('🔍 Attempting DEV_HUB webhook verification via sendToWebhook...');
      response = await sendToWebhook('DEV_HUB', { 
        password,
        action: 'dev_login',
        timestamp: new Date().toISOString(),
        user_auth: sessionStorage.getItem('auth')
      });
    } else {
      console.log('🔍 Attempting DEV_HUB webhook verification via direct fetch...');
      const fetchResponse = await fetch(WEBHOOKS.DEV_HUB, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          password,
          action: 'dev_login',
          timestamp: new Date().toISOString(),
          user_auth: sessionStorage.getItem('auth')
        })
      });
      
      console.log('🔍 DEV_HUB fetch response status:', fetchResponse.status);
      
      if (!fetchResponse.ok) {
        throw new Error(`HTTP ${fetchResponse.status}: ${fetchResponse.statusText}`);
      }
      
      try {
        response = await fetchResponse.json();
      } catch (jsonError) {
        console.log('Response is not JSON, getting text...');
        response = await fetchResponse.text();
      }
    }
    
    console.log('🔍 DEV_HUB webhook response:', response);
    
    // Enhanced dev access validation with multiple patterns
    const isDevAccess = 
      // JSON response patterns
      response?.role === 'dev' || 
      response?.access === 'dev' ||
      response?.status === 'dev' ||
      response?.result === 'dev' ||
      response?.access_granted === true ||
      response?.dev === true ||
      response?.authenticated === true ||
      response?.valid === true ||
      
      // Check for success indicators
      response?.success === true ||
      response?.approved === true ||
      
      // String response patterns (if response is just a string) - FIXED
      (typeof response === 'string' && /^(dev|success|granted|approved|valid|authenticated|true)$/i.test(response.trim())) ||
      
      // Handle webhook response that returns "approved" as seen in console
      response === 'approved' ||
      response === 'dev' ||
      response === 'granted';
    
    console.log('🔍 Dev access validation result:', isDevAccess);
    console.log('🔍 Response details:', {
      response,
      type: typeof response,
      stringValue: typeof response === 'string' ? response.trim() : 'not a string',
      regexTest: typeof response === 'string' ? /^(dev|success|granted|approved|valid|authenticated|true)$/i.test(response.trim()) : 'not tested'
    });
    
    if (isDevAccess) {
      console.log('✅ Dev access granted via webhook');
      sessionStorage.setItem('dev-access', 'granted');
      if (submitBtn) {
        submitBtn.textContent = '✅ גישה אושרה';
      }
      setTimeout(() => {
        window.location.href = 'dev-module.html';
      }, 500);
    } else {
      console.error('❌ Dev access denied');
      console.error('Response details:', response);
      if (submitBtn) {
        submitBtn.textContent = '❌ גישה נדחתה';
        setTimeout(() => {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }, 2000);
      }
      alert('❌ Access denied: incorrect password or insufficient privileges');
    }
    
  } catch (err) {
    console.error('Dev login failed:', err);
    
    if (submitBtn) {
      submitBtn.textContent = '❌ שגיאת חיבור';
      setTimeout(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }, 2000);
    }
    
    let errorMessage = 'שגיאה בחיבור לשרת האימות';
    
    if (err.message.includes('Failed to fetch')) {
      errorMessage = 'שגיאת רשת - בדוק חיבור לאינטרנט';
    } else if (err.message.includes('timeout')) {
      errorMessage = 'פג זמן החיבור - נסה שוב';
    }
    
    alert(`🚫 Verification failed: ${errorMessage}`);
    
    // Emergency fallback only if it's a network error
    if (err.message.includes('HTTP') || err.message.includes('network')) {
      const fallbackAccess = confirm('Server connection failed. Use offline emergency access?');
      if (fallbackAccess && password === 'dev_admin_2025') {
        sessionStorage.setItem('dev-access', 'granted-offline');
        window.location.href = 'dev-module.html';
      }
    }
  }
}

// Ensure function is globally available
window.verifyDevAccess = verifyDevAccess;

// External Calendar Integration Template - Google/Outlook Sync Placeholder
window.showCalendarSyncModal = function() {
  // Show calendar provider selection modal
  const modalHtml = `
    <div id="calendarSyncModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000;">
      <div style="background: #2a2a2a; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; border: 2px solid #0284c7;">
        <div style="text-align: center; margin-bottom: 20px;">
          <h3 style="color: #0284c7; margin: 0 0 10px 0;">🔗 סנכרון יומן חיצוני</h3>
          <p style="color: #ccc; font-size: 14px; margin: 0;">בחר ספק יומן כדי לסנכרן תזכורות עם יומן חיצוני</p>
        </div>
        
        <!-- Calendar Provider Selection -->
        <div style="background: #333; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #555;">
          <div style="color: #0284c7; font-weight: bold; margin-bottom: 15px;">בחר ספק יומן:</div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <!-- Google Calendar Option -->
            <button id="googleCalendarBtn" onclick="selectCalendarProvider('google')" 
                    style="padding: 20px; background: #1a1a1a; border: 2px solid #4285f4; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
              <div style="text-align: center;">
                <div style="font-size: 32px; margin-bottom: 10px;">📅</div>
                <div style="color: #4285f4; font-weight: bold; margin-bottom: 5px;">Google Calendar</div>
                <div style="color: #ccc; font-size: 12px;">סנכרון עם גוגל קלנדר</div>
              </div>
            </button>
            
            <!-- Outlook Calendar Option -->
            <button id="outlookCalendarBtn" onclick="selectCalendarProvider('outlook')" 
                    style="padding: 20px; background: #1a1a1a; border: 2px solid #0078d4; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
              <div style="text-align: center;">
                <div style="font-size: 32px; margin-bottom: 10px;">📆</div>
                <div style="color: #0078d4; font-weight: bold; margin-bottom: 5px;">Outlook Calendar</div>
                <div style="color: #ccc; font-size: 12px;">סנכרון עם אאוטלוק</div>
              </div>
            </button>
          </div>
          
          <!-- Selected Provider Info -->
          <div id="selectedProviderInfo" style="display: none; background: #1a1a1a; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
            <div style="color: #4ade80; font-weight: bold; margin-bottom: 10px;">✅ נבחר: <span id="selectedProviderName"></span></div>
            <div id="providerInstructions" style="color: #e0e0e0; font-size: 14px; margin-bottom: 15px;"></div>
            
            <!-- Sync Options -->
            <div style="border-top: 1px solid #444; padding-top: 15px; margin-top: 15px;">
              <div style="color: #fbbf24; font-weight: bold; margin-bottom: 10px;">אפשרויות סנכרון:</div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <label style="color: #e0e0e0; cursor: pointer;">
                  <input type="checkbox" id="syncActiveReminders" checked style="margin-left: 8px;">
                  תזכורות פעילות
                </label>
                <label style="color: #e0e0e0; cursor: pointer;">
                  <input type="checkbox" id="syncPendingReminders" checked style="margin-left: 8px;">
                  תזכורות ממתינות
                </label>
                <label style="color: #e0e0e0; cursor: pointer;">
                  <input type="checkbox" id="syncCompletedReminders" style="margin-left: 8px;">
                  תזכורות שהושלמו
                </label>
                <label style="color: #e0e0e0; cursor: pointer;">
                  <input type="checkbox" id="syncOverdueReminders" checked style="margin-left: 8px;">
                  תזכורות שפג תוקפן
                </label>
              </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="margin-top: 20px; text-align: center;">
              <button onclick="initializeCalendarSync()" 
                      style="padding: 12px 24px; background: #16a34a; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-left: 10px;">
                🔗 התחל סנכרון
              </button>
              <button onclick="testCalendarConnection()" 
                      style="padding: 12px 24px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                🧪 בדוק חיבור
              </button>
            </div>
          </div>
        </div>
        
        <!-- Status Display -->
        <div id="calendarSyncStatus" style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #444;">
          <div style="color: #fbbf24; font-weight: bold; margin-bottom: 10px;">מצב:</div>
          <div id="syncStatusText" style="color: #e0e0e0; font-size: 14px;">בחר ספק יומן כדי להתחיל</div>
        </div>
        
        <!-- Modal Controls -->
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button onclick="closeCalendarSyncModal()" 
                  style="padding: 12px 24px; background: #991b1b; color: white; border: none; border-radius: 8px; cursor: pointer;">
            ❌ סגור
          </button>
        </div>
      </div>
    </div>`;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
};

// Calendar Provider Selection
window.selectCalendarProvider = function(provider) {
  const providerInfo = document.getElementById('selectedProviderInfo');
  const providerName = document.getElementById('selectedProviderName');
  const instructions = document.getElementById('providerInstructions');
  const statusText = document.getElementById('syncStatusText');
  
  // Reset button styles
  document.getElementById('googleCalendarBtn').style.background = '#1a1a1a';
  document.getElementById('outlookCalendarBtn').style.background = '#1a1a1a';
  
  if (provider === 'google') {
    providerName.textContent = 'Google Calendar';
    instructions.innerHTML = `
      <strong>הוראות חיבור לגוגל קלנדר:</strong><br>
      1. המערכת תפתח חלון התחברות לגוגל<br>
      2. התחבר עם חשבון הגוגל שלך<br>
      3. אשר הרשאות גישה ליומן<br>
      4. התזכורות יסנכרנו אוטומטית<br><br>
      <em style="color: #f59e0b;">הערה: נדרשת הרשאת מנהל להפעלת הסנכרון</em>
    `;
    document.getElementById('googleCalendarBtn').style.background = '#2a4a2a';
    statusText.textContent = 'נבחר Google Calendar - מוכן לחיבור';
  } else if (provider === 'outlook') {
    providerName.textContent = 'Outlook Calendar';
    instructions.innerHTML = `
      <strong>הוראות חיבור לאאוטלוק:</strong><br>
      1. המערכת תפתח חלון התחברות למיקרוסופט<br>
      2. התחבר עם חשבון Microsoft 365 או Outlook.com<br>
      3. אשר הרשאות גישה ליומן<br>
      4. התזכורות יסנכרנו אוטומטית<br><br>
      <em style="color: #f59e0b;">הערה: נדרשת הרשאת מנהל להפעלת הסנכרון</em>
    `;
    document.getElementById('outlookCalendarBtn').style.background = '#2a2a4a';
    statusText.textContent = 'נבחר Outlook Calendar - מוכן לחיבור';
  }
  
  // Store selected provider
  window.selectedCalendarProvider = provider;
  
  // Show provider info
  providerInfo.style.display = 'block';
};

// Initialize Calendar Sync (Template - requires API integration)
window.initializeCalendarSync = function() {
  const provider = window.selectedCalendarProvider;
  const statusText = document.getElementById('syncStatusText');
  
  if (!provider) {
    alert('אנא בחר ספק יומן תחילה');
    return;
  }
  
  statusText.textContent = 'מתחיל סנכרון...';
  
  // Get sync options
  const syncOptions = {
    active: document.getElementById('syncActiveReminders').checked,
    pending: document.getElementById('syncPendingReminders').checked,
    completed: document.getElementById('syncCompletedReminders').checked,
    overdue: document.getElementById('syncOverdueReminders').checked
  };
  
  console.log(\`🔗 Initializing calendar sync with \${provider}\`, syncOptions);
  
  // Template implementation - in actual deployment this would:
  // 1. Open OAuth2 flow for selected provider
  // 2. Handle authentication callback
  // 3. Store access tokens securely
  // 4. Sync reminders based on selected options
  
  setTimeout(() => {
    statusText.innerHTML = \`
      <div style="color: #f59e0b;">⚠️ רכיב הסנכרון במצב פיתוח</div>
      <div style="font-size: 12px; margin-top: 5px;">
        נבחר: \${provider === 'google' ? 'Google Calendar' : 'Outlook Calendar'}<br>
        אפשרויות: \${Object.entries(syncOptions).filter(([k,v]) => v).map(([k]) => k).join(', ')}<br>
        <em>API יופעל על ידי המנהל</em>
      </div>
    \`;
    
    alert(\`✅ הגדרות סנכרון נשמרו עבור \${provider === 'google' ? 'Google Calendar' : 'Outlook Calendar'}!\nהמנהל יפעיל את ה-API בהתאם להעדפות שלך.\`);
  }, 1500);
};

// Test Calendar Connection (Template)
window.testCalendarConnection = function() {
  const provider = window.selectedCalendarProvider;
  const statusText = document.getElementById('syncStatusText');
  
  if (!provider) {
    alert('אנא בחר ספק יומן תחילה');
    return;
  }
  
  statusText.textContent = 'בודק חיבור...';
  
  console.log(\`🧪 Testing calendar connection for \${provider}\`);
  
  // Template implementation - would test actual API connection
  setTimeout(() => {
    statusText.innerHTML = \`
      <div style="color: #4ade80;">✅ בדיקת חיבור הצליחה</div>
      <div style="font-size: 12px; margin-top: 5px; color: #ccc;">
        ספק: \${provider === 'google' ? 'Google Calendar API' : 'Microsoft Graph API'}<br>
        סטטוס: מוכן לסנכרון (רק לאחר הפעלת API)
      </div>
    \`;
  }, 1000);
};

// Close Calendar Sync Modal
window.closeCalendarSyncModal = function() {
  const modal = document.getElementById('calendarSyncModal');
  if (modal) modal.remove();
  
  // Clear selection
  window.selectedCalendarProvider = null;
};

// Voice Reminder Functionality - STT Integration for Reminder Creation
window.startVoiceReminder = function() {
  console.log('🎤 Voice reminder button clicked');
  console.log('Browser support check:', {
    webkitSpeechRecognition: 'webkitSpeechRecognition' in window,
    SpeechRecognition: 'SpeechRecognition' in window,
    userAgent: navigator.userAgent
  });
  
  // Check if speech recognition is available
  if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
    console.error('❌ Speech recognition not supported in this browser');
    alert('זיהוי קול לא נתמך בדפדפן זה\nאנא השתמש בכרום או אדג\'');
    return;
  }
  
  console.log('✅ Speech recognition supported, showing modal...');
  
  // Show voice recording modal
  const modalHtml = `
    <div id="voiceReminderModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000;">
      <div style="background: #2a2a2a; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; border: 2px solid #7c3aed;">
        <div style="text-align: center; margin-bottom: 20px;">
          <h3 style="color: #7c3aed; margin: 0 0 10px 0;">🎤 יצירת תזכורת קולית</h3>
          <p style="color: #ccc; font-size: 14px; margin: 0;">דבר בעברית - המערכת תזהה תאריך, שעה ומספר רכב אוטומטית</p>
        </div>
        
        <!-- Recording Status -->
        <div id="voiceReminderStatus" style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #555; text-align: center;">
          <div id="recordingIndicator" style="color: #ff6b6b; font-size: 18px; margin-bottom: 10px;">🔴 לחץ על "התחל הקלטה" כדי להתחיל</div>
          <div id="speechText" style="color: #e0e0e0; font-size: 16px; min-height: 50px; font-style: italic;">המתן לטקסט המזוהה...</div>
        </div>
        
        <!-- Voice Controls -->
        <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
          <button id="startRecordingBtn" onclick="startRecordingVoiceReminder()" 
                  style="padding: 12px 24px; background: #7c3aed; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
            🎤 התחל הקלטה
          </button>
          <button id="stopRecordingBtn" onclick="stopRecordingVoiceReminder()" disabled
                  style="padding: 12px 24px; background: #dc2626; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; opacity: 0.5;">
            ⏹️ עצור
          </button>
        </div>
        
        <!-- Processed Results -->
        <div id="voiceReminderResults" style="display: none; background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #444;">
          <div style="color: #4ade80; font-weight: bold; margin-bottom: 10px;">📝 תוצאות זיהוי:</div>
          <div id="extractedData" style="color: #e0e0e0; font-size: 14px;"></div>
          <div style="margin-top: 15px;">
            <button onclick="confirmVoiceReminder()" 
                    style="padding: 10px 20px; background: #16a34a; color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px;">
              ✅ צור תזכורת
            </button>
            <button onclick="retryVoiceRecording()" 
                    style="padding: 10px 20px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer;">
              🔄 נסה שוב
            </button>
          </div>
        </div>
        
        <!-- Modal Controls -->
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button onclick="closeVoiceReminderModal()" 
                  style="padding: 12px 24px; background: #991b1b; color: white; border: none; border-radius: 8px; cursor: pointer;">
            ❌ ביטול
          </button>
        </div>
      </div>
    </div>`;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
};

// Voice Recording Control Functions
window.startRecordingVoiceReminder = function() {
  const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
  const recognition = new SpeechRecognition();
  
  // Configure recognition for Hebrew
  recognition.lang = 'he-IL';
  recognition.interimResults = true;
  recognition.maxAlternatives = 1;
  recognition.continuous = true;
  
  // Update UI for recording state
  const indicator = document.getElementById('recordingIndicator');
  const speechText = document.getElementById('speechText');
  const startBtn = document.getElementById('startRecordingBtn');
  const stopBtn = document.getElementById('stopRecordingBtn');
  
  if (indicator) indicator.textContent = '🔴 מקליט... דבר עכשיו';
  if (speechText) speechText.textContent = 'מקשיב...';
  if (startBtn) { startBtn.disabled = true; startBtn.style.opacity = '0.5'; }
  if (stopBtn) { stopBtn.disabled = false; stopBtn.style.opacity = '1'; }
  
  // Store recognition instance for stopping
  window.currentVoiceRecognition = recognition;
  
  // Handle speech results
  recognition.addEventListener('result', (event) => {
    let finalTranscript = '';
    let interimTranscript = '';
    
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const transcript = event.results[i][0].transcript;
      if (event.results[i].isFinal) {
        finalTranscript += transcript + ' ';
      } else {
        interimTranscript += transcript;
      }
    }
    
    // Update speech text display
    const displayText = finalTranscript + interimTranscript;
    if (speechText) {
      speechText.textContent = displayText || 'מקשיב...';
    }
    
    // Store the transcript
    window.voiceReminderTranscript = finalTranscript.trim();
  });
  
  // Handle recognition end
  recognition.addEventListener('end', () => {
    if (indicator) indicator.textContent = '✅ הקלטה הסתיימה';
    if (startBtn) { startBtn.disabled = false; startBtn.style.opacity = '1'; }
    if (stopBtn) { stopBtn.disabled = true; stopBtn.style.opacity = '0.5'; }
    
    // Process the recorded speech
    processVoiceReminderText();
  });
  
  // Handle errors
  recognition.addEventListener('error', (event) => {
    console.error('Voice recognition error:', event.error);
    if (indicator) indicator.textContent = '❌ שגיאה בזיהוי קול: ' + event.error;
    if (startBtn) { startBtn.disabled = false; startBtn.style.opacity = '1'; }
    if (stopBtn) { stopBtn.disabled = true; stopBtn.style.opacity = '0.5'; }
  });
  
  // Start recognition
  try {
    recognition.start();
    console.log('🎤 Voice recognition started for reminder creation');
  } catch (error) {
    console.error('Failed to start voice recognition:', error);
    if (indicator) indicator.textContent = '❌ נכשל להתחיל זיהוי קול';
  }
};

window.stopRecordingVoiceReminder = function() {
  if (window.currentVoiceRecognition) {
    window.currentVoiceRecognition.stop();
    window.currentVoiceRecognition = null;
  }
};

// Process voice text and extract reminder data
window.processVoiceReminderText = function() {
  const transcript = window.voiceReminderTranscript || '';
  
  if (!transcript) {
    document.getElementById('recordingIndicator').textContent = '❌ לא זוהה טקסט - נסה שוב';
    return;
  }
  
  console.log('🔍 Processing voice reminder text:', transcript);
  
  // Hebrew date/time extraction patterns
  const extractedData = {
    title: '',
    description: transcript,
    date: null,
    time: null,
    plate: null,
    category: 'general',
    priority: 'medium'
  };
  
  // Extract plate number patterns (Israeli format)
  const platePatterns = [
    /(\d{7,8})/g, // 7-8 digits
    /(\d{3}[-\s]?\d{2}[-\s]?\d{3})/g, // xxx-xx-xxx format
    /רכב\s*:?\s*(\d+)/gi, // "רכב: 123456"
    /מספר\s*:?\s*(\d+)/gi, // "מספר: 123456"
    /לוחית\s*:?\s*(\d+)/gi // "לוחית: 123456"
  ];
  
  for (const pattern of platePatterns) {
    const match = transcript.match(pattern);
    if (match) {
      extractedData.plate = match[0].replace(/[-\s]/g, '');
      break;
    }
  }
  
  // Extract Hebrew dates and times
  const today = new Date();
  
  // Date patterns
  const datePatterns = [
    { pattern: /היום/gi, offset: 0 },
    { pattern: /מחר/gi, offset: 1 },
    { pattern: /מחרתיים/gi, offset: 2 },
    { pattern: /השבוע הבא/gi, offset: 7 },
    { pattern: /בעוד שבוע/gi, offset: 7 },
    { pattern: /בעוד (\d+) ימים/gi, offset: 'dynamic' }
  ];
  
  for (const { pattern, offset } of datePatterns) {
    const match = transcript.match(pattern);
    if (match) {
      const targetDate = new Date(today);
      if (offset === 'dynamic') {
        const days = parseInt(match[1]);
        targetDate.setDate(today.getDate() + days);
      } else {
        targetDate.setDate(today.getDate() + offset);
      }
      extractedData.date = targetDate.toISOString().split('T')[0];
      break;
    }
  }
  
  // Time patterns
  const timePatterns = [
    /(\d{1,2}):(\d{2})/g, // HH:MM format
    /(\d{1,2}) ו(\d{2})/g, // Hebrew "X וY" format  
    /בשעה\s*(\d{1,2})/gi, // "בשעה X"
    /ב(\d{1,2})/gi // "בX" (at X o'clock)
  ];
  
  for (const pattern of timePatterns) {
    const match = transcript.match(pattern);
    if (match) {
      let hour = parseInt(match[1]);
      let minute = match[2] ? parseInt(match[2]) : 0;
      
      // Handle PM/AM context in Hebrew
      if (transcript.includes('אחה"צ') || transcript.includes('אחרי הצהריים') || transcript.includes('בערב')) {
        if (hour < 12) hour += 12;
      }
      
      extractedData.time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
      break;
    }
  }
  
  // Set default date/time if not found
  if (!extractedData.date) {
    extractedData.date = today.toISOString().split('T')[0];
  }
  if (!extractedData.time) {
    extractedData.time = '09:00';
  }
  
  // Generate title from description (first 50 chars)
  extractedData.title = transcript.substring(0, 50) + (transcript.length > 50 ? '...' : '');
  
  // Determine category based on keywords
  const categoryKeywords = {
    payment_reminder: ['תשלום', 'חיוב', 'כסף', 'חשבון'],
    case_deadline: ['תיק', 'סגירה', 'דדליין', 'מועד'],
    follow_up: ['מעקב', 'בדיקה', 'עדכון', 'טלפון'],
    inspection: ['בדיקה', 'ביקורת', 'אקספרטיזה']
  };
  
  for (const [category, keywords] of Object.entries(categoryKeywords)) {
    if (keywords.some(keyword => transcript.includes(keyword))) {
      extractedData.category = category;
      break;
    }
  }
  
  // Determine priority based on keywords
  if (transcript.includes('דחוף') || transcript.includes('חשוב') || transcript.includes('מיידי')) {
    extractedData.priority = 'high';
  } else if (transcript.includes('רגיל') || transcript.includes('נמוך')) {
    extractedData.priority = 'low';
  }
  
  // Store extracted data globally
  window.extractedVoiceReminderData = extractedData;
  
  // Display results
  displayVoiceReminderResults(extractedData);
};

// Display extracted data for user confirmation
window.displayVoiceReminderResults = function(data) {
  const resultsDiv = document.getElementById('voiceReminderResults');
  const extractedDataDiv = document.getElementById('extractedData');
  
  if (!resultsDiv || !extractedDataDiv) return;
  
  const categoryNames = {
    case_deadline: 'מועד סגירת תיק',
    payment_reminder: 'תזכורת תשלום', 
    follow_up: 'מעקב',
    inspection: 'בדיקה',
    general: 'כללי'
  };
  
  const priorityNames = {
    high: 'גבוהה',
    medium: 'בינונית',
    low: 'נמוכה'
  };
  
  extractedDataDiv.innerHTML = `
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
      <div><strong style="color: #fbbf24;">כותרת:</strong> ${data.title}</div>
      <div><strong style="color: #fbbf24;">תאריך:</strong> ${new Date(data.date).toLocaleDateString('he-IL')}</div>
      <div><strong style="color: #fbbf24;">שעה:</strong> ${data.time}</div>
      <div><strong style="color: #fbbf24;">קטגוריה:</strong> ${categoryNames[data.category]}</div>
      <div><strong style="color: #fbbf24;">עדיפות:</strong> ${priorityNames[data.priority]}</div>
      <div><strong style="color: #fbbf24;">רכב:</strong> ${data.plate || 'לא זוהה'}</div>
    </div>
    <div style="margin-top: 10px;"><strong style="color: #fbbf24;">תיאור מלא:</strong></div>
    <div style="background: #333; padding: 8px; border-radius: 4px; margin-top: 5px; font-style: italic;">${data.description}</div>
  `;
  
  resultsDiv.style.display = 'block';
};

// Confirm and create the voice reminder
window.confirmVoiceReminder = async function() {
  const data = window.extractedVoiceReminderData;
  if (!data) {
    alert('אין נתונים ליצירת תזכורת');
    return;
  }
  
  try {
    console.log('🔄 Starting voice reminder creation process...');
    console.log('Webhook ready:', window.webhookReady);
    console.log('sendToWebhook available:', typeof window.sendToWebhook);
    
    // Wait for webhook to be ready with better timing handling
    if (!window.webhookReady) {
      console.log('⏳ Webhook not ready, waiting for initialization...');
      // Wait a bit for webhook to initialize
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
    
    if (!window.webhookReady || typeof window.sendToWebhook !== 'function') {
      console.error('❌ Webhook system not available');
      console.log('Available functions:', Object.keys(window).filter(k => k.includes('webhook')));
      throw new Error('מערכת הקישור לשרת לא זמינה - נסה לרענן את הדף');
    }
    
    console.log('🔄 Creating voice reminder with data:', data);
    
    const reminderPayload = {
      action: 'create_reminder',
      title: data.title,
      description: data.description,
      due_date: data.date,
      due_time: data.time,
      category: data.category,
      priority: data.priority,
      plate: data.plate || '',
      status: 'active',
      created_via: 'voice_stt',
      created_at: new Date().toISOString(),
      voice_transcript: window.voiceReminderTranscript || ''
    };
    
    console.log('📤 Sending voice reminder payload:', reminderPayload);
    
    const response = await window.sendToWebhook('ADMIN_CREATE_REMINDER', reminderPayload);
    
    console.log('✅ Voice reminder created successfully:', response);
    
    // Close modal and show success
    closeVoiceReminderModal();
    alert('✅ תזכורת קולית נוצרה בהצלחה!');
    
    // Refresh reminders list if data is loaded
    if (window.remindersData && Array.isArray(window.remindersData)) {
      console.log('🔄 Refreshing reminders display...');
      renderReminders();
    } else {
      console.log('ℹ️ No reminders data loaded, skipping refresh');
    }
    
  } catch (error) {
    console.error('❌ Failed to create voice reminder:', error);
    console.error('Error details:', {
      message: error.message,
      stack: error.stack,
      webhookReady: window.webhookReady,
      sendToWebhookType: typeof window.sendToWebhook
    });
    alert(`❌ שגיאה ביצירת תזכורת: ${error.message}`);
  }
};

// Retry voice recording
window.retryVoiceRecording = function() {
  // Hide results and reset
  const resultsDiv = document.getElementById('voiceReminderResults');
  const speechText = document.getElementById('speechText');
  const indicator = document.getElementById('recordingIndicator');
  
  if (resultsDiv) resultsDiv.style.display = 'none';
  if (speechText) speechText.textContent = 'המתן לטקסט המזוהה...';
  if (indicator) indicator.textContent = '🔴 לחץ על "התחל הקלטה" כדי להתחיל';
  
  // Clear stored data
  window.voiceReminderTranscript = '';
  window.extractedVoiceReminderData = null;
};

// Close voice reminder modal
window.closeVoiceReminderModal = function() {
  // Stop any ongoing recording
  if (window.currentVoiceRecognition) {
    window.currentVoiceRecognition.stop();
    window.currentVoiceRecognition = null;
  }
  
  // Remove modal
  const modal = document.getElementById('voiceReminderModal');
  if (modal) modal.remove();
  
  // Clear stored data
  window.voiceReminderTranscript = '';
  window.extractedVoiceReminderData = null;
};
</script>

  </div>
</body>
</html>
