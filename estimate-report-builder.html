<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <style>
    /* Modern Professional PDF Styling */
    @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&display=swap');
    
    @page { 
      size: A4; 
      margin: 0; 
    }
    
    body{ 
      margin: 0; 
      direction: rtl; 
      -webkit-print-color-adjust: exact; 
      print-color-adjust: exact;
      font-family: 'Heebo', 'Segoe UI', Tahoma, Arial, sans-serif;
      font-weight: 400;
      line-height: 1.6;
      color: #2c3e50;
      background: white;
    }
    
    .bg{ position:fixed; inset:0; width:100%; height:100%; object-fit:cover; z-index:0; pointer-events:none }
    .page{ position:relative; z-index:1; padding:25mm 15mm 20mm 15mm; }
  </style>
  <style>
    body {
      font-family: 'Heebo', 'Segoe UI', Tahoma, Arial, sans-serif;
      direction: rtl;
      margin: 0;
      padding: 0;
      font-weight: 400;
    }
    
    h1, h2, h3 {
      color: #1e3a8a;
      font-family: 'Heebo', 'Segoe UI', Tahoma, Arial, sans-serif;
      font-weight: 600;
    }
    
    h1 {
      font-size: 28px;
      font-weight: 700;
      text-align: center;
      margin: 20px 0 25px 0;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      letter-spacing: -0.5px;
    }
    
    h2 {
      font-size: 20px;
      font-weight: 600;
      margin: 25px 0 15px 0;
      border-right: 4px solid #3b82f6;
      padding-right: 12px;
    }
    
    table {
      width: 100%;
      max-width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      border: none;
      table-layout: fixed;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      font-family: 'Heebo', 'Segoe UI', Tahoma, Arial, sans-serif;
    }
    
    table + table {
      margin-top: 20px;
    }
    
    th, td {
      padding: 16px 12px;
      text-align: right;
      border: none;
      word-wrap: break-word;
      overflow-wrap: break-word;
      font-size: 14px;
      line-height: 1.4;
    }
    
    th {
      color: #1e3a8a !important;
      background: #fff8e1 !important;
      border-bottom: 3px solid #003366 !important;
      text-align: center !important;
    }
    
    td {
      background: white;
      border-bottom: 1px solid #f1f5f9;
      transition: background-color 0.2s ease;
    }
    
    tr:nth-child(even) td {
      background: #f8fafc;
    }
    
    tr:hover td {
      background: #e0f2fe;
    }
    .section {
      margin-bottom: 20px;
      page-break-inside: avoid;
    }
    .section:not(:first-child) {
      margin-top: 15px;
    }
    .signature-stamp {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 40px;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      border: 1px solid #e2e8f0;
    }
    .signature-stamp img {
      height: 120px;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
    }
    .signature-stamp .center-text {
      flex-grow: 1;
      text-align: center;
      font-size: 20px;
      font-weight: 700;
      color: #1e3a8a;
      font-family: 'Heebo', 'Segoe UI', Tahoma, Arial, sans-serif;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .car-details {
      background: white;
      border: 2px solid #3b82f6;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.1);
      transition: all 0.3s ease;
    }
    .car-details-title {
      color: #1e3a8a;
      font-weight: 700;
      font-size: 22px;
      text-align: center;
      margin-bottom: 20px;
      font-family: 'Heebo', 'Segoe UI', Tahoma, Arial, sans-serif;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      letter-spacing: -0.3px;
    }
    .car-details-table {
      width: 100%;
      border: none;
      font-size: 16px;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .car-details-table td {
      padding: 12px 16px;
      border-bottom: 1px solid #f1f5f9;
      font-weight: 500;
      text-align: center;
    }
    .car-details-table th {
      padding: 12px 16px;
      text-align: center;
      font-weight: bold;
    }
    /* Override centering for vehicle details table */
    .car-details-table.vehicle-details td {
      text-align: right;
    }
    .car-details-table tr:nth-child(even) td {
      background: #f8fafc;
    }
    .car-details-table tr:hover td {
      background: #e0f2fe;
    }
    .intellectual-box {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 20px;
      font-size: 16px;
      font-weight: 600;
      margin: 20px 0;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15);
      font-family: 'Heebo', 'Segoe UI', Tahoma, Arial, sans-serif;
      color: #1e3a8a;
    }
    .buttons {
      text-align: center;
      margin-top: 40px;
    }
    
    /* Text boxes for all non-table content */
    .text-box {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .credentials-box {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15);
    }
    
    /* Override styles.css */
    .page body {
      padding: 0 !important;
      margin: 0 !important;
    }
    
    .page table {
      border-collapse: collapse !important;
      background: white !important;
      border-radius: 12px !important;
      overflow: hidden !important;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08) !important;
    }
    
    .page th {
      background: #fff8e1 !important;
      color: #1e3a8a !important;
      border: none !important;
    }
    
    .page td {
      border: none !important;
      border-bottom: 1px solid #f1f5f9 !important;
    }
    
    @media print {
      body {
        padding: 0 !important;
        margin: 0 !important;
      }
      
      .page {
        padding: 25mm 15mm 20mm 15mm !important;
      }
      
      html, body {
        margin: 0 !important;
        padding: 0 !important;
        width: 210mm !important;
        font-size: 11px !important;
        line-height: 1.3 !important;
      }
      
      .bg {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 210mm !important;
        height: 297mm !important;
        z-index: 0 !important;
      }
      
      .page {
        width: 210mm !important;
        padding: 20mm 12mm 15mm 12mm !important;
        margin: 0 !important;
        box-sizing: border-box !important;
        position: relative !important;
        z-index: 1 !important;
      }
      
      /* Proper page breaks */
      .section {
        page-break-inside: avoid !important;
        margin-bottom: 6mm !important;
      }
      
      table {
        page-break-inside: avoid !important;
        margin-bottom: 4mm !important;
        font-size: 10px !important;
      }
      
      th, td {
        padding: 3mm !important;
        font-size: 9px !important;
      }
      
      .text-box,
      .credentials-box,
      .estimate-disclaimer {
        page-break-inside: avoid !important;
        margin-bottom: 4mm !important;
      }
      
      h1, h2, h3 {
        page-break-after: avoid !important;
        margin-bottom: 3mm !important;
        font-size: 14px !important;
      }
      
      .buttons,
      .control-buttons {
        display: none !important;
      }
      
      .text-box,
      .credentials-box {
        page-break-inside: avoid;
        background: rgba(255, 255, 255, 0.98) !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
    }
    .buttons button {
      padding: 10px 20px;
      margin: 0 10px;
      font-size: 16px;
      cursor: pointer;
    }
    .estimate-header {
      background: linear-gradient(135deg, #1e3a8a 0%, #475569 100%);
      color: white !important;
      padding: 30px;
      text-align: center;
      margin-bottom: 30px;
      border-radius: 15px;
    }
    .estimate-header h1, .estimate-header h2, .estimate-header h3 {
      color: white !important;
      margin: 10px 0;
    }
    .estimate-disclaimer {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      font-weight: bold;
      text-align: center;
    }
    .estimate-totals {
      background: #e8f5e8;
      border: 2px solid #28a745;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
    }
    .control-buttons {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin: 30px 0;
    }
    .control-buttons button {
      margin: 0 10px;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
    }
    .btn-primary {
      background: #007bff;
      color: white;
    }
    .btn-success {
      background: #28a745;
      color: white;
    }
    .btn-info {
      background: #17a2b8;
      color: white;
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    .btn-primary:hover {
      background: #0056b3;
    }
    .btn-success:hover {
      background: #218838;
    }
    .btn-info:hover {
      background: #138496;
    }
    .btn-secondary:hover {
      background: #545b62;
    }
    
    /* Print Styles for A4 Format */
    @media print {
      @page {
        size: A4;
        margin: 25mm 20mm 25mm 20mm;
      }
      
      body {
        font-family: sans-serif;
        font-size: 12pt;
        line-height: 1.4;
        color: #000;
        background: white;
        margin: 0;
        padding: 0;
      }
      
      /* Hide control elements */
      .no-print,
      .control-buttons,
      .estimate-header,
      .estimate-disclaimer {
        display: none !important;
      }
      
      /* Optimize tables for print */
      table {
        width: 100% !important;
        max-width: 180mm !important; /* A4 width minus margins */
        border-collapse: collapse !important;
        page-break-inside: avoid;
        font-size: 10pt;
        table-layout: fixed !important;
        margin: 0 auto !important;
      }
      
      th, td {
        padding: 4px 6px !important;
        border: 1px solid #000 !important;
        font-size: 10pt;
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-width: 0; /* Forces text wrapping */
      }
      
      th {
        background: #f0f0f0 !important;
        font-weight: bold;
        text-align: center !important;
      }
      
      /* Section formatting */
      .section {
        page-break-inside: avoid;
        margin-bottom: 15mm;
      }
      
      .car-details {
        border: 1px solid #000;
        border-radius: 0;
        padding: 8mm;
        margin-bottom: 10mm;
        page-break-inside: avoid;
      }
      
      .car-details-title {
        font-size: 14pt;
        font-weight: bold;
        margin-bottom: 6mm;
        text-align: center;
      }
      
      /* Signature section */
      .signature-stamp {
        page-break-inside: avoid;
        margin-top: 20mm;
      }
      
      .signature-stamp img {
        max-height: 40mm;
        max-width: 60mm;
      }
      
      /* Ensure no orphaned content */
      h1, h2, h3 {
        page-break-after: avoid;
        font-size: 14pt;
        margin: 8mm 0 4mm 0;
      }
      
      p {
        orphans: 2;
        widows: 2;
        font-size: 11pt;
      }
      
      /* Optimize assessor credentials and car details for A4 */
      .car-details {
        margin-bottom: 4mm;
        page-break-inside: avoid;
      }
      
      .car-details-table td {
        padding: 1.5mm !important;
        font-size: 10pt;
        text-align: center !important;
      }
      
      /* Override centering for vehicle details table in print */
      .car-details-table.vehicle-details td {
        text-align: right !important;
      }
      
      .intellectual-box {
        font-size: 10pt !important;
        line-height: 1.1 !important;
        padding: 4mm !important;
        margin: 3mm 0 !important;
        page-break-inside: avoid;
      }
      
      .car-details-title {
        font-size: 12pt !important;
        margin-bottom: 3mm !important;
      }
      
      /* Compact header section */
      .report-header {
        margin-bottom: 4mm !important;
      }
      
      .report-header table {
        margin-top: 3mm !important;
      }
      
      .report-header td {
        padding: 2.5mm !important;
        font-size: 10pt !important;
      }
      
      /* Reduce spacing in depreciation and legal sections */
      .section {
        margin-bottom: 3mm !important;
      }
      
      .section p {
        font-size: 10pt !important;
        line-height: 1.2 !important;
        margin: 2mm 0 !important;
      }
      
      /* Optimize estimate totals table to fit on same page */
      .estimate-totals {
        page-break-inside: auto !important;
        margin-top: 2mm !important;
      }
      
      .estimate-totals .car-details-title {
        font-size: 11pt !important;
        margin-bottom: 2mm !important;
      }
      
      /* Dynamic Page Layout System */
      
      /* Page 1: Car details + Credentials */
      .page-car-details {
        page-break-after: always !important;
      }
      
      /* Page 2+: Damage analysis with dynamic breaks */
      .page-damage-intro {
        page-break-before: always !important;
        page-break-after: avoid !important;
      }
      
      .damage-center-container {
        page-break-inside: avoid !important;
        margin-bottom: 4mm !important;
        page-break-before: avoid !important;
      }
      
      .damage-center-container:nth-child(n+3) {
        page-break-before: avoid !important;
      }
      
      /* Group all damage centers together */
      .damage-centers-group {
        page-break-inside: auto !important;
        page-break-before: always !important;
        page-break-after: avoid !important;
      }
      
      .damage-centers-group .page-damage-intro {
        page-break-before: avoid !important;
        page-break-after: avoid !important;
      }
      
      /* Dedicated pages for specific sections */
      .page-price-adjustments {
        page-break-before: always !important;
        page-break-after: avoid !important;
      }
      
      .adjustment-group {
        page-break-inside: avoid !important;
        margin-bottom: 8mm !important;
      }
      
      .adjustment-group:last-child {
        page-break-after: always !important;
      }
      
      .depreciation-group {
        page-break-inside: avoid !important;
        margin-bottom: 8mm !important;
      }
      
      .page-depreciation {
        page-break-before: always !important;
        page-break-after: avoid !important;
      }
      
      /* Final page: Legal + Signature */
      .page-legal-final {
        page-break-before: always !important;
      }
      
      /* Optimize damage centers spacing for A4 */
      .car-details {
        margin-bottom: 4mm !important;
        box-decoration-break: clone !important;
        -webkit-box-decoration-break: clone !important;
        border-image-slice: 1 !important;
      }
      
      /* Auto-restore borders when containers stretch across pages */
      .car-details {
        border: 2px solid #000 !important;
        border-radius: 25px !important;
        padding: 15px !important;
        page-break-inside: auto !important;
        orphans: 2 !important;
        widows: 2 !important;
      }
      
      /* Enhanced border restoration for page breaks */
      @page {
        margin: 20mm;
      }
      
      /* Ensure borders are maintained when content spans pages */
      .car-details-page-break {
        border-top: 2px solid #000 !important;
        border-left: 2px solid #000 !important;
        border-right: 2px solid #000 !important;
        border-bottom: none !important;
        border-radius: 25px 25px 0 0 !important;
        margin-bottom: 0 !important;
        padding-bottom: 10px !important;
      }
      
      .car-details-page-continue {
        border-top: none !important;
        border-left: 2px solid #000 !important;
        border-right: 2px solid #000 !important;
        border-bottom: 2px solid #000 !important;
        border-radius: 0 0 25px 25px !important;
        margin-top: 0 !important;
        padding-top: 10px !important;
      }
      
      /* Enhanced border restoration for spanning containers */
      .car-details-spanning {
        box-decoration-break: clone !important;
        -webkit-box-decoration-break: clone !important;
        border: 2px solid #000 !important;
        border-radius: 25px !important;
        padding: 15px !important;
        margin-bottom: 4mm !important;
      }
      
      .car-details-title {
        margin-bottom: 3mm !important;
        font-size: 12pt !important;
      }
      
      .car-details-table td {
        padding: 1.5mm !important;
        font-size: 10pt;
        text-align: center !important;
      }
      
      /* Override centering for vehicle details table in print */
      .car-details-table.vehicle-details td {
        text-align: right !important;
      }
      
      /* Optimize legal text, attachments, and signature for A4 */
      .section:last-of-type {
        margin-bottom: 2mm !important;
      }
      
      .section:last-of-type > div {
        padding: 8mm !important;
        font-size: 9pt !important;
        line-height: 1.1 !important;
      }
      
      .section:last-of-type p {
        margin: 0 0 3mm 0 !important;
        font-size: 9pt !important;
      }
      
      .section:last-of-type .estimate-disclaimer {
        padding: 4mm !important;
        margin-top: 4mm !important;
      }
      
      .section:last-of-type .estimate-disclaimer p {
        font-size: 9pt !important;
        line-height: 1.2 !important;
      }
      
      .signature-stamp {
        margin-top: 6mm !important;
        page-break-inside: avoid !important;
      }
      
      .signature-stamp img {
        max-height: 45mm !important;
        max-width: 90mm !important;
      }
      
      .signature-stamp + div {
        margin-top: 3mm !important;
      }
      
      .signature-stamp + div + div {
        margin-top: 2mm !important;
      }
      
      /* Hide print button and navigation */
      button {
        display: none !important;
      }
      
      /* Ensure content fits within margins */
      .report-content {
        max-width: 100%;
        overflow: hidden;
      }
      
      .estimate-totals {
        background: #f5f5f5 !important;
        border: 1px solid #000 !important;
        padding: 6mm;
        margin: 8mm 0;
      }
      
      .intellectual-box {
        border: 1px solid #000;
        padding: 6mm;
        margin: 8mm 0;
      }
      
      /* Professional header spacing */
      .report-header {
        margin-bottom: 8mm;
        padding: 4mm;
      }
      
      /* Ensure consistent spacing between sections */
      .car-details + .car-details {
        margin-top: 6mm;
      }
      
      /* Professional table spacing */
      .car-details-table {
        margin-bottom: 4mm;
      }
      
      /* Signature area proper spacing */
      .signature-stamp {
        margin-top: 15mm;
        margin-bottom: 10mm;
      }
      
      /* Fix text alignment for professional appearance */
      .center-text {
        text-align: center;
        font-size: 12pt;
        margin: 6mm 0;
      }
      
      /* Ensure proper page breaks */
      .estimate-totals {
        page-break-inside: avoid;
      }
      
      /* Better spacing for legal text */
      .legal-text {
        margin: 8mm 0;
        line-height: 1.6;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.min.js"></script>
  <script src="./math-preview.js"></script>
</head>
<body>
  <img class="bg" src="https://assets.carmelcayouf.com/assets/bg-report.png" alt="">
  <div class="page">
  <div class="estimate-header">
    <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo" style="width: 80px; margin-bottom: 15px;">
    <h1>×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×¤×•×¨×˜×œ</h1>
    <h2>×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</h2>
    <h3>×‘×•× ×” ×“×•"×— ××•××“×Ÿ</h3>
  </div>

  <div class="estimate-disclaimer">
    <h3>×”×•×“×¢×” ×—×©×•×‘×” - ××•××“×Ÿ ×‘×œ×‘×“</h3>
    <p>××¡××š ×–×” ×”×™× ×• ××•××“×Ÿ ×¨××©×•× ×™ ×‘×œ×‘×“ ×•××™× ×• ××”×•×•×” ×”×ª×—×™×™×‘×•×ª ×›×¡×¤×™×ª ××• ×—×•×–×™×ª ××›×œ ×¡×•×’ ×©×”×•×.</p>
    <p>×”×¢×¨×›×™× ×”×¡×•×¤×™×™× ×¢×©×•×™×™× ×œ×”×©×ª× ×•×ª ×‘×”×ª×× ×œ×ª×•×¦××•×ª ×”×‘×™×¦×•×¢ ×‘×¤×•×¢×œ ×•×œ×—×©×‘×•× ×™×•×ª ×”×¡×•×¤×™×•×ª.</p>
  </div>

  <!-- Buttons moved to end -->

  <div id="estimate-output" class="report-content">
    <!-- Report will be populated here by JavaScript -->
  </div>

  <script type="module">
    import { helper, updateHelper } from './helper.js';
    import { MathEngine } from './math.js';
    import { sendToWebhook } from './webhook.js';
    import { getVehicleData, getDamageData } from './helper.js';
    import { vaultLoader } from './vault-loader.js';

    // Authentication and data validation
    document.addEventListener('DOMContentLoaded', () => {
      console.log('ğŸ”„ Estimate Report Builder: Initializing...');
      
      const auth = sessionStorage.getItem("auth");
      if (!auth) {
        console.error('âŒ No authentication found');
        alert("×”×’×™×©×” ×—×¡×•××” - ×× × ×”×ª×—×‘×¨ ×“×¨×š ×“×£ ×”×‘×™×ª");
        window.location.href = "index.html";
        return;
      }

      const helperData = sessionStorage.getItem('helper');
      const selectedReportType = sessionStorage.getItem('selectedReportType');
      const validationCompleted = sessionStorage.getItem('estimateValidationCompleted');
      
      // Check if we should skip validation (coming from expertise or final-report-builder) FIRST
      const urlParams = new URLSearchParams(window.location.search);
      const skipValidation = urlParams.get('skipValidation') === 'true';
      const fromExpertise = urlParams.get('from') === 'expertise';
      const fromFinalReportBuilder = urlParams.get('fromFinalReportBuilder') === 'true' || sessionStorage.getItem('fromFinalReportBuilder') === 'true';
      
      // Validation removed - allow direct access to estimate report builder
      if (!helperData) {
        console.warn('âš ï¸ No helper data found, will proceed with empty data');
        helperData = {};
      }
      
      if (skipValidation || fromExpertise || fromFinalReportBuilder) {
        console.log('âœ… Validation skipped - accessed from expertise report or final report builder');
      }

      console.log('âœ… Estimate Report Builder: All validations passed');
      
      // Initialize vault loader
      vaultLoader.init().then(() => {
        console.log('âœ… Vault loader initialized');
        initializeEstimateBuilder();
      });
    });

    function initializeEstimateBuilder() {
      loadEstimateData();
      injectEstimateHTML();
    }

    function loadEstimateData() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Ensure basic structure exists
      helper.meta = helper.meta || {};
      helper.vehicle = helper.vehicle || helper.car_details || {};
      helper.calculations = helper.calculations || {};
      helper.damage_sections = helper.damage_sections || [];
      helper.expertise = helper.expertise || {};
      
      // Ensure estimate structure exists first
      helper.estimate = helper.estimate || {};
      
      // Ensure estimate damage centers structure exists
      if (!helper.estimate.damage_centers) {
        helper.estimate.damage_centers = helper.damage_sections || [];
      }
      
      // Ensure estimate depreciation structure exists
      if (!helper.estimate.depreciation) {
        helper.estimate.depreciation = helper.depreciation || {};
      }
      helper.depreciation = helper.depreciation || {};
      
      // Ensure meta fields have defaults
      helper.meta.client_name = helper.meta.client_name || helper.meta.owner || '';
      helper.meta.plate = helper.meta.plate || '';
      helper.meta.inspection_date = helper.meta.inspection_date || new Date().toLocaleDateString('he-IL');
      helper.meta.location = helper.meta.location || '';
      helper.meta.damage = helper.meta.damage || '';
      // Ensure estimate contact structure exists
      if (!helper.estimate.contact) {
        helper.estimate.contact = {
          name: helper.meta.client_name || helper.client?.name || '',
          address: helper.meta.address || helper.client?.address || '',
          phone_number: helper.meta.phone_number || helper.client?.phone_number || ''
        };
      }
      
      // Ensure damage_info structure exists
      if (!helper.damage_info) {
        helper.damage_info = {
          damage_type: helper.meta.damage || helper.car_details?.damageType || helper.meta.damage_type || '',
          event_date: helper.case_info?.damage_date || helper.meta.damage_date || helper.meta.event_date || ''
        };
      }
      
      // Ensure case_info structure exists
      if (!helper.case_info) {
        helper.case_info = {
          damage_date: helper.meta.damage_date || helper.meta.event_date || ''
        };
      }
      
      helper.meta.address = helper.meta.address || '';
      helper.meta.phone_number = helper.meta.phone_number || '';
      
      // Ensure vehicle fields have defaults
      helper.vehicle.manufacturer = helper.vehicle.manufacturer || '';
      helper.vehicle.model = helper.vehicle.model || '';
      helper.vehicle.year = helper.vehicle.year || '';
      helper.vehicle.chassis = helper.vehicle.chassis || helper.vehicle.vin || '';
      helper.vehicle.km = helper.vehicle.km || '';
      helper.vehicle.ownership_type = helper.vehicle.ownership_type || '';
      
      // Ensure helper template fields have defaults
      // Create dynamic title: "estimate [type] for car no. [plate]"
      const estimateType = helper.estimate_data?.type || '××•×‘×“×Ÿ_×œ×”×œ×›×”';
      const plateNumber = helper.plate || helper.meta?.plate || 'XXXXX';
      helper.report_title = `××•××“×Ÿ ${estimateType} ×œ×¨×›×‘ ××¡×¤×¨  ${plateNumber}`;
      helper.file_number = helper.file_number || `YC-${(helper.meta.plate || 'XXXXX').replace(/[-\/]/g, '')}-${new Date().getFullYear()}`;
      helper.business_license = helper.business_license || '02921217';
      helper.estimate_details_title = helper.estimate_details_title || '×¤×¨×˜×™ ×”×¨×›×‘ ×”× ×‘×“×§';
      
      // Ensure estimate calculations are up to date
      if (!helper.estimate?.totals?.damage_centers?.total_with_vat?.value || 
          !helper.estimate?.calculations?.total_damage_cost) {
        calculateEstimateTotals(helper);
      }
      
      // Update session storage with processed data using proper function
      if (typeof updateHelper === 'function') {
        updateHelper('meta', helper.meta, 'estimate_report_builder_init');
        updateHelper('vehicle', helper.vehicle, 'estimate_report_builder_init');
        updateHelper('calculations', helper.calculations, 'estimate_report_builder_init');
        updateHelper('damage_sections', helper.damage_sections, 'estimate_report_builder_init');
        updateHelper('expertise', helper.expertise, 'estimate_report_builder_init');
        updateHelper('depreciation', helper.depreciation, 'estimate_report_builder_init');
        updateHelper('report_title', helper.report_title, 'estimate_report_builder_init');
        updateHelper('file_number', helper.file_number, 'estimate_report_builder_init');
        updateHelper('business_license', helper.business_license, 'estimate_report_builder_init');
        updateHelper('estimate_details_title', helper.estimate_details_title, 'estimate_report_builder_init');
      } else {
        // Fallback for compatibility
        sessionStorage.setItem('helper', JSON.stringify(helper));
      }
      
      console.log('âœ… Estimate data loaded and processed:', helper);
    }

    function calculateEstimateTotals(helper) {
      // Get base damage from multiple sources, prioritizing estimate structure
      const baseDamage = helper.estimate?.calculations?.total_damage_cost || 
                        helper.estimate?.totals?.damage_centers?.total_before_vat?.value ||
                        helper.calculations?.base_damage ||
                        helper.calculations?.total_damage ||
                        helper.calculations?.total_before_depreciation ||
                        helper.levi_report?.total_damage ||
                        helper.damage_calculation?.total ||
                        0;

      // Get VAT rate from multiple sources, prioritizing estimate structure
      const vatRate = helper.estimate?.summary?.vat_rate?.current || 
                     helper.estimate?.totals?.damage_centers?.vat_rate ||
                     helper.calculations?.vat_rate ||
                     parseFloat(sessionStorage.getItem('globalVAT')) ||
                     18;
      const vatAmount = helper.estimate?.totals?.damage_centers?.vat_amount || 
                       Math.round(baseDamage * vatRate / 100);
      const totalEstimate = helper.estimate?.totals?.damage_centers?.total_with_vat?.value || 
                           (baseDamage + vatAmount);

      // Store calculations in estimate structure
      if (!helper.estimate.calculations) helper.estimate.calculations = {};
      helper.estimate.calculations.total_damage_cost = baseDamage;
      
      // Update helper with calculations (maintain backward compatibility)
      helper.calculations = helper.calculations || {};
      helper.calculations.base_damage = baseDamage;
      // Store VAT rate in estimate structure
      if (!helper.estimate.summary) helper.estimate.summary = {};
      if (!helper.estimate.summary.vat_rate) helper.estimate.summary.vat_rate = {};
      helper.estimate.summary.vat_rate.current = vatRate;
      helper.calculations.vat_amount = vatAmount;
      helper.calculations.total_estimate = totalEstimate;
      // Store total estimate in estimate structure
      if (!helper.estimate.totals) helper.estimate.totals = {};
      if (!helper.estimate.totals.damage_centers) helper.estimate.totals.damage_centers = {};
      helper.estimate.totals.damage_centers.total_with_vat = { value: totalEstimate };
      helper.estimate.totals.damage_centers.total_before_vat = { value: baseDamage };
      helper.estimate.totals.damage_centers.vat_amount = vatAmount;
      
      // Calculate depreciation values
      calculateDepreciationValues(helper);
    }

    function calculateDepreciationValues(helper) {
      // Get market value from helper
      const marketValue = helper.calculations?.market_value || 
                         helper.vehicle_value_base || 
                         helper.levi?.market_value || 0;

      // Calculate depreciation values for each center
      if (helper.expertise?.depreciation?.centers) {
        helper.expertise.depreciation.centers.forEach(center => {
          const percent = parseFloat(center.percent) || 0;
          center.depreciation_value = Math.round(marketValue * percent / 100);
        });
      }

      // Calculate values for estimate depreciation bulk items
      if (helper.estimate_depreciation?.bulk_items) {
        helper.estimate_depreciation.bulk_items.forEach(item => {
          const percent = parseFloat(item.percent) || 0;
          item.value = Math.round(marketValue * percent / 100);
        });
      }

      // Calculate global depreciation using estimate structure
      const depreciationData = helper.estimate.depreciation || helper.depreciation || {};
      if (depreciationData.global_percent) {
        const globalPercent = parseFloat(depreciationData.global_percent) || 0;
        const globalAmount = Math.round(marketValue * globalPercent / 100);
        
        // Store in estimate structure
        helper.estimate.depreciation.global_percent = globalPercent;
        helper.estimate.depreciation.global_amount = globalAmount;
        
        // Maintain backward compatibility
        if (helper.depreciation) {
          helper.depreciation.global_amount = globalAmount;
        }
      }
      
      // Calculate global estimate depreciation
      if (helper.estimate_depreciation) {
        const globalPercent = parseFloat(helper.estimate_depreciation.global_percent) || 0;
        helper.estimate_depreciation.global_value = Math.round(marketValue * globalPercent / 100);
      }
    }

    function injectEstimateHTML() {
      const container = document.getElementById("estimate-output");
      if (!container) return;

      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      if (!helper || !helper.meta) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #dc2626;">
            <h3>×©×’×™××”: × ×ª×•× ×™ ×”×ª×™×§ ×œ× × ××¦××•</h3>
            <p>×× × ×—×–×•×¨ ×œ×“×£ ×”×‘×—×™×¨×” ×•×˜×¢×Ÿ ××ª ×”×ª×™×§ ××—×“×©</p>
            <button onclick="window.location.href='selection.html'" class="btn-secondary">×—×–×•×¨ ×œ×“×£ ×”×‘×™×ª</button>
          </div>
        `;
        return;
      }

      try {
        // Get data from helper with proper mapping
        const clientName = helper.estimate?.contact?.name || helper.client?.name || helper.car_details?.owner || helper.meta?.client_name || '';
        const clientAddress = helper.estimate?.contact?.address || helper.client?.address || helper.car_details?.ownerAddress || helper.meta?.address || '';
        const clientPhone = helper.estimate?.contact?.phone_number || helper.client?.phone_number || helper.car_details?.ownerPhone || helper.meta?.phone_number || '';
        const plate = helper.meta?.plate || helper.car_details?.plate || helper.vehicle?.plate_number || '';
        const inspectionDate = helper.meta?.inspection_date || new Date().toLocaleDateString('he-IL');
        const location = helper.meta?.location || helper.meta?.inspection_location || helper.car_details?.location || '';
        const damageType = helper.damage_info?.damage_type || 
                          helper.meta?.damage || 
                          helper.car_details?.damageType || 
                          helper.meta?.damage_type || 
                          '×œ× ×¦×•×™×Ÿ';
        
        // Additional fields - Event Date and Vehicle Value
        const eventDate = helper.case_info?.damage_date || helper.meta?.damage_date || helper.damage_info?.event_date || helper.meta?.event_date || '';
        const vehicleValue = helper.levi_report?.final_price || helper.calculations?.market_value || helper.estimate?.vehicle?.marketValue || '';
        
        
        // Vehicle data - try multiple sources
        const vehicle = helper.vehicle || helper.car_details || {};
        const manufacturer = vehicle.manufacturer || vehicle.make || helper.meta?.manufacturer || '';
        const model = vehicle.model || helper.meta?.model || '';
        const modelCode = vehicle.model_code || helper.levi_report?.model_code || helper.meta?.model_code || '';
        const year = vehicle.year || vehicle.manufacture_year || helper.meta?.year || '';
        const chassis = vehicle.chassis || vehicle.vin || vehicle.frame_number || helper.meta?.chassis || '';
        const km = vehicle.km || vehicle.odo || vehicle.odometer || vehicle.mileage || helper.meta?.km || '';
        const ownershipType = vehicle.ownership_type || vehicle.type || vehicle.category || helper.meta?.ownership_type || '';
        
        // Enhanced mileage display with breakdown
        const baseMileage = helper.levi_report?.adjustments?.find(adj => adj.subject === '×§"×')?.value || '';
        const mileageAdjustment = helper.levi_report?.adjustments?.find(adj => adj.subject === '×§"×')?.adjusted_value || '';
        const totalMileage = km || baseMileage || '';
        const mileageDisplay = baseMileage && mileageAdjustment ? 
          `×§"× ${totalMileage} (×§"× + ${Math.abs(mileageAdjustment)}) (×˜×•×Ÿ ×§"×: ${((Math.abs(mileageAdjustment) / baseMileage) * 100).toFixed(1)})` : 
          `×§"× ${totalMileage}`;
        
        // Calculations - Use helper.estimate structure
        const baseDamage = helper.estimate?.calculations?.total_damage_cost || 
                          helper.estimate?.totals?.damage_centers?.total_before_vat?.value || 0;
        const vatRate = helper.estimate?.summary?.vat_rate?.current || 
                       helper.estimate?.totals?.damage_centers?.vat_rate || 18;
        const vatAmount = helper.estimate?.totals?.damage_centers?.vat_amount || 
                         Math.round(baseDamage * vatRate / 100);
        const totalEstimate = helper.estimate?.totals?.damage_centers?.total_with_vat?.value || 
                             helper.estimate?.summary?.sum_claim || (baseDamage + vatAmount);
        const marketValue = helper.estimate?.calculations?.full_market_value || 
                           helper.estimate?.vehicle?.marketValue?.replace(/[â‚ª,\s]/g, '') || 0;
        const damagePercent = helper.estimate?.calculations?.gross_damage_percentage || 
                             (marketValue > 0 ? Math.round((baseDamage / marketValue) * 100) : 0);
        
        // Damage description - check multiple sources
        let damageDescription = '';
        
        // Check various sources for damage description
        if (helper.expertise?.description) {
          damageDescription = helper.expertise.description;
        } else if (helper.damage?.description) {
          damageDescription = helper.damage.description;
        } else if (helper.estimate_notes) {
          damageDescription = helper.estimate_notes;
        } else if (helper.centers?.length > 0) {
          // Collect descriptions from centers - each center on separate row
          const blockDescriptions = [];
          helper.centers.forEach((center, index) => {
            const blockDesc = [];
            
            // Add damage center identifier (number + name if available) - make bold
            const centerNum = center['Damage center Number'] || (index + 1);
            const centerName = center.Location || '';
            const centerIdentifier = centerName ? `<strong>××•×§×“ ${centerNum}: ${centerName}</strong>` : `<strong>××•×§×“ ${centerNum}</strong>`;
            
            // Add damage center description if available - simplified format
            if (center.Description) {
              blockDesc.push(`${centerIdentifier} - ${center.Description}`);
            } else {
              blockDesc.push(centerIdentifier);
            }
            
            if (blockDesc.length > 0) {
              blockDescriptions.push(blockDesc[0]); // Only take the main description
            }
          });
          
          if (blockDescriptions.length > 0) {
            // Join each center description with a line break for separate rows
            damageDescription = blockDescriptions.join('<br><br>');
          }
        }
        
        // Fallback if no description found
        if (!damageDescription) {
          damageDescription = '×ª×™××•×¨ × ×–×§ ×œ× ×–××™×Ÿ';
        }
        
        // Build HTML structure
        const html = `
          <!-- Section 1 - Header -->
          <div class="report-header">
            <div class="car-details-title">${helper.report_title || '××•××“×Ÿ × ×–×§×™ ×¨×›×‘'}</div>
            <table style="width: 100%; margin-top: 10px; table-layout: fixed;">
              <tr>
                <td style="width: 40%; text-align: right; padding: 10px;">
                  <p style="margin: 0;"><strong>×œ×›×‘×•×“:</strong><br>${clientName}<br>${clientAddress}</p>
                </td>
                <td style="width: 20%;"></td>
                <td style="width: 40%; text-align: right; padding: 10px;">
                  <p style="margin: 0;"><strong>×ª××¨×™×š:</strong> ${new Date().toLocaleDateString('he-IL')}</p>
                  <p style="margin: 0;"><strong>×ª×™×§ ××¡×¤×¨:</strong> YC-${plate.replace(/[-\/]/g, '')}-${new Date().getFullYear()}</p>
                  <p style="margin: 0;"><strong>×¢×•×¡×§ ××•×¨×©×”:</strong> 02921217</p>
                </td>
              </tr>
            </table>
          </div>

          <!-- Section 2 - Vehicle Details -->
          <div class="car-details">
            <div class="car-details-title">×¤×¨×˜×™ ×”×¨×›×‘ ×”× ×‘×“×§</div> 
            <table class="car-details-table vehicle-details" style="width: 100%; table-layout: fixed; margin-bottom: 10px;">
              <tbody>
                <tr>
                  <td style="width: 50%; padding: 4px;"><strong>×‘×¢×œ ×”×¨×›×‘:</strong> ${clientName}</td>
                  <td style="width: 50%; padding: 4px;"><strong>×™×¦×¨×Ÿ:</strong> ${manufacturer}</td>
                </tr>
                <tr>
                  <td style="padding: 4px;"><strong>×›×ª×•×‘×ª ×‘×¢×œ ×”×¨×›×‘:</strong> ${clientAddress}</td>
                  <td style="padding: 4px;"><strong>×“×’×:</strong> ${model}</td>
                </tr>
                <tr>
                  <td style="padding: 4px;"><strong>××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×‘×¢×œ ×”×¨×›×‘:</strong> ${clientPhone}</td>
                  <td style="padding: 4px;"><strong>×§×•×“ ×“×’×:</strong> ${modelCode}</td>
                </tr>
                <tr>
                  <td style="padding: 4px;"><strong>××¡×¤×¨ ×¨×™×©×•×™:</strong> ${plate}</td>
                  <td style="padding: 4px;"><strong>××¡×¤×¨ ×©×œ×“×”:</strong> ${chassis}</td>
                </tr>
                <tr>
                  <td style="padding: 4px;"><strong>×ª××¨×™×š ×”×‘×“×™×§×”:</strong> ${inspectionDate}</td>
                  <td style="padding: 4px;"><strong>××§×•× ×”×‘×“×™×§×”:</strong> ${location}</td>
                </tr>
                <tr>
                  <td style="padding: 4px;"><strong>×©× ×ª ×™×¦×•×¨ ×”×¨×›×‘:</strong> ${year}</td>
                  <td style="padding: 4px;"><strong>××“ ××•×•×™×¨:</strong> ${mileageDisplay}</td>
                </tr>
                <tr>
                  <td style="padding: 4px;"><strong>×¡×•×’ ×”×¨×›×‘:</strong> ${ownershipType}</td>
                  <td style="padding: 4px;"><strong>×¡×•×’ ×”× ×–×§:</strong> ${damageType}</td>
                </tr>
                <tr>
                  <td style="padding: 4px;"><strong>×ª××¨×™×š ×”××™×¨×•×¢:</strong> ${eventDate}</td>
                  <td style="padding: 4px;"><strong>×¢×¨×š ×”×¨×›×‘:</strong> â‚ª ${vehicleValue ? parseFloat(vehicleValue.toString().replace(/[^\d.-]/g, '')).toLocaleString('he-IL') : ''}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Section 3 - Assessor Credentials -->
          <div class="section page-car-details">
            <div class="car-details">
              <div class="car-details-title">×©×××™ ×‘×•×“×§ ×™×¨×•×Ÿ ×›×™×•×£ ××¡' ×¨×©×™×•×Ÿ 1097</div>
              <div class="intellectual-box" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #003366; border-radius: 8px; padding: 8px; margin: 5px 0; text-align: right; page-break-inside: avoid;">
                <div style="font-size: 14px; color: #495057; line-height: 1.1; white-space: pre-line;">
<strong>×¤×¨×˜×™ ×”×©×›×œ×ª×™ ×•× ×™×¡×™×•× ×™:</strong>
×× ×™ ×”×—×ª×•× ××˜×” ×™×¨×•×Ÿ ×›×™×•×£ ×©×××™ ×‘×¢×œ ×¨×™×©×™×•×Ÿ ××©×¨×“ ×”×ª×—×‘×•×¨×” ××¡' 1097
×©×××™ ×¨×›×•×©, ×—×§×œ××•×ª ×‘×•×’×¨ ×”×™×—×™×“×” ×œ×œ×™××•×“×™ ×—×•×¥
×—×•×§×¨ ×ª××•× ×•×ª ×“×¨×›×™× ×•×‘×˜×™×—×•×ª, ××›×œ×œ×ª ××©×œ×‘
××¨×¦×” ×©×××•×ª ×¨×›×‘ ××›×œ×œ×ª ×¢×ª×™×“
×‘×•×’×¨ ×‘×™×”"×¡ ××§×¦×•×¢×™ ×œ××›×•× ××•×ª ×¨×›×‘ (×‘×•×’×¨ ××¦×˜×™×™×Ÿ)
×‘×•×’×¨ ×”×§×•×¨×¡ ×œ×©×××•×ª ×¨×›×‘, ××›×œ×œ×ª ×¢×ª×™×“
×¢×“ ××•××—×” ×œ×‘×™×ª ×”××©×¤×˜, ×ª×—×•× ×©×××•×ª ×¨×›×‘ ×•×¨×›×•×©. ××›×œ×œ×ª ××¤×™×§
××›×•× ××™ ×¨×›×‘ ×¡×•×’ 3, ××›×œ×œ×ª ×¢×ª×™×“
×‘×•×—×Ÿ ×¨×›×‘ ×‘×©×™×¨×•×ª ×§×‘×¢ ×¦×”"×œ
×‘×•×’×¨ ×§×•×¨×¡ ×”×¡××›×” ×•× ×™×”×•×œ ××•×¡×›×™×, ××›×œ×œ×ª ×¢×ª×™×“
×”×©×ª×œ××•×ª ×‘××¢×¨×›×•×ª ×‘×œ××™× ××•×•×™×¨ ×• ABS ×‘×¦×™×•×“ ×›×‘×“
×”×©×ª×œ××•×ª ××¢×¨×›×•×ª ××ª×§×“××•×ª ×•×—×™×“×•×© ×˜×›× ×•×œ×•×’×™×™× ×‘×¨×›×‘, ×”××›×œ×œ×” ×”×˜×›× ×•×œ×•×’×™×ª ×œ×¨×›×‘
×”×©×ª×œ××•×ª ×‘×¨×›×‘ ×”×™×‘×¨×™×“×™ ×•×—×©××œ×™, ×”××›×œ×œ×” ×”×˜×›× ×•×œ×•×’×™×ª ×œ×¨×›×‘
×‘×•×’×¨ ×”×©×ª×œ××•×™×•×ª ×©×•× ×•×ª ×‘×× ×•×¢×™ ×‘× ×–×™×Ÿ, ×“×™×–×œ, ×¨×›×‘ ×—×©××œ×™ / ×”×™×‘×¨×™×“×™ ×•×ª×•×¨×ª ×”×—×•××¨×™×.
                </div>
              </div>
            </div>
          </div>

          <!-- Section 4 - Damage Analysis with Introduction -->
          ${generateDamageAnalysis(helper, damageDescription)}

          <!-- Section 4.5 - Vehicle Value for Gross Damage -->
          <div class="section page-price-adjustments adjustment-group">
            <div class="car-details">
              <div class="car-details-title">×¢×¨×š ×”×¨×›×‘ ×œ× ×–×§ ×’×•×œ××™</div>
              <table class="car-details-table" style="width: 100%; max-width: 600px; margin: 0 auto;">
                <tr><th style="width: 40%;">××¨×›×™×‘</th><th style="width: 20%;">×ª×•×¡×¤×ª/×”×¤×—×ª×”</th><th style="width: 20%;">××—×•×–</th><th style="width: 20%;">×¢×¨×š</th></tr>
                ${generateMarketValueTable()}
              </table>
            </div>
          </div>

          <!-- Section 4.6 - Damage Percentage Calculation -->
          <div class="section adjustment-group">
            <div class="car-details">
              <div class="car-details-title">×—×™×©×•×‘ ××—×•×– ×”× ×–×§</div>
              <table class="car-details-table" style="width: 100%; max-width: 600px; margin: 0 auto;">
                <tr><th style="width: 70%;">×ª×™××•×¨</th><th style="width: 30%;">×¢×¨×š</th></tr>
                <tr><td style="padding: 8px;">×¡×”"×› ×”× ×–×§ ×›×•×œ×œ ××¢"×</td><td style="padding: 8px; text-align: center;">${formatCurrency(baseDamage)}</td></tr>
                <tr><td style="padding: 8px;">×¢×¨×š ×”×¨×›×‘ ×œ× ×–×§ ×’×•×œ××™ ×›×•×œ×œ ××¢"×</td><td style="padding: 8px; text-align: center;">${formatCurrency(marketValue)}</td></tr>
                <tr><td style="padding: 8px;"><strong>××—×•×– ×”× ×–×§ ×”×’×•×œ××™</strong></td><td style="padding: 8px; text-align: center;"><strong>${damagePercent}%</strong></td></tr>
              </table>
            </div>
          </div>

          <!-- Section 4.7 - Levi Market Value Calculation -->
          ${generateLeviAdjustments(helper)}

          <!-- Section 4.8 - Depreciation Opening Block -->
          ${generateDepreciationAnalysis(helper)}

          <!-- Section 5 - Estimate Totals Summary -->
          <div class="section depreciation-group">
            <div class="estimate-totals">
              <div class="car-details-title">×¡×™×›×•× ×”××•××“×Ÿ</div>
              <table class="car-details-table" style="width: 100%; max-width: 600px; margin: 0 auto;">
                <tr>
                  <th style="width: 70%; text-align: right;">×¡×¢×™×£</th>
                  <th style="width: 30%; text-align: center;">×©×•×•×™</th>
                </tr>
                <tr>
                  <td style="padding: 8px;">×¡×”"×› ××•××“×Ÿ × ×–×§×™×</td>
                  <td style="padding: 8px; text-align: center;">${formatCurrency(baseDamage)}</td>
                </tr>
                <tr>
                  <td style="padding: 8px;">×¤×™×¦×•×™ ×‘×’×™×Ÿ ×™×¨×™×“×ª ×¢×¨×š</td>
                  <td style="padding: 8px; text-align: center;">${formatCurrency(helper.estimate?.depreciation?.global_amount || helper.expertise?.depreciation?.global_amount || helper.depreciation?.global_amount || helper.estimate_depreciation?.global_value || 0)}</td>
                </tr>
                <tr>
                  <td style="padding: 8px;"><strong>×¡×”"×› × ×›×œ×œ ×‘××•××“×Ÿ</strong></td>
                  <td style="padding: 8px; text-align: center;"><strong>${formatCurrency(baseDamage + (helper.estimate?.depreciation?.global_amount || helper.expertise?.depreciation?.global_amount || helper.depreciation?.global_amount || helper.estimate_depreciation?.global_value || 0))}</strong></td>
                </tr>
              </table>
            </div>
          </div>

          <!-- Section 6 - Legal Text and Disclaimers -->
          <div class="section page-legal-final">
            <div style="font-size: 14px; line-height: 1.1; padding: 15px;">
              <p style="margin: 0 0 12px 0; font-weight: bold; color: #003366; font-size: 16px;">×”×¢×¨×•×ª ×—×©×•×‘×•×ª ×œ×’×‘×™ ×”××•××“×Ÿ:</p>
              <div style="font-size: 14px; line-height: 1.1; margin-bottom: 15px; text-align: justify;">
                ${generateLegalText(helper).replace(/\n/g, '<br>')}
              </div>

              <p style="margin: 0 0 12px 0; font-weight: bold; color: #003366; font-size: 16px;">×”×¦×”×¨×ª ×©×××™:</p>
              <p style="font-size: 14px; line-height: 1.1; margin-bottom: 15px; text-align: justify;">
                ×× ×™ ×”×—×ª×•× ××˜×”: <strong>×™×¨×•×Ÿ ×›×™×•×£, ×ª×¢×•×“×ª ×©×××™ ××¡' 1097</strong>. ×”× × ×™ × ×•×ª×Ÿ ××ª ×—×•×•×ª ×“×¢×ª×™ ×–×• ×‘××§×•× ×¢×“×•×ª ×‘×©×‘×•×¢×” ×‘×‘×™×ª ××©×¤×˜. ×”×“×™×Ÿ ×©×œ ×—×•×•×ª ×“×¢×ª ×–×• ×”×•× ×›×“×™×Ÿ ×¢×“×•×ª ×‘×©×‘×•×¢×”.
              </p>

              <div style="margin: 20px 0 15px 0; font-size: 14px; line-height: 1.2;">
                ${getAttachmentsList()}
              </div>

              <div class="estimate-disclaimer" style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 12px; margin-top: 12px;">
                <p style="margin: 0 0 6px 0; font-weight: bold; color: #856404; font-size: 14px;">××•××“×Ÿ ×–×” ×”×™× ×• ×”×¢×¨×›×” ×¨××©×•× ×™×ª ×‘×œ×‘×“ ×•××™× ×• ××”×•×•×” ×”×ª×—×™×™×‘×•×ª ×›×¡×¤×™×ª.</p>
                <p style="margin: 0; color: #856404; font-size: 14px; line-height: 1.3;">×”×¢×œ×•×™×•×ª ×”×¡×•×¤×™×•×ª ×¢×©×•×™×•×ª ×œ×”×©×ª× ×•×ª ×‘×”×ª×× ×œ×ª×•×¦××•×ª ×”×‘×™×¦×•×¢ ×‘×¤×•×¢×œ, ×–××™× ×•×ª ×—×œ×§×™× ×•×ª× ××™ ×”×©×•×§.</p>
              </div>
            </div>
          </div>

          <!-- Section 7 - Signature -->
          <div class="signature-stamp" style="margin-top: 15px;">
            <div class="center-text" style="font-size: 16px; font-weight: bold;">×‘×›×‘×•×“ ×¨×‘,</div>
          </div>

          <div style="margin-top: 10px; text-align: left;">
            <img src="https://carmelcayouf.com/wp-content/uploads/2025/04/yaron-signature-transparent-.webp" alt="×—×ª×™××”" style="height: 140px;">
          </div>
          
          <div style="margin-top: 8px; text-align: center;">
            <p style="margin: 5px 0;"><strong>×™×¨×•×Ÿ ×›×™×•×£ - ×©×××™ ××•×¨×©×” ××¡' 1097</strong></p>
            <p style="margin: 5px 0;">×™×¨×•×Ÿ ×›×™×•×£ - ×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</p>
            <p style="margin: 15px 0 5px 0; font-size: 12px; color: #666; font-style: italic;">×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª @ ×™×¨×•×Ÿ ×›×™×•×£ - ×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</p>
          </div>
        `;
        
        container.innerHTML = html;
        
        // Apply dynamic page layout management
        adjustContentForPrint();
        
      } catch (error) {
        console.error('Error generating estimate report:', error);
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #dc2626;">
            <h3>×©×’×™××” ×‘×™×¦×™×¨×ª ×”××•××“×Ÿ</h3>
            <p>××™×¨×¢×” ×©×’×™××” ×‘×™×¦×™×¨×ª ×“×•"×— ×”××•××“×Ÿ. ×× × × ×¡×” ×©×•×‘.</p>
            <button onclick="window.location.reload()" class="btn-primary">× ×¡×” ×©×•×‘</button>
          </div>
        `;
      }
    }

    // Dynamic Page Layout Management
    function optimizePageBreaks() {
      const A4_HEIGHT_MM = 297;
      const A4_HEIGHT_PX = A4_HEIGHT_MM * 3.78; // 1mm â‰ˆ 3.78px at 96dpi
      const CONTENT_HEIGHT_PX = A4_HEIGHT_PX - 120; // Account for margins and headers
      
      // Get all damage center containers
      const damageContainers = document.querySelectorAll('.damage-center-container');
      let currentPageHeight = 0;
      let pageNumber = 2; // Start from page 2 (after car details)
      
      damageContainers.forEach((container, index) => {
        const containerHeight = container.offsetHeight;
        
        // If adding this container would exceed page height, force page break
        if (currentPageHeight + containerHeight > CONTENT_HEIGHT_PX && index > 0) {
          container.style.pageBreakBefore = 'always';
          currentPageHeight = containerHeight;
          pageNumber++;
        } else {
          currentPageHeight += containerHeight;
        }
        
        // Mark containers for potential page breaks after every 2-3 containers
        if (index > 0 && index % 2 === 0) {
          container.style.pageBreakBefore = 'auto';
        }
      });
      
      console.log(`ğŸ“„ Dynamic layout: ${pageNumber} pages optimized for damage centers`);
    }
    
    // Content-aware positioning
    function adjustContentForPrint() {
      // Ensure first page always contains car details + credentials
      const carDetailsSection = document.querySelector('.page-car-details');
      if (carDetailsSection) {
        carDetailsSection.style.pageBreakAfter = 'always';
      }
      
      // Ensure damage intro starts on new page
      const damageIntroSection = document.querySelector('.page-damage-intro');
      if (damageIntroSection) {
        damageIntroSection.style.pageBreakBefore = 'always';
      }
      
      // Optimize adjustment groups to stay together
      const adjustmentGroups = document.querySelectorAll('.adjustment-group');
      adjustmentGroups.forEach((group, index) => {
        if (index === 0) {
          // First adjustment group starts the price adjustments page
          group.style.pageBreakBefore = 'always';
        } else {
          // Subsequent groups try to stay on same page
          group.style.pageBreakBefore = 'avoid';
        }
        
        // Prevent breaking within adjustment groups
        group.style.pageBreakInside = 'avoid';
        
        // Last adjustment group should break after
        if (index === adjustmentGroups.length - 1) {
          group.style.pageBreakAfter = 'always';
        }
      });

      // Optimize depreciation groups to stay together
      const depreciationGroups = document.querySelectorAll('.depreciation-group');
      depreciationGroups.forEach((group, index) => {
        // Prevent breaking within depreciation groups
        group.style.pageBreakInside = 'avoid';
        
        // First depreciation group (main depreciation section) should start on new page
        if (index === 0) {
          group.style.pageBreakBefore = 'always';
        } else {
          // Subsequent groups (like summary) try to stay on same page
          group.style.pageBreakBefore = 'avoid';
        }
      });

      // Optimize damage centers to flow together without page breaks
      const damageCentersGroup = document.querySelector('.damage-centers-group');
      if (damageCentersGroup) {
        damageCentersGroup.style.pageBreakInside = 'auto';
        damageCentersGroup.style.pageBreakBefore = 'always';
        damageCentersGroup.style.pageBreakAfter = 'avoid';
        
        // Ensure individual damage centers don't break
        const damageContainers = damageCentersGroup.querySelectorAll('.car-details');
        damageContainers.forEach((container, index) => {
          container.style.pageBreakBefore = 'avoid';
          container.style.pageBreakInside = 'avoid';
          container.style.pageBreakAfter = 'avoid';
        });
      }
      
      // Ensure final legal section is on its own page
      const legalSection = document.querySelector('.page-legal-final');
      if (legalSection) {
        legalSection.style.pageBreakBefore = 'always';
      }
      
      // Run dynamic page break optimization after DOM is ready
      setTimeout(optimizePageBreaks, 100);
      
      // Handle border restoration for containers that span across pages
      setTimeout(handleContainerBorderRestoration, 200);
    }
    
    function handleContainerBorderRestoration() {
      const carDetailsElements = document.querySelectorAll('.car-details');
      
      carDetailsElements.forEach((element, index) => {
        // Check if element might span pages by looking at its height
        const elementHeight = element.offsetHeight;
        const pageHeight = window.innerHeight || 800; // Approximate A4 height
        
        // If element is taller than half a page, it might span pages
        if (elementHeight > pageHeight * 0.4) {
          // Add class to maintain borders across page breaks
          element.classList.add('car-details-spanning');
          
          // Use box-decoration-break to maintain borders
          element.style.boxDecorationBreak = 'clone';
          element.style.webkitBoxDecorationBreak = 'clone';
          
          // Ensure borders are maintained
          element.style.border = '2px solid #000';
          element.style.borderRadius = '25px';
          element.style.padding = '15px';
        }
      });
    }
    
    function generateDamageAnalysis(helper, damageDescription = '') {
      const damageBlocks = helper.estimate?.damage_centers || helper.expertise?.damage_blocks || helper.damage_sections || [];
      
      // Create introduction section
      const introSection = `
        <div class="car-details page-damage-intro">
          <p style="font-size: 16px; line-height: 1.6; margin: 15px 0;">
            ×‘×”×ª×× ×œ×‘×§×©×ª×›×, ×¢×¨×›× ×• ××•××“×Ÿ ×¨××©×•× ×™ ×œ×¢×œ×•×™×•×ª ×ª×™×§×•×Ÿ × ×–×§×™ ×”×¨×›×‘ ×”× ×“×•×Ÿ ×›×¤×™ ×©×”×•×¦×’×• ×œ×¤× ×™× ×•.
          </p>
          <p style="font-size: 16px; font-weight: bold; text-decoration: underline; margin: 10px 0;">×ª×™××•×¨ ×”× ×–×§:</p>
          <div style="font-size: 16px; line-height: 1.6; margin: 10px 0;">
            ${damageDescription}
          </div>
          <p style="font-size: 16px; font-weight: bold; text-decoration: underline; margin: 10px 0;">××•××“×Ÿ ×¢×œ×•×™×•×ª:</p>
          <p style="font-size: 16px; line-height: 1.6; margin: 10px 0;">
            ×”××•××“×Ÿ ××‘×•×¡×¡ ×¢×œ ××—×™×¨×™ ×©×•×§ × ×•×›×—×™×™× ×•×¢×œ ×‘×“×™×§×” ×¨××©×•× ×™×ª ×©×œ ×”× ×–×§×™×. ×¢×œ×•×™×•×ª ×¡×•×¤×™×•×ª ×¢×©×•×™×•×ª ×œ×”×©×ª× ×•×ª.
          </p>
        </div>
      `;
      
      if (!damageBlocks || damageBlocks.length === 0) {
        return `
          <div class="section damage-centers-group">
            ${introSection}
            <div class="car-details">
              <div class="car-details-title">× ×™×ª×•×— × ×–×§×™×</div>
              <p style="text-align: center; padding: 20px;">×œ× × ××¦××• × ×ª×•× ×™ × ×–×§×™× ××¤×•×¨×˜×™×</p>
            </div>
          </div>
        `;
      }
      
      const damageHTML = damageBlocks.map((block, index) => {
        const works = block.works || [];
        const parts = block.parts || [];
        const repairs = block.repairs || [];
        
        const worksTotal = block.works_total || works.reduce((sum, item) => sum + (item.cost || 0), 0);
        const partsTotal = block.parts_total || parts.reduce((sum, item) => sum + (item.price || 0), 0);
        const repairsTotal = block.repairs_total || repairs.reduce((sum, item) => sum + (item.cost || 0), 0);
        const sectionTotal = worksTotal + partsTotal + repairsTotal;
        
        // Generate detailed rows for each category
        const workRows = works.map(work => `
          <tr>
            <td style="padding: 4px 6px;">×¢×‘×•×“×•×ª</td>
            <td style="padding: 4px 6px;">${work.type || work.description || work.name || '×¢×‘×•×“×” ×œ× ××•×’×“×¨×ª'}</td>
            <td style="padding: 4px 6px; text-align: center;">${formatCurrency(work.cost || 0)}</td>
          </tr>
        `).join('');
        
        const partRows = parts.map(part => `
          <tr>
            <td style="padding: 4px 6px;">×—×œ×§×™×</td>
            <td style="padding: 4px 6px;">${part.name || part.description || '×—×œ×§ ×œ× ××•×’×“×¨'}</td>
            <td style="padding: 4px 6px; text-align: center;">${formatCurrency(part.price || 0)}</td>
          </tr>
        `).join('');
        
        const repairRows = repairs.map(repair => `
          <tr>
            <td style="padding: 4px 6px;">×ª×™×§×•× ×™×</td>
            <td style="padding: 4px 6px;">${repair.name || repair.description || '×ª×™×§×•×Ÿ ×œ× ××•×’×“×¨'}</td>
            <td style="padding: 4px 6px; text-align: center;">${formatCurrency(repair.cost || 0)}</td>
          </tr>
        `).join('');
        
        // If no detailed items, show summary
        const detailedRows = workRows + partRows + repairRows;
        const summaryRows = detailedRows || `
          <tr>
            <td style="padding: 8px;">×¢×‘×•×“×•×ª</td>
            <td style="padding: 8px;">${works.length} ×¤×¨×™×˜×™×</td>
            <td style="padding: 8px; text-align: center;">${formatCurrency(worksTotal)}</td>
          </tr>
          <tr>
            <td style="padding: 8px;">×—×œ×§×™×</td>
            <td style="padding: 8px;">${parts.length} ×¤×¨×™×˜×™×</td>
            <td style="padding: 8px; text-align: center;">${formatCurrency(partsTotal)}</td>
          </tr>
          <tr>
            <td style="padding: 8px;">×ª×™×§×•× ×™×</td>
            <td style="padding: 8px;">${repairs.length} ×¤×¨×™×˜×™×</td>
            <td style="padding: 8px; text-align: center;">${formatCurrency(repairsTotal)}</td>
          </tr>
        `;
        
        // Generate separate sections for each category
        let categorySections = '';
        
        // Works section - Updated structure from Final Report Template
        if (works.length > 0) {
          const workRowsDetailed = works.map((work, index) => `
            <tr>
              <td>${index + 1}</td>
              <td>${work.category || work.type || work.description || work.name || '×¢×‘×•×“×” ×œ× ××•×’×“×¨×ª'}</td>
              <td>${formatCurrency(work.cost || 0)}</td>
              <td>${work.comments || work.description || ''}</td>
            </tr>
          `).join('');
          
          categorySections += `
            <div style="margin-bottom: 8px;">
              <h4 style="margin: 6px 0; color: #003366; font-size: 16px; font-weight: bold;">×¢×‘×•×“×•×ª</h4>
              <table class="car-details-table">
                <thead>
                  <tr>
                    <th style="font-weight: bold;">××¡"×“</th>
                    <th>×¡×•×’ ×¢×‘×•×“×”</th>
                    <th>×¢×œ×•×ª ××©×•×¢×¨×ª</th>
                    <th>×ª×™××•×¨</th>
                  </tr>
                </thead>
                <tbody>
                  ${workRowsDetailed}
                </tbody>
              </table>
            </div>
          `;
        }
        
        // Parts section - Updated structure from Final Report Template
        if (parts.length > 0) {
          const partRowsDetailed = parts.map((part, index) => `
            <tr>
              <td>${index + 1}</td>
              <td>${part.name || '×—×œ×§ ×œ× ××•×’×“×¨'}</td>
              <td>${formatCurrency(part.price || 0)}</td>
              <td>${part.source || ''}</td>
              <td>${part.desc || part.description || ''}</td>
            </tr>
          `).join('');
          
          categorySections += `
            <div style="margin-bottom: 8px;">
              <h4 style="margin: 6px 0; color: #003366; font-size: 16px; font-weight: bold;">×—×œ×§×™×</h4>
              <table class="car-details-table">
                <thead>
                  <tr>
                    <th style="font-weight: bold;">××¡"×“</th>
                    <th>×©× ×”×—×œ×§</th>
                    <th>×¢×œ×•×ª ××©×•×¢×¨×ª</th>
                    <th>××§×•×¨</th>
                    <th>×ª×™××•×¨</th>
                  </tr>
                </thead>
                <tbody>
                  ${partRowsDetailed}
                </tbody>
              </table>
            </div>
          `;
        }
        
        // Repairs section - Updated structure from Final Report Template
        if (repairs.length > 0) {
          const repairRowsDetailed = repairs.map((repair, index) => `
            <tr>
              <td>${index + 1}</td>
              <td>${repair.name || '×ª×™×§×•×Ÿ ×œ× ××•×’×“×¨'}</td>
              <td>${formatCurrency(repair.cost || 0)}</td>
              <td>${repair.description || ''}</td>
            </tr>
          `).join('');
          
          categorySections += `
            <div style="margin-bottom: 8px;">
              <h4 style="margin: 6px 0; color: #003366; font-size: 16px; font-weight: bold;">×ª×™×§×•× ×™×</h4>
              <table class="car-details-table">
                <thead>
                  <tr>
                    <th style="font-weight: bold;">××¡"×“</th>
                    <th>×©× ×”×ª×™×§×•×Ÿ</th>
                    <th>×¢×œ×•×ª ××©×•×¢×¨×ª</th>
                    <th>×ª×™××•×¨ ×¢×œ×•×ª</th>
                  </tr>
                </thead>
                <tbody>
                  ${repairRowsDetailed}
                </tbody>
              </table>
            </div>
          `;
        }
        
        return `
          <div class="car-details damage-center-container" style="margin-bottom: 20px;">
            <div class="car-details-title">××•××“×Ÿ ××•×§×“ ${index + 1}: ${block.area_name || block.label || block.location || block.center || block.name || block.area || block.section || `××•×§×“ ${index + 1}`}</div>
            <div style="padding: 10px;">
              ${categorySections}
              <div style="margin-top: 15px; padding: 10px; background: #f0f8ff; border-radius: 8px;">
                <table class="car-details-table" style="width: 100%; border: 2px solid #003366;">
                  <tr>
                    <th style="width: 70%; text-align: right; background: #fff8e1; color: #003366; font-weight: bold;">×¡×™×›×•×</th>
                    <th style="width: 30%; text-align: center; background: #fff8e1; color: #003366; font-weight: bold;">×¢×œ×•×ª</th>
                  </tr>
                  <tr>
                    <td style="padding: 8px;">×¡×”"×› ×”×›×œ ×¢×‘×•×“×•×ª</td>
                    <td style="padding: 8px; text-align: center;">${formatCurrency(worksTotal)}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px;">×¡×”"×› ×”×›×œ ×—×œ×§×™×</td>
                    <td style="padding: 8px; text-align: center;">${formatCurrency(partsTotal)}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px;">×¡×”"×› ×”×›×œ ×ª×™×§×•× ×™×</td>
                    <td style="padding: 8px; text-align: center;">${formatCurrency(repairsTotal)}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px;">×¡×”"×› ×”×›×œ ×¢×‘×•×“×•×ª + ×—×œ×§×™× + ×ª×™×§×•× ×™×</td>
                    <td style="padding: 8px; text-align: center;">${formatCurrency(worksTotal + partsTotal + repairsTotal)}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px;">××¢"× 18%</td>
                    <td style="padding: 8px; text-align: center;">${formatCurrency((worksTotal + partsTotal + repairsTotal) * 0.18)}</td>
                  </tr>
                  <tr style="background: #e8f4f8;">
                    <td style="padding: 8px; font-weight: bold;">×¡×”"×› ×›×•×œ×œ ××¢"×</td>
                    <td style="padding: 8px; text-align: center; font-weight: bold;">${formatCurrency((worksTotal + partsTotal + repairsTotal) * 1.18)}</td>
                  </tr>
                </table>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // Calculate total damage for all centers including VAT
      const totalDamageAllCenters = damageBlocks.reduce((sum, block) => {
        const worksTotal = block.works_total || (block.works || []).reduce((sum, item) => sum + (item.cost || 0), 0);
        const partsTotal = block.parts_total || (block.parts || []).reduce((sum, item) => sum + (item.price || 0), 0);
        const repairsTotal = block.repairs_total || (block.repairs || []).reduce((sum, item) => sum + (item.cost || 0), 0);
        const centerTotalWithVat = (worksTotal + partsTotal + repairsTotal) * 1.18;
        return sum + centerTotalWithVat;
      }, 0);
      
      // Generate centers summary table
      const centersSummaryRows = damageBlocks.map((block, index) => {
        const worksTotal = block.works_total || (block.works || []).reduce((sum, item) => sum + (item.cost || 0), 0);
        const partsTotal = block.parts_total || (block.parts || []).reduce((sum, item) => sum + (item.price || 0), 0);
        const repairsTotal = block.repairs_total || (block.repairs || []).reduce((sum, item) => sum + (item.cost || 0), 0);
        const centerTotalWithVat = (worksTotal + partsTotal + repairsTotal) * 1.18;
        const centerName = block.area_name || block.label || block.location || block.center || block.name || block.area || block.section || `××•×§×“ ${index + 1}`;
        const centerDescription = block.description || '';
        
        return `
          <tr>
            <td style="padding: 8px; text-align: center;">××•×§×“ ${index + 1}: ${centerName}</td>
            <td style="padding: 8px; text-align: center;">${centerDescription}</td>
            <td style="padding: 8px; text-align: center;">â‚ª${Math.round(centerTotalWithVat).toLocaleString()}</td>
          </tr>
        `;
      }).join('');
      
      const centersSummaryTable = `
        <div class="car-details" style="margin-top: 30px;">
          <div class="car-details-title">×—×œ×•×§×” ×œ××•×§×“×™×</div>
          <table class="car-details-table" style="width: 100%; max-width: 800px; margin: 0 auto;">
            <thead>
              <tr>
                <th style="width: 20%; text-align: center; background: #fff8e1; color: #003366; font-weight: bold;">××•×§×“</th>
                <th style="width: 50%; text-align: center; background: #fff8e1; color: #003366; font-weight: bold;">×ª×™××•×¨</th>
                <th style="width: 30%; text-align: center; background: #fff8e1; color: #003366; font-weight: bold;">×¡×›×•×</th>
              </tr>
            </thead>
            <tbody>
              ${centersSummaryRows}
              <tr style="background: #e8f4f8; font-weight: bold;">
                <td style="padding: 8px; text-align: center; font-weight: bold;">×¡×”"×›</td>
                <td style="padding: 8px; text-align: center; font-weight: bold;">×›×•×œ×œ ××¢"×</td>
                <td style="padding: 8px; text-align: center; font-weight: bold;">â‚ª${Math.round(totalDamageAllCenters).toLocaleString()}</td>
              </tr>
            </tbody>
          </table>
        </div>
      `;
      
      return `<div class="section damage-centers-group">${introSection}${damageHTML}${centersSummaryTable}</div>`;
    }
    
    function generateLegalText(helper) {
      // Get legal text from estimate.summary.legal_text (primary source)
      const summaryLegalText = helper.estimate?.summary?.legal_text || '';
      
      if (summaryLegalText) {
        return summaryLegalText;
      }
      
      // Fallback to builder text
      const builderLegalText = helper.estimate_legal_text || '';
      
      // If builder has text, use it
      if (builderLegalText) {
        return builderLegalText;
      }
      
      // Fallback to vault system
      const estimateType = helper.estimate_type || '××•×‘×“×Ÿ_×œ×”×œ×›×”';
      const vaultTexts = window.vaultTexts || helper.vault?.legal_texts || {};
      
      const legalText = helper.legal_texts?.[`estimate_${estimateType}`] || 
                       helper.legal_texts?.estimate_default ||
                       vaultTexts[`estimate_${estimateType}`]?.text ||
                       vaultTexts.estimate_default?.text ||
                       '××•××“×Ÿ ×–×” ××‘×•×¡×¡ ×¢×œ ×‘×“×™×§×” ×¨××©×•× ×™×ª ×•×¢×œ ××—×™×¨×™ ×©×•×§ × ×•×›×—×™×™×. ×”×¢×œ×•×™×•×ª ×”×¡×•×¤×™×•×ª ×¢×©×•×™×•×ª ×œ×”×©×ª× ×•×ª ×‘×”×ª×× ×œ×ª× ××™ ×”×‘×™×¦×•×¢ ×‘×¤×•×¢×œ.';
      
      // Add assessor credentials from vault
      const assessorCredentials = vaultTexts.assessor_introduction || 
                                 '×™×¨×•×Ÿ ×›×™×•×£, ×©×××™ ××•×¡××š ××¡×¤×¨ ×¨×™×©×™×•×Ÿ 1097, ×‘×¢×œ ×•×ª×§ ×©×œ ××¢×œ 15 ×©× ×” ×‘×ª×—×•× ×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©.';
      
      return legalText + '\n\n' + assessorCredentials;
    }
    
    function getAttachmentsList() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Get attachments from estimate.summary.attachments[0] (primary source)
      let attachmentsText = helper.estimate?.summary?.attachments?.[0] || '';
      
      // Fallback to helper attachments (saved from builder)
      if (!attachmentsText) {
        attachmentsText = helper.estimate_attachments || '**×œ×•×˜×”**\n×ª×¦×œ×•××™ ×”×¨×›×‘ ×”× ×™×–×•×§\n×—×©×‘×•× ×™×•×ª ×ª×™×§×•×Ÿ\n×¢×¨×š ×¨×›×‘ ×××•×—×©×‘\n×¦×™×œ×•× ×¨×™×©×™×•×Ÿ ×”×¨×›×‘\n×—×©×›"×˜';
      }
      
      // Convert plain text to HTML for display
      attachmentsText = attachmentsText
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
      
      return attachmentsText;
    }
    
    function generateMarketValueTable() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Get base price from valuation.base_price
      const basePrice = parseFloat(helper.valuation?.base_price?.replace(/[^\d.-]/g, '') || '0') || 0;
      
      let rows = [];
      // Get total from estimate.gross_market_value
      const totalValue = helper.estimate?.gross_market_value || 0;
      
      // Add base price row
      rows.push(`
        <tr>
          <td style="padding: 8px;">×¢×¨×š ×”×¨×›×‘ ×¢"×¤ ××—×™×¨×•×Ÿ ×›×•×œ×œ ××¢"×</td>
          <td style="padding: 8px; text-align: center;">-</td>
          <td style="padding: 8px; text-align: center;">-</td>
          <td style="padding: 8px; text-align: center;">${formatCurrency(basePrice)}</td>
        </tr>
      `);
      
      // Process features adjustments first
      const featuresAdjustments = helper.estimate?.adjustments?.features || [];
      
      featuresAdjustments.forEach(adjustment => {
        const componentValue = adjustment.value || ''; // ××¨×›×™×‘
        const typeDisplay = adjustment.type === 'plus' ? '×ª×•×¡×¤×ª' : '×”×¤×—×ª×”'; // ×ª×•×¡×¤×ª\×”×¤×—×ª×”  
        const percentDisplay = adjustment.percent ? `${adjustment.percent}%` : '-'; // ××—×•×–
        const amount = adjustment.amount || 0; // ×¢×¨×š
        
        // No need to calculate cumulative value - use estimate.gross_market_value
        
        rows.push(`
          <tr>
            <td style="padding: 8px;">${componentValue}</td>
            <td style="padding: 8px; text-align: center;">${typeDisplay}</td>
            <td style="padding: 8px; text-align: center;">${percentDisplay}</td>
            <td style="padding: 8px; text-align: center;">${formatCurrency(amount)}</td>
          </tr>
        `);
      });
      
      // Process registration adjustments second
      const registrationAdjustments = helper.estimate?.adjustments?.registration || [];
      
      registrationAdjustments.forEach(adjustment => {
        const componentValue = adjustment.value || ''; // ××¨×›×™×‘
        const typeDisplay = adjustment.type === 'plus' ? '×ª×•×¡×¤×ª' : '×”×¤×—×ª×”'; // ×ª×•×¡×¤×ª\×”×¤×—×ª×”
        const percentDisplay = adjustment.percent ? `${adjustment.percent}%` : '-'; // ××—×•×–  
        const amount = adjustment.amount || 0; // ×¢×¨×š
        
        // No need to calculate cumulative value - use estimate.gross_market_value
        
        rows.push(`
          <tr>
            <td style="padding: 8px;">${componentValue}</td>
            <td style="padding: 8px; text-align: center;">${typeDisplay}</td>
            <td style="padding: 8px; text-align: center;">${percentDisplay}</td>
            <td style="padding: 8px; text-align: center;">${formatCurrency(amount)}</td>
          </tr>
        `);
      });
      
      // Add final cumulative value row
      rows.push(`
        <tr style="background: #e8f4f8; font-weight: bold;">
          <td colspan="3" style="padding: 8px; text-align: center; font-weight: bold;"><strong>×¢×¨×š ×”×¨×›×‘ ×œ× ×–×§ ×’×•×œ××™ ×›×•×œ×œ ××¢"×</strong></td>
          <td style="padding: 8px; text-align: center; font-weight: bold;"><strong>${formatCurrency(totalValue)}</strong></td>
        </tr>
      `);
      
      return rows.join('');
    }
    
    function generateLeviAdjustments(helper) {
      // Get base price from valuation.base_price
      const basePrice = parseFloat(helper.valuation?.base_price?.replace(/[^\d.-]/g, '') || '0') || 0;
      
      if (!basePrice) {
        return `
          <div class="section">
            <div class="car-details">
              <div class="car-details-title">×—×™×©×•×‘ ×¢×¨×š ×”×©×•×§ ×©×œ ×”×¨×›×‘</div>
              <p style="text-align: center; padding: 20px;">×œ× × ××¦××• × ×ª×•× ×™ ××—×™×¨ ×‘×¡×™×¡</p>
            </div>
          </div>
        `;
      }
      
      // Get total from estimate.gross_market_value
      const totalValue = helper.estimate?.gross_market_value || 0;
      const adjustmentRows = [];
      
      // Process adjustments in specific order: features, registration, mileage, ownership_type, ownership_history
      const categoryOrder = ['features', 'registration', 'mileage', 'ownership_type', 'ownership_history'];
      const categoryLabels = {
        'features': '×××¤×™×™× ×™×',
        'registration': '×¢×œ×™×” ×œ×›×‘×™×©',
        'mileage': '××¡ ×§×´×',
        'ownership_type': '×‘×¢×œ×•×ª',
        'ownership_history': '××¡×¤×¨ ×‘×¢×œ×™×'
      };
      
      categoryOrder.forEach(category => {
        const adjustments = helper.estimate?.adjustments?.[category] || [];
        
        adjustments.forEach(adjustment => {
          const percentDisplay = adjustment.percent ? `${adjustment.percent}%` : '-';
          const amount = adjustment.amount || 0;
          const categoryLabel = categoryLabels[category] || category;
          const specificValue = adjustment.value || '';
          const combinedLabel = specificValue ? `${categoryLabel} - ${specificValue}` : categoryLabel;
          
          // No need to calculate cumulative value - use estimate.gross_market_value
          
          const typeDisplay = adjustment.type === 'plus' ? '×ª×•×¡×¤×ª' : '×”×¤×—×ª×”';
          
          adjustmentRows.push(`
            <tr>
              <td style="padding: 8px;">${combinedLabel}</td>
              <td style="padding: 8px; text-align: center;">${typeDisplay}</td>
              <td style="padding: 8px; text-align: center;">${percentDisplay}</td>
              <td style="padding: 8px; text-align: center;">${formatCurrency(amount)}</td>
            </tr>
          `);
        });
      });
      
      return `
        <div class="section adjustment-group">
          <div class="car-details">
            <div class="car-details-title">×—×™×©×•×‘ ×¢×¨×š ×”×©×•×§ ×©×œ ×”×¨×›×‘</div>
            <table class="car-details-table" style="width: 100%; max-width: 700px; margin: 0 auto;">
              <tr><th style="width: 40%;">×ª×™××•×¨</th><th style="width: 20%;">×ª×•×¡×¤×ª/×”×¤×—×ª×”</th><th style="width: 20%;">××—×•×–</th><th style="width: 20%;">×¢×¨×š</th></tr>
              <tr><td style="padding: 8px;">×¢×¨×š ×”×¨×›×‘ ×¢"×¤ ××—×™×¨×•×Ÿ ×›×•×œ×œ ××¢"×</td><td style="padding: 8px; text-align: center;">-</td><td style="padding: 8px; text-align: center;">-</td><td style="padding: 8px; text-align: center;">${formatCurrency(basePrice)}</td></tr>
              ${adjustmentRows.join('')}
              <tr><td colspan="3" style="padding: 8px; text-align: center;"><strong>×¢×¨×š ×”×©×•×§ ×©×œ ×”×¨×›×‘ ×›×•×œ×œ ××¢"×</strong></td><td style="padding: 8px; text-align: center;"><strong>${formatCurrency(totalValue)}</strong></td></tr>
            </table>
          </div>
        </div>
      `;
    }
    
    function generateDepreciationAnalysis(helper) {
      // Check both depreciation data sources
      const depreciation = helper.estimate?.depreciation || helper.expertise?.depreciation || helper.depreciation || {};
      const estimateDepreciation = helper.estimate_depreciation || {};
      
      // Get centers from estimate.depreciation.bulk_items (primary) and fallback sources
      const bulkItems = helper.estimate?.depreciation?.bulk_items || [];
      const centers = bulkItems.length > 0 ? 
                     bulkItems.map(item => ({
                       center_number: item.center_number || item.center || '',
                       damaged_part: item.damaged_part || item.part || '',
                       repair_type: item.repair_type || item.repair || '',
                       percent: item.percent || 0,
                       value: item.value || item.depreciation_value || 0,
                       center: item.center || item.location || ''
                     })) : 
                     // Fallback to legacy sources
                     depreciation.centers || 
                     (estimateDepreciation.bulk_items || []).map(item => ({
                       center_number: item.center || '',
                       damaged_part: item.damaged_part || item.part || '',
                       repair_type: item.repair_type || item.repair || '',
                       percent: item.percent || 0,
                       value: item.value || 0
                     })) || [];
      
      const globalPercent = helper.estimate?.depreciation?.globalDep1 || depreciation.global_percent || estimateDepreciation.global_percent || 0;
      const globalAmount = depreciation.global_amount || estimateDepreciation.global_value || 0;
      const marketValue = helper.calculations?.market_value || helper.expertise?.levi_report?.final_price || 0;
      
      if (!centers.length && !globalPercent) {
        return `
          <div class="section">
            <div class="car-details">
              <div class="car-details-title">×™×¨×™×“×ª ×¢×¨×š</div>
              <p style="text-align: center; padding: 20px;">×œ× × ××¦××• × ×ª×•× ×™ ×™×¨×™×“×ª ×¢×¨×š</p>
            </div>
          </div>
        `;
      }
      
      // Depreciation introduction
      const damageBlocks = helper.estimate?.damage_centers || helper.expertise?.damage_blocks || [];
      const damageWorkRows = damageBlocks.map((block, index) => `
        <tr>
          <td style="padding: 8px;">${block.location || block.center || block.name || `××•×§×“ ${index + 1}`}</td>
          <td style="padding: 8px;">
            ${[
              ...(block.repairs || []).map(r => r.name || r.description),
              ...(block.works || []).map(w => w.type || w.description)
            ].filter(item => item).join(', ')}
          </td>
        </tr>
      `).join('');
      
      // Individual depreciation centers
      const depreciationRows = centers.map((center, index) => `
        <tr>
          <td>${center.center_number || center.center || index + 1}</td>
          <td>${center.damaged_part || center.part || center.description || ''}</td>
          <td>${center.repair_type || center.repair || center.work || ''}</td>
          <td>${center.percent || '0'}%</td>
          <td>${formatCurrency(parseFloat((center.value || center.depreciation_value || '0').toString().replace(/[^\d.-]/g, '')) || 0)}</td>
        </tr>
      `).join('');
      
      return `
        <div class="section page-depreciation depreciation-group">
          <div class="car-details">
            <div class="car-details-title">×™×¨×™×“×ª ×¢×¨×š</div>
            <p style="font-size: 14px; font-weight: bold;">
              ××××¦××™ ×‘×“×™×§×ª× ×• ×¢×•×œ×” ×›×™ ×”×¨×›×‘ × ×¤×’×¢ ×•×”×™×” ×¦×•×¨×š ×‘×¢×‘×•×“×•×ª ×•×ª×™×§×•× ×™× ×”×‘××™×:
            </p>
            <table class="car-details-table" style="width: 100%; max-width: 700px; margin: 0 auto;">
              <tr><th style="width: 30%;">××•×§×“ × ×–×§</th><th style="width: 70%;">×¢×‘×•×“×•×ª / ×ª×™×§×•× ×™×</th></tr>
              ${damageWorkRows}
            </table>
            <p style="font-size: 14px; font-weight: bold;">
              ×× ×• ×‘×“×¢×” ×›×™ ×××¦××™× ××œ×” ×™×™×’×¨××• ×œ×”×¤×—×ª×•×ª ×¢×¨×›×• ×”××¡×—×¨×™ ×©×œ ×”×¨×›×‘ ×œ×¢×•××ª ×¨×›×‘ ×–×”×” ×××•×ª×• ×ª×•×¦×¨×ª, ×“×’× ×•×©× ×ª ×™×™×¦×•×¨ ×©×œ× ×¢×‘×¨ ×ª××•× ×•×ª ×“×¨×›×™×.
            </p>
          </div>

          <div class="car-details">
            <div class="car-details-title">×—×™×©×•×‘ ×™×¨×™×“×ª ×”×¢×¨×š ×©×œ ×”×¨×›×‘</div>
            <table class="car-details-table">
              <tr><th style="font-weight: bold;">××¡' ××•×§×“</th><th style="font-weight: bold;">×”×—×œ×§ ×”× ×™×–×•×§</th><th>××”×•×ª ×”×ª×™×§×•×Ÿ</th><th>% ×™×¨×™×“×ª ×¢×¨×š</th><th>×¢×¨×š ×‘-â‚ª</th></tr>
              ${depreciationRows}
            </table>
            <p style="font-size: 14px; font-weight: bold;">
              ×¢×¨×š ×”×©×•×§ ×©×œ ×”×¨×›×‘ ×”×™× ×• ${formatCurrency(marketValue)}×œ×¤×™ ×›×š, ×”×¤×™×¦×•×™ ×œ×™×¨×™×“×ª ×”×¢×¨×š ×™×”×™×”  ${globalPercent}% ××¢×¨×š ×”×©×•×§ ×©×œ ×”×¨×›×‘ ×›×•×œ×œ ××¢"× ×©××¡×ª×›× ×‘ ${formatCurrency(globalAmount)} ×©"×—
            </p>
          </div>
        </div>
      `;
    }


    function formatCurrency(amount) {
      return new Intl.NumberFormat('he-IL', {
        style: 'currency',
        currency: 'ILS',
        minimumFractionDigits: 0
      }).format(amount || 0);
    }

    // Global functions for buttons
    window.editEstimate = function() {
      window.location.href = 'estimate-builder.html';
    };

    window.previewEstimate = function() {
      window.print();
    };

    window.generateEstimateReport = async function() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      try {
        console.log('ğŸ”„ Starting estimate submission to Make.com...');
        
        // Get the current HTML content for the estimate
        const estimateContent = document.getElementById('estimate-output').innerHTML;
        
        const payload = {
          type: 'estimate',
          plate: helper.meta?.plate || '',
          owner: helper.meta?.client_name || '',
          helper: helper,
          estimate_type: helper.estimate_type || '××•×‘×“×Ÿ_×œ×”×œ×›×”',
          html_content: estimateContent,
          timestamp: new Date().toISOString(),
          calculations: helper.calculations || {}
        };

        console.log('ğŸ“‹ Payload being sent:', {
          type: payload.type,
          plate: payload.plate,
          owner: payload.owner,
          estimate_type: payload.estimate_type,
          timestamp: payload.timestamp,
          html_content_length: payload.html_content.length
        });

        // Use the SUBMIT_ESTIMATE webhook URL
        const webhookUrl = 'https://hook.eu2.make.com/7dvgi7patq0vlgbd53hjbjasf6tek16l';
        console.log('ğŸŒ Webhook URL:', webhookUrl);
        
        // Show loading message
        const originalAlert = window.alert;
        window.alert = () => {}; // Temporarily disable alerts
        
        console.log('ğŸ“¡ Sending request to Make.com...');
        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': '*/*'
          },
          body: JSON.stringify(payload)
        });
        
        console.log('ğŸ“¨ Response received:');
        console.log('- Status:', response.status);
        console.log('- Status Text:', response.statusText);
        console.log('- Headers:', Object.fromEntries(response.headers.entries()));
        
        // Restore alert function
        window.alert = originalAlert;
        
        if (response.status >= 200 && response.status < 300) {
          // Handle successful response
          let responseText = '';
          try {
            responseText = await response.text();
            console.log('ğŸ“„ Response body:', responseText || '(empty)');
          } catch (textError) {
            console.log('âš ï¸ Could not read response text:', textError.message);
          }
          
          console.log('âœ… Estimate submitted successfully to Make.com');
          
          // Mark estimate as finalized
          helper.meta = helper.meta || {};
          helper.meta.estimate_finalized = true;
          helper.meta.estimate_finalized_timestamp = new Date().toISOString();
          sessionStorage.setItem('helper', JSON.stringify(helper));
          
          alert('×“×•"×— ×”××•××“×Ÿ × ×©×œ×— ×œ×¢×™×‘×•×“ ×‘×”×¦×œ×—×”!\n\nMake.com ×™×¢×‘×“ ××ª ×”×“×•"×— ×•×™×¦×•×¨ PDF.\n×ª×§×‘×œ ×”×ª×¨××” ×›××©×¨ ×”×“×•"×— ×™×”×™×” ××•×›×Ÿ.');
          
          // Return to appropriate page based on entry mode
          const workflowMode = sessionStorage.getItem('workflowMode');
          if (workflowMode === 'centralized') {
            window.location.href = 'report-selection.html';
          } else {
            window.location.href = 'selection.html';
          }
        } else {
          // Handle HTTP error responses
          let errorText = '';
          try {
            errorText = await response.text();
          } catch (e) {
            errorText = 'Could not read error response';
          }
          
          console.error('âŒ HTTP Error Response:', {
            status: response.status,
            statusText: response.statusText,
            body: errorText
          });
          
          throw new Error(`Make.com webhook failed: ${response.status} ${response.statusText}\nResponse: ${errorText}`);
        }
      } catch (error) {
        console.error('âŒ Error submitting estimate to Make.com:', error);
        console.error('Error details:', {
          name: error.name,
          message: error.message,
          stack: error.stack
        });
        
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          alert('×©×’×™××ª ×¨×©×ª: ×œ× × ×™×ª×Ÿ ×œ×”×ª×—×‘×¨ ×œ-Make.com\n\n×× × ×‘×“×•×§:\n- ×—×™×‘×•×¨ ×”××™× ×˜×¨× ×˜\n- ×›×ª×•×‘×ª ×”-webhook ×‘-Make.com\n\n×¤×¨×˜×™ ×©×’×™××”: ' + error.message);
        } else {
          alert('×©×’×™××” ×‘×©×œ×™×—×ª ×”××•××“×Ÿ ×œ-Make.com ×œ×¢×™×‘×•×“\n\n×× × × ×¡×” ×©×•×‘ ××• ×¤× ×” ×œ×ª××™×›×” ×˜×›× ×™×ª.\n\n×¤×¨×˜×™ ×©×’×™××”: ' + error.message);
        }
      }
    };

    window.goHome = function() {
      const workflowMode = sessionStorage.getItem('workflowMode');
      if (workflowMode === 'centralized') {
        window.location.href = 'report-selection.html';
      } else {
        window.location.href = 'selection.html';
      }
    };

    window.exportToMake = async function(event) {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      const button = event.target;
      const originalText = button.textContent;
      
      try {
        // Show loading message
        button.textContent = 'ğŸ“¤ ××™×™×¦×...';
        button.disabled = true;
        
        // Get the generated HTML content for PDF generation (same as SUBMIT_FINAL_REPORT)
        const estimateContainer = document.getElementById('estimate-output');
        let cleanHTML = estimateContainer ? estimateContainer.innerHTML : '';
        
        // Clean HTML the same way as final report
        cleanHTML = cleanHTML
          .replace(/<div class="control-buttons no-print">[\s\S]*?<\/div>/g, '')
          .replace(/<div[^>]*style="[^"]*×˜×™×•×˜×” ×‘×œ×‘×“[^"]*"[^>]*>[\s\S]*?<\/div>/g, '')
          .replace(/<div[^>]*style="[^"]*position:fixed[^"]*×˜×™×•×˜×” ×‘×œ×‘×“[^"]*"[^>]*>[\s\S]*?<\/div>/g, '')
          .replace(/×˜×™×•×˜×” ×‘×œ×‘×“/g, '')
          .replace(/<button[\s\S]*?<\/button>/g, '')
          .replace(/<div[^>]*class="[^"]*no-print[^"]*"[^>]*>[\s\S]*?<\/div>/g, '');
        
        // Use the same format as SUBMIT_FINAL_REPORT for consistency with Make.com
        const payload = {
          html: cleanHTML,
          meta: {
            ...helper.meta || {},
            plate: helper.estimate?.vehicle?.plateNumber || helper.vehicle?.plate_number || helper.car_details?.plate || helper.meta?.plate?.replace(/-/g, '') || '',
            owner_name: helper.estimate?.client?.name || helper.client?.name || helper.car_details?.owner_name || helper.meta?.owner_name || ''
          },
          report_type: 'estimate',
          date: new Date().toISOString()
        };
        
        // Send to webhook with correct parameter order: (id, payload)
        const result = await sendToWebhook('SUBMIT_ESTIMATE', payload);
        
        if (result.success) {
          alert('âœ… ×”××•××“×Ÿ ×™×•×¦× ×‘×”×¦×œ×—×”');
        } else {
          alert('âŒ ×©×’×™××” ×‘×™×¦×•× ×”××•××“×Ÿ: ' + (result.error || '×©×’×™××” ×œ× ×™×“×•×¢×”'));
        }
      } catch (error) {
        console.error('Error exporting estimate:', error);
        alert('âŒ ×©×’×™××” ×‘×™×¦×•× ×”××•××“×Ÿ: ' + error.message);
      } finally {
        // Restore button
        button.textContent = originalText;
        button.disabled = false;
      }
    };

    // Validation function for testing
    function validateEstimateData() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Debug: Log the actual helper structure
      console.log('ğŸ” Debug - Current helper structure:', helper);
      console.log('ğŸ” Debug - Available top-level keys:', Object.keys(helper));
      if (helper.meta) console.log('ğŸ” Debug - meta keys:', Object.keys(helper.meta));
      if (helper.car_details) console.log('ğŸ” Debug - car_details keys:', Object.keys(helper.car_details));
      if (helper.general_info) console.log('ğŸ” Debug - general_info keys:', Object.keys(helper.general_info));
      if (helper.calculations) console.log('ğŸ” Debug - calculations keys:', Object.keys(helper.calculations));
      
      const validation = {
        valid: true,
        errors: [],
        warnings: []
      };
      
      // Check for plate number in multiple possible locations
      const plateNumber = helper.meta?.plate || helper.car_details?.plate || helper.general_info?.plate;
      if (!plateNumber) {
        validation.errors.push('××¡×¤×¨ ×¨×™×©×•×™ ×—×¡×¨');
        validation.valid = false;
      }
      
      // Check for client/owner name in multiple possible locations
      const clientName = helper.meta?.client_name || 
                        helper.general_info?.client_name || 
                        helper.general_info?.owner_name ||
                        helper.car_details?.owner ||
                        helper.owner_details?.name;
      if (!clientName) {
        validation.errors.push('×©× ×‘×¢×œ ×”×¨×›×‘ ×—×¡×¨');
        validation.valid = false;
      }
      
      // Check for vehicle manufacturer in multiple locations
      const manufacturer = helper.vehicle?.manufacturer || 
                          helper.car_details?.manufacturer ||
                          helper.car_details?.make;
      if (!manufacturer) {
        validation.warnings.push('×™×¦×¨×Ÿ ×¨×›×‘ ×—×¡×¨');
      }
      
      // Check for vehicle model in multiple locations
      const model = helper.vehicle?.model || 
                   helper.car_details?.model;
      if (!model) {
        validation.warnings.push('×“×’× ×¨×›×‘ ×—×¡×¨');
      }
      
      // Use unified estimate structure for damage calculations  
      const baseDamage = helper.estimate?.calculations?.total_damage_cost ||
                        helper.estimate?.totals?.damage_centers?.total_before_vat?.value ||
                        helper.calculations?.base_damage || 
                        helper.calculations?.total_damage ||
                        helper.calculations?.total_before_depreciation ||
                        helper.levi_report?.total_damage ||
                        helper.damage_calculation?.total;
      
      if (!baseDamage || baseDamage <= 0) {
        validation.errors.push('×—×™×©×•×‘ × ×–×§ ×‘×¡×™×¡×™ ×—×¡×¨ ××• ×©×’×•×™');
        validation.valid = false;
      }
      
      // Check for depreciation data
      const depreciationPercent = helper.estimate?.depreciation?.global_percent ||
                                 helper.depreciation?.global_percent || 
                                 helper.depreciation?.percentage ||
                                 helper.calculations?.depreciation_percent;
      if (!depreciationPercent) {
        validation.warnings.push('××—×•×– ×™×¨×™×“×ª ×¢×¨×š ×’×œ×•×‘×œ×™ ×—×¡×¨');
      }
      
      console.log('ğŸ” Validation results:', validation);
      console.log('ğŸ” Found values:', {
        plateNumber,
        clientName,
        manufacturer,
        model,
        baseDamage,
        depreciationPercent
      });
      
      return validation;
    }
    
    // Test print functionality
    function testPrintPreview() {
      console.log('ğŸ–¨ï¸ Testing print preview...');
      
      // Validation removed - allow printing without validation
      console.log('âœ… Print preview - validation requirement removed');
      
      // Test print functionality
      try {
        window.print();
        console.log('âœ… Print preview opened successfully');
        return true;
      } catch (error) {
        console.error('âŒ Print preview failed:', error);
        alert('×©×’×™××” ×‘×¤×ª×™×—×ª ×ª×¦×•×’×” ××§×“×™××” ×œ×”×“×¤×¡×”');
        return false;
      }
    }
    
    // Test webhook connectivity
    async function testWebhookConnection() {
      console.log('ğŸ”— Testing webhook connection...');
      
      const webhookUrl = 'https://hook.eu2.make.com/7dvgi7patq0vlgbd53hjbjasf6tek16l';
      
      try {
        const testPayload = {
          type: 'test',
          timestamp: new Date().toISOString(),
          message: 'Connection test from estimate builder'
        };
        
        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(testPayload)
        });
        
        if (response.ok) {
          console.log('âœ… Webhook connection successful');
          return true;
        } else {
          console.error('âŒ Webhook connection failed:', response.status, response.statusText);
          return false;
        }
      } catch (error) {
        console.error('âŒ Webhook connection error:', error);
        return false;
      }
    }
    
    // Update previewEstimate to use validation
    window.previewEstimate = function() {
      testPrintPreview();
    };
    
    // Smart validation dependencies based on access mode
    function checkAccessMode() {
      const currentUrl = window.location.href;
      const referrer = document.referrer;
      const workflowMode = sessionStorage.getItem('workflowMode');
      
      // Check URL parameters for expertise access
      const urlParams = new URLSearchParams(window.location.search);
      const fromExpertise = urlParams.get('from') === 'expertise';
      const skipValidation = urlParams.get('skipValidation') === 'true';
      const fromFinalReportBuilder = referrer.includes('final-report-builder') || sessionStorage.getItem('fromFinalReportBuilder') === 'true';
      
      // Check if report is finalized
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      const isFinalized = helper.meta?.finalized === true || helper.meta?.estimate_finalized === true;
      
      // If accessed from final-report-builder, expertise, or skip validation flags, show draft with watermark
      if (fromFinalReportBuilder || fromExpertise || skipValidation || referrer.includes('expertise') || workflowMode === 'draft_view' || !isFinalized) {
        console.log('âœ… Skipping validation - accessed from final report builder or other bypass mode');
        return 'draft'; // No validation required, read-only with watermark
      }
      
      // If accessed from estimate workflow and finalized, allow builder mode
      if (referrer.includes('estimate-') || workflowMode === 'estimate_builder') {
        return isFinalized ? 'final' : 'draft'; // Requires validation if not finalized
      }
      
      // Default to draft mode for safety (always show watermark until finalized)
      return 'draft';
    }
    
    // Real-time helper data watcher
    function startEstimateHelperWatcher() {
      let lastHelperData = sessionStorage.getItem('helper') || '{}';
      
      setInterval(() => {
        try {
          const currentHelperData = sessionStorage.getItem('helper') || '{}';
          
          if (currentHelperData !== lastHelperData) {
            console.log('ğŸ”„ Helper data changed, updating estimate report...');
            lastHelperData = currentHelperData;
            
            // Only auto-update if in draft mode
            const accessMode = checkAccessMode();
            if (accessMode === 'draft') {
              injectEstimateHTML();
            }
          }
        } catch (error) {
          console.warn('Error watching helper data:', error);
        }
      }, 1000);
      
      // Listen for helper update events
      window.addEventListener('helperUpdated', () => {
        console.log('ğŸ“¡ Helper update event received, refreshing estimate report');
        const accessMode = checkAccessMode();
        if (accessMode === 'draft') {
          injectEstimateHTML();
        }
      });
    }
    
    // Add draft watermark
    function addDraftWatermark() {
      const accessMode = checkAccessMode();
      if (accessMode === 'draft') {
        const watermark = document.createElement('div');
        watermark.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%) rotate(-45deg);
          font-size: 6rem;
          color: rgba(220, 38, 38, 0.1);
          z-index: 1000;
          pointer-events: none;
          font-weight: bold;
          white-space: nowrap;
        `;
        watermark.textContent = '×˜×™×•×˜×”';
        document.body.appendChild(watermark);
        
        // Also disable edit buttons in draft mode
        const buttons = document.querySelectorAll('.control-buttons button');
        buttons.forEach(button => {
          if (button.textContent.includes('×¢×¨×•×š') || button.textContent.includes('×”×¤×§')) {
            button.style.display = 'none';
          }
        });
      }
    }
    
    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
      console.log('ğŸ”„ Estimate Report Builder loaded and ready');
      
      const accessMode = checkAccessMode();
      console.log('ğŸ” Access mode detected:', accessMode);
      
      if (accessMode === 'builder') {
        console.log('âœ… Builder mode - validation requirement removed');
      }
      
      // Add draft watermark if in draft mode
      addDraftWatermark();
      
      // Start real-time helper watcher
      startEstimateHelperWatcher();
      
      // Run injection on load - validation dependency removed
      setTimeout(() => {
        console.log('âœ… Injecting content without validation requirements');
        injectEstimateHTML();
      }, 1000);
    });
  </script>
  
  <!-- Control buttons moved to end of page -->
  <div class="control-buttons no-print" style="margin-top: 40px;">
    <button class="btn-secondary" onclick="editEstimate()">âœï¸ ×¢×¨×•×š ××•××“×Ÿ</button>
    <button class="btn-primary" onclick="previewEstimate()">ğŸ‘ï¸ ×ª×¦×•×’×” ××§×“×™××”</button>
    <button class="btn-success" onclick="generateEstimateReport()">ğŸ“„ ×”×¤×§ ×“×•"×— ××•××“×Ÿ</button>
    <button class="btn-info" onclick="exportToMake(event)">ğŸ“¤ ×™×¦×•× ××•××“×Ÿ</button>
    <button class="btn-secondary" onclick="goHome()">ğŸ  ×—×–×•×¨ ×œ×“×£ ×”×‘×™×ª</button>
  </div>
  
  </div>
</body>
</html>