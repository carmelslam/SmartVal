<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <style>
    body {
      font-family: sans-serif;
      direction: rtl;
      margin: 20px;
    }
    h1, h2, h3 {
      color: #003366;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      border: 3px solid #003366 !important;
    }
    th, td {
      padding: 8px;
      text-align: right;
      border: 1px solid #aaa;
    }
    th {
      color: #003366 !important;
      background: #fff8e1 !important;
      border-bottom: 3px solid #003366 !important;
      text-align: center !important;
    }
    .section {
      margin-bottom: 30px;
      page-break-after: always;
    }
    .signature-stamp {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 40px;
    }
    .signature-stamp img {
      height: 100px;
    }
    .signature-stamp .center-text {
      flex-grow: 1;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
    }
    .car-details {
      border: 2px solid #000;
      border-radius: 25px;
      padding: 20px;
      margin-bottom: 40px;
    }
    .car-details-title {
      color: #003366;
      font-weight: bold;
      font-size: 20px;
      text-align: center;
      margin-bottom: 20px;
    }
    .car-details-table {
      width: 100%;
      border: none;
      font-size: 16px;
    }
    .car-details-table td {
      padding: 5px 10px;
    }
    .intellectual-box {
      border: 2px solid #000;
      padding: 15px;
      font-size: 16px;
      font-weight: bold;
      margin-top: 15px;
    }
    .buttons {
      text-align: center;
      margin-top: 40px;
    }
    .buttons button {
      padding: 10px 20px;
      margin: 0 10px;
      font-size: 16px;
      cursor: pointer;
    }
    .estimate-header {
      background: linear-gradient(135deg, #1e3a8a 0%, #475569 100%);
      color: white !important;
      padding: 30px;
      text-align: center;
      margin-bottom: 30px;
      border-radius: 15px;
    }
    .estimate-header h1, .estimate-header h2, .estimate-header h3 {
      color: white !important;
      margin: 10px 0;
    }
    .estimate-disclaimer {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      font-weight: bold;
      text-align: center;
    }
    .estimate-totals {
      background: #e8f5e8;
      border: 2px solid #28a745;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }
    .control-buttons {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin: 30px 0;
    }
    .control-buttons button {
      margin: 0 10px;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
    }
    .btn-primary {
      background: #007bff;
      color: white;
    }
    .btn-success {
      background: #28a745;
      color: white;
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    .btn-primary:hover {
      background: #0056b3;
    }
    .btn-success:hover {
      background: #218838;
    }
    .btn-secondary:hover {
      background: #545b62;
    }
    
    /* Print Styles for A4 Format */
    @media print {
      @page {
        size: A4;
        margin: 25mm 20mm 25mm 20mm;
      }
      
      body {
        font-family: sans-serif;
        font-size: 12pt;
        line-height: 1.4;
        color: #000;
        background: white;
        margin: 0;
        padding: 0;
      }
      
      /* Hide control elements */
      .no-print,
      .control-buttons,
      .estimate-header,
      .estimate-disclaimer {
        display: none !important;
      }
      
      /* Optimize tables for print */
      table {
        width: 100% !important;
        max-width: 100% !important;
        border-collapse: collapse !important;
        page-break-inside: avoid;
        font-size: 10pt;
      }
      
      th, td {
        padding: 4px 6px !important;
        border: 1px solid #000 !important;
        font-size: 10pt;
        word-wrap: break-word;
      }
      
      th {
        background: #f0f0f0 !important;
        font-weight: bold;
        text-align: center !important;
      }
      
      /* Section formatting */
      .section {
        page-break-inside: avoid;
        margin-bottom: 15mm;
      }
      
      .car-details {
        border: 1px solid #000;
        border-radius: 0;
        padding: 8mm;
        margin-bottom: 10mm;
        page-break-inside: avoid;
      }
      
      .car-details-title {
        font-size: 14pt;
        font-weight: bold;
        margin-bottom: 6mm;
        text-align: center;
      }
      
      /* Signature section */
      .signature-stamp {
        page-break-inside: avoid;
        margin-top: 20mm;
      }
      
      .signature-stamp img {
        max-height: 40mm;
        max-width: 60mm;
      }
      
      /* Ensure no orphaned content */
      h1, h2, h3 {
        page-break-after: avoid;
        font-size: 14pt;
        margin: 8mm 0 4mm 0;
      }
      
      p {
        orphans: 2;
        widows: 2;
        font-size: 11pt;
      }
      
      /* Hide print button and navigation */
      button {
        display: none !important;
      }
      
      /* Ensure content fits within margins */
      .report-content {
        max-width: 100%;
        overflow: hidden;
      }
      
      .estimate-totals {
        background: #f5f5f5 !important;
        border: 1px solid #000 !important;
        padding: 6mm;
        margin: 8mm 0;
      }
      
      .intellectual-box {
        border: 1px solid #000;
        padding: 6mm;
        margin: 8mm 0;
      }
      
      /* Professional header spacing */
      .report-header {
        margin-bottom: 8mm;
        padding: 4mm;
      }
      
      /* Ensure consistent spacing between sections */
      .car-details + .car-details {
        margin-top: 6mm;
      }
      
      /* Professional table spacing */
      .car-details-table {
        margin-bottom: 4mm;
      }
      
      /* Signature area proper spacing */
      .signature-stamp {
        margin-top: 15mm;
        margin-bottom: 10mm;
      }
      
      /* Fix text alignment for professional appearance */
      .center-text {
        text-align: center;
        font-size: 12pt;
        margin: 6mm 0;
      }
      
      /* Ensure proper page breaks */
      .estimate-totals {
        page-break-inside: avoid;
      }
      
      /* Better spacing for legal text */
      .legal-text {
        margin: 8mm 0;
        line-height: 1.6;
      }
    }
  </style>
  <script src="./math-preview.js"></script>
</head>
<body>
  <div class="estimate-header">
    <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo" style="width: 80px; margin-bottom: 15px;">
    <h1>×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×¤×•×¨×˜×œ</h1>
    <h2>×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</h2>
    <h3>×‘×•× ×” ×“×•"×— ××•××“×Ÿ</h3>
  </div>

  <div class="estimate-disclaimer">
    <h3>×”×•×“×¢×” ×—×©×•×‘×” - ××•××“×Ÿ ×‘×œ×‘×“</h3>
    <p>××¡××š ×–×” ×”×™× ×• ××•××“×Ÿ ×¨××©×•× ×™ ×‘×œ×‘×“ ×•××™× ×• ××”×•×•×” ×”×ª×—×™×™×‘×•×ª ×›×¡×¤×™×ª ××• ×—×•×–×™×ª ××›×œ ×¡×•×’ ×©×”×•×.</p>
    <p>×”×¢×¨×›×™× ×”×¡×•×¤×™×™× ×¢×©×•×™×™× ×œ×”×©×ª× ×•×ª ×‘×”×ª×× ×œ×ª×•×¦××•×ª ×”×‘×™×¦×•×¢ ×‘×¤×•×¢×œ ×•×œ×—×©×‘×•× ×™×•×ª ×”×¡×•×¤×™×•×ª.</p>
  </div>

  <div class="control-buttons no-print">
    <button class="btn-secondary" onclick="editEstimate()">âœï¸ ×¢×¨×•×š ××•××“×Ÿ</button>
    <button class="btn-primary" onclick="previewEstimate()">ğŸ‘ï¸ ×ª×¦×•×’×” ××§×“×™××”</button>
    <button class="btn-success" onclick="generateEstimateReport()">ğŸ“„ ×”×¤×§ ×“×•"×— ××•××“×Ÿ</button>
    <button class="btn-secondary" onclick="goHome()">ğŸ  ×—×–×•×¨ ×œ×“×£ ×”×‘×™×ª</button>
  </div>

  <div id="estimate-output" class="report-content"></div>

  <div id="template-html">
   
  <!-- Section 1 - Header -->
  <div class="report-header">
    <div class="car-details-title">{{helper.report_title}}</div>
    <table style="width: 100%; margin-top: 10px;">
      <tr>
        <td style="width: 40%; text-align: right;">
          <p>×œ×›×‘×•×“:<br>{{meta.client_name}}<br>{{meta.address}}</p>
        </td>
        <td style="width: 20%;"></td>
        <td style="width: 40%; text-align: right;">
          <p>×ª××¨×™×š: {{meta.today}}</p>
          <p>×ª×™×§ ××¡×¤×¨: {{helper.file_number}}</p>
          <p>×¢×•×¡×§ ××•×¨×©×”: {{helper.business_license}}</p>
        </td>
      </tr>
    </table>
  </div>

  <div class="car-details">
    <div class="car-details-title">{{helper.estimate_details_title}}</div> 
    <table class="car-details-table">
    <tbody>
      <tr>
        <td><strong>×‘×¢×œ ×”×¨×›×‘:</strong> {{meta.client_name}}</td>
        <td><strong>×“×’×:</strong> {{helper.vehicle.model}}</td>
      </tr>
      <tr>
        <td><strong>××¡×¤×¨ ×˜×œ×¤×•×Ÿ:</strong> {{meta.phone_number}}</td>
        <td><strong>××¡×¤×¨ ×©×œ×“×”:</strong> {{helper.vehicle.chassis}}</td>
      </tr>
      <tr>
        <td><strong>×ª××¨×™×š ×”×‘×“×™×§×”:</strong> {{meta.inspection_date}}</td>
        <td><strong>×©× ×ª ×™×¦×•×¨:</strong> {{helper.vehicle.year}}</td>
      </tr>
      <tr>
        <td><strong>××§×•× ×”×‘×“×™×§×”:</strong> {{meta.location}}</td>
        <td><strong>××“ ×§"×:</strong> {{helper.vehicle.km}}</td>
      </tr>
      <tr>
        <td><strong>××¡×¤×¨ ×¨×™×©×•×™:</strong> {{meta.plate}}</td>
        <td><strong>×¡×•×’ ×”×¨×›×‘:</strong> {{helper.vehicle.ownership_type}}</td>
      </tr>
      <tr>
        <td><strong>×™×¦×¨×Ÿ:</strong> {{helper.vehicle.manufacturer}}</td>
        <td><strong>×¡×•×’ ×”× ×–×§:</strong> {{meta.damage}}</td>
      </tr>
    </tbody>
    </table>
  </div>

  <!-- Section 2 - Estimate Introduction -->
  <div class="section" style="page-break-before: always;">
    <p style="font-size: 16px;">
      ×‘×”×ª×× ×œ×‘×§×©×ª×›×, ×¢×¨×›× ×• ××•××“×Ÿ ×¨××©×•× ×™ ×œ×¢×œ×•×™×•×ª ×ª×™×§×•×Ÿ × ×–×§×™ ×”×¨×›×‘ ×”× ×“×•×Ÿ ×›×¤×™ ×©×”×•×¦×’×• ×œ×¤× ×™× ×•.
    </p>
    <p style="font-size: 16px; font-weight: bold; text-decoration: underline;">×ª×™××•×¨ ×”× ×–×§:</p>
    <p style="font-size: 16px;">
      {{helper.damage.description}}
    </p>
    <p style="font-size: 16px; font-weight: bold; text-decoration: underline;">××•××“×Ÿ ×¢×œ×•×™×•×ª:</p>
    <p style="font-size: 16px;">
      ×”××•××“×Ÿ ××‘×•×¡×¡ ×¢×œ ××—×™×¨×™ ×©×•×§ × ×•×›×—×™×™× ×•×¢×œ ×‘×“×™×§×” ×¨××©×•× ×™×ª ×©×œ ×”× ×–×§×™×. ×¢×œ×•×™×•×ª ×¡×•×¤×™×•×ª ×¢×©×•×™×•×ª ×œ×”×©×ª× ×•×ª.
    </p>
  </div>

  <!-- Section 3 - Damage Breakdown -->
  <div class="section">
    {{#each helper.damage_blocks}}
      <div class="car-details">
        <div class="car-details-title">××•××“×Ÿ ××•×§×“ {{this.label}}</div>
        {{{this.table}}}
      </div>
    {{/each}}
  </div>

  <!-- Section 4 - Summary Table -->
  {{#if (gt (length helper.damage_blocks) 1)}}
  <div class="section">
    <div class="car-details">
      <div class="car-details-title">×¡×™×›×•× ××•××“×Ÿ ×œ×¤×™ ××•×§×“×™×</div>
      <table class="car-details-table">
        <thead>
          <tr>
            <th>××•×§×“</th>
            <th>××•××“×Ÿ ×¢×œ×•×ª</th>
          </tr>
        </thead>
        <tbody>
          {{#each helper.damage_summary}}
          <tr>
            <td>{{this.label}}</td>
            <td>{{money this.total}}</td>
          </tr>
          {{/each}}
          <tr>
            <td><strong>×¡×”"×› ××•××“×Ÿ ×›×œ×œ ×”××•×§×“×™× ×›×•×œ×œ ××¢"×</strong></td>
            <td><strong>{{money helper.damage_total}}</strong></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  {{/if}}

  <!-- Section 4.5 - Levi Adjustments (bulk two) - EXACT COPY FROM FINAL REPORT BUILDER -->
  <div class="section">
    <div class="car-details">
      <div class="car-details-title">××—×•×– ×”× ×–×§ ×”×’×•×œ××™</div>
      <table class="car-details-table">
        <tr><th>×ª×™××•×¨</th><th>×¢×¨×š</th></tr>
        <tr><td>×¡×”"×› ×”× ×–×§ ×›×•×œ×œ ××¢"×</td><td>{{money helper.calculations.total_damage}}</td></tr>
        <tr><td>×¢×¨×š ×”×¨×›×‘ ×œ× ×–×§ ×’×•×œ××™ ×›×•×œ×œ ××¢"×</td><td>{{money helper.calculations.vehicle_value_gross}}</td></tr>
        <tr><td><strong>××—×•×– ×”× ×–×§ ×”×’×•×œ××™</strong></td><td><strong>{{percent helper.calculations.damage_percent}}</strong></td></tr>
      </table>
    </div>
  </div>

  <!-- Section 4.6 - Levi Adjustments (bulk three) - EXACT COPY FROM FINAL REPORT BUILDER -->
  <div class="section">
    <div class="car-details">
      <div class="car-details-title">×—×™×©×•×‘ ×¢×¨×š ×”×©×•×§ ×©×œ ×”×¨×›×‘</div>
      <table class="car-details-table">
        <tr><th>×ª×™××•×¨</th><th>×¢×¨×š</th></tr>
        <tr><td>×¢×¨×š ×”×¨×›×‘ ×¢"×¤ ××—×™×¨×•×Ÿ ×›×•×œ×œ ××¢"×</td><td>{{money helper.vehicle_value_base}}</td></tr>
        {{#each helper.levi.adjustments}}
          <tr><td>{{this.label}}</td><td>{{money this.amount}}</td></tr>
        {{/each}}
        <tr><td><strong>×¢×¨×š ×”×©×•×§ ×©×œ ×”×¨×›×‘ ×›×•×œ×œ ××¢"×</strong></td><td><strong>{{money helper.calculations.market_value}}</strong></td></tr>
      </table>
    </div>
  </div>

  <!-- Section 4.7 - Depreciation Opening Block - EXACT COPY FROM FINAL REPORT BUILDER -->
  <div class="section">
    <div class="car-details">
      <div class="car-details-title">×™×¨×™×“×ª ×¢×¨×š</div>
      <p style="font-size: 18px; font-weight: bold;">
        ××××¦××™ ×‘×“×™×§×ª× ×• ×¢×•×œ×” ×›×™ ×”×¨×›×‘ × ×¤×’×¢ ×•×”×™×” ×¦×•×¨×š ×‘×¢×‘×•×“×•×ª ×•×ª×™×§×•× ×™× ×”×‘××™×:
      </p>
      <table class="car-details-table">
        <tr><th>××•×§×“ × ×–×§</th><th>×¢×‘×•×“×•×ª / ×ª×™×§×•× ×™×</th></tr>
        {{#each helper.damage_blocks}}
          <tr>
            <td>{{this.center}}</td>
            <td>
              {{#each this.repairs}}{{this}}, {{/each}}
              {{#each this.works}}{{this}}, {{/each}}
            </td>
          </tr>
        {{/each}}
      </table>
      <p style="font-size: 18px; font-weight: bold;">
        ×× ×• ×‘×“×¢×” ×›×™ ×××¦××™× ××œ×” ×™×™×’×¨××• ×œ×”×¤×—×ª×•×ª ×¢×¨×›×• ×”××¡×—×¨×™ ×©×œ ×”×¨×›×‘ ×œ×¢×•××ª ×¨×›×‘ ×–×”×” ×××•×ª×• ×ª×•×¦×¨×ª, ×“×’× ×•×©× ×ª ×™×™×¦×•×¨ ×©×œ× ×¢×‘×¨ ×ª××•× ×•×ª ×“×¨×›×™×.
      </p>
    </div>
  </div>

  <!-- Section 4.6 - Depreciation Bulk 2 - EXACT COPY FROM FINAL REPORT BUILDER -->
  <div class="section">
    <div class="car-details">
      <div class="car-details-title">×—×™×©×•×‘ ×™×¨×™×“×ª ×”×¢×¨×š ×©×œ ×”×¨×›×‘</div>
      <table class="car-details-table">
        <tr><th>×”×—×œ×§ ×”× ×™×–×•×§</th><th>××”×•×ª ×”×ª×™×§×•×Ÿ</th><th>% ×™×¨×™×“×ª ×¢×¨×š</th><th>×¢×¨×š ×‘×©"×—</th><th>××•×§×“</th></tr>
        {{#each helper.expertise.depreciation.centers}}
          <tr>
            <td>{{this.part}}</td>
            <td>{{this.repair}}</td>
            <td>{{percent this.percent}}</td>
            <td>{{money this.depreciation_value}}</td>
            <td>{{this.center}}</td>
          </tr>
        {{/each}}
      </table>
      <p style="font-size: 18px; font-weight: bold;">
        ×¢×¨×š ×”×©×•×§ ×©×œ ×”×¨×›×‘ ×”×™× ×• {{money helper.calculations.market_value}} ×©"×— ×›×•×œ×œ ××¢"×, ×œ×¤×™×›×š ×”×¤×™×¦×•×™ ×œ×™×¨×™×“×ª ×”×¢×¨×š ×™×”×™×” {{percent helper.depreciation.global_percent}} = {{money helper.depreciation.global_amount}} ×©"×—
      </p>
    </div>
  </div>

  <!-- Section 5 - Estimate Totals Summary (Combined with Green Styling) -->
  <div class="section">
    <div class="estimate-totals">
      <div class="car-details-title">×¡×™×›×•× ×”××•××“×Ÿ</div>
      <table class="car-details-table">
        <tr>
          <th>×¡×¢×™×£</th>
          <th>×©×•×•×™</th>
        </tr>
        <tr>
          <td>×¡×”"×› ××•××“×Ÿ × ×–×§×™×</td>
          <td>{{money helper.calculations.base_damage}}</td>
        </tr>
        <tr>
          <td>×¤×™×¦×•×™ ×‘×’×™×Ÿ ×™×¨×™×“×ª ×¢×¨×š</td>
          <td>{{money helper.depreciation.global_amount}}</td>
        </tr>
        <tr>
          <td>××¢"× ({{helper.calculations.vat_rate}}%)</td>
          <td>{{money helper.calculations.vat_amount}}</td>
        </tr>
        <tr>
          <td><strong>×¡×”"×› × ×›×œ×œ ×‘××•××“×Ÿ</strong></td>
          <td><strong>{{money helper.calculations.total_compensation}}</strong></td>
        </tr>
      </table>
    </div>
  </div>

  <!-- Section 6 - Legal Text and Disclaimers - ESTIMATE SPECIFIC -->
  <div class="section">
    <div style="font-size: 16px; line-height: 1.8;">
      <strong>×”×¢×¨×•×ª ×—×©×•×‘×•×ª ×œ×’×‘×™ ×”××•××“×Ÿ:</strong><br>
      {{lookup vault.estimate_××•×‘×“×Ÿ_×œ×”×œ×›×” helper.estimate_type}}<br><br>

      <strong>×”×¦×”×¨×ª ×©×××™:</strong><br>
      ×× ×™ ×”×—×ª"×: ×™×¨×•×Ÿ ×›×™×•×£, ×ª×¢×•×“×ª ×©×××™ ××¡' 1097. ×”× × ×™ × ×•×ª×Ÿ ××ª ×—×•×•×ª ×“×¢×ª×™ ×–×• ×‘××§×•× ×¢×“×•×ª ×‘×©×‘×•×¢×” ×‘×‘×™×ª ××©×¤×˜. ×”×“×™×Ÿ ×©×œ ×—×•×•×ª ×“×¢×ª ×–×• ×”×•× ×›×“×™×Ÿ ×¢×“×•×ª ×‘×©×‘×•×¢×”.<br><br>

      <div class="estimate-disclaimer">
        <strong>××•××“×Ÿ ×–×” ×”×™× ×• ×”×¢×¨×›×” ×¨××©×•× ×™×ª ×‘×œ×‘×“ ×•××™× ×• ××”×•×•×” ×”×ª×—×™×™×‘×•×ª ×›×¡×¤×™×ª.</strong><br>
        ×”×¢×œ×•×™×•×ª ×”×¡×•×¤×™×•×ª ×¢×©×•×™×•×ª ×œ×”×©×ª× ×•×ª ×‘×”×ª×× ×œ×ª×•×¦××•×ª ×”×‘×™×¦×•×¢ ×‘×¤×•×¢×œ, ×–××™× ×•×ª ×—×œ×§×™× ×•×ª× ××™ ×”×©×•×§.
      </div>
    </div>
  </div>

  <!-- Section 7 - Signature -->
  <div class="signature-stamp" style="margin-top: 40px;">
    <div class="center-text" style="font-size: 18px; font-weight: bold;">×‘×›×‘×•×“ ×¨×‘,</div>
  </div>

  <div style="margin-top: 40px; text-align: left;">
    <br><br>
    <img src="https://carmelcayouf.com/wp-content/uploads/2025/04/yaron-signature-transparent-.webp" alt="×—×ª×™××”" style="height: 160px;">
  </div>
  
  <div style="margin-top: 20px; text-align: center;">
    <p><strong>×™×¨×•×Ÿ ×›×™×•×£ - ×©×××™ ××•×¨×©×” ××¡' 1097</strong></p>
    <p>×™×¨×•×Ÿ ×›×™×•×£ - ×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</p>
  </div>

  <div id="math-preview" style="margin-top: 20px;"></div>
  </div>

  <script type="module">
    import { helper, updateHelper } from './helper.js';
    import { MathEngine } from './math.js';
    import { sendToWebhook } from './webhook.js';
    import { getVehicleData, getDamageData } from './helper.js';

    // Authentication and data validation
    document.addEventListener('DOMContentLoaded', () => {
      console.log('ğŸ”„ Estimate Report Builder: Initializing...');
      
      const auth = sessionStorage.getItem("auth");
      if (!auth) {
        console.error('âŒ No authentication found');
        alert("×”×’×™×©×” ×—×¡×•××” - ×× × ×”×ª×—×‘×¨ ×“×¨×š ×“×£ ×”×‘×™×ª");
        window.location.href = "index.html";
        return;
      }

      const helperData = sessionStorage.getItem('helper');
      const selectedReportType = sessionStorage.getItem('selectedReportType');
      const validationCompleted = sessionStorage.getItem('estimateValidationCompleted');
      
      if (!helperData || selectedReportType !== 'estimate') {
        console.error('âŒ Missing required data for estimate report builder');
        alert('×©×’×™××”: × ×ª×•× ×™× ×—×¡×¨×™× ×œ×‘× ×™×™×ª ××•××“×Ÿ. ×—×•×–×¨ ×œ×“×£ ×”×‘×—×™×¨×”...');
        window.location.href = 'selection.html';
        return;
      }

      if (!validationCompleted) {
        console.warn('âš ï¸ Validation not completed, redirecting to validation');
        alert('×™×© ×œ×”×©×œ×™× ×ª×—×™×œ×” ××ª ×ª×”×œ×™×š ×”××™××•×ª');
        window.location.href = 'estimate-validation.html';
        return;
      }

      console.log('âœ… Estimate Report Builder: All validations passed');
      initializeEstimateBuilder();
    });

    function initializeEstimateBuilder() {
      loadEstimateData();
      injectEstimateHTML();
    }

    function loadEstimateData() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Ensure basic structure exists
      helper.meta = helper.meta || {};
      helper.vehicle = helper.vehicle || helper.car_details || {};
      helper.calculations = helper.calculations || {};
      helper.damage_sections = helper.damage_sections || [];
      helper.expertise = helper.expertise || {};
      helper.depreciation = helper.depreciation || {};
      
      // Ensure meta fields have defaults
      helper.meta.client_name = helper.meta.client_name || helper.meta.owner || '';
      helper.meta.plate = helper.meta.plate || '';
      helper.meta.inspection_date = helper.meta.inspection_date || new Date().toLocaleDateString('he-IL');
      helper.meta.location = helper.meta.location || '';
      helper.meta.damage = helper.meta.damage || '';
      helper.meta.address = helper.meta.address || '';
      helper.meta.phone_number = helper.meta.phone_number || '';
      
      // Ensure vehicle fields have defaults
      helper.vehicle.manufacturer = helper.vehicle.manufacturer || '';
      helper.vehicle.model = helper.vehicle.model || '';
      helper.vehicle.year = helper.vehicle.year || '';
      helper.vehicle.chassis = helper.vehicle.chassis || helper.vehicle.vin || '';
      helper.vehicle.km = helper.vehicle.km || '';
      helper.vehicle.ownership_type = helper.vehicle.ownership_type || '';
      
      // Ensure helper template fields have defaults
      helper.report_title = helper.report_title || '××•××“×Ÿ × ×–×§×™ ×¨×›×‘';
      helper.file_number = helper.file_number || `YC/${helper.meta.plate || 'XXXXX'}/2025`;
      helper.business_license = helper.business_license || '02921217';
      helper.estimate_details_title = helper.estimate_details_title || '×¤×¨×˜×™ ×”×¨×›×‘ ×”× ×‘×“×§';
      
      // Ensure estimate calculations are up to date
      if (!helper.calculations || !helper.calculations.total_estimate) {
        calculateEstimateTotals(helper);
      }
      
      // Update session storage with processed data
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      console.log('âœ… Estimate data loaded and processed:', helper);
    }

    function calculateEstimateTotals(helper) {
      // Get base damage from expertise or validation
      const baseDamage = helper.expertise?.calculations?.base_damage || 
                        helper.damage_sections?.reduce((total, section) => {
                          return total + (section.works_total || 0) + (section.parts_total || 0) + (section.repairs_total || 0);
                        }, 0) || 0;

      // Get VAT rate from helper, not from external source
      const vatRate = helper.calculations?.vat_rate || helper.fees?.vat_rate || helper.vat_rate || 18;
      const vatAmount = Math.round(baseDamage * vatRate / 100);
      const totalEstimate = baseDamage + vatAmount;

      // Update helper with calculations
      helper.calculations = helper.calculations || {};
      helper.calculations.base_damage = baseDamage;
      helper.calculations.vat_rate = vatRate;
      helper.calculations.vat_amount = vatAmount;
      helper.calculations.total_estimate = totalEstimate;
      
      // Calculate depreciation values
      calculateDepreciationValues(helper);
    }

    function calculateDepreciationValues(helper) {
      // Get market value from helper
      const marketValue = helper.calculations?.market_value || 
                         helper.vehicle_value_base || 
                         helper.levi?.market_value || 0;

      // Calculate depreciation values for each center
      if (helper.expertise?.depreciation?.centers) {
        helper.expertise.depreciation.centers.forEach(center => {
          const percent = parseFloat(center.percent) || 0;
          center.depreciation_value = Math.round(marketValue * percent / 100);
        });
      }

      // Calculate global depreciation
      if (helper.depreciation) {
        const globalPercent = parseFloat(helper.depreciation.global_percent) || 0;
        helper.depreciation.global_amount = Math.round(marketValue * globalPercent / 100);
      }
    }

    function injectEstimateHTML() {
      const container = document.getElementById("estimate-output");
      if (!container) return;

      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      if (!helper || !helper.meta) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #dc2626;">
            <h3>×©×’×™××”: × ×ª×•× ×™ ×”×ª×™×§ ×œ× × ××¦××•</h3>
            <p>×× × ×—×–×•×¨ ×œ×“×£ ×”×‘×—×™×¨×” ×•×˜×¢×Ÿ ××ª ×”×ª×™×§ ××—×“×©</p>
            <button onclick="window.location.href='selection.html'" class="btn-secondary">×—×–×•×¨ ×œ×“×£ ×”×‘×™×ª</button>
          </div>
        `;
        return;
      }

      try {
        // Get template and inject data
        const template = document.getElementById('template-html').innerHTML;
        
        // Simple template replacement for estimate data
        let html = template;
        
        // Replace meta data
        html = html.replace(/\{\{meta\.client_name\}\}/g, helper.meta.client_name || '');
        html = html.replace(/\{\{meta\.address\}\}/g, helper.meta.address || '');
        html = html.replace(/\{\{meta\.today\}\}/g, new Date().toLocaleDateString('he-IL'));
        html = html.replace(/\{\{meta\.plate\}\}/g, helper.meta.plate || '');
        html = html.replace(/\{\{meta\.phone_number\}\}/g, helper.meta.phone_number || '');
        html = html.replace(/\{\{meta\.inspection_date\}\}/g, helper.meta.inspection_date || '');
        html = html.replace(/\{\{meta\.location\}\}/g, helper.meta.location || '');
        html = html.replace(/\{\{meta\.damage\}\}/g, helper.meta.damage || '');
        
        // Replace helper template placeholders
        html = html.replace(/\{\{helper\.report_title\}\}/g, helper.report_title || '××•××“×Ÿ × ×–×§×™ ×¨×›×‘');
        html = html.replace(/\{\{helper\.file_number\}\}/g, helper.file_number || `YC/${helper.meta.plate || 'XXXXX'}/2025`);
        html = html.replace(/\{\{helper\.business_license\}\}/g, helper.business_license || '02921217');
        html = html.replace(/\{\{helper\.estimate_details_title\}\}/g, helper.estimate_details_title || '×¤×¨×˜×™ ×”×¨×›×‘ ×”× ×‘×“×§');
        
        // Replace vehicle data
        const vehicle = helper.vehicle || helper.car_details || {};
        html = html.replace(/\{\{helper\.vehicle\.model\}\}/g, vehicle.model || '');
        html = html.replace(/\{\{helper\.vehicle\.chassis\}\}/g, vehicle.chassis || '');
        html = html.replace(/\{\{helper\.vehicle\.year\}\}/g, vehicle.year || '');
        html = html.replace(/\{\{helper\.vehicle\.km\}\}/g, vehicle.km || '');
        html = html.replace(/\{\{helper\.vehicle\.ownership_type\}\}/g, vehicle.ownership_type || '');
        html = html.replace(/\{\{helper\.vehicle\.manufacturer\}\}/g, vehicle.manufacturer || '');
        
        // Replace damage description
        const damage = helper.damage || helper.expertise?.damage || {};
        html = html.replace(/\{\{helper\.damage\.description\}\}/g, damage.description || '×ª×™××•×¨ × ×–×§ ×œ× ×–××™×Ÿ');
        
        // Replace calculations
        const calc = helper.calculations || {};
        html = html.replace(/\{\{money helper\.calculations\.base_damage\}\}/g, formatCurrency(calc.base_damage || 0));
        html = html.replace(/\{\{helper\.calculations\.vat_rate\}\}/g, calc.vat_rate || 18);
        html = html.replace(/\{\{money helper\.calculations\.vat_amount\}\}/g, formatCurrency(calc.vat_amount || 0));
        html = html.replace(/\{\{money helper\.calculations\.total_estimate\}\}/g, formatCurrency(calc.total_estimate || 0));
        html = html.replace(/\{\{money helper\.calculations\.market_value\}\}/g, formatCurrency(calc.market_value || 0));
        html = html.replace(/\{\{money helper\.calculations\.total_damage\}\}/g, formatCurrency(calc.total_damage || calc.base_damage || 0));
        html = html.replace(/\{\{money helper\.calculations\.vehicle_value_gross\}\}/g, formatCurrency(calc.vehicle_value_gross || calc.market_value || 0));
        html = html.replace(/\{\{percent helper\.calculations\.damage_percent\}\}/g, (calc.damage_percent || '0') + '%');
        html = html.replace(/\{\{money helper\.calculations\.total_compensation\}\}/g, formatCurrency(calc.total_compensation || calc.total_estimate || 0));
        
        // Replace damage blocks (simplified for estimate)
        if (helper.damage_sections && helper.damage_sections.length > 0) {
          const damageBlocksHTML = helper.damage_sections.map((section, index) => `
            <div class="car-details">
              <div class="car-details-title">××•××“×Ÿ ××•×§×“ ${index + 1}: ${section.zone || '×œ× ××•×’×“×¨'}</div>
              <table class="car-details-table">
                <tr><th>×¡×•×’</th><th>×ª×™××•×¨</th><th>××•××“×Ÿ ×¢×œ×•×ª</th></tr>
                <tr><td>×¢×‘×•×“×•×ª</td><td>${section.works?.length || 0} ×¤×¨×™×˜×™×</td><td>${formatCurrency(section.works_total || 0)}</td></tr>
                <tr><td>×—×œ×§×™×</td><td>${section.parts?.length || 0} ×¤×¨×™×˜×™×</td><td>${formatCurrency(section.parts_total || 0)}</td></tr>
                <tr><td>×ª×™×§×•× ×™×</td><td>${section.repairs?.length || 0} ×¤×¨×™×˜×™×</td><td>${formatCurrency(section.repairs_total || 0)}</td></tr>
                <tr><td><strong>×¡×”"×› ××•×§×“</strong></td><td></td><td><strong>${formatCurrency((section.works_total || 0) + (section.parts_total || 0) + (section.repairs_total || 0))}</strong></td></tr>
              </table>
            </div>
          `).join('');
          
          html = html.replace(/\{\{#each helper\.damage_blocks\}\}[\s\S]*?\{\{\/each\}\}/g, damageBlocksHTML);
        }
        
        // Replace depreciation data with calculated values
        if (helper.expertise?.depreciation?.centers) {
          const depreciationHTML = helper.expertise.depreciation.centers.map(center => `
            <tr>
              <td>${center.part || ''}</td>
              <td>${center.repair || ''}</td>
              <td>${center.percent || '0'}%</td>
              <td>${formatCurrency(center.depreciation_value || 0)}</td>
              <td>${center.center || ''}</td>
            </tr>
          `).join('');
          
          html = html.replace(/\{\{#each helper\.expertise\.depreciation\.centers\}\}[\s\S]*?\{\{\/each\}\}/g, depreciationHTML);
        }
        
        // Replace global depreciation values
        html = html.replace(/\{\{money helper\.depreciation\.global_amount\}\}/g, formatCurrency(helper.depreciation?.global_amount || 0));
        html = html.replace(/\{\{percent helper\.depreciation\.global_percent\}\}/g, (helper.depreciation?.global_percent || '0') + '%');
        
        // Load legal text from helper (estimate type specific)
        loadEstimateLegalText(helper.estimate_type || '××•×‘×“×Ÿ_×œ×”×œ×›×”', helper).then(legalText => {
          html = html.replace(/\{\{lookup vault\.estimate_legal_text helper\.estimate_type\}\}/g, legalText);
          
          // Get assessor declaration from helper too
          const assessorDeclaration = helper.legal_texts?.assessor_declaration || 
                                     helper.vault?.legal_texts?.assessor_declaration ||
                                     '×× ×™ ×”×—×ª×•× ××˜×”, ×™×¨×•×Ÿ ×›×™×•×£, ×©×××™ ××•×’×©×¨ ××¡\' 1097, ××¦×”×™×¨ ×›×™ ××•××“×Ÿ ×–×” × ×¢×¨×š ×¢×œ ×¤×™ ×‘×“×™×§×ª×™ ×•×‘×”×ª×× ×œ×™×“×™×¢×•×ª×™×™ ×”××§×¦×•×¢×™×•×ª.';
          
          html = html.replace(/\{\{lookup vault\.assessor_declaration 'estimate'\}\}/g, assessorDeclaration);
          
          container.innerHTML = html;
        });
        
      } catch (error) {
        console.error('Error generating estimate report:', error);
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #dc2626;">
            <h3>×©×’×™××” ×‘×™×¦×™×¨×ª ×”××•××“×Ÿ</h3>
            <p>××™×¨×¢×” ×©×’×™××” ×‘×™×¦×™×¨×ª ×“×•"×— ×”××•××“×Ÿ. ×× × × ×¡×” ×©×•×‘.</p>
            <button onclick="window.location.reload()" class="btn-primary">× ×¡×” ×©×•×‘</button>
          </div>
        `;
      }
    }

    async function loadEstimateLegalText(estimateType, helper) {
      try {
        // Load legal text from helper, not from external vault
        const legalText = helper.legal_texts?.[`estimate_${estimateType}`] || 
                         helper.legal_texts?.estimate_default ||
                         helper.vault?.legal_texts?.[`estimate_${estimateType}`] ||
                         '××•××“×Ÿ ×–×” ××‘×•×¡×¡ ×¢×œ ×‘×“×™×§×” ×¨××©×•× ×™×ª ×•×¢×œ ××—×™×¨×™ ×©×•×§ × ×•×›×—×™×™×. ×”×¢×œ×•×™×•×ª ×”×¡×•×¤×™×•×ª ×¢×©×•×™×•×ª ×œ×”×©×ª× ×•×ª ×‘×”×ª×× ×œ×ª× ××™ ×”×‘×™×¦×•×¢ ×‘×¤×•×¢×œ.';
        return legalText;
      } catch (error) {
        console.error('Error loading legal text from helper:', error);
        return '×˜×§×¡×˜ ××©×¤×˜×™ ×œ× ×–××™×Ÿ';
      }
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('he-IL', {
        style: 'currency',
        currency: 'ILS',
        minimumFractionDigits: 0
      }).format(amount || 0);
    }

    // Global functions for buttons
    window.editEstimate = function() {
      window.location.href = 'estimate-builder.html';
    };

    window.previewEstimate = function() {
      window.print();
    };

    window.generateEstimateReport = async function() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      try {
        console.log('ğŸ”„ Submitting estimate to webhook...');
        
        // Get the current HTML content for the estimate
        const estimateContent = document.getElementById('estimate-output').innerHTML;
        
        const payload = {
          type: 'estimate',
          plate: helper.meta?.plate || '',
          owner: helper.meta?.client_name || '',
          helper: helper,
          estimate_type: helper.estimate_type || '××•×‘×“×Ÿ_×œ×”×œ×›×”',
          html_content: estimateContent,
          timestamp: new Date().toISOString(),
          calculations: helper.calculations || {}
        };

        // Use the SUBMIT_ESTIMATE webhook URL from todo requirements
        const webhookUrl = 'https://hook.eu2.make.com/7dvgi7patq0vlgbd53hjbjasf6tek16l';
        
        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log('âœ… Estimate submitted successfully:', result);
          alert('×“×•"×— ×”××•××“×Ÿ × ×©×œ×— ×œ×¢×™×‘×•×“ ×‘×”×¦×œ×—×”! ×ª×§×‘×œ ×”×ª×¨××” ×›××©×¨ ×”×“×•"×— ×™×”×™×” ××•×›×Ÿ.');
          
          // Return to appropriate page based on entry mode
          const workflowMode = sessionStorage.getItem('workflowMode');
          if (workflowMode === 'centralized') {
            window.location.href = 'report-selection.html';
          } else {
            window.location.href = 'selection.html';
          }
        } else {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
      } catch (error) {
        console.error('âŒ Error submitting estimate:', error);
        alert('×©×’×™××” ×‘×©×œ×™×—×ª ×”××•××“×Ÿ ×œ×¢×™×‘×•×“. ×× × × ×¡×” ×©×•×‘.\n\n×¤×¨×˜×™ ×©×’×™××”: ' + error.message);
      }
    };

    window.goHome = function() {
      const workflowMode = sessionStorage.getItem('workflowMode');
      if (workflowMode === 'centralized') {
        window.location.href = 'report-selection.html';
      } else {
        window.location.href = 'selection.html';
      }
    };

    // Validation function for testing
    function validateEstimateData() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      const validation = {
        valid: true,
        errors: [],
        warnings: []
      };
      
      // Validate required fields
      if (!helper.meta?.plate) {
        validation.errors.push('××¡×¤×¨ ×¨×™×©×•×™ ×—×¡×¨');
        validation.valid = false;
      }
      
      if (!helper.meta?.client_name) {
        validation.errors.push('×©× ×‘×¢×œ ×”×¨×›×‘ ×—×¡×¨');
        validation.valid = false;
      }
      
      if (!helper.vehicle?.manufacturer) {
        validation.warnings.push('×™×¦×¨×Ÿ ×¨×›×‘ ×—×¡×¨');
      }
      
      if (!helper.vehicle?.model) {
        validation.warnings.push('×“×’× ×¨×›×‘ ×—×¡×¨');
      }
      
      if (!helper.calculations?.base_damage || helper.calculations.base_damage <= 0) {
        validation.errors.push('×—×™×©×•×‘ × ×–×§ ×‘×¡×™×¡×™ ×—×¡×¨ ××• ×©×’×•×™');
        validation.valid = false;
      }
      
      if (!helper.depreciation?.global_percent) {
        validation.warnings.push('××—×•×– ×™×¨×™×“×ª ×¢×¨×š ×’×œ×•×‘×œ×™ ×—×¡×¨');
      }
      
      console.log('ğŸ” Validation results:', validation);
      return validation;
    }
    
    // Test print functionality
    function testPrintPreview() {
      console.log('ğŸ–¨ï¸ Testing print preview...');
      
      // Validate data first
      const validation = validateEstimateData();
      if (!validation.valid) {
        console.error('âŒ Validation failed:', validation.errors);
        alert('×œ× × ×™×ª×Ÿ ×œ×”×“×¤×™×¡ - ×™×© ×©×’×™××•×ª ×‘× ×ª×•× ×™×:\n' + validation.errors.join('\n'));
        return false;
      }
      
      // Test print functionality
      try {
        window.print();
        console.log('âœ… Print preview opened successfully');
        return true;
      } catch (error) {
        console.error('âŒ Print preview failed:', error);
        alert('×©×’×™××” ×‘×¤×ª×™×—×ª ×ª×¦×•×’×” ××§×“×™××” ×œ×”×“×¤×¡×”');
        return false;
      }
    }
    
    // Test webhook connectivity
    async function testWebhookConnection() {
      console.log('ğŸ”— Testing webhook connection...');
      
      const webhookUrl = 'https://hook.eu2.make.com/7dvgi7patq0vlgbd53hjbjasf6tek16l';
      
      try {
        const testPayload = {
          type: 'test',
          timestamp: new Date().toISOString(),
          message: 'Connection test from estimate builder'
        };
        
        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(testPayload)
        });
        
        if (response.ok) {
          console.log('âœ… Webhook connection successful');
          return true;
        } else {
          console.error('âŒ Webhook connection failed:', response.status, response.statusText);
          return false;
        }
      } catch (error) {
        console.error('âŒ Webhook connection error:', error);
        return false;
      }
    }
    
    // Update previewEstimate to use validation
    window.previewEstimate = function() {
      testPrintPreview();
    };
    
    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
      console.log('ğŸ”„ Estimate Report Builder loaded and ready');
      
      // Run validation on load
      setTimeout(() => {
        const validation = validateEstimateData();
        if (validation.errors.length > 0) {
          console.warn('âš ï¸ Data validation errors found:', validation.errors);
        }
        if (validation.warnings.length > 0) {
          console.warn('âš ï¸ Data validation warnings:', validation.warnings);
        }
      }, 1000);
    });
  </script>
</body>
</html>