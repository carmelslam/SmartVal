<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <style>
    /* Modern Professional PDF Styling */
    @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&display=swap');
    
    @page { 
      size: A4; 
      margin: 0; 
    }
    
    body{ 
      margin: 0; 
      direction: rtl; 
      -webkit-print-color-adjust: exact; 
      print-color-adjust: exact;
      font-family: 'Heebo', 'Segoe UI', Tahoma, Arial, sans-serif;
      font-weight: 400;
      line-height: 1.6;
      color: #2c3e50;
      background: white;
    }
    
    .bg{ position:fixed; inset:0; width:100%; height:100%; object-fit:cover; z-index:0; pointer-events:none }
    .page{ position:relative; z-index:1; padding:25mm 15mm 20mm 15mm; }
  </style>
  <style>
    body {
      font-family: 'Heebo', 'Segoe UI', Tahoma, Arial, sans-serif;
      direction: rtl;
      margin: 0;
      padding: 0;
      font-weight: 400;
    }
    
    h1, h2, h3 {
      color: #1e3a8a;
      font-family: 'Heebo', 'Segoe UI', Tahoma, Arial, sans-serif;
      font-weight: 600;
    }
    
    h1 {
      font-size: 28px;
      font-weight: 700;
      text-align: center;
      margin: 20px 0 25px 0;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      letter-spacing: -0.5px;
    }
    
    h2 {
      font-size: 20px;
      font-weight: 600;
      margin: 25px 0 15px 0;
      border-right: 4px solid #3b82f6;
      padding-right: 12px;
    }
    
    table {
      width: 100%;
      max-width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      border: none;
      table-layout: fixed;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      font-family: 'Heebo', 'Segoe UI', Tahoma, Arial, sans-serif;
    }
    
    table + table {
      margin-top: 20px;
    }
    
    th, td {
      padding: 16px 12px;
      text-align: right;
      border: none;
      word-wrap: break-word;
      overflow-wrap: break-word;
      font-size: 14px;
      line-height: 1.4;
    }
    
    th {
      color: #1e3a8a !important;
      background: #fff8e1 !important;
      border-bottom: 3px solid #003366 !important;
      text-align: center !important;
    }
    
    td {
      background: white;
      border-bottom: 1px solid #f1f5f9;
      transition: background-color 0.2s ease;
    }
    
    tr:nth-child(even) td {
      background: #f8fafc;
    }
    
    tr:hover td {
      background: #e0f2fe;
    }
    .section {
      margin-bottom: 20px;
      page-break-inside: avoid;
    }
    .section:not(:first-child) {
      margin-top: 15px;
    }
    .signature-stamp {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 40px;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      border: 1px solid #e2e8f0;
    }
    .signature-stamp img {
      height: 120px;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
    }
    .signature-stamp .center-text {
      flex-grow: 1;
      text-align: center;
      font-size: 20px;
      font-weight: 700;
      color: #1e3a8a;
      font-family: 'Heebo', 'Segoe UI', Tahoma, Arial, sans-serif;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .car-details {
      background: white;
      border: 2px solid #3b82f6;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.1);
      transition: all 0.3s ease;
    }
    .car-details-title {
      color: #1e3a8a;
      font-weight: 700;
      font-size: 22px;
      text-align: center;
      margin-bottom: 20px;
      font-family: 'Heebo', 'Segoe UI', Tahoma, Arial, sans-serif;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      letter-spacing: -0.3px;
    }
    .car-details-table {
      width: 100%;
      border: none;
      font-size: 16px;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .car-details-table td {
      padding: 12px 16px;
      border-bottom: 1px solid #f1f5f9;
      font-weight: 500;
    }
    .car-details-table tr:nth-child(even) td {
      background: #f8fafc;
    }
    .car-details-table tr:hover td {
      background: #e0f2fe;
    }
    .intellectual-box {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 20px;
      font-size: 16px;
      font-weight: 600;
      margin: 20px 0;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15);
      font-family: 'Heebo', 'Segoe UI', Tahoma, Arial, sans-serif;
      color: #1e3a8a;
    }
    .buttons {
      text-align: center;
      margin-top: 40px;
    }
    
    /* Text boxes for all non-table content */
    .text-box {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .credentials-box {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15);
    }
    
    /* Override styles.css */
    .page body {
      padding: 0 !important;
      margin: 0 !important;
    }
    
    .page table {
      border-collapse: collapse !important;
      background: white !important;
      border-radius: 12px !important;
      overflow: hidden !important;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08) !important;
    }
    
    .page th {
      background: #fff8e1 !important;
      color: #1e3a8a !important;
      border: none !important;
    }
    
    .page td {
      border: none !important;
      border-bottom: 1px solid #f1f5f9 !important;
    }
    
    @media print {
      body {
        padding: 0 !important;
        margin: 0 !important;
      }
      
      .page {
        padding: 25mm 15mm 20mm 15mm !important;
      }
      
      .buttons,
      .control-buttons {
        display: none !important;
      }
      
      .text-box,
      .credentials-box {
        page-break-inside: avoid;
        background: rgba(255, 255, 255, 0.98) !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
    }
    .buttons button {
      padding: 10px 20px;
      margin: 0 10px;
      font-size: 16px;
      cursor: pointer;
    }
    .estimate-header {
      background: linear-gradient(135deg, #1e3a8a 0%, #475569 100%);
      color: white !important;
      padding: 30px;
      text-align: center;
      margin-bottom: 30px;
      border-radius: 15px;
    }
    .estimate-header h1, .estimate-header h2, .estimate-header h3 {
      color: white !important;
      margin: 10px 0;
    }
    .estimate-disclaimer {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      font-weight: bold;
      text-align: center;
    }
    .estimate-totals {
      background: #e8f5e8;
      border: 2px solid #28a745;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
    }
    .control-buttons {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin: 30px 0;
    }
    .control-buttons button {
      margin: 0 10px;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
    }
    .btn-primary {
      background: #007bff;
      color: white;
    }
    .btn-success {
      background: #28a745;
      color: white;
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    .btn-primary:hover {
      background: #0056b3;
    }
    .btn-success:hover {
      background: #218838;
    }
    .btn-secondary:hover {
      background: #545b62;
    }
    
    /* Print Styles for A4 Format */
    @media print {
      @page {
        size: A4;
        margin: 25mm 20mm 25mm 20mm;
      }
      
      body {
        font-family: sans-serif;
        font-size: 12pt;
        line-height: 1.4;
        color: #000;
        background: white;
        margin: 0;
        padding: 0;
      }
      
      /* Hide control elements */
      .no-print,
      .control-buttons,
      .estimate-header,
      .estimate-disclaimer {
        display: none !important;
      }
      
      /* Optimize tables for print */
      table {
        width: 100% !important;
        max-width: 180mm !important; /* A4 width minus margins */
        border-collapse: collapse !important;
        page-break-inside: avoid;
        font-size: 10pt;
        table-layout: fixed !important;
        margin: 0 auto !important;
      }
      
      th, td {
        padding: 4px 6px !important;
        border: 1px solid #000 !important;
        font-size: 10pt;
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-width: 0; /* Forces text wrapping */
      }
      
      th {
        background: #f0f0f0 !important;
        font-weight: bold;
        text-align: center !important;
      }
      
      /* Section formatting */
      .section {
        page-break-inside: avoid;
        margin-bottom: 15mm;
      }
      
      .car-details {
        border: 1px solid #000;
        border-radius: 0;
        padding: 8mm;
        margin-bottom: 10mm;
        page-break-inside: avoid;
      }
      
      .car-details-title {
        font-size: 14pt;
        font-weight: bold;
        margin-bottom: 6mm;
        text-align: center;
      }
      
      /* Signature section */
      .signature-stamp {
        page-break-inside: avoid;
        margin-top: 20mm;
      }
      
      .signature-stamp img {
        max-height: 40mm;
        max-width: 60mm;
      }
      
      /* Ensure no orphaned content */
      h1, h2, h3 {
        page-break-after: avoid;
        font-size: 14pt;
        margin: 8mm 0 4mm 0;
      }
      
      p {
        orphans: 2;
        widows: 2;
        font-size: 11pt;
      }
      
      /* Optimize assessor credentials and car details for A4 */
      .car-details {
        margin-bottom: 4mm;
        page-break-inside: avoid;
      }
      
      .car-details-table td {
        padding: 1.5mm !important;
        font-size: 10pt;
      }
      
      .intellectual-box {
        font-size: 10pt !important;
        line-height: 1.1 !important;
        padding: 4mm !important;
        margin: 3mm 0 !important;
        page-break-inside: avoid;
      }
      
      .car-details-title {
        font-size: 12pt !important;
        margin-bottom: 3mm !important;
      }
      
      /* Compact header section */
      .report-header {
        margin-bottom: 4mm !important;
      }
      
      .report-header table {
        margin-top: 3mm !important;
      }
      
      .report-header td {
        padding: 2.5mm !important;
        font-size: 10pt !important;
      }
      
      /* Reduce spacing in depreciation and legal sections */
      .section {
        margin-bottom: 3mm !important;
      }
      
      .section p {
        font-size: 10pt !important;
        line-height: 1.2 !important;
        margin: 2mm 0 !important;
      }
      
      /* Optimize estimate totals table to fit on same page */
      .estimate-totals {
        page-break-inside: auto !important;
        margin-top: 2mm !important;
      }
      
      .estimate-totals .car-details-title {
        font-size: 11pt !important;
        margin-bottom: 2mm !important;
      }
      
      /* Dynamic Page Layout System */
      
      /* Page 1: Car details + Credentials */
      .page-car-details {
        page-break-after: always !important;
      }
      
      /* Page 2+: Damage analysis with dynamic breaks */
      .page-damage-intro {
        page-break-before: always !important;
        page-break-after: avoid !important;
      }
      
      .damage-center-container {
        page-break-inside: avoid !important;
        margin-bottom: 4mm !important;
        page-break-before: avoid !important;
      }
      
      .damage-center-container:nth-child(n+3) {
        page-break-before: avoid !important;
      }
      
      /* Group all damage centers together */
      .damage-centers-group {
        page-break-inside: auto !important;
        page-break-before: always !important;
        page-break-after: avoid !important;
      }
      
      .damage-centers-group .page-damage-intro {
        page-break-before: avoid !important;
        page-break-after: avoid !important;
      }
      
      /* Dedicated pages for specific sections */
      .page-price-adjustments {
        page-break-before: always !important;
        page-break-after: avoid !important;
      }
      
      .adjustment-group {
        page-break-inside: avoid !important;
        margin-bottom: 8mm !important;
      }
      
      .adjustment-group:last-child {
        page-break-after: always !important;
      }
      
      .depreciation-group {
        page-break-inside: avoid !important;
        margin-bottom: 8mm !important;
      }
      
      .page-depreciation {
        page-break-before: always !important;
        page-break-after: avoid !important;
      }
      
      /* Final page: Legal + Signature */
      .page-legal-final {
        page-break-before: always !important;
      }
      
      /* Optimize damage centers spacing for A4 */
      .car-details {
        margin-bottom: 4mm !important;
        box-decoration-break: clone !important;
        -webkit-box-decoration-break: clone !important;
        border-image-slice: 1 !important;
      }
      
      /* Auto-restore borders when containers stretch across pages */
      .car-details {
        border: 2px solid #000 !important;
        border-radius: 25px !important;
        padding: 15px !important;
        page-break-inside: auto !important;
        orphans: 2 !important;
        widows: 2 !important;
      }
      
      /* Enhanced border restoration for page breaks */
      @page {
        margin: 20mm;
      }
      
      /* Ensure borders are maintained when content spans pages */
      .car-details-page-break {
        border-top: 2px solid #000 !important;
        border-left: 2px solid #000 !important;
        border-right: 2px solid #000 !important;
        border-bottom: none !important;
        border-radius: 25px 25px 0 0 !important;
        margin-bottom: 0 !important;
        padding-bottom: 10px !important;
      }
      
      .car-details-page-continue {
        border-top: none !important;
        border-left: 2px solid #000 !important;
        border-right: 2px solid #000 !important;
        border-bottom: 2px solid #000 !important;
        border-radius: 0 0 25px 25px !important;
        margin-top: 0 !important;
        padding-top: 10px !important;
      }
      
      /* Enhanced border restoration for spanning containers */
      .car-details-spanning {
        box-decoration-break: clone !important;
        -webkit-box-decoration-break: clone !important;
        border: 2px solid #000 !important;
        border-radius: 25px !important;
        padding: 15px !important;
        margin-bottom: 4mm !important;
      }
      
      .car-details-title {
        margin-bottom: 3mm !important;
        font-size: 12pt !important;
      }
      
      .car-details-table td {
        padding: 1.5mm !important;
        font-size: 10pt;
      }
      
      /* Optimize legal text, attachments, and signature for A4 */
      .section:last-of-type {
        margin-bottom: 2mm !important;
      }
      
      .section:last-of-type > div {
        padding: 8mm !important;
        font-size: 9pt !important;
        line-height: 1.1 !important;
      }
      
      .section:last-of-type p {
        margin: 0 0 3mm 0 !important;
        font-size: 9pt !important;
      }
      
      .section:last-of-type .estimate-disclaimer {
        padding: 4mm !important;
        margin-top: 4mm !important;
      }
      
      .section:last-of-type .estimate-disclaimer p {
        font-size: 9pt !important;
        line-height: 1.2 !important;
      }
      
      .signature-stamp {
        margin-top: 6mm !important;
        page-break-inside: avoid !important;
      }
      
      .signature-stamp img {
        max-height: 45mm !important;
        max-width: 90mm !important;
      }
      
      .signature-stamp + div {
        margin-top: 3mm !important;
      }
      
      .signature-stamp + div + div {
        margin-top: 2mm !important;
      }
      
      /* Hide print button and navigation */
      button {
        display: none !important;
      }
      
      /* Ensure content fits within margins */
      .report-content {
        max-width: 100%;
        overflow: hidden;
      }
      
      .estimate-totals {
        background: #f5f5f5 !important;
        border: 1px solid #000 !important;
        padding: 6mm;
        margin: 8mm 0;
      }
      
      .intellectual-box {
        border: 1px solid #000;
        padding: 6mm;
        margin: 8mm 0;
      }
      
      /* Professional header spacing */
      .report-header {
        margin-bottom: 8mm;
        padding: 4mm;
      }
      
      /* Ensure consistent spacing between sections */
      .car-details + .car-details {
        margin-top: 6mm;
      }
      
      /* Professional table spacing */
      .car-details-table {
        margin-bottom: 4mm;
      }
      
      /* Signature area proper spacing */
      .signature-stamp {
        margin-top: 15mm;
        margin-bottom: 10mm;
      }
      
      /* Fix text alignment for professional appearance */
      .center-text {
        text-align: center;
        font-size: 12pt;
        margin: 6mm 0;
      }
      
      /* Ensure proper page breaks */
      .estimate-totals {
        page-break-inside: avoid;
      }
      
      /* Better spacing for legal text */
      .legal-text {
        margin: 8mm 0;
        line-height: 1.6;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.min.js"></script>
  <script src="./math-preview.js"></script>
</head>
<body>
  <img class="bg" src="https://assets.carmelcayouf.com/assets/bg-report.png" alt="">
  <div class="page">
  <div class="estimate-header">
    <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo" style="width: 80px; margin-bottom: 15px;">
    <h1>ירון כיוף שמאות - פורטל</h1>
    <h2>שמאות והערכת נזקי רכב ורכוש</h2>
    <h3>בונה דו"ח אומדן</h3>
  </div>

  <div class="estimate-disclaimer">
    <h3>הודעה חשובה - אומדן בלבד</h3>
    <p>מסמך זה הינו אומדן ראשוני בלבד ואינו מהווה התחייבות כספית או חוזית מכל סוג שהוא.</p>
    <p>הערכים הסופיים עשויים להשתנות בהתאם לתוצאות הביצוע בפועל ולחשבוניות הסופיות.</p>
  </div>

  <!-- Buttons moved to end -->

  <div id="estimate-output" class="report-content">
    <!-- Report will be populated here by JavaScript -->
  </div>

  <script type="module">
    import { helper, updateHelper } from './helper.js';
    import { MathEngine } from './math.js';
    import { sendToWebhook } from './webhook.js';
    import { getVehicleData, getDamageData } from './helper.js';
    import { vaultLoader } from './vault-loader.js';

    // Authentication and data validation
    document.addEventListener('DOMContentLoaded', () => {
      console.log('🔄 Estimate Report Builder: Initializing...');
      
      const auth = sessionStorage.getItem("auth");
      if (!auth) {
        console.error('❌ No authentication found');
        alert("הגישה חסומה - אנא התחבר דרך דף הבית");
        window.location.href = "index.html";
        return;
      }

      const helperData = sessionStorage.getItem('helper');
      const selectedReportType = sessionStorage.getItem('selectedReportType');
      const validationCompleted = sessionStorage.getItem('estimateValidationCompleted');
      
      // Check if we should skip validation (coming from expertise) FIRST
      const urlParams = new URLSearchParams(window.location.search);
      const skipValidation = urlParams.get('skipValidation') === 'true';
      const fromExpertise = urlParams.get('from') === 'expertise';
      
      // Allow access if coming from expertise or skipping validation, even without selectedReportType
      if (!helperData || (!skipValidation && !fromExpertise && selectedReportType !== 'estimate')) {
        console.error('❌ Missing required data for estimate report builder');
        alert('שגיאה: נתונים חסרים לבניית אומדן. חוזר לדף הבחירה...');
        window.location.href = 'selection.html';
        return;
      }
      
      if (!validationCompleted && !skipValidation && !fromExpertise) {
        console.warn('⚠️ Validation not completed, redirecting to validation');
        alert('יש להשלים תחילה את תהליך האימות');
        window.location.href = 'estimate-validation.html';
        return;
      }
      
      if (skipValidation || fromExpertise) {
        console.log('✅ Validation skipped - accessed from expertise report');
      }

      console.log('✅ Estimate Report Builder: All validations passed');
      
      // Initialize vault loader
      vaultLoader.init().then(() => {
        console.log('✅ Vault loader initialized');
        initializeEstimateBuilder();
      });
    });

    function initializeEstimateBuilder() {
      loadEstimateData();
      injectEstimateHTML();
    }

    function loadEstimateData() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Ensure basic structure exists
      helper.meta = helper.meta || {};
      helper.vehicle = helper.vehicle || helper.car_details || {};
      helper.calculations = helper.calculations || {};
      helper.damage_sections = helper.damage_sections || [];
      helper.expertise = helper.expertise || {};
      helper.depreciation = helper.depreciation || {};
      
      // Ensure meta fields have defaults
      helper.meta.client_name = helper.meta.client_name || helper.meta.owner || '';
      helper.meta.plate = helper.meta.plate || '';
      helper.meta.inspection_date = helper.meta.inspection_date || new Date().toLocaleDateString('he-IL');
      helper.meta.location = helper.meta.location || '';
      helper.meta.damage = helper.meta.damage || '';
      helper.meta.address = helper.meta.address || '';
      helper.meta.phone_number = helper.meta.phone_number || '';
      
      // Ensure vehicle fields have defaults
      helper.vehicle.manufacturer = helper.vehicle.manufacturer || '';
      helper.vehicle.model = helper.vehicle.model || '';
      helper.vehicle.year = helper.vehicle.year || '';
      helper.vehicle.chassis = helper.vehicle.chassis || helper.vehicle.vin || '';
      helper.vehicle.km = helper.vehicle.km || '';
      helper.vehicle.ownership_type = helper.vehicle.ownership_type || '';
      
      // Ensure helper template fields have defaults
      // Create dynamic title: "estimate [type] for car no. [plate]"
      const estimateType = helper.estimate_data?.type || 'אובדן_להלכה';
      const plateNumber = helper.plate || helper.meta?.plate || 'XXXXX';
      helper.report_title = `אומדן ${estimateType} לרכב מספר  ${plateNumber}`;
      helper.file_number = helper.file_number || `YC/${helper.meta.plate || 'XXXXX'}/2025`;
      helper.business_license = helper.business_license || '02921217';
      helper.estimate_details_title = helper.estimate_details_title || 'פרטי הרכב הנבדק';
      
      // Ensure estimate calculations are up to date
      if (!helper.calculations || !helper.calculations.total_estimate) {
        calculateEstimateTotals(helper);
      }
      
      // Update session storage with processed data using proper function
      if (typeof updateHelper === 'function') {
        updateHelper('meta', helper.meta, 'estimate_report_builder_init');
        updateHelper('vehicle', helper.vehicle, 'estimate_report_builder_init');
        updateHelper('calculations', helper.calculations, 'estimate_report_builder_init');
        updateHelper('damage_sections', helper.damage_sections, 'estimate_report_builder_init');
        updateHelper('expertise', helper.expertise, 'estimate_report_builder_init');
        updateHelper('depreciation', helper.depreciation, 'estimate_report_builder_init');
        updateHelper('report_title', helper.report_title, 'estimate_report_builder_init');
        updateHelper('file_number', helper.file_number, 'estimate_report_builder_init');
        updateHelper('business_license', helper.business_license, 'estimate_report_builder_init');
        updateHelper('estimate_details_title', helper.estimate_details_title, 'estimate_report_builder_init');
      } else {
        // Fallback for compatibility
        sessionStorage.setItem('helper', JSON.stringify(helper));
      }
      
      console.log('✅ Estimate data loaded and processed:', helper);
    }

    function calculateEstimateTotals(helper) {
      // Get base damage from expertise or validation
      const baseDamage = helper.expertise?.calculations?.base_damage || 
                        helper.damage_sections?.reduce((total, section) => {
                          return total + (section.works_total || 0) + (section.parts_total || 0) + (section.repairs_total || 0);
                        }, 0) || 0;

      // Get VAT rate from helper, not from external source
      const vatRate = helper.calculations?.vat_rate || helper.fees?.vat_rate || helper.vat_rate || 18;
      const vatAmount = Math.round(baseDamage * vatRate / 100);
      const totalEstimate = baseDamage + vatAmount;

      // Update helper with calculations
      helper.calculations = helper.calculations || {};
      helper.calculations.base_damage = baseDamage;
      helper.calculations.vat_rate = vatRate;
      helper.calculations.vat_amount = vatAmount;
      helper.calculations.total_estimate = totalEstimate;
      
      // Calculate depreciation values
      calculateDepreciationValues(helper);
    }

    function calculateDepreciationValues(helper) {
      // Get market value from helper
      const marketValue = helper.calculations?.market_value || 
                         helper.vehicle_value_base || 
                         helper.levi?.market_value || 0;

      // Calculate depreciation values for each center
      if (helper.expertise?.depreciation?.centers) {
        helper.expertise.depreciation.centers.forEach(center => {
          const percent = parseFloat(center.percent) || 0;
          center.depreciation_value = Math.round(marketValue * percent / 100);
        });
      }

      // Calculate values for estimate depreciation bulk items
      if (helper.estimate_depreciation?.bulk_items) {
        helper.estimate_depreciation.bulk_items.forEach(item => {
          const percent = parseFloat(item.percent) || 0;
          item.value = Math.round(marketValue * percent / 100);
        });
      }

      // Calculate global depreciation
      if (helper.depreciation) {
        const globalPercent = parseFloat(helper.depreciation.global_percent) || 0;
        helper.depreciation.global_amount = Math.round(marketValue * globalPercent / 100);
      }
      
      // Calculate global estimate depreciation
      if (helper.estimate_depreciation) {
        const globalPercent = parseFloat(helper.estimate_depreciation.global_percent) || 0;
        helper.estimate_depreciation.global_value = Math.round(marketValue * globalPercent / 100);
      }
    }

    function injectEstimateHTML() {
      const container = document.getElementById("estimate-output");
      if (!container) return;

      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      if (!helper || !helper.meta) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #dc2626;">
            <h3>שגיאה: נתוני התיק לא נמצאו</h3>
            <p>אנא חזור לדף הבחירה וטען את התיק מחדש</p>
            <button onclick="window.location.href='selection.html'" class="btn-secondary">חזור לדף הבית</button>
          </div>
        `;
        return;
      }

      try {
        // Get data from helper with proper mapping
        const clientName = helper.client?.name || helper.car_details?.owner || helper.meta?.client_name || '';
        const clientAddress = helper.client?.address || helper.car_details?.ownerAddress || helper.meta?.address || '';
        const clientPhone = helper.client?.phone_number || helper.car_details?.ownerPhone || helper.meta?.phone_number || '';
        const plate = helper.meta?.plate || helper.car_details?.plate || helper.vehicle?.plate_number || '';
        const inspectionDate = helper.meta?.inspection_date || new Date().toLocaleDateString('he-IL');
        const location = helper.meta?.location || helper.meta?.inspection_location || helper.car_details?.location || '';
        const damageType = helper.meta?.damage || helper.car_details?.damageType || helper.meta?.damage_type || '';
        
        // Vehicle data - try multiple sources
        const vehicle = helper.vehicle || helper.car_details || {};
        const manufacturer = vehicle.manufacturer || vehicle.make || helper.meta?.manufacturer || '';
        const model = vehicle.model || helper.meta?.model || '';
        const year = vehicle.year || vehicle.manufacture_year || helper.meta?.year || '';
        const chassis = vehicle.chassis || vehicle.vin || vehicle.frame_number || helper.meta?.chassis || '';
        const km = vehicle.km || vehicle.odo || vehicle.odometer || vehicle.mileage || helper.meta?.km || '';
        const ownershipType = vehicle.ownership_type || vehicle.type || vehicle.category || helper.meta?.ownership_type || '';
        
        // Calculations
        const calc = helper.calculations || helper.expertise?.calculations || {};
        const baseDamage = calc.base_damage || calc.total_damage || 0;
        const vatRate = calc.vat_rate || 18;
        const vatAmount = calc.vat_amount || Math.round(baseDamage * vatRate / 100);
        const totalEstimate = calc.total_estimate || calc.total_compensation || (baseDamage + vatAmount);
        const marketValue = calc.market_value || helper.expertise?.levi_report?.final_price || helper.levisummary?.final_price || 0;
        const damagePercent = calc.damage_percent || (marketValue > 0 ? Math.round((baseDamage / marketValue) * 100) : 0);
        
        // Damage description - check multiple sources
        let damageDescription = '';
        
        // Check various sources for damage description
        if (helper.expertise?.description) {
          damageDescription = helper.expertise.description;
        } else if (helper.damage?.description) {
          damageDescription = helper.damage.description;
        } else if (helper.estimate_notes) {
          damageDescription = helper.estimate_notes;
        } else if (helper.centers?.length > 0) {
          // Collect descriptions from centers - each center on separate row
          const blockDescriptions = [];
          helper.centers.forEach((center, index) => {
            const blockDesc = [];
            
            // Add damage center identifier (number + name if available) - make bold
            const centerNum = center['Damage center Number'] || (index + 1);
            const centerName = center.Location || '';
            const centerIdentifier = centerName ? `<strong>מוקד ${centerNum}: ${centerName}</strong>` : `<strong>מוקד ${centerNum}</strong>`;
            
            // Add damage center description if available
            if (center.Description) {
              blockDesc.push(`${centerIdentifier} - ${center.Description}`);
            } else {
              blockDesc.push(centerIdentifier);
            }
            
            // Skip repair descriptions - not needed in this description
            
            // Add part descriptions as additional details  
            if (center.Parts?.parts_required?.length > 0) {
              const partDescs = center.Parts.parts_required.map(part => part.name || part.description).filter(desc => desc);
              if (partDescs.length > 0) {
                blockDesc.push(`חלקים: ${partDescs.join(', ')}`);
              }
            }
            
            // Add work notes as additional details
            if (center.Works?.works?.length > 0) {
              const workNotes = center.Works.works.map(work => work.comments || work.category).filter(note => note);
              if (workNotes.length > 0) {
                blockDesc.push(`עבודות: ${workNotes.join(', ')}`);
              }
            }
            
            if (blockDesc.length > 0) {
              blockDescriptions.push(blockDesc.join(', '));
            }
          });
          
          if (blockDescriptions.length > 0) {
            // Join each center description with a line break for separate rows
            damageDescription = blockDescriptions.join('<br><br>');
          }
        }
        
        // Fallback if no description found
        if (!damageDescription) {
          damageDescription = 'תיאור נזק לא זמין';
        }
        
        // Build HTML structure
        const html = `
          <!-- Section 1 - Header -->
          <div class="report-header">
            <div class="car-details-title">${helper.report_title || 'אומדן נזקי רכב'}</div>
            <table style="width: 100%; margin-top: 10px; table-layout: fixed;">
              <tr>
                <td style="width: 40%; text-align: right; padding: 10px;">
                  <p style="margin: 0;"><strong>לכבוד:</strong><br>${clientName}<br>${clientAddress}</p>
                </td>
                <td style="width: 20%;"></td>
                <td style="width: 40%; text-align: right; padding: 10px;">
                  <p style="margin: 0;"><strong>תאריך:</strong> ${new Date().toLocaleDateString('he-IL')}</p>
                  <p style="margin: 0;"><strong>תיק מספר:</strong> YC/${plate}/2025</p>
                  <p style="margin: 0;"><strong>עוסק מורשה:</strong> 02921217</p>
                </td>
              </tr>
            </table>
          </div>

          <!-- Section 2 - Vehicle Details -->
          <div class="car-details">
            <div class="car-details-title">פרטי הרכב הנבדק</div> 
            <table class="car-details-table" style="width: 100%; table-layout: fixed; margin-bottom: 10px;">
              <tbody>
                <tr>
                  <td style="width: 50%; padding: 4px;"><strong>בעל הרכב:</strong> ${clientName}</td>
                  <td style="width: 50%; padding: 4px;"><strong>דגם:</strong> ${model}</td>
                </tr>
                <tr>
                  <td style="padding: 4px;"><strong>מספר טלפון:</strong> ${clientPhone}</td>
                  <td style="padding: 4px;"><strong>מספר שלדה:</strong> ${chassis}</td>
                </tr>
                <tr>
                  <td style="padding: 4px;"><strong>תאריך הבדיקה:</strong> ${inspectionDate}</td>
                  <td style="padding: 4px;"><strong>שנת יצור:</strong> ${year}</td>
                </tr>
                <tr>
                  <td style="padding: 4px;"><strong>מקום הבדיקה:</strong> ${location}</td>
                  <td style="padding: 4px;"><strong>מד ק"מ:</strong> ${km}</td>
                </tr>
                <tr>
                  <td style="padding: 4px;"><strong>מספר רישוי:</strong> ${plate}</td>
                  <td style="padding: 4px;"><strong>סוג הרכב:</strong> ${ownershipType}</td>
                </tr>
                <tr>
                  <td style="padding: 4px;"><strong>יצרן:</strong> ${manufacturer}</td>
                  <td style="padding: 4px;"><strong>סוג הנזק:</strong> ${damageType}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Section 3 - Assessor Credentials -->
          <div class="section page-car-details">
            <div class="car-details">
              <div class="car-details-title">שמאי בודק ירון כיוף מס' רשיון 1097</div>
              <div class="intellectual-box" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #003366; border-radius: 8px; padding: 8px; margin: 5px 0; text-align: right; page-break-inside: avoid;">
                <div style="font-size: 14px; color: #495057; line-height: 1.1; white-space: pre-line;">
<strong>פרטי השכלתי וניסיוני:</strong>
אני החתום מטה ירון כיוף שמאי בעל רישיון משרד התחבורה מס' 1097
שמאי רכוש, חקלאות בוגר היחידה ללימודי חוץ
חוקר תאונות דרכים ובטיחות, מכללת משלב
מרצה שמאות רכב מכללת עתיד
בוגר ביה"ס מקצועי למכונאות רכב (בוגר מצטיין)
בוגר הקורס לשמאות רכב, מכללת עתיד
עד מומחה לבית המשפט, תחום שמאות רכב ורכוש. מכללת אפיק
מכונאי רכב סוג 3, מכללת עתיד
בוחן רכב בשירות קבע צה"ל
בוגר קורס הסמכה וניהול מוסכים, מכללת עתיד
השתלמות במערכות בלמים אוויר ו ABS בציוד כבד
השתלמות מערכות מתקדמות וחידוש טכנולוגיים ברכב, המכללה הטכנולוגית לרכב
השתלמות ברכב היברידי וחשמלי, המכללה הטכנולוגית לרכב
בוגר השתלמויות שונות במנועי בנזין, דיזל, רכב חשמלי / היברידי ותורת החומרים.
                </div>
              </div>
            </div>
          </div>

          <!-- Section 4 - Damage Analysis with Introduction -->
          ${generateDamageAnalysis(helper, damageDescription)}

          <!-- Section 4.5 - Vehicle Value for Gross Damage -->
          <div class="section page-price-adjustments adjustment-group">
            <div class="car-details">
              <div class="car-details-title">ערך הרכב לנזק גולמי</div>
              <table class="car-details-table" style="width: 100%; max-width: 600px; margin: 0 auto;">
                <tr><th style="width: 50%;">מרכיב</th><th style="width: 25%;">תוספת \ פחתה</th><th style="width: 25%;">ערך</th></tr>
                ${generateMarketValueTable()}
              </table>
            </div>
          </div>

          <!-- Section 4.6 - Damage Percentage Calculation -->
          <div class="section adjustment-group">
            <div class="car-details">
              <div class="car-details-title">חישוב אחוז הנזק</div>
              <table class="car-details-table" style="width: 100%; max-width: 600px; margin: 0 auto;">
                <tr><th style="width: 70%;">תיאור</th><th style="width: 30%;">ערך</th></tr>
                <tr><td style="padding: 8px;">סה"כ הנזק כולל מע"מ</td><td style="padding: 8px; text-align: center;">${formatCurrency(baseDamage)}</td></tr>
                <tr><td style="padding: 8px;">ערך הרכב לנזק גולמי כולל מע"מ</td><td style="padding: 8px; text-align: center;">${formatCurrency(marketValue)}</td></tr>
                <tr><td style="padding: 8px;"><strong>אחוז הנזק הגולמי</strong></td><td style="padding: 8px; text-align: center;"><strong>${damagePercent}%</strong></td></tr>
              </table>
            </div>
          </div>

          <!-- Section 4.7 - Levi Market Value Calculation -->
          ${generateLeviAdjustments(helper)}

          <!-- Section 4.8 - Depreciation Opening Block -->
          ${generateDepreciationAnalysis(helper)}

          <!-- Section 5 - Estimate Totals Summary -->
          <div class="section depreciation-group">
            <div class="estimate-totals">
              <div class="car-details-title">סיכום האומדן</div>
              <table class="car-details-table" style="width: 100%; max-width: 600px; margin: 0 auto;">
                <tr>
                  <th style="width: 70%; text-align: right;">סעיף</th>
                  <th style="width: 30%; text-align: center;">שווי</th>
                </tr>
                <tr>
                  <td style="padding: 8px;">סה"כ אומדן נזקים</td>
                  <td style="padding: 8px; text-align: center;">${formatCurrency(baseDamage)}</td>
                </tr>
                <tr>
                  <td style="padding: 8px;">פיצוי בגין ירידת ערך</td>
                  <td style="padding: 8px; text-align: center;">${formatCurrency(helper.expertise?.depreciation?.global_amount || helper.depreciation?.global_amount || helper.estimate_depreciation?.global_value || 0)}</td>
                </tr>
                <tr>
                  <td style="padding: 8px;">מע"מ (${vatRate}%)</td>
                  <td style="padding: 8px; text-align: center;">${formatCurrency(vatAmount)}</td>
                </tr>
                <tr>
                  <td style="padding: 8px;"><strong>סה"כ נכלל באומדן</strong></td>
                  <td style="padding: 8px; text-align: center;"><strong>${formatCurrency(totalEstimate + (helper.expertise?.depreciation?.global_amount || helper.depreciation?.global_amount || helper.estimate_depreciation?.global_value || 0))}</strong></td>
                </tr>
              </table>
            </div>
          </div>

          <!-- Section 6 - Legal Text and Disclaimers -->
          <div class="section page-legal-final">
            <div style="font-size: 14px; line-height: 1.1; padding: 15px;">
              <p style="margin: 0 0 12px 0; font-weight: bold; color: #003366; font-size: 16px;">הערות חשובות לגבי האומדן:</p>
              <div style="font-size: 14px; line-height: 1.1; margin-bottom: 15px; text-align: justify;">
                ${generateLegalText(helper).replace(/\n/g, '<br>')}
              </div>

              <p style="margin: 0 0 12px 0; font-weight: bold; color: #003366; font-size: 16px;">הצהרת שמאי:</p>
              <p style="font-size: 14px; line-height: 1.1; margin-bottom: 15px; text-align: justify;">
                אני החתום מטה: <strong>ירון כיוף, תעודת שמאי מס' 1097</strong>. הנני נותן את חוות דעתי זו במקום עדות בשבועה בבית משפט. הדין של חוות דעת זו הוא כדין עדות בשבועה.
              </p>

              <div style="margin: 20px 0 15px 0; font-size: 14px; line-height: 1.2;">
                ${getAttachmentsList()}
              </div>

              <div class="estimate-disclaimer" style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 12px; margin-top: 12px;">
                <p style="margin: 0 0 6px 0; font-weight: bold; color: #856404; font-size: 14px;">אומדן זה הינו הערכה ראשונית בלבד ואינו מהווה התחייבות כספית.</p>
                <p style="margin: 0; color: #856404; font-size: 14px; line-height: 1.3;">העלויות הסופיות עשויות להשתנות בהתאם לתוצאות הביצוע בפועל, זמינות חלקים ותנאי השוק.</p>
              </div>
            </div>
          </div>

          <!-- Section 7 - Signature -->
          <div class="signature-stamp" style="margin-top: 15px;">
            <div class="center-text" style="font-size: 16px; font-weight: bold;">בכבוד רב,</div>
          </div>

          <div style="margin-top: 10px; text-align: left;">
            <img src="https://carmelcayouf.com/wp-content/uploads/2025/04/yaron-signature-transparent-.webp" alt="חתימה" style="height: 140px;">
          </div>
          
          <div style="margin-top: 8px; text-align: center;">
            <p style="margin: 5px 0;"><strong>ירון כיוף - שמאי מורשה מס' 1097</strong></p>
            <p style="margin: 5px 0;">ירון כיוף - שמאות והערכת נזקי רכב ורכוש</p>
          </div>
        `;
        
        container.innerHTML = html;
        
        // Apply dynamic page layout management
        adjustContentForPrint();
        
      } catch (error) {
        console.error('Error generating estimate report:', error);
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #dc2626;">
            <h3>שגיאה ביצירת האומדן</h3>
            <p>אירעה שגיאה ביצירת דו"ח האומדן. אנא נסה שוב.</p>
            <button onclick="window.location.reload()" class="btn-primary">נסה שוב</button>
          </div>
        `;
      }
    }

    // Dynamic Page Layout Management
    function optimizePageBreaks() {
      const A4_HEIGHT_MM = 297;
      const A4_HEIGHT_PX = A4_HEIGHT_MM * 3.78; // 1mm ≈ 3.78px at 96dpi
      const CONTENT_HEIGHT_PX = A4_HEIGHT_PX - 120; // Account for margins and headers
      
      // Get all damage center containers
      const damageContainers = document.querySelectorAll('.damage-center-container');
      let currentPageHeight = 0;
      let pageNumber = 2; // Start from page 2 (after car details)
      
      damageContainers.forEach((container, index) => {
        const containerHeight = container.offsetHeight;
        
        // If adding this container would exceed page height, force page break
        if (currentPageHeight + containerHeight > CONTENT_HEIGHT_PX && index > 0) {
          container.style.pageBreakBefore = 'always';
          currentPageHeight = containerHeight;
          pageNumber++;
        } else {
          currentPageHeight += containerHeight;
        }
        
        // Mark containers for potential page breaks after every 2-3 containers
        if (index > 0 && index % 2 === 0) {
          container.style.pageBreakBefore = 'auto';
        }
      });
      
      console.log(`📄 Dynamic layout: ${pageNumber} pages optimized for damage centers`);
    }
    
    // Content-aware positioning
    function adjustContentForPrint() {
      // Ensure first page always contains car details + credentials
      const carDetailsSection = document.querySelector('.page-car-details');
      if (carDetailsSection) {
        carDetailsSection.style.pageBreakAfter = 'always';
      }
      
      // Ensure damage intro starts on new page
      const damageIntroSection = document.querySelector('.page-damage-intro');
      if (damageIntroSection) {
        damageIntroSection.style.pageBreakBefore = 'always';
      }
      
      // Optimize adjustment groups to stay together
      const adjustmentGroups = document.querySelectorAll('.adjustment-group');
      adjustmentGroups.forEach((group, index) => {
        if (index === 0) {
          // First adjustment group starts the price adjustments page
          group.style.pageBreakBefore = 'always';
        } else {
          // Subsequent groups try to stay on same page
          group.style.pageBreakBefore = 'avoid';
        }
        
        // Prevent breaking within adjustment groups
        group.style.pageBreakInside = 'avoid';
        
        // Last adjustment group should break after
        if (index === adjustmentGroups.length - 1) {
          group.style.pageBreakAfter = 'always';
        }
      });

      // Optimize depreciation groups to stay together
      const depreciationGroups = document.querySelectorAll('.depreciation-group');
      depreciationGroups.forEach((group, index) => {
        // Prevent breaking within depreciation groups
        group.style.pageBreakInside = 'avoid';
        
        // First depreciation group (main depreciation section) should start on new page
        if (index === 0) {
          group.style.pageBreakBefore = 'always';
        } else {
          // Subsequent groups (like summary) try to stay on same page
          group.style.pageBreakBefore = 'avoid';
        }
      });

      // Optimize damage centers to flow together without page breaks
      const damageCentersGroup = document.querySelector('.damage-centers-group');
      if (damageCentersGroup) {
        damageCentersGroup.style.pageBreakInside = 'auto';
        damageCentersGroup.style.pageBreakBefore = 'always';
        damageCentersGroup.style.pageBreakAfter = 'avoid';
        
        // Ensure individual damage centers don't break
        const damageContainers = damageCentersGroup.querySelectorAll('.car-details');
        damageContainers.forEach((container, index) => {
          container.style.pageBreakBefore = 'avoid';
          container.style.pageBreakInside = 'avoid';
          container.style.pageBreakAfter = 'avoid';
        });
      }
      
      // Ensure final legal section is on its own page
      const legalSection = document.querySelector('.page-legal-final');
      if (legalSection) {
        legalSection.style.pageBreakBefore = 'always';
      }
      
      // Run dynamic page break optimization after DOM is ready
      setTimeout(optimizePageBreaks, 100);
      
      // Handle border restoration for containers that span across pages
      setTimeout(handleContainerBorderRestoration, 200);
    }
    
    function handleContainerBorderRestoration() {
      const carDetailsElements = document.querySelectorAll('.car-details');
      
      carDetailsElements.forEach((element, index) => {
        // Check if element might span pages by looking at its height
        const elementHeight = element.offsetHeight;
        const pageHeight = window.innerHeight || 800; // Approximate A4 height
        
        // If element is taller than half a page, it might span pages
        if (elementHeight > pageHeight * 0.4) {
          // Add class to maintain borders across page breaks
          element.classList.add('car-details-spanning');
          
          // Use box-decoration-break to maintain borders
          element.style.boxDecorationBreak = 'clone';
          element.style.webkitBoxDecorationBreak = 'clone';
          
          // Ensure borders are maintained
          element.style.border = '2px solid #000';
          element.style.borderRadius = '25px';
          element.style.padding = '15px';
        }
      });
    }
    
    function generateDamageAnalysis(helper, damageDescription = '') {
      const damageBlocks = helper.expertise?.damage_blocks || helper.damage_sections || [];
      
      // Create introduction section
      const introSection = `
        <div class="car-details page-damage-intro">
          <p style="font-size: 16px; line-height: 1.6; margin: 15px 0;">
            בהתאם לבקשתכם, ערכנו אומדן ראשוני לעלויות תיקון נזקי הרכב הנדון כפי שהוצגו לפנינו.
          </p>
          <p style="font-size: 16px; font-weight: bold; text-decoration: underline; margin: 10px 0;">תיאור הנזק:</p>
          <div style="font-size: 16px; line-height: 1.6; margin: 10px 0;">
            ${damageDescription}
          </div>
          <p style="font-size: 16px; font-weight: bold; text-decoration: underline; margin: 10px 0;">אומדן עלויות:</p>
          <p style="font-size: 16px; line-height: 1.6; margin: 10px 0;">
            האומדן מבוסס על מחירי שוק נוכחיים ועל בדיקה ראשונית של הנזקים. עלויות סופיות עשויות להשתנות.
          </p>
        </div>
      `;
      
      if (!damageBlocks || damageBlocks.length === 0) {
        return `
          <div class="section damage-centers-group">
            ${introSection}
            <div class="car-details">
              <div class="car-details-title">ניתוח נזקים</div>
              <p style="text-align: center; padding: 20px;">לא נמצאו נתוני נזקים מפורטים</p>
            </div>
          </div>
        `;
      }
      
      const damageHTML = damageBlocks.map((block, index) => {
        const works = block.works || [];
        const parts = block.parts || [];
        const repairs = block.repairs || [];
        
        const worksTotal = block.works_total || works.reduce((sum, item) => sum + (item.cost || 0), 0);
        const partsTotal = block.parts_total || parts.reduce((sum, item) => sum + (item.price || 0), 0);
        const repairsTotal = block.repairs_total || repairs.reduce((sum, item) => sum + (item.cost || 0), 0);
        const sectionTotal = worksTotal + partsTotal + repairsTotal;
        
        // Generate detailed rows for each category
        const workRows = works.map(work => `
          <tr>
            <td style="padding: 4px 6px;">עבודות</td>
            <td style="padding: 4px 6px;">${work.type || work.description || work.name || 'עבודה לא מוגדרת'}</td>
            <td style="padding: 4px 6px; text-align: center;">${formatCurrency(work.cost || 0)}</td>
          </tr>
        `).join('');
        
        const partRows = parts.map(part => `
          <tr>
            <td style="padding: 4px 6px;">חלקים</td>
            <td style="padding: 4px 6px;">${part.name || part.description || 'חלק לא מוגדר'}</td>
            <td style="padding: 4px 6px; text-align: center;">${formatCurrency(part.price || 0)}</td>
          </tr>
        `).join('');
        
        const repairRows = repairs.map(repair => `
          <tr>
            <td style="padding: 4px 6px;">תיקונים</td>
            <td style="padding: 4px 6px;">${repair.name || repair.description || 'תיקון לא מוגדר'}</td>
            <td style="padding: 4px 6px; text-align: center;">${formatCurrency(repair.cost || 0)}</td>
          </tr>
        `).join('');
        
        // If no detailed items, show summary
        const detailedRows = workRows + partRows + repairRows;
        const summaryRows = detailedRows || `
          <tr>
            <td style="padding: 8px;">עבודות</td>
            <td style="padding: 8px;">${works.length} פריטים</td>
            <td style="padding: 8px; text-align: center;">${formatCurrency(worksTotal)}</td>
          </tr>
          <tr>
            <td style="padding: 8px;">חלקים</td>
            <td style="padding: 8px;">${parts.length} פריטים</td>
            <td style="padding: 8px; text-align: center;">${formatCurrency(partsTotal)}</td>
          </tr>
          <tr>
            <td style="padding: 8px;">תיקונים</td>
            <td style="padding: 8px;">${repairs.length} פריטים</td>
            <td style="padding: 8px; text-align: center;">${formatCurrency(repairsTotal)}</td>
          </tr>
        `;
        
        // Generate separate sections for each category
        let categorySections = '';
        
        // Works section
        if (works.length > 0) {
          const workRowsDetailed = works.map(work => `
            <tr>
              <td style="padding: 4px 6px;">${work.type || work.description || work.name || 'עבודה לא מוגדרת'}</td>
              <td style="padding: 4px 6px; text-align: center;">${formatCurrency(work.cost || 0)}</td>
            </tr>
          `).join('');
          
          categorySections += `
            <div style="margin-bottom: 8px;">
              <h4 style="margin: 6px 0; color: #003366; font-size: 16px; font-weight: bold;">עבודות:</h4>
              <table class="car-details-table" style="width: 100%; max-width: 700px; margin: 0 auto;">
                <tr>
                  <th style="width: 70%;">תיאור</th>
                  <th style="width: 30%;">אומדן עלות</th>
                </tr>
                ${workRowsDetailed}
                <tr>
                  <td style="padding: 4px 6px;"><strong>סה"כ עבודות</strong></td>
                  <td style="padding: 4px 6px; text-align: center;"><strong>${formatCurrency(worksTotal)}</strong></td>
                </tr>
              </table>
            </div>
          `;
        }
        
        // Parts section
        if (parts.length > 0) {
          const partRowsDetailed = parts.map(part => `
            <tr>
              <td style="padding: 4px 6px;">${part.name || part.description || 'חלק לא מוגדר'}</td>
              <td style="padding: 4px 6px; text-align: center;">${formatCurrency(part.price || 0)}</td>
            </tr>
          `).join('');
          
          categorySections += `
            <div style="margin-bottom: 8px;">
              <h4 style="margin: 6px 0; color: #003366; font-size: 16px; font-weight: bold;">חלקים:</h4>
              <table class="car-details-table" style="width: 100%; max-width: 700px; margin: 0 auto;">
                <tr>
                  <th style="width: 70%;">תיאור</th>
                  <th style="width: 30%;">אומדן עלות</th>
                </tr>
                ${partRowsDetailed}
                <tr>
                  <td style="padding: 4px 6px;"><strong>סה"כ חלקים</strong></td>
                  <td style="padding: 4px 6px; text-align: center;"><strong>${formatCurrency(partsTotal)}</strong></td>
                </tr>
              </table>
            </div>
          `;
        }
        
        // Repairs section
        if (repairs.length > 0) {
          const repairRowsDetailed = repairs.map(repair => `
            <tr>
              <td style="padding: 4px 6px;">${repair.name || repair.description || 'תיקון לא מוגדר'}</td>
              <td style="padding: 4px 6px; text-align: center;">${formatCurrency(repair.cost || 0)}</td>
            </tr>
          `).join('');
          
          categorySections += `
            <div style="margin-bottom: 8px;">
              <h4 style="margin: 6px 0; color: #003366; font-size: 16px; font-weight: bold;">תיקונים:</h4>
              <table class="car-details-table" style="width: 100%; max-width: 700px; margin: 0 auto;">
                <tr>
                  <th style="width: 70%;">תיאור</th>
                  <th style="width: 30%;">אומדן עלות</th>
                </tr>
                ${repairRowsDetailed}
                <tr>
                  <td style="padding: 4px 6px;"><strong>סה"כ תיקונים</strong></td>
                  <td style="padding: 4px 6px; text-align: center;"><strong>${formatCurrency(repairsTotal)}</strong></td>
                </tr>
              </table>
            </div>
          `;
        }
        
        return `
          <div class="car-details damage-center-container" style="margin-bottom: 20px;">
            <div class="car-details-title">אומדן מוקד ${index + 1}: ${block.area_name || block.label || block.location || block.center || block.name || block.area || block.section || `מוקד ${index + 1}`}</div>
            <div style="padding: 10px;">
              ${categorySections}
              <div style="margin-top: 15px; padding: 10px; background: #f0f8ff; border-radius: 8px;">
                <table class="car-details-table" style="width: 100%; border: 2px solid #003366;">
                  <tr>
                    <th style="width: 70%; text-align: right; background: #fff8e1; color: #003366; font-weight: bold;">סיכום</th>
                    <th style="width: 30%; text-align: center; background: #fff8e1; color: #003366; font-weight: bold;">עלות</th>
                  </tr>
                  <tr>
                    <td style="padding: 8px;">סה"כ הכל עבודות</td>
                    <td style="padding: 8px; text-align: center;">${formatCurrency(worksTotal)}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px;">סה"כ הכל חלקים</td>
                    <td style="padding: 8px; text-align: center;">${formatCurrency(partsTotal)}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px;">סה"כ הכל תיקונים</td>
                    <td style="padding: 8px; text-align: center;">${formatCurrency(repairsTotal)}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px;">סה"כ הכל עבודות + חלקים + תיקונים</td>
                    <td style="padding: 8px; text-align: center;">${formatCurrency(worksTotal + partsTotal + repairsTotal)}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px;">מע"מ 18%</td>
                    <td style="padding: 8px; text-align: center;">${formatCurrency((worksTotal + partsTotal + repairsTotal) * 0.18)}</td>
                  </tr>
                  <tr style="background: #e8f4f8;">
                    <td style="padding: 8px; font-weight: bold;">סה"כ כולל מע"מ</td>
                    <td style="padding: 8px; text-align: center; font-weight: bold;">${formatCurrency((worksTotal + partsTotal + repairsTotal) * 1.18)}</td>
                  </tr>
                </table>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // Calculate total damage for all centers including VAT
      const totalDamageAllCenters = damageBlocks.reduce((sum, block) => {
        const worksTotal = block.works_total || (block.works || []).reduce((sum, item) => sum + (item.cost || 0), 0);
        const partsTotal = block.parts_total || (block.parts || []).reduce((sum, item) => sum + (item.price || 0), 0);
        const repairsTotal = block.repairs_total || (block.repairs || []).reduce((sum, item) => sum + (item.cost || 0), 0);
        const centerTotalWithVat = (worksTotal + partsTotal + repairsTotal) * 1.18;
        return sum + centerTotalWithVat;
      }, 0);
      
      // Generate centers summary table
      const centersSummaryRows = damageBlocks.map((block, index) => {
        const worksTotal = block.works_total || (block.works || []).reduce((sum, item) => sum + (item.cost || 0), 0);
        const partsTotal = block.parts_total || (block.parts || []).reduce((sum, item) => sum + (item.price || 0), 0);
        const repairsTotal = block.repairs_total || (block.repairs || []).reduce((sum, item) => sum + (item.cost || 0), 0);
        const centerTotalWithVat = (worksTotal + partsTotal + repairsTotal) * 1.18;
        const centerName = block.area_name || block.label || block.location || block.center || block.name || block.area || block.section || `מוקד ${index + 1}`;
        
        return `
          <tr>
            <td style="padding: 8px; text-align: center;">₪${Math.round(centerTotalWithVat).toLocaleString()}</td>
            <td style="padding: 8px; text-align: center;">-</td>
            <td style="padding: 8px; text-align: right;">סה"כ נזק למוקד ${index + 1}: ${centerName}</td>
          </tr>
        `;
      }).join('');
      
      const centersSummaryTable = `
        <div class="car-details" style="margin-top: 30px;">
          <div class="car-details-title">חלוקה למוקדים</div>
          <table class="car-details-table" style="width: 100%; max-width: 800px; margin: 0 auto;">
            <thead>
              <tr>
                <th style="width: 20%; text-align: center; background: #fff8e1; color: #003366; font-weight: bold;">סכום</th>
                <th style="width: 10%; text-align: center; background: #fff8e1; color: #003366; font-weight: bold;">סוג</th>
                <th style="width: 70%; text-align: right; background: #fff8e1; color: #003366; font-weight: bold;">תיאור</th>
              </tr>
            </thead>
            <tbody>
              ${centersSummaryRows}
              <tr style="background: #e8f4f8; font-weight: bold;">
                <td style="padding: 8px; text-align: center; font-weight: bold;">₪${Math.round(totalDamageAllCenters).toLocaleString()}</td>
                <td style="padding: 8px; text-align: center; font-weight: bold;">-</td>
                <td style="padding: 8px; text-align: right; font-weight: bold;">סה"כ לשני המוקדים כולל מע"מ</td>
              </tr>
            </tbody>
          </table>
        </div>
      `;
      
      return `<div class="section damage-centers-group">${introSection}${damageHTML}${centersSummaryTable}</div>`;
    }
    
    function generateLegalText(helper) {
      // Get legal text from builder first, then fallback to vault
      const builderLegalText = helper.estimate_legal_text || '';
      
      // If builder has text, use it
      if (builderLegalText) {
        return builderLegalText;
      }
      
      // Fallback to vault system
      const estimateType = helper.estimate_type || 'אובדן_להלכה';
      const vaultTexts = window.vaultTexts || helper.vault?.legal_texts || {};
      
      const legalText = helper.legal_texts?.[`estimate_${estimateType}`] || 
                       helper.legal_texts?.estimate_default ||
                       vaultTexts[`estimate_${estimateType}`]?.text ||
                       vaultTexts.estimate_default?.text ||
                       'אומדן זה מבוסס על בדיקה ראשונית ועל מחירי שוק נוכחיים. העלויות הסופיות עשויות להשתנות בהתאם לתנאי הביצוע בפועל.';
      
      // Add assessor credentials from vault
      const assessorCredentials = vaultTexts.assessor_introduction || 
                                 'ירון כיוף, שמאי מוסמך מספר רישיון 1097, בעל ותק של מעל 15 שנה בתחום הערכת נזקי רכב ורכוש.';
      
      return legalText + '\n\n' + assessorCredentials;
    }
    
    function getAttachmentsList() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Get attachments from helper (saved from builder)
      let attachmentsText = helper.estimate_attachments || '**לוטה**\nתצלומי הרכב הניזוק\nחשבוניות תיקון\nערך רכב ממוחשב\nצילום רישיון הרכב\nחשכ"ט';
      
      // Convert plain text to HTML for display
      attachmentsText = attachmentsText
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
      
      return attachmentsText;
    }
    
    function generateMarketValueTable() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Get market value adjustments from helper
      const marketAdjustments = helper.custom_adjustments?.full_market_adjustments || [];
      
      // Get base market value
      const basePrice = helper.levi_report?.base_price || 
                       helper.expertise?.levi_report?.base_price || 
                       helper.levisummary?.base_price || 
                       helper.car_details?.base_price || 
                       helper.vehicle?.base_price || 
                       helper.calculations?.base_price || 0;
      
      // Get final market value
      const finalPrice = helper.calculations?.market_value || 
                        helper.expertise?.calculations?.market_value || 
                        helper.calculations?.full_market_value || 
                        helper.expertise?.levi_report?.final_price || 
                        helper.levisummary?.final_price || 0;
      
      let rows = [];
      
      // Add base price row
      rows.push(`
        <tr>
          <td style="padding: 8px;">ערך הרכב ע"פ מחירון כולל מע"מ</td>
          <td style="padding: 8px; text-align: center;">-</td>
          <td style="padding: 8px; text-align: center;">${formatCurrency(basePrice)}</td>
        </tr>
      `);
      
      // Add adjustment rows
      marketAdjustments.forEach(adj => {
        if (adj.description && (adj.percentage || adj.value)) {
          const percentSign = adj.type === 'plus' ? '+' : '-';
          const percentText = adj.percentage ? `${percentSign}${adj.percentage}%` : '-';
          const value = adj.type === 'minus' ? -Math.abs(adj.value || 0) : Math.abs(adj.value || 0);
          
          rows.push(`
            <tr>
              <td style="padding: 8px;">${adj.description}</td>
              <td style="padding: 8px; text-align: center;">${percentText}</td>
              <td style="padding: 8px; text-align: center;">${formatCurrency(value)}</td>
            </tr>
          `);
        }
      });
      
      // Add final sum row
      rows.push(`
        <tr>
          <td style="padding: 8px;"><strong>ערך הרכב לנזק גולמי כולל מע"מ</strong></td>
          <td style="padding: 8px; text-align: center;"><strong>-</strong></td>
          <td style="padding: 8px; text-align: center;"><strong>${formatCurrency(finalPrice)}</strong></td>
        </tr>
      `);
      
      return rows.join('');
    }
    
    function generateLeviAdjustments(helper) {
      const leviData = helper.expertise?.levi_report || helper.levisummary || {};
      
      // Try to get values from custom adjustments first, then fallback to legacy
      const customAdjustments = helper.custom_adjustments?.full_market_adjustments || [];
      const hasCustomData = customAdjustments.length > 0;
      
      const basePrice = hasCustomData ? 
        (helper.calculations?.base_market_value || helper.custom_adjustments?.base_market_value || 0) : 
        (leviData.base_price || leviData['מחיר בסיס'] || 0);
        
      const finalPrice = hasCustomData ? 
        (helper.calculations?.full_market_value || helper.custom_adjustments?.full_market_value || 0) : 
        (leviData.final_price || leviData['מחיר סופי'] || 0);
      
      if (!basePrice && !finalPrice) {
        return `
          <div class="section">
            <div class="car-details">
              <div class="car-details-title">חישוב ערך השוק של הרכב</div>
              <p style="text-align: center; padding: 20px;">לא נמצאו נתוני הערכת לוי</p>
            </div>
          </div>
        `;
      }
      
      const adjustments = [];
      
      // Get custom market value adjustments from helper
      const marketAdjustments = helper.custom_adjustments?.full_market_adjustments || [];
      
      // Process custom adjustments
      marketAdjustments.forEach(adj => {
        if (adj.description && (adj.percentage || adj.value)) {
          const percentSign = adj.type === 'plus' ? '+' : '-';
          adjustments.push({
            label: adj.description,
            percent: adj.percentage ? `${percentSign}${adj.percentage}` : '',
            amount: adj.type === 'minus' ? -Math.abs(adj.value) : Math.abs(adj.value)
          });
        }
      });
      
      // Fallback to legacy Levi data structure if no custom adjustments
      if (adjustments.length === 0) {
        // Registration adjustment
        if (leviData['עליה לכביש %'] || leviData['ערך ש״ח עליה לכביש']) {
          adjustments.push({
            label: 'עליה לכביש',
            percent: leviData['עליה לכביש %'] || '',
            amount: leviData['ערך ש״ח עליה לכביש'] || 0
          });
        }
        
        // Ownership adjustment
        if (leviData['בעלות %'] || leviData['ערך ש״ח בעלות']) {
          adjustments.push({
            label: 'בעלות',
            percent: leviData['בעלות %'] || '',
            amount: leviData['ערך ש״ח בעלות'] || 0
          });
        }
        
        // Mileage adjustment
        if (leviData['מס ק״מ %'] || leviData['ערך ש״ח מס ק״מ']) {
          adjustments.push({
            label: 'מס ק״מ',
            percent: leviData['מס ק״מ %'] || '',
            amount: leviData['ערך ש״ח מס ק״מ'] || 0
          });
        }
        
        // Owner count adjustment
        if (leviData['מספר בעלים %'] || leviData['ערך ש״ח מספר בעלים']) {
          adjustments.push({
            label: 'מספר בעלים',
            percent: leviData['מספר בעלים %'] || '',
            amount: leviData['ערך ש״ח מספר בעלים'] || 0
          });
        }
        
        // Features adjustment
        if (leviData['מאפיינים %'] || leviData['ערך ש״ח מאפיינים']) {
          adjustments.push({
            label: 'מאפיינים',
            percent: leviData['מאפיינים %'] || '',
            amount: leviData['ערך ש״ח מאפיינים'] || 0
          });
        }
        
        // Alternative English structure
        if (leviData.adjustments) {
          Object.entries(leviData.adjustments).forEach(([key, adj]) => {
            if (adj.percent || adj.value) {
              const labelMap = {
                'registration': 'עליה לכביש',
                'ownership': 'בעלות',
                'km': 'מס ק״מ',
                'owner_count': 'מספר בעלים',
                'features': 'מאפיינים'
              };
              adjustments.push({
                label: labelMap[key] || key,
                percent: adj.percent || '',
                amount: adj.value || 0
              });
            }
          });
        }
      }
      
      const adjustmentRows = adjustments.map(adj => `
        <tr>
          <td style="padding: 8px;">${adj.label}</td>
          <td style="padding: 8px; text-align: center;">${adj.percent}%</td>
          <td style="padding: 8px; text-align: center;">${formatCurrency(adj.amount)}</td>
        </tr>
      `).join('');
      
      return `
        <div class="section adjustment-group">
          <div class="car-details">
            <div class="car-details-title">חישוב ערך השוק של הרכב</div>
            <table class="car-details-table" style="width: 100%; max-width: 700px; margin: 0 auto;">
              <tr><th style="width: 50%;">תיאור</th><th style="width: 20%;">אחוז</th><th style="width: 30%;">ערך</th></tr>
              <tr><td style="padding: 8px;">ערך הרכב ע"פ מחירון כולל מע"מ</td><td style="padding: 8px; text-align: center;">-</td><td style="padding: 8px; text-align: center;">${formatCurrency(basePrice)}</td></tr>
              ${adjustmentRows}
              <tr><td style="padding: 8px;"><strong>ערך השוק של הרכב כולל מע"מ</strong></td><td style="padding: 8px; text-align: center;">-</td><td style="padding: 8px; text-align: center;"><strong>${formatCurrency(finalPrice)}</strong></td></tr>
            </table>
          </div>
        </div>
      `;
    }
    
    function generateDepreciationAnalysis(helper) {
      // Check both depreciation data sources
      const depreciation = helper.expertise?.depreciation || helper.depreciation || {};
      const estimateDepreciation = helper.estimate_depreciation || {};
      
      // Get centers from multiple sources
      const centers = depreciation.centers || 
                     (estimateDepreciation.bulk_items || []).map(item => ({
                       part: item.damaged_part,
                       repair: item.repair_type,
                       percent: item.percent,
                       value: item.value,
                       center: item.center || item.location
                     })) || [];
      
      const globalPercent = depreciation.global_percent || estimateDepreciation.global_percent || 0;
      const globalAmount = depreciation.global_amount || estimateDepreciation.global_value || 0;
      const marketValue = helper.calculations?.market_value || helper.expertise?.levi_report?.final_price || 0;
      
      if (!centers.length && !globalPercent) {
        return `
          <div class="section">
            <div class="car-details">
              <div class="car-details-title">ירידת ערך</div>
              <p style="text-align: center; padding: 20px;">לא נמצאו נתוני ירידת ערך</p>
            </div>
          </div>
        `;
      }
      
      // Depreciation introduction
      const damageBlocks = helper.expertise?.damage_blocks || [];
      const damageWorkRows = damageBlocks.map((block, index) => `
        <tr>
          <td style="padding: 8px;">${block.location || block.center || block.name || `מוקד ${index + 1}`}</td>
          <td style="padding: 8px;">
            ${[
              ...(block.repairs || []).map(r => r.name || r.description),
              ...(block.works || []).map(w => w.type || w.description)
            ].filter(item => item).join(', ')}
          </td>
        </tr>
      `).join('');
      
      // Individual depreciation centers
      const depreciationRows = centers.map((center, index) => `
        <tr>
          <td style="padding: 8px;">${center.part || center.description || ''}</td>
          <td style="padding: 8px;">${center.repair || center.work || ''}</td>
          <td style="padding: 8px; text-align: center;">${center.percent || '0%'}</td>
          <td style="padding: 8px; text-align: center;">${formatCurrency(center.value || center.depreciation_value || 0)}</td>
          <td style="padding: 8px;">${center.center || center.name || center.location || `מוקד ${index + 1}`}</td>
        </tr>
      `).join('');
      
      return `
        <div class="section page-depreciation depreciation-group">
          <div class="car-details">
            <div class="car-details-title">ירידת ערך</div>
            <p style="font-size: 14px; font-weight: bold;">
              מממצאי בדיקתנו עולה כי הרכב נפגע והיה צורך בעבודות ותיקונים הבאים:
            </p>
            <table class="car-details-table" style="width: 100%; max-width: 700px; margin: 0 auto;">
              <tr><th style="width: 30%;">מוקד נזק</th><th style="width: 70%;">עבודות / תיקונים</th></tr>
              ${damageWorkRows}
            </table>
            <p style="font-size: 14px; font-weight: bold;">
              אנו בדעה כי ממצאים אלה ייגרמו להפחתות ערכו המסחרי של הרכב לעומת רכב זהה מאותו תוצרת, דגם ושנת ייצור שלא עבר תאונות דרכים.
            </p>
          </div>

          <div class="car-details">
            <div class="car-details-title">חישוב ירידת הערך של הרכב</div>
            <table class="car-details-table" style="width: 100%; max-width: 800px; margin: 0 auto;">
              <tr><th style="width: 25%;">החלק הניזוק</th><th style="width: 30%;">מהות התיקון</th><th style="width: 15%;">% ירידת ערך</th><th style="width: 20%;">ערך בש"ח</th><th style="width: 10%;">מוקד</th></tr>
              ${depreciationRows}
            </table>
            <p style="font-size: 14px; font-weight: bold;">
              ערך השוק של הרכב הינו ${formatCurrency(marketValue)}לפי כך, הפיצוי לירידת הערך יהיה  ${globalPercent} מערך השוק של הרכב כולל מע"מ שמסתכם ב ${formatCurrency(globalAmount)} ש"ח
            </p>
          </div>
        </div>
      `;
    }


    function formatCurrency(amount) {
      return new Intl.NumberFormat('he-IL', {
        style: 'currency',
        currency: 'ILS',
        minimumFractionDigits: 0
      }).format(amount || 0);
    }

    // Global functions for buttons
    window.editEstimate = function() {
      window.location.href = 'estimate-builder.html';
    };

    window.previewEstimate = function() {
      window.print();
    };

    window.generateEstimateReport = async function() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      try {
        console.log('🔄 Starting estimate submission to Make.com...');
        
        // Get the current HTML content for the estimate
        const estimateContent = document.getElementById('estimate-output').innerHTML;
        
        const payload = {
          type: 'estimate',
          plate: helper.meta?.plate || '',
          owner: helper.meta?.client_name || '',
          helper: helper,
          estimate_type: helper.estimate_type || 'אובדן_להלכה',
          html_content: estimateContent,
          timestamp: new Date().toISOString(),
          calculations: helper.calculations || {}
        };

        console.log('📋 Payload being sent:', {
          type: payload.type,
          plate: payload.plate,
          owner: payload.owner,
          estimate_type: payload.estimate_type,
          timestamp: payload.timestamp,
          html_content_length: payload.html_content.length
        });

        // Use the SUBMIT_ESTIMATE webhook URL
        const webhookUrl = 'https://hook.eu2.make.com/7dvgi7patq0vlgbd53hjbjasf6tek16l';
        console.log('🌐 Webhook URL:', webhookUrl);
        
        // Show loading message
        const originalAlert = window.alert;
        window.alert = () => {}; // Temporarily disable alerts
        
        console.log('📡 Sending request to Make.com...');
        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': '*/*'
          },
          body: JSON.stringify(payload)
        });
        
        console.log('📨 Response received:');
        console.log('- Status:', response.status);
        console.log('- Status Text:', response.statusText);
        console.log('- Headers:', Object.fromEntries(response.headers.entries()));
        
        // Restore alert function
        window.alert = originalAlert;
        
        if (response.status >= 200 && response.status < 300) {
          // Handle successful response
          let responseText = '';
          try {
            responseText = await response.text();
            console.log('📄 Response body:', responseText || '(empty)');
          } catch (textError) {
            console.log('⚠️ Could not read response text:', textError.message);
          }
          
          console.log('✅ Estimate submitted successfully to Make.com');
          
          // Mark estimate as finalized
          helper.meta = helper.meta || {};
          helper.meta.estimate_finalized = true;
          helper.meta.estimate_finalized_timestamp = new Date().toISOString();
          sessionStorage.setItem('helper', JSON.stringify(helper));
          
          alert('דו"ח האומדן נשלח לעיבוד בהצלחה!\n\nMake.com יעבד את הדו"ח ויצור PDF.\nתקבל התראה כאשר הדו"ח יהיה מוכן.');
          
          // Return to appropriate page based on entry mode
          const workflowMode = sessionStorage.getItem('workflowMode');
          if (workflowMode === 'centralized') {
            window.location.href = 'report-selection.html';
          } else {
            window.location.href = 'selection.html';
          }
        } else {
          // Handle HTTP error responses
          let errorText = '';
          try {
            errorText = await response.text();
          } catch (e) {
            errorText = 'Could not read error response';
          }
          
          console.error('❌ HTTP Error Response:', {
            status: response.status,
            statusText: response.statusText,
            body: errorText
          });
          
          throw new Error(`Make.com webhook failed: ${response.status} ${response.statusText}\nResponse: ${errorText}`);
        }
      } catch (error) {
        console.error('❌ Error submitting estimate to Make.com:', error);
        console.error('Error details:', {
          name: error.name,
          message: error.message,
          stack: error.stack
        });
        
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          alert('שגיאת רשת: לא ניתן להתחבר ל-Make.com\n\nאנא בדוק:\n- חיבור האינטרנט\n- כתובת ה-webhook ב-Make.com\n\nפרטי שגיאה: ' + error.message);
        } else {
          alert('שגיאה בשליחת האומדן ל-Make.com לעיבוד\n\nאנא נסה שוב או פנה לתמיכה טכנית.\n\nפרטי שגיאה: ' + error.message);
        }
      }
    };

    window.goHome = function() {
      const workflowMode = sessionStorage.getItem('workflowMode');
      if (workflowMode === 'centralized') {
        window.location.href = 'report-selection.html';
      } else {
        window.location.href = 'selection.html';
      }
    };

    // Validation function for testing
    function validateEstimateData() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Debug: Log the actual helper structure
      console.log('🔍 Debug - Current helper structure:', helper);
      console.log('🔍 Debug - Available top-level keys:', Object.keys(helper));
      if (helper.meta) console.log('🔍 Debug - meta keys:', Object.keys(helper.meta));
      if (helper.car_details) console.log('🔍 Debug - car_details keys:', Object.keys(helper.car_details));
      if (helper.general_info) console.log('🔍 Debug - general_info keys:', Object.keys(helper.general_info));
      if (helper.calculations) console.log('🔍 Debug - calculations keys:', Object.keys(helper.calculations));
      
      const validation = {
        valid: true,
        errors: [],
        warnings: []
      };
      
      // Check for plate number in multiple possible locations
      const plateNumber = helper.meta?.plate || helper.car_details?.plate || helper.general_info?.plate;
      if (!plateNumber) {
        validation.errors.push('מספר רישוי חסר');
        validation.valid = false;
      }
      
      // Check for client/owner name in multiple possible locations
      const clientName = helper.meta?.client_name || 
                        helper.general_info?.client_name || 
                        helper.general_info?.owner_name ||
                        helper.car_details?.owner ||
                        helper.owner_details?.name;
      if (!clientName) {
        validation.errors.push('שם בעל הרכב חסר');
        validation.valid = false;
      }
      
      // Check for vehicle manufacturer in multiple locations
      const manufacturer = helper.vehicle?.manufacturer || 
                          helper.car_details?.manufacturer ||
                          helper.car_details?.make;
      if (!manufacturer) {
        validation.warnings.push('יצרן רכב חסר');
      }
      
      // Check for vehicle model in multiple locations
      const model = helper.vehicle?.model || 
                   helper.car_details?.model;
      if (!model) {
        validation.warnings.push('דגם רכב חסר');
      }
      
      // Check for damage calculations in multiple possible structures
      const baseDamage = helper.calculations?.base_damage || 
                        helper.calculations?.total_damage ||
                        helper.calculations?.total_before_depreciation ||
                        helper.levi_report?.total_damage ||
                        helper.damage_calculation?.total;
      
      if (!baseDamage || baseDamage <= 0) {
        validation.errors.push('חישוב נזק בסיסי חסר או שגוי');
        validation.valid = false;
      }
      
      // Check for depreciation data
      const depreciationPercent = helper.depreciation?.global_percent || 
                                 helper.depreciation?.percentage ||
                                 helper.calculations?.depreciation_percent;
      if (!depreciationPercent) {
        validation.warnings.push('אחוז ירידת ערך גלובלי חסר');
      }
      
      console.log('🔍 Validation results:', validation);
      console.log('🔍 Found values:', {
        plateNumber,
        clientName,
        manufacturer,
        model,
        baseDamage,
        depreciationPercent
      });
      
      return validation;
    }
    
    // Test print functionality
    function testPrintPreview() {
      console.log('🖨️ Testing print preview...');
      
      // Validate data first
      const validation = validateEstimateData();
      if (!validation.valid) {
        console.error('❌ Validation failed:', validation.errors);
        alert('לא ניתן להדפיס - יש שגיאות בנתונים:\n' + validation.errors.join('\n'));
        return false;
      }
      
      // Test print functionality
      try {
        window.print();
        console.log('✅ Print preview opened successfully');
        return true;
      } catch (error) {
        console.error('❌ Print preview failed:', error);
        alert('שגיאה בפתיחת תצוגה מקדימה להדפסה');
        return false;
      }
    }
    
    // Test webhook connectivity
    async function testWebhookConnection() {
      console.log('🔗 Testing webhook connection...');
      
      const webhookUrl = 'https://hook.eu2.make.com/7dvgi7patq0vlgbd53hjbjasf6tek16l';
      
      try {
        const testPayload = {
          type: 'test',
          timestamp: new Date().toISOString(),
          message: 'Connection test from estimate builder'
        };
        
        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(testPayload)
        });
        
        if (response.ok) {
          console.log('✅ Webhook connection successful');
          return true;
        } else {
          console.error('❌ Webhook connection failed:', response.status, response.statusText);
          return false;
        }
      } catch (error) {
        console.error('❌ Webhook connection error:', error);
        return false;
      }
    }
    
    // Update previewEstimate to use validation
    window.previewEstimate = function() {
      testPrintPreview();
    };
    
    // Smart validation dependencies based on access mode
    function checkAccessMode() {
      const currentUrl = window.location.href;
      const referrer = document.referrer;
      const workflowMode = sessionStorage.getItem('workflowMode');
      
      // Check URL parameters for expertise access
      const urlParams = new URLSearchParams(window.location.search);
      const fromExpertise = urlParams.get('from') === 'expertise';
      const skipValidation = urlParams.get('skipValidation') === 'true';
      
      // Check if report is finalized
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      const isFinalized = helper.meta?.finalized === true || helper.meta?.estimate_finalized === true;
      
      // If accessed from expertise or not finalized, show draft with watermark
      if (fromExpertise || skipValidation || referrer.includes('expertise') || workflowMode === 'draft_view' || !isFinalized) {
        return 'draft'; // No validation required, read-only with watermark
      }
      
      // If accessed from estimate workflow and finalized, allow builder mode
      if (referrer.includes('estimate-') || workflowMode === 'estimate_builder') {
        return isFinalized ? 'final' : 'draft'; // Requires validation if not finalized
      }
      
      // Default to draft mode for safety (always show watermark until finalized)
      return 'draft';
    }
    
    // Real-time helper data watcher
    function startEstimateHelperWatcher() {
      let lastHelperData = sessionStorage.getItem('helper') || '{}';
      
      setInterval(() => {
        try {
          const currentHelperData = sessionStorage.getItem('helper') || '{}';
          
          if (currentHelperData !== lastHelperData) {
            console.log('🔄 Helper data changed, updating estimate report...');
            lastHelperData = currentHelperData;
            
            // Only auto-update if in draft mode
            const accessMode = checkAccessMode();
            if (accessMode === 'draft') {
              injectEstimateHTML();
            }
          }
        } catch (error) {
          console.warn('Error watching helper data:', error);
        }
      }, 1000);
      
      // Listen for helper update events
      window.addEventListener('helperUpdated', () => {
        console.log('📡 Helper update event received, refreshing estimate report');
        const accessMode = checkAccessMode();
        if (accessMode === 'draft') {
          injectEstimateHTML();
        }
      });
    }
    
    // Add draft watermark
    function addDraftWatermark() {
      const accessMode = checkAccessMode();
      if (accessMode === 'draft') {
        const watermark = document.createElement('div');
        watermark.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%) rotate(-45deg);
          font-size: 6rem;
          color: rgba(220, 38, 38, 0.1);
          z-index: 1000;
          pointer-events: none;
          font-weight: bold;
          white-space: nowrap;
        `;
        watermark.textContent = 'טיוטה';
        document.body.appendChild(watermark);
        
        // Also disable edit buttons in draft mode
        const buttons = document.querySelectorAll('.control-buttons button');
        buttons.forEach(button => {
          if (button.textContent.includes('ערוך') || button.textContent.includes('הפק')) {
            button.style.display = 'none';
          }
        });
      }
    }
    
    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
      console.log('🔄 Estimate Report Builder loaded and ready');
      
      const accessMode = checkAccessMode();
      console.log('🔍 Access mode detected:', accessMode);
      
      if (accessMode === 'builder') {
        // Builder mode: require validation
        const validationCompleted = sessionStorage.getItem('estimateValidationCompleted');
        if (!validationCompleted) {
          console.warn('⚠️ Validation required for builder mode, redirecting...');
          alert('יש להשלים תחילה את תהליך האימות');
          window.location.href = 'estimate-validation.html';
          return;
        }
      }
      
      // Add draft watermark if in draft mode
      addDraftWatermark();
      
      // Start real-time helper watcher
      startEstimateHelperWatcher();
      
      // Run validation and injection on load
      setTimeout(() => {
        if (accessMode === 'builder') {
          const validation = validateEstimateData();
          if (validation.errors.length > 0) {
            console.warn('⚠️ Data validation errors found:', validation.errors);
          }
          if (validation.warnings.length > 0) {
            console.warn('⚠️ Data validation warnings:', validation.warnings);
          }
          
          // Always inject in builder mode after validation
          injectEstimateHTML();
        } else {
          // Draft mode: always show content without strict validation
          console.log('📄 Draft mode: showing content without validation');
          injectEstimateHTML();
        }
      }, 1000);
    });
  </script>
  
  <!-- Control buttons moved to end of page -->
  <div class="control-buttons no-print" style="margin-top: 40px;">
    <button class="btn-secondary" onclick="editEstimate()">✏️ ערוך אומדן</button>
    <button class="btn-primary" onclick="previewEstimate()">👁️ תצוגה מקדימה</button>
    <button class="btn-success" onclick="generateEstimateReport()">📄 הפק דו"ח אומדן</button>
    <button class="btn-secondary" onclick="goHome()">🏠 חזור לדף הבית</button>
  </div>
  
  </div>
</body>
</html>