<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>עיבוד חשבוניות - OCR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link href="https://fonts.googleapis.com/css2?family=Assistant&display=swap" rel="stylesheet" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #1e293b 100%);
      background-attachment: fixed;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      direction: rtl;
      position: relative;
      overflow-x: hidden;
    }

    /* Animated background particles */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image:
        radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
      animation: float 20s ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes float {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.1); }
    }

    .container {
      max-width: 580px;
      width: 100%;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(20px);
      padding: 35px;
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      position: relative;
      z-index: 1;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 30px;
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .logo img {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      margin-bottom: 20px;
      border: 3px solid rgba(99, 102, 241, 0.3);
      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
      animation: logoGlow 3s ease-in-out infinite;
    }

    @keyframes logoGlow {
      0%, 100% { box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3); }
      50% { box-shadow: 0 8px 32px rgba(139, 92, 246, 0.5); }
    }

    .title {
      font-size: 26px;
      font-weight: 700;
      background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    h2 {
      font-size: 20px;
      color: #e0e7ff;
      margin-bottom: 25px;
      font-weight: 600;
    }

    .subtitle {
      font-size: 16px;
      color: #94a3b8;
      margin-bottom: 15px;
      font-weight: 500;
    }
    
    .section {
      margin-bottom: 25px;
      padding: 25px;
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .section h3 {
      margin: 0 0 20px 0;
      color: #cbd5e1;
      font-size: 18px;
      font-weight: 600;
      border-bottom: 2px solid rgba(99, 102, 241, 0.3);
      padding-bottom: 12px;
    }
    
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .form-group {
      flex: 1;
      min-width: 200px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #cbd5e1;
      font-size: 14px;
    }

    input, select, textarea {
      width: 100%;
      padding: 14px 16px;
      font-size: 15px;
      border-radius: 12px;
      border: 1.5px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      color: #e2e8f0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-sizing: border-box;
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #6366f1;
      background: rgba(255, 255, 255, 0.08);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1), 0 8px 16px rgba(0, 0, 0, 0.2);
      transform: translateY(-2px);
    }
    
    .file-upload-area {
      border: 3px dashed #bdc3c7;
      border-radius: 15px;
      padding: 40px 20px;
      text-align: center;
      background: #ecf0f1;
      transition: all 0.3s ease;
      cursor: pointer;
      margin-bottom: 20px;
    }
    
    .file-upload-area:hover {
      border-color: #3498db;
      background: #ebf3fd;
    }
    
    .file-upload-area.dragover {
      border-color: #27ae60;
      background: #e8f5e8;
    }
    
    .upload-icon {
      font-size: 48px;
      color: #95a5a6;
      margin-bottom: 15px;
    }
    
    .upload-text {
      font-size: 18px;
      color: #7f8c8d;
      margin-bottom: 10px;
    }
    
    .upload-hint {
      font-size: 14px;
      color: #95a5a6;
    }
    
    #file-input {
      display: none;
    }
    
    .preview-container {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }
    
    .preview-image {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    .btn {
      padding: 15px 30px;
      font-size: 16px;
      font-weight: 600;
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin: 10px 5px;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .btn:hover {
      background: linear-gradient(135deg, #2980b9, #21618c);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
    }
    
    .btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #27ae60, #229954);
    }
    
    .btn-success:hover {
      background: linear-gradient(135deg, #229954, #1e8449);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #95a5a6, #7f8c8d);
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, #7f8c8d, #6c7b7d);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
    }
    
    .btn-danger:hover {
      background: linear-gradient(135deg, #c0392b, #a93226);
    }
    
    .processing-status {
      display: none;
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .processing-status.show {
      display: block;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #ecf0f1;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 15px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3498db, #2980b9);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .ocr-results {
      display: none;
      background: white;
      border-radius: 10px;
      padding: 25px;
      margin-top: 20px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    .ocr-results.show {
      display: block;
    }
    
    .results-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .results-table th,
    .results-table td {
      padding: 12px;
      text-align: right;
      border-bottom: 1px solid #ecf0f1;
    }
    
    .results-table th {
      background: #34495e;
      color: white;
      font-weight: 600;
    }
    
    .results-table tr:hover {
      background: #f8f9fa;
    }
    
    .validation-status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      display: none;
    }
    
    .validation-status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .validation-status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .validation-status.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .validation-status.show {
      display: block;
    }
    
    .footer-btns {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e1e8ed;
    }
    
    .footer {
      text-align: center;
      font-size: 12px;
      margin-top: 20px;
      color: #95a5a6;
    }
    
    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
    }
    
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        padding: 20px;
      }
      
      .form-row {
        flex-direction: column;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .footer-btns {
        flex-direction: column;
      }
    }
    
    .alert {
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
    }
    
    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .alert.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .alert.show {
      display: block;
    }
  </style>
</head>
<body>

<script type="module">
  import { WEBHOOKS } from './webhook.js';
  import { caseOwnershipService } from './services/caseOwnershipService.js';
  
  window.WEBHOOKS = WEBHOOKS;
  
  // Phase 6: Case ownership check
  (async () => {
    const plateNumber = window.helper?.plate || sessionStorage.getItem('currentPlate');
    
    if (plateNumber) {
      const ownershipCheck = await caseOwnershipService.canEditCase(plateNumber);
      
      if (!ownershipCheck.canEdit) {
        alert(ownershipCheck.reason || 'אין לך הרשאה לערוך תיק זה.\n\nרק הבעלים, מנהל או מפתח יכולים לערוך.');
        window.location.href = 'selection.html';
        return;
      }
      
      console.log('✅ Case ownership verified - user can upload invoices');
    }
  })();
</script>

<div class="container">
  <div class="header">
    <div class="logo">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo" />
    </div>
    <h1 class="title">ירון כיוף - שמאות וייעוץ</h1>
    <div class="subtitle">שמאות והערכת נזקי רכב ורכוש</div>
    <h2>עיבוד חשבוניות - OCR</h2>
  </div>

  <div id="alerts-container"></div>

  <form id="invoice-form" method="POST" onsubmit="return false;">
    <!-- Case Information Section -->
    <div class="section">
      <h3>פרטי התיק</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="plate">מספר רישוי:</label>
          <input id="plate" name="plate" placeholder="מספר רישוי הרכב" required type="text" />
        </div>
        <div class="form-group">
          <label for="owner">שם בעל הרכב:</label>
          <input id="owner" name="owner" placeholder="שם בעל הרכב" required type="text" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="garage_name">שם המוסך:</label>
          <input id="garage_name" name="garage_name" placeholder="שם המוסך (אופציונלי)" type="text" />
        </div>
        <div class="form-group">
          <label for="date">תאריך:</label>
          <input id="date" name="date" type="date" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="invoice-type">סוג חשבונית:</label>
          <select id="invoice-type" name="invoice-type">
            <option value="parts">חלקים</option>
            <option value="labor">עבודה</option>
            <option value="mixed">מעורב</option>
            <option value="other">אחר</option>
          </select>
        </div>
      </div>
    </div>

    <!-- File Upload Section -->
    <div class="section">
      <h3>העלאת חשבונית</h3>
      <div class="file-upload-area" onclick="document.getElementById('file-input').click()">
        <div class="upload-icon">📄</div>
        <div class="upload-text">לחץ כאן או גרור חשבונית לאזור זה</div>
        <div class="upload-hint">תומך בקבצי PDF, JPG, PNG | גודל מקסימלי: 10MB</div>
      </div>
      <input id="file-input" type="file" accept="image/*,.pdf" required />
      
      <!-- Preview Container -->
      <div class="preview-container" id="preview-container">
        <img id="preview-image" class="preview-image" style="display: none;" />
      </div>
    </div>

    <!-- Processing Status -->
    <div class="processing-status" id="processing-status">
      <h3>מעבד חשבונית...</h3>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div id="progress-text">אנא המתן...</div>
    </div>

    <!-- OCR Results Section -->
    <div class="ocr-results" id="ocr-results">
      <h3>תוצאות עיבוד OCR</h3>
      <div id="ocr-summary"></div>
      <table class="results-table" id="results-table">
        <thead>
          <tr>
            <th>פריט</th>
            <th>תיאור</th>
            <th>כמות</th>
            <th>מחיר יחידה</th>
            <th>סה"כ</th>
            <th>פעולות</th>
          </tr>
        </thead>
        <tbody id="results-body">
          <!-- OCR results will be populated here -->
        </tbody>
      </table>
    </div>

    <!-- Validation Status -->
    <div class="validation-status" id="validation-status">
      <!-- Validation messages will appear here -->
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button type="submit" id="process-invoice" class="btn btn-success">
        🔍 עבד חשבונית
      </button>
      <button type="button" id="save-results" class="btn btn-primary" style="display: none;">
        💾 שמור תוצאות
      </button>
      <button type="button" id="clear-form" class="btn btn-secondary">
        🗑️ נקה טופס
      </button>
    </div>
  </form>

  <!-- SESSION 76: Manual Invoice Entry - COMPLETELY SEPARATE from OCR upload -->
  <!-- For rare cases when there's no physical invoice document available -->
  <div class="section" style="margin-top: 40px; border-top: 3px solid #ffc107; padding-top: 20px;">
    <h3 onclick="toggleManualSection()" style="cursor: pointer; user-select: none; background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); padding: 15px; border-radius: 8px; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <span id="manual-toggle-icon">▼</span> ✏️ הזנת חשבונית ידנית
      <small style="display: block; font-size: 13px; font-weight: normal; margin-top: 8px; opacity: 0.95;">
        ⚠️ למקרים נדירים בלבד - כאשר אין חשבונית פיזית/דיגיטלית זמינה
      </small>
    </h3>
    <div id="manual-section-content" style="display: none; background: #fff9e6; padding: 20px; border-radius: 8px; margin-top: 10px;">
      <p style="color: #856404; font-size: 14px; margin-bottom: 15px; font-weight: bold;">
        📝 השתמש באפשרות זו רק אם אין אפשרות להעלות חשבונית - הזן פרטים ידנית
      </p>
      <div class="form-row">
        <div class="form-group">
          <label for="manual-item">פריט:</label>
          <input id="manual-item" type="text" placeholder="שם הפריט" />
        </div>
        <div class="form-group">
          <label for="manual-desc">תיאור:</label>
          <input id="manual-desc" type="text" placeholder="תיאור" />
        </div>
        <div class="form-group">
          <label for="manual-qty">כמות:</label>
          <input id="manual-qty" type="number" min="1" value="1" />
        </div>
        <div class="form-group">
          <label for="manual-price">מחיר:</label>
          <input id="manual-price" type="number" step="0.01" placeholder="0.00" />
        </div>
      </div>
      <button type="button" id="add-manual-item" class="btn btn-warning" style="font-size: 16px; padding: 12px 24px;">
        ➕ הוסף פריט לרשימה
      </button>
    </div>
  </div>

  <div class="footer-btns">
    <button class="btn btn-secondary" onclick="window.location.href='selection.html'">🏠 עמוד הבית</button>
    <button class="btn btn-danger" onclick="logout()">🚪 יציאה</button>
  </div>

  <div class="footer">@2025 Carmel Cayouf. All rights reserved. SmartVal Pro System by Eval ©</div>
</div>

<!-- SESSION 56: Load helper.js as regular script BEFORE module script -->
<script src="helper.js"></script>
<!-- SESSION 76: Load all scripts as modules to support export statements -->
<script type="module">
// Import Supabase client and expose globally for non-module code
import { supabase } from './lib/supabaseClient.js';
window.supabase = supabase;
console.log('✅ Supabase client loaded as module and exposed globally');
</script>
<script src="services/invoice-service.js"></script>
<script src="services/invoice-helper-sync.js"></script>
<script type="module">
import { sendToWebhook, getWebhook } from './webhook.js';
// SESSION 56: helper.js is NOT an ES6 module - use window.updateHelper
// import { updateHelper } from './helper.js';
// SESSION 74: Phase 5a Invoice Integration with Supabase

// Enhanced Invoice Processing System
class InvoiceProcessor {
  constructor() {
    this.uploadedFile = null;
    this.ocrResults = [];
    this.processingInProgress = false;
    this.maxFileSize = 10 * 1024 * 1024; // 10MB
    this.allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'application/pdf'];
    
    // SESSION 74: Supabase integration
    this.invoiceService = window.invoiceService;
    this.invoiceHelperSync = window.invoiceHelperSync;
    this.currentDocumentId = null;
    this.currentInvoiceId = null;
    
    this.init();
  }

  init() {
    this.setupEventListeners();
    this.loadCaseData();
    this.setupDragAndDrop();
  }

  setupEventListeners() {
    // File input change
    const fileInput = document.getElementById('file-input');
    if (fileInput) {
      fileInput.addEventListener('change', (e) => {
        this.handleFileSelection(e.target.files[0]);
      });
    } else {
      console.error('❌ File input element not found - file-input missing');
    }

    // Form submission
    const invoiceForm = document.getElementById('invoice-form');
    if (invoiceForm) {
      invoiceForm.addEventListener('submit', (e) => {
        e.preventDefault();
        this.processInvoice();
      });
    } else {
      console.error('❌ Invoice form element not found - invoice-form missing');
    }

    // Manual item addition
    document.getElementById('add-manual-item').addEventListener('click', () => {
      this.addManualItem();
    });

    // Clear form
    document.getElementById('clear-form').addEventListener('click', () => {
      this.clearForm();
    });

    // Save results
    document.getElementById('save-results').addEventListener('click', () => {
      this.saveResults();
    });
  }

  loadCaseData() {
    // Load case data from session storage
    const plate = sessionStorage.getItem('plate');
    const owner = sessionStorage.getItem('owner');
    // SESSION 74: Removed pass loading - using Supabase auth only
    const garageName = sessionStorage.getItem('garage_name');
    const today = new Date().toISOString().split('T')[0];

    if (plate) document.getElementById('plate').value = plate;
    if (owner) document.getElementById('owner').value = owner;
    // SESSION 74: Removed pass field setting - using Supabase auth only
    if (garageName) document.getElementById('garage_name').value = garageName;
    document.getElementById('date').value = today;

    // Load from helper if available
    try {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      if (helper.car_details) {
        document.getElementById('plate').value = helper.car_details.plate || '';
      }
      if (helper.general_info) {
        document.getElementById('owner').value = helper.general_info.owner_name || '';
        // Load garage name from helper if available
        if (helper.general_info.garage_name) {
          document.getElementById('garage_name').value = helper.general_info.garage_name;
        }
      }
      // SESSION 74: Password auth removed - using Supabase auth only
    } catch (e) {
      console.warn('Could not load helper data:', e);
    }
  }

  // SESSION 74: validatePassword() removed - using Supabase auth only
  validatePassword() {
    // No password validation needed - Supabase handles authentication
    return true;
  }

  setupDragAndDrop() {
    const uploadArea = document.querySelector('.file-upload-area');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, this.preventDefaults, false);
      document.body.addEventListener(eventName, this.preventDefaults, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
      uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
    });

    uploadArea.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const files = dt.files;
      if (files.length > 0) {
        this.handleFileSelection(files[0]);
      }
    }, false);
  }

  preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  async handleFileSelection(file) {
    if (!file) return;

    if (!this.validateFile(file)) {
      return;
    }

    this.uploadedFile = file;
    this.showPreview(file);
    
    // SESSION 76: Reset state for new file to prevent reusing old IDs
    const isNewFile = !this.currentDocumentId || this.uploadedFile.name !== file.name;
    if (isNewFile) {
      this.currentDocumentId = null;
      this.currentInvoiceId = null;
      this.ocrResults = [];
      console.log('📁 New file selected - reset state');
    }
    
    // SESSION 76: Only upload to Supabase if NOT already uploaded
    if (this.currentDocumentId) {
      console.log('✅ File already uploaded, reusing document ID:', this.currentDocumentId);
      this.showAlert('קובץ כבר נטען, לחץ "עבד חשבונית" להמשך', 'info');
      return;
    }
    
    // SESSION 74: Upload to Supabase Storage
    try {
      let caseId = sessionStorage.getItem('currentCaseId');
      const plate = document.getElementById('plate').value;
      
      // Try to get case ID from helper if not in sessionStorage
      if (!caseId) {
        try {
          const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
          // Check helper.case_info.supabase_case_id first, then fallback to helper.case_id
          if (helper.case_info && helper.case_info.supabase_case_id) {
            caseId = helper.case_info.supabase_case_id;
            sessionStorage.setItem('currentCaseId', caseId);
            console.log('✅ Found case ID in helper.case_info.supabase_case_id:', caseId);
          } else if (helper.case_id) {
            caseId = helper.case_id;
            sessionStorage.setItem('currentCaseId', caseId);
            console.log('✅ Found case ID in helper.case_id:', caseId);
          }
        } catch (e) {
          console.warn('Could not get case ID from helper:', e);
        }
      }
      
      if (!caseId) {
        console.warn('⚠️ No case ID found, skipping Supabase upload (will save via webhook)');
        this.showAlert('קובץ נטען בהצלחה (ללא שמירה בענן - פתח מתוך תיק לשמירה מלאה)', 'info');
        return;
      }

      console.log('📤 Uploading invoice document to Supabase (FIRST TIME)...');
      const result = await this.invoiceService.uploadInvoiceDocument(file, caseId, plate, null);
      
      if (result.success) {
        this.currentDocumentId = result.document.id;
        console.log('✅ Document uploaded to Supabase:', this.currentDocumentId);
        this.showAlert('קובץ נטען ונשמר בהצלחה', 'success');
      }
    } catch (error) {
      console.error('❌ Supabase upload failed:', error);
      this.showAlert('קובץ נטען (שמירה בענן נכשלה)', 'warning');
    }
  }

  validateFile(file) {
    if (!this.allowedTypes.includes(file.type)) {
      this.showAlert(`סוג קובץ לא נתמך: ${file.name}`, 'error');
      return false;
    }

    if (file.size > this.maxFileSize) {
      this.showAlert(`קובץ גדול מדי: ${file.name} (מקסימום 10MB)`, 'error');
      return false;
    }

    return true;
  }

  showPreview(file) {
    const previewContainer = document.getElementById('preview-container');
    const previewImage = document.getElementById('preview-image');
    
    // Add null checks to prevent errors
    if (!previewContainer || !previewImage) {
      console.error('❌ Preview elements not found - preview-container or preview-image missing');
      return;
    }
    
    if (file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage.src = e.target.result;
        previewImage.style.display = 'block';
        previewContainer.style.display = 'block';
      };
      reader.readAsDataURL(file);
    } else {
      previewImage.style.display = 'none';
      previewContainer.style.display = 'block';
      previewContainer.innerHTML = `
        <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
          <div style="font-size: 48px; color: #dc3545; margin-bottom: 10px;">📄</div>
          <div>קובץ PDF נטען: ${file.name}</div>
        </div>
      `;
    }
  }

  async processInvoice() {
    if (this.processingInProgress) return;
    
    if (!this.uploadedFile) {
      this.showAlert('אנא בחר קובץ חשבונית', 'error');
      return;
    }

    if (!this.validateForm()) {
      return;
    }

    this.processingInProgress = true;
    this.showProcessingStatus(true);
    
    try {
      const formData = new FormData();
      formData.append('file', this.uploadedFile);
      // SESSION 74: Removed 'pass' field - using Supabase auth only
      // Add defensive checks for all fields
      const plateEl = document.getElementById('plate');
      const ownerEl = document.getElementById('owner');
      const garageEl = document.getElementById('garage_name');
      const dateEl = document.getElementById('date');
      const typeEl = document.getElementById('invoice-type');
      
      formData.append('meta', JSON.stringify({
        plate: plateEl ? plateEl.value : '',
        owner: ownerEl ? ownerEl.value : '',
        garage_name: garageEl ? garageEl.value : '',
        date: dateEl ? dateEl.value : '',
        invoice_type: typeEl ? typeEl.value : ''
      }));

      // FIXED: Use sendToWebhook to get proper Make.com array parsing
      const result = await sendToWebhook('OCR_INVOICES', formData);
      
      console.log('✅ Invoice OCR webhook response:', result);
      this.handleOCRResults(result);
      this.showAlert('✅ חשבונית עובדה בהצלחה', 'success');
      
    } catch (error) {
      console.error('Invoice processing error:', error);
      this.showAlert('❌ שגיאה בעיבוד החשבונית: ' + error.message, 'error');
    } finally {
      this.processingInProgress = false;
      this.showProcessingStatus(false);
    }
  }

  validateForm() {
    // SESSION 74: Removed 'pass' from required fields - using Supabase auth only
    const required = ['plate', 'owner'];
    for (const fieldId of required) {
      const field = document.getElementById(fieldId);
      if (!field || !field.value.trim()) {
        this.showAlert(`שדה חובה: ${field ? field.previousElementSibling.textContent : fieldId}`, 'error');
        if (field) field.focus();
        return false;
      }
    }
    
    return true;
  }

  async handleOCRResults(result) {
    this.ocrResults = result.items || [];
    this.displayOCRResults(result);
    this.showValidationStatus(result);
    
    // SESSION 74: Save OCR results to Supabase
    try {
      if (this.currentDocumentId) {
        console.log('💾 Saving OCR results to Supabase...');
        await this.invoiceService.updateOCRResults(this.currentDocumentId, result);
        console.log('✅ OCR results saved to Supabase');
      } else {
        console.warn('⚠️ No document ID, skipping Supabase OCR save');
      }
    } catch (error) {
      console.error('❌ Failed to save OCR results to Supabase:', error);
    }
    
    // Update helper with OCR results
    this.updateHelperWithResults(result);
    
    // Show save button
    document.getElementById('save-results').style.display = 'inline-block';
  }

  displayOCRResults(result) {
    const ocrContainer = document.getElementById('ocr-results');
    const summaryContainer = document.getElementById('ocr-summary');
    const resultsBody = document.getElementById('results-body');
    
    // Show OCR results section
    ocrContainer.classList.add('show');
    
    // SESSION 76: Calculate totals by category
    let totalParts = 0, totalWorks = 0, totalRepairs = 0, totalOther = 0;
    
    this.ocrResults.forEach(item => {
      const lineTotal = (item.quantity || 1) * (item.unit_price || 0);
      const category = this.categorizeItem(item.name || item.description || '');
      
      if (category === 'PART') totalParts += lineTotal;
      else if (category === 'WORK') totalWorks += lineTotal;
      else if (category === 'REPAIR') totalRepairs += lineTotal;
      else totalOther += lineTotal;
    });
    
    const calculatedTotal = totalParts + totalWorks + totalRepairs + totalOther;
    
    // Get invoice details
    const invoiceNumber = result['מס. חשבונית'] || result.invoice_number || `INV-${Date.now()}`;
    const garageName = document.getElementById('garage_name').value || result['שם מוסך'] || 'לא צוין';
    const plate = document.getElementById('plate').value || 'לא צוין';
    const invoiceDate = document.getElementById('date').value || new Date().toISOString().split('T')[0];
    
    // Display enhanced summary
    summaryContainer.innerHTML = `
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h4 style="margin: 0 0 15px 0; font-size: 20px; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 10px;">📋 סיכום חשבונית</h4>
        
        <!-- Invoice Header Info -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
          <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 8px;">
            <div style="font-size: 12px; opacity: 0.9;">מספר חשבונית</div>
            <div style="font-size: 18px; font-weight: bold; margin-top: 5px;">${invoiceNumber}</div>
          </div>
          <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 8px;">
            <div style="font-size: 12px; opacity: 0.9;">מוסך</div>
            <div style="font-size: 16px; font-weight: bold; margin-top: 5px;">${garageName}</div>
          </div>
          <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 8px;">
            <div style="font-size: 12px; opacity: 0.9;">מספר רכב</div>
            <div style="font-size: 18px; font-weight: bold; margin-top: 5px;">${plate}</div>
          </div>
          <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 8px;">
            <div style="font-size: 12px; opacity: 0.9;">תאריך</div>
            <div style="font-size: 16px; font-weight: bold; margin-top: 5px;">${invoiceDate}</div>
          </div>
        </div>
        
        <!-- Cost Breakdown by Category -->
        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <div style="font-size: 14px; margin-bottom: 10px; font-weight: bold;">פירוט עלויות לפי קטגוריה:</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
            <div style="background: rgba(76, 175, 80, 0.3); padding: 8px; border-radius: 6px; text-align: center;">
              <div style="font-size: 11px; opacity: 0.9;">🔧 חלקים</div>
              <div style="font-size: 16px; font-weight: bold;">₪${totalParts.toFixed(2)}</div>
            </div>
            <div style="background: rgba(33, 150, 243, 0.3); padding: 8px; border-radius: 6px; text-align: center;">
              <div style="font-size: 11px; opacity: 0.9;">👷 עבודות</div>
              <div style="font-size: 16px; font-weight: bold;">₪${totalWorks.toFixed(2)}</div>
            </div>
            <div style="background: rgba(255, 152, 0, 0.3); padding: 8px; border-radius: 6px; text-align: center;">
              <div style="font-size: 11px; opacity: 0.9;">🔨 תיקונים</div>
              <div style="font-size: 16px; font-weight: bold;">₪${totalRepairs.toFixed(2)}</div>
            </div>
            ${totalOther > 0 ? `
            <div style="background: rgba(158, 158, 158, 0.3); padding: 8px; border-radius: 6px; text-align: center;">
              <div style="font-size: 11px; opacity: 0.9;">📦 אחר</div>
              <div style="font-size: 16px; font-weight: bold;">₪${totalOther.toFixed(2)}</div>
            </div>
            ` : ''}
          </div>
        </div>
        
        <!-- Total and Stats -->
        <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
          <div>
            <div style="font-size: 12px; opacity: 0.9;">מספר פריטים: <strong>${this.ocrResults.length}</strong></div>
            <div style="font-size: 12px; opacity: 0.9;">דיוק OCR: <strong>${result.confidence || 'לא זמין'}%</strong></div>
          </div>
          <div style="text-align: left;">
            <div id="summary-total" style="font-size: 14px; opacity: 0.9;">סה"כ לתשלום</div>
            <div style="font-size: 28px; font-weight: bold;">₪${calculatedTotal.toFixed(2)}</div>
          </div>
        </div>
        
        ${this.currentDocumentId ? `
        <div style="margin-top: 15px; text-align: center;">
          <button onclick="window.invoiceProcessor.viewInvoicePDF()" class="btn" style="background: rgba(255,255,255,0.9); color: #667eea; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
            📄 צפה בחשבונית המקורית
          </button>
        </div>
        ` : ''}
      </div>
    `;
    
    // Display results table
    resultsBody.innerHTML = '';
    this.ocrResults.forEach((item, index) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input type="text" value="${item.name || ''}" data-field="name" data-index="${index}" class="result-field"></td>
        <td><input type="text" value="${item.description || ''}" data-field="description" data-index="${index}" class="result-field"></td>
        <td><input type="number" value="${item.quantity || 1}" data-field="quantity" data-index="${index}" class="result-field" min="1"></td>
        <td><input type="number" value="${item.unit_price || 0}" data-field="unit_price" data-index="${index}" class="result-field" step="0.01"></td>
        <td><span class="total-cell">₪${(item.quantity || 1) * (item.unit_price || 0)}</span></td>
        <td><button type="button" onclick="window.invoiceProcessor.removeItem(${index})" class="btn btn-danger">הסר</button></td>
      `;
      resultsBody.appendChild(row);
    });
    
    // Add event listeners for real-time calculation
    document.querySelectorAll('.result-field').forEach(field => {
      field.addEventListener('input', (e) => {
        this.updateItemCalculation(e.target);
      });
    });
  }

  updateItemCalculation(field) {
    const index = field.dataset.index;
    const fieldType = field.dataset.field;
    const value = field.value;
    
    // Update internal data
    if (this.ocrResults[index]) {
      this.ocrResults[index][fieldType] = fieldType === 'quantity' || fieldType === 'unit_price' ? parseFloat(value) || 0 : value;
      
      // Update total display
      const row = field.closest('tr');
      const totalCell = row.querySelector('.total-cell');
      const quantity = parseFloat(row.querySelector('[data-field="quantity"]').value) || 0;
      const unitPrice = parseFloat(row.querySelector('[data-field="unit_price"]').value) || 0;
      totalCell.textContent = `₪${quantity * unitPrice}`;
      
      // Update overall totals
      this.updateOverallTotals();
    }
  }

  updateOverallTotals() {
    // SESSION 76: Recalculate totals by category
    let totalParts = 0, totalWorks = 0, totalRepairs = 0, totalOther = 0;
    
    this.ocrResults.forEach(item => {
      const lineTotal = (item.quantity || 1) * (item.unit_price || 0);
      const category = this.categorizeItem(item.name || item.description || '');
      
      if (category === 'PART') totalParts += lineTotal;
      else if (category === 'WORK') totalWorks += lineTotal;
      else if (category === 'REPAIR') totalRepairs += lineTotal;
      else totalOther += lineTotal;
    });
    
    const total = totalParts + totalWorks + totalRepairs + totalOther;
    
    // Update summary total display
    const totalElement = document.getElementById('summary-total');
    if (totalElement) {
      totalElement.innerHTML = `סה"כ לתשלום<br><span style="font-size: 28px; font-weight: bold;">₪${total.toFixed(2)}</span>`;
    }
  }
  
  // SESSION 76: Categorize invoice items
  categorizeItem(text) {
    const lowerText = text.toLowerCase();
    
    // Parts keywords
    if (lowerText.includes('חלק') || lowerText.includes('פנס') || lowerText.includes('מראה') || 
        lowerText.includes('דלת') || lowerText.includes('פגוש') || lowerText.includes('גלגל') ||
        lowerText.includes('צמיג') || lowerText.includes('מנוע') || lowerText.includes('part')) {
      return 'PART';
    }
    
    // Work/Labor keywords  
    if (lowerText.includes('עבודה') || lowerText.includes('שעת') || lowerText.includes('שעות') ||
        lowerText.includes('התקנה') || lowerText.includes('labor') || lowerText.includes('work')) {
      return 'WORK';
    }
    
    // Repair keywords
    if (lowerText.includes('תיקון') || lowerText.includes('תיק') || lowerText.includes('repair') ||
        lowerText.includes('צבע') || lowerText.includes('paint') || lowerText.includes('ריתוך')) {
      return 'REPAIR';
    }
    
    return 'OTHER';
  }
  
  // SESSION 76: View invoice PDF in new tab
  async viewInvoicePDF() {
    try {
      if (!this.currentDocumentId) {
        this.showAlert('לא נמצא מסמך', 'error');
        return;
      }
      
      this.showAlert('מייצר קישור לצפייה...', 'info');
      
      const url = await this.invoiceService.getInvoiceDocumentURL(this.currentDocumentId);
      window.open(url, '_blank');
      
      this.showAlert('החשבונית נפתחה בחלון חדש', 'success');
    } catch (error) {
      console.error('Error viewing PDF:', error);
      this.showAlert('שגיאה בפתיחת החשבונית', 'error');
    }
  }

  addManualItem() {
    const name = document.getElementById('manual-item').value.trim();
    const description = document.getElementById('manual-desc').value.trim();
    const quantity = parseFloat(document.getElementById('manual-qty').value) || 1;
    const unitPrice = parseFloat(document.getElementById('manual-price').value) || 0;
    
    if (!name) {
      this.showAlert('אנא הכנס שם פריט', 'error');
      return;
    }
    
    const newItem = {
      name,
      description,
      quantity,
      unit_price: unitPrice
    };
    
    this.ocrResults.push(newItem);
    
    // Refresh display
    this.displayOCRResults({
      items: this.ocrResults,
      total: this.ocrResults.reduce((sum, item) => sum + (item.quantity * item.unit_price), 0)
    });
    
    // Clear manual input fields
    document.getElementById('manual-item').value = '';
    document.getElementById('manual-desc').value = '';
    document.getElementById('manual-qty').value = '1';
    document.getElementById('manual-price').value = '';
    
    this.showAlert('פריט נוסף בהצלחה', 'success');
  }

  removeItem(index) {
    if (confirm('האם למחוק פריט זה?')) {
      this.ocrResults.splice(index, 1);
      this.displayOCRResults({
        items: this.ocrResults,
        total: this.ocrResults.reduce((sum, item) => sum + (item.quantity * item.unit_price), 0)
      });
      this.showAlert('פריט הוסר', 'success');
    }
  }

  showValidationStatus(result) {
    const statusContainer = document.getElementById('validation-status');
    let statusType = 'success';
    let message = '✅ חשבונית עובדה בהצלחה';
    
    if (result.warnings && result.warnings.length > 0) {
      statusType = 'warning';
      message = '⚠️ חשבונית עובדה עם אזהרות: ' + result.warnings.join(', ');
    }
    
    if (result.errors && result.errors.length > 0) {
      statusType = 'error';
      message = '❌ שגיאות בעיבוד: ' + result.errors.join(', ');
    }
    
    statusContainer.className = `validation-status ${statusType} show`;
    statusContainer.textContent = message;
    
    // Hide after 5 seconds
    setTimeout(() => {
      statusContainer.classList.remove('show');
    }, 5000);
  }

  async saveResults() {
    if (this.ocrResults.length === 0) {
      this.showAlert('אין תוצאות לשמירה', 'warning');
      return;
    }
    
    try {
      console.log('💾 Saving invoice results...');
      
      const plate = document.getElementById('plate').value;
      const caseId = sessionStorage.getItem('currentCaseId');
      
      // Prepare result data for helper (backward compatibility)
      const resultData = {
        plate: plate,
        owner: document.getElementById('owner').value,
        garage_name: document.getElementById('garage_name').value,
        date: document.getElementById('date').value,
        invoice_type: document.getElementById('invoice-type').value,
        items: this.ocrResults,
        total: this.ocrResults.reduce((sum, item) => sum + (item.quantity * item.unit_price), 0),
        processed_at: new Date().toISOString()
      };
      
      // SESSION 74: Save to Supabase if case ID exists
      if (caseId && this.invoiceService) {
        try {
          // Prepare invoice data
          const invoiceData = {
            plate: plate,
            invoice_number: `INV-${Date.now()}`, // Generate unique number
            supplier_name: document.getElementById('garage_name').value,
            issue_date: document.getElementById('date').value,
            invoice_type: document.getElementById('invoice-type').value?.toUpperCase() || 'MIXED',
            total_amount: resultData.total,
            currency: 'ILS',
            approval_status: 'pending'
          };
          
          // Prepare invoice lines
          const lines = this.ocrResults.map((item, index) => ({
            line_number: index + 1,
            description: item.name || item.description || '',
            quantity: item.quantity || 1,
            unit_price: item.unit_price || 0,
            line_total: (item.quantity || 1) * (item.unit_price || 0)
            // item_category will be auto-filled by SQL trigger
          }));
          
          // Create invoice in Supabase
          const result = await this.invoiceService.createInvoice(invoiceData, lines, caseId);
          
          if (result.success) {
            this.currentInvoiceId = result.invoice.id;
            console.log('✅ Invoice saved to Supabase:', this.currentInvoiceId);
            
            // SESSION 76: Link document to invoice - UPDATE invoice_documents.invoice_id
            if (this.currentDocumentId) {
              console.log('🔗 Linking document to invoice:', this.currentDocumentId, '→', this.currentInvoiceId);
              
              const { data: updatedDoc, error: linkError } = await window.supabase
                .from('invoice_documents')
                .update({ invoice_id: this.currentInvoiceId })
                .eq('id', this.currentDocumentId)
                .select()
                .single();
              
              if (linkError) {
                console.error('❌ Failed to link document to invoice:', linkError);
              } else {
                console.log('✅ Document linked to invoice successfully');
              }
            }
          }
        } catch (supabaseError) {
          console.error('❌ Supabase save failed:', supabaseError);
          this.showAlert('⚠️ חשבונית נשמרה מקומית (שמירה בענן נכשלה)', 'warning');
        }
      } else {
        console.warn('⚠️ No case ID, skipping Supabase save');
      }
      
      // Save to helper system (backward compatibility)
      this.updateHelperWithResults(resultData);
      
      // Send to webhook for processing
      await sendToWebhook('SAVE_INVOICE_RESULTS', resultData);
      
      this.showAlert('✅ חשבונית נשמרה בהצלחה', 'success');
      
    } catch (error) {
      console.error('Save error:', error);
      this.showAlert('❌ שגיאה בשמירת החשבונית', 'error');
    }
  }

  updateHelperWithResults(result) {
    try {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      if (!helper.invoices) {
        helper.invoices = [];
      }
      
      // SESSION 76: Prevent duplicates based on invoice_number
      // Remove any existing invoice with the same invoice_number
      const invoiceNumber = result.invoice_number || result['מס. חשבונית'] || result.invoiceNumber;
      
      if (invoiceNumber) {
        helper.invoices = helper.invoices.filter(inv => {
          const existingInvNum = inv.invoice_number || inv['מס. חשבונית'] || inv.invoiceNumber;
          return existingInvNum !== invoiceNumber;
        });
        
        console.log(`🔍 Checking for duplicate invoice: ${invoiceNumber}`);
        console.log(`📋 Existing invoices count: ${helper.invoices.length}`);
      }
      
      // Add new invoice data
      const invoiceData = {
        ...result,
        processed_at: new Date().toISOString(),
        invoice_number: invoiceNumber
      };
      
      helper.invoices.push(invoiceData);
      
      // Update meta information
      helper.meta = helper.meta || {};
      helper.meta.last_invoice_processed = new Date().toISOString();
      helper.meta.total_invoices = helper.invoices.length;
      
      // Update session storage
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      // SESSION 56: Update via helper system with correct parameters
      if (typeof window.updateHelper === 'function') {
        window.updateHelper('invoices', helper.invoices, 'invoice-upload');
        window.updateHelper('meta', helper.meta, 'invoice-upload');
      }
      
      console.log(`✅ Invoice ${invoiceNumber} added to helper (total: ${helper.invoices.length})`);
      
    } catch (e) {
      console.warn('Could not update helper with invoice results:', e);
    }
  }

  showProcessingStatus(show) {
    const statusElement = document.getElementById('processing-status');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    
    if (show) {
      statusElement.classList.add('show');
      
      // Simulate progress
      let progress = 0;
      const interval = setInterval(() => {
        progress += 15;
        progressFill.style.width = `${Math.min(progress, 90)}%`;
        
        if (progress >= 30 && progress < 60) {
          progressText.textContent = 'מעבד OCR...';
        } else if (progress >= 60 && progress < 90) {
          progressText.textContent = 'מנתח תוצאות...';
        }
        
        if (progress >= 90) {
          clearInterval(interval);
          progressText.textContent = 'משלים עיבוד...';
        }
      }, 500);
      
      // Store interval reference for cleanup
      this.progressInterval = interval;
    } else {
      statusElement.classList.remove('show');
      progressFill.style.width = '0%';
      progressText.textContent = 'אנא המתן...';
      
      if (this.progressInterval) {
        clearInterval(this.progressInterval);
      }
    }
  }

  clearForm() {
    if (confirm('האם לנקות את כל הנתונים?')) {
      // SESSION 76: Remove current invoice from helper.invoices before clearing
      if (this.currentInvoiceId) {
        try {
          const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
          
          if (helper.invoices && Array.isArray(helper.invoices)) {
            // Remove invoice with matching invoice_id
            helper.invoices = helper.invoices.filter(inv => inv.invoice_id !== this.currentInvoiceId);
            
            // Update meta
            helper.meta = helper.meta || {};
            helper.meta.total_invoices = helper.invoices.length;
            
            // Save back to sessionStorage
            sessionStorage.setItem('helper', JSON.stringify(helper));
            
            // Update via helper system
            if (typeof window.updateHelper === 'function') {
              window.updateHelper('invoices', helper.invoices, 'invoice-upload-clear');
              window.updateHelper('meta', helper.meta, 'invoice-upload-clear');
            }
            
            console.log('✅ Removed invoice from helper:', this.currentInvoiceId);
          }
        } catch (e) {
          console.warn('Could not remove invoice from helper:', e);
        }
      }
      
      // Clear form fields
      document.getElementById('invoice-form').reset();
      
      // Clear internal state
      this.uploadedFile = null;
      this.ocrResults = [];
      this.currentDocumentId = null;
      this.currentInvoiceId = null;
      
      // Hide sections
      document.getElementById('preview-container').style.display = 'none';
      document.getElementById('ocr-results').classList.remove('show');
      document.getElementById('validation-status').classList.remove('show');
      document.getElementById('save-results').style.display = 'none';
      
      // Reload case data
      this.loadCaseData();
      
      this.showAlert('טופס נוקה וחשבונית הוסרה', 'success');
    }
  }

  showAlert(message, type = 'info') {
    const container = document.getElementById('alerts-container');
    const alert = document.createElement('div');
    alert.className = `alert ${type} show`;
    alert.textContent = message;
    
    container.appendChild(alert);
    
    setTimeout(() => {
      alert.remove();
    }, 5000);
  }
}

// Global functions
window.logout = function() {
  sessionStorage.clear();
  window.location.href = 'index.html';
};

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  // Auth check
  const auth = sessionStorage.getItem("auth");
  if (!auth) {
    alert("הגישה חסומה - אנא התחבר דרך דף הבית");
    window.location.href = "index.html";
    return;
  }

  // Initialize invoiceService with current user from auth
  try {
    const authData = JSON.parse(auth);
    if (window.invoiceService && authData.profile) {
      // Set currentUser from auth profile
      window.invoiceService.currentUser = {
        user_id: authData.profile.user_id || authData.user.id,
        email: authData.profile.email || authData.user.email,
        name: authData.profile.name,
        role: authData.profile.role
      };
      console.log('✅ InvoiceService initialized with user:', window.invoiceService.currentUser.email);
    }
  } catch (error) {
    console.error('❌ Failed to initialize invoiceService with user:', error);
  }

  // Initialize invoice processor
  window.invoiceProcessor = new InvoiceProcessor();
  
  // ENHANCED: Auto-populate vehicle data from helper
  function populateVehicleDataFromHelper() {
    console.log('🧾 Invoice Upload: Auto-populating vehicle data from helper...');
    
    try {
      const helperString = sessionStorage.getItem('helper');
      if (helperString) {
        const helper = JSON.parse(helperString);
        console.log('✅ Helper data loaded for invoice upload:', helper);
        
        // Populate basic fields
        const fieldMappings = {
          'plate': helper.vehicle?.plate || helper.meta?.plate,
          'owner': helper.stakeholders?.owner?.name
        };
        
        // Apply the mappings
        Object.entries(fieldMappings).forEach(([fieldId, value]) => {
          const element = document.getElementById(fieldId);
          if (element && value) {
            element.value = value;
            console.log(`  ✅ ${fieldId}: "${value}"`);
          }
        });
        
        console.log('✅ Invoice upload auto-population completed');
      } else {
        console.log('⚠️ No helper data found in sessionStorage');
      }
    } catch (error) {
      console.error('❌ Error auto-populating invoice upload vehicle data:', error);
    }
  }
  
  // Auto-populate on page load
  populateVehicleDataFromHelper();
  
  // SESSION 76: Expose toggleManualSection globally
  window.toggleManualSection = function() {
    const content = document.getElementById('manual-section-content');
    const icon = document.getElementById('manual-toggle-icon');
    
    if (content.style.display === 'none') {
      content.style.display = 'block';
      icon.textContent = '▲';
    } else {
      content.style.display = 'none';
      icon.textContent = '▼';
    }
  };
});

</script>
<script src="password-prefill.js"></script>

</body>
</html>