<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>×¢×™×‘×•×“ ×—×©×‘×•× ×™×•×ª </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link href="https://fonts.googleapis.com/css2?family=Assistant&display=swap" rel="stylesheet" />
  <!-- SESSION 87: jsPDF library for manual invoice PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #1e293b 100%);
      background-attachment: fixed;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      direction: rtl;
      position: relative;
      overflow-x: hidden;
    }

    /* Animated background particles */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image:
        radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
      animation: float 20s ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes float {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.1); }
    }

    .container {
      max-width: 1200px;
      width: 95%;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(20px);
      padding: 35px;
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      position: relative;
      z-index: 1;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 30px;
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .logo img {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      margin-bottom: 20px;
      border: 3px solid rgba(99, 102, 241, 0.3);
      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
      animation: logoGlow 3s ease-in-out infinite;
    }

    @keyframes logoGlow {
      0%, 100% { box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3); }
      50% { box-shadow: 0 8px 32px rgba(139, 92, 246, 0.5); }
    }

    .title {
      font-size: 26px;
      font-weight: 700;
      background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    h2 {
      font-size: 20px;
      color: #e0e7ff;
      margin-bottom: 25px;
      font-weight: 600;
    }

    .subtitle {
      font-size: 16px;
      color: #94a3b8;
      margin-bottom: 15px;
      font-weight: 500;
    }
    
    .section {
      margin-bottom: 25px;
      padding: 25px;
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .section h3 {
      margin: 0 0 20px 0;
      color: #cbd5e1;
      font-size: 18px;
      font-weight: 600;
      border-bottom: 2px solid rgba(99, 102, 241, 0.3);
      padding-bottom: 12px;
    }
    
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .form-group {
      flex: 1;
      min-width: 200px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #cbd5e1;
      font-size: 14px;
    }

    input, select, textarea {
      width: 100%;
      padding: 14px 16px;
      font-size: 15px;
      border-radius: 12px;
      border: 1.5px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      color: #e2e8f0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-sizing: border-box;
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #6366f1;
      background: rgba(255, 255, 255, 0.08);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1), 0 8px 16px rgba(0, 0, 0, 0.2);
      transform: translateY(-2px);
    }
    
    .file-upload-area {
      border: 3px dashed #bdc3c7;
      border-radius: 15px;
      padding: 40px 20px;
      text-align: center;
      background: #ecf0f1;
      transition: all 0.3s ease;
      cursor: pointer;
      margin-bottom: 20px;
    }
    
    .file-upload-area:hover {
      border-color: #3498db;
      background: #ebf3fd;
    }
    
    .file-upload-area.dragover {
      border-color: #27ae60;
      background: #e8f5e8;
    }
    
    .upload-icon {
      font-size: 48px;
      color: #95a5a6;
      margin-bottom: 15px;
    }
    
    .upload-text {
      font-size: 18px;
      color: #7f8c8d;
      margin-bottom: 10px;
    }
    
    .upload-hint {
      font-size: 14px;
      color: #95a5a6;
    }
    
    #file-input {
      display: none;
    }
    
    .preview-container {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }
    
    .preview-image {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    .btn {
      padding: 15px 30px;
      font-size: 16px;
      font-weight: 600;
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin: 10px 5px;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .btn:hover {
      background: linear-gradient(135deg, #2980b9, #21618c);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
    }
    
    .btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #27ae60, #229954);
    }
    
    .btn-success:hover {
      background: linear-gradient(135deg, #229954, #1e8449);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #95a5a6, #7f8c8d);
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, #7f8c8d, #6c7b7d);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
    }
    
    .btn-danger:hover {
      background: linear-gradient(135deg, #c0392b, #a93226);
    }
    
    .btn-loading {
      position: relative;
      pointer-events: none;
      opacity: 0.8;
    }
    
    .btn-loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin-left: -8px;
      margin-top: -8px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .processing-status {
      display: none;
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .processing-status.show {
      display: block;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #ecf0f1;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 15px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3498db, #2980b9);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .ocr-results {
      display: none;
      background: white;
      border-radius: 10px;
      padding: 25px;
      margin-top: 20px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    .ocr-results.show {
      display: block;
    }
    
    .results-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .results-table th,
    .results-table td {
      padding: 6px 8px;
      text-align: right;
      border-bottom: 1px solid #475569;
    }
    
    .results-table th {
      background: #1e293b;
      color: white;
      font-weight: 600;
      font-size: 11px;
      white-space: nowrap;
    }
    
    .results-table tr:hover {
      background: #f8f9fa;
    }
    
    .validation-status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      display: none;
    }
    
    .validation-status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .validation-status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .validation-status.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .validation-status.show {
      display: block;
    }
    
    .footer-btns {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e1e8ed;
    }
    
    .footer {
      text-align: center;
      font-size: 12px;
      margin-top: 20px;
      color: #95a5a6;
    }
    
    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
    }
    
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        padding: 20px;
      }
      
      .form-row {
        flex-direction: column;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .footer-btns {
        flex-direction: column;
      }
    }
    
    .alert {
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
    }
    
    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .alert.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .alert.show {
      display: block;
    }
  </style>
</head>
<body>

<script type="module">
  import { WEBHOOKS } from './webhook.js';
  import { caseOwnershipService } from './services/caseOwnershipService.js';
  
  window.WEBHOOKS = WEBHOOKS;
  
  // Phase 6: Case ownership check
  (async () => {
    const plateNumber = window.helper?.plate || sessionStorage.getItem('currentPlate');
    
    if (plateNumber) {
      const ownershipCheck = await caseOwnershipService.canEditCase(plateNumber);
      
      if (!ownershipCheck.canEdit) {
        alert(ownershipCheck.reason || '××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¢×¨×•×š ×ª×™×§ ×–×”.\n\n×¨×§ ×”×‘×¢×œ×™×, ×× ×”×œ ××• ××¤×ª×— ×™×›×•×œ×™× ×œ×¢×¨×•×š.');
        window.location.href = 'selection.html';
        return;
      }
      
      console.log('âœ… Case ownership verified - user can upload invoices');
    }
  })();
</script>

<div class="container">
  <div class="header">
    <div class="logo">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo" />
    </div>
    <h1 class="title">×™×¨×•×Ÿ ×›×™×•×£ - ×©×××•×ª ×•×™×™×¢×•×¥</h1>
    <div class="subtitle">×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</div>
    <h2>××•×“×•×œ ×¢×™×‘×•×“ ×—×©×‘×•× ×™×•×ª </h2>
  </div>

  <div id="alerts-container"></div>

  <form id="invoice-form" method="POST" onsubmit="return false;">
    <!-- Case Information Section -->
    <div class="section">
      <h3>×¤×¨×˜×™ ×”×ª×™×§</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="plate">××¡×¤×¨ ×¨×™×©×•×™:</label>
          <input id="plate" name="plate" placeholder="××¡×¤×¨ ×¨×™×©×•×™ ×”×¨×›×‘" required type="text" />
        </div>
        <div class="form-group">
          <label for="owner">×©× ×‘×¢×œ ×”×¨×›×‘:</label>
          <input id="owner" name="owner" placeholder="×©× ×‘×¢×œ ×”×¨×›×‘" required type="text" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="garage_name">×©× ×”××•×¡×š:</label>
          <input id="garage_name" name="garage_name" placeholder="×©× ×”××•×¡×š (××•×¤×¦×™×•× ×œ×™)" type="text" />
        </div>
        <div class="form-group">
          <label for="date">×ª××¨×™×š:</label>
          <input id="date" name="date" type="date" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="invoice-type">×¡×•×’ ×—×©×‘×•× ×™×ª:</label>
          <select id="invoice-type" name="invoice-type">
            <option value="parts">×—×œ×§×™×</option>
            <option value="labor">×¢×‘×•×“×”</option>
            <option value="mixed">××¢×•×¨×‘</option>
            <option value="other">××—×¨</option>
          </select>
        </div>
      </div>
    </div>

    <!-- SESSION 82: Load Existing Invoices Section -->
    <div class="section" style="border: 2px solid rgba(139, 92, 246, 0.3);">
      <h3 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: -25px -25px 20px -25px; padding: 15px 25px; border-radius: 20px 20px 0 0; color: white;">ğŸ“‚ ×˜×¢×™× ×ª ×—×©×‘×•× ×™×•×ª ×§×™×™××•×ª</h3>
      
      <button type="button" id="loadInvoicesBtn" class="btn" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); width: 100%; padding: 15px; font-size: 16px; margin-bottom: 15px;">
        ğŸ“‚ ×˜×¢×Ÿ ×—×©×‘×•× ×™×•×ª ××××’×¨
      </button>
      
      <div id="invoiceDropdownContainer" style="display: none;">
        <div class="form-group" style="margin-bottom: 15px;">
          <label style="font-size: 14px; margin-bottom: 8px; display: block;">×‘×—×¨ ×—×©×‘×•× ×™×ª ×§×™×™××ª:</label>
          <select id="existingInvoicesDropdown" style="width: 100%; padding: 14px; font-size: 15px; border-radius: 12px; border: 1.5px solid rgba(139, 92, 246, 0.3); background: rgba(255, 255, 255, 0.05); color: #e2e8f0;">
            <option value="">-- ×‘×—×¨ ×—×©×‘×•× ×™×ª --</option>
          </select>
        </div>
        
        <button type="button" id="viewInvoiceBtn" class="btn btn-secondary" style="display: none; width: 100%;">
          ğŸ“„ ×¦×¤×” ×‘×—×©×‘×•× ×™×ª
        </button>
      </div>
      
      <div id="invoiceLoadingSpinner" style="display: none; text-align: center; padding: 20px;">
        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid rgba(139, 92, 246, 0.3); border-top-color: #8b5cf6; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
        <p style="color: #cbd5e1; margin-top: 10px; font-size: 14px;">×˜×•×¢×Ÿ ×—×©×‘×•× ×™×•×ª...</p>
      </div>
    </div>

    <!-- File Upload Section -->
    <div class="section">
      <h3>×”×¢×œ××ª ×—×©×‘×•× ×™×ª</h3>
      <div class="file-upload-area" onclick="document.getElementById('file-input').click()">
        <div class="upload-icon">ğŸ“„</div>
        <div class="upload-text">×œ×—×¥ ×›××Ÿ ××• ×’×¨×•×¨ ×—×©×‘×•× ×™×ª ×œ××–×•×¨ ×–×”</div>
        <div class="upload-hint">×ª×•××š ×‘×§×‘×¦×™ PDF, JPG, PNG | ×’×•×“×œ ××§×¡×™××œ×™: 10MB</div>
      </div>
      <input id="file-input" type="file" accept="image/*,.pdf" />
      
      <!-- Preview Container -->
      <div class="preview-container" id="preview-container">
        <img id="preview-image" class="preview-image" style="display: none;" />
      </div>
    </div>

    <!-- Processing Status -->
    <div class="processing-status" id="processing-status">
      <h3>××¢×‘×“ ×—×©×‘×•× ×™×ª...</h3>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div id="progress-text">×× × ×”××ª×Ÿ...</div>
    </div>

    <!-- OCR Results Section -->
    <div class="ocr-results" id="ocr-results">
      <h3>×ª×•×¦××•×ª ×¢×™×‘×•×“ OCR</h3>
      <div id="ocr-summary"></div>
      <table class="results-table" id="results-table">
        <thead>
          <tr>
            <th style="width: 150px;">×¤×¨×™×˜</th>
            <th>×ª×™××•×¨</th>
            <th style="width: 60px;">×›××•×ª</th>
            <th style="width: 80px;">××—×™×¨ ×™×—×™×“×”</th>
            <th style="width: 85px;">×¡×”"×›</th>
            <th style="width: 70px;">×¤×¢×•×œ×•×ª</th>
          </tr>
        </thead>
        <tbody id="results-body">
          <!-- OCR results will be populated here -->
        </tbody>
      </table>
    </div>

    <!-- Validation Status -->
    <div class="validation-status" id="validation-status">
      <!-- Validation messages will appear here -->
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button type="submit" id="process-invoice" class="btn btn-success">
        ğŸ” ×¢×‘×“ ×—×©×‘×•× ×™×ª
      </button>
      <button type="button" id="save-results" class="btn btn-primary" style="display: none;">
        ğŸ’¾ ×©××•×¨ ×ª×•×¦××•×ª
      </button>
      <button type="button" id="delete-invoice" class="btn btn-danger" style="display: none;">
        ğŸ—‘ï¸ ××—×§ ×—×©×‘×•× ×™×ª ×œ×¦××™×ª×•×ª
      </button>
      <button type="button" id="clear-ui" class="btn btn-secondary" style="display: none;">
        ğŸ”„ × ×§×” ××¡×š
      </button>
    </div>
  </form>

  <!-- SESSION 77: Manual Invoice Entry - REBUILT with proper table structure -->
  <div class="section" style="margin-top: 40px; border-top: 3px solid #ffc107; padding-top: 20px;">
    <h3 onclick="toggleManualSection()" style="cursor: pointer; user-select: none; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); padding: 15px; border-radius: 8px; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <span id="manual-toggle-icon">â–¼</span> âœï¸ ×”×–× ×ª ×—×©×‘×•× ×™×ª ×™×“× ×™×ª
      <small style="display: block; font-size: 13px; font-weight: normal; margin-top: 8px; opacity: 0.95;">
        âš ï¸ ×œ××§×¨×™× × ×“×™×¨×™× ×‘×œ×‘×“ - ×›××©×¨ ××™×Ÿ ×—×©×‘×•× ×™×ª ×¤×™×–×™×ª/×“×™×’×™×˜×œ×™×ª ×–××™× ×”
      </small>
    </h3>
    <div id="manual-section-content" style="display: none; background: #fff9e6; padding: 20px; border-radius: 8px; margin-top: 10px;">
      
      <!-- Fixed Fields Section - General Information -->
      <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h4 style="margin: 0 0 15px 0; font-size: 16px; color: #1e293b; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px;">ğŸ“‹ ×¤×¨×˜×™ ×—×©×‘×•× ×™×ª</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
          
          <div>
            <label style="display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; color: #334155;">×‘×¢×œ ×”×¨×›×‘ <span style="color: #dc2626;">*</span></label>
            <input type="text" id="manual-car-owner" required style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; color: #000;" />
          </div>
          
          <div>
            <label style="display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; color: #334155;">××¡. ×—×©×‘×•× ×™×ª <span style="color: #dc2626;">*</span></label>
            <input type="text" id="manual-invoice-number" required style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; color: #000;" />
          </div>
          
          <div>
            <label style="display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; color: #334155;">×ª××¨×™×š <span style="color: #dc2626;">*</span></label>
            <input type="text" id="manual-date" required placeholder="dd/mm/yy" style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; color: #000;" />
          </div>
          
          <div>
            <label style="display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; color: #334155;">×©× ××•×¡×š <span style="color: #dc2626;">*</span></label>
            <input type="text" id="manual-garage-name" required style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; color: #000;" />
          </div>
          
          <div>
            <label style="display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; color: #334155;">×˜×œ×¤×•×Ÿ ××•×¡×š <span style="color: #dc2626;">*</span></label>
            <input type="tel" id="manual-garage-phone" required style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; color: #000;" />
          </div>
          
          <div>
            <label style="display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; color: #334155;">××¡×¤×¨ ×¨×›×‘</label>
            <input type="text" id="manual-vehicle-plate" style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; color: #000;" />
          </div>
          
          <div>
            <label style="display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; color: #334155;">×™×¦×¨×Ÿ</label>
            <input type="text" id="manual-manufacturer" style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; color: #000;" />
          </div>
          
          <div>
            <label style="display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; color: #334155;">×“×’×</label>
            <input type="text" id="manual-model" style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; color: #000;" />
          </div>
          
          <div>
            <label style="display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; color: #334155;">×©× ×ª ×™×™×¦×•×¨</label>
            <input type="text" id="manual-production-year" style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; color: #000;" />
          </div>
          
          <div>
            <label style="display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; color: #334155;">××“ ××•×¥</label>
            <input type="text" id="manual-odometer" style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; color: #000;" />
          </div>
          
          <div>
            <label style="display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; color: #334155;">××¡×¤×¨ ×ª×™×§</label>
            <input type="text" id="manual-file-number" style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; color: #000;" />
          </div>
          
          <div>
            <label style="display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; color: #334155;">×“×•×"×œ ××•×¡×š</label>
            <input type="email" id="manual-garage-email" style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; color: #000;" />
          </div>
          
          <div>
            <label style="display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; color: #334155;">×›×ª×•×‘×ª ××•×¡×š</label>
            <input type="text" id="manual-garage-address" style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; color: #000;" />
          </div>
          
          <div>
            <label style="display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; color: #334155;">××•×§×“ × ×–×§</label>
            <input type="text" id="manual-damage-area" style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; color: #000;" />
          </div>
          
          <div>
            <label style="display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; color: #334155;">×—.×¤.</label>
            <input type="text" id="manual-company-number" style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; color: #000;" />
          </div>
          
          <div>
            <label style="display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; color: #334155;">×”×¢×¨×•×ª</label>
            <input type="text" id="manual-notes" style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; color: #000;" />
          </div>
          
        </div>
      </div>
      
      <!-- Manual Entry Tables - Matching OCR Style -->
      <div style="margin-bottom: 20px;">
        <h4 style="background: rgba(76, 175, 80, 0.3); padding: 8px; border-radius: 6px; margin-bottom: 10px; font-size: 15px;">ğŸ”§ ×—×œ×§×™×</h4>
        <table class="results-table" id="manual-parts-table">
          <thead>
            <tr>
              <th style="width: 150px;">××§"×˜</th>
              <th>×©× ×—×œ×§</th>
              <th>×ª×™××•×¨</th>
              <th style="width: 60px;">×›××•×ª</th>
              <th style="width: 100px;">××§×•×¨</th>
              <th style="width: 80px;">××—×™×¨ ×™×—×™×“×”</th>
              <th style="width: 70px;">×¤×¢×•×œ×•×ª</th>
            </tr>
          </thead>
          <tbody id="manual-parts-body">
            <!-- Parts rows added dynamically -->
          </tbody>
          <tfoot>
            <tr>
              <td colspan="6" style="text-align: left; padding: 8px;">
                <button type="button" onclick="window.invoiceProcessor.addManualPartRow()" class="btn btn-success" style="font-size: 13px; padding: 6px 12px;">+ ×”×•×¡×£ ×—×œ×§</button>
              </td>
              <td style="text-align: right; font-weight: bold; color: #2e7d32; padding: 8px;">
                <span id="manual-parts-total">â‚ª0.00</span>
              </td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div style="margin-bottom: 20px;">
        <h4 style="background: rgba(33, 150, 243, 0.3); padding: 8px; border-radius: 6px; margin-bottom: 10px; font-size: 15px;">ğŸ‘· ×¢×‘×•×“×•×ª</h4>
        <table class="results-table" id="manual-works-table">
          <thead>
            <tr>
              <th style="width: 100px;">×§×•×“</th>
              <th colspan="2">×ª×™××•×¨ ×¢×‘×•×“×•×ª</th>
              <th style="width: 80px;">××—×™×¨</th>
              <th style="width: 70px;">×¤×¢×•×œ×•×ª</th>
            </tr>
          </thead>
          <tbody id="manual-works-body">
            <!-- Works rows added dynamically -->
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="text-align: left; padding: 8px;">
                <button type="button" onclick="window.invoiceProcessor.addManualWorkRow()" class="btn btn-success" style="font-size: 13px; padding: 6px 12px;">+ ×”×•×¡×£ ×¢×‘×•×“×”</button>
              </td>
              <td style="text-align: right; font-weight: bold; color: #1976d2; padding: 8px;">
                <span id="manual-works-total">â‚ª0.00</span>
              </td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div style="margin-bottom: 20px;">
        <h4 style="background: rgba(255, 152, 0, 0.3); padding: 8px; border-radius: 6px; margin-bottom: 10px; font-size: 15px;">ğŸ”¨ ×ª×™×§×•× ×™×</h4>
        <table class="results-table" id="manual-repairs-table">
          <thead>
            <tr>
              <th style="width: 100px;">×¡×•×’ ×ª×™×§×•×Ÿ</th>
              <th colspan="2">×ª×™××•×¨ ×”×ª×™×§×•×Ÿ</th>
              <th style="width: 80px;">××—×™×¨</th>
              <th style="width: 70px;">×¤×¢×•×œ×•×ª</th>
            </tr>
          </thead>
          <tbody id="manual-repairs-body">
            <!-- Repairs rows added dynamically -->
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="text-align: left; padding: 8px;">
                <button type="button" onclick="window.invoiceProcessor.addManualRepairRow()" class="btn btn-success" style="font-size: 13px; padding: 6px 12px;">+ ×”×•×¡×£ ×ª×™×§×•×Ÿ</button>
              </td>
              <td style="text-align: right; font-weight: bold; color: #f57c00; padding: 8px;">
                <span id="manual-repairs-total">â‚ª0.00</span>
              </td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Manual Entry Totals Summary -->
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 8px; color: white; margin-top: 20px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span>×¡×”"×› ×œ×¤× ×™ ××¢"×:</span>
          <span id="manual-subtotal" style="font-weight: bold;">â‚ª0.00</span>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <span>××¢"× (%):</span>
          <input type="number" id="manual-vat-percent" value="18" min="0" max="100" step="0.1" onchange="window.invoiceProcessor.recalculateManualTotals()" style="width: 80px; padding: 4px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.3); text-align: center;" />
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span>×¢×¨×š ××¢"×:</span>
          <span id="manual-vat-amount" style="font-weight: bold;">â‚ª0.00</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 2px solid rgba(255,255,255,0.3);">
          <span style="font-size: 16px; font-weight: bold;">×¡×”"×› ×›×•×œ×œ ××¢"×:</span>
          <span id="manual-grand-total" style="font-size: 18px; font-weight: bold;">â‚ª0.00</span>
        </div>
      </div>

      <!-- Signature Section -->
      <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h4 style="margin: 0 0 15px 0; font-size: 16px; color: #1e293b; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px;">âœï¸ ×¤×¨×˜×™ ××™×œ×•×™</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
          
          <div>
            <label style="display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; color: #334155;">××•×œ× ×¢×œ ×™×“×™:</label>
            <input type="text" id="manual-filled-by" readonly style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; color: #000; background: #e5e7eb; cursor: not-allowed;" />
          </div>
          
          <div>
            <label style="display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; color: #334155;">×ª××¨×™×š ××™×œ×•×™:</label>
            <input type="date" id="manual-fill-date" style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; color: #000;" />
          </div>
          
          <div>
            <label style="display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; color: #334155;">××§×•×¨:</label>
            <span style="display: inline-block; padding: 8px 12px; background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); color: white; border-radius: 6px; font-size: 13px; font-weight: bold;">ğŸ“ ×§×œ×˜ ×™×“× ×™</span>
          </div>
          
        </div>
      </div>

      <button type="button" onclick="console.log('ğŸ”˜ SESSION 87: Button clicked!'); window.invoiceProcessor.saveManualInvoice()" class="btn btn-warning" style="font-size: 16px; padding: 12px 24px; width: 100%; margin-top: 15px;">
        ğŸ’¾ ×©××•×¨ ×—×©×‘×•× ×™×ª ×™×“× ×™×ª
      </button>
    </div>
  </div>

  <div class="footer-btns">
    <button class="btn btn-secondary" onclick="window.location.href='selection.html'">ğŸ  ×¢××•×“ ×”×‘×™×ª</button>
    <button class="btn btn-danger" onclick="logout()">ğŸšª ×™×¦×™××”</button>
  </div>

  <div class="footer">@2025 Carmel Cayouf. All rights reserved. SmartVal Pro System by Eval Â©</div>
</div>

<!-- SESSION 56: Load helper.js as regular script BEFORE module script -->
<script src="helper.js"></script>
<!-- SESSION 87: Load parts.js for autocomplete -->
<script type="module">
import { PARTS_BANK } from './parts.js';
window.PARTS_BANK = PARTS_BANK;
console.log('âœ… SESSION 87: PARTS_BANK loaded and exposed globally');
</script>
<!-- SESSION 76: Load all scripts as modules to support export statements -->
<script type="module">
// Import Supabase client and expose globally for non-module code
import { supabase } from './lib/supabaseClient.js';
window.supabase = supabase;
console.log('âœ… Supabase client loaded as module and exposed globally');
</script>
<script src="services/invoice-service.js"></script>
<script src="services/invoice-helper-sync.js"></script>
<script type="module">
import { sendToWebhook, getWebhook } from './webhook.js';
// SESSION 56: helper.js is NOT an ES6 module - use window.updateHelper
// import { updateHelper } from './helper.js';
// SESSION 74: Phase 5a Invoice Integration with Supabase

// SESSION 87: User tracking system - prompt/cache for created_by, uploaded_by, updated_by
let cachedUserName = null;

function getUserName() {
  // Return cached value if available
  if (cachedUserName) {
    return cachedUserName;
  }

  // Check helper.user
  const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
  if (helper.user?.name) {
    cachedUserName = helper.user.name;
    return cachedUserName;
  }

  // Check Supabase auth
  const auth = sessionStorage.getItem('auth');
  if (auth) {
    try {
      const authData = JSON.parse(auth);
      const user = authData.session?.user || authData.user;
      if (user?.email) {
        cachedUserName = user.email;
        return cachedUserName;
      }
    } catch (e) {
      console.error('âŒ Error parsing auth:', e);
    }
  }

  // Prompt user for name
  const userName = prompt('×× × ×”×–×Ÿ ×©× ××©×ª××© ×œ×–×™×”×•×™:');
  if (!userName || userName.trim() === '') {
    return '××©×ª××© ×œ× ×™×“×•×¢';
  }

  // Cache and save to helper
  cachedUserName = userName.trim();
  helper.user = helper.user || {};
  helper.user.name = cachedUserName;
  sessionStorage.setItem('helper', JSON.stringify(helper));

  console.log('âœ… SESSION 87: User name cached:', cachedUserName);
  return cachedUserName;
}

// SESSION 87: Autocomplete for manual parts from PARTS_BANK
function flattenPartsBank() {
  if (!window.PARTS_BANK) {
    console.warn('âš ï¸ window.PARTS_BANK not loaded');
    return [];
  }

  const flatList = [];
  Object.keys(window.PARTS_BANK).forEach(category => {
    window.PARTS_BANK[category].forEach(partName => {
      flatList.push({
        category: category,
        name: partName
      });
    });
  });

  return flatList;
}

function showManualPartSuggestions(input) {
  const searchText = input.value.toLowerCase().trim();

  if (searchText.length < 1) {
    hideManualPartSuggestions(input);
    return;
  }

  // Get flattened parts list
  const allParts = flattenPartsBank();

  // Filter by search text
  const matches = allParts.filter(part =>
    part.name.toLowerCase().includes(searchText)
  ).slice(0, 15); // Limit to 15 suggestions

  // Get dropdown element
  const dropdown = input.nextElementSibling;
  if (!dropdown || !dropdown.classList.contains('manual-part-dropdown')) {
    return;
  }

  // Populate dropdown
  if (matches.length === 0) {
    dropdown.innerHTML = '<div style="padding: 8px; color: #999; text-align: center;">××™×Ÿ ×ª×•×¦××•×ª</div>';
    dropdown.style.display = 'block';
    return;
  }

  dropdown.innerHTML = matches.map(part => `
    <div class="suggestion-item"
         onmousedown="selectManualPartSuggestion(this, '${escapeHtml(part.name)}', '${escapeHtml(part.category)}')"
         style="padding: 8px; cursor: pointer; border-bottom: 1px solid #e2e8f0;">
      <div style="font-weight: bold; color: #1e293b; font-size: 11px;">${escapeHtml(part.name)}</div>
      <div style="font-size: 9px; color: #64748b;">${escapeHtml(part.category)}</div>
    </div>
  `).join('');

  dropdown.style.display = 'block';

  // Add hover effect
  dropdown.querySelectorAll('.suggestion-item').forEach(item => {
    item.addEventListener('mouseenter', () => {
      item.style.background = '#f1f5f9';
    });
    item.addEventListener('mouseleave', () => {
      item.style.background = 'white';
    });
  });
}

function selectManualPartSuggestion(element, partName, category) {
  // Find the input field
  const row = element.closest('tr');
  if (!row) return;

  // Fill the part name field
  const nameInput = row.querySelector('.manual-part-name');
  if (nameInput) {
    nameInput.value = partName;

    // Hide dropdown
    const dropdown = nameInput.nextElementSibling;
    if (dropdown) dropdown.style.display = 'none';
  }

  console.log('âœ… SESSION 87: Selected part from PARTS_BANK:', { name: partName, category: category });
}

function hideManualPartSuggestions(input) {
  // Delay to allow click on suggestion
  setTimeout(() => {
    const dropdown = input.nextElementSibling;
    if (dropdown && dropdown.classList.contains('manual-part-dropdown')) {
      dropdown.style.display = 'none';
    }
  }, 200);
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// SESSION 87: Generate PDF for manual invoice with watermark
async function generateManualInvoicePDF(invoiceData, documentId) {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Add watermark - "×—×©×‘×•× ×™×ª ×™×“× ×™×ª"
    doc.setFontSize(60);
    doc.setTextColor(220, 220, 220);
    doc.text('×—×©×‘×•× ×™×ª ×™×“× ×™×ª', 105, 150, { align: 'center', angle: 45 });

    // Reset for content
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);

    // Add title
    doc.setFontSize(18);
    doc.text('×—×©×‘×•× ×™×ª ×™×“× ×™×ª / ××©×•×—×–×¨×ª', 105, 20, { align: 'center' });

    // Add invoice details
    let y = 40;
    doc.setFontSize(12);
    doc.text(`××¡. ×—×©×‘×•× ×™×ª: ${invoiceData['××¡. ×—×©×‘×•× ×™×ª'] || '×œ× ×¦×•×™×Ÿ'}`, 20, y);
    y += 10;
    doc.text(`××•×¡×š: ${invoiceData['×©× ××•×¡×š'] || '×œ× ×¦×•×™×Ÿ'}`, 20, y);
    y += 10;
    doc.text(`×ª××¨×™×š: ${invoiceData['×ª××¨×™×š'] || '×œ× ×¦×•×™×Ÿ'}`, 20, y);
    y += 10;
    doc.text(`×¨×›×‘: ${invoiceData['××¡×¤×¨ ×¨×›×‘'] || '×œ× ×¦×•×™×Ÿ'}`, 20, y);
    y += 10;
    doc.text(`×‘×¢×œ ×¨×›×‘: ${invoiceData['×‘×¢×œ ×”×¨×›×‘'] || '×œ× ×¦×•×™×Ÿ'}`, 20, y);

    // Add parts summary if exists
    if (invoiceData['×—×œ×§×™×'] && invoiceData['×—×œ×§×™×'].length > 0) {
      y += 15;
      doc.setFontSize(14);
      doc.text(`×—×œ×§×™× (${invoiceData['×—×œ×§×™×'].length}):`, 20, y);
      y += 8;
      doc.setFontSize(10);
      invoiceData['×—×œ×§×™×'].slice(0, 5).forEach(part => {
        doc.text(`â€¢ ${part['×©× ×—×œ×§'] || part['×ª×™××•×¨'] || '×—×œ×§'}: ${part['×¢×œ×•×ª'] || '0'} â‚ª`, 25, y);
        y += 6;
      });
      if (invoiceData['×—×œ×§×™×'].length > 5) {
        doc.text(`... ×•×¢×•×“ ${invoiceData['×—×œ×§×™×'].length - 5} ×—×œ×§×™×`, 25, y);
        y += 6;
      }
    }

    // Add totals
    y += 15;
    doc.setFontSize(14);
    doc.text('×¡×™×›×•×:', 20, y);
    y += 10;
    doc.setFontSize(12);
    doc.text(`×—×œ×§×™×: ${invoiceData['×¡×”×› ×—×œ×§×™×'] || '0'} â‚ª`, 30, y);
    y += 8;
    doc.text(`×¢×‘×•×“×•×ª: ${invoiceData['×¡×”×› ×¢×‘×•×“×•×ª'] || '0'} â‚ª`, 30, y);
    y += 8;
    doc.text(`×ª×™×§×•× ×™×: ${invoiceData['×¡×”×› ×ª×™×§×•× ×™×'] || '0'} â‚ª`, 30, y);
    y += 8;
    doc.text(`×¡×”"×› ×œ×¤× ×™ ××¢"×: ${invoiceData['×¢×œ×•×ª ×›×•×œ×œ×ª ×œ×œ× ××¢×´×'] || '0'} â‚ª`, 30, y);
    y += 8;
    doc.text(`××¢"× (${invoiceData['××¢"×'] || '17%'}): ${invoiceData['×¢×¨×š ××¢"×'] || '0'} â‚ª`, 30, y);
    y += 8;
    doc.setFontSize(14);
    doc.setTextColor(255, 140, 0);  // Orange color
    doc.text(`×¡×”"×› ×›×•×œ×œ ××¢"×: ${invoiceData['×¢×œ×•×ª ×›×•×œ×œ×ª'] || '0'} â‚ª`, 30, y);

    // Footer watermark
    doc.setFontSize(10);
    doc.setTextColor(150, 150, 150);
    doc.text('××¡××š ×–×” × ×•×¦×¨ ×™×“× ×™×ª ×‘××¢×¨×›×ª SmartVal - EVALIX', 105, 280, { align: 'center' });

    // Convert to blob
    const pdfBlob = doc.output('blob');

    // Upload to Supabase storage
    const fileName = `manual_invoice_${invoiceData['××¡. ×—×©×‘×•× ×™×ª']}_${Date.now()}.pdf`;
    const { data: uploadData, error: uploadError } = await window.supabase.storage
      .from('invoices')
      .upload(fileName, pdfBlob);

    if (uploadError) {
      console.error('âŒ SESSION 87: PDF upload error:', uploadError);
      throw uploadError;
    }

    // Get public URL
    const { data: urlData } = window.supabase.storage
      .from('invoices')
      .getPublicUrl(fileName);

    const pdfUrl = urlData.publicUrl;

    // Update invoice_documents with PDF URL
    await window.supabase
      .from('invoice_documents')
      .update({ storage_url: pdfUrl })
      .eq('id', documentId);

    console.log('âœ… SESSION 87: PDF generated and uploaded:', pdfUrl);
    return pdfUrl;

  } catch (error) {
    console.error('âŒ SESSION 87: PDF generation failed:', error);
    return null;
  }
}

// Enhanced Invoice Processing System
class InvoiceProcessor {
  constructor() {
    this.uploadedFile = null;
    this.ocrResults = [];
    this.processingInProgress = false;
    this.maxFileSize = 10 * 1024 * 1024; // 10MB
    this.allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'application/pdf'];
    
    // SESSION 74: Supabase integration
    this.invoiceService = window.invoiceService;
    this.invoiceHelperSync = window.invoiceHelperSync;
    this.currentDocumentId = null;
    this.currentInvoiceId = null;
    
    this.init();
  }

  init() {
    this.setupEventListeners();
    this.loadCaseData();
    this.setupDragAndDrop();
  }

  setupEventListeners() {
    // File input change
    const fileInput = document.getElementById('file-input');
    if (fileInput) {
      fileInput.addEventListener('change', (e) => {
        this.handleFileSelection(e.target.files[0]);
      });
    } else {
      console.error('âŒ File input element not found - file-input missing');
    }

    // Form submission
    const invoiceForm = document.getElementById('invoice-form');
    if (invoiceForm) {
      invoiceForm.addEventListener('submit', (e) => {
        e.preventDefault();
        this.processInvoice();
      });
    } else {
      console.error('âŒ Invoice form element not found - invoice-form missing');
    }

    // SESSION 77: Manual item addition - removed old listener (now using onclick in HTML)

    // Delete invoice completely
    document.getElementById('delete-invoice').addEventListener('click', () => {
      this.deleteInvoiceCompletely();
    });
    
    // Clear UI only
    document.getElementById('clear-ui').addEventListener('click', () => {
      this.clearUIForNewInvoice();
    });

    // Save results
    document.getElementById('save-results').addEventListener('click', () => {
      this.saveResults();
    });
    
    // SESSION 82: Load existing invoices button
    document.getElementById('loadInvoicesBtn').addEventListener('click', () => {
      this.loadExistingInvoices();
    });
    
    // SESSION 82: Existing invoices dropdown change
    document.getElementById('existingInvoicesDropdown').addEventListener('change', async (e) => {
      const selectedOption = e.target.options[e.target.selectedIndex];
      
      if (!selectedOption.value) {
        document.getElementById('viewInvoiceBtn').style.display = 'none';
        return;
      }
      
      // SESSION 82 FIX: Fetch invoice, lines, and documents separately due to RLS
      const invoiceId = selectedOption.value;
      console.log('ğŸ”„ Fetching full invoice data for:', invoiceId);
      
      try {
        // Fetch invoice header
        const { data: invoice, error: invError } = await window.supabase
          .from('invoices')
          .select('*')
          .eq('id', invoiceId)
          .single();
        
        if (invError) throw invError;
        
        // Fetch lines separately
        const { data: lines, error: linesError } = await window.supabase
          .from('invoice_lines')
          .select('*')
          .eq('invoice_id', invoiceId)
          .order('line_number');
        
        if (linesError) {
          console.warn('âš ï¸ Error fetching lines:', linesError);
        }
        
        // Fetch documents separately
        const { data: documents, error: docsError } = await window.supabase
          .from('invoice_documents')
          .select('*')
          .eq('invoice_id', invoiceId);
        
        if (docsError) {
          console.warn('âš ï¸ Error fetching documents:', docsError);
        }
        
        // Combine into full invoice object
        const fullInvoice = {
          ...invoice,
          lines: lines || [],
          documents: documents || []
        };
        
        console.log('âœ… Fetched invoice with', fullInvoice.lines.length, 'lines and', fullInvoice.documents.length, 'documents');
        await this.populateOcrSectionFromInvoice(fullInvoice);
        document.getElementById('viewInvoiceBtn').style.display = 'block';
      } catch (error) {
        console.error('âŒ Error fetching invoice:', error);
        this.showAlert('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×—×©×‘×•× ×™×ª', 'error');
      }
    });
    
    // SESSION 82: View invoice document button
    document.getElementById('viewInvoiceBtn').addEventListener('click', () => {
      this.viewInvoiceDocument();
    });
  }

  loadCaseData() {
    // Load case data from session storage
    const plate = sessionStorage.getItem('plate');
    const owner = sessionStorage.getItem('owner');
    // SESSION 74: Removed pass loading - using Supabase auth only
    const garageName = sessionStorage.getItem('garage_name');
    const today = new Date().toISOString().split('T')[0];

    if (plate) document.getElementById('plate').value = plate;
    if (owner) document.getElementById('owner').value = owner;
    // SESSION 74: Removed pass field setting - using Supabase auth only
    if (garageName) document.getElementById('garage_name').value = garageName;
    document.getElementById('date').value = today;

    // Load from helper if available
    try {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      if (helper.car_details) {
        document.getElementById('plate').value = helper.car_details.plate || '';
        // SESSION 77: Auto-populate manual section fields
        const manualPlateField = document.getElementById('manual-vehicle-plate');
        if (manualPlateField) manualPlateField.value = helper.car_details.plate || '';
        
        const manualManufacturerField = document.getElementById('manual-manufacturer');
        if (manualManufacturerField) manualManufacturerField.value = helper.car_details.manufacturer || '';
        
        const manualModelField = document.getElementById('manual-model');
        if (manualModelField) manualModelField.value = helper.car_details.model || '';
        
        const manualYearField = document.getElementById('manual-production-year');
        if (manualYearField) manualYearField.value = helper.car_details.year || '';
        
        const manualOdometerField = document.getElementById('manual-odometer');
        if (manualOdometerField) manualOdometerField.value = helper.car_details.odometer || '';
      }
      
      // SESSION 77: Load owner from stakeholders (single source of truth)
      const ownerName = helper.stakeholders?.owner?.name || '';
      if (ownerName) {
        document.getElementById('owner').value = ownerName;
        const manualOwnerField = document.getElementById('manual-car-owner');
        if (manualOwnerField) manualOwnerField.value = ownerName;
      }
      
      // Load garage name from stakeholders
      const garageName = helper.stakeholders?.garage?.name || '';
      if (garageName) {
        document.getElementById('garage_name').value = garageName;
      }
      
      // SESSION 77: Auto-populate file number from car_details.case_number
      if (helper.car_details?.case_number) {
        const manualFileNumberField = document.getElementById('manual-file-number');
        if (manualFileNumberField) manualFileNumberField.value = helper.car_details.case_number;
      }
      
      // SESSION 77: Auto-populate signature section
      this.populateSignatureSection();
      
      // SESSION 74: Password auth removed - using Supabase auth only
    } catch (e) {
      console.warn('Could not load helper data:', e);
    }
    
    // SESSION 80: Ensure manual totals calculate on page load
    setTimeout(() => {
      if (typeof this.recalculateManualTotals === 'function') {
        this.recalculateManualTotals();
      }
    }, 100);
  }
  
  async populateSignatureSection() {
    // Auto-fill user name from profiles table (readonly)
    try {
      const authData = sessionStorage.getItem('auth');
      if (authData) {
        const auth = JSON.parse(authData);
        const userId = auth.user?.id;
        
        if (userId && window.supabase) {
          // Fetch user name from profiles table
          const { data: profile, error } = await window.supabase
            .from('profiles')
            .select('name')
            .eq('user_id', userId)
            .single();
          
          if (error) {
            console.warn('Could not fetch profile:', error);
          } else if (profile?.name) {
            const filledByField = document.getElementById('manual-filled-by');
            if (filledByField) filledByField.value = profile.name;
          }
        }
      }
    } catch (e) {
      console.warn('Could not load profile data for signature:', e);
    }
    
    // Auto-fill current date (editable via date picker)
    const fillDateField = document.getElementById('manual-fill-date');
    if (fillDateField) {
      fillDateField.value = new Date().toISOString().split('T')[0];
    }
  }

  // SESSION 74: validatePassword() removed - using Supabase auth only
  validatePassword() {
    // No password validation needed - Supabase handles authentication
    return true;
  }

  // SESSION 82: Load existing invoices from Supabase
  validateInvoiceLoadContext() {
    const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
    
    if (!helper.case_info?.supabase_case_id) {
      console.error('âŒ Missing case UUID in helper.case_info.supabase_case_id');
      this.showAlert('×©×’×™××”: ×œ× × ××¦× ××–×”×” ×ª×™×§ ×‘××¢×¨×›×ª', 'error');
      return false;
    }
    
    if (!helper.case_info?.plate) {
      console.error('âŒ Missing plate number in helper.case_info.plate');
      this.showAlert('×©×’×™××”: ×œ× × ××¦× ××¡×¤×¨ ×¨×™×©×•×™ ×‘××¢×¨×›×ª', 'error');
      return false;
    }
    
    console.log('âœ… Context validation passed:', {
      case_uuid: helper.case_info.supabase_case_id,
      plate: helper.case_info.plate
    });
    
    return true;
  }

  async loadExistingInvoices() {
    if (!this.validateInvoiceLoadContext()) {
      return;
    }
    
    const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
    const caseId = helper.case_info.supabase_case_id;
    const plateNumber = helper.case_info.plate;
    
    const spinner = document.getElementById('invoiceLoadingSpinner');
    const loadBtn = document.getElementById('loadInvoicesBtn');
    
    spinner.style.display = 'block';
    loadBtn.disabled = true;
    
    try {
      console.log('ğŸ“‚ Loading invoices for case:', caseId, 'plate:', plateNumber);
      
      const invoices = await this.invoiceService.getInvoicesByCase(caseId);
      
      console.log('ğŸ“¦ All invoices from database:', invoices);
      console.log('ğŸ” Filtering by plate:', plateNumber);
      
      const filteredInvoices = invoices.filter(inv => {
        console.log(`  Comparing: "${inv.plate}" === "${plateNumber}" â†’ ${inv.plate === plateNumber}`);
        return inv.plate === plateNumber;
      });
      
      console.log(`ğŸ“Š Found ${filteredInvoices.length} invoices for this case and plate`);
      
      if (filteredInvoices && filteredInvoices.length > 0) {
        this.populateInvoiceDropdown(filteredInvoices);
        document.getElementById('invoiceDropdownContainer').style.display = 'block';
        this.showAlert(`× ××¦××• ${filteredInvoices.length} ×—×©×‘×•× ×™×•×ª ×©××•×¨×•×ª`, 'success');
      } else {
        console.log('âš ï¸ No invoices in invoices table, checking invoice_documents...');
        
        const { data: documents, error: docError } = await window.supabase
          .from('invoice_documents')
          .select('*')
          .eq('case_id', caseId)
          .eq('plate', plateNumber)
          .order('created_at', { ascending: false });
        
        if (docError) {
          console.error('âŒ Error checking invoice_documents:', docError);
        }
        
        if (documents && documents.length > 0) {
          console.log(`ğŸ“„ Found ${documents.length} invoice documents that need to be saved`);
          this.showAlert(`× ××¦××• ${documents.length} ××¡××›×™ ×—×©×‘×•× ×™×ª ×©×˜×¨× × ×©××¨×•. ×× × ×”×¢×œ×” ×•×©××•×¨ ××•×ª× ×›×“×™ ×œ×¦×¤×•×ª ×‘×”× ×›××Ÿ.`, 'info');
        } else {
          // SESSION 84: Task 4 - Enhanced message with plate number context
          this.showAlert(`×œ× × ××¦××• ×—×©×‘×•× ×™×•×ª ×¢×‘×•×¨ ×¨×›×‘ ${plateNumber}`, 'info');
          console.log('â„¹ï¸ No invoices found for plate:', plateNumber);
        }
      }
      
    } catch (error) {
      console.error('âŒ Error loading invoices:', error);
      this.showAlert('×©×’×™××” ×‘×˜×¢×™× ×ª ×—×©×‘×•× ×™×•×ª ××”×××’×¨', 'error');
    } finally {
      spinner.style.display = 'none';
      loadBtn.disabled = false;
    }
  }

  populateInvoiceDropdown(invoices) {
    const dropdown = document.getElementById('existingInvoicesDropdown');
    
    dropdown.innerHTML = '<option value="">-- ×‘×—×¨ ×—×©×‘×•× ×™×ª --</option>';
    
    invoices.forEach(invoice => {
      const option = document.createElement('option');
      
      const displayDate = new Date(invoice.created_at).toLocaleDateString('he-IL');
      const supplierName = invoice.supplier_name || '×œ× ×¦×•×™×Ÿ';
      option.text = `${supplierName} - ${displayDate}`;
      option.value = invoice.id;
      
      option.dataset.invoiceData = JSON.stringify(invoice);
      
      dropdown.appendChild(option);
    });
  }

  async populateOcrSectionFromInvoice(invoiceData) {
    console.log('ğŸ“¥ Populating OCR section from invoice:', invoiceData);
    console.log('ğŸ“¦ Invoice has lines:', invoiceData.lines?.length || 0);
    console.log('ğŸ“„ Invoice has documents:', invoiceData.documents?.length || 0);
    
    const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
    if (invoiceData.case_id !== helper.case_info?.supabase_case_id) {
      console.error('âŒ Invoice case UUID mismatch!');
      this.showAlert('×©×’×™××”: ×—×©×‘×•× ×™×ª ×œ× ×©×™×™×›×ª ×œ×ª×™×§ ×–×”', 'error');
      return;
    }
    
    // SESSION 84: CRITICAL FIX - Load invoice data from invoice_documents OCR JSON
    // DON'T mix with case/helper data - show invoice EXACTLY as saved!
    let ocrResult = null;
    let documentId = null;
    let usingOriginalOCR = false; // Track if we're using original OCR data

    // Try to get original OCR data from invoice_documents first
    if (invoiceData.documents && invoiceData.documents.length > 0) {
      documentId = invoiceData.documents[0].id;
      this.currentDocumentId = documentId;

      const originalOCR = invoiceData.documents[0].ocr_structured_data;
      if (originalOCR && typeof originalOCR === 'object') {
        // Use ORIGINAL OCR data as-is (preserves invoice exactly as uploaded)
        console.log('âœ… SESSION 84: Using ORIGINAL invoice data from invoice_documents.ocr_structured_data');
        console.log('   This preserves the invoice EXACTLY as saved - no reconstruction!');
        ocrResult = originalOCR;
        usingOriginalOCR = true;
      }
    }

    // Fallback: If no OCR data, reconstruct from invoices table + invoice_lines
    if (!ocrResult) {
      console.warn('âš ï¸ No OCR data found, reconstructing from invoices table + invoice_lines');

      const totalBeforeTax = invoiceData.total_before_tax || 0;
      const taxAmount = invoiceData.tax_amount || 0;
      const vatPercentage = totalBeforeTax > 0 ? ((taxAmount / totalBeforeTax) * 100).toFixed(1) : 17;

      ocrResult = {
        '××¡. ×—×©×‘×•× ×™×ª': invoiceData.invoice_number || '',
        '×©× ××•×¡×š': invoiceData.supplier_name || '',
        '××¡×¤×¨ ×¨×›×‘': invoiceData.plate || '',
        '×‘×¢×œ ×”×¨×›×‘': '',  // Will be filled from invoice_lines if available
        '×ª××¨×™×š': invoiceData.created_at ? new Date(invoiceData.created_at).toISOString().split('T')[0] : '',
        "×¢×œ×•×ª ×›×•×œ×œ×ª ×œ×œ× ××¢'×": totalBeforeTax,
        "××¢'×": vatPercentage,
        "×¢×¨×š ××¢'×": taxAmount,
        '×¢×œ×•×ª ×›×•×œ×œ×ª': invoiceData.total_amount || 0,
        '×—×œ×§×™×': [],
        '×¢×‘×•×“×•×ª': [],
        '×ª×™×§×•× ×™×': [],
        '×¡×”×› ×—×œ×§×™×': 0,
        '×¡×”×› ×¢×‘×•×“×•×ª': 0,
        '×¡×”×› ×ª×™×§×•× ×™×': 0
      };
    }

    console.log('ğŸ“„ Invoice data source:', usingOriginalOCR ? 'ORIGINAL OCR (no reconstruction)' : 'Reconstructed from tables');

    // SESSION 84: CRITICAL - Only process invoice_lines if we're in reconstruction mode!
    // If we have original OCR data, SKIP this entirely to avoid overwriting correct data
    if (!usingOriginalOCR && invoiceData.lines && Array.isArray(invoiceData.lines)) {
      console.log('ğŸ”„ RECONSTRUCTION MODE: Processing', invoiceData.lines.length, 'lines from invoice_lines table...');

      const totalBeforeTax = invoiceData.total_before_tax || 0;
      const taxAmount = invoiceData.tax_amount || 0;

      invoiceData.lines.forEach((line, index) => {
        const metadata = line.metadata || {};
        const category = (metadata.category || 'PART').toUpperCase();

        console.log(`  Line ${index + 1}:`, {
          desc: line.description,
          qty: line.quantity,
          price: line.unit_price,
          total: line.line_total,
          category: category
        });

        const lineData = {
          '×ª×™××•×¨': line.description || '',
          '×›××•×ª': String(line.quantity || 1),
          '×¢×œ×•×ª': String(line.unit_price || 0)
        };

        if (category === 'PART') {
          lineData['×©× ×—×œ×§'] = line.description || '';
          lineData['××§×´×˜ ×—×œ×§'] = metadata.code || '';
          ocrResult['×—×œ×§×™×'].push(lineData);
          ocrResult['×¡×”×› ×—×œ×§×™×'] += line.line_total || 0;
          console.log(`    âœ… PART: Added ${line.line_total} to parts total (now: ${ocrResult['×¡×”×› ×—×œ×§×™×']})`);
        } else if (category === 'WORK') {
          lineData['×¡×•×’ ×”×¢×‘×•×“×”'] = metadata.code || line.description || '';
          lineData['×ª×™××•×¨ ×¢×‘×•×“×•×ª'] = line.description || '';
          lineData['×¢×œ×•×ª ×¢×‘×•×“×•×ª'] = String(line.unit_price || 0);
          ocrResult['×¢×‘×•×“×•×ª'].push(lineData);
          ocrResult['×¡×”×› ×¢×‘×•×“×•×ª'] += line.line_total || 0;
          console.log(`    âœ… WORK: Added ${line.line_total} to works total (now: ${ocrResult['×¡×”×› ×¢×‘×•×“×•×ª']})`);
        } else if (category === 'REPAIR') {
          lineData['×¡×•×’ ×ª×™×§×•×Ÿ'] = metadata.code || line.description || '';
          lineData['×ª×™××•×¨ ×”×ª×™×§×•×Ÿ'] = line.description || '';
          lineData['×¢×œ×•×ª ×ª×™×§×•× ×™×'] = String(line.unit_price || 0);
          ocrResult['×ª×™×§×•× ×™×'].push(lineData);
          ocrResult['×¡×”×› ×ª×™×§×•× ×™×'] += line.line_total || 0;
          console.log(`    âœ… REPAIR: Added ${line.line_total} to repairs total (now: ${ocrResult['×¡×”×› ×ª×™×§×•× ×™×']})`);
        }
      });

      // Only recalculate totals in reconstruction mode
      const calculatedTotal = ocrResult['×¡×”×› ×—×œ×§×™×'] + ocrResult['×¡×”×› ×¢×‘×•×“×•×ª'] + ocrResult['×¡×”×› ×ª×™×§×•× ×™×'];
      console.log('ğŸ“Š SESSION 84 - Totals comparison (RECONSTRUCTION MODE):', {
        'Category totals (from invoice_lines)': {
          parts: ocrResult['×¡×”×› ×—×œ×§×™×'],
          works: ocrResult['×¡×”×› ×¢×‘×•×“×•×ª'],
          repairs: ocrResult['×¡×”×› ×ª×™×§×•× ×™×'],
          calculated_sum: calculatedTotal
        },
        'Invoice table totals': {
          total_before_tax: totalBeforeTax,
          tax_amount: taxAmount,
          total_amount: invoiceData.total_amount
        },
        'MISMATCH': calculatedTotal !== totalBeforeTax ? 'âš ï¸ YES - Category totals do not match invoice total!' : 'âœ… Match'
      });

      // SESSION 84: SAFETY FIX - If invoices table has missing/zero totals, recalculate from lines
      if (totalBeforeTax === 0 || !totalBeforeTax) {
        console.warn('âš ï¸ Invoice table has missing totals! Recalculating from invoice_lines...');
        const recalcVatPercent = ocrResult["××¢'×"] || 17;
        ocrResult["×¢×œ×•×ª ×›×•×œ×œ×ª ×œ×œ× ××¢'×"] = calculatedTotal;
        ocrResult["××¢'×"] = recalcVatPercent;
        ocrResult["×¢×¨×š ××¢'×"] = (calculatedTotal * recalcVatPercent) / 100;
        ocrResult['×¢×œ×•×ª ×›×•×œ×œ×ª'] = calculatedTotal + ocrResult["×¢×¨×š ××¢'×"];
        console.log('âœ… Recalculated totals:', ocrResult);
      }
    } else if (usingOriginalOCR) {
      console.log('âœ… SESSION 84: SKIPPING invoice_lines reconstruction - using original OCR data as-is!');
      console.log('   Invoice will display EXACTLY as it was saved:', {
        'Owner': ocrResult['×‘×¢×œ ×”×¨×›×‘'],
        'Plate': ocrResult['××¡×¤×¨ ×¨×›×‘'],
        'Date': ocrResult['×ª××¨×™×š'],
        'Parts Total': ocrResult['×¡×”×› ×—×œ×§×™×'],
        'Works Total': ocrResult['×¡×”×› ×¢×‘×•×“×•×ª'],
        'Repairs Total': ocrResult['×¡×”×› ×ª×™×§×•× ×™×']
      });
    }
    
    // SESSION 82 FIX: When loading existing invoice, populate this.ocrResults manually
    // DO NOT call handleOCRResults() as it will re-save OCR data and corrupt totals
    const parts = ocrResult['×—×œ×§×™×'] || [];
    const works = ocrResult['×¢×‘×•×“×•×ª'] || [];
    const repairs = ocrResult['×ª×™×§×•× ×™×'] || [];
    
    const parsePrice = (value) => {
      if (!value) return 0;
      const strValue = String(value).replace(/,/g, '');
      const parsed = parseFloat(strValue);
      return isNaN(parsed) ? 0 : parsed;
    };
    
    const partItems = parts.map(part => {
      // Try ALL possible quote variations: ', ", ×´ (Hebrew Gershayim)
      const code = part['××§×´×˜ ×—×œ×§'] || part['××§\'×˜ ×—×œ×§'] || part['××§"×˜ ×—×œ×§'] || part.code || '';
      console.log(`ğŸ“¦ populateOcrSectionFromInvoice - Mapping part: code="${code}", name="${part['×©× ×—×œ×§']}"`, part);
      return {
        code: code,
        name: part['×©× ×—×œ×§'] || part.name || part['×ª×™××•×¨'] || part.description,
        description: part['×ª×™××•×¨'] || part.description || '',
        quantity: parsePrice(part['×›××•×ª'] || part.quantity || 1),
        unit_price: parsePrice(part['×¢×œ×•×ª'] || part.price || part.unit_price),
        category: 'PART'
      };
    });
    
    const workItems = works.map(work => ({
      code: work['×¡×•×’ ×”×¢×‘×•×“×”'] || work['×¡×•×’'] || work.code || '',
      name: work['×ª×™××•×¨ ×¢×‘×•×“×•×ª'] || work.name || work.description,
      description: work['×ª×™××•×¨ ×¢×‘×•×“×•×ª'] || work.description || '',
      quantity: 1,
      unit_price: parsePrice(work['×¢×œ×•×ª ×¢×‘×•×“×•×ª'] || work.price || work.unit_price),
      category: 'WORK'
    }));
    
    const repairItems = repairs.map(repair => ({
      code: repair['×§×•×“'] || repair['×¡×•×’ ×ª×™×§×•×Ÿ'] || repair.code || '',
      name: repair['×ª×™××•×¨ ×”×ª×™×§×•×Ÿ'] || repair.name || repair.description,
      description: repair['×ª×™××•×¨ ×”×ª×™×§×•×Ÿ'] || repair.description || '',
      quantity: 1,
      unit_price: parsePrice(repair['×¢×œ×•×ª ×ª×™×§×•× ×™×'] || repair.price || repair.unit_price),
      category: 'REPAIR'
    })).filter(item => item.unit_price > 0);
    
    this.ocrResults = [...partItems, ...workItems, ...repairItems];
    this.lastOCRResult = ocrResult;
    
    // Display results without re-saving OCR data
    this.displayOCRResults(ocrResult);
    this.updateHelperWithResults(ocrResult);
    
    // SESSION 82 FIX: Set invoice ID and document ID
    this.currentInvoiceId = invoiceData.id;
    
    helper.current_invoice = {
      invoice_id: invoiceData.id,
      case_uuid: invoiceData.case_id,
      source: 'existing',
      document_id: documentId
    };
    
    sessionStorage.setItem('helper', JSON.stringify(helper));
    
    document.getElementById('save-results').style.display = 'inline-block';
    document.getElementById('delete-invoice').style.display = 'inline-block';
    document.getElementById('clear-ui').style.display = 'inline-block';
    
    this.showAlert('âœ… ×—×©×‘×•× ×™×ª × ×˜×¢× ×” ×‘×”×¦×œ×—×”', 'success');
  }

  async viewInvoiceDocument() {
    try {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      const documentId = helper.current_invoice?.document_id;
      
      if (!documentId) {
        this.showAlert('×œ× × ××¦× ×§×•×‘×¥ ×—×©×‘×•× ×™×ª ×œ×¦×¤×™×™×”', 'info');
        return;
      }
      
      console.log('ğŸ“„ Getting document URL for:', documentId);
      const url = await this.invoiceService.getInvoiceDocumentURL(documentId);
      
      if (url) {
        window.open(url, '_blank');
      } else {
        this.showAlert('×©×’×™××”: ×œ× × ×™×ª×Ÿ ×œ×§×‘×œ ×§×™×©×•×¨ ×œ×—×©×‘×•× ×™×ª', 'error');
      }
    } catch (error) {
      console.error('âŒ Error viewing invoice document:', error);
      this.showAlert('×©×’×™××” ×‘×¤×ª×™×—×ª ×”×—×©×‘×•× ×™×ª', 'error');
    }
  }

  setupDragAndDrop() {
    const uploadArea = document.querySelector('.file-upload-area');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, this.preventDefaults, false);
      document.body.addEventListener(eventName, this.preventDefaults, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
      uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
    });

    uploadArea.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const files = dt.files;
      if (files.length > 0) {
        this.handleFileSelection(files[0]);
      }
    }, false);
  }

  preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  async handleFileSelection(file) {
    if (!file) return;

    if (!this.validateFile(file)) {
      return;
    }

    this.uploadedFile = file;
    this.showPreview(file);
    
    // SESSION 76: Reset state for new file to prevent reusing old IDs
    const isNewFile = !this.currentDocumentId || this.uploadedFile.name !== file.name;
    if (isNewFile) {
      this.currentDocumentId = null;
      this.currentInvoiceId = null;
      this.ocrResults = [];
      console.log('ğŸ“ New file selected - reset state');
    }
    
    // SESSION 76: Only upload to Supabase if NOT already uploaded
    if (this.currentDocumentId) {
      console.log('âœ… File already uploaded, reusing document ID:', this.currentDocumentId);
      this.showAlert('×§×•×‘×¥ ×›×‘×¨ × ×˜×¢×Ÿ, ×œ×—×¥ "×¢×‘×“ ×—×©×‘×•× ×™×ª" ×œ×”××©×š', 'info');
      return;
    }
    
    // SESSION 74: Upload to Supabase Storage
    try {
      let caseId = sessionStorage.getItem('currentCaseId');
      const plate = document.getElementById('plate').value;
      
      // Try to get case ID from helper if not in sessionStorage
      if (!caseId) {
        try {
          const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
          // Check helper.case_info.supabase_case_id first, then fallback to helper.case_id
          if (helper.case_info && helper.case_info.supabase_case_id) {
            caseId = helper.case_info.supabase_case_id;
            sessionStorage.setItem('currentCaseId', caseId);
            console.log('âœ… Found case ID in helper.case_info.supabase_case_id:', caseId);
          } else if (helper.case_id) {
            caseId = helper.case_id;
            sessionStorage.setItem('currentCaseId', caseId);
            console.log('âœ… Found case ID in helper.case_id:', caseId);
          }
        } catch (e) {
          console.warn('Could not get case ID from helper:', e);
        }
      }
      
      if (!caseId) {
        console.warn('âš ï¸ No case ID found, skipping Supabase upload (will save via webhook)');
        this.showAlert('×§×•×‘×¥ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×” (×œ×œ× ×©××™×¨×” ×‘×¢× ×Ÿ - ×¤×ª×— ××ª×•×š ×ª×™×§ ×œ×©××™×¨×” ××œ××”)', 'info');
        return;
      }

      console.log('ğŸ“¤ Uploading invoice document to Supabase (FIRST TIME)...');
      const result = await this.invoiceService.uploadInvoiceDocument(file, caseId, plate, null);
      
      if (result.success) {
        this.currentDocumentId = result.document.id;
        console.log('âœ… Document uploaded to Supabase:', this.currentDocumentId);
        this.showAlert('×§×•×‘×¥ × ×˜×¢×Ÿ ×•× ×©××¨ ×‘×”×¦×œ×—×”', 'success');
      }
    } catch (error) {
      console.error('âŒ Supabase upload failed:', error);
      this.showAlert('×§×•×‘×¥ × ×˜×¢×Ÿ (×©××™×¨×” ×‘×¢× ×Ÿ × ×›×©×œ×”)', 'warning');
    }
  }

  validateFile(file) {
    if (!this.allowedTypes.includes(file.type)) {
      this.showAlert(`×¡×•×’ ×§×•×‘×¥ ×œ× × ×ª××š: ${file.name}`, 'error');
      return false;
    }

    if (file.size > this.maxFileSize) {
      this.showAlert(`×§×•×‘×¥ ×’×“×•×œ ××“×™: ${file.name} (××§×¡×™××•× 10MB)`, 'error');
      return false;
    }

    return true;
  }

  showPreview(file) {
    const previewContainer = document.getElementById('preview-container');
    const previewImage = document.getElementById('preview-image');
    
    // Add null checks to prevent errors
    if (!previewContainer || !previewImage) {
      console.error('âŒ Preview elements not found - preview-container or preview-image missing');
      return;
    }
    
    if (file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage.src = e.target.result;
        previewImage.style.display = 'block';
        previewContainer.style.display = 'block';
      };
      reader.readAsDataURL(file);
    } else {
      previewImage.style.display = 'none';
      previewContainer.style.display = 'block';
      previewContainer.innerHTML = `
        <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
          <div style="font-size: 48px; color: #dc3545; margin-bottom: 10px;">ğŸ“„</div>
          <div>×§×•×‘×¥ PDF × ×˜×¢×Ÿ: ${file.name}</div>
        </div>
      `;
    }
  }

  async processInvoice() {
    if (this.processingInProgress) return;
    
    if (!this.uploadedFile) {
      this.showAlert('×× × ×‘×—×¨ ×§×•×‘×¥ ×—×©×‘×•× ×™×ª', 'error');
      return;
    }

    if (!this.validateForm()) {
      return;
    }

    this.processingInProgress = true;
    this.showProcessingStatus(true);
    
    try {
      const formData = new FormData();
      formData.append('file', this.uploadedFile);
      // SESSION 74: Removed 'pass' field - using Supabase auth only
      // Add defensive checks for all fields
      const plateEl = document.getElementById('plate');
      const ownerEl = document.getElementById('owner');
      const garageEl = document.getElementById('garage_name');
      const dateEl = document.getElementById('date');
      const typeEl = document.getElementById('invoice-type');
      
      formData.append('meta', JSON.stringify({
        plate: plateEl ? plateEl.value : '',
        owner: ownerEl ? ownerEl.value : '',
        garage_name: garageEl ? garageEl.value : '',
        date: dateEl ? dateEl.value : '',
        invoice_type: typeEl ? typeEl.value : ''
      }));

      // FIXED: Use sendToWebhook to get proper Make.com array parsing
      const result = await sendToWebhook('OCR_INVOICES', formData);
      
      console.log('âœ… Invoice OCR webhook response:', result);
      this.handleOCRResults(result);
      this.showAlert('âœ… ×—×©×‘×•× ×™×ª ×¢×•×‘×“×” ×‘×”×¦×œ×—×”', 'success');
      
    } catch (error) {
      console.error('Invoice processing error:', error);
      this.showAlert('âŒ ×©×’×™××” ×‘×¢×™×‘×•×“ ×”×—×©×‘×•× ×™×ª: ' + error.message, 'error');
    } finally {
      this.processingInProgress = false;
      this.showProcessingStatus(false);
    }
  }

  validateForm() {
    // SESSION 74: Removed 'pass' from required fields - using Supabase auth only
    const required = ['plate', 'owner'];
    for (const fieldId of required) {
      const field = document.getElementById(fieldId);
      if (!field || !field.value.trim()) {
        this.showAlert(`×©×“×” ×—×•×‘×”: ${field ? field.previousElementSibling.textContent : fieldId}`, 'error');
        if (field) field.focus();
        return false;
      }
    }
    
    return true;
  }

  async handleOCRResults(result) {
    // SESSION 79: Parse Hebrew structured data from webhook
    // Webhook returns: { ×—×œ×§×™×: [], ×¢×‘×•×“×•×ª: [], ×ª×™×§×•× ×™×: [] }
    // Need to combine into flat items array for UI
    
    // SESSION 79 FIX: Store OCR result for use in saveResults()
    this.lastOCRResult = result;
    
    const parts = result.×—×œ×§×™× || result.parts || [];
    const works = result.×¢×‘×•×“×•×ª || result.works || [];
    const repairs = result.×ª×™×§×•× ×™× || result.repairs || [];
    
    // SESSION 79 FIX: Helper function to parse prices with comma separators
    const parsePrice = (value) => {
      if (!value) return 0;
      const strValue = String(value).replace(/,/g, ''); // Remove commas
      const parsed = parseFloat(strValue);
      return isNaN(parsed) ? 0 : parsed;
    };
    
    // Convert parts to items format
    const partItems = parts.map(part => {
      // Try ALL possible quote variations: ', ", ×´ (Hebrew Gershayim)
      const code = part['××§×´×˜ ×—×œ×§'] || part['××§\'×˜ ×—×œ×§'] || part['××§"×˜ ×—×œ×§'] || part.code || '';
      console.log(`ğŸ“¦ handleOCRResults - Mapping part: code="${code}", name="${part['×©× ×—×œ×§']}"`, part);
      return {
        code: code,
        name: part['×©× ×—×œ×§'] || part.name || part['×ª×™××•×¨'] || part.description,
        description: part['×ª×™××•×¨'] || part.description || '',
        quantity: parsePrice(part['×›××•×ª'] || part.quantity || 1),
        unit_price: parsePrice(part['×¢×œ×•×ª'] || part.price || part.unit_price),
        category: 'PART'
      };
    });
    
    // Convert works to items format
    const workItems = works.map(work => ({
      code: work['×¡×•×’ ×”×¢×‘×•×“×”'] || work['×¡×•×’'] || work.code || '',
      name: work['×ª×™××•×¨ ×¢×‘×•×“×•×ª'] || work.name || work.description,
      description: work['×ª×™××•×¨ ×¢×‘×•×“×•×ª'] || work.description || '',
      quantity: 1,
      unit_price: parsePrice(work['×¢×œ×•×ª ×¢×‘×•×“×•×ª'] || work.price || work.unit_price),
      category: 'WORK'
    }));
    
    // Convert repairs to items format
    const repairItems = repairs.map(repair => ({
      code: repair['×§×•×“'] || repair['×¡×•×’ ×ª×™×§×•×Ÿ'] || repair.code || '',
      name: repair['×ª×™××•×¨ ×”×ª×™×§×•×Ÿ'] || repair.name || repair.description,
      description: repair['×ª×™××•×¨ ×”×ª×™×§×•×Ÿ'] || repair.description || '',
      quantity: 1,
      unit_price: parsePrice(repair['×¢×œ×•×ª ×ª×™×§×•× ×™×'] || repair.price || repair.unit_price),
      category: 'REPAIR'
    })).filter(item => item.unit_price > 0); // Filter out "××™×Ÿ ××™×“×¢" entries
    
    // Combine all items
    this.ocrResults = [...partItems, ...workItems, ...repairItems];
    
    // Fallback to old format if Hebrew fields not found
    if (this.ocrResults.length === 0) {
      this.ocrResults = result.items || [];
    }
    
    console.log(`ğŸ“Š Parsed ${partItems.length} parts, ${workItems.length} works, ${repairItems.length} repairs`);
    
    this.displayOCRResults(result);
    this.showValidationStatus(result);
    
    // SESSION 74: Save OCR results to Supabase
    try {
      if (this.currentDocumentId) {
        console.log('ğŸ’¾ Saving OCR results to Supabase...');
        await this.invoiceService.updateOCRResults(this.currentDocumentId, result);
        console.log('âœ… OCR results saved to Supabase');
      } else {
        console.warn('âš ï¸ No document ID, skipping Supabase OCR save');
      }
    } catch (error) {
      console.error('âŒ Failed to save OCR results to Supabase:', error);
    }
    
    // Update helper with OCR results
    this.updateHelperWithResults(result);
    
    // Show save button
    document.getElementById('save-results').style.display = 'inline-block';
  }

  displayOCRResults(result) {
    const ocrContainer = document.getElementById('ocr-results');
    const summaryContainer = document.getElementById('ocr-summary');
    const resultsBody = document.getElementById('results-body');
    
    // Show OCR results section
    ocrContainer.classList.add('show');
    
    // SESSION 80: Show delete and clear buttons when results are displayed
    document.getElementById('delete-invoice').style.display = 'inline-block';
    document.getElementById('clear-ui').style.display = 'inline-block';
    
    // SESSION 76: Calculate totals by category
    let totalParts = 0, totalWorks = 0, totalRepairs = 0, totalOther = 0;
    
    this.ocrResults.forEach(item => {
      const lineTotal = (item.quantity || 1) * (item.unit_price || 0);
      const category = this.categorizeItem(item.name || item.description || '');
      
      if (category === 'PART') totalParts += lineTotal;
      else if (category === 'WORK') totalWorks += lineTotal;
      else if (category === 'REPAIR') totalRepairs += lineTotal;
      else totalOther += lineTotal;
    });
    
    const calculatedTotal = totalParts + totalWorks + totalRepairs + totalOther;
    
    // SESSION 79: Get invoice details - PRIORITIZE OCR DATA over form fields
    const invoiceNumber = result['××¡. ×—×©×‘×•× ×™×ª'] || result.invoice_number || `INV-${Date.now()}`;
    const garageName = result['×©× ××•×¡×š'] || document.getElementById('garage_name').value || '×œ× ×¦×•×™×Ÿ';
    const plate = result['××¡×¤×¨ ×¨×›×‘'] || document.getElementById('plate').value || '×œ× ×¦×•×™×Ÿ';
    const invoiceDate = result['×ª××¨×™×š'] || document.getElementById('date').value || new Date().toISOString().split('T')[0];
    const carOwner = result['×‘×¢×œ ×”×¨×›×‘'] || '×œ× ×¦×•×™×Ÿ';
    
    // SESSION 79 FIX: Get totals from OCR data, not calculated (OCR has final totals)
    const parsePrice = (value) => {
      if (!value) return 0;
      const strValue = String(value).replace(/,/g, '').replace(/%/g, '');
      const parsed = parseFloat(strValue);
      return isNaN(parsed) ? 0 : parsed;
    };
    
    // SESSION 80: Debug - log all keys to find exact names
    console.log('ğŸ” OCR Result Keys:', Object.keys(result));
    console.log('ğŸ“Š Cost values from result:', {
      '×¡×”×› ×—×œ×§×™×': result['×¡×”×› ×—×œ×§×™×'],
      '×¡×”×› ×¢×‘×•×“×•×ª': result['×¡×”×› ×¢×‘×•×“×•×ª'],
      '×¡×”×› ×ª×™×§×•× ×™×': result['×¡×”×› ×ª×™×§×•× ×™×'],
      "×¢×œ×•×ª ×›×•×œ×œ×ª ×œ×œ× ××¢'×": result["×¢×œ×•×ª ×›×•×œ×œ×ª ×œ×œ× ××¢'×"],
      "××¢'×": result["××¢'×"],
      "×¢×¨×š ××¢'×": result["×¢×¨×š ××¢'×"],
      '×¢×œ×•×ª ×›×•×œ×œ×ª': result['×¢×œ×•×ª ×›×•×œ×œ×ª']
    });
    
    // SESSION 82 FIX: Use category totals directly from webhook - NEVER calculate
    // The webhook returns correct totals, we should trust those values
    let partsTotal = parsePrice(result['×¡×”×› ×—×œ×§×™×']) || parsePrice(result['×™×ª×¨×ª ×—×œ×§×™×']) || 0;
    let worksTotal = parsePrice(result['×¡×”×› ×¢×‘×•×“×•×ª']) || parsePrice(result['×™×ª×¨×ª ×¢×‘×•×“×•×ª']) || 0;
    let repairsTotal = parsePrice(result['×¡×”×› ×ª×™×§×•× ×™×']) || parsePrice(result['×™×ª×¨×ª ×ª×™×§×•× ×™×']) || 0;
    
    console.log('âœ… Using category totals from OCR webhook:', { partsTotal, worksTotal, repairsTotal });
    
    // Try ALL quote variations for VAT fields: ', ", ×´ (Hebrew Gershayim)
    const totalBeforeVAT = parsePrice(result["×¢×œ×•×ª ×›×•×œ×œ×ª ×œ×œ× ××¢×´×"] || result["×¢×œ×•×ª ×›×•×œ×œ×ª ×œ×œ× ××¢'×"] || result["×¢×œ×•×ª ×›×•×œ×œ×ª ×œ×œ× ××¢\"×"]);
    const vatPercentage = parsePrice(result["××¢×´×"] || result["××¢'×"] || result["××¢\"×"]);
    const vatAmount = parsePrice(result["×¢×¨×š ××¢×´×"] || result["×¢×¨×š ××¢'×"] || result["×¢×¨×š ××¢\"×"]);
    const totalWithVAT = parsePrice(result['×¢×œ×•×ª ×›×•×œ×œ×ª']);
    
    console.log('ğŸ’° Parsed values:', { partsTotal, worksTotal, repairsTotal, totalBeforeVAT, vatPercentage, vatAmount, totalWithVAT });
    
    // SESSION 79 FIX: Display enhanced summary with correct OCR data
    summaryContainer.innerHTML = `
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h4 style="margin: 0 0 15px 0; font-size: 20px; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 10px;">ğŸ“‹ ×¡×™×›×•× ×—×©×‘×•× ×™×ª</h4>
        
        <!-- Invoice Header Info - SESSION 80: EDITABLE FIELDS -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 15px;">
          <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 8px;">
            <div style="font-size: 11px; opacity: 0.8;">××¡×¤×¨ ×—×©×‘×•× ×™×ª</div>
            <input type="text" id="edit-invoice-number" value="${invoiceNumber}" style="width: 100%; padding: 5px; font-size: 14px; font-weight: bold; margin-top: 3px; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; background: rgba(255,255,255,0.9); color: #333;" />
          </div>
          <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 8px;">
            <div style="font-size: 11px; opacity: 0.8;">×‘×¢×œ ×”×¨×›×‘</div>
            <input type="text" id="edit-car-owner" value="${carOwner}" style="width: 100%; padding: 5px; font-size: 13px; font-weight: bold; margin-top: 3px; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; background: rgba(255,255,255,0.9); color: #333;" />
          </div>
          <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 8px;">
            <div style="font-size: 11px; opacity: 0.8;">××¡×¤×¨ ×¨×›×‘</div>
            <input type="text" id="edit-plate" value="${plate}" style="width: 100%; padding: 5px; font-size: 14px; font-weight: bold; margin-top: 3px; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; background: rgba(255,255,255,0.9); color: #333;" />
          </div>
          <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 8px;">
            <div style="font-size: 11px; opacity: 0.8;">××•×¡×š</div>
            <input type="text" id="edit-garage-name" value="${garageName}" style="width: 100%; padding: 5px; font-size: 12px; font-weight: bold; margin-top: 3px; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; background: rgba(255,255,255,0.9); color: #333;" />
          </div>
          <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 8px;">
            <div style="font-size: 11px; opacity: 0.8;">×ª××¨×™×š</div>
            <input type="text" id="edit-date" value="${invoiceDate}" placeholder="dd/mm/yyyy" style="width: 100%; padding: 5px; font-size: 13px; font-weight: bold; margin-top: 3px; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; background: rgba(255,255,255,0.9); color: #333;" />
          </div>
        </div>
        
        <!-- Cost Breakdown by Category - SESSION 80: EDITABLE with better formatting -->
        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <div style="font-size: 13px; margin-bottom: 10px; font-weight: bold;">×¤×™×¨×•×˜ ×¢×œ×•×™×•×ª:</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
            <div style="background: rgba(76, 175, 80, 0.3); padding: 8px; border-radius: 6px;">
              <div style="font-size: 10px; opacity: 0.9; margin-bottom: 3px;">ğŸ”§ ×—×œ×§×™×</div>
              <div style="font-size: 18px; font-weight: 700; text-align: center; color: #fff; direction: ltr; margin: 5px 0;">â‚ª${partsTotal.toLocaleString('he-IL', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
              <input type="number" id="edit-parts-total" value="${partsTotal}" step="0.01" style="width: 100%; padding: 4px 6px; font-size: 12px; font-weight: 500; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; background: rgba(255,255,255,0.7); color: #1a1a1a; text-align: center; direction: ltr;" />
            </div>
            <div style="background: rgba(33, 150, 243, 0.3); padding: 8px; border-radius: 6px;">
              <div style="font-size: 10px; opacity: 0.9; margin-bottom: 3px;">ğŸ‘· ×¢×‘×•×“×•×ª</div>
              <div style="font-size: 18px; font-weight: 700; text-align: center; color: #fff; direction: ltr; margin: 5px 0;">â‚ª${worksTotal.toLocaleString('he-IL', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
              <input type="number" id="edit-works-total" value="${worksTotal}" step="0.01" style="width: 100%; padding: 4px 6px; font-size: 12px; font-weight: 500; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; background: rgba(255,255,255,0.7); color: #1a1a1a; text-align: center; direction: ltr;" />
            </div>
            <div style="background: rgba(255, 152, 0, 0.3); padding: 8px; border-radius: 6px;">
              <div style="font-size: 10px; opacity: 0.9; margin-bottom: 3px;">ğŸ”¨ ×ª×™×§×•× ×™×</div>
              <div style="font-size: 18px; font-weight: 700; text-align: center; color: #fff; direction: ltr; margin: 5px 0;">â‚ª${repairsTotal.toLocaleString('he-IL', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
              <input type="number" id="edit-repairs-total" value="${repairsTotal}" step="0.01" style="width: 100%; padding: 4px 6px; font-size: 12px; font-weight: 500; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; background: rgba(255,255,255,0.7); color: #1a1a1a; text-align: center; direction: ltr;" />
            </div>
          </div>
        </div>
        
        <!-- VAT Breakdown - SESSION 82: EDITABLE with prominent formatting -->
        <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="font-size: 14px; font-weight: 600;">×¡×”"×› ×œ×¤× ×™ ××¢"×:</span>
            <div style="text-align: left;">
              <div style="font-size: 16px; font-weight: 700; color: #fff; direction: ltr; margin-bottom: 3px;">â‚ª${totalBeforeVAT.toLocaleString('he-IL', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
              <input type="number" id="edit-total-before-vat" value="${totalBeforeVAT}" step="0.01" style="width: 140px; padding: 4px 6px; font-size: 11px; font-weight: 500; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; background: rgba(255,255,255,0.7); color: #1a1a1a; text-align: center; direction: ltr;" />
            </div>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="font-size: 14px; font-weight: 600;">××¢"× (%):</span>
            <div style="text-align: left;">
              <div style="font-size: 16px; font-weight: 700; color: #fff; direction: ltr; margin-bottom: 3px;">${vatPercentage}%</div>
              <input type="number" id="edit-vat-percentage" value="${vatPercentage}" step="0.1" min="0" max="100" style="width: 70px; padding: 4px 6px; font-size: 11px; font-weight: 500; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; background: rgba(255,255,255,0.7); color: #1a1a1a; text-align: center; direction: ltr;" />
            </div>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="font-size: 14px; font-weight: 600;">×¢×¨×š ××¢"×:</span>
            <div style="text-align: left;">
              <div style="font-size: 16px; font-weight: 700; color: #fff; direction: ltr; margin-bottom: 3px;">â‚ª${vatAmount.toLocaleString('he-IL', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
              <input type="number" id="edit-vat-amount" value="${vatAmount}" step="0.01" style="width: 140px; padding: 4px 6px; font-size: 11px; font-weight: 500; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; background: rgba(255,255,255,0.7); color: #1a1a1a; text-align: center; direction: ltr;" />
            </div>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 2px solid rgba(255,255,255,0.3);">
            <span style="font-size: 16px; font-weight: bold;">×¡×”"×› ×›×•×œ×œ ××¢"×:</span>
            <div style="text-align: left;">
              <div style="font-size: 18px; font-weight: 800; color: #fff; direction: ltr; margin-bottom: 3px;">â‚ª${totalWithVAT.toLocaleString('he-IL', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
              <input type="number" id="edit-total-with-vat" value="${totalWithVAT}" step="0.01" style="width: 140px; padding: 5px 8px; font-size: 12px; font-weight: 600; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; border: 1px solid rgba(255,255,255,0.4); border-radius: 4px; background: rgba(255,255,255,0.8); color: #1a1a1a; text-align: center; direction: ltr;" />
            </div>
          </div>
        </div>
        
        ${this.currentDocumentId ? `
        <div style="margin-top: 15px; text-align: center; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
          <button onclick="window.invoiceProcessor.viewInvoicePDF()" class="btn" style="background: rgba(255,255,255,0.9); color: #667eea; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
            ğŸ“„ ×¦×¤×” ×‘×—×©×‘×•× ×™×ª
          </button>
          <button onclick="window.invoiceProcessor.reprocessOCR()" class="btn" style="background: rgba(255,193,7,0.9); color: #1e293b; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
            ğŸ”„ ×¢×‘×“ ×—×©×‘×•× ×™×ª ×©×•×‘
          </button>
          <button onclick="window.invoiceProcessor.saveEditsToHelper()" class="btn" style="background: rgba(34,197,94,0.9); color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
            âœï¸ ×©××•×¨ ×¢×¨×™×›×•×ª
          </button>
        </div>
        ` : ''}
      </div>
    `;
    
    // SESSION 79 FIX: Display results table - simple, clean, organized by category
    resultsBody.innerHTML = '';
    
    // Group items by category
    const partItems = this.ocrResults.filter(item => item.category === 'PART');
    const workItems = this.ocrResults.filter(item => item.category === 'WORK');
    const repairItems = this.ocrResults.filter(item => item.category === 'REPAIR');
    
    const renderCategory = (items, categoryName, icon, categoryType) => {
      // SESSION 80: Always show header even if empty, with add button
      const headerRow = document.createElement('tr');
      headerRow.innerHTML = `
        <td colspan="5" style="background: #334155; color: white; font-weight: bold; padding: 6px 8px; text-align: right; font-size: 11px;">
          ${icon} ${categoryName} (${items.length})
        </td>
        <td style="background: #334155; padding: 4px 6px; text-align: center;">
          <button type="button" onclick="window.invoiceProcessor.addLineToCategory('${categoryType}')" class="btn btn-success" style="padding: 4px 8px; font-size: 10px; background: #22c55e; color: white; border: none; border-radius: 3px; cursor: pointer;">+ ×”×•×¡×£</button>
        </td>
      `;
      resultsBody.appendChild(headerRow);
      
      if (items.length === 0) {
        // Show empty state row
        const emptyRow = document.createElement('tr');
        emptyRow.style.background = '#475569';
        emptyRow.innerHTML = `
          <td colspan="6" style="padding: 8px; text-align: center; color: #cbd5e1; font-size: 11px; font-style: italic;">
            ××™×Ÿ ×¤×¨×™×˜×™× ×‘×§×˜×’×•×¨×™×” ×–×• - ×œ×—×¥ '+ ×”×•×¡×£' ×œ×”×•×¡×¤×”
          </td>
        `;
        resultsBody.appendChild(emptyRow);
      } else {
        items.forEach((item, index) => {
          const globalIndex = this.ocrResults.indexOf(item);
          console.log(`ğŸ” Rendering item ${index}, code: "${item.code}", name: "${item.name}", category: "${item.category}"`);
          const row = document.createElement('tr');
          row.style.background = '#64748b';
          row.innerHTML = `
            <td style="padding: 4px 6px; width: 150px;"><input type="text" value="${item.code || ''}" data-field="code" data-index="${globalIndex}" class="result-field" style="width: 100%; padding: 4px 6px; font-size: 11px; color: #000; border: 1px solid #94a3b8; border-radius: 3px; background: #fff;"></td>
            <td style="padding: 4px 6px;"><input type="text" value="${item.description || ''}" data-field="description" data-index="${globalIndex}" class="result-field" style="width: 100%; padding: 4px 6px; font-size: 11px; color: #000; border: 1px solid #94a3b8; border-radius: 3px; background: #fff;"></td>
            <td style="padding: 4px 6px; width: 60px;"><input type="number" value="${item.quantity || 1}" data-field="quantity" data-index="${globalIndex}" class="result-field" min="1" style="width: 100%; padding: 4px; font-size: 11px; color: #000; border: 1px solid #94a3b8; border-radius: 3px; background: #fff; text-align: center;"></td>
            <td style="padding: 4px 6px; width: 80px;"><input type="number" value="${item.unit_price || 0}" data-field="unit_price" data-index="${globalIndex}" class="result-field" step="0.01" style="width: 100%; padding: 4px; font-size: 11px; color: #000; border: 1px solid #94a3b8; border-radius: 3px; background: #fff; text-align: center;"></td>
            <td style="padding: 4px 6px; width: 85px; font-weight: bold; color: #fff; font-size: 11px; text-align: center;">â‚ª${((item.quantity || 1) * (item.unit_price || 0)).toLocaleString()}</td>
            <td style="padding: 4px 6px; width: 70px; text-align: center;"><button type="button" onclick="window.invoiceProcessor.removeItem(${globalIndex})" class="btn btn-danger" style="padding: 4px 8px; font-size: 10px; background: #dc2626; color: white; border: none; border-radius: 3px; cursor: pointer;">×”×¡×¨</button></td>
          `;
          resultsBody.appendChild(row);
        });
      }
    };
    
    renderCategory(partItems, '×—×œ×§×™×', 'ğŸ”§', 'PART');
    renderCategory(workItems, '×¢×‘×•×“×•×ª', 'ğŸ‘·', 'WORK');
    renderCategory(repairItems, '×ª×™×§×•× ×™×', 'ğŸ”¨', 'REPAIR');
    
    // Add event listeners for real-time calculation
    document.querySelectorAll('.result-field').forEach(field => {
      field.addEventListener('input', (e) => {
        this.updateItemCalculation(e.target);
      });
    });
    
    // SESSION 82: Add event listeners for ALL editable fields in invoice summary
    const editableFields = [
      'edit-invoice-number',
      'edit-car-owner', 
      'edit-plate',
      'edit-garage-name',
      'edit-date',
      'edit-parts-total',
      'edit-works-total',
      'edit-repairs-total',
      'edit-total-before-vat',
      'edit-vat-percentage',
      'edit-vat-amount',
      'edit-total-with-vat'
    ];
    
    editableFields.forEach(fieldId => {
      const field = document.getElementById(fieldId);
      if (field) {
        field.addEventListener('input', () => {
          this.hasUnsavedEdits = true;
          console.log(`âœï¸ Field ${fieldId} edited, hasUnsavedEdits = true`);
          
          // SESSION 83: Auto-recalculate when category totals or VAT% change
          if (['edit-parts-total', 'edit-works-total', 'edit-repairs-total', 'edit-vat-percentage'].includes(fieldId)) {
            this.recalculateInvoiceTotals();
          }
        });
      }
    });
  }
  
  recalculateInvoiceTotals() {
    // Get category totals
    const partsTotal = parseFloat(document.getElementById('edit-parts-total')?.value || 0);
    const worksTotal = parseFloat(document.getElementById('edit-works-total')?.value || 0);
    const repairsTotal = parseFloat(document.getElementById('edit-repairs-total')?.value || 0);
    
    // Calculate total before VAT
    const totalBeforeVAT = partsTotal + worksTotal + repairsTotal;
    
    // Get VAT percentage
    const vatPercentage = parseFloat(document.getElementById('edit-vat-percentage')?.value || 0);
    
    // Calculate VAT amount
    const vatAmount = (totalBeforeVAT * vatPercentage) / 100;
    
    // Calculate total with VAT
    const totalWithVAT = totalBeforeVAT + vatAmount;
    
    // Update the fields
    document.getElementById('edit-total-before-vat').value = totalBeforeVAT.toFixed(2);
    document.getElementById('edit-vat-amount').value = vatAmount.toFixed(2);
    document.getElementById('edit-total-with-vat').value = totalWithVAT.toFixed(2);
    
    console.log('ğŸ”¢ Recalculated totals:', { totalBeforeVAT, vatAmount, totalWithVAT });
  }

  async updateItemCalculation(field) {
    const index = field.dataset.index;
    const fieldType = field.dataset.field;
    const value = field.value;
    
    // Update internal data
    if (this.ocrResults[index]) {
      this.ocrResults[index][fieldType] = fieldType === 'quantity' || fieldType === 'unit_price' ? parseFloat(value) || 0 : value;
      
      // Update total display
      const row = field.closest('tr');
      const totalCell = row.querySelector('td:nth-last-child(2)'); // Total is 2nd from end
      const quantity = parseFloat(row.querySelector('[data-field="quantity"]').value) || 0;
      const unitPrice = parseFloat(row.querySelector('[data-field="unit_price"]').value) || 0;
      totalCell.textContent = `â‚ª${(quantity * unitPrice).toLocaleString()}`;
      
      // Update overall totals
      this.updateOverallTotals();
      
      // SESSION 79: Mark as edited
      this.hasUnsavedEdits = true;
      
      // SESSION 83: Auto-save to Supabase if invoice already exists
      if (this.currentInvoiceId) {
        await this.autoSaveItemLine(index);
      }
    }
  }
  
  async autoSaveItemLine(index) {
    try {
      const item = this.ocrResults[index];
      if (!item) return;

      console.log(`ğŸ’¾ Auto-saving line ${index + 1}:`, item);

      const lineNumber = index + 1;
      const itemCode = item.code || null;

      // STEP 1: Update invoice_lines table
      const { error: lineError } = await window.supabase
        .from('invoice_lines')
        .update({
          description: item.name || item.description || '',
          quantity: item.quantity || 1,
          unit_price: item.unit_price || 0,
          line_total: (item.quantity || 1) * (item.unit_price || 0),
          metadata: {
            category: item.category || 'OTHER',
            code: itemCode,
            name: item.name || item.description || ''
          }
        })
        .eq('invoice_id', this.currentInvoiceId)
        .eq('line_number', lineNumber);

      if (lineError) {
        console.error('âŒ invoice_lines update failed:', lineError);
        throw lineError;
      }

      // SESSION 84: STEP 2 - Update invoice_documents.ocr_structured_data JSON
      if (this.currentDocumentId && this.lastOCRResult) {
        // Update the specific item in the OCR JSON structure
        const categoryMap = {
          'PART': '×—×œ×§×™×',
          'part': '×—×œ×§×™×',
          'WORK': '×¢×‘×•×“×•×ª',
          'work': '×¢×‘×•×“×•×ª',
          'REPAIR': '×ª×™×§×•× ×™×',
          'repair': '×ª×™×§×•× ×™×'
        };

        const categoryKey = categoryMap[item.category] || '×—×œ×§×™×';

        if (this.lastOCRResult[categoryKey] && Array.isArray(this.lastOCRResult[categoryKey])) {
          // Find and update the item in the OCR array
          const ocrItemIndex = this.lastOCRResult[categoryKey].findIndex((ocrItem, idx) => idx === index);
          if (ocrItemIndex !== -1) {
            this.lastOCRResult[categoryKey][ocrItemIndex] = {
              ...this.lastOCRResult[categoryKey][ocrItemIndex],
              '×ª×™××•×¨': item.description || item.name,
              '×›××•×ª': String(item.quantity || 1),
              '×¢×œ×•×ª': String(item.unit_price || 0)
            };

            // Update invoice_documents.ocr_structured_data
            const { error: docError } = await window.supabase
              .from('invoice_documents')
              .update({ ocr_structured_data: this.lastOCRResult })
              .eq('id', this.currentDocumentId);

            if (docError) {
              console.error('âŒ invoice_documents JSON update failed:', docError);
            } else {
              console.log('âœ… Updated invoice_documents OCR JSON');
            }
          }
        }
      }

      // SESSION 84: STEP 3 - Update helper.invoices for this specific item
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      if (helper.invoices && Array.isArray(helper.invoices)) {
        const invoiceIndex = helper.invoices.findIndex(inv =>
          (inv.invoice_id || inv.supabase_invoice_id || inv.id) === this.currentInvoiceId
        );

        if (invoiceIndex !== -1) {
          const invoice = helper.invoices[invoiceIndex];

          // Update the specific category array in helper
          const helperCategoryMap = {
            'PART': '×—×œ×§×™×',
            'part': '×—×œ×§×™×',
            'WORK': '×¢×‘×•×“×•×ª',
            'work': '×¢×‘×•×“×•×ª',
            'REPAIR': '×ª×™×§×•× ×™×',
            'repair': '×ª×™×§×•× ×™×'
          };

          const helperCategoryKey = helperCategoryMap[item.category];
          if (helperCategoryKey && invoice[helperCategoryKey]) {
            // Update the specific item in the helper category array
            const helperItemIndex = invoice[helperCategoryKey].findIndex((helperItem, idx) => idx === index);
            if (helperItemIndex !== -1) {
              invoice[helperCategoryKey][helperItemIndex] = {
                ...invoice[helperCategoryKey][helperItemIndex],
                '×ª×™××•×¨': item.description || item.name,
                '×›××•×ª': String(item.quantity || 1),
                '×¢×œ×•×ª': String(item.unit_price || 0)
              };

              sessionStorage.setItem('helper', JSON.stringify(helper));
              console.log('âœ… Updated helper.invoices item');
            }
          }
        }
      }

      // SESSION 84: STEP 4 - Recalculate and update invoices table totals
      await this.recalculateInvoiceTotals();

      // Visual feedback - green flash
      console.log(`âœ… Auto-saved line ${lineNumber} to all systems`);
      const row = document.querySelector(`[data-index="${index}"]`)?.closest('tr');
      if (row) {
        row.style.background = '#10b981';
        setTimeout(() => {
          row.style.background = '#64748b';
        }, 500);
      }

    } catch (error) {
      console.error('âŒ Auto-save error:', error);
      const row = document.querySelector(`[data-index="${index}"]`)?.closest('tr');
      if (row) {
        row.style.background = '#ef4444'; // Red flash on error
        setTimeout(() => {
          row.style.background = '#64748b';
        }, 500);
      }
    }
  }

  // SESSION 84: New function to recalculate invoice totals
  async recalculateInvoiceTotals() {
    if (!this.currentInvoiceId) return;

    try {
      // Fetch all lines for this invoice
      const { data: lines, error: fetchError } = await window.supabase
        .from('invoice_lines')
        .select('*')
        .eq('invoice_id', this.currentInvoiceId);

      if (fetchError) throw fetchError;

      // Calculate category totals
      const partsTotal = lines
        .filter(line => (line.metadata?.category || '').toUpperCase() === 'PART')
        .reduce((sum, line) => sum + (line.line_total || 0), 0);

      const worksTotal = lines
        .filter(line => (line.metadata?.category || '').toUpperCase() === 'WORK')
        .reduce((sum, line) => sum + (line.line_total || 0), 0);

      const repairsTotal = lines
        .filter(line => (line.metadata?.category || '').toUpperCase() === 'REPAIR')
        .reduce((sum, line) => sum + (line.line_total || 0), 0);

      const totalBeforeVAT = partsTotal + worksTotal + repairsTotal;

      // Get VAT% from UI or calculate
      const vatPercentage = parseFloat(document.getElementById('edit-vat-percentage')?.value) || 17;
      const vatAmount = (totalBeforeVAT * vatPercentage) / 100;
      const totalWithVAT = totalBeforeVAT + vatAmount;

      // Update invoices table
      const { error: updateError } = await window.supabase
        .from('invoices')
        .update({
          total_before_tax: totalBeforeVAT,
          tax_amount: vatAmount,
          total_amount: totalWithVAT,
          updated_at: new Date().toISOString()
        })
        .eq('id', this.currentInvoiceId);

      if (updateError) throw updateError;

      console.log('âœ… Recalculated invoice totals:', {
        parts: partsTotal,
        works: worksTotal,
        repairs: repairsTotal,
        totalBeforeVAT,
        vatAmount,
        totalWithVAT
      });

    } catch (error) {
      console.error('âŒ Failed to recalculate totals:', error);
    }
  }

  updateOverallTotals() {
    // SESSION 76: Recalculate totals by category
    let totalParts = 0, totalWorks = 0, totalRepairs = 0, totalOther = 0;
    
    this.ocrResults.forEach(item => {
      const lineTotal = (item.quantity || 1) * (item.unit_price || 0);
      const category = item.category || this.categorizeItem(item.name || item.description || '');
      
      if (category === 'PART') totalParts += lineTotal;
      else if (category === 'WORK') totalWorks += lineTotal;
      else if (category === 'REPAIR') totalRepairs += lineTotal;
      else totalOther += lineTotal;
    });
    
    const total = totalParts + totalWorks + totalRepairs + totalOther;
    
    // Update summary total display - this won't exist in the DOM, just track internally
    console.log('ğŸ“Š Updated totals - Parts:', totalParts, 'Works:', totalWorks, 'Repairs:', totalRepairs, 'Total:', total);
  }
  
  // SESSION 76: Categorize invoice items
  categorizeItem(text) {
    const lowerText = text.toLowerCase();
    
    // Parts keywords
    if (lowerText.includes('×—×œ×§') || lowerText.includes('×¤× ×¡') || lowerText.includes('××¨××”') || 
        lowerText.includes('×“×œ×ª') || lowerText.includes('×¤×’×•×©') || lowerText.includes('×’×œ×’×œ') ||
        lowerText.includes('×¦××™×’') || lowerText.includes('×× ×•×¢') || lowerText.includes('part')) {
      return 'PART';
    }
    
    // Work/Labor keywords  
    if (lowerText.includes('×¢×‘×•×“×”') || lowerText.includes('×©×¢×ª') || lowerText.includes('×©×¢×•×ª') ||
        lowerText.includes('×”×ª×§× ×”') || lowerText.includes('labor') || lowerText.includes('work')) {
      return 'WORK';
    }
    
    // Repair keywords
    if (lowerText.includes('×ª×™×§×•×Ÿ') || lowerText.includes('×ª×™×§') || lowerText.includes('repair') ||
        lowerText.includes('×¦×‘×¢') || lowerText.includes('paint') || lowerText.includes('×¨×™×ª×•×š')) {
      return 'REPAIR';
    }
    
    return 'OTHER';
  }
  
  // SESSION 76: View invoice PDF in new tab - NO WEBHOOK CALL
  async viewInvoicePDF() {
    try {
      console.log('ğŸ“„ viewInvoicePDF called - NO WEBHOOK WILL BE TRIGGERED');
      
      if (!this.currentDocumentId) {
        this.showAlert('×œ× × ××¦× ××¡××š', 'error');
        return;
      }
      
      console.log('ğŸ” Getting signed URL from Supabase storage for document ID:', this.currentDocumentId);
      console.log('âš ï¸ IMPORTANT: This function ONLY gets a URL, NO webhook call');
      this.showAlert('××™×™×¦×¨ ×§×™×©×•×¨ ×œ×¦×¤×™×™×”...', 'info');
      
      // SESSION 80: This only calls Supabase storage API - NO WEBHOOK
      const url = await this.invoiceService.getInvoiceDocumentURL(this.currentDocumentId);
      console.log('âœ… Got signed URL from Supabase, opening in new tab');
      console.log('ğŸ“ URL source: Supabase Storage (NOT Make.com webhook)');
      window.open(url, '_blank');
      
      this.showAlert('×”×—×©×‘×•× ×™×ª × ×¤×ª×—×” ×‘×—×œ×•×Ÿ ×—×“×©', 'success');
    } catch (error) {
      console.error('âŒ Error viewing PDF:', error);
      console.error('   Document ID was:', this.currentDocumentId);
      
      // SESSION 79: Show more helpful error message
      if (error.message && error.message.includes('storage_path is NULL')) {
        this.showAlert('×”×—×©×‘×•× ×™×ª ×œ× ×”×•×¢×œ×ª×” ×›×¨××•×™ - ×× × ×”×¢×œ×” ×©×•×‘', 'error');
      } else if (error.message && error.message.includes('not found')) {
        this.showAlert('×œ× × ××¦× ××¡××š ×‘×××’×¨', 'error');
      } else {
        this.showAlert(`×©×’×™××”: ${error.message || '×œ× × ×™×ª×Ÿ ×œ×¤×ª×•×— ×—×©×‘×•× ×™×ª'}`, 'error');
      }
    }
  }

  // SESSION 80: Reprocess OCR - sends uploaded file to OCR webhook again
  async reprocessOCR() {
    try {
      if (!this.uploadedFile) {
        this.showAlert('××™×Ÿ ×§×•×‘×¥ × ×˜×¢×Ÿ ×œ×¢×™×‘×•×“ ××—×“×©', 'error');
        return;
      }
      
      if (!confirm('×”×× ×œ×¢×‘×“ ××ª ×”×—×©×‘×•× ×™×ª ××—×“×©? ×¤×¢×•×œ×” ×–×• ×ª×©×›×ª×‘ ××ª ×”×ª×•×¦××•×ª ×”× ×•×›×—×™×•×ª.')) {
        return;
      }
      
      console.log('ğŸ”„ Reprocessing OCR for existing file');
      this.showAlert('×©×•×œ×— ×œ×¢×™×‘×•×“ ××—×“×©...', 'info');
      
      // Call processInvoice to send to OCR webhook again
      await this.processInvoice();
      
      this.showAlert('âœ… ×—×©×‘×•× ×™×ª ×¢×•×‘×“×” ××—×“×©', 'success');
    } catch (error) {
      console.error('âŒ Error reprocessing OCR:', error);
      this.showAlert('×©×’×™××” ×‘×¢×™×‘×•×“ ××—×“×©: ' + error.message, 'error');
    }
  }

  // SESSION 80: Add new line to specific category
  addLineToCategory(categoryType) {
    console.log('â• Adding new line to category:', categoryType);
    
    // Create new empty item with the specified category
    const newItem = {
      code: '',
      name: '',
      description: '',
      quantity: 1,
      unit_price: 0,
      category: categoryType
    };
    
    // Add to ocrResults array
    this.ocrResults.push(newItem);
    
    // Mark as edited
    this.hasUnsavedEdits = true;
    
    // Refresh display
    this.displayOCRResults(this.lastOCRResult);
    
    this.showAlert(`×©×•×¨×” ×—×“×©×” × ×•×¡×¤×” ×œ×§×˜×’×•×¨×™×” ${categoryType}`, 'success');
  }

  // SESSION 77: Old addManualItem removed - replaced with proper table-based manual entry

  removeItem(index) {
    if (confirm('×”×× ×œ××—×•×§ ×¤×¨×™×˜ ×–×”?')) {
      this.ocrResults.splice(index, 1);
      this.displayOCRResults(this.lastOCRResult || {
        items: this.ocrResults,
        total: this.ocrResults.reduce((sum, item) => sum + (item.quantity * item.unit_price), 0)
      });
      this.hasUnsavedEdits = true;
      this.showAlert('×¤×¨×™×˜ ×”×•×¡×¨', 'success');
    }
  }

  // SESSION 79: Save edits back to helper.invoices and Supabase
  // SESSION 80: Extended to save general details changes too
  async saveEditsToHelper() {
    // SESSION 83: Add loading animation to button
    const saveButton = document.querySelector('button[onclick*="saveEditsToHelper"]');
    if (saveButton) {
      saveButton.disabled = true;
      saveButton.style.opacity = '0.6';
      saveButton.innerHTML = 'â³ ×©×•××¨...';
    }
    
    try {
      console.log('ğŸ’¾ Saving edits to helper and Supabase...');
      
      if (!this.hasUnsavedEdits) {
        this.showAlert('××™×Ÿ ×©×™× ×•×™×™× ×œ×©××™×¨×”', 'info');
        if (saveButton) {
          saveButton.disabled = false;
          saveButton.style.opacity = '1';
          saveButton.innerHTML = 'âœï¸ ×©××•×¨ ×¢×¨×™×›×•×ª';
        }
        return;
      }
      
      // SESSION 80: Capture edited general details from input fields
      const editedInvoiceNumber = document.getElementById('edit-invoice-number')?.value;
      const editedCarOwner = document.getElementById('edit-car-owner')?.value;
      const editedPlate = document.getElementById('edit-plate')?.value;
      const editedGarageName = document.getElementById('edit-garage-name')?.value;
      const editedDate = document.getElementById('edit-date')?.value;
      
      // SESSION 80: Capture edited cost totals from input fields
      const parseNum = (value) => {
        if (!value) return 0;
        const num = parseFloat(String(value).replace(/,/g, ''));
        return isNaN(num) ? 0 : num;
      };
      
      const editedPartsTotal = parseNum(document.getElementById('edit-parts-total')?.value);
      const editedWorksTotal = parseNum(document.getElementById('edit-works-total')?.value);
      const editedRepairsTotal = parseNum(document.getElementById('edit-repairs-total')?.value);
      const editedTotalBeforeVAT = parseNum(document.getElementById('edit-total-before-vat')?.value);
      const editedVATPercentage = parseNum(document.getElementById('edit-vat-percentage')?.value);
      const editedVATAmount = parseNum(document.getElementById('edit-vat-amount')?.value);
      const editedTotalWithVAT = parseNum(document.getElementById('edit-total-with-vat')?.value);
      
      // Update lastOCRResult with edited items
      if (this.lastOCRResult) {
        // SESSION 80: Update general details in OCR result
        if (editedInvoiceNumber) this.lastOCRResult['××¡. ×—×©×‘×•× ×™×ª'] = editedInvoiceNumber;
        if (editedCarOwner) this.lastOCRResult['×‘×¢×œ ×”×¨×›×‘'] = editedCarOwner;
        if (editedPlate) this.lastOCRResult['××¡×¤×¨ ×¨×›×‘'] = editedPlate;
        if (editedGarageName) this.lastOCRResult['×©× ××•×¡×š'] = editedGarageName;
        if (editedDate) this.lastOCRResult['×ª××¨×™×š'] = editedDate;
        
        // SESSION 80: Update cost totals in OCR result from edited fields - use single quotes
        this.lastOCRResult['×¡×”×› ×—×œ×§×™×'] = editedPartsTotal.toFixed(2);
        this.lastOCRResult['×¡×”×› ×¢×‘×•×“×•×ª'] = editedWorksTotal.toFixed(2);
        this.lastOCRResult['×¡×”×› ×ª×™×§×•× ×™×'] = editedRepairsTotal.toFixed(2);
        this.lastOCRResult["×¢×œ×•×ª ×›×•×œ×œ×ª ×œ×œ× ××¢'×"] = editedTotalBeforeVAT.toFixed(2);
        this.lastOCRResult["××¢'×"] = editedVATPercentage.toString();
        this.lastOCRResult["×¢×¨×š ××¢'×"] = editedVATAmount.toFixed(2);
        this.lastOCRResult['×¢×œ×•×ª ×›×•×œ×œ×ª'] = editedTotalWithVAT.toFixed(2);
        
        // Rebuild parts, works, repairs arrays from edited ocrResults
        const parts = this.ocrResults.filter(item => item.category === 'PART');
        const works = this.ocrResults.filter(item => item.category === 'WORK');
        const repairs = this.ocrResults.filter(item => item.category === 'REPAIR');
        
        // Map back to Hebrew structure
        this.lastOCRResult['×—×œ×§×™×'] = parts.map(item => ({
          '×©× ×—×œ×§': item.name,
          '×ª×™××•×¨': item.description,
          '×›××•×ª': String(item.quantity),
          '×¢×œ×•×ª': String(item.unit_price)
        }));
        
        this.lastOCRResult['×¢×‘×•×“×•×ª'] = works.map(item => ({
          '×¡×•×’ ×”×¢×‘×•×“×”': item.name,
          '×ª×™××•×¨ ×¢×‘×•×“×•×ª': item.description,
          '×¢×œ×•×ª ×¢×‘×•×“×•×ª': String(item.unit_price)
        }));
        
        this.lastOCRResult['×ª×™×§×•× ×™×'] = repairs.map(item => ({
          '×¡×•×’ ×ª×™×§×•×Ÿ': item.name,
          '×ª×™××•×¨ ×”×ª×™×§×•×Ÿ': item.description,
          '×¢×œ×•×ª ×ª×™×§×•× ×™×': String(item.unit_price)
        }));
        
        // SESSION 82 FIX: DO NOT recalculate totals - use the edited values from fields
        // The user may have manually adjusted the category totals in the UI
        // Totals were already set correctly on lines 2215-2217 from the edit fields
      }
      
      // Update helper.invoices
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      if (helper.invoices && helper.invoices.length > 0) {
        const invoiceNumber = this.lastOCRResult?.['××¡. ×—×©×‘×•× ×™×ª'] || this.lastOCRResult?.invoice_number;
        const invoiceIndex = helper.invoices.findIndex(inv => {
          const invNum = inv['××¡. ×—×©×‘×•× ×™×ª'] || inv.invoice_number;
          return invNum === invoiceNumber;
        });
        
        if (invoiceIndex >= 0) {
          helper.invoices[invoiceIndex] = this.lastOCRResult;
          sessionStorage.setItem('helper', JSON.stringify(helper));
          console.log('âœ… Updated helper.invoices');
        }
      }
      
      // Update Supabase if invoice was saved
      if (this.currentInvoiceId && this.invoiceService) {
        // SESSION 80: Update invoice header fields AND totals in Supabase
        const invoiceUpdate = {};
        
        // Update all general fields
        if (editedInvoiceNumber) invoiceUpdate.invoice_number = editedInvoiceNumber;
        if (editedGarageName) invoiceUpdate.supplier_name = editedGarageName;
        if (editedPlate) invoiceUpdate.plate = editedPlate;
        // NOTE: Date is stored in created_at (auto), not invoice_date
        
        // SESSION 80: Update cost totals - always update these
        invoiceUpdate.total_before_tax = editedTotalBeforeVAT;
        invoiceUpdate.tax_amount = editedVATAmount;
        invoiceUpdate.total_amount = editedTotalWithVAT;
        
        console.log('ğŸ“ Updating Supabase invoice with:', invoiceUpdate);
        
        const { error: updateHeaderError } = await window.supabase
          .from('invoices')
          .update(invoiceUpdate)
          .eq('id', this.currentInvoiceId);
        
        if (updateHeaderError) {
          console.error('âŒ Failed to update invoice header:', updateHeaderError);
          throw updateHeaderError;
        }
        console.log('âœ… Updated Supabase invoice header + totals');
        
        // Update invoice lines - delete old and insert new with edited values
        console.log('ğŸ“ Updating invoice lines, current ocrResults:', this.ocrResults);
        
        // Delete old lines first
        const { error: deleteError } = await window.supabase
          .from('invoice_lines')
          .delete()
          .eq('invoice_id', this.currentInvoiceId);
        
        if (deleteError) {
          console.error('âŒ Failed to delete old invoice lines:', deleteError);
          throw deleteError;
        }
        
        // Build new lines from edited ocrResults
        const linesInsert = this.ocrResults.map((item, index) => {
          const itemCode = item.code || null;
          console.log(`ğŸ’¾ saveEditsToHelper - Saving line ${index + 1}: category="${item.category}", code="${itemCode}", name="${item.name}"`);
          return {
            invoice_id: this.currentInvoiceId,
            line_number: index + 1,
            description: item.name || item.description || '',
            part_id: null, // SESSION 83: part_id is UUID - catalog codes go in metadata only
            quantity: item.quantity || 1,
            unit_price: item.unit_price || 0,
            line_total: (item.quantity || 1) * (item.unit_price || 0),
            discount_percent: 0,
            metadata: {
              category: item.category || 'OTHER',
              unit: '×™×—×™×“×”',
              code: itemCode, // Catalog code stored here for all types
              name: item.name || item.description || ''
            }
          };
        });
        
        console.log('ğŸ“ Inserting updated invoice lines:', linesInsert);
        
        const { error: insertError } = await window.supabase
          .from('invoice_lines')
          .insert(linesInsert);
        
        if (insertError) {
          console.error('âŒ Failed to insert invoice lines:', insertError);
          throw insertError;
        }
        
        console.log('âœ… Updated Supabase invoice_lines');
      }
      
      // SESSION 83: Update OCR data DIRECTLY via Supabase - don't use invoiceService to avoid webhook trigger
      if (this.currentDocumentId && this.lastOCRResult) {
        const { error: ocrUpdateError } = await window.supabase
          .from('invoice_documents')
          .update({ ocr_structured_data: this.lastOCRResult })
          .eq('id', this.currentDocumentId);
        
        if (ocrUpdateError) {
          console.error('âŒ Failed to update OCR data:', ocrUpdateError);
        } else {
          console.log('âœ… Updated invoice_documents.ocr_structured_data');
        }
      }
      
      this.hasUnsavedEdits = false;
      
      // SESSION 83: Success animation
      if (saveButton) {
        saveButton.innerHTML = 'âœ… × ×©××¨!';
        saveButton.style.background = 'rgba(34,197,94,1)';
        setTimeout(() => {
          saveButton.disabled = false;
          saveButton.style.opacity = '1';
          saveButton.innerHTML = 'âœï¸ ×©××•×¨ ×¢×¨×™×›×•×ª';
          saveButton.style.background = 'rgba(34,197,94,0.9)';
        }, 1500);
      }
      
      this.showAlert('âœ… ×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”', 'success');
      
      // SESSION 82: Refresh display to show saved values
      console.log('ğŸ”„ Refreshing display with saved values...');
      this.displayOCRResults(this.lastOCRResult);
      console.log('âœ… Display refreshed');
      
    } catch (error) {
      console.error('âŒ Error saving edits:', error);
      
      // SESSION 83: Error animation
      if (saveButton) {
        saveButton.innerHTML = 'âŒ ×©×’×™××”';
        saveButton.style.background = 'rgba(239,68,68,0.9)';
        setTimeout(() => {
          saveButton.disabled = false;
          saveButton.style.opacity = '1';
          saveButton.innerHTML = 'âœï¸ ×©××•×¨ ×¢×¨×™×›×•×ª';
          saveButton.style.background = 'rgba(34,197,94,0.9)';
        }, 2000);
      }
      
      this.showAlert('âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”×©×™× ×•×™×™×', 'error');
    }
  }

  showValidationStatus(result) {
    const statusContainer = document.getElementById('validation-status');
    let statusType = 'success';
    let message = 'âœ… ×—×©×‘×•× ×™×ª ×¢×•×‘×“×” ×‘×”×¦×œ×—×”';
    
    if (result.warnings && result.warnings.length > 0) {
      statusType = 'warning';
      message = 'âš ï¸ ×—×©×‘×•× ×™×ª ×¢×•×‘×“×” ×¢× ××–×”×¨×•×ª: ' + result.warnings.join(', ');
    }
    
    if (result.errors && result.errors.length > 0) {
      statusType = 'error';
      message = 'âŒ ×©×’×™××•×ª ×‘×¢×™×‘×•×“: ' + result.errors.join(', ');
    }
    
    statusContainer.className = `validation-status ${statusType} show`;
    statusContainer.textContent = message;
    
    // Hide after 5 seconds
    setTimeout(() => {
      statusContainer.classList.remove('show');
    }, 5000);
  }

  async saveResults() {
    if (this.ocrResults.length === 0) {
      this.showAlert('××™×Ÿ ×ª×•×¦××•×ª ×œ×©××™×¨×”', 'warning');
      return;
    }
    
    // Add loading animation to save button
    const saveButton = document.getElementById('save-results');
    saveButton.classList.add('btn-loading');
    const originalText = saveButton.textContent;
    saveButton.textContent = '×©×•××¨...';
    
    try {
      console.log('ğŸ’¾ Saving invoice results...');
      
      const plate = document.getElementById('plate').value;
      const caseId = sessionStorage.getItem('currentCaseId');
      
      // Prepare result data for helper (backward compatibility)
      const resultData = {
        plate: plate,
        owner: document.getElementById('owner').value,
        garage_name: document.getElementById('garage_name').value,
        date: document.getElementById('date').value,
        invoice_type: document.getElementById('invoice-type').value,
        items: this.ocrResults,
        total: this.ocrResults.reduce((sum, item) => sum + (item.quantity * item.unit_price), 0),
        processed_at: new Date().toISOString()
      };
      
      // SESSION 74: Save to Supabase if case ID exists
      if (caseId && this.invoiceService) {
        try {
          // SESSION 79 FIX: Helper function to parse prices with comma separators
          const parsePrice = (value) => {
            if (!value) return null;
            const strValue = String(value).replace(/,/g, ''); // Remove commas
            const parsed = parseFloat(strValue);
            return isNaN(parsed) ? null : parsed;
          };
          
          // SESSION 79 FIX: Use OCR data for invoice header, not form fields
          const ocrResult = this.lastOCRResult || {};
          
          // SESSION 79: Prepare invoice data - match actual schema
          // invoice_type must be: 'PARTS', 'LABOR', 'TOWING', 'OTHER'
          const invoiceData = {
            plate: plate,
            invoice_number: ocrResult['××¡. ×—×©×‘×•× ×™×ª'] || ocrResult.invoice_number || `INV-${Date.now()}`,
            supplier_name: ocrResult['×©× ××•×¡×š'] || document.getElementById('garage_name').value || '×œ× ×¦×•×™×Ÿ',
            supplier_tax_id: ocrResult['×¢×•×¡×§ ××•×¨×©×”'] || null,
            invoice_type: 'OTHER', // Default to OTHER (mixed invoice)
            total_amount: parsePrice(ocrResult['×¢×œ×•×ª ×›×•×œ×œ×ª']) || resultData.total,
            total_before_tax: parsePrice(ocrResult["×¢×œ×•×ª ×›×•×œ×œ×ª ×œ×œ× ××¢'×"]),
            tax_amount: parsePrice(ocrResult["×¢×¨×š ××¢'×"]), // SESSION 79: Use single quote
            status: 'DRAFT'
          };
          
          console.log('ğŸ“‹ Invoice data prepared:', invoiceData);
          
          // Prepare invoice lines
          const lines = this.ocrResults.map((item, index) => {
            const itemCode = item.code || null;
            console.log(`ğŸ’¾ Saving line ${index + 1}: category="${item.category}", code="${itemCode}", name="${item.name}"`);
            return {
              line_number: index + 1,
              description: item.name || item.description || '',
              part_id: null, // SESSION 83: part_id is UUID - catalog codes go in metadata only
              quantity: item.quantity || 1,
              unit_price: item.unit_price || 0,
              line_total: (item.quantity || 1) * (item.unit_price || 0),
              metadata: {
                category: item.category || 'part',
                code: itemCode, // Catalog code stored here for all types
                name: item.name || item.description || ''
              }
            };
          });
          
          // SESSION 82: Check if updating existing invoice or creating new
          const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
          const existingInvoiceId = helper.current_invoice?.invoice_id || this.currentInvoiceId;
          
          let result;
          if (existingInvoiceId) {
            console.log('ğŸ”„ Attempting to update existing invoice:', existingInvoiceId);
            
            // SESSION 82: Verify invoice exists before trying to update
            const { data: existingInvoice, error: checkError } = await window.supabase
              .from('invoices')
              .select('id')
              .eq('id', existingInvoiceId)
              .single();
            
            if (checkError || !existingInvoice) {
              console.warn('âš ï¸ Invoice ID not found in database, creating new instead');
              console.log('â• Creating new invoice (previous ID was invalid)');
              console.log('ğŸ“¦ Case ID:', caseId);
              console.log('ğŸ“¦ Invoice data:', invoiceData);
              console.log('ğŸ“¦ Lines count:', lines.length);
              console.log('ğŸ“¦ InvoiceService currentUser:', this.invoiceService.currentUser);
              
              try {
                result = await this.invoiceService.createInvoice(invoiceData, lines, caseId);
                console.log('âœ… createInvoice returned:', result);
              } catch (createError) {
                console.error('âŒ createInvoice threw error:', createError);
                throw createError;
              }
            } else {
              console.log('âœ… Invoice exists, proceeding with update');
              await this.invoiceService.updateInvoice(existingInvoiceId, invoiceData);
              
              const { data: deleteResult, error: deleteError } = await window.supabase
                .from('invoice_lines')
                .delete()
                .eq('invoice_id', existingInvoiceId);
              
              if (deleteError) console.error('âŒ Error deleting old lines:', deleteError);
              
              const linesInsert = lines.map(line => ({
                ...line,
                invoice_id: existingInvoiceId
              }));
              
              const { data: newLines, error: linesError } = await window.supabase
                .from('invoice_lines')
                .insert(linesInsert)
                .select();
              
              if (linesError) throw linesError;
              
              result = { 
                success: true, 
                invoice: { 
                  id: existingInvoiceId, 
                  lines: newLines 
                } 
              };
              
              console.log('âœ… Invoice updated successfully');
            }
          } else {
            console.log('â• Creating new invoice');
            console.log('ğŸ“¦ Case ID:', caseId);
            console.log('ğŸ“¦ Invoice data:', invoiceData);
            console.log('ğŸ“¦ Lines count:', lines.length);
            console.log('ğŸ“¦ InvoiceService currentUser:', this.invoiceService.currentUser);
            
            try {
              result = await this.invoiceService.createInvoice(invoiceData, lines, caseId);
              console.log('âœ… createInvoice returned:', result);
            } catch (createError) {
              console.error('âŒ createInvoice threw error:', createError);
              throw createError;
            }
          }
          
          if (result && result.success) {
            this.currentInvoiceId = result.invoice.id;
            console.log('âœ… Invoice saved to Supabase:', this.currentInvoiceId);
            
            // SESSION 76: Link document to invoice - UPDATE invoice_documents.invoice_id
            if (this.currentDocumentId) {
              console.log('ğŸ”— Linking document to invoice:', this.currentDocumentId, 'â†’', this.currentInvoiceId);
              
              const { data: updatedDoc, error: linkError } = await window.supabase
                .from('invoice_documents')
                .update({ invoice_id: this.currentInvoiceId })
                .eq('id', this.currentDocumentId)
                .select()
                .single();
              
              if (linkError) {
                console.error('âŒ Failed to link document to invoice:', linkError);
              } else {
                console.log('âœ… Document linked to invoice successfully');
              }
            }
            
            // SESSION 79: Create validation record and send to Drive webhook
            const userId = this.invoiceService?.currentUser?.user_id;
            
            console.log('ğŸ” Webhook check:', {
              userId: userId,
              currentInvoiceId: this.currentInvoiceId,
              currentDocumentId: this.currentDocumentId
            });
            
            if (!userId) {
              console.error('âŒ Cannot send webhook: No user ID');
            }
            if (!this.currentInvoiceId) {
              console.error('âŒ Cannot send webhook: No invoice ID');
            }
            
            if (userId && this.currentInvoiceId) {
              // SESSION 82: Check if validation record exists, then UPDATE or INSERT
              const { data: existingValidation, error: checkError } = await window.supabase
                .from('invoice_validations')
                .select('id')
                .eq('invoice_id', this.currentInvoiceId)
                .single();
              
              if (existingValidation) {
                // Update existing validation
                const { error: validationError } = await window.supabase
                  .from('invoice_validations')
                  .update({
                    reviewed_by: userId,
                    approval_status: 'approved',
                    review_date: new Date().toISOString()
                  })
                  .eq('invoice_id', this.currentInvoiceId);
                
                if (validationError) {
                  console.error('âŒ Failed to update validation:', validationError);
                } else {
                  console.log('âœ… Validation record updated');
                }
              } else {
                // Create new validation
                const { error: validationError } = await window.supabase
                  .from('invoice_validations')
                  .insert({
                    invoice_id: this.currentInvoiceId,
                    reviewed_by: userId,
                    approval_status: 'approved',
                    review_date: new Date().toISOString()
                  });
                
                if (validationError) {
                  console.error('âŒ Failed to create validation:', validationError);
                } else {
                  console.log('âœ… Validation record created');
                }
              }
              
              // Get PDF URL
              let pdfUrl = null;
              if (this.currentDocumentId) {
                try {
                  pdfUrl = await this.invoiceService.getInvoiceDocumentURL(this.currentDocumentId);
                  console.log('âœ… PDF URL generated');
                } catch (pdfError) {
                  console.error('âŒ Failed to get PDF URL:', pdfError);
                }
              } else {
                console.warn('âš ï¸ No document ID, PDF URL will be null');
              }
              
              // Generate case filing ID: YC-PLATE-YEAR
              const year = new Date().getFullYear();
              const caseFilingId = `YC-${plate}-${year}`;
              
              // Send to SAVE_INVOICE_TO_DRIVE webhook
              const webhookPayload = {
                plate: plate,
                case_filing_id: caseFilingId,
                pdf_url: pdfUrl,
                invoice_id: this.currentInvoiceId,
                case_id: caseId,
                invoice_number: invoiceData.invoice_number,
                supplier_name: invoiceData.supplier_name,
                total_amount: invoiceData.total_amount
              };
              
              console.log('ğŸ“¤ Sending to SAVE_INVOICE_TO_DRIVE webhook:', webhookPayload);
              
              try {
                await sendToWebhook('SAVE_INVOICE_TO_DRIVE', webhookPayload);
                console.log('âœ… Invoice sent to Drive successfully');
              } catch (webhookError) {
                console.error('âŒ Webhook error:', webhookError);
                console.error('Webhook error details:', webhookError.message, webhookError.stack);
                this.showAlert('âš ï¸ ×—×©×‘×•× ×™×ª × ×©××¨×” ××š ×©×œ×™×—×” ×œ-Drive × ×›×©×œ×”', 'warning');
              }
            } else {
              console.warn('âš ï¸ Skipping webhook - missing userId or invoiceId');
            }
          }
        } catch (supabaseError) {
          console.error('âŒ Supabase save failed:', supabaseError);
          this.showAlert('âš ï¸ ×—×©×‘×•× ×™×ª × ×©××¨×” ××§×•××™×ª (×©××™×¨×” ×‘×¢× ×Ÿ × ×›×©×œ×”)', 'warning');
        }
      } else {
        console.warn('âš ï¸ No case ID, skipping Supabase save');
      }
      
      // SESSION 79 FIX: Save ORIGINAL OCR data to helper, not rebuilt resultData
      // This preserves all Hebrew fields: ×—×œ×§×™×, ×¢×‘×•×“×•×ª, ×ª×™×§×•× ×™×, etc.
      this.updateHelperWithResults(this.lastOCRResult || resultData);
      
      this.showAlert('âœ… ×—×©×‘×•× ×™×ª × ×©××¨×” ×•× ×©×œ×—×” ×œ-Drive', 'success');
      
      // SESSION 83: Stop spinner and disable save button after first save
      const saveButton = document.getElementById('save-results');
      if (saveButton) {
        saveButton.classList.remove('btn-loading');
        saveButton.disabled = true;
        saveButton.style.opacity = '0.5';
        saveButton.style.cursor = 'not-allowed';
        saveButton.textContent = 'âœ… × ×©××¨';
        saveButton.title = '×”×—×©×‘×•× ×™×ª ×›×‘×¨ × ×©××¨×” - ×”×©×ª××© ×‘"×©××•×¨ ×¢×¨×™×›×•×ª" ×œ×¢×“×›×•×Ÿ';
      }
      
    } catch (error) {
      console.error('Save error:', error);
      this.showAlert('âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”×—×©×‘×•× ×™×ª', 'error');
      
      // Remove loading animation even on error
      const saveButton = document.getElementById('save-results');
      if (saveButton) {
        saveButton.classList.remove('btn-loading');
        saveButton.textContent = originalText;
      }
    }
  }

  updateHelperWithResults(result) {
    try {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      if (!helper.invoices) {
        helper.invoices = [];
      }
      
      // SESSION 80: Prevent duplicates with comprehensive check
      const invoiceNumber = result.invoice_number || result['××¡. ×—×©×‘×•× ×™×ª'] || result.invoiceNumber;
      const plate = result['××¡×¤×¨ ×¨×›×‘'] || result.plate || sessionStorage.getItem('plate');
      const garageName = result['×©× ××•×¡×š'] || result.supplier_name;
      
      // Generate unique invoice entry ID
      const generateUUID = () => {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          const r = Math.random() * 16 | 0;
          const v = c == 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      };
      
      if (invoiceNumber) {
        // Check for duplicates: same invoice_number + plate + garage
        helper.invoices = helper.invoices.filter(inv => {
          const existingInvNum = inv.invoice_number || inv['××¡. ×—×©×‘×•× ×™×ª'] || inv.invoiceNumber;
          const existingPlate = inv['××¡×¤×¨ ×¨×›×‘'] || inv.plate;
          const existingGarage = inv['×©× ××•×¡×š'] || inv.supplier_name;
          
          const isDuplicate = existingInvNum === invoiceNumber && 
                             existingPlate === plate && 
                             existingGarage === garageName;
          
          return !isDuplicate;
        });
        
        console.log(`ğŸ” Checking for duplicate: ${invoiceNumber} / ${plate} / ${garageName}`);
        console.log(`ğŸ“‹ Invoices after duplicate check: ${helper.invoices.length}`);
      }
      
      // SESSION 80: Add invoice with unique entry ID and metadata
      const invoiceData = {
        invoice_entry_id: generateUUID(),
        supabase_invoice_id: this.currentInvoiceId || null,
        entry_timestamp: new Date().toISOString(),
        source: 'ocr_webhook',
        ...result,
        processed_at: new Date().toISOString(),
        invoice_number: invoiceNumber,
        plate: plate,
        supplier_name: garageName
      };
      
      helper.invoices.push(invoiceData);
      
      // Update meta information
      helper.meta = helper.meta || {};
      helper.meta.last_invoice_processed = new Date().toISOString();
      helper.meta.total_invoices = helper.invoices.length;
      
      // Update session storage
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      // SESSION 56: Update via helper system with correct parameters
      if (typeof window.updateHelper === 'function') {
        window.updateHelper('invoices', helper.invoices, 'invoice-upload');
        window.updateHelper('meta', helper.meta, 'invoice-upload');
      }
      
      console.log(`âœ… Invoice ${invoiceNumber} added to helper (total: ${helper.invoices.length})`);
      
    } catch (e) {
      console.warn('Could not update helper with invoice results:', e);
    }
  }

  showProcessingStatus(show) {
    const statusElement = document.getElementById('processing-status');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    
    if (show) {
      statusElement.classList.add('show');
      
      // Simulate progress
      let progress = 0;
      const interval = setInterval(() => {
        progress += 15;
        progressFill.style.width = `${Math.min(progress, 90)}%`;
        
        if (progress >= 30 && progress < 60) {
          progressText.textContent = '××¢×‘×“ OCR...';
        } else if (progress >= 60 && progress < 90) {
          progressText.textContent = '×× ×ª×— ×ª×•×¦××•×ª...';
        }
        
        if (progress >= 90) {
          clearInterval(interval);
          progressText.textContent = '××©×œ×™× ×¢×™×‘×•×“...';
        }
      }, 500);
      
      // Store interval reference for cleanup
      this.progressInterval = interval;
    } else {
      statusElement.classList.remove('show');
      progressFill.style.width = '0%';
      progressText.textContent = '×× × ×”××ª×Ÿ...';
      
      if (this.progressInterval) {
        clearInterval(this.progressInterval);
      }
    }
  }

  // SESSION 80: Complete invoice deletion from all systems
  async deleteInvoiceCompletely() {
    // SESSION 84: Task 3 - Stricter validation to prevent accidental mass deletion
    if (!this.currentInvoiceId) {
      this.showAlert('×©×’×™××”: ×œ× × ××¦× ××–×”×” ×—×©×‘×•× ×™×ª ×œ××—×™×§×”', 'error');
      console.error('âŒ Cannot delete: No currentInvoiceId set');
      return;
    }

    if (!this.currentDocumentId) {
      console.warn('âš ï¸ No document ID, will only delete invoice record');
    }
    
    // Get invoice details for confirmation
    const invoiceNumber = this.lastOCRResult?.['××¡. ×—×©×‘×•× ×™×ª'] || '×œ× ×™×“×•×¢';
    const garageName = this.lastOCRResult?.['×©× ××•×¡×š'] || '×œ× ×™×“×•×¢';
    const totalAmount = this.lastOCRResult?.['×¢×œ×•×ª ×›×•×œ×œ×ª'] || '0';
    
    const confirmMessage = `âš ï¸ ××–×”×¨×”: ×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×”×—×©×‘×•× ×™×ª ×œ×¦××™×ª×•×ª!\n\n×¤×¨×˜×™ ×—×©×‘×•× ×™×ª:\nâ€¢ ××¡×¤×¨: ${invoiceNumber}\nâ€¢ ××•×¡×š: ${garageName}\nâ€¢ ×¡×›×•×: â‚ª${totalAmount}\n\n×”××—×™×§×” ×ª×‘×•×¦×¢ ×:\nâœ“ ×©×¨×ª ×”××¢×¨×›×ª\nâœ“ ×××’×¨ ×”××™×“×¢ ×”××§×•××™\nâœ“ ××—×¡×•×Ÿ ×¢× ×Ÿ\n\n×”×× ××ª×” ×‘×˜×•×—?`;
    
    if (!confirm(confirmMessage)) {
      return;
    }
    
    try {
      console.log('ğŸ—‘ï¸ Starting complete invoice deletion...');
      this.showAlert('××•×—×§ ×—×©×‘×•× ×™×ª...', 'info');
      
      // 1. Delete from ×©×¨×ª (Supabase)
      if (this.currentInvoiceId && this.invoiceService) {
        console.log('ğŸ—‘ï¸ Deleting from ×©×¨×ª:', this.currentInvoiceId);
        await this.invoiceService.deleteInvoice(this.currentInvoiceId);
        console.log('âœ… Deleted from ×©×¨×ª');
      }
      
      // 2. Delete from helper.invoices
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');

        if (helper.invoices && Array.isArray(helper.invoices)) {
          const beforeCount = helper.invoices.length;
          // SESSION 84: Task 3 - Use ONLY invoice ID for precise deletion
          // Previous logic used invoice number too, which could delete multiple invoices
          helper.invoices = helper.invoices.filter(inv => {
            const invId = inv.invoice_id || inv.supabase_invoice_id;
            // Only compare by unique ID, not invoice number (numbers can repeat!)
            return invId !== this.currentInvoiceId;
          });
          
          helper.meta = helper.meta || {};
          helper.meta.total_invoices = helper.invoices.length;
          
          sessionStorage.setItem('helper', JSON.stringify(helper));
          
          if (typeof window.updateHelper === 'function') {
            window.updateHelper('invoices', helper.invoices, 'invoice-delete');
            window.updateHelper('meta', helper.meta, 'invoice-delete');
          }
          
          console.log(`âœ… Removed from helper (${beforeCount} â†’ ${helper.invoices.length})`);
        }
      } catch (e) {
        console.warn('Could not remove from helper:', e);
      }
      
      // 3. Delete from OneDrive via webhook (if document exists)
      if (this.currentDocumentId) {
        try {
          console.log('ğŸ—‘ï¸ Deleting from ××—×¡×•×Ÿ ×¢× ×Ÿ...');
          // Note: Add webhook call here if DELETE_INVOICE_FROM_DRIVE webhook exists
          // For now, just log
          console.log('âš ï¸ OneDrive deletion webhook not yet implemented');
        } catch (e) {
          console.warn('Could not delete from OneDrive:', e);
        }
      }
      
      // 4. Clear UI
      this.clearUIForNewInvoice();
      
      this.showAlert('âœ… ×—×©×‘×•× ×™×ª × ××—×§×” ×œ×¦××™×ª×•×ª ××›×œ ×”××¢×¨×›×•×ª', 'success');
      
    } catch (error) {
      console.error('âŒ Error deleting invoice:', error);
      this.showAlert('×©×’×™××” ×‘××—×™×§×ª ×—×©×‘×•× ×™×ª: ' + error.message, 'error');
    }
  }
  
  // SESSION 80: Clear UI only - prepare for new invoice without deleting data
  clearUIForNewInvoice() {
    console.log('ğŸ”„ Clearing UI for new invoice (data preserved)');
    
    // Clear form fields (except car info)
    const form = document.getElementById('invoice-form');
    if (form) {
      // Save car info
      const plate = document.getElementById('plate')?.value;
      const owner = document.getElementById('owner')?.value;
      const garageName = document.getElementById('garage_name')?.value;
      
      form.reset();
      
      // Restore car info
      if (plate) document.getElementById('plate').value = plate;
      if (owner) document.getElementById('owner').value = owner;
      if (garageName) document.getElementById('garage_name').value = garageName;
    }
    
    // Clear internal state
    this.uploadedFile = null;
    this.ocrResults = [];
    this.lastOCRResult = null;
    this.currentDocumentId = null;
    this.currentInvoiceId = null;
    this.hasUnsavedEdits = false;
    
    // Hide sections
    document.getElementById('preview-container').style.display = 'none';
    document.getElementById('ocr-results').classList.remove('show');
    document.getElementById('validation-status').classList.remove('show');
    document.getElementById('save-results').style.display = 'none';
    
    // SESSION 80: Hide delete and clear buttons
    document.getElementById('delete-invoice').style.display = 'none';
    document.getElementById('clear-ui').style.display = 'none';
    
    // Clear manual tables
    document.getElementById('manual-parts-body').innerHTML = '';
    document.getElementById('manual-works-body').innerHTML = '';
    document.getElementById('manual-repairs-body').innerHTML = '';
    
    // Reset row counters
    this.manualRowCounters = { parts: 0, works: 0, repairs: 0 };
    
    // Reload case data
    this.loadCaseData();
    
    this.showAlert('××¡×š × ×•×§×” - ××•×›×Ÿ ×œ×—×©×‘×•× ×™×ª ×—×“×©×”', 'success');
  }

  showAlert(message, type = 'info') {
    const container = document.getElementById('alerts-container');
    const alert = document.createElement('div');
    alert.className = `alert ${type} show`;
    alert.textContent = message;
    
    container.appendChild(alert);
    
    setTimeout(() => {
      alert.remove();
    }, 5000);
  }

  // SESSION 77: Manual Invoice Entry Functions
  manualRowCounters = { parts: 0, works: 0, repairs: 0 };

  addManualPartRow() {
    const rowId = `manual-part-${++this.manualRowCounters.parts}`;
    const tbody = document.getElementById('manual-parts-body');
    const row = document.createElement('tr');
    row.dataset.rowId = rowId;
    row.style.background = '#64748b';
    
    row.innerHTML = `
      <td style="padding: 4px;"><input type="text" placeholder="××§×´×˜" style="width: 100%; padding: 4px; font-size: 11px; border: 1px solid #94a3b8; border-radius: 3px;" /></td>
      <td style="padding: 4px; position: relative;">
        <input type="text"
               placeholder="×©× ×—×œ×§"
               class="manual-part-name"
               oninput="showManualPartSuggestions(this)"
               onfocus="showManualPartSuggestions(this)"
               onblur="hideManualPartSuggestions(this)"
               style="width: 100%; padding: 4px; font-size: 11px; border: 1px solid #94a3b8; border-radius: 3px;" />
        <div class="manual-part-dropdown" style="display: none; position: absolute; top: 100%; right: 0; left: 0; background: white; border: 1px solid #94a3b8; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
      </td>
      <td style="padding: 4px;"><input type="text" placeholder="×ª×™××•×¨" style="width: 100%; padding: 4px; font-size: 11px; border: 1px solid #94a3b8; border-radius: 3px;" /></td>
      <td style="padding: 4px;"><input type="number" value="1" min="1" class="manual-qty" style="width: 100%; padding: 4px; font-size: 11px; border: 1px solid #94a3b8; border-radius: 3px; text-align: center;" /></td>
      <td style="padding: 4px;">
        <select style="width: 100%; padding: 4px; font-size: 11px; border: 1px solid #94a3b8; border-radius: 3px;">
          <option value="××§×•×¨×™">××§×•×¨×™</option>
          <option value="×ª×—×œ×™×¤×™">×ª×—×œ×™×¤×™</option>
          <option value="××—×¨">××—×¨</option>
        </select>
      </td>
      <td style="padding: 4px;"><input type="number" step="0.01" placeholder="0.00" class="manual-price" style="width: 100%; padding: 4px; font-size: 11px; border: 1px solid #94a3b8; border-radius: 3px; text-align: left;" /></td>
      <td style="padding: 4px; text-align: center;"><button type="button" onclick="window.invoiceProcessor.removeManualRow('${rowId}')" style="padding: 4px 8px; font-size: 10px; background: #dc2626; color: white; border: none; border-radius: 3px; cursor: pointer;">×”×¡×¨</button></td>
    `;
    
    tbody.appendChild(row);
    row.querySelectorAll('.manual-qty, .manual-price').forEach(input => {
      input.addEventListener('input', () => this.recalculateManualTotals());
    });
  }

  addManualWorkRow() {
    const rowId = `manual-work-${++this.manualRowCounters.works}`;
    const tbody = document.getElementById('manual-works-body');
    const row = document.createElement('tr');
    row.dataset.rowId = rowId;
    row.style.background = '#64748b';
    
    row.innerHTML = `
      <td style="padding: 4px;"><input type="text" placeholder="×§×•×“" style="width: 100%; padding: 4px; font-size: 11px; border: 1px solid #94a3b8; border-radius: 3px;" /></td>
      <td colspan="2" style="padding: 4px;"><input type="text" placeholder="×ª×™××•×¨ ×¢×‘×•×“×•×ª" style="width: 100%; padding: 4px; font-size: 11px; border: 1px solid #94a3b8; border-radius: 3px;" /></td>
      <td style="padding: 4px;"><input type="number" step="0.01" placeholder="0.00" class="manual-price" style="width: 100%; padding: 4px; font-size: 11px; border: 1px solid #94a3b8; border-radius: 3px; text-align: left;" /></td>
      <td style="padding: 4px; text-align: center;"><button type="button" onclick="window.invoiceProcessor.removeManualRow('${rowId}')" style="padding: 4px 8px; font-size: 10px; background: #dc2626; color: white; border: none; border-radius: 3px; cursor: pointer;">×”×¡×¨</button></td>
    `;
    
    tbody.appendChild(row);
    row.querySelectorAll('.manual-price').forEach(input => {
      input.addEventListener('input', () => this.recalculateManualTotals());
    });
  }

  addManualRepairRow() {
    const rowId = `manual-repair-${++this.manualRowCounters.repairs}`;
    const tbody = document.getElementById('manual-repairs-body');
    const row = document.createElement('tr');
    row.dataset.rowId = rowId;
    row.style.background = '#64748b';
    
    row.innerHTML = `
      <td style="padding: 4px;"><input type="text" placeholder="×¡×•×’" style="width: 100%; padding: 4px; font-size: 11px; border: 1px solid #94a3b8; border-radius: 3px;" /></td>
      <td colspan="2" style="padding: 4px;"><input type="text" placeholder="×ª×™××•×¨ ×”×ª×™×§×•×Ÿ" style="width: 100%; padding: 4px; font-size: 11px; border: 1px solid #94a3b8; border-radius: 3px;" /></td>
      <td style="padding: 4px;"><input type="number" step="0.01" placeholder="0.00" class="manual-price" style="width: 100%; padding: 4px; font-size: 11px; border: 1px solid #94a3b8; border-radius: 3px; text-align: left;" /></td>
      <td style="padding: 4px; text-align: center;"><button type="button" onclick="window.invoiceProcessor.removeManualRow('${rowId}')" style="padding: 4px 8px; font-size: 10px; background: #dc2626; color: white; border: none; border-radius: 3px; cursor: pointer;">×”×¡×¨</button></td>
    `;
    
    tbody.appendChild(row);
    row.querySelectorAll('.manual-price').forEach(input => {
      input.addEventListener('input', () => this.recalculateManualTotals());
    });
  }

  removeManualRow(rowId) {
    const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
    if (row && confirm('×”×× ×œ××—×•×§ ×©×•×¨×” ×–×•?')) {
      row.remove();
      this.recalculateManualTotals();
    }
  }

  recalculateManualTotals() {
    // Calculate parts total
    let partsTotal = 0;
    document.querySelectorAll('#manual-parts-body tr').forEach(row => {
      const qty = parseFloat(row.querySelector('.manual-qty')?.value) || 0;
      const price = parseFloat(row.querySelector('.manual-price')?.value) || 0;
      partsTotal += qty * price;
    });
    
    // Calculate works total
    let worksTotal = 0;
    document.querySelectorAll('#manual-works-body tr').forEach(row => {
      const price = parseFloat(row.querySelector('.manual-price')?.value) || 0;
      worksTotal += price;
    });
    
    // Calculate repairs total
    let repairsTotal = 0;
    document.querySelectorAll('#manual-repairs-body tr').forEach(row => {
      const price = parseFloat(row.querySelector('.manual-price')?.value) || 0;
      repairsTotal += price;
    });
    
    // Update category totals
    document.getElementById('manual-parts-total').textContent = `â‚ª${partsTotal.toLocaleString('he-IL', {minimumFractionDigits: 2})}`;
    document.getElementById('manual-works-total').textContent = `â‚ª${worksTotal.toLocaleString('he-IL', {minimumFractionDigits: 2})}`;
    document.getElementById('manual-repairs-total').textContent = `â‚ª${repairsTotal.toLocaleString('he-IL', {minimumFractionDigits: 2})}`;
    
    // Calculate grand totals
    const subtotal = partsTotal + worksTotal + repairsTotal;
    const vatPercent = parseFloat(document.getElementById('manual-vat-percent')?.value) || 0;
    const vatAmount = subtotal * (vatPercent / 100);
    const grandTotal = subtotal + vatAmount;
    
    document.getElementById('manual-subtotal').textContent = `â‚ª${subtotal.toLocaleString('he-IL', {minimumFractionDigits: 2})}`;
    document.getElementById('manual-vat-amount').textContent = `â‚ª${vatAmount.toLocaleString('he-IL', {minimumFractionDigits: 2})}`;
    document.getElementById('manual-grand-total').textContent = `â‚ª${grandTotal.toLocaleString('he-IL', {minimumFractionDigits: 2})}`;
  }

  async saveManualInvoice() {
    console.log('ğŸ’¾ SESSION 87: saveManualInvoice called!');
    console.log('ğŸ’¾ Saving manual invoice...');
    
    // SESSION 77: Validate required fields
    const requiredFields = [
      { id: 'manual-car-owner', label: '×‘×¢×œ ×”×¨×›×‘' },
      { id: 'manual-invoice-number', label: '××¡. ×—×©×‘×•× ×™×ª' },
      { id: 'manual-date', label: '×ª××¨×™×š' },
      { id: 'manual-garage-name', label: '×©× ××•×¡×š' },
      { id: 'manual-garage-phone', label: '×˜×œ×¤×•×Ÿ ××•×¡×š' }
    ];
    
    const missing = [];
    requiredFields.forEach(field => {
      const input = document.getElementById(field.id);
      if (!input.value.trim()) {
        missing.push(field.label);
        input.style.border = '2px solid #dc2626';
      } else {
        input.style.border = '1px solid #cbd5e1';
      }
    });
    
    if (missing.length > 0) {
      this.showAlert(`âŒ ×©×“×•×ª ×—×•×‘×” ×—×¡×¨×™×: ${missing.join(', ')}`, 'error');
      return;
    }
    
    // Collect data from manual entry tables
    const parts = [];
    document.querySelectorAll('#manual-parts-body tr').forEach(row => {
      const inputs = row.querySelectorAll('input, select');
      parts.push({
        "××§\"×˜ ×—×œ×§": inputs[0].value,
        "×©× ×—×œ×§": inputs[1].value,
        "×ª×™××•×¨": inputs[2].value,
        "×›××•×ª": inputs[3].value,
        "××§×•×¨": inputs[4].value,
        "×¢×œ×•×ª": (parseFloat(inputs[3].value) * parseFloat(inputs[5].value)).toFixed(2)
      });
    });
    
    const works = [];
    document.querySelectorAll('#manual-works-body tr').forEach(row => {
      const inputs = row.querySelectorAll('input');
      works.push({
        "×¡×•×’ ×”×¢×‘×•×“×”": inputs[0].value,
        "×ª×™××•×¨ ×¢×‘×•×“×•×ª": inputs[1].value,
        "×¢×œ×•×ª ×¢×‘×•×“×•×ª": parseFloat(inputs[2].value).toFixed(2)
      });
    });
    
    const repairs = [];
    document.querySelectorAll('#manual-repairs-body tr').forEach(row => {
      const inputs = row.querySelectorAll('input');
      repairs.push({
        "×¡×•×’ ×ª×™×§×•×Ÿ": inputs[0].value,
        "×ª×™××•×¨ ×”×ª×™×§×•×Ÿ": inputs[1].value,
        "×¢×œ×•×ª ×ª×™×§×•× ×™×": parseFloat(inputs[2].value).toFixed(2)
      });
    });
    
    // SESSION 77: Collect ALL fixed field data
    const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
    const caseId = helper.case_id;
    
    const subtotal = parseFloat(document.getElementById('manual-subtotal').textContent.replace(/[^\d.-]/g, ''));
    const vatPercent = parseFloat(document.getElementById('manual-vat-percent').value);
    const vatAmount = parseFloat(document.getElementById('manual-vat-amount').textContent.replace(/[^\d.-]/g, ''));
    const grandTotal = parseFloat(document.getElementById('manual-grand-total').textContent.replace(/[^\d.-]/g, ''));
    
    // Build invoice data matching OCR structure EXACTLY
    const invoiceData = {
      "××¡×¤×¨ ×¨×›×‘": document.getElementById('manual-vehicle-plate')?.value || '',
      "×™×¦×¨×Ÿ": document.getElementById('manual-manufacturer')?.value || '',
      "×“×’×": document.getElementById('manual-model')?.value || '',
      "×©× ×ª ×™×™×¦×•×¨": document.getElementById('manual-production-year')?.value || '',
      "××“ ××•×¥": document.getElementById('manual-odometer')?.value || '',
      "×‘×¢×œ ×”×¨×›×‘": document.getElementById('manual-car-owner').value,
      "××¡×¤×¨ ×ª×™×§": document.getElementById('manual-file-number')?.value || '',
      "×ª××¨×™×š": document.getElementById('manual-date').value,
      "××¡. ×—×©×‘×•× ×™×ª": document.getElementById('manual-invoice-number').value,
      "×©× ××•×¡×š": document.getElementById('manual-garage-name').value,
      "×“×•×\"×œ ××•×¡×š": document.getElementById('manual-garage-email')?.value || '',
      "×˜×œ×¤×•×Ÿ ××•×¡×š": document.getElementById('manual-garage-phone').value,
      "×›×ª×•×‘×ª ××•×¡×š": document.getElementById('manual-garage-address')?.value || '',
      "××•×§×“ × ×–×§": document.getElementById('manual-damage-area')?.value || '',
      "×”×¢×¨×•×ª": document.getElementById('manual-notes')?.value || '',
      "×—.×¤.": document.getElementById('manual-company-number')?.value || '',
      "×—×œ×§×™×": parts,
      "×¢×‘×•×“×•×ª": works,
      "×ª×™×§×•× ×™×": repairs,
      "×¡×”×› ×—×œ×§×™×": parts.reduce((sum, p) => sum + parseFloat(p.×¢×œ×•×ª), 0).toFixed(2),
      "×¡×”×› ×¢×‘×•×“×•×ª": works.reduce((sum, w) => sum + parseFloat(w['×¢×œ×•×ª ×¢×‘×•×“×•×ª']), 0).toFixed(2),
      "×¡×”×› ×ª×™×§×•× ×™×": repairs.reduce((sum, r) => sum + parseFloat(r['×¢×œ×•×ª ×ª×™×§×•× ×™×']), 0).toFixed(2),
      "×¢×œ×•×ª ×›×•×œ×œ×ª ×œ×œ× ××¢×´×": subtotal.toFixed(2),
      "××¢\"×": vatPercent + "%",
      "×¢×¨×š ××¢\"×": vatAmount.toFixed(2),
      "×¢×œ×•×ª ×›×•×œ×œ×ª": grandTotal.toFixed(2),
      "×œ×™× ×§": "",
      "source": "manual_input",
      "processed_at": new Date().toISOString()
    };
    
    // SESSION 80: Save to helper with unique ID and duplicate check
    if (!helper.invoices) helper.invoices = [];
    
    // Generate unique UUID
    const generateUUID = () => {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    };
    
    // Check for duplicates
    const invoiceNumber = invoiceData['××¡. ×—×©×‘×•× ×™×ª'];
    const plate = invoiceData['××¡×¤×¨ ×¨×›×‘'];
    const garageName = invoiceData['×©× ××•×¡×š'];
    
    if (invoiceNumber) {
      helper.invoices = helper.invoices.filter(inv => {
        const existingInvNum = inv['××¡. ×—×©×‘×•× ×™×ª'] || inv.invoice_number;
        const existingPlate = inv['××¡×¤×¨ ×¨×›×‘'] || inv.plate;
        const existingGarage = inv['×©× ××•×¡×š'] || inv.supplier_name;
        
        const isDuplicate = existingInvNum === invoiceNumber && 
                           existingPlate === plate && 
                           existingGarage === garageName;
        
        return !isDuplicate;
      });
      
      console.log(`ğŸ” Manual invoice duplicate check: ${invoiceNumber} / ${plate} / ${garageName}`);
    }
    
    // Add unique metadata
    invoiceData.invoice_entry_id = generateUUID();
    invoiceData.entry_timestamp = new Date().toISOString();
    invoiceData.invoice_number = invoiceNumber;
    invoiceData.plate = plate;
    invoiceData.supplier_name = garageName;
    
    helper.invoices.push(invoiceData);
    
    // Update meta
    helper.meta = helper.meta || {};
    helper.meta.total_invoices = helper.invoices.length;
    helper.meta.last_invoice_processed = new Date().toISOString();
    
    sessionStorage.setItem('helper', JSON.stringify(helper));
    
    if (typeof window.updateHelper === 'function') {
      window.updateHelper('invoices', helper.invoices, 'manual-invoice');
      window.updateHelper('meta', helper.meta, 'manual-invoice');
    }
    
    console.log(`âœ… Manual invoice saved to helper (total: ${helper.invoices.length})`);

    // SESSION 87: Save to Supabase (always, not just when case exists)
    if (window.supabase) {
      try {
        // SESSION 87: Get user name for tracking
        const userName = window.getUserName();

        // STEP 1: Save to invoices table
        const invoiceInsert = {
          case_id: caseId,
          plate: invoiceData['××¡×¤×¨ ×¨×›×‘'],
          invoice_number: invoiceData['××¡. ×—×©×‘×•× ×™×ª'],
          invoice_type: 'PARTS',
          supplier_name: invoiceData['×©× ××•×¡×š'],
          status: 'DRAFT',
          total_before_tax: subtotal,
          tax_amount: vatAmount,
          total_amount: grandTotal
        };

        console.log('ğŸ’¾ SESSION 87: Inserting to invoices table:', invoiceInsert);
        const { data: invoice, error: invoiceError } = await window.supabase
          .from('invoices')
          .insert(invoiceInsert)
          .select()
          .single();

        if (invoiceError) throw invoiceError;
        console.log('âœ… SESSION 87: Manual invoice saved to invoices table:', invoice.id);

        // STEP 2: Save to invoice_documents table (match OCR structure)
        const documentInsert = {
          case_id: caseId,
          plate: invoiceData['××¡×¤×¨ ×¨×›×‘'],
          storage_url: null,  // No physical PDF yet (will be generated in STEP 4)
          source: 'manual_input',
          ocr_structured_data: invoiceData,  // Store manual data as if from OCR
          ocr_status: 'manual',
          created_at: new Date().toISOString()
        };

        const { data: document, error: documentError } = await window.supabase
          .from('invoice_documents')
          .insert(documentInsert)
          .select()
          .single();

        if (documentError) throw documentError;
        console.log('âœ… SESSION 87: Manual invoice saved to invoice_documents:', document.id);

        // Link invoice to document
        await window.supabase
          .from('invoices')
          .update({ document_id: document.id })
          .eq('id', invoice.id);

        // STEP 3: Save to invoice_lines table
        const lineItems = [];
        let lineNumber = 0;

        // Add parts as line items
        parts.forEach(part => {
          lineNumber++;
          lineItems.push({
            invoice_id: invoice.id,
            line_number: lineNumber,
            description: `${part['×©× ×—×œ×§']} - ${part['×ª×™××•×¨']}`,
            quantity: parseFloat(part['×›××•×ª']) || 1,
            unit_price: parseFloat(part['×¢×œ×•×ª']) / (parseFloat(part['×›××•×ª']) || 1),
            line_total: parseFloat(part['×¢×œ×•×ª']),
            metadata: {
              category: 'part',
              code: part['××§"×˜ ×—×œ×§'],
              name: part['×©× ×—×œ×§'],
              source: part['××§×•×¨']
            }
          });
        });

        // Add works as line items
        works.forEach(work => {
          lineNumber++;
          lineItems.push({
            invoice_id: invoice.id,
            line_number: lineNumber,
            description: work['×ª×™××•×¨ ×¢×‘×•×“×•×ª'],
            quantity: 1,
            unit_price: parseFloat(work['×¢×œ×•×ª ×¢×‘×•×“×•×ª']),
            line_total: parseFloat(work['×¢×œ×•×ª ×¢×‘×•×“×•×ª']),
            metadata: {
              category: 'work',
              code: work['×¡×•×’ ×”×¢×‘×•×“×”']
            }
          });
        });

        // Add repairs as line items
        repairs.forEach(repair => {
          lineNumber++;
          lineItems.push({
            invoice_id: invoice.id,
            line_number: lineNumber,
            description: repair['×ª×™××•×¨ ×”×ª×™×§×•×Ÿ'],
            quantity: 1,
            unit_price: parseFloat(repair['×¢×œ×•×ª ×ª×™×§×•× ×™×']),
            line_total: parseFloat(repair['×¢×œ×•×ª ×ª×™×§×•× ×™×']),
            metadata: {
              category: 'repair',
              code: repair['×¡×•×’ ×ª×™×§×•×Ÿ']
            }
          });
        });

        // Insert all line items
        if (lineItems.length > 0) {
          const { error: linesError } = await window.supabase
            .from('invoice_lines')
            .insert(lineItems);

          if (linesError) throw linesError;
          console.log(`âœ… SESSION 87: Saved ${lineItems.length} line items to invoice_lines`);
        }

        // STEP 4: Generate PDF with watermark
        if (document.id) {
          console.log('ğŸ“„ SESSION 87: Generating PDF with watermark...');
          const pdfUrl = await window.generateManualInvoicePDF(invoiceData, document.id);
          if (pdfUrl) {
            console.log('âœ… SESSION 87: Manual invoice PDF available at:', pdfUrl);
          } else {
            console.warn('âš ï¸ SESSION 87: PDF generation failed, but invoice saved successfully');
          }
        }

        // SESSION 80: Update helper with ×©×¨×ª ID
        invoiceData.supabase_invoice_id = invoice.id;
        const helperUpdated = JSON.parse(sessionStorage.getItem('helper') || '{}');
        const invoiceIndex = helperUpdated.invoices.findIndex(inv => inv.invoice_entry_id === invoiceData.invoice_entry_id);
        if (invoiceIndex >= 0) {
          helperUpdated.invoices[invoiceIndex].supabase_invoice_id = invoice.id;
          helperUpdated.invoices[invoiceIndex].document_id = document.id;
          sessionStorage.setItem('helper', JSON.stringify(helperUpdated));
        }

        // SESSION 87: Success message
        this.showAlert(`âœ… ×—×©×‘×•× ×™×ª ×™×“× ×™×ª × ×©××¨×” ×‘×”×¦×œ×—×” (${lineItems.length} ×¤×¨×™×˜×™×)`, 'success');
      } catch (error) {
        console.error('âŒ Failed to save manual invoice:', error);
        this.showAlert('âš ï¸ × ×©××¨ ×œ-helper ××‘×œ ×©×’×™××” ×‘×©××™×¨×” ×œ××¡×“ × ×ª×•× ×™×', 'warning');
      }
    } else {
      this.showAlert('âœ… ×—×©×‘×•× ×™×ª ×™×“× ×™×ª × ×©××¨×” ×œ-helper', 'success');
    }
  }
}

// Global functions
window.logout = function() {
  sessionStorage.clear();
  window.location.href = 'index.html';
};

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  // Auth check
  const auth = sessionStorage.getItem("auth");
  if (!auth) {
    alert("×”×’×™×©×” ×—×¡×•××” - ×× × ×”×ª×—×‘×¨ ×“×¨×š ×“×£ ×”×‘×™×ª");
    window.location.href = "index.html";
    return;
  }

  // SESSION 79: Initialize invoiceService with current user from auth
  try {
    const authData = JSON.parse(auth);
    if (window.invoiceService) {
      // SESSION 79 FIX: Auth structure is { session: { user: {...} } } OR { user: {...}, profile: {...} }
      // Need to handle both cases for backward compatibility
      const user = authData.session?.user || authData.user;
      const profile = authData.profile;
      
      if (user) {
        window.invoiceService.currentUser = {
          user_id: profile?.user_id || user.id,
          email: profile?.email || user.email,
          full_name: profile?.full_name || user.user_metadata?.full_name || user.email,
          role: profile?.role || user.user_metadata?.role || 'user'
        };
        console.log('âœ… InvoiceService initialized with user:', window.invoiceService.currentUser.email);
        console.log('   User ID:', window.invoiceService.currentUser.user_id);
      } else {
        console.error('âŒ No user found in auth data:', authData);
      }
    } else {
      console.error('âŒ window.invoiceService not available');
    }
  } catch (error) {
    console.error('âŒ Failed to initialize invoiceService with user:', error);
    console.error('   Auth data:', auth);
  }

  // Initialize invoice processor
  window.invoiceProcessor = new InvoiceProcessor();
  console.log('âœ… SESSION 87: InvoiceProcessor initialized:', window.invoiceProcessor);
  console.log('âœ… SESSION 87: saveManualInvoice method exists:', typeof window.invoiceProcessor.saveManualInvoice);

  // SESSION 82: Initialize InvoiceService to ensure currentUser is set
  async function initializeInvoiceService() {
    if (window.invoiceService) {
      try {
        await window.invoiceService.initialize();
        console.log('âœ… InvoiceService initialized with user:', window.invoiceService.currentUser?.email);
      } catch (error) {
        console.error('âŒ Failed to initialize InvoiceService:', error);
        console.warn('âš ï¸ Invoice saving may fail - user authentication required');
      }
    } else {
      console.error('âŒ window.invoiceService not available');
    }
  }
  
  initializeInvoiceService();
  
  // ENHANCED: Auto-populate vehicle data from helper
  function populateVehicleDataFromHelper() {
    console.log('ğŸ§¾ Invoice Upload: Auto-populating vehicle data from helper...');
    
    try {
      const helperString = sessionStorage.getItem('helper');
      if (helperString) {
        const helper = JSON.parse(helperString);
        console.log('âœ… Helper data loaded for invoice upload:', helper);
        
        // Populate basic fields
        const fieldMappings = {
          'plate': helper.vehicle?.plate || helper.meta?.plate,
          'owner': helper.stakeholders?.owner?.name
        };
        
        // Apply the mappings
        Object.entries(fieldMappings).forEach(([fieldId, value]) => {
          const element = document.getElementById(fieldId);
          if (element && value) {
            element.value = value;
            console.log(`  âœ… ${fieldId}: "${value}"`);
          }
        });
        
        console.log('âœ… Invoice upload auto-population completed');
      } else {
        console.log('âš ï¸ No helper data found in sessionStorage');
      }
    } catch (error) {
      console.error('âŒ Error auto-populating invoice upload vehicle data:', error);
    }
  }
  
  // Auto-populate on page load
  populateVehicleDataFromHelper();
  
  // SESSION 76: Expose toggleManualSection globally
  window.toggleManualSection = function() {
    const content = document.getElementById('manual-section-content');
    const icon = document.getElementById('manual-toggle-icon');
    
    if (content.style.display === 'none') {
      content.style.display = 'block';
      icon.textContent = 'â–²';
    } else {
      content.style.display = 'none';
      icon.textContent = 'â–¼';
    }
  };
});

// SESSION 87: Expose autocomplete functions globally for inline event handlers
window.showManualPartSuggestions = showManualPartSuggestions;
window.hideManualPartSuggestions = hideManualPartSuggestions;
window.selectManualPartSuggestion = selectManualPartSuggestion;
window.getUserName = getUserName;  // SESSION 87: Expose for saveManualInvoice
window.generateManualInvoicePDF = generateManualInvoicePDF;  // SESSION 87: Expose for PDF generation

</script>
<script src="password-prefill.js"></script>

</body>
</html>