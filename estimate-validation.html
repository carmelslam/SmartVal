<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>אימות אומדן - ירון כיוף שמאות</title>
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  
  <!-- OneSignal Push -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">

  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "3b924b99-c302-4919-a97e-baf909394696",
      });
    });
  </script>

  <style>
    body {
      font-family: sans-serif;
      background: #f3f6fb;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      max-width: 1000px;
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      width: 100%;
    }
    .logo img {
      width: 120px;
      margin-bottom: 20px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .title {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 5px;
      color: #1e3a8a;
    }
    .subtitle {
      font-size: 18px;
      color: #64748b;
      text-align: center;
      margin-bottom: 30px;
    }
    h1 {
      font-size: 22px;
      color: #1e3a8a;
      text-align: center;
      margin-bottom: 30px;
    }
    .validation-section {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }
    .validation-section.completed {
      border-color: #16a34a;
      background: #f0fdf4;
    }
    .validation-section.current {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    .validation-section.error {
      border-color: #dc2626;
      background: #fef2f2;
    }
    .validation-section.warning {
      border-color: #f59e0b;
      background: #fefbf2;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .section-title {
      font-size: 18px;
      font-weight: bold;
      color: #1e3a8a;
    }
    .section-status {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }
    .status-current {
      background: #dbeafe;
      color: #1d4ed8;
    }
    .status-completed {
      background: #dcfce7;
      color: #166534;
    }
    .status-error {
      background: #fecaca;
      color: #991b1b;
    }
    .status-warning {
      background: #fef3c7;
      color: #92400e;
    }
    .section-content {
      color: #475569;
      line-height: 1.6;
    }
    .validation-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #e2e8f0;
    }
    .validation-item:last-child {
      border-bottom: none;
    }
    .validation-label {
      font-weight: 500;
      color: #374151;
      flex: 1;
    }
    .validation-value {
      font-weight: 600;
      color: #1e3a8a;
    }
    .validation-status {
      font-size: 18px;
    }
    
    /* Enhanced 3-Column Validation Display */
    .validation-item-enhanced {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 15px;
      padding: 15px 0;
      border-bottom: 1px solid #e2e8f0;
      align-items: center;
    }
    .validation-item-enhanced:last-child {
      border-bottom: none;
    }
    .validation-columns {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
      align-items: center;
    }
    
    /* Enhanced 5-Column Validation Display for Levi/Financial sections */
    .validation-item-financial {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr auto;
      gap: 10px;
      padding: 15px 0;
      border-bottom: 1px solid #e2e8f0;
      align-items: center;
    }
    .validation-item-financial:last-child {
      border-bottom: none;
    }
    .financial-field-name {
      font-weight: 500;
      color: #374151;
    }
    .financial-calculation {
      font-size: 12px;
      color: #64748b;
      text-align: center;
      padding: 6px 8px;
      background: #f8fafc;
      border-radius: 4px;
      border: 1px solid #e2e8f0;
    }
    .current-value {
      font-weight: 600;
      color: #1e3a8a;
      padding: 8px 12px;
      background: #f0f9ff;
      border-radius: 6px;
      border: 1px solid #bae6fd;
    }
    .stored-value {
      font-weight: 500;
      color: #64748b;
      padding: 8px 12px;
      background: #f8fafc;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
      font-size: 14px;
    }
    .action-buttons {
      display: flex;
      gap: 5px;
    }
    .action-buttons button {
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .edit-inline {
      background: #3b82f6;
      color: white;
    }
    .edit-inline:hover {
      background: #1e40af;
    }
    .edit-builder {
      background: #64748b;
      color: white;
    }
    .edit-builder:hover {
      background: #475569;
    }
    .ignore {
      background: #f59e0b;
      color: white;
    }
    .ignore:hover {
      background: #d97706;
    }
    
    /* Data consistency indicators */
    .data-match {
      border-color: #16a34a !important;
      background: #f0fdf4 !important;
    }
    .data-warning {
      border-color: #f59e0b !important;
      background: #fefbf2 !important;
    }
    .data-error {
      border-color: #dc2626 !important;
      background: #fef2f2 !important;
    }
    
    /* Inline editing styles */
    .inline-edit-input {
      width: 100%;
      padding: 8px 12px;
      border: 2px solid #3b82f6;
      border-radius: 6px;
      font-weight: 600;
      color: #1e3a8a;
      background: white;
    }
    .inline-edit-input:focus {
      outline: none;
      border-color: #1e40af;
    }
    .cost-summary {
      background: #f1f5f9;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    .cost-summary-title {
      font-size: 16px;
      font-weight: bold;
      color: #1e3a8a;
      margin-bottom: 10px;
    }
    .cost-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .cost-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
    }
    .cost-label {
      color: #64748b;
    }
    .cost-value {
      font-weight: 600;
      color: #1e3a8a;
    }
    .validation-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      flex: 1;
      min-width: 120px;
    }
    .btn-validate {
      background: #3b82f6;
      color: white;
    }
    .btn-validate:hover {
      background: #1e40af;
    }
    .btn-edit {
      background: #64748b;
      color: white;
    }
    .btn-edit:hover {
      background: #475569;
    }
    .btn-success {
      background: #16a34a;
      color: white;
    }
    .btn-success:hover {
      background: #15803d;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .damage-center {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .damage-center-header {
      font-weight: bold;
      color: #1e3a8a;
      margin-bottom: 10px;
      border-bottom: 1px solid #e2e8f0;
      padding-bottom: 5px;
    }
    .damage-center-content {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
      margin-top: 10px;
    }
    .damage-stat {
      text-align: center;
      padding: 10px;
      background: #f8fafc;
      border-radius: 6px;
    }
    .damage-stat-label {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 5px;
    }
    .damage-stat-value {
      font-size: 16px;
      font-weight: bold;
      color: #1e3a8a;
    }
    .levi-adjustments {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    .levi-adjustments-title {
      font-weight: bold;
      color: #1e3a8a;
      margin-bottom: 10px;
    }
    .adjustment-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid #f1f5f9;
    }
    .adjustment-item:last-child {
      border-bottom: none;
    }
    .legal-text-section {
      background: #fef3c7;
      border: 2px solid #f59e0b;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }
    .legal-text-header {
      font-size: 18px;
      font-weight: bold;
      color: #92400e;
      margin-bottom: 15px;
    }
    .legal-text-content {
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 15px;
      min-height: 150px;
      font-size: 14px;
      line-height: 1.6;
      resize: vertical;
      width: 100%;
      box-sizing: border-box;
    }
    .user-validation-section {
      background: #eff6ff;
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 25px;
      margin: 20px 0;
    }
    .user-validation-header {
      font-size: 18px;
      font-weight: bold;
      color: #1e3a8a;
      margin-bottom: 15px;
    }
    .final-actions {
      background: #f1f5f9;
      border-radius: 12px;
      padding: 25px;
      text-align: center;
      margin-top: 30px;
    }
    .progress-indicator {
      background: #f1f5f9;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 25px;
    }
    .progress-bar {
      background: #e2e8f0;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-fill {
      background: linear-gradient(90deg, #3b82f6, #1e3a8a);
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    .footer {
      text-align: center;
      margin-top: 30px;
      font-size: 12px;
      color: #64748b;
    }
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        padding: 20px;
      }
      .cost-grid, .damage-center-content {
        grid-template-columns: 1fr;
      }
      .validation-buttons {
        flex-direction: column;
      }
    }
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }
    .alert.show {
      display: block;
    }
    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .alert.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo" />
    </div>
    <div class="title">ירון כיוף שמאות - פורטל</div>
    <div class="subtitle">שמאות והערכת נזקי רכב ורכוש</div>
    
    <h1>אימות אומדן נזקי רכב - מערכת בדיקה חכמה</h1>
    
    <div id="alerts"></div>
    
    <!-- Progress Indicator -->
    <div class="progress-indicator">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <span style="font-weight: 600; color: #1e3a8a;">התקדמות האימות</span>
        <span id="progress-text">0% הושלם</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
      </div>
    </div>

    <!-- Vehicle and Case Details Validation -->
    <div class="validation-section current" id="section-vehicle">
      <div class="section-header">
        <div class="section-title">פרטי רכב ומקרה</div>
        <div class="section-status status-current">בבדיקה</div>
      </div>
      <div class="section-content">
        <div style="background: #f8fafc; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 13px; color: #64748b;">
          <strong>הנחיות:</strong> עמודת "ערך נוכחי" מציגה את הנתונים המוצגים | עמודת "נתונים מאוחסנים" מציגה את הנתונים בעזר | ניתן לערוך או להתעלם מאי התאמות
        </div>
        
        <div class="validation-item">
          <span class="validation-label">מספר רכב מוגדר</span>
          <span class="validation-status" id="vehicle-plate">⏳</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">פרטי יצרן ודגם</span>
          <span class="validation-status" id="vehicle-details">⏳</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">מפרט רכב ושנת יצור</span>
          <span class="validation-status" id="vehicle-specs">⏳</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">פרטי בעלים</span>
          <span class="validation-status" id="vehicle-owner">⏳</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">פרטי ביטוח</span>
          <span class="validation-status" id="vehicle-insurance">⏳</span>
        </div>
      </div>
      <div class="validation-buttons">
        <button class="btn btn-validate" onclick="validateSection('vehicle')">בדוק אוטומטית</button>
        <button class="btn btn-edit" onclick="editSection('vehicle')">עריכה ידנית</button>
        <button class="btn btn-success" onclick="approveSection('vehicle')" disabled>אימות פרטי רכב</button>
      </div>
    </div>

    <!-- Levi Report Validation -->
    <div class="validation-section" id="section-levi">
      <div class="section-header">
        <div class="section-title">דו"ח לוי יצחק - שווי רכב</div>
        <div class="section-status status-pending">ממתין</div>
      </div>
      <div class="section-content">
        <div style="background: #f8fafc; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 13px; color: #64748b;">
          <strong>הנחיות:</strong> עמודת "ערך נוכחי" מציגה את הנתונים המוצגים | עמודת "נתונים מאוחסנים" מציגה את הנתונים בעזר | ניתן לערוך או להתעלם מאי התאמות
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 8px; margin-bottom: 10px; padding: 8px; background: #e2e8f0; border-radius: 6px; font-weight: 600; font-size: 12px; color: #374151;">
          <div>שדה</div>
          <div style="text-align: center;">ערך נוכחי</div>
          <div style="text-align: center;">נתונים מאוחסנים</div>
          <div style="text-align: center;">חישוב/אחוז</div>
          <div style="text-align: center;">פעולות</div>
        </div>
        
        <div id="levi-validation-items">
          <!-- Will be populated by JavaScript -->
        </div>
        
        <!-- Cost Summary -->
        <div class="cost-summary" style="margin-top: 20px;">
          <div class="cost-summary-title">סיכום שווי רכב</div>
          <div class="cost-grid">
            <div class="cost-item">
              <span class="cost-label">מחיר בסיס:</span>
              <span class="cost-value" id="levi-display-base">₪0</span>
            </div>
            <div class="cost-item">
              <span class="cost-label">סה"כ התאמות:</span>
              <span class="cost-value" id="levi-display-adjustments">₪0</span>
            </div>
            <div class="cost-item">
              <span class="cost-label">שווי שוק סופי:</span>
              <span class="cost-value" id="levi-display-final">₪0</span>
            </div>
          </div>
        </div>
      </div>
      <div class="validation-buttons">
        <button class="btn btn-validate" onclick="validateSection('levi')" disabled>בדוק אוטומטית</button>
        <button class="btn btn-edit" onclick="editSection('levi')" disabled>עריכה ידנית</button>
        <button class="btn btn-success" onclick="approveSection('levi')" disabled>אימות דו"ח לוי</button>
      </div>
    </div>

    <!-- Damage Centers Validation -->
    <div class="validation-section" id="section-damage">
      <div class="section-header">
        <div class="section-title">מוקדי נזק ואקספרטיזה</div>
        <div class="section-status status-pending">ממתין</div>
      </div>
      <div class="section-content">
        <div class="validation-item">
          <span class="validation-label">מספר מוקדי נזק מוגדרים</span>
          <span class="validation-status" id="damage-centers-count">⏳</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">פירוט עבודות ותיקונים</span>
          <span class="validation-status" id="damage-works">⏳</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">רשימת חלקים נדרשים</span>
          <span class="validation-status" id="damage-parts">⏳</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">חישוב עלויות כולל</span>
          <span class="validation-status" id="damage-costs">⏳</span>
        </div>
        
        <!-- Damage Centers Display -->
        <div id="damage-centers-container">
          <!-- Will be populated dynamically -->
        </div>
        
        <!-- Total Damage Cost Summary -->
        <div class="cost-summary">
          <div class="cost-summary-title">סיכום עלויות נזקים</div>
          <div class="cost-grid">
            <div class="cost-item">
              <span class="cost-label">סה"כ עבודות:</span>
              <span class="cost-value" id="damage-total-works">₪0</span>
            </div>
            <div class="cost-item">
              <span class="cost-label">סה"כ חלקים:</span>
              <span class="cost-value" id="damage-total-parts">₪0</span>
            </div>
            <div class="cost-item">
              <span class="cost-label">סה"כ תיקונים:</span>
              <span class="cost-value" id="damage-total-repairs">₪0</span>
            </div>
            <div class="cost-item" style="border-top: 2px solid #3b82f6; padding-top: 10px; margin-top: 10px;">
              <span class="cost-label" style="font-weight: bold;">סה"כ נזקים ללא מע"מ:</span>
              <span class="cost-value" style="font-size: 18px; color: #dc2626;" id="damage-total-before-vat">₪0</span>
            </div>
            <div class="cost-item" style="padding-top: 10px;">
              <span class="cost-label" style="font-weight: bold;">סה"כ נזקים כולל מע"מ:</span>
              <span class="cost-value" style="font-size: 18px; color: #16a34a;" id="damage-total-with-vat">₪0</span>
            </div>
          </div>
        </div>
      </div>
      <div class="validation-buttons">
        <button class="btn btn-validate" onclick="validateSection('damage')" disabled>בדוק אוטומטית</button>
        <button class="btn btn-edit" onclick="editSection('damage')" disabled>עריכה ידנית</button>
        <button class="btn btn-success" onclick="approveSection('damage')" disabled>אימות מוקדי נזק</button>
      </div>
    </div>

    <!-- Estimate Type and Calculations -->
    <div class="validation-section" id="section-estimate">
      <div class="section-header">
        <div class="section-title">סוג אומדן וחישובים</div>
        <div class="section-status status-pending">ממתין</div>
      </div>
      <div class="section-content">
        <div class="validation-item">
          <span class="validation-label">סוג אומדן מוגדר</span>
          <span class="validation-status" id="estimate-type-status">⏳</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">טקסט משפטי מתאים</span>
          <span class="validation-status" id="estimate-legal-text">⏳</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">חישוב מע"מ ותביעה</span>
          <span class="validation-status" id="estimate-calculations">⏳</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">בדיקת עקביות נתונים</span>
          <span class="validation-status" id="estimate-consistency">⏳</span>
        </div>
        
        <!-- Estimate Calculations Summary -->
        <div class="cost-summary">
          <div class="cost-summary-title">חישובי אומדן סופיים</div>
          <div class="cost-grid">
            <div class="cost-item">
              <span class="cost-label">סה"כ נזקים:</span>
              <span class="cost-value" id="estimate-base-damage">₪0</span>
            </div>
            <div class="cost-item">
              <span class="cost-label">שיעור מע"מ:</span>
              <span class="cost-value" id="estimate-vat-rate">18%</span>
            </div>
            <div class="cost-item">
              <span class="cost-label">סכום מע"מ:</span>
              <span class="cost-value" id="estimate-vat-amount">₪0</span>
            </div>
            <div class="cost-item" style="grid-column: 1 / -1; border-top: 2px solid #16a34a; padding-top: 10px; margin-top: 10px;">
              <span class="cost-label" style="font-weight: bold; font-size: 18px;">סה"כ תביעה כולל מע"מ:</span>
              <span class="cost-value" style="font-size: 20px; color: #16a34a;" id="estimate-total-claim">₪0</span>
            </div>
          </div>
        </div>
      </div>
      <div class="validation-buttons">
        <button class="btn btn-validate" onclick="validateSection('estimate')" disabled>בדוק אוטומטית</button>
        <button class="btn btn-edit" onclick="editSection('estimate')" disabled>עריכה ידנית</button>
        <button class="btn btn-success" onclick="approveSection('estimate')" disabled>אימות חישובים</button>
      </div>
    </div>

    <!-- Legal Text Validation -->
    <div class="legal-text-section">
      <div class="legal-text-header">אימות טקסט משפטי</div>
      <div style="margin-bottom: 15px; color: #92400e;">
        הטקסט המשפטי להלן ייכלל באומדן. ניתן לערוך ולהתאים לפי הצורך. המערכת בדקה את התאמת הטקסט לסוג האומדן.
      </div>
      <textarea class="legal-text-content" id="legal-text-content" placeholder="טקסט משפטי ייטען כאן..."></textarea>
      <div class="validation-buttons" style="margin-top: 15px;">
        <button class="btn btn-validate" onclick="validateLegalText()">בדוק טקסט משפטי</button>
        <button class="btn btn-edit" onclick="editLegalText()">עריכה מתקדמת</button>
      </div>
    </div>

    <!-- User Manual Validation -->
    <div class="user-validation-section">
      <div class="user-validation-header">אימות ברמת המשתמש - סקירה ידנית</div>
      <div style="color: #475569; line-height: 1.6; margin-bottom: 20px;">
        <p><strong>בדוק את כל הנתונים לעיל ותקן במידת הצורך.</strong> המערכת ביצעה בדיקות אוטומטיות, אך נדרשת הסקירה הידנית שלך.</p>
        
        <div style="background: #eff6ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
          <strong>אזהרה חשובה:</strong> שינויים שתבצע כאן יהפכו לאמת המערכת ויורשמו באומדן הסופי. ודא שכל הנתונים נכונים לפני האישור הסופי.
        </div>
        
        <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin: 15px 0;">
          <strong>הנחיות לאימות:</strong>
          <ul style="margin: 10px 0; padding-right: 20px;">
            <li>ודא שכל הנתונים הכספיים נכונים ועקביים</li>
            <li>בדוק שהטקסט המשפטי מתאים לסוג האומדן</li>
            <li>וודא שפרטי הרכב והבעלים נכונים</li>
            <li>בדוק שמוקדי הנזק משקפים את המצב בפועל</li>
          </ul>
        </div>
      </div>
      
      <div class="validation-buttons">
        <button class="btn btn-edit" onclick="requestManualReview()">דרוש סקירה נוספת</button>
        <button class="btn btn-validate" onclick="saveValidationData()">שמור שינויים</button>
      </div>
    </div>

    <!-- Final Actions -->
    <div class="final-actions">
      <div style="font-size: 18px; font-weight: bold; color: #1e3a8a; margin-bottom: 20px;">
        פעולות סיום
      </div>
      <div style="color: #64748b; margin-bottom: 25px;">
        לאחר האישור הסופי ייוצר האומדן ויישלח לעיבוד. לא ניתן יהיה לערוך את הנתונים לאחר מכן.
      </div>
      <div class="validation-buttons" style="justify-content: center; max-width: 600px; margin: 0 auto;">
        <button class="btn btn-edit" onclick="window.location.href='estimate-builder.html'">
          ⬅️ חזור לעריכה
        </button>
        <button class="btn btn-validate" onclick="saveValidationData()">
          💾 שמור אימות
        </button>
        <button class="btn btn-success" id="final-approve-btn" onclick="reviewEstimateReport()" disabled>
          📋 בדיקת אומדן סופי
        </button>
      </div>
    </div>
    
    <div class="footer">All rights reserved © Carmel Cayouf</div>
  </div>

  <script type="module">
    import { helper, updateHelper } from './helper.js';
    import { loadLegalText } from './vault-loader.js';
    import { MathEngine } from './math.js';
    import { sendToWebhook } from './webhook.js';
    
    let validationProgress = {
      vehicle: false,
      levi: false,
      damage: false,
      estimate: false
    };
    
    let currentValidationData = {};

    // Authentication check
    document.addEventListener('DOMContentLoaded', () => {
      console.log('🔄 Estimate Validation: Initializing comprehensive validation system...');
      
      const auth = sessionStorage.getItem("auth");
      if (!auth) {
        console.error('❌ No authentication found');
        showAlert("הגישה חסומה - אנא התחבר דרך דף הבית", 'error');
        setTimeout(() => {
          window.location.href = "index.html";
        }, 2000);
        return;
      }

      const helperData = sessionStorage.getItem('helper');
      const selectedReportType = sessionStorage.getItem('selectedReportType');
      
      if (!helperData || selectedReportType !== 'estimate') {
        console.error('❌ Missing required data for validation');
        showAlert('שגיאה: נתונים חסרים לאימות. חוזר לדף הבחירה...', 'error');
        setTimeout(() => {
          window.location.href = 'selection.html';
        }, 2000);
        return;
      }

      console.log('✅ Estimate Validation: Authentication and data validated');
      initializeValidationSystem();
    });

    function initializeValidationSystem() {
      loadValidationData();
      loadLegalTextValidation();
      populateEnhancedValidationItems();
      startInitialValidation();
    }

    // Create enhanced validation item with 3-column display
    function createEnhancedValidationItem(label, currentValue, storedValue, fieldKey, editType = 'inline') {
      // Clean and normalize values
      const cleanCurrent = currentValue && currentValue !== 'undefined' ? String(currentValue).trim() : '';
      const cleanStored = storedValue && storedValue !== 'undefined' && storedValue !== 'לא מוגדר' ? String(storedValue).trim() : '';
      
      const isMatch = cleanCurrent === cleanStored && cleanCurrent !== '';
      const hasStoredData = cleanStored !== '' && cleanStored !== 'לא מוגדר';
      
      let statusClass;
      if (isMatch) {
        statusClass = 'data-match';
      } else if (hasStoredData) {
        statusClass = 'data-warning';
      } else {
        statusClass = 'data-error';
      }
      
      return `
        <div class="validation-item-enhanced" data-field="${fieldKey}">
          <div class="validation-label">${label}</div>
          <div class="validation-columns">
            <div class="current-value ${statusClass}" id="current-${fieldKey}">
              ${cleanCurrent || 'לא זמין'}
            </div>
            <div class="stored-value">
              ${hasStoredData ? cleanStored : 'לא קיים בעזר'}
            </div>
            <div class="action-buttons">
              ${editType === 'inline' ? 
                `<button class="edit-inline" onclick="startInlineEdit('${fieldKey}')">✏️</button>` : 
                `<button class="edit-builder" onclick="editInBuilder('${fieldKey}')">📝</button>`
              }
              ${!isMatch && (cleanCurrent || hasStoredData) ? `<button class="ignore" onclick="ignoreDiscrepancy('${fieldKey}')">🚫</button>` : ''}
            </div>
          </div>
        </div>
      `;
    }

    // Restore original vehicle validation items (working version)
    function populateEnhancedValidationItems() {
      // Keep original working vehicle validation - don't use enhanced display for vehicle section
      console.log('✅ Vehicle section using original working validation structure');
    }

    function loadValidationData() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Enhanced data extraction from estimate-builder format
      currentValidationData = {
        // Basic metadata
        meta: helper.meta || {},
        plate: helper.plate || helper.meta?.plate || '',
        
        // Car details from multiple possible sources
        car_details: {
          plate: helper.plate || helper.meta?.plate || '',
          manufacturer: helper.manufacturer || helper.car_details?.manufacturer || '',
          model: helper.model || helper.car_details?.model || '',
          year: helper.year || helper.car_details?.year || '',
          vin: helper.vin || helper.car_details?.vin || '',
          engine: helper.engine || helper.car_details?.engine || ''
        },
        
        // Client/owner information
        client: {
          name: helper.owner || helper.client?.name || '',
          phone_number: helper.client?.phone_number || '',
          address: helper.client?.address || '',
          insurance_company: helper.client?.insurance_company || ''
        },
        
        // Levi report data
        levi_report: helper.levi_report || helper.expertise?.levi_report || {},
        
        // Damage centers from estimate-builder format
        damage_blocks: helper.expertise?.damage_blocks || [],
        
        // Legal text from estimate builder
        estimate_legal_text: helper.estimate_legal_text || '',
        
        // Estimate calculations and totals
        estimate_totals: extractEstimateTotals(helper),
        
        // Store raw helper for reference
        raw_helper: helper
      };
      
      console.log('📊 Enhanced validation data loaded:', currentValidationData);
    }

    // Extract estimate totals from damage blocks
    function extractEstimateTotals(helper) {
      const damageBlocks = helper.expertise?.damage_blocks || [];
      let totals = {
        parts_cost: 0,
        work_cost: 0,
        repairs_cost: 0,
        total_before_vat: 0,
        total_with_vat: 0
      };
      
      damageBlocks.forEach(block => {
        // Sum parts costs
        if (block.parts) {
          block.parts.forEach(part => {
            totals.parts_cost += parseFloat(part.price) || 0;
          });
        }
        
        // Sum work costs
        if (block.works) {
          block.works.forEach(work => {
            totals.work_cost += parseFloat(work.cost) || 0;
          });
        }
        
        // Sum repair costs
        if (block.repairs) {
          block.repairs.forEach(repair => {
            totals.repairs_cost += parseFloat(repair.cost) || 0;
          });
        }
      });
      
      totals.total_before_vat = totals.parts_cost + totals.work_cost + totals.repairs_cost;
      totals.total_with_vat = totals.total_before_vat * 1.18; // 18% VAT
      
      return totals;
    }

    async function loadLegalTextValidation() {
      try {
        // First try to load from estimate builder selection
        const estimateText = currentValidationData.estimate_legal_text;
        
        if (estimateText && estimateText.length > 50) {
          document.getElementById('legal-text-content').value = estimateText;
          console.log('✅ Loaded legal text from estimate builder');
        } else {
          // Fallback to loading from vault based on estimate type
          const estimateType = currentValidationData.raw_helper.estimate_type || 'אובדן_להלכה';
          const legalText = await loadLegalText(`estimate_${estimateType}`);
          document.getElementById('legal-text-content').value = legalText || 'טקסט משפטי לא נמצא';
          console.log('📄 Loaded legal text from vault as fallback');
        }
      } catch (error) {
        console.error('Error loading legal text:', error);
        document.getElementById('legal-text-content').value = 'שגיאה בטעינת הטקסט המשפטי';
      }
    }

    function startInitialValidation() {
      // Auto-validate vehicle section first
      validateSection('vehicle');
    }

    // Validation Functions
    window.validateSection = async function(sectionName) {
      const section = document.getElementById(`section-${sectionName}`);
      const status = section.querySelector('.section-status');
      
      // Set to validating state
      section.classList.remove('completed', 'error', 'warning');
      section.classList.add('current');
      status.textContent = 'מאמת...';
      status.className = 'section-status status-current';
      
      try {
        let validationResult;
        
        switch(sectionName) {
          case 'vehicle':
            validationResult = await validateVehicleSection();
            break;
          case 'levi':
            validationResult = await validateLeviSection();
            break;
          case 'damage':
            validationResult = await validateDamageSection();
            break;
          case 'estimate':
            validationResult = await validateEstimateSection();
            break;
        }
        
        // Update UI based on validation result
        updateSectionUI(sectionName, validationResult);
        
        // Update progress
        updateValidationProgress();
        
      } catch (error) {
        console.error(`Validation error for section ${sectionName}:`, error);
        setSectionError(sectionName, error.message);
      }
    };

    async function validateVehicleSection() {
      const issues = [];
      const validItems = [];
      const data = currentValidationData;
      
      // Use original data extraction approach (working version)
      const plateValue = data.plate || data.car_details?.plate || '';
      const manufacturerValue = data.car_details?.manufacturer || '';
      const modelValue = data.car_details?.model || '';
      const yearValue = data.car_details?.year || '';
      const ownerValue = data.client?.name || '';
      const insuranceValue = data.client?.insurance_company || '';
      
      // Validate plate number
      if (plateValue && plateValue.length >= 6) {
        validItems.push('vehicle-plate');
        updateElementIfExists('vehicle-plate', '✓');
      } else {
        issues.push('מספר רכב חסר או לא תקין');
        updateElementIfExists('vehicle-plate', '❌');
      }
      
      // Validate vehicle details  
      if (manufacturerValue && modelValue) {
        validItems.push('vehicle-details');
        updateElementIfExists('vehicle-details', '✓');
      } else {
        issues.push('פרטי יצרן או דגם חסרים');
        updateElementIfExists('vehicle-details', '❌');
      }
      
      // Validate vehicle specs
      if (yearValue && yearValue > 1990 && yearValue <= new Date().getFullYear()) {
        validItems.push('vehicle-specs');
        updateElementIfExists('vehicle-specs', '✓');
      } else {
        issues.push('שנת יצור לא תקינה');
        updateElementIfExists('vehicle-specs', '❌');
      }
      
      // Validate owner details (warning only, not blocking)
      if (ownerValue) {
        validItems.push('vehicle-owner');
        updateElementIfExists('vehicle-owner', '✓');
      } else {
        issues.push('פרטי בעלים חסרים (אזהרה)');
        updateElementIfExists('vehicle-owner', '⚠️');
      }
      
      // Validate insurance details (warning only, not blocking)  
      if (insuranceValue) {
        validItems.push('vehicle-insurance');
        updateElementIfExists('vehicle-insurance', '✓');
      } else {
        issues.push('פרטי ביטוח חסרים (אזהרה)');
        updateElementIfExists('vehicle-insurance', '⚠️');
      }
      
      // Only count critical errors (not warnings)
      const criticalErrors = issues.filter(i => !i.includes('אזהרה')).length;
      
      return {
        success: criticalErrors === 0,
        warnings: issues.filter(i => i.includes('אזהרה')).length,
        errors: criticalErrors,
        issues: issues,
        validItems: validItems.length
      };
    }

    // Helper function to get current field value from enhanced display
    function getCurrentFieldValue(fieldKey) {
      const element = document.getElementById(`current-${fieldKey}`);
      return element ? element.textContent.trim() : '';
    }

    // Helper function to set validation status for a field
    function setFieldValidationStatus(fieldKey, status) {
      const element = document.getElementById(`current-${fieldKey}`);
      if (element) {
        // Update the visual indicator (could add a small status icon)
        if (status === '✓') {
          element.classList.remove('data-error', 'data-warning');
          element.classList.add('data-match');
        } else if (status === '⚠️') {
          element.classList.remove('data-error', 'data-match');
          element.classList.add('data-warning');
        } else {
          element.classList.remove('data-match', 'data-warning');
          element.classList.add('data-error');
        }
      }
    }

    // Helper function to safely update elements that may or may not exist
    function updateElementIfExists(elementId, content) {
      const element = document.getElementById(elementId);
      if (element) {
        element.textContent = content;
        return true;
      }
      return false;
    }

    async function validateLeviSection() {
      const issues = [];
      const validItems = [];
      const levi = currentValidationData.levi_report;
      
      // Get current values from enhanced display
      const basePriceValue = getCurrentFieldValue('levi_base_price');
      const marketValueValue = getCurrentFieldValue('levi_market_value');
      
      console.log('🔍 Levi validation - Base price:', basePriceValue, 'Market value:', marketValueValue);
      
      // Validate base price - treat as critical for Levi section
      const basePrice = parseFloat(basePriceValue?.replace(/[₪,]/g, '')) || 0;
      if (basePrice > 0) {
        validItems.push('levi-base-price');
        setFieldValidationStatus('levi_base_price', '✓');
        updateElementIfExists('levi-display-base', MathEngine.formatCurrency(basePrice));
      } else {
        issues.push('מחיר בסיס חסר או לא תקין');
        setFieldValidationStatus('levi_base_price', '❌');
        updateElementIfExists('levi-display-base', '₪0');
      }
      
      // Validate market value - treat as critical for Levi section
      const marketValue = parseFloat(marketValueValue?.replace(/[₪,]/g, '')) || 0;
      if (marketValue > 0) {
        validItems.push('levi-market-value');
        setFieldValidationStatus('levi_market_value', '✓');
        updateElementIfExists('levi-display-final', MathEngine.formatCurrency(marketValue));
      } else {
        issues.push('שווי שוק סופי חסר או לא תקין');
        setFieldValidationStatus('levi_market_value', '❌');
        updateElementIfExists('levi-display-final', '₪0');
      }
      
      // Calculate adjustments
      const adjustments = marketValue - basePrice;
      updateElementIfExists('levi-display-adjustments', MathEngine.formatCurrency(adjustments));
      
      // Stricter validation: require both base price and market value with valid amounts
      const hasValidBasePrice = basePrice > 1000; // Minimum reasonable car value
      const hasValidMarketValue = marketValue > 1000; // Minimum reasonable car value
      
      if (!hasValidBasePrice) {
        issues.push('מחיר בסיס לא תקין (נדרש מעל ₪1,000)');
      }
      if (!hasValidMarketValue) {
        issues.push('שווי שוק לא תקין (נדרש מעל ₪1,000)');
      }
      
      // Count critical errors after all validations
      const criticalErrors = issues.filter(i => !i.includes('אזהרה')).length;
      const bothValuesExist = hasValidBasePrice && hasValidMarketValue;
      
      console.log('🔍 Levi validation result - Critical errors:', criticalErrors, 'Issues:', issues, 'Valid prices:', bothValuesExist);
      
      return {
        success: criticalErrors === 0 && bothValuesExist,
        warnings: 0,
        errors: criticalErrors,
        issues: issues,
        validItems: validItems.length
      };
    }

    async function validateDamageSection() {
      const issues = [];
      const validItems = [];
      const damageBlocks = currentValidationData.damage_blocks;
      const totals = currentValidationData.estimate_totals;
      
      // Validate damage centers count
      if (damageBlocks && damageBlocks.length > 0) {
        validItems.push('damage-centers-count');
        updateElementIfExists('damage-centers-count', `✓ (${damageBlocks.length})`);
      } else {
        issues.push('לא נמצאו מוקדי נזק (אזהרה)');
        updateElementIfExists('damage-centers-count', '⚠️');
      }
      
      let hasWorks = false, hasParts = false, hasRepairs = false;
      
      // Validate each damage center and check for content
      if (damageBlocks && damageBlocks.length > 0) {
        displayDamageCentersEnhanced(damageBlocks);
        
        damageBlocks.forEach(center => {
          if (center.works && center.works.length > 0) {
            hasWorks = true;
          }
          if (center.parts && center.parts.length > 0) {
            hasParts = true;
          }
          if (center.repairs && center.repairs.length > 0) {
            hasRepairs = true;
          }
        });
      }
      
      // Validate works (warning only)
      if (hasWorks) {
        validItems.push('damage-works');
        updateElementIfExists('damage-works', '✓');
      } else {
        issues.push('לא נמצאו פרטי עבודות (אזהרה)');
        updateElementIfExists('damage-works', '⚠️');
      }
      
      // Validate parts (warning only)
      if (hasParts) {
        validItems.push('damage-parts');
        updateElementIfExists('damage-parts', '✓');
      } else {
        issues.push('לא נמצאו חלקים (אזהרה)');
        updateElementIfExists('damage-parts', '⚠️');
      }
      
      // Validate costs using extracted totals (warning only if no costs)
      if (totals && totals.total_before_vat > 0) {
        validItems.push('damage-costs');
        updateElementIfExists('damage-costs', '✓');
      } else {
        issues.push('לא נמצאו עלויות חישוב (אזהרה)');
        updateElementIfExists('damage-costs', '⚠️');
      }
      
      // Update cost display using extracted totals with safe fallbacks
      const safeTotals = totals || { work_cost: 0, parts_cost: 0, repairs_cost: 0, total_before_vat: 0, total_with_vat: 0 };
      updateElementIfExists('damage-total-works', MathEngine.formatCurrency(safeTotals.work_cost));
      updateElementIfExists('damage-total-parts', MathEngine.formatCurrency(safeTotals.parts_cost));
      updateElementIfExists('damage-total-repairs', MathEngine.formatCurrency(safeTotals.repairs_cost));
      updateElementIfExists('damage-total-before-vat', MathEngine.formatCurrency(safeTotals.total_before_vat));
      updateElementIfExists('damage-total-with-vat', MathEngine.formatCurrency(safeTotals.total_with_vat));
      
      // Stricter damage section validation
      let criticalErrors = 0;
      
      // Must have at least one damage center
      if (!damageBlocks || damageBlocks.length === 0) {
        criticalErrors++;
        issues.push('נדרש לפחות מוקד נזק אחד');
      }
      
      // Must have actual damage content (works, parts, or repairs)
      if (damageBlocks && damageBlocks.length > 0 && !hasWorks && !hasParts && !hasRepairs) {
        criticalErrors++;
        issues.push('נדרש תוכן נזק בפועל (עבודות, חלקים או תיקונים)');
      }
      
      // Must have reasonable damage costs (at least ₪100)
      if (safeTotals.total_before_vat < 100) {
        criticalErrors++;
        issues.push('עלות נזקים נמוכה מדי (נדרש לפחות ₪100)');
      }
      
      console.log('🔍 Damage validation result - Critical errors:', criticalErrors, 'Has content:', hasWorks || hasParts || hasRepairs, 'Total:', safeTotals.total_before_vat);
      
      return {
        success: criticalErrors === 0,
        warnings: issues.filter(i => i.includes('אזהרה')).length,
        errors: criticalErrors,
        issues: issues,
        validItems: validItems.length,
        totalDamage: safeTotals.total_before_vat
      };
    }

    async function validateEstimateSection() {
      const issues = [];
      const validItems = [];
      
      // Validate estimate type (warning only)
      const estimateType = currentValidationData.raw_helper?.estimate_type || currentValidationData.estimate_data?.type;
      if (estimateType && ['אובדן_להלכה', 'טוטלוס', 'פרטי', 'גלובלי'].includes(estimateType)) {
        validItems.push('estimate-type-status');
        updateElementIfExists('estimate-type-status', '✓');
      } else {
        issues.push('סוג אומדן לא מוגדר (אזהרה)');
        updateElementIfExists('estimate-type-status', '⚠️');
      }
      
      // Validate legal text
      const legalTextElement = document.getElementById('legal-text-content');
      const legalText = legalTextElement ? legalTextElement.value : '';
      if (legalText && legalText.length > 50 && !legalText.includes('שגיאה')) {
        validItems.push('estimate-legal-text');
        updateElementIfExists('estimate-legal-text', '✓');
      } else {
        issues.push('טקסט משפטי לא תקין (אזהרה)');
        updateElementIfExists('estimate-legal-text', '⚠️');
      }
      
      // Get damage total from totals or calculate from DOM safely
      let totalDamage = 0;
      if (currentValidationData.estimate_totals) {
        totalDamage = currentValidationData.estimate_totals.total_before_vat || 0;
      } else {
        const damageElement = document.getElementById('damage-total-before-vat');
        if (damageElement) {
          totalDamage = parseFloat(damageElement.textContent.replace(/[₪,]/g, '')) || 0;
        }
      }
      
      // Calculate VAT and final amount
      const vatRate = MathEngine ? MathEngine.getVatRate() : 18;
      const vatAmount = Math.round(totalDamage * vatRate / 100);
      const totalClaim = totalDamage + vatAmount;
      
      // Validate calculations (warning only)
      if (totalDamage >= 0) { // Accept 0 as valid
        validItems.push('estimate-calculations');
        updateElementIfExists('estimate-calculations', '✓');
      } else {
        issues.push('חישובים לא תקינים (אזהרה)');
        updateElementIfExists('estimate-calculations', '⚠️');
      }
      
      // Validate data consistency (warning only)
      const hasPlate = currentValidationData.plate || currentValidationData.car_details?.plate;
      if (hasPlate) {
        validItems.push('estimate-consistency');
        updateElementIfExists('estimate-consistency', '✓');
      } else {
        issues.push('חוסר עקביות בנתונים (אזהרה)');
        updateElementIfExists('estimate-consistency', '⚠️');
      }
      
      // Update calculation display with safe fallbacks
      updateElementIfExists('estimate-base-damage', MathEngine ? MathEngine.formatCurrency(totalDamage) : `₪${totalDamage.toLocaleString()}`);
      updateElementIfExists('estimate-vat-rate', `${vatRate}%`);
      updateElementIfExists('estimate-vat-amount', MathEngine ? MathEngine.formatCurrency(vatAmount) : `₪${vatAmount.toLocaleString()}`);
      updateElementIfExists('estimate-total-claim', MathEngine ? MathEngine.formatCurrency(totalClaim) : `₪${totalClaim.toLocaleString()}`);
      
      // Stricter estimate section validation
      let criticalErrors = 0;
      
      // Validate legal text
      if (!legalText || legalText.length < 50 || legalText.includes('שגיאה')) {
        criticalErrors++;
        issues.push('טקסט משפטי לא תקין או חסר');
      }
      
      // Validate reasonable total damage amount
      if (totalDamage < 100) {
        criticalErrors++;
        issues.push('סכום נזק כולל נמוך מדי (נדרש לפחות ₪100)');
      }
      
      // Validate estimate type exists
      const estimateType = currentValidationData.raw_helper?.estimate_type;
      if (!estimateType || !['אובדן_להלכה', 'טוטלוס', 'פרטי', 'גלובלי'].includes(estimateType)) {
        criticalErrors++;
        issues.push('סוג אומדן לא מוגדר או לא תקין');
      }
      
      // Validate basic plate number exists for consistency
      if (!hasPlate) {
        criticalErrors++;
        issues.push('מספר רכב חסר לבדיקת עקביות');
      }
      
      console.log('🔍 Estimate validation result - Critical errors:', criticalErrors, 'Legal text length:', legalText.length, 'Total damage:', totalDamage);
      
      return {
        success: criticalErrors === 0,
        warnings: issues.filter(i => i.includes('אזהרה')).length,
        errors: criticalErrors,
        issues: issues,
        validItems: validItems.length,
        totalClaim: totalClaim
      };
    }

    function displayLeviAdjustments(adjustments) {
      const container = document.getElementById('levi-adjustments-content');
      container.innerHTML = '';
      
      Object.keys(adjustments).forEach(key => {
        const adjustment = adjustments[key];
        if (adjustment.percent || adjustment.value) {
          const div = document.createElement('div');
          div.className = 'adjustment-item';
          div.innerHTML = `
            <span>${key}:</span>
            <span>${adjustment.percent || '0'}% (${MathEngine.formatCurrency(adjustment.value || 0)})</span>
          `;
          container.appendChild(div);
        }
      });
    }

    function displayDamageCentersEnhanced(damageBlocks) {
      const container = document.getElementById('damage-centers-container');
      container.innerHTML = '';
      
      damageBlocks.forEach((block, index) => {
        // Calculate totals for this block using individual cost fields
        const worksTotal = block.works ? block.works.reduce((sum, work) => sum + (parseFloat(work.cost) || 0), 0) : 0;
        const partsTotal = block.parts ? block.parts.reduce((sum, part) => sum + (parseFloat(part.price) || 0), 0) : 0;
        const repairsTotal = block.repairs ? block.repairs.reduce((sum, repair) => sum + (parseFloat(repair.cost) || 0), 0) : 0;
        
        // Calculate VAT for each category
        const vatRate = MathEngine.getVatRate();
        const worksVat = Math.round(worksTotal * vatRate / 100);
        const partsVat = Math.round(partsTotal * vatRate / 100);
        const repairsVat = Math.round(repairsTotal * vatRate / 100);
        
        const div = document.createElement('div');
        div.className = 'damage-center';
        div.innerHTML = `
          <div class="damage-center-header">
            ${block.damage_center_name || `מוקד נזק ${index + 1}`}
            <button onclick="editDamageCenter(${index})" style="float: left; background: #3b82f6; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
              ✏️ עריכה
            </button>
          </div>
          <div class="damage-center-content">
            <div class="damage-stat">
              <div class="damage-stat-label">עבודות</div>
              <div class="damage-stat-value">${block.works?.length || 0}</div>
              <div style="font-size: 11px; color: #64748b; margin-top: 3px;">ללא מע"מ: ${MathEngine.formatCurrency(worksTotal)}</div>
              <div style="font-size: 11px; color: #16a34a; font-weight: bold;">כולל מע"מ: ${MathEngine.formatCurrency(worksTotal + worksVat)}</div>
            </div>
            <div class="damage-stat">
              <div class="damage-stat-label">חלקים</div>
              <div class="damage-stat-value">${block.parts?.length || 0}</div>
              <div style="font-size: 11px; color: #64748b; margin-top: 3px;">ללא מע"מ: ${MathEngine.formatCurrency(partsTotal)}</div>
              <div style="font-size: 11px; color: #16a34a; font-weight: bold;">כולל מע"מ: ${MathEngine.formatCurrency(partsTotal + partsVat)}</div>
            </div>
            <div class="damage-stat">
              <div class="damage-stat-label">תיקונים</div>
              <div class="damage-stat-value">${block.repairs?.length || 0}</div>
              <div style="font-size: 11px; color: #64748b; margin-top: 3px;">ללא מע"מ: ${MathEngine.formatCurrency(repairsTotal)}</div>
              <div style="font-size: 11px; color: #16a34a; font-weight: bold;">כולל מע"מ: ${MathEngine.formatCurrency(repairsTotal + repairsVat)}</div>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // Add edit damage center function
    window.editDamageCenter = function(index) {
      sessionStorage.setItem('editDamageCenterIndex', index);
      window.location.href = 'estimate-builder.html#damage-centers';
    };

    // ENHANCED VALIDATION EDITING FUNCTIONS

    // Start inline editing for a field
    window.startInlineEdit = function(fieldKey) {
      const currentElement = document.getElementById(`current-${fieldKey}`);
      const currentValue = currentElement.textContent.trim();
      
      if (currentValue === 'לא זמין') {
        currentValue = '';
      }
      
      // Create inline edit input
      currentElement.innerHTML = `
        <input type="text" class="inline-edit-input" value="${currentValue}" 
               onblur="saveInlineEdit('${fieldKey}', this.value)" 
               onkeypress="if(event.key==='Enter') saveInlineEdit('${fieldKey}', this.value)"
               data-original="${currentValue}" />
      `;
      
      // Focus the input
      const input = currentElement.querySelector('.inline-edit-input');
      input.focus();
      input.select();
    };

    // Save inline edit and update helper
    window.saveInlineEdit = function(fieldKey, newValue) {
      const currentElement = document.getElementById(`current-${fieldKey}`);
      const originalValue = currentElement.querySelector('.inline-edit-input').dataset.original;
      
      if (newValue !== originalValue) {
        // Update helper data
        updateHelperField(fieldKey, newValue);
        
        // Update display
        currentElement.textContent = newValue || 'לא זמין';
        currentElement.className = 'current-value data-match'; // Assume it matches after edit
        
        // Remove ignore button if it exists since user has edited
        const actionButtons = currentElement.parentElement.querySelector('.action-buttons');
        const ignoreBtn = actionButtons.querySelector('.ignore');
        if (ignoreBtn) {
          ignoreBtn.remove();
        }
        
        showAlert(`השדה "${getFieldLabel(fieldKey)}" עודכן בהצלחה`, 'success');
        
        // Trigger re-validation
        setTimeout(() => {
          validateSection('vehicle');
        }, 500);
      } else {
        // Restore original value
        currentElement.textContent = originalValue || 'לא זמין';
      }
    };

    // Update helper field with new value
    function updateHelperField(fieldKey, newValue) {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      switch(fieldKey) {
        // Vehicle fields
        case 'plate':
          helper.plate = newValue;
          break;
        case 'manufacturer':
          helper.manufacturer = newValue;
          break;
        case 'model':
          helper.model = newValue;
          break;
        case 'year':
          helper.year = newValue;
          break;
        case 'owner_name':
          helper.owner = newValue;
          break;
        case 'insurance':
          helper.insurance_company = newValue;
          break;
        
        // Levi fields
        case 'levi_base_price':
          if (!helper.levi_report) helper.levi_report = {};
          helper.levi_report.base_price = parseFloat(newValue.replace(/[₪,]/g, '')) || 0;
          break;
        case 'levi_market_value':
          if (!helper.levi_report) helper.levi_report = {};
          helper.levi_report.final_price = parseFloat(newValue.replace(/[₪,]/g, '')) || 0;
          helper.levi_report.market_value = parseFloat(newValue.replace(/[₪,]/g, '')) || 0;
          break;
      }
      
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      // Update current validation data
      loadValidationData();
      
      console.log(`Updated ${fieldKey} to:`, newValue);
    }

    // Get field label for display
    function getFieldLabel(fieldKey) {
      const labels = {
        'plate': 'מספר רכב',
        'manufacturer': 'יצרן',
        'model': 'דגם',
        'year': 'שנת יצור',
        'owner_name': 'שם בעלים',
        'insurance': 'חברת ביטוח'
      };
      return labels[fieldKey] || fieldKey;
    }

    // Edit in builder (redirect to builder)
    window.editInBuilder = function(fieldKey) {
      sessionStorage.setItem('editField', fieldKey);
      window.location.href = 'estimate-builder.html#vehicle-details';
    };

    // Ignore discrepancy
    window.ignoreDiscrepancy = function(fieldKey) {
      const currentElement = document.getElementById(`current-${fieldKey}`);
      currentElement.className = 'current-value data-match';
      
      // Remove ignore button
      const actionButtons = currentElement.parentElement.querySelector('.action-buttons');
      const ignoreBtn = actionButtons.querySelector('.ignore');
      if (ignoreBtn) {
        ignoreBtn.remove();
      }
      
      showAlert(`אי ההתאמה עבור "${getFieldLabel(fieldKey)}" התעלמה`, 'warning');
    };

    function updateSectionUI(sectionName, result) {
      const section = document.getElementById(`section-${sectionName}`);
      const status = section.querySelector('.section-status');
      const buttons = section.querySelectorAll('.btn');
      
      if (result.success) {
        section.classList.remove('current', 'error', 'warning');
        section.classList.add('completed');
        status.textContent = 'אומת ✓';
        status.className = 'section-status status-completed';
        
        // Enable approve button
        buttons[2].disabled = false;
        
        validationProgress[sectionName] = true;
        
      } else if (result.warnings > 0 && result.errors === 0) {
        section.classList.remove('current', 'error');
        section.classList.add('warning');
        status.textContent = 'אזהרות ⚠️';
        status.className = 'section-status status-warning';
        
        // Enable approve button with warning
        buttons[2].disabled = false;
        
      } else {
        section.classList.remove('current', 'completed', 'warning');
        section.classList.add('error');
        status.textContent = 'שגיאות ❌';
        status.className = 'section-status status-error';
        
        // Keep approve button disabled
        buttons[2].disabled = true;
      }
      
      // Always enable edit button after validation
      buttons[1].disabled = false;
      
      console.log(`Section ${sectionName} validation result:`, result);
    }

    function setSectionError(sectionName, errorMessage) {
      const section = document.getElementById(`section-${sectionName}`);
      const status = section.querySelector('.section-status');
      
      section.classList.remove('current', 'completed', 'warning');
      section.classList.add('error');
      status.textContent = 'שגיאה ❌';
      status.className = 'section-status status-error';
      
      showAlert(`שגיאה באימות ${sectionName}: ${errorMessage}`, 'error');
    }

    function updateValidationProgress() {
      const completedSections = Object.values(validationProgress).filter(v => v).length;
      const totalSections = Object.keys(validationProgress).length;
      const progressPercent = Math.round((completedSections / totalSections) * 100);
      
      document.getElementById('progress-fill').style.width = progressPercent + '%';
      document.getElementById('progress-text').textContent = progressPercent + '% הושלם';
      
      // Enable final approval if all sections are validated
      const finalBtn = document.getElementById('final-approve-btn');
      finalBtn.disabled = progressPercent < 100;
      
      if (progressPercent === 100) {
        showAlert('כל האימותים הושלמו בהצלחה! ניתן להמשיך לאישור סופי.', 'success');
      }
    }

    // Section Actions
    window.editSection = function(sectionName) {
      switch(sectionName) {
        case 'vehicle':
          window.location.href = 'estimate-builder.html#vehicle-details';
          break;
        case 'levi':
          window.location.href = 'upload-levi.html';
          break;
        case 'damage':
          window.location.href = 'damage-center-flow.html';
          break;
        case 'estimate':
          window.location.href = 'estimate-builder.html#estimate-type';
          break;
      }
    };

    window.approveSection = function(sectionName) {
      const section = document.getElementById(`section-${sectionName}`);
      const status = section.querySelector('.section-status');
      const button = section.querySelector('.btn-success');
      
      section.classList.remove('current', 'warning');
      section.classList.add('completed');
      status.textContent = 'אושר ✓';
      status.className = 'section-status status-completed';
      button.disabled = true;
      button.textContent = '✓ אושר';
      
      validationProgress[sectionName] = true;
      
      // Enable and move to next section
      const sections = ['vehicle', 'levi', 'damage', 'estimate'];
      const currentIndex = sections.indexOf(sectionName);
      
      if (currentIndex < sections.length - 1) {
        const nextSectionName = sections[currentIndex + 1];
        const nextSection = document.getElementById(`section-${nextSectionName}`);
        const nextStatus = nextSection.querySelector('.section-status');
        const nextButtons = nextSection.querySelectorAll('.btn');
        
        // Update next section to current
        nextSection.classList.remove('pending');
        nextSection.classList.add('current');
        nextStatus.textContent = 'בבדיקה';
        nextStatus.className = 'section-status status-current';
        
        // Enable buttons for next section
        nextButtons[0].disabled = false; // validate button
        nextButtons[1].disabled = false; // edit button
        
        // If next section needs enhanced display, populate it
        if (nextSectionName === 'levi') {
          populateLeviValidationItems();
        }
        
        // Auto-validate next section
        setTimeout(() => {
          validateSection(nextSectionName);
        }, 500);
        
        // Scroll to next section
        nextSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
      
      updateValidationProgress();
      showAlert(`${getSectionTitle(sectionName)} אושר בהצלחה! עובר לסעיף הבא...`, 'success');
      console.log(`Section ${sectionName} approved`);
    };
    
    function getSectionTitle(sectionName) {
      const titles = {
        'vehicle': 'פרטי רכב ומקרה',
        'levi': 'דו"ח לוי יצחק',
        'damage': 'מוקדי נזק',
        'estimate': 'חישובי אומדן'
      };
      return titles[sectionName] || sectionName;
    }

    // Create financial validation item with 5-column display
    function createFinancialValidationItem(label, currentValue, storedValue, calculationType, calculationValue, fieldKey, editType = 'inline') {
      // Clean and normalize values
      const cleanCurrent = currentValue && currentValue !== 'undefined' ? String(currentValue).trim() : '';
      const cleanStored = storedValue && storedValue !== 'undefined' && storedValue !== 'לא מוגדר' ? String(storedValue).trim() : '';
      
      const isMatch = cleanCurrent === cleanStored && cleanCurrent !== '';
      const hasStoredData = cleanStored !== '' && cleanStored !== 'לא מוגדר';
      
      let statusClass;
      if (isMatch) {
        statusClass = 'data-match';
      } else if (hasStoredData) {
        statusClass = 'data-warning';
      } else {
        statusClass = 'data-error';
      }
      
      return `
        <div class="validation-item-financial" data-field="${fieldKey}">
          <div class="financial-field-name">${label}</div>
          <div class="current-value ${statusClass}" id="current-${fieldKey}">
            ${cleanCurrent || 'לא זמין'}
          </div>
          <div class="stored-value">
            ${hasStoredData ? cleanStored : 'לא קיים בעזר'}
          </div>
          <div class="financial-calculation">
            ${calculationType ? `${calculationType}: ${calculationValue}` : 'לא חושב'}
          </div>
          <div class="action-buttons">
            ${editType === 'inline' ? 
              `<button class="edit-inline" onclick="startInlineEdit('${fieldKey}')">✏️</button>` : 
              `<button class="edit-builder" onclick="editInBuilder('${fieldKey}')">📝</button>`
            }
            ${!isMatch && (cleanCurrent || hasStoredData) ? `<button class="ignore" onclick="ignoreDiscrepancy('${fieldKey}')">🚫</button>` : ''}
          </div>
        </div>
      `;
    }

    // Enhanced validation items for Levi section
    function populateLeviValidationItems() {
      const container = document.getElementById('levi-validation-items');
      if (!container) return;
      
      const data = currentValidationData;
      const levi = data.levi_report || {};
      const helper = data.raw_helper;
      
      console.log('📄 Debug Levi data:', levi);
      
      // Base price
      const basePrice = levi.base_price || helper?.levi_report?.base_price || '';
      const storedBasePrice = helper?.levi_report?.base_price || helper?.base_price || '';
      
      // Market value (final price)
      const marketValue = levi.final_price || levi.market_value || helper?.levi_report?.final_price || '';
      const storedMarketValue = helper?.levi_report?.final_price || helper?.market_value || '';
      
      container.innerHTML = 
        createFinancialValidationItem(
          'מחיר בסיס', 
          basePrice, 
          storedBasePrice, 
          'בסיס', 
          basePrice ? `₪${parseFloat(basePrice).toLocaleString()}` : '₪0',
          'levi_base_price'
        ) +
        createFinancialValidationItem(
          'שווי שוק סופי', 
          marketValue, 
          storedMarketValue, 
          'סופי', 
          marketValue ? `₪${parseFloat(marketValue).toLocaleString()}` : '₪0',
          'levi_market_value'
        );
      
      // Add adjustment items if they exist
      if (levi.adjustments) {
        let adjustmentsHTML = '';
        Object.keys(levi.adjustments).forEach(key => {
          const adjustment = levi.adjustments[key];
          if (adjustment && (adjustment.percentage || adjustment.value)) {
            const adjType = adjustment.percentage > 0 ? 'תוספת' : 'הפחתה';
            const adjCalc = `${Math.abs(adjustment.percentage || 0)}% = ₪${Math.abs(adjustment.value || 0).toLocaleString()}`;
            
            adjustmentsHTML += createFinancialValidationItem(
              key,
              adjustment.value ? `₪${adjustment.value.toLocaleString()}` : '',
              adjustment.value ? `₪${adjustment.value.toLocaleString()}` : '',
              adjType,
              adjCalc,
              `levi_adj_${key.replace(/\s+/g, '_')}`
            );
          }
        });
        container.innerHTML += adjustmentsHTML;
      }
    }

    function populateDamageValidationItems() {
      console.log('🔧 Implementing enhanced damage section validation items');
      
      // For damage section, we'll enhance the existing validation 
      // but keep the current structure since it's already functional
      const damageBlocks = currentValidationData.damage_blocks || [];
      
      if (damageBlocks.length > 0) {
        displayDamageCentersEnhanced(damageBlocks);
        console.log('✅ Damage centers displayed with enhanced validation');
      } else {
        console.log('⚠️ No damage blocks found for validation');
      }
    }

    function populateEstimateValidationItems() {
      console.log('📊 Implementing enhanced estimate section validation items');
      
      // For estimate section, ensure all calculations are properly validated
      const totals = currentValidationData.estimate_totals || {};
      const helper = currentValidationData.raw_helper;
      
      // Update all estimate calculation displays
      if (totals.total_before_vat !== undefined) {
        updateElementIfExists('estimate-base-damage', MathEngine ? MathEngine.formatCurrency(totals.total_before_vat) : `₪${totals.total_before_vat.toLocaleString()}`);
      }
      
      if (totals.total_with_vat !== undefined) {
        const vatAmount = totals.total_with_vat - totals.total_before_vat;
        updateElementIfExists('estimate-vat-amount', MathEngine ? MathEngine.formatCurrency(vatAmount) : `₪${vatAmount.toLocaleString()}`);
        updateElementIfExists('estimate-total-claim', MathEngine ? MathEngine.formatCurrency(totals.total_with_vat) : `₪${totals.total_with_vat.toLocaleString()}`);
      }
      
      console.log('✅ Estimate calculations updated and enhanced validation applied');
    }

    // Other Actions
    window.validateLegalText = function() {
      const legalText = document.getElementById('legal-text-content').value;
      if (legalText && legalText.length > 50) {
        showAlert('הטקסט המשפטי תקין', 'success');
      } else {
        showAlert('הטקסט המשפטי קצר מדי או לא תקין', 'warning');
      }
    };

    window.editLegalText = function() {
      window.location.href = 'estimate-builder.html#legal-text';
    };

    window.requestManualReview = function() {
      showAlert('בקשה לסקירה ידנית נרשמה במערכת', 'warning');
      // Could send to webhook for manual review request
    };

    window.saveValidationData = function() {
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        // Update validation data
        helper.validation = {
          completed_sections: Object.keys(validationProgress).filter(k => validationProgress[k]),
          legal_text: document.getElementById('legal-text-content').value,
          validated_at: new Date().toISOString(),
          validated_by: 'user',
          validation_progress: validationProgress
        };

        sessionStorage.setItem('helper', JSON.stringify(helper));
        showAlert('נתוני האימות נשמרו בהצלחה', 'success');
        
      } catch (error) {
        console.error('Error saving validation data:', error);
        showAlert('שגיאה בשמירת נתוני האימות', 'error');
      }
    };

    window.reviewEstimateReport = function() {
      const finalBtn = document.getElementById('final-approve-btn');
      
      try {
        // Save validation data before proceeding
        saveValidationData();
        
        // Set validation as completed
        sessionStorage.setItem('estimateValidationCompleted', 'true');
        
        // Show loading state briefly
        finalBtn.disabled = true;
        finalBtn.textContent = 'עובר לבדיקת אומדן...';
        
        showAlert('מעבר לבדיקת האומדן הסופי...', 'success');
        
        // Redirect to estimate report builder
        setTimeout(() => {
          window.location.href = 'estimate-report-builder.html';
        }, 1000);
        
      } catch (error) {
        console.error('Error proceeding to report review:', error);
        finalBtn.disabled = false;
        finalBtn.textContent = '📋 בדיקת אומדן סופי';
        showAlert('שגיאה במעבר לבדיקת אומדן: ' + error.message, 'error');
      }
    };

    function showAlert(message, type = 'success') {
      const alertsContainer = document.getElementById('alerts');
      const alert = document.createElement('div');
      alert.className = `alert ${type} show`;
      alert.textContent = message;
      alertsContainer.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    // Functions are already globally available through window.functionName definitions above
  </script>
</body>
</html>