<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>אימות אומדן - ירון כיוף שמאות</title>
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  
  <!-- OneSignal Push -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">

  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "3b924b99-c302-4919-a97e-baf909394696",
      });
    });
  </script>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      margin: 0;
      padding: 20px;
      direction: rtl;
      text-align: right;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #1e3a8a 0%, #475569 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .logo {
      width: 60px;
      height: 60px;
      margin: 0 auto 20px;
      border-radius: 50%;
      background: white;
      padding: 5px;
      display: block;
    }

    .business-name {
      font-size: 24px;
      font-weight: 600;
      margin: 15px 0 5px 0;
      color: white;
    }

    .business-subtitle {
      font-size: 16px;
      opacity: 0.9;
      margin: 0 0 15px 0;
      color: #e2e8f0;
    }

    .page-title {
      font-size: 28px;
      font-weight: 300;
      margin: 15px 0 0 0;
      color: white;
      border-top: 1px solid rgba(255,255,255,0.3);
      padding-top: 15px;
    }

    .content {
      padding: 30px;
    }

    .validation-section {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      transition: all 0.3s ease;
    }

    .validation-section.completed {
      border-color: #16a34a;
      background: #f0fdf4;
    }

    .validation-section.current {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    .validation-section.error {
      border-color: #dc2626;
      background: #fef2f2;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 20px;
      font-weight: bold;
      color: #1e3a8a;
    }

    .section-status {
      padding: 6px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }

    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .status-current {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .status-completed {
      background: #dcfce7;
      color: #166534;
    }

    .status-error {
      background: #fecaca;
      color: #991b1b;
    }

    .validation-content {
      color: #475569;
      line-height: 1.6;
    }

    .validation-item {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .validation-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .validation-item-title {
      font-weight: 600;
      color: #1e3a8a;
    }

    .validation-check {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }

    .check-pass {
      background: #16a34a;
      color: white;
    }

    .check-fail {
      background: #dc2626;
      color: white;
    }

    .check-warning {
      background: #f59e0b;
      color: white;
    }

    .editable-field {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      margin-top: 8px;
      box-sizing: border-box;
    }

    .editable-field:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .legal-text-section {
      background: #fef3c7;
      border: 2px solid #f59e0b;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
    }

    .legal-text-header {
      font-size: 18px;
      font-weight: bold;
      color: #92400e;
      margin-bottom: 15px;
    }

    .legal-text-content {
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 15px;
      min-height: 150px;
      font-size: 14px;
      line-height: 1.6;
      resize: vertical;
      width: 100%;
      box-sizing: border-box;
    }

    .damage-center-validation {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .damage-center-header {
      background: #f1f5f9;
      padding: 10px 15px;
      margin: -15px -15px 15px -15px;
      border-radius: 8px 8px 0 0;
      font-weight: bold;
      color: #1e3a8a;
    }

    .damage-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 10px;
    }

    .stat-item {
      text-align: center;
      padding: 10px;
      background: #f8fafc;
      border-radius: 6px;
    }

    .stat-label {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: #1e3a8a;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 40px;
      padding: 30px;
      background: #f8f9fa;
      border-radius: 10px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #1e3a8a);
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #1e3a8a, #1e40af);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #64748b, #475569);
      color: white;
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #475569, #334155);
      transform: translateY(-2px);
    }

    .btn-success {
      background: linear-gradient(135deg, #16a34a, #15803d);
      color: white;
    }

    .btn-success:hover {
      background: linear-gradient(135deg, #15803d, #166534);
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .progress-indicator {
      background: #f1f5f9;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 25px;
    }

    .progress-bar {
      background: #e2e8f0;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      background: linear-gradient(90deg, #3b82f6, #1e3a8a);
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .footer {
      background: #1e3a8a;
      color: white;
      text-align: center;
      padding: 20px;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      .container {
        margin: 10px;
        border-radius: 10px;
      }
      
      .content {
        padding: 20px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .damage-stats {
        grid-template-columns: 1fr 1fr;
      }
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .alert.show {
      display: block;
    }

    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alert.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo" class="logo">
      <div class="business-name">ירון כיוף שמאות - פורטל</div>
      <div class="business-subtitle">שמאות והערכת נזקי רכב ורכוש</div>
      <div class="page-title">אימות אומדן נזקי רכב</div>
    </div>

    <div class="content">
      <div id="alerts"></div>
      
      <!-- Progress Indicator -->
      <div class="progress-indicator">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <span style="font-weight: 600; color: #1e3a8a;">התקדמות האימות</span>
          <span id="progress-text">0% הושלם</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
      </div>

      <!-- System Level Validation -->
      <div class="validation-section" id="system-validation">
        <div class="section-header">
          <div class="section-title">אימות ברמת המערכת</div>
          <div class="section-status status-current" id="system-status">בבדיקה</div>
        </div>
        <div class="validation-content">
          
          <!-- Car + General Details -->
          <div class="validation-item" id="car-details-validation">
            <div class="validation-item-header">
              <div class="validation-item-title">פרטי רכב וכלליים</div>
              <div class="validation-check check-pass" id="car-details-check">✓</div>
            </div>
            <div id="car-details-content">
              <label>מספר רכב:</label>
              <input type="text" class="editable-field" id="plate-number" readonly>
              
              <label>יצרן:</label>
              <input type="text" class="editable-field" id="manufacturer">
              
              <label>דגם:</label>
              <input type="text" class="editable-field" id="model">
              
              <label>שנת יצור:</label>
              <input type="text" class="editable-field" id="year">
            </div>
          </div>

          <!-- Levi Report Upload -->
          <div class="validation-item" id="levi-validation">
            <div class="validation-item-header">
              <div class="validation-item-title">העלאת דו"ח לוי יצחק</div>
              <div class="validation-check check-warning" id="levi-check">!</div>
            </div>
            <div id="levi-content">
              <label>סטטוס דו"ח לוי:</label>
              <select class="editable-field" id="levi-status">
                <option value="uploaded">הועלה</option>
                <option value="missing">חסר</option>
                <option value="not-required">לא נדרש</option>
              </select>
            </div>
          </div>

          <!-- Damage Centers Validation -->
          <div class="validation-item" id="damage-centers-validation">
            <div class="validation-item-header">
              <div class="validation-item-title">מוקדי נזק</div>
              <div class="validation-check check-pass" id="damage-centers-check">✓</div>
            </div>
            <div id="damage-centers-content">
              <!-- Will be populated dynamically -->
            </div>
          </div>

          <!-- Summary Validation -->
          <div class="validation-item" id="summary-validation">
            <div class="validation-item-header">
              <div class="validation-item-title">סיכום וסטטוס</div>
              <div class="validation-check check-pass" id="summary-check">✓</div>
            </div>
            <div id="summary-content">
              <label>סטטוס:</label>
              <select class="editable-field" id="case-status">
                <option value="ready">מוכן לאומדן</option>
                <option value="incomplete">לא הושלם</option>
                <option value="requires-review">דרוש סקירה</option>
              </select>
              
              <label>הערות:</label>
              <textarea class="editable-field" id="case-comments" rows="3" placeholder="הוסף הערות לגבי התיק..."></textarea>
            </div>
          </div>

        </div>
      </div>

      <!-- Legal Text Validation -->
      <div class="legal-text-section">
        <div class="legal-text-header">אימות טקסט משפטי</div>
        <div style="margin-bottom: 15px; color: #92400e;">
          הטקסט המשפטי להלן ייכלל באומדן. ניתן לערוך ולהתאים לפי הצורך.
        </div>
        <textarea class="legal-text-content" id="legal-text-content" placeholder="טקסט משפטי ייטען כאן..."></textarea>
      </div>

      <!-- User Level Validation -->
      <div class="validation-section" id="user-validation">
        <div class="section-header">
          <div class="section-title">אימות ברמת המשתמש</div>
          <div class="section-status status-pending" id="user-status">ממתין לאישור</div>
        </div>
        <div class="validation-content">
          <p>בדוק את כל הנתונים לעיל ותקן במידת הצורך. כל השדות ניתנים לעריכה ויכולים להיות מתועלמים במידת הצורך.</p>
          
          <div style="background: #eff6ff; padding: 15px; border-radius: 8px; margin-top: 15px;">
            <strong>הערה חשובה:</strong> שינויים שתבצע כאן יהפכו לאמת המערכת ויורשמו באומדן הסופי.
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button type="button" id="save-validation" class="btn btn-secondary">
          💾 שמור שינויים
        </button>
        <button type="button" id="confirm-validation" class="btn btn-success" disabled>
          ✅ אשר ועבור לבניית אומדן
        </button>
        <button type="button" onclick="window.location.href='estimate-builder.html'" class="btn btn-secondary">
          ⬅️ חזור לבונה אומדן
        </button>
        <button type="button" onclick="window.location.href='selection.html'" class="btn btn-secondary">
          🏠 חזור לדף הבית
        </button>
      </div>
    </div>
    
    <div class="footer">
      All rights reserved © Carmel Cayouf
    </div>
  </div>

  <script type="module">
    import { helper, updateHelper } from './helper.js';
    import { loadLegalText } from './vault-loader.js';
    
    let validationData = {};
    let currentProgress = 0;

    // Authentication check
    document.addEventListener('DOMContentLoaded', () => {
      console.log('🔄 Estimate Validation: Initializing...');
      
      const auth = sessionStorage.getItem("auth");
      if (!auth) {
        console.error('❌ No authentication found');
        showAlert("הגישה חסומה - אנא התחבר דרך דף הבית", 'error');
        setTimeout(() => {
          window.location.href = "index.html";
        }, 2000);
        return;
      }

      const helperData = sessionStorage.getItem('helper');
      const selectedReportType = sessionStorage.getItem('selectedReportType');
      
      if (!helperData || selectedReportType !== 'estimate') {
        console.error('❌ Missing required data for validation');
        showAlert('שגיאה: נתונים חסרים לאימות. חוזר לדף הבחירה...', 'error');
        setTimeout(() => {
          window.location.href = 'selection.html';
        }, 2000);
        return;
      }

      console.log('✅ Estimate Validation: Authentication and data validated');
      initializeValidation();
    });

    function initializeValidation() {
      loadSystemValidation();
      loadLegalTextValidation();
      setupEventListeners();
      updateProgress();
    }

    function loadSystemValidation() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Load car details
      const carDetails = helper.car_details || {};
      const meta = helper.meta || {};
      
      document.getElementById('plate-number').value = meta.plate || carDetails.plate || '';
      document.getElementById('manufacturer').value = carDetails.manufacturer || '';
      document.getElementById('model').value = carDetails.model || '';
      document.getElementById('year').value = carDetails.year || '';

      // Load damage centers
      loadDamageCenters(helper.damage_sections || []);
      
      // Validate all sections
      validateCarDetails();
      validateLeviReport();
      validateDamageCenters();
      validateSummary();
    }

    function loadDamageCenters(damageSections) {
      const container = document.getElementById('damage-centers-content');
      
      if (!damageSections || damageSections.length === 0) {
        container.innerHTML = '<p style="color: #dc2626;">לא נמצאו מוקדי נזק באקספרטיזה</p>';
        return;
      }

      container.innerHTML = damageSections.map((center, index) => `
        <div class="damage-center-validation">
          <div class="damage-center-header">מוקד נזק ${index + 1}: ${center.zone || 'לא מוגדר'}</div>
          
          <label>שם:</label>
          <input type="text" class="editable-field" value="${center.zone || ''}" data-field="zone" data-index="${index}">
          
          <label>תיאור:</label>
          <input type="text" class="editable-field" value="${center.zone_description || ''}" data-field="description" data-index="${index}">
          
          <div class="damage-stats">
            <div class="stat-item">
              <div class="stat-label">עבודות</div>
              <div class="stat-value">${center.works?.length || 0}</div>
              <input type="number" class="editable-field" value="${calculateWorksTotal(center.works)}" data-field="works_total" data-index="${index}" placeholder="סה״כ עלות עבודות">
            </div>
            <div class="stat-item">
              <div class="stat-label">חלקים</div>
              <div class="stat-value">${center.parts?.length || 0}</div>
              <input type="number" class="editable-field" value="${calculatePartsTotal(center.parts)}" data-field="parts_total" data-index="${index}" placeholder="סה״כ עלות חלקים">
            </div>
            <div class="stat-item">
              <div class="stat-label">תיקונים</div>
              <div class="stat-value">${center.repairs?.length || 0}</div>
              <input type="number" class="editable-field" value="${calculateRepairsTotal(center.repairs)}" data-field="repairs_total" data-index="${index}" placeholder="סה״כ עלות תיקונים">
            </div>
          </div>
        </div>
      `).join('');
    }

    function calculateWorksTotal(works) {
      if (!works || !Array.isArray(works)) return 0;
      return works.reduce((total, work) => total + (parseFloat(work.cost) || 0), 0);
    }

    function calculatePartsTotal(parts) {
      if (!parts || !Array.isArray(parts)) return 0;
      return parts.reduce((total, part) => total + (parseFloat(part.cost) || 0), 0);
    }

    function calculateRepairsTotal(repairs) {
      if (!repairs || !Array.isArray(repairs)) return 0;
      return repairs.reduce((total, repair) => total + (parseFloat(repair.cost) || 0), 0);
    }

    async function loadLegalTextValidation() {
      try {
        // Get estimate type from session
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        const estimateType = helper.estimate_type || 'אובדן_להלכה';
        
        // Load legal text from existing vault
        const legalText = await loadLegalText(`estimate_${estimateType}`);
        document.getElementById('legal-text-content').value = legalText || 'טקסט משפטי לא נמצא';
      } catch (error) {
        console.error('Error loading legal text:', error);
        document.getElementById('legal-text-content').value = 'שגיאה בטעינת הטקסט המשפטי';
      }
    }

    function validateCarDetails() {
      const plate = document.getElementById('plate-number').value;
      const manufacturer = document.getElementById('manufacturer').value;
      
      const isValid = plate && manufacturer;
      updateValidationCheck('car-details-check', isValid);
      return isValid;
    }

    function validateLeviReport() {
      const leviStatus = document.getElementById('levi-status').value;
      const isValid = leviStatus !== 'missing';
      updateValidationCheck('levi-check', isValid, leviStatus === 'not-required' ? 'warning' : 'pass');
      return isValid;
    }

    function validateDamageCenters() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      const damageSections = helper.damage_sections || [];
      const isValid = damageSections.length > 0;
      updateValidationCheck('damage-centers-check', isValid);
      return isValid;
    }

    function validateSummary() {
      const status = document.getElementById('case-status').value;
      const isValid = status === 'ready';
      updateValidationCheck('summary-check', isValid, status === 'requires-review' ? 'warning' : (isValid ? 'pass' : 'fail'));
      return isValid;
    }

    function updateValidationCheck(checkId, isValid, type = null) {
      const check = document.getElementById(checkId);
      if (!check) return;

      check.className = 'validation-check';
      
      if (type === 'warning') {
        check.classList.add('check-warning');
        check.textContent = '!';
      } else if (isValid) {
        check.classList.add('check-pass');
        check.textContent = '✓';
      } else {
        check.classList.add('check-fail');
        check.textContent = '✗';
      }
    }

    function updateProgress() {
      const validations = [
        validateCarDetails(),
        validateLeviReport(),
        validateDamageCenters(),
        validateSummary()
      ];
      
      const completedCount = validations.filter(v => v).length;
      currentProgress = Math.round((completedCount / validations.length) * 100);
      
      document.getElementById('progress-fill').style.width = currentProgress + '%';
      document.getElementById('progress-text').textContent = currentProgress + '% הושלם';
      
      // Enable confirm button when validation is complete
      const confirmBtn = document.getElementById('confirm-validation');
      confirmBtn.disabled = currentProgress < 100;
      
      // Update section statuses
      if (currentProgress === 100) {
        document.getElementById('system-status').textContent = 'הושלם';
        document.getElementById('system-status').className = 'section-status status-completed';
        document.getElementById('system-validation').classList.add('completed');
      }
    }

    function setupEventListeners() {
      // Save validation data
      document.getElementById('save-validation').addEventListener('click', saveValidationData);
      
      // Confirm and proceed
      document.getElementById('confirm-validation').addEventListener('click', confirmAndProceed);
      
      // Update validation on field changes
      document.addEventListener('change', (e) => {
        if (e.target.classList.contains('editable-field')) {
          updateProgress();
        }
      });

      // Auto-save on input
      document.addEventListener('input', (e) => {
        if (e.target.classList.contains('editable-field')) {
          saveValidationData();
        }
      });
    }

    function saveValidationData() {
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        // Update car details
        helper.car_details = helper.car_details || {};
        helper.car_details.manufacturer = document.getElementById('manufacturer').value;
        helper.car_details.model = document.getElementById('model').value;
        helper.car_details.year = document.getElementById('year').value;
        
        // Update validation data
        helper.validation = {
          levi_status: document.getElementById('levi-status').value,
          case_status: document.getElementById('case-status').value,
          case_comments: document.getElementById('case-comments').value,
          legal_text: document.getElementById('legal-text-content').value,
          validated_at: new Date().toISOString(),
          validated_by: 'user'
        };

        // Update damage centers with validation data
        const damageInputs = document.querySelectorAll('[data-field]');
        damageInputs.forEach(input => {
          const field = input.dataset.field;
          const index = parseInt(input.dataset.index);
          
          if (helper.damage_sections && helper.damage_sections[index]) {
            if (field === 'zone') {
              helper.damage_sections[index].zone = input.value;
            } else if (field === 'description') {
              helper.damage_sections[index].zone_description = input.value;
            } else if (field.endsWith('_total')) {
              helper.damage_sections[index][field] = parseFloat(input.value) || 0;
            }
          }
        });

        sessionStorage.setItem('helper', JSON.stringify(helper));
        showAlert('נתוני האימות נשמרו בהצלחה', 'success');
        
      } catch (error) {
        console.error('Error saving validation data:', error);
        showAlert('שגיאה בשמירת נתוני האימות', 'error');
      }
    }

    function confirmAndProceed() {
      if (currentProgress < 100) {
        showAlert('יש להשלים את כל האימותים לפני המעבר הלאה', 'warning');
        return;
      }

      saveValidationData();
      
      // Set validation as completed
      sessionStorage.setItem('estimateValidationCompleted', 'true');
      
      showAlert('אימות הושלם בהצלחה! עובר לבניית אומדן...', 'success');
      
      setTimeout(() => {
        window.location.href = 'estimate-report-builder.html';
      }, 1500);
    }

    function showAlert(message, type = 'success') {
      const alertsContainer = document.getElementById('alerts');
      const alert = document.createElement('div');
      alert.className = `alert ${type} show`;
      alert.textContent = message;
      alertsContainer.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    // Make functions globally available
    window.saveValidationData = saveValidationData;
    window.confirmAndProceed = confirmAndProceed;
  </script>
</body>
</html>