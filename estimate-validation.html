<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××™××•×ª ××•××“×Ÿ - ×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª</title>
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  
  <!-- OneSignal Push -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">

  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "3b924b99-c302-4919-a97e-baf909394696",
      });
    });
  </script>

  <style>
    body {
      font-family: sans-serif;
      background: #f3f6fb;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      max-width: 1000px;
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      width: 100%;
    }
    .logo img {
      width: 120px;
      margin-bottom: 20px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .title {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 5px;
      color: #1e3a8a;
    }
    .subtitle {
      font-size: 18px;
      color: #64748b;
      text-align: center;
      margin-bottom: 30px;
    }
    h1 {
      font-size: 22px;
      color: #1e3a8a;
      text-align: center;
      margin-bottom: 30px;
    }
    .validation-section {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }
    .validation-section.completed {
      border-color: #16a34a;
      background: #f0fdf4;
    }
    .validation-section.current {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    .validation-section.error {
      border-color: #dc2626;
      background: #fef2f2;
    }
    .validation-section.warning {
      border-color: #f59e0b;
      background: #fefbf2;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .section-title {
      font-size: 18px;
      font-weight: bold;
      color: #1e3a8a;
    }
    .section-status {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }
    .status-current {
      background: #dbeafe;
      color: #1d4ed8;
    }
    .status-completed {
      background: #dcfce7;
      color: #166534;
    }
    .status-error {
      background: #fecaca;
      color: #991b1b;
    }
    .status-warning {
      background: #fef3c7;
      color: #92400e;
    }
    .section-content {
      color: #475569;
      line-height: 1.6;
    }
    .validation-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #e2e8f0;
    }
    .validation-item:last-child {
      border-bottom: none;
    }
    .validation-label {
      font-weight: 500;
      color: #374151;
    }
    .validation-value {
      font-weight: 600;
      color: #1e3a8a;
    }
    .validation-status {
      font-size: 18px;
    }
    .cost-summary {
      background: #f1f5f9;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    .cost-summary-title {
      font-size: 16px;
      font-weight: bold;
      color: #1e3a8a;
      margin-bottom: 10px;
    }
    .cost-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .cost-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
    }
    .cost-label {
      color: #64748b;
    }
    .cost-value {
      font-weight: 600;
      color: #1e3a8a;
    }
    .validation-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      flex: 1;
      min-width: 120px;
    }
    .btn-validate {
      background: #3b82f6;
      color: white;
    }
    .btn-validate:hover {
      background: #1e40af;
    }
    .btn-edit {
      background: #64748b;
      color: white;
    }
    .btn-edit:hover {
      background: #475569;
    }
    .btn-success {
      background: #16a34a;
      color: white;
    }
    .btn-success:hover {
      background: #15803d;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .damage-center {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .damage-center-header {
      font-weight: bold;
      color: #1e3a8a;
      margin-bottom: 10px;
      border-bottom: 1px solid #e2e8f0;
      padding-bottom: 5px;
    }
    .damage-center-content {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
      margin-top: 10px;
    }
    .damage-stat {
      text-align: center;
      padding: 10px;
      background: #f8fafc;
      border-radius: 6px;
    }
    .damage-stat-label {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 5px;
    }
    .damage-stat-value {
      font-size: 16px;
      font-weight: bold;
      color: #1e3a8a;
    }
    .levi-adjustments {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    .levi-adjustments-title {
      font-weight: bold;
      color: #1e3a8a;
      margin-bottom: 10px;
    }
    .adjustment-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid #f1f5f9;
    }
    .adjustment-item:last-child {
      border-bottom: none;
    }
    .legal-text-section {
      background: #fef3c7;
      border: 2px solid #f59e0b;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }
    .legal-text-header {
      font-size: 18px;
      font-weight: bold;
      color: #92400e;
      margin-bottom: 15px;
    }
    .legal-text-content {
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 15px;
      min-height: 150px;
      font-size: 14px;
      line-height: 1.6;
      resize: vertical;
      width: 100%;
      box-sizing: border-box;
    }
    .user-validation-section {
      background: #eff6ff;
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 25px;
      margin: 20px 0;
    }
    .user-validation-header {
      font-size: 18px;
      font-weight: bold;
      color: #1e3a8a;
      margin-bottom: 15px;
    }
    .final-actions {
      background: #f1f5f9;
      border-radius: 12px;
      padding: 25px;
      text-align: center;
      margin-top: 30px;
    }
    .progress-indicator {
      background: #f1f5f9;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 25px;
    }
    .progress-bar {
      background: #e2e8f0;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-fill {
      background: linear-gradient(90deg, #3b82f6, #1e3a8a);
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    .footer {
      text-align: center;
      margin-top: 30px;
      font-size: 12px;
      color: #64748b;
    }
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        padding: 20px;
      }
      .cost-grid, .damage-center-content {
        grid-template-columns: 1fr;
      }
      .validation-buttons {
        flex-direction: column;
      }
    }
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }
    .alert.show {
      display: block;
    }
    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .alert.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo" />
    </div>
    <div class="title">×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×¤×•×¨×˜×œ</div>
    <div class="subtitle">×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</div>
    
    <h1>××™××•×ª ××•××“×Ÿ × ×–×§×™ ×¨×›×‘ - ××¢×¨×›×ª ×‘×“×™×§×” ××™× ×˜×œ×™×’× ×˜×™×ª</h1>
    
    <div id="alerts"></div>
    
    <!-- Progress Indicator -->
    <div class="progress-indicator">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <span style="font-weight: 600; color: #1e3a8a;">×”×ª×§×“××•×ª ×”××™××•×ª</span>
        <span id="progress-text">0% ×”×•×©×œ×</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
      </div>
    </div>

    <!-- Vehicle and Case Details Validation -->
    <div class="validation-section current" id="section-vehicle">
      <div class="section-header">
        <div class="section-title">×¤×¨×˜×™ ×¨×›×‘ ×•××§×¨×”</div>
        <div class="section-status status-current">×‘×‘×“×™×§×”</div>
      </div>
      <div class="section-content">
        <div class="validation-item">
          <span class="validation-label">××¡×¤×¨ ×¨×›×‘ ×××•××ª</span>
          <span class="validation-status" id="vehicle-plate">â³</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">×¤×¨×˜×™ ×™×¦×¨×Ÿ ×•×“×’×</span>
          <span class="validation-status" id="vehicle-details">â³</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">×©× ×ª ×™×¦×•×¨ ×•××¤×¨×˜×™×</span>
          <span class="validation-status" id="vehicle-specs">â³</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">×¤×¨×˜×™ ×‘×¢×œ×™× ×•×ª×§×©×•×¨×ª</span>
          <span class="validation-status" id="vehicle-owner">â³</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">×¤×¨×˜×™ ×‘×™×˜×•×— ×•×¡×•×›×Ÿ</span>
          <span class="validation-status" id="vehicle-insurance">â³</span>
        </div>
      </div>
      <div class="validation-buttons">
        <button class="btn btn-validate" onclick="validateSection('vehicle')">×‘×“×•×§ ××•×˜×•××˜×™×ª</button>
        <button class="btn btn-edit" onclick="editSection('vehicle')">×¢×¨×™×›×” ×™×“× ×™×ª</button>
        <button class="btn btn-success" onclick="approveSection('vehicle')" disabled>××™××•×ª ×¤×¨×˜×™ ×¨×›×‘</button>
      </div>
    </div>

    <!-- Levi Report Validation -->
    <div class="validation-section" id="section-levi">
      <div class="section-header">
        <div class="section-title">×“×•"×— ×œ×•×™ ×™×¦×—×§ - ×©×•×•×™ ×¨×›×‘</div>
        <div class="section-status status-pending">×××ª×™×Ÿ</div>
      </div>
      <div class="section-content">
        <div class="validation-item">
          <span class="validation-label">×§×•×“ ×“×’× ×•××™××•×ª ××•×“×œ</span>
          <span class="validation-status" id="levi-model">â³</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">××—×™×¨ ×‘×¡×™×¡ ×××•×©×¨</span>
          <span class="validation-status" id="levi-base-price">â³</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">×©×•×•×™ ×©×•×§ ×¡×•×¤×™</span>
          <span class="validation-status" id="levi-final-price">â³</span>
        </div>
        
        <!-- Levi Adjustments Display -->
        <div class="levi-adjustments" id="levi-adjustments-container" style="display:none;">
          <div class="levi-adjustments-title">×”×ª×××•×ª ××—×™×¨ ××“×•"×— ×œ×•×™ ×™×¦×—×§</div>
          <div id="levi-adjustments-content">
            <!-- Will be populated dynamically -->
          </div>
        </div>
        
        <!-- Cost Summary -->
        <div class="cost-summary">
          <div class="cost-summary-title">×¡×™×›×•× ×©×•×•×™ ×¨×›×‘</div>
          <div class="cost-grid">
            <div class="cost-item">
              <span class="cost-label">××—×™×¨ ×‘×¡×™×¡:</span>
              <span class="cost-value" id="levi-display-base">â‚ª0</span>
            </div>
            <div class="cost-item">
              <span class="cost-label">×¡×”"×› ×”×ª×××•×ª:</span>
              <span class="cost-value" id="levi-display-adjustments">â‚ª0</span>
            </div>
            <div class="cost-item">
              <span class="cost-label">×©×•×•×™ ×©×•×§ ×¡×•×¤×™:</span>
              <span class="cost-value" id="levi-display-final">â‚ª0</span>
            </div>
          </div>
        </div>
      </div>
      <div class="validation-buttons">
        <button class="btn btn-validate" onclick="validateSection('levi')" disabled>×‘×“×•×§ ××•×˜×•××˜×™×ª</button>
        <button class="btn btn-edit" onclick="editSection('levi')" disabled>×¢×¨×™×›×” ×™×“× ×™×ª</button>
        <button class="btn btn-success" onclick="approveSection('levi')" disabled>××™××•×ª ×“×•"×— ×œ×•×™</button>
      </div>
    </div>

    <!-- Damage Centers Validation -->
    <div class="validation-section" id="section-damage">
      <div class="section-header">
        <div class="section-title">××•×§×“×™ × ×–×§ ×•××§×¡×¤×¨×˜×™×–×”</div>
        <div class="section-status status-pending">×××ª×™×Ÿ</div>
      </div>
      <div class="section-content">
        <div class="validation-item">
          <span class="validation-label">××¡×¤×¨ ××•×§×“×™ × ×–×§ ××•×’×“×¨×™×</span>
          <span class="validation-status" id="damage-centers-count">â³</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">×¤×™×¨×•×˜ ×¢×‘×•×“×•×ª ×•×ª×™×§×•× ×™×</span>
          <span class="validation-status" id="damage-works">â³</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">×¨×©×™××ª ×—×œ×§×™× × ×“×¨×©×™×</span>
          <span class="validation-status" id="damage-parts">â³</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">×—×™×©×•×‘ ×¢×œ×•×™×•×ª ×›×•×œ×œ</span>
          <span class="validation-status" id="damage-costs">â³</span>
        </div>
        
        <!-- Damage Centers Display -->
        <div id="damage-centers-container">
          <!-- Will be populated dynamically -->
        </div>
        
        <!-- Total Damage Cost Summary -->
        <div class="cost-summary">
          <div class="cost-summary-title">×¡×™×›×•× ×¢×œ×•×™×•×ª × ×–×§×™×</div>
          <div class="cost-grid">
            <div class="cost-item">
              <span class="cost-label">×¡×”"×› ×¢×‘×•×“×•×ª:</span>
              <span class="cost-value" id="damage-total-works">â‚ª0</span>
            </div>
            <div class="cost-item">
              <span class="cost-label">×¡×”"×› ×—×œ×§×™×:</span>
              <span class="cost-value" id="damage-total-parts">â‚ª0</span>
            </div>
            <div class="cost-item">
              <span class="cost-label">×¡×”"×› ×ª×™×§×•× ×™×:</span>
              <span class="cost-value" id="damage-total-repairs">â‚ª0</span>
            </div>
            <div class="cost-item" style="border-top: 2px solid #3b82f6; padding-top: 10px; margin-top: 10px;">
              <span class="cost-label" style="font-weight: bold;">×¡×”"×› × ×–×§×™× ×œ×œ× ××¢"×:</span>
              <span class="cost-value" style="font-size: 18px; color: #dc2626;" id="damage-total-before-vat">â‚ª0</span>
            </div>
            <div class="cost-item" style="padding-top: 10px;">
              <span class="cost-label" style="font-weight: bold;">×¡×”"×› × ×–×§×™× ×›×•×œ×œ ××¢"×:</span>
              <span class="cost-value" style="font-size: 18px; color: #16a34a;" id="damage-total-with-vat">â‚ª0</span>
            </div>
          </div>
        </div>
      </div>
      <div class="validation-buttons">
        <button class="btn btn-validate" onclick="validateSection('damage')" disabled>×‘×“×•×§ ××•×˜×•××˜×™×ª</button>
        <button class="btn btn-edit" onclick="editSection('damage')" disabled>×¢×¨×™×›×” ×™×“× ×™×ª</button>
        <button class="btn btn-success" onclick="approveSection('damage')" disabled>××™××•×ª ××•×§×“×™ × ×–×§</button>
      </div>
    </div>

    <!-- Estimate Type and Calculations -->
    <div class="validation-section" id="section-estimate">
      <div class="section-header">
        <div class="section-title">×¡×•×’ ××•××“×Ÿ ×•×—×™×©×•×‘×™×</div>
        <div class="section-status status-pending">×××ª×™×Ÿ</div>
      </div>
      <div class="section-content">
        <div class="validation-item">
          <span class="validation-label">×¡×•×’ ××•××“×Ÿ ××•×’×“×¨</span>
          <span class="validation-status" id="estimate-type-status">â³</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">×˜×§×¡×˜ ××©×¤×˜×™ ××ª××™×</span>
          <span class="validation-status" id="estimate-legal-text">â³</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">×—×™×©×•×‘ ××¢"× ×•×ª×‘×™×¢×”</span>
          <span class="validation-status" id="estimate-calculations">â³</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">×‘×“×™×§×ª ×¢×§×‘×™×•×ª × ×ª×•× ×™×</span>
          <span class="validation-status" id="estimate-consistency">â³</span>
        </div>
        
        <!-- Estimate Calculations Summary -->
        <div class="cost-summary">
          <div class="cost-summary-title">×—×™×©×•×‘×™ ××•××“×Ÿ ×¡×•×¤×™×™×</div>
          <div class="cost-grid">
            <div class="cost-item">
              <span class="cost-label">×¡×”"×› × ×–×§×™×:</span>
              <span class="cost-value" id="estimate-base-damage">â‚ª0</span>
            </div>
            <div class="cost-item">
              <span class="cost-label">×©×™×¢×•×¨ ××¢"×:</span>
              <span class="cost-value" id="estimate-vat-rate">18%</span>
            </div>
            <div class="cost-item">
              <span class="cost-label">×¡×›×•× ××¢"×:</span>
              <span class="cost-value" id="estimate-vat-amount">â‚ª0</span>
            </div>
            <div class="cost-item" style="grid-column: 1 / -1; border-top: 2px solid #16a34a; padding-top: 10px; margin-top: 10px;">
              <span class="cost-label" style="font-weight: bold; font-size: 18px;">×¡×”"×› ×ª×‘×™×¢×” ×›×•×œ×œ ××¢"×:</span>
              <span class="cost-value" style="font-size: 20px; color: #16a34a;" id="estimate-total-claim">â‚ª0</span>
            </div>
          </div>
        </div>
      </div>
      <div class="validation-buttons">
        <button class="btn btn-validate" onclick="validateSection('estimate')" disabled>×‘×“×•×§ ××•×˜×•××˜×™×ª</button>
        <button class="btn btn-edit" onclick="editSection('estimate')" disabled>×¢×¨×™×›×” ×™×“× ×™×ª</button>
        <button class="btn btn-success" onclick="approveSection('estimate')" disabled>××™××•×ª ×—×™×©×•×‘×™×</button>
      </div>
    </div>

    <!-- Legal Text Validation -->
    <div class="legal-text-section">
      <div class="legal-text-header">××™××•×ª ×˜×§×¡×˜ ××©×¤×˜×™</div>
      <div style="margin-bottom: 15px; color: #92400e;">
        ×”×˜×§×¡×˜ ×”××©×¤×˜×™ ×œ×”×œ×Ÿ ×™×™×›×œ×œ ×‘××•××“×Ÿ. × ×™×ª×Ÿ ×œ×¢×¨×•×š ×•×œ×”×ª××™× ×œ×¤×™ ×”×¦×•×¨×š. ×”××¢×¨×›×ª ×‘×“×§×” ××ª ×”×ª×××ª ×”×˜×§×¡×˜ ×œ×¡×•×’ ×”××•××“×Ÿ.
      </div>
      <textarea class="legal-text-content" id="legal-text-content" placeholder="×˜×§×¡×˜ ××©×¤×˜×™ ×™×™×˜×¢×Ÿ ×›××Ÿ..."></textarea>
      <div class="validation-buttons" style="margin-top: 15px;">
        <button class="btn btn-validate" onclick="validateLegalText()">×‘×“×•×§ ×˜×§×¡×˜ ××©×¤×˜×™</button>
        <button class="btn btn-edit" onclick="editLegalText()">×¢×¨×™×›×” ××ª×§×“××ª</button>
      </div>
    </div>

    <!-- User Manual Validation -->
    <div class="user-validation-section">
      <div class="user-validation-header">××™××•×ª ×‘×¨××ª ×”××©×ª××© - ×¡×§×™×¨×” ×™×“× ×™×ª</div>
      <div style="color: #475569; line-height: 1.6; margin-bottom: 20px;">
        <p><strong>×‘×“×•×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×œ×¢×™×œ ×•×ª×§×Ÿ ×‘××™×“×ª ×”×¦×•×¨×š.</strong> ×”××¢×¨×›×ª ×‘×™×¦×¢×” ×‘×“×™×§×•×ª ××•×˜×•××˜×™×•×ª, ××š × ×“×¨×©×ª ×”×¡×§×™×¨×” ×”×™×“× ×™×ª ×©×œ×š.</p>
        
        <div style="background: #eff6ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
          <strong>××–×”×¨×” ×—×©×•×‘×”:</strong> ×©×™× ×•×™×™× ×©×ª×‘×¦×¢ ×›××Ÿ ×™×”×¤×›×• ×œ×××ª ×”××¢×¨×›×ª ×•×™×•×¨×©××• ×‘××•××“×Ÿ ×”×¡×•×¤×™. ×•×“× ×©×›×œ ×”× ×ª×•× ×™× × ×›×•× ×™× ×œ×¤× ×™ ×”××™×©×•×¨ ×”×¡×•×¤×™.
        </div>
        
        <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin: 15px 0;">
          <strong>×”× ×—×™×•×ª ×œ××™××•×ª:</strong>
          <ul style="margin: 10px 0; padding-right: 20px;">
            <li>×•×“× ×©×›×œ ×”× ×ª×•× ×™× ×”×›×¡×¤×™×™× × ×›×•× ×™× ×•×¢×§×‘×™×™×</li>
            <li>×‘×“×•×§ ×©×”×˜×§×¡×˜ ×”××©×¤×˜×™ ××ª××™× ×œ×¡×•×’ ×”××•××“×Ÿ</li>
            <li>×•×•×“× ×©×¤×¨×˜×™ ×”×¨×›×‘ ×•×”×‘×¢×œ×™× × ×›×•× ×™×</li>
            <li>×‘×“×•×§ ×©××•×§×“×™ ×”× ×–×§ ××©×§×¤×™× ××ª ×”××¦×‘ ×‘×¤×•×¢×œ</li>
          </ul>
        </div>
      </div>
      
      <div class="validation-buttons">
        <button class="btn btn-edit" onclick="requestManualReview()">×“×¨×•×© ×¡×§×™×¨×” × ×•×¡×¤×ª</button>
        <button class="btn btn-validate" onclick="saveValidationData()">×©××•×¨ ×©×™× ×•×™×™×</button>
      </div>
    </div>

    <!-- Final Actions -->
    <div class="final-actions">
      <div style="font-size: 18px; font-weight: bold; color: #1e3a8a; margin-bottom: 20px;">
        ×¤×¢×•×œ×•×ª ×¡×™×•×
      </div>
      <div style="color: #64748b; margin-bottom: 25px;">
        ×œ××—×¨ ×”××™×©×•×¨ ×”×¡×•×¤×™ ×™×™×•×¦×¨ ×”××•××“×Ÿ ×•×™×™×©×œ×— ×œ×¢×™×‘×•×“. ×œ× × ×™×ª×Ÿ ×™×”×™×” ×œ×¢×¨×•×š ××ª ×”× ×ª×•× ×™× ×œ××—×¨ ××›×Ÿ.
      </div>
      <div class="validation-buttons" style="justify-content: center; max-width: 600px; margin: 0 auto;">
        <button class="btn btn-edit" onclick="window.location.href='estimate-builder.html'">
          â¬…ï¸ ×—×–×•×¨ ×œ×¢×¨×™×›×”
        </button>
        <button class="btn btn-validate" onclick="saveValidationData()">
          ğŸ’¾ ×©××•×¨ ××™××•×ª
        </button>
        <button class="btn btn-success" id="final-approve-btn" onclick="finalApproval()" disabled>
          âœ… ××™×©×•×¨ ×¡×•×¤×™ ×•×™×¦×™×¨×ª ××•××“×Ÿ
        </button>
      </div>
    </div>
    
    <div class="footer">All rights reserved Â© Carmel Cayouf</div>
  </div>

  <script type="module">
    import { helper, updateHelper } from './helper.js';
    import { loadLegalText } from './vault-loader.js';
    import { MathEngine } from './math.js';
    import { sendToWebhook } from './webhook.js';
    
    let validationProgress = {
      vehicle: false,
      levi: false,
      damage: false,
      estimate: false
    };
    
    let currentValidationData = {};

    // Authentication check
    document.addEventListener('DOMContentLoaded', () => {
      console.log('ğŸ”„ Estimate Validation: Initializing comprehensive validation system...');
      
      const auth = sessionStorage.getItem("auth");
      if (!auth) {
        console.error('âŒ No authentication found');
        showAlert("×”×’×™×©×” ×—×¡×•××” - ×× × ×”×ª×—×‘×¨ ×“×¨×š ×“×£ ×”×‘×™×ª", 'error');
        setTimeout(() => {
          window.location.href = "index.html";
        }, 2000);
        return;
      }

      const helperData = sessionStorage.getItem('helper');
      const selectedReportType = sessionStorage.getItem('selectedReportType');
      
      if (!helperData || selectedReportType !== 'estimate') {
        console.error('âŒ Missing required data for validation');
        showAlert('×©×’×™××”: × ×ª×•× ×™× ×—×¡×¨×™× ×œ××™××•×ª. ×—×•×–×¨ ×œ×“×£ ×”×‘×—×™×¨×”...', 'error');
        setTimeout(() => {
          window.location.href = 'selection.html';
        }, 2000);
        return;
      }

      console.log('âœ… Estimate Validation: Authentication and data validated');
      initializeValidationSystem();
    });

    function initializeValidationSystem() {
      loadValidationData();
      loadLegalTextValidation();
      startInitialValidation();
    }

    function loadValidationData() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      currentValidationData = {
        meta: helper.meta || {},
        car_details: helper.car_details || {},
        vehicle: helper.vehicle || {},
        client: helper.client || {},
        levi_report: helper.expertise?.levi_report || {},
        damage_sections: helper.damage_sections || [],
        estimate_data: helper.estimate_data || {}
      };
      
      console.log('ğŸ“Š Loaded validation data:', currentValidationData);
    }

    async function loadLegalTextValidation() {
      try {
        const estimateType = currentValidationData.estimate_data.type || '××•×‘×“×Ÿ_×œ×”×œ×›×”';
        const legalText = await loadLegalText(`estimate_${estimateType}`);
        document.getElementById('legal-text-content').value = legalText || '×˜×§×¡×˜ ××©×¤×˜×™ ×œ× × ××¦×';
      } catch (error) {
        console.error('Error loading legal text:', error);
        document.getElementById('legal-text-content').value = '×©×’×™××” ×‘×˜×¢×™× ×ª ×”×˜×§×¡×˜ ×”××©×¤×˜×™';
      }
    }

    function startInitialValidation() {
      // Auto-validate vehicle section first
      validateSection('vehicle');
    }

    // Validation Functions
    window.validateSection = async function(sectionName) {
      const section = document.getElementById(`section-${sectionName}`);
      const status = section.querySelector('.section-status');
      
      // Set to validating state
      section.classList.remove('completed', 'error', 'warning');
      section.classList.add('current');
      status.textContent = '××××ª...';
      status.className = 'section-status status-current';
      
      try {
        let validationResult;
        
        switch(sectionName) {
          case 'vehicle':
            validationResult = await validateVehicleSection();
            break;
          case 'levi':
            validationResult = await validateLeviSection();
            break;
          case 'damage':
            validationResult = await validateDamageSection();
            break;
          case 'estimate':
            validationResult = await validateEstimateSection();
            break;
        }
        
        // Update UI based on validation result
        updateSectionUI(sectionName, validationResult);
        
        // Update progress
        updateValidationProgress();
        
      } catch (error) {
        console.error(`Validation error for section ${sectionName}:`, error);
        setSectionError(sectionName, error.message);
      }
    };

    async function validateVehicleSection() {
      const issues = [];
      const validItems = [];
      
      // Validate plate number
      const plate = currentValidationData.meta.plate || currentValidationData.car_details.plate;
      if (plate && plate.length >= 6) {
        validItems.push('vehicle-plate');
        document.getElementById('vehicle-plate').textContent = 'âœ“';
      } else {
        issues.push('××¡×¤×¨ ×¨×›×‘ ×—×¡×¨ ××• ×œ× ×ª×§×™×Ÿ');
        document.getElementById('vehicle-plate').textContent = 'âŒ';
      }
      
      // Validate vehicle details
      const manufacturer = currentValidationData.car_details.manufacturer || currentValidationData.vehicle.manufacturer;
      const model = currentValidationData.car_details.model || currentValidationData.vehicle.model;
      if (manufacturer && model) {
        validItems.push('vehicle-details');
        document.getElementById('vehicle-details').textContent = 'âœ“';
      } else {
        issues.push('×¤×¨×˜×™ ×™×¦×¨×Ÿ ××• ×“×’× ×—×¡×¨×™×');
        document.getElementById('vehicle-details').textContent = 'âŒ';
      }
      
      // Validate vehicle specs
      const year = currentValidationData.car_details.year || currentValidationData.vehicle.year;
      if (year && year > 1990 && year <= new Date().getFullYear()) {
        validItems.push('vehicle-specs');
        document.getElementById('vehicle-specs').textContent = 'âœ“';
      } else {
        issues.push('×©× ×ª ×™×¦×•×¨ ×œ× ×ª×§×™× ×”');
        document.getElementById('vehicle-specs').textContent = 'âŒ';
      }
      
      // Validate owner details
      const owner = currentValidationData.client.name;
      const phone = currentValidationData.client.phone_number;
      if (owner || phone) {
        validItems.push('vehicle-owner');
        document.getElementById('vehicle-owner').textContent = 'âœ“';
      } else {
        issues.push('×¤×¨×˜×™ ×‘×¢×œ×™× ×—×¡×¨×™×');
        document.getElementById('vehicle-owner').textContent = 'âš ï¸';
      }
      
      // Validate insurance details
      const insurance = currentValidationData.client.insurance_company;
      if (insurance) {
        validItems.push('vehicle-insurance');
        document.getElementById('vehicle-insurance').textContent = 'âœ“';
      } else {
        issues.push('×¤×¨×˜×™ ×‘×™×˜×•×— ×—×¡×¨×™×');
        document.getElementById('vehicle-insurance').textContent = 'âš ï¸';
      }
      
      return {
        success: issues.length === 0,
        warnings: issues.filter(i => i.includes('×—×¡×¨×™×')).length,
        errors: issues.filter(i => !i.includes('×—×¡×¨×™×')).length,
        issues: issues,
        validItems: validItems.length
      };
    }

    async function validateLeviSection() {
      const issues = [];
      const validItems = [];
      const levi = currentValidationData.levi_report;
      
      // Validate model code
      if (levi.model_code) {
        validItems.push('levi-model');
        document.getElementById('levi-model').textContent = 'âœ“';
      } else {
        issues.push('×§×•×“ ×“×’× ×—×¡×¨ ×‘×“×•"×— ×œ×•×™');
        document.getElementById('levi-model').textContent = 'âŒ';
      }
      
      // Validate base price
      if (levi.base_price && parseFloat(levi.base_price) > 0) {
        validItems.push('levi-base-price');
        document.getElementById('levi-base-price').textContent = 'âœ“';
        document.getElementById('levi-display-base').textContent = MathEngine.formatCurrency(levi.base_price);
      } else {
        issues.push('××—×™×¨ ×‘×¡×™×¡ ×œ× ×ª×§×™×Ÿ');
        document.getElementById('levi-base-price').textContent = 'âŒ';
      }
      
      // Validate final price
      if (levi.final_price && parseFloat(levi.final_price) > 0) {
        validItems.push('levi-final-price');
        document.getElementById('levi-final-price').textContent = 'âœ“';
        document.getElementById('levi-display-final').textContent = MathEngine.formatCurrency(levi.final_price);
      } else {
        issues.push('×©×•×•×™ ×©×•×§ ×¡×•×¤×™ ×œ× ×ª×§×™×Ÿ');
        document.getElementById('levi-final-price').textContent = 'âŒ';
      }
      
      // Display adjustments if available
      if (levi.adjustments) {
        displayLeviAdjustments(levi.adjustments);
        document.getElementById('levi-adjustments-container').style.display = 'block';
      }
      
      // Calculate total adjustments
      const basePrice = parseFloat(levi.base_price) || 0;
      const finalPrice = parseFloat(levi.final_price) || 0;
      const adjustments = finalPrice - basePrice;
      document.getElementById('levi-display-adjustments').textContent = MathEngine.formatCurrency(adjustments);
      
      return {
        success: issues.length === 0,
        warnings: 0,
        errors: issues.length,
        issues: issues,
        validItems: validItems.length
      };
    }

    async function validateDamageSection() {
      const issues = [];
      const validItems = [];
      const damageSections = currentValidationData.damage_sections;
      
      // Validate damage centers count
      if (damageSections && damageSections.length > 0) {
        validItems.push('damage-centers-count');
        document.getElementById('damage-centers-count').textContent = `âœ“ (${damageSections.length})`;
      } else {
        issues.push('×œ× × ××¦××• ××•×§×“×™ × ×–×§');
        document.getElementById('damage-centers-count').textContent = 'âŒ';
      }
      
      let totalWorks = 0, totalParts = 0, totalRepairs = 0;
      let hasWorks = false, hasParts = false;
      
      // Validate each damage center and calculate totals
      if (damageSections && damageSections.length > 0) {
        displayDamageCenters(damageSections);
        
        damageSections.forEach(center => {
          if (center.works && center.works.length > 0) {
            hasWorks = true;
            totalWorks += center.works.reduce((sum, work) => sum + (parseFloat(work.cost) || 0), 0);
          }
          if (center.parts && center.parts.length > 0) {
            hasParts = true;
            totalParts += center.parts.reduce((sum, part) => sum + (parseFloat(part.cost) || 0), 0);
          }
          if (center.repairs && center.repairs.length > 0) {
            totalRepairs += center.repairs.reduce((sum, repair) => sum + (parseFloat(repair.cost) || 0), 0);
          }
        });
      }
      
      // Validate works
      if (hasWorks) {
        validItems.push('damage-works');
        document.getElementById('damage-works').textContent = 'âœ“';
      } else {
        issues.push('×œ× × ××¦××• ×¤×¨×˜×™ ×¢×‘×•×“×•×ª');
        document.getElementById('damage-works').textContent = 'âš ï¸';
      }
      
      // Validate parts
      if (hasParts) {
        validItems.push('damage-parts');
        document.getElementById('damage-parts').textContent = 'âœ“';
      } else {
        issues.push('×œ× × ××¦××• ×—×œ×§×™×');
        document.getElementById('damage-parts').textContent = 'âš ï¸';
      }
      
      // Validate costs
      const totalDamage = totalWorks + totalParts + totalRepairs;
      if (totalDamage > 0) {
        validItems.push('damage-costs');
        document.getElementById('damage-costs').textContent = 'âœ“';
      } else {
        issues.push('×œ× × ××¦××• ×¢×œ×•×™×•×ª ×—×™×©×•×‘');
        document.getElementById('damage-costs').textContent = 'âŒ';
      }
      
      // Calculate VAT for damage totals
      const vatRate = MathEngine.getVatRate();
      const vatAmount = Math.round(totalDamage * vatRate / 100);
      const totalWithVat = totalDamage + vatAmount;
      
      // Update cost display
      document.getElementById('damage-total-works').textContent = MathEngine.formatCurrency(totalWorks);
      document.getElementById('damage-total-parts').textContent = MathEngine.formatCurrency(totalParts);
      document.getElementById('damage-total-repairs').textContent = MathEngine.formatCurrency(totalRepairs);
      document.getElementById('damage-total-before-vat').textContent = MathEngine.formatCurrency(totalDamage);
      document.getElementById('damage-total-with-vat').textContent = MathEngine.formatCurrency(totalWithVat);
      
      return {
        success: issues.length === 0,
        warnings: issues.filter(i => i.includes('×œ× × ××¦××•')).length,
        errors: issues.filter(i => !i.includes('×œ× × ××¦××•')).length,
        issues: issues,
        validItems: validItems.length,
        totalDamage: totalDamage
      };
    }

    async function validateEstimateSection() {
      const issues = [];
      const validItems = [];
      
      // Validate estimate type
      const estimateType = currentValidationData.estimate_data.type;
      if (estimateType && ['××•×‘×“×Ÿ_×œ×”×œ×›×”', '×˜×•×˜×œ×•×¡'].includes(estimateType)) {
        validItems.push('estimate-type-status');
        document.getElementById('estimate-type-status').textContent = 'âœ“';
      } else {
        issues.push('×¡×•×’ ××•××“×Ÿ ×œ× ××•×’×“×¨');
        document.getElementById('estimate-type-status').textContent = 'âŒ';
      }
      
      // Validate legal text
      const legalText = document.getElementById('legal-text-content').value;
      if (legalText && legalText.length > 50 && !legalText.includes('×©×’×™××”')) {
        validItems.push('estimate-legal-text');
        document.getElementById('estimate-legal-text').textContent = 'âœ“';
      } else {
        issues.push('×˜×§×¡×˜ ××©×¤×˜×™ ×œ× ×ª×§×™×Ÿ');
        document.getElementById('estimate-legal-text').textContent = 'âŒ';
      }
      
      // Get damage total from previous validation
      const totalDamage = parseFloat(document.getElementById('damage-total-before-vat').textContent.replace('â‚ª', '').replace(',', '')) || 0;
      
      // Calculate VAT and final amount
      const vatRate = MathEngine.getVatRate();
      const vatAmount = Math.round(totalDamage * vatRate / 100);
      const totalClaim = totalDamage + vatAmount;
      
      // Validate calculations
      if (totalDamage > 0) {
        validItems.push('estimate-calculations');
        document.getElementById('estimate-calculations').textContent = 'âœ“';
      } else {
        issues.push('×—×™×©×•×‘×™× ×œ× ×ª×§×™× ×™×');
        document.getElementById('estimate-calculations').textContent = 'âŒ';
      }
      
      // Validate data consistency
      if (currentValidationData.meta.plate && currentValidationData.levi_report.final_price && totalDamage > 0) {
        validItems.push('estimate-consistency');
        document.getElementById('estimate-consistency').textContent = 'âœ“';
      } else {
        issues.push('×—×•×¡×¨ ×¢×§×‘×™×•×ª ×‘× ×ª×•× ×™×');
        document.getElementById('estimate-consistency').textContent = 'âŒ';
      }
      
      // Update calculation display
      document.getElementById('estimate-base-damage').textContent = MathEngine.formatCurrency(totalDamage);
      document.getElementById('estimate-vat-rate').textContent = `${vatRate}%`;
      document.getElementById('estimate-vat-amount').textContent = MathEngine.formatCurrency(vatAmount);
      document.getElementById('estimate-total-claim').textContent = MathEngine.formatCurrency(totalClaim);
      
      return {
        success: issues.length === 0,
        warnings: 0,
        errors: issues.length,
        issues: issues,
        validItems: validItems.length,
        totalClaim: totalClaim
      };
    }

    function displayLeviAdjustments(adjustments) {
      const container = document.getElementById('levi-adjustments-content');
      container.innerHTML = '';
      
      Object.keys(adjustments).forEach(key => {
        const adjustment = adjustments[key];
        if (adjustment.percent || adjustment.value) {
          const div = document.createElement('div');
          div.className = 'adjustment-item';
          div.innerHTML = `
            <span>${key}:</span>
            <span>${adjustment.percent || '0'}% (${MathEngine.formatCurrency(adjustment.value || 0)})</span>
          `;
          container.appendChild(div);
        }
      });
    }

    function displayDamageCenters(damageSections) {
      const container = document.getElementById('damage-centers-container');
      container.innerHTML = '';
      
      damageSections.forEach((center, index) => {
        const worksTotal = center.works ? center.works.reduce((sum, work) => sum + (parseFloat(work.cost) || 0), 0) : 0;
        const partsTotal = center.parts ? center.parts.reduce((sum, part) => sum + (parseFloat(part.cost) || 0), 0) : 0;
        const repairsTotal = center.repairs ? center.repairs.reduce((sum, repair) => sum + (parseFloat(repair.cost) || 0), 0) : 0;
        
        // Calculate VAT for each category
        const vatRate = MathEngine.getVatRate();
        const worksVat = Math.round(worksTotal * vatRate / 100);
        const partsVat = Math.round(partsTotal * vatRate / 100);
        const repairsVat = Math.round(repairsTotal * vatRate / 100);
        
        const div = document.createElement('div');
        div.className = 'damage-center';
        div.innerHTML = `
          <div class="damage-center-header">××•×§×“ × ×–×§ ${index + 1}: ${center.zone || '×œ× ××•×’×“×¨'}</div>
          <div class="damage-center-content">
            <div class="damage-stat">
              <div class="damage-stat-label">×¢×‘×•×“×•×ª</div>
              <div class="damage-stat-value">${center.works?.length || 0}</div>
              <div style="font-size: 11px; color: #64748b; margin-top: 3px;">×œ×œ× ××¢"×: ${MathEngine.formatCurrency(worksTotal)}</div>
              <div style="font-size: 11px; color: #16a34a; font-weight: bold;">×›×•×œ×œ ××¢"×: ${MathEngine.formatCurrency(worksTotal + worksVat)}</div>
            </div>
            <div class="damage-stat">
              <div class="damage-stat-label">×—×œ×§×™×</div>
              <div class="damage-stat-value">${center.parts?.length || 0}</div>
              <div style="font-size: 11px; color: #64748b; margin-top: 3px;">×œ×œ× ××¢"×: ${MathEngine.formatCurrency(partsTotal)}</div>
              <div style="font-size: 11px; color: #16a34a; font-weight: bold;">×›×•×œ×œ ××¢"×: ${MathEngine.formatCurrency(partsTotal + partsVat)}</div>
            </div>
            <div class="damage-stat">
              <div class="damage-stat-label">×ª×™×§×•× ×™×</div>
              <div class="damage-stat-value">${center.repairs?.length || 0}</div>
              <div style="font-size: 11px; color: #64748b; margin-top: 3px;">×œ×œ× ××¢"×: ${MathEngine.formatCurrency(repairsTotal)}</div>
              <div style="font-size: 11px; color: #16a34a; font-weight: bold;">×›×•×œ×œ ××¢"×: ${MathEngine.formatCurrency(repairsTotal + repairsVat)}</div>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function updateSectionUI(sectionName, result) {
      const section = document.getElementById(`section-${sectionName}`);
      const status = section.querySelector('.section-status');
      const buttons = section.querySelectorAll('.btn');
      
      if (result.success) {
        section.classList.remove('current', 'error', 'warning');
        section.classList.add('completed');
        status.textContent = '××•××ª âœ“';
        status.className = 'section-status status-completed';
        
        // Enable approve button
        buttons[2].disabled = false;
        
        validationProgress[sectionName] = true;
        
      } else if (result.warnings > 0 && result.errors === 0) {
        section.classList.remove('current', 'error');
        section.classList.add('warning');
        status.textContent = '××–×”×¨×•×ª âš ï¸';
        status.className = 'section-status status-warning';
        
        // Enable approve button with warning
        buttons[2].disabled = false;
        
      } else {
        section.classList.remove('current', 'completed', 'warning');
        section.classList.add('error');
        status.textContent = '×©×’×™××•×ª âŒ';
        status.className = 'section-status status-error';
        
        // Keep approve button disabled
        buttons[2].disabled = true;
      }
      
      // Always enable edit button after validation
      buttons[1].disabled = false;
      
      console.log(`Section ${sectionName} validation result:`, result);
    }

    function setSectionError(sectionName, errorMessage) {
      const section = document.getElementById(`section-${sectionName}`);
      const status = section.querySelector('.section-status');
      
      section.classList.remove('current', 'completed', 'warning');
      section.classList.add('error');
      status.textContent = '×©×’×™××” âŒ';
      status.className = 'section-status status-error';
      
      showAlert(`×©×’×™××” ×‘××™××•×ª ${sectionName}: ${errorMessage}`, 'error');
    }

    function updateValidationProgress() {
      const completedSections = Object.values(validationProgress).filter(v => v).length;
      const totalSections = Object.keys(validationProgress).length;
      const progressPercent = Math.round((completedSections / totalSections) * 100);
      
      document.getElementById('progress-fill').style.width = progressPercent + '%';
      document.getElementById('progress-text').textContent = progressPercent + '% ×”×•×©×œ×';
      
      // Enable final approval if all sections are validated
      const finalBtn = document.getElementById('final-approve-btn');
      finalBtn.disabled = progressPercent < 100;
      
      if (progressPercent === 100) {
        showAlert('×›×œ ×”××™××•×ª×™× ×”×•×©×œ××• ×‘×”×¦×œ×—×”! × ×™×ª×Ÿ ×œ×”××©×™×š ×œ××™×©×•×¨ ×¡×•×¤×™.', 'success');
      }
    }

    // Section Actions
    window.editSection = function(sectionName) {
      switch(sectionName) {
        case 'vehicle':
          window.location.href = 'estimate-builder.html#vehicle-details';
          break;
        case 'levi':
          window.location.href = 'upload-levi.html';
          break;
        case 'damage':
          window.location.href = 'damage-center-flow.html';
          break;
        case 'estimate':
          window.location.href = 'estimate-builder.html#estimate-type';
          break;
      }
    };

    window.approveSection = function(sectionName) {
      const section = document.getElementById(`section-${sectionName}`);
      const status = section.querySelector('.section-status');
      const button = section.querySelector('.btn-success');
      
      section.classList.remove('current', 'warning');
      section.classList.add('completed');
      status.textContent = '××•×©×¨ âœ“';
      status.className = 'section-status status-completed';
      button.disabled = true;
      button.textContent = 'âœ“ ××•×©×¨';
      
      validationProgress[sectionName] = true;
      
      // Enable next section
      const sections = ['vehicle', 'levi', 'damage', 'estimate'];
      const currentIndex = sections.indexOf(sectionName);
      if (currentIndex < sections.length - 1) {
        const nextSectionName = sections[currentIndex + 1];
        const nextSection = document.getElementById(`section-${nextSectionName}`);
        const nextButtons = nextSection.querySelectorAll('.btn');
        
        // Enable buttons for next section
        nextButtons[0].disabled = false; // validate button
        nextButtons[1].disabled = false; // edit button
        
        // Auto-validate next section
        setTimeout(() => {
          validateSection(nextSectionName);
        }, 500);
      }
      
      updateValidationProgress();
      console.log(`Section ${sectionName} approved`);
    };

    // Other Actions
    window.validateLegalText = function() {
      const legalText = document.getElementById('legal-text-content').value;
      if (legalText && legalText.length > 50) {
        showAlert('×”×˜×§×¡×˜ ×”××©×¤×˜×™ ×ª×§×™×Ÿ', 'success');
      } else {
        showAlert('×”×˜×§×¡×˜ ×”××©×¤×˜×™ ×§×¦×¨ ××“×™ ××• ×œ× ×ª×§×™×Ÿ', 'warning');
      }
    };

    window.editLegalText = function() {
      window.location.href = 'estimate-builder.html#legal-text';
    };

    window.requestManualReview = function() {
      showAlert('×‘×§×©×” ×œ×¡×§×™×¨×” ×™×“× ×™×ª × ×¨×©××” ×‘××¢×¨×›×ª', 'warning');
      // Could send to webhook for manual review request
    };

    window.saveValidationData = function() {
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        // Update validation data
        helper.validation = {
          completed_sections: Object.keys(validationProgress).filter(k => validationProgress[k]),
          legal_text: document.getElementById('legal-text-content').value,
          validated_at: new Date().toISOString(),
          validated_by: 'user',
          validation_progress: validationProgress
        };

        sessionStorage.setItem('helper', JSON.stringify(helper));
        showAlert('× ×ª×•× ×™ ×”××™××•×ª × ×©××¨×• ×‘×”×¦×œ×—×”', 'success');
        
      } catch (error) {
        console.error('Error saving validation data:', error);
        showAlert('×©×’×™××” ×‘×©××™×¨×ª × ×ª×•× ×™ ×”××™××•×ª', 'error');
      }
    };

    window.finalApproval = async function() {
      const finalBtn = document.getElementById('final-approve-btn');
      const originalText = finalBtn.textContent;
      
      try {
        // Confirm with user
        if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××©×¨ ××ª ×”××•××“×Ÿ ×”×¡×•×¤×™ ×•×œ×©×œ×•×— ×œ×¢×™×‘×•×“? ×œ× × ×™×ª×Ÿ ×™×”×™×” ×œ×¢×¨×•×š ×œ××—×¨ ××›×Ÿ.')) {
          return;
        }
        
        // Show loading state
        finalBtn.disabled = true;
        finalBtn.textContent = '××¢×‘×“ ××•××“×Ÿ ×¡×•×¤×™...';
        
        // Save final validation data
        saveValidationData();
        
        // Set validation as completed
        sessionStorage.setItem('estimateValidationCompleted', 'true');
        
        // Send to webhook for final processing
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        await sendToWebhook('SUBMIT_ESTIMATE_FINAL', {
          helper: helper,
          validation_completed: true,
          validation_timestamp: new Date().toISOString()
        });
        
        finalBtn.textContent = 'âœ… ×”×•×©×œ× ×‘×”×¦×œ×—×”';
        showAlert('×”××•××“×Ÿ ××•×©×¨ ×‘×”×¦×œ×—×” ×•× ×©×œ×— ×œ×¢×™×‘×•×“!', 'success');
        
        // Redirect to report builder
        setTimeout(() => {
          window.location.href = 'estimate-report-builder.html';
        }, 2000);
        
      } catch (error) {
        console.error('Final approval error:', error);
        finalBtn.disabled = false;
        finalBtn.textContent = originalText;
        showAlert('×©×’×™××” ×‘××™×©×•×¨ ×”×¡×•×¤×™: ' + error.message, 'error');
      }
    };

    function showAlert(message, type = 'success') {
      const alertsContainer = document.getElementById('alerts');
      const alert = document.createElement('div');
      alert.className = `alert ${type} show`;
      alert.textContent = message;
      alertsContainer.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    // Make functions globally available
    window.validateSection = validateSection;
    window.editSection = editSection;
    window.approveSection = approveSection;
    window.validateLegalText = validateLegalText;
    window.editLegalText = editLegalText;
    window.requestManualReview = requestManualReview;
    window.saveValidationData = saveValidationData;
    window.finalApproval = finalApproval;
  </script>
</body>
</html>