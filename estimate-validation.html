<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>אימות אומדן - ירון כיוף שמאות</title>
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  
  <!-- OneSignal Push -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">

  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "3b924b99-c302-4919-a97e-baf909394696",
      });
    });
  </script>

  <style>
    body {
      font-family: sans-serif;
      background: #f3f6fb;
      margin: 0;
      min-height: 100vh;
      padding: 0;
      padding-top: 90px;
      overflow-x: hidden;
    }
    .container {
      width: 100%;
      max-width:750px;
      background: #fff;
      padding: 32px 24px 24px 24px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.08);
      margin: 32px auto 32px auto;
      box-sizing: border-box;
    }
    .logo {
      display: flex;
      justify-content: center;
      margin-bottom: 8px;
    }
    .logo img {
      width: 112px;
      height: auto;
      display: block;
    }
    .title { font-size: 27px; font-weight: bold; text-align: center; margin-bottom: 2px; font-weight: 900;}
    .subtitle { font-size: 23px; color: #666; text-align: center; margin-bottom: 10px;}
    h1, h2 { color: #1e3a8a; font-size: 25px; text-align: center; margin: 15px 0 8px 0; font-weight: 600;}
    h3 { color: #1e3a8a; font-size: 24px; margin: 22px 0 12px 0; text-align: right; font-weight: 900;}
    .form-section {
      width: 100%;
      margin-bottom: 20px;
      background: #fafbfe;
      border-radius: 12px;
      padding: 17px 15px 12px 15px;
      box-sizing: border-box;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px 18px;
      width: 100%;
    }
    @media (max-width: 600px) {
      .form-grid { grid-template-columns: 1fr; }
      .container { padding: 14px 2vw 20px 2vw; }
    }
    
    /* Mobile viewport fixes */
    @media (max-width: 768px) {
      body {
        width: 100vw;
        overflow-x: hidden !important;
        position: relative;
      }
      
      html {
        width: 100vw;
        overflow-x: hidden !important;
      }
      
      .container {
        width: 95vw;
        max-width: 95vw;
        margin: 32px 2.5vw 32px 2.5vw;
      }
    }
    label {
      font-size: 18px;
      margin-bottom: 4px;
      display: block;
      text-align: right;
    }
    input, select, textarea {
      width: 100%;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 0px;
      padding: 8px 9px;
      box-sizing: border-box;
      text-align: right;
      background: #f9f9f9;
      transition: border .15s;
      outline: none;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #3b82f6;
    }
    .readonly-box {
      background: #f4f6fa;
      border-radius: 6px;
      border: 1px solid #eee;
      padding: 7px 8px;
      min-height: 30px;
      font-size: 16px;
      color: #222;
      margin-bottom: 0;
    }
    .form-row { margin-bottom: 13px;}
    .collapsible-btn {
      background: #e0e7f1;
      font-family: sans-serif;
      color: #1e3a8a;
      border: none;
      padding: 7px 18px;
      border-radius: 7px;
      margin-bottom: 8px;
      margin-top: 2px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      text-align: right;
      width: auto;
      display: inline-block;
    }
    button, .btn {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      color: white;
      background-color: #3b82f6;
      margin-top: 16px;
      margin-bottom: 0;
      cursor: pointer;
      font-weight: 600;
      transition: background .2s;
    }
    .btn.add {
      background: #28a745;
      margin-top: 7px;
      margin-bottom: 0;
      width: auto;
      padding: 8px 18px;
      font-size: 16px;
    }
    button:hover, .btn:hover {
      background-color: #2563eb;
    }
    .btn.add:hover {
      background: #218838;
    }

    .validation-section {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      transition: all 0.3s ease;
    }

    .validation-section.completed {
      border-color: #16a34a;
      background: #f0fdf4;
    }

    .validation-section.current {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    .validation-section.error {
      border-color: #dc2626;
      background: #fef2f2;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 20px;
      font-weight: bold;
      color: #1e3a8a;
    }

    .section-status {
      padding: 6px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }

    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .status-current {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .status-completed {
      background: #dcfce7;
      color: #166534;
    }

    .status-error {
      background: #fecaca;
      color: #991b1b;
    }

    .validation-content {
      color: #475569;
      line-height: 1.6;
    }

    .validation-item {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .validation-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .validation-item-title {
      font-weight: 600;
      color: #1e3a8a;
    }

    .validation-check {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }

    .check-pass {
      background: #16a34a;
      color: white;
    }

    .check-fail {
      background: #dc2626;
      color: white;
    }

    .check-warning {
      background: #f59e0b;
      color: white;
    }

    .editable-field {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      margin-top: 8px;
      box-sizing: border-box;
    }

    .editable-field:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .legal-text-section {
      background: #fef3c7;
      border: 2px solid #f59e0b;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
    }

    .legal-text-header {
      font-size: 18px;
      font-weight: bold;
      color: #92400e;
      margin-bottom: 15px;
    }

    .legal-text-content {
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 15px;
      min-height: 150px;
      font-size: 14px;
      line-height: 1.6;
      resize: vertical;
      width: 100%;
      box-sizing: border-box;
    }

    .damage-center-validation {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .damage-center-header {
      background: #f1f5f9;
      padding: 10px 15px;
      margin: -15px -15px 15px -15px;
      border-radius: 8px 8px 0 0;
      font-weight: bold;
      color: #1e3a8a;
    }

    .damage-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 10px;
    }

    .stat-item {
      text-align: center;
      padding: 10px;
      background: #f8fafc;
      border-radius: 6px;
    }

    .stat-label {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: #1e3a8a;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 40px;
      padding: 30px;
      background: #f8f9fa;
      border-radius: 10px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #1e3a8a);
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #1e3a8a, #1e40af);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #64748b, #475569);
      color: white;
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #475569, #334155);
      transform: translateY(-2px);
    }

    .btn-success {
      background: linear-gradient(135deg, #16a34a, #15803d);
      color: white;
    }

    .btn-success:hover {
      background: linear-gradient(135deg, #15803d, #166534);
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .progress-indicator {
      background: #f1f5f9;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 25px;
    }

    .progress-bar {
      background: #e2e8f0;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      background: linear-gradient(90deg, #3b82f6, #1e3a8a);
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .footer {
      background: #1e3a8a;
      color: white;
      text-align: center;
      padding: 20px;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      .container {
        margin: 10px;
        border-radius: 10px;
      }
      
      .content {
        padding: 20px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .damage-stats {
        grid-template-columns: 1fr 1fr;
      }
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .alert.show {
      display: block;
    }

    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alert.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo"><img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo"></div>
    <div class="title">ירון כיוף שמאות - פורטל</div>
    <div class="subtitle">שמאות והערכת נזקי רכב ורכוש</div>
    <h1>אימות אומדן נזקי רכב</h1>
    <h2 id="pageTitle">תיק מס. ...</h2>

    <div class="content">
      <div id="alerts"></div>
      
      <!-- Progress Indicator -->
      <div class="progress-indicator">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <span style="font-weight: 600; color: #1e3a8a;">התקדמות האימות</span>
          <span id="progress-text">0% הושלם</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
      </div>

      <!-- System Level Validation -->
      <div class="validation-section" id="system-validation">
        <div class="section-header">
          <div class="section-title">אימות ברמת המערכת</div>
          <div class="section-status status-current" id="system-status">בבדיקה</div>
        </div>
        <div class="validation-content">
          
          <!-- 1. FIXED VEHICLE DATA (נתוני רכב) - Always Visible -->
          <div class="form-section">
            <h3>נתוני רכב</h3>
            <div class="form-grid">
              <div>
                <label>מספר רכב:</label>
                <div class="readonly-box" id="carPlate"></div>
              </div>
              <div>
                <label>תוצרת:</label>
                <div class="readonly-box" id="carManufacturer"></div>
              </div>
              <div>
                <label>דגם:</label>
                <div class="readonly-box" id="carModel"></div>
              </div>
              <div>
                <label>שנת ייצור:</label>
                <div class="readonly-box" id="carYear"></div>
              </div>
              <div>
                <label>מחיר בסיס:</label>
                <div class="readonly-box" id="carBasePrice"></div>
              </div>
              <div>
                <label>תאריך הפקה:</label>
                <div class="readonly-box" id="carReportDate"></div>
              </div>
            </div>
          </div>

          <!-- 2. COLLAPSIBLE CLAIM DATA (נתוני תביעה) -->
          <div class="form-section">
            <button class="collapsible-btn" type="button" onclick="toggleSection('priceData')">נתוני תביעה (הצג/הסתר)</button>
            <div id="priceData" style="display:none;">
              <div class="form-grid">
                <div><label>סה״כ תביעה:</label><div class="readonly-box" id="totalClaim"></div></div>
                <div><label>חישוב הערך לנזק גולמי:</label><div class="readonly-box" id="leviPriceList"></div></div>
                <div><label>חישוב האחוז הגולמי:</label><div class="readonly-box" id="grossPercent"></div></div>
                <div><label>סה"כ תביעה (מאושר):</label><div class="readonly-box" id="authorizedClaim"></div></div>
                <div><label>ערך השוק של הרכב:</label><div class="readonly-box" id="finalMarketValue"></div></div>
              </div>
            </div>
          </div>

          <!-- 3. COLLAPSIBLE CONTACT DATA (נתוני התקשרות) -->
          <div class="form-section">
            <button class="collapsible-btn" type="button" onclick="toggleSection('contactData')">נתוני התקשרות (הצג/הסתר)</button>
            <div id="contactData" style="display:none;">
              <div class="form-grid">
                <div><label>שם בעל הרכב:</label><div class="readonly-box" id="ownerName"></div></div>
                <div><label>כתובת בעל הרכב:</label><div class="readonly-box" id="ownerAddress"></div></div>
                <div><label>טלפון בעל הרכב:</label><div class="readonly-box" id="ownerPhone"></div></div>
                <div><label>חברת ביטוח:</label><div class="readonly-box" id="insuranceCompany"></div></div>
                <div><label>אימייל חברת ביטוח:</label><div class="readonly-box" id="insuranceEmail"></div></div>
                <div><label>סוכן ביטוח:</label><div class="readonly-box" id="insuranceAgent"></div></div>
                <div><label>טלפון סוכן ביטוח:</label><div class="readonly-box" id="agentPhone"></div></div>
                <div><label>אימייל סוכן ביטוח:</label><div class="readonly-box" id="agentEmail"></div></div>
              </div>
            </div>
          </div>

          <!-- Levi Report Upload -->
          <div class="validation-item" id="levi-validation">
            <div class="validation-item-header">
              <div class="validation-item-title">העלאת דו"ח לוי יצחק</div>
              <div class="validation-check check-warning" id="levi-check">!</div>
            </div>
            <div id="levi-content">
              <label>סטטוס דו"ח לוי:</label>
              <select class="editable-field" id="levi-status">
                <option value="uploaded">הועלה</option>
                <option value="missing">חסר</option>
                <option value="not-required">לא נדרש</option>
              </select>
            </div>
          </div>

          <!-- Damage Centers Validation -->
          <div class="validation-item" id="damage-centers-validation">
            <div class="validation-item-header">
              <div class="validation-item-title">מוקדי נזק</div>
              <div class="validation-check check-pass" id="damage-centers-check">✓</div>
            </div>
            <div id="damage-centers-content">
              <!-- Will be populated dynamically -->
            </div>
          </div>

          <!-- Summary Validation -->
          <div class="validation-item" id="summary-validation">
            <div class="validation-item-header">
              <div class="validation-item-title">סיכום וסטטוס</div>
              <div class="validation-check check-pass" id="summary-check">✓</div>
            </div>
            <div id="summary-content">
              <label>סטטוס:</label>
              <select class="editable-field" id="case-status">
                <option value="ready">מוכן לאומדן</option>
                <option value="incomplete">לא הושלם</option>
                <option value="requires-review">דרוש סקירה</option>
              </select>
              
              <label>הערות:</label>
              <textarea class="editable-field" id="case-comments" rows="3" placeholder="הוסף הערות לגבי התיק..."></textarea>
            </div>
          </div>

        </div>
      </div>

      <!-- Legal Text Validation -->
      <div class="legal-text-section">
        <div class="legal-text-header">אימות טקסט משפטי</div>
        <div style="margin-bottom: 15px; color: #92400e;">
          הטקסט המשפטי להלן ייכלל באומדן. ניתן לערוך ולהתאים לפי הצורך.
        </div>
        <textarea class="legal-text-content" id="legal-text-content" placeholder="טקסט משפטי ייטען כאן..."></textarea>
      </div>

      <!-- User Level Validation -->
      <div class="validation-section" id="user-validation">
        <div class="section-header">
          <div class="section-title">אימות ברמת המשתמש</div>
          <div class="section-status status-pending" id="user-status">ממתין לאישור</div>
        </div>
        <div class="validation-content">
          <p>בדוק את כל הנתונים לעיל ותקן במידת הצורך. כל השדות ניתנים לעריכה ויכולים להיות מתועלמים במידת הצורך.</p>
          
          <div style="background: #eff6ff; padding: 15px; border-radius: 8px; margin-top: 15px;">
            <strong>הערה חשובה:</strong> שינויים שתבצע כאן יהפכו לאמת המערכת ויורשמו באומדן הסופי.
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button type="button" id="save-validation" class="btn btn-secondary">
          💾 שמור שינויים
        </button>
        <button type="button" id="confirm-validation" class="btn btn-success" disabled>
          ✅ אשר ועבור לבניית אומדן
        </button>
        <button type="button" onclick="window.location.href='estimate-builder.html'" class="btn btn-secondary">
          ⬅️ חזור לבונה אומדן
        </button>
        <button type="button" onclick="window.location.href='selection.html'" class="btn btn-secondary">
          🏠 חזור לדף הבית
        </button>
      </div>
    </div>
    
    <div class="footer">
      All rights reserved © Carmel Cayouf
    </div>
  </div>

  <script type="module">
    import { helper, updateHelper } from './helper.js';
    import { loadLegalText } from './vault-loader.js';
    
    let validationData = {};
    let currentProgress = 0;

    // Toggle Section Function (copied from depreciation module)
    function toggleSection(id) {
      const el = document.getElementById(id);
      if (el) {
        const isHidden = el.style.display === 'none';
        el.style.display = isHidden ? 'block' : 'none';
        console.log(`Toggled section ${id}: ${isHidden ? 'shown' : 'hidden'}`);
      }
    }

    // Make toggleSection globally available
    window.toggleSection = toggleSection;

    // Authentication check
    document.addEventListener('DOMContentLoaded', () => {
      console.log('🔄 Estimate Validation: Initializing...');
      
      const auth = sessionStorage.getItem("auth");
      if (!auth) {
        console.error('❌ No authentication found');
        showAlert("הגישה חסומה - אנא התחבר דרך דף הבית", 'error');
        setTimeout(() => {
          window.location.href = "index.html";
        }, 2000);
        return;
      }

      const helperData = sessionStorage.getItem('helper');
      const selectedReportType = sessionStorage.getItem('selectedReportType');
      
      if (!helperData || selectedReportType !== 'estimate') {
        console.error('❌ Missing required data for validation');
        showAlert('שגיאה: נתונים חסרים לאימות. חוזר לדף הבחירה...', 'error');
        setTimeout(() => {
          window.location.href = 'selection.html';
        }, 2000);
        return;
      }

      console.log('✅ Estimate Validation: Authentication and data validated');
      initializeValidation();
    });

    function initializeValidation() {
      loadSystemValidation();
      loadLegalTextValidation();
      setupEventListeners();
      updateProgress();
    }

    function loadSystemValidation() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Load meta and vehicle data
      const carDetails = helper.car_details || {};
      const meta = helper.meta || {};
      const vehicle = helper.vehicle || {};
      const client = helper.client || {};
      const levi = helper.expertise?.levi_report || {};
      const calc = helper.expertise?.calculations || {};
      
      // Update page title
      if (document.getElementById('pageTitle')) {
        document.getElementById('pageTitle').innerText = `תיק מס. ${meta.case_id || meta.plate || '...'}`;
      }
      
      // Load car details (נתוני רכב) - Fixed data from depreciation module pattern
      if (document.getElementById('carPlate')) document.getElementById('carPlate').innerText = meta.plate || carDetails.plate || '';
      if (document.getElementById('carManufacturer')) document.getElementById('carManufacturer').innerText = carDetails.manufacturer || vehicle.manufacturer || '';
      if (document.getElementById('carModel')) document.getElementById('carModel').innerText = carDetails.model || vehicle.model || '';
      if (document.getElementById('carYear')) document.getElementById('carYear').innerText = carDetails.year || vehicle.year || '';
      if (document.getElementById('carBasePrice')) document.getElementById('carBasePrice').innerText = levi.base_price || '';
      if (document.getElementById('carReportDate')) document.getElementById('carReportDate').innerText = levi.report_date || '';

      // Load claim data (נתוני תביעה) - Collapsible section from depreciation module pattern
      if (document.getElementById('totalClaim')) document.getElementById('totalClaim').innerText = calc.total_damage || '';
      if (document.getElementById('grossPercent')) document.getElementById('grossPercent').innerText = calc.damage_percent ? `${calc.damage_percent}%` : '';
      if (document.getElementById('authorizedClaim')) document.getElementById('authorizedClaim').innerText = calc.total_damage || '';
      if (document.getElementById('finalMarketValue')) document.getElementById('finalMarketValue').innerText = levi.final_price || calc.market_value || '';

      if (document.getElementById('leviPriceList')) {
        const adj = levi.adjustments || {};
        const parts = Object.keys(adj).map(k => {
          const a = adj[k] || {}; return a.percent ? `${k}:${a.percent}%(${a.value})` : '';
        }).filter(Boolean);
        document.getElementById('leviPriceList').innerText = parts.join(', ');
      }

      // Load contact data (נתוני התקשרות) - Collapsible section from depreciation module pattern
      if (document.getElementById('ownerName')) document.getElementById('ownerName').innerText = client.name || '';
      if (document.getElementById('ownerAddress')) document.getElementById('ownerAddress').innerText = client.address || '';
      if (document.getElementById('ownerPhone')) document.getElementById('ownerPhone').innerText = client.phone_number || '';
      if (document.getElementById('insuranceCompany')) document.getElementById('insuranceCompany').innerText = client.insurance_company || '';
      if (document.getElementById('insuranceEmail')) document.getElementById('insuranceEmail').innerText = client.insurance_email || '';
      if (document.getElementById('insuranceAgent')) document.getElementById('insuranceAgent').innerText = client.insurance_agent || '';
      if (document.getElementById('agentPhone')) document.getElementById('agentPhone').innerText = client.insurance_agent_phone || '';
      if (document.getElementById('agentEmail')) document.getElementById('agentEmail').innerText = client.insurance_agent_email || '';

      // Load damage centers
      loadDamageCenters(helper.damage_sections || []);
      
      // Validate all sections
      validateCarDetails();
      validateLeviReport();
      validateDamageCenters();
      validateSummary();
    }

    function loadDamageCenters(damageSections) {
      const container = document.getElementById('damage-centers-content');
      
      if (!damageSections || damageSections.length === 0) {
        container.innerHTML = '<p style="color: #dc2626;">לא נמצאו מוקדי נזק באקספרטיזה</p>';
        return;
      }

      container.innerHTML = damageSections.map((center, index) => `
        <div class="damage-center-validation">
          <div class="damage-center-header">מוקד נזק ${index + 1}: ${center.zone || 'לא מוגדר'}</div>
          
          <label>שם:</label>
          <input type="text" class="editable-field" value="${center.zone || ''}" data-field="zone" data-index="${index}">
          
          <label>תיאור:</label>
          <input type="text" class="editable-field" value="${center.zone_description || ''}" data-field="description" data-index="${index}">
          
          <div class="damage-stats">
            <div class="stat-item">
              <div class="stat-label">עבודות</div>
              <div class="stat-value">${center.works?.length || 0}</div>
              <input type="number" class="editable-field" value="${calculateWorksTotal(center.works)}" data-field="works_total" data-index="${index}" placeholder="סה״כ עלות עבודות">
            </div>
            <div class="stat-item">
              <div class="stat-label">חלקים</div>
              <div class="stat-value">${center.parts?.length || 0}</div>
              <input type="number" class="editable-field" value="${calculatePartsTotal(center.parts)}" data-field="parts_total" data-index="${index}" placeholder="סה״כ עלות חלקים">
            </div>
            <div class="stat-item">
              <div class="stat-label">תיקונים</div>
              <div class="stat-value">${center.repairs?.length || 0}</div>
              <input type="number" class="editable-field" value="${calculateRepairsTotal(center.repairs)}" data-field="repairs_total" data-index="${index}" placeholder="סה״כ עלות תיקונים">
            </div>
          </div>
        </div>
      `).join('');
    }

    function calculateWorksTotal(works) {
      if (!works || !Array.isArray(works)) return 0;
      return works.reduce((total, work) => total + (parseFloat(work.cost) || 0), 0);
    }

    function calculatePartsTotal(parts) {
      if (!parts || !Array.isArray(parts)) return 0;
      return parts.reduce((total, part) => total + (parseFloat(part.cost) || 0), 0);
    }

    function calculateRepairsTotal(repairs) {
      if (!repairs || !Array.isArray(repairs)) return 0;
      return repairs.reduce((total, repair) => total + (parseFloat(repair.cost) || 0), 0);
    }

    async function loadLegalTextValidation() {
      try {
        // Get estimate type from session
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        const estimateType = helper.estimate_type || 'אובדן_להלכה';
        
        // Load legal text from existing vault
        const legalText = await loadLegalText(`estimate_${estimateType}`);
        document.getElementById('legal-text-content').value = legalText || 'טקסט משפטי לא נמצא';
      } catch (error) {
        console.error('Error loading legal text:', error);
        document.getElementById('legal-text-content').value = 'שגיאה בטעינת הטקסט המשפטי';
      }
    }

    function validateCarDetails() {
      const plate = document.getElementById('carPlate')?.innerText;
      const manufacturer = document.getElementById('carManufacturer')?.innerText;
      
      const isValid = plate && manufacturer;
      updateValidationCheck('car-details-check', isValid);
      return isValid;
    }

    function validateLeviReport() {
      const leviStatus = document.getElementById('levi-status').value;
      const isValid = leviStatus !== 'missing';
      updateValidationCheck('levi-check', isValid, leviStatus === 'not-required' ? 'warning' : 'pass');
      return isValid;
    }

    function validateDamageCenters() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      const damageSections = helper.damage_sections || [];
      const isValid = damageSections.length > 0;
      updateValidationCheck('damage-centers-check', isValid);
      return isValid;
    }

    function validateSummary() {
      const status = document.getElementById('case-status').value;
      const isValid = status === 'ready';
      updateValidationCheck('summary-check', isValid, status === 'requires-review' ? 'warning' : (isValid ? 'pass' : 'fail'));
      return isValid;
    }

    function updateValidationCheck(checkId, isValid, type = null) {
      const check = document.getElementById(checkId);
      if (!check) return;

      check.className = 'validation-check';
      
      if (type === 'warning') {
        check.classList.add('check-warning');
        check.textContent = '!';
      } else if (isValid) {
        check.classList.add('check-pass');
        check.textContent = '✓';
      } else {
        check.classList.add('check-fail');
        check.textContent = '✗';
      }
    }

    function updateProgress() {
      const validations = [
        validateCarDetails(),
        validateLeviReport(),
        validateDamageCenters(),
        validateSummary()
      ];
      
      const completedCount = validations.filter(v => v).length;
      currentProgress = Math.round((completedCount / validations.length) * 100);
      
      document.getElementById('progress-fill').style.width = currentProgress + '%';
      document.getElementById('progress-text').textContent = currentProgress + '% הושלם';
      
      // Enable confirm button when validation is complete
      const confirmBtn = document.getElementById('confirm-validation');
      confirmBtn.disabled = currentProgress < 100;
      
      // Update section statuses
      if (currentProgress === 100) {
        document.getElementById('system-status').textContent = 'הושלם';
        document.getElementById('system-status').className = 'section-status status-completed';
        document.getElementById('system-validation').classList.add('completed');
      }
    }

    function setupEventListeners() {
      // Save validation data
      document.getElementById('save-validation').addEventListener('click', saveValidationData);
      
      // Confirm and proceed
      document.getElementById('confirm-validation').addEventListener('click', confirmAndProceed);
      
      // Update validation on field changes
      document.addEventListener('change', (e) => {
        if (e.target.classList.contains('editable-field')) {
          updateProgress();
        }
      });

      // Auto-save on input
      document.addEventListener('input', (e) => {
        if (e.target.classList.contains('editable-field')) {
          saveValidationData();
        }
      });
    }

    function saveValidationData() {
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        // Update validation data
        helper.validation = {
          levi_status: document.getElementById('levi-status').value,
          case_status: document.getElementById('case-status').value,
          case_comments: document.getElementById('case-comments').value,
          legal_text: document.getElementById('legal-text-content').value,
          validated_at: new Date().toISOString(),
          validated_by: 'user'
        };

        // Update damage centers with validation data
        const damageInputs = document.querySelectorAll('[data-field]');
        damageInputs.forEach(input => {
          const field = input.dataset.field;
          const index = parseInt(input.dataset.index);
          
          if (helper.damage_sections && helper.damage_sections[index]) {
            if (field === 'zone') {
              helper.damage_sections[index].zone = input.value;
            } else if (field === 'description') {
              helper.damage_sections[index].zone_description = input.value;
            } else if (field.endsWith('_total')) {
              helper.damage_sections[index][field] = parseFloat(input.value) || 0;
            }
          }
        });

        sessionStorage.setItem('helper', JSON.stringify(helper));
        showAlert('נתוני האימות נשמרו בהצלחה', 'success');
        
      } catch (error) {
        console.error('Error saving validation data:', error);
        showAlert('שגיאה בשמירת נתוני האימות', 'error');
      }
    }

    function confirmAndProceed() {
      if (currentProgress < 100) {
        showAlert('יש להשלים את כל האימותים לפני המעבר הלאה', 'warning');
        return;
      }

      saveValidationData();
      
      // Set validation as completed
      sessionStorage.setItem('estimateValidationCompleted', 'true');
      
      showAlert('אימות הושלם בהצלחה! עובר לבניית אומדן...', 'success');
      
      setTimeout(() => {
        window.location.href = 'estimate-report-builder.html';
      }, 1500);
    }

    function showAlert(message, type = 'success') {
      const alertsContainer = document.getElementById('alerts');
      const alert = document.createElement('div');
      alert.className = `alert ${type} show`;
      alert.textContent = message;
      alertsContainer.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    // Make functions globally available
    window.saveValidationData = saveValidationData;
    window.confirmAndProceed = confirmAndProceed;
  </script>
</body>
</html>