<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××™××•×ª ××•××“×Ÿ - ×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª</title>
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  
  <!-- OneSignal Push -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">

  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "3b924b99-c302-4919-a97e-baf909394696",
      });
    });
  </script>

  <style>
    body {
      font-family: sans-serif;
      background: #f3f6fb;
      margin: 0;
      min-height: 100vh;
      padding: 0;
      padding-top: 90px;
      overflow-x: hidden;
    }
    .container {
      width: 100%;
      max-width:750px;
      background: #fff;
      padding: 32px 24px 24px 24px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.08);
      margin: 32px auto 32px auto;
      box-sizing: border-box;
    }
    .logo {
      display: flex;
      justify-content: center;
      margin-bottom: 8px;
    }
    .logo img {
      width: 112px;
      height: auto;
      display: block;
    }
    .title { font-size: 27px; font-weight: bold; text-align: center; margin-bottom: 2px; font-weight: 900;}
    .subtitle { font-size: 23px; color: #666; text-align: center; margin-bottom: 10px;}
    h1, h2 { color: #1e3a8a; font-size: 25px; text-align: center; margin: 15px 0 8px 0; font-weight: 600;}
    h3 { color: #1e3a8a; font-size: 24px; margin: 22px 0 12px 0; text-align: right; font-weight: 900;}
    .form-section {
      width: 100%;
      margin-bottom: 20px;
      background: #fafbfe;
      border-radius: 12px;
      padding: 17px 15px 12px 15px;
      box-sizing: border-box;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px 18px;
      width: 100%;
    }
    @media (max-width: 600px) {
      .form-grid { grid-template-columns: 1fr; }
      .container { padding: 14px 2vw 20px 2vw; }
    }
    
    /* Mobile viewport fixes */
    @media (max-width: 768px) {
      body {
        width: 100vw;
        overflow-x: hidden !important;
        position: relative;
      }
      
      html {
        width: 100vw;
        overflow-x: hidden !important;
      }
      
      .container {
        width: 95vw;
        max-width: 95vw;
        margin: 32px 2.5vw 32px 2.5vw;
      }
    }
    label {
      font-size: 18px;
      margin-bottom: 4px;
      display: block;
      text-align: right;
    }
    input, select, textarea {
      width: 100%;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 0px;
      padding: 8px 9px;
      box-sizing: border-box;
      text-align: right;
      background: #f9f9f9;
      transition: border .15s;
      outline: none;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #3b82f6;
    }
    .readonly-box {
      background: #f4f6fa;
      border-radius: 6px;
      border: 1px solid #eee;
      padding: 7px 8px;
      min-height: 30px;
      font-size: 16px;
      color: #222;
      margin-bottom: 0;
    }
    .form-row { margin-bottom: 13px;}
    .collapsible-btn {
      background: #e0e7f1;
      font-family: sans-serif;
      color: #1e3a8a;
      border: none;
      padding: 7px 18px;
      border-radius: 7px;
      margin-bottom: 8px;
      margin-top: 2px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      text-align: right;
      width: auto;
      display: inline-block;
    }
    button, .btn {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      color: white;
      background-color: #3b82f6;
      margin-top: 16px;
      margin-bottom: 0;
      cursor: pointer;
      font-weight: 600;
      transition: background .2s;
    }
    .btn.add {
      background: #28a745;
      margin-top: 7px;
      margin-bottom: 0;
      width: auto;
      padding: 8px 18px;
      font-size: 16px;
    }
    button:hover, .btn:hover {
      background-color: #2563eb;
    }
    .btn.add:hover {
      background: #218838;
    }
    
    /* Validation specific styles */
    .validation-indicator {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }
    
    .validation-pass {
      background: #16a34a;
      color: white;
    }
    
    .validation-fail {
      background: #dc2626;
      color: white;
    }
    
    .validation-warning {
      background: #f59e0b;
      color: white;
    }
    
    .legal-text-section {
      background: #fef3c7;
      border: 2px solid #f59e0b;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
    }
    
    .legal-text-header {
      font-size: 18px;
      font-weight: bold;
      color: #92400e;
      margin-bottom: 15px;
    }
    
    .legal-text-content {
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 15px;
      min-height: 150px;
      font-size: 14px;
      line-height: 1.6;
      resize: vertical;
      width: 100%;
      box-sizing: border-box;
    }
    
    .damage-center-item {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    
    .damage-center-header {
      background: #f1f5f9;
      padding: 10px 15px;
      margin: -15px -15px 15px -15px;
      border-radius: 8px 8px 0 0;
      font-weight: bold;
      color: #1e3a8a;
    }
    
    .damage-center-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    
    .damage-center-stat {
      text-align: center;
      padding: 8px;
      background: #f8fafc;
      border-radius: 6px;
    }
    
    .damage-center-stat label {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 5px;
    }
    
    .progress-section {
      background: #f1f5f9;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 25px;
    }
    
    .progress-bar {
      background: #e2e8f0;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .progress-fill {
      background: linear-gradient(90deg, #3b82f6, #1e3a8a);
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }
    
    .alert.show {
      display: block;
    }
    
    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .alert.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo"><img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo"></div>
    <div class="title">×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×¤×•×¨×˜×œ</div>
    <div class="subtitle">×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</div>
    <h1>××™××•×ª ××•××“×Ÿ × ×–×§×™ ×¨×›×‘</h1>
    <h2 id="pageTitle">×ª×™×§ ××¡. ...</h2>

    <div id="alerts"></div>
    
    <!-- Progress Indicator -->
    <div class="progress-section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <span style="font-weight: 600; color: #1e3a8a;">×”×ª×§×“××•×ª ×”××™××•×ª</span>
        <span id="progress-text">0% ×”×•×©×œ×</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
      </div>
    </div>

    <!-- 1. FIXED VEHICLE DATA (× ×ª×•× ×™ ×¨×›×‘) - Always Visible -->
    <div class="form-section">
      <h3>× ×ª×•× ×™ ×¨×›×‘ <span class="validation-indicator validation-pass" id="car-details-validation">âœ“</span></h3>
      <div class="form-grid">
        <div>
          <label>××¡×¤×¨ ×¨×›×‘:</label>
          <input type="text" id="plate-number" readonly>
        </div>
        <div>
          <label>×™×¦×¨×Ÿ:</label>
          <input type="text" id="manufacturer">
        </div>
        <div>
          <label>×“×’×:</label>
          <input type="text" id="model">
        </div>
        <div>
          <label>×©× ×ª ×™×¦×•×¨:</label>
          <input type="text" id="year">
        </div>
        <div>
          <label>××—×™×¨ ×‘×¡×™×¡:</label>
          <div class="readonly-box" id="carBasePrice"></div>
        </div>
        <div>
          <label>×ª××¨×™×š ×”×¤×§×”:</label>
          <div class="readonly-box" id="carReportDate"></div>
        </div>
      </div>
    </div>

    <!-- 2. COLLAPSIBLE CLAIM DATA (× ×ª×•× ×™ ×ª×‘×™×¢×”) -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('claimData')">× ×ª×•× ×™ ×ª×‘×™×¢×” (×”×¦×’/×”×¡×ª×¨) <span class="validation-indicator validation-pass" id="claim-validation">âœ“</span></button>
      <div id="claimData" style="display:none;">
        
        <!-- Levi Report Upload -->
        <div class="form-row">
          <label>×¡×˜×˜×•×¡ ×“×•"×— ×œ×•×™ ×™×¦×—×§:</label>
          <select id="levi-status">
            <option value="uploaded">×”×•×¢×œ×”</option>
            <option value="missing">×—×¡×¨</option>
            <option value="not-required">×œ× × ×“×¨×©</option>
          </select>
        </div>
        
        <!-- Damage Centers Section -->
        <div style="margin-top: 20px;">
          <label style="font-weight: bold; color: #1e3a8a; margin-bottom: 10px;">××•×§×“×™ × ×–×§:</label>
          <div id="damage-centers-content">
            <!-- Will be populated dynamically -->
          </div>
        </div>
        
        <div class="form-grid" style="margin-top: 15px;">
          <div>
            <label>×¡×”×´×› ×ª×‘×™×¢×”:</label>
            <div class="readonly-box" id="totalClaim"></div>
          </div>
          <div>
            <label>××—×•×– × ×–×§ ×’×•×œ××™:</label>
            <div class="readonly-box" id="grossPercent"></div>
          </div>
          <div>
            <label>×¡×”"×› ×ª×‘×™×¢×” (×××•×©×¨):</label>
            <div class="readonly-box" id="authorizedClaim"></div>
          </div>
          <div>
            <label>×¢×¨×š ×”×©×•×§ ×©×œ ×”×¨×›×‘:</label>
            <div class="readonly-box" id="finalMarketValue"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 3. COLLAPSIBLE CONTACT DATA (× ×ª×•× ×™ ×”×ª×§×©×¨×•×ª) -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('contactData')">× ×ª×•× ×™ ×”×ª×§×©×¨×•×ª (×”×¦×’/×”×¡×ª×¨) <span class="validation-indicator validation-pass" id="contact-validation">âœ“</span></button>
      <div id="contactData" style="display:none;">
        <div class="form-grid">
          <div>
            <label>×©× ×‘×¢×œ ×”×¨×›×‘:</label>
            <input type="text" id="ownerName">
          </div>
          <div>
            <label>×›×ª×•×‘×ª ×‘×¢×œ ×”×¨×›×‘:</label>
            <input type="text" id="ownerAddress">
          </div>
          <div>
            <label>×˜×œ×¤×•×Ÿ ×‘×¢×œ ×”×¨×›×‘:</label>
            <input type="text" id="ownerPhone">
          </div>
          <div>
            <label>×—×‘×¨×ª ×‘×™×˜×•×—:</label>
            <input type="text" id="insuranceCompany">
          </div>
          <div>
            <label>××™××™×™×œ ×—×‘×¨×ª ×‘×™×˜×•×—:</label>
            <input type="text" id="insuranceEmail">
          </div>
          <div>
            <label>×¡×•×›×Ÿ ×‘×™×˜×•×—:</label>
            <input type="text" id="insuranceAgent">
          </div>
          <div>
            <label>×˜×œ×¤×•×Ÿ ×¡×•×›×Ÿ ×‘×™×˜×•×—:</label>
            <input type="text" id="agentPhone">
          </div>
          <div>
            <label>××™××™×™×œ ×¡×•×›×Ÿ ×‘×™×˜×•×—:</label>
            <input type="text" id="agentEmail">
          </div>
        </div>
      </div>
    </div>

    <!-- Legal Text Validation -->
    <div class="legal-text-section">
      <div class="legal-text-header">×˜×§×¡×˜ ××©×¤×˜×™ <span class="validation-indicator validation-pass" id="legal-validation">âœ“</span></div>
      <div style="margin-bottom: 15px; color: #92400e;">
        ×”×˜×§×¡×˜ ×”××©×¤×˜×™ ×œ×”×œ×Ÿ ×™×™×›×œ×œ ×‘××•××“×Ÿ. × ×™×ª×Ÿ ×œ×¢×¨×•×š ×•×œ×”×ª××™× ×œ×¤×™ ×”×¦×•×¨×š.
      </div>
      <textarea class="legal-text-content" id="legal-text-content" placeholder="×˜×§×¡×˜ ××©×¤×˜×™ ×™×™×˜×¢×Ÿ ×›××Ÿ..."></textarea>
    </div>

    <!-- Summary and Status -->
    <div class="form-section">
      <h3>×¡×™×›×•× ×•×¡×˜×˜×•×¡ <span class="validation-indicator validation-pass" id="summary-validation">âœ“</span></h3>
      <div class="form-grid">
        <div>
          <label>×¡×˜×˜×•×¡ ××™××•×ª:</label>
          <select id="case-status">
            <option value="ready">××•×›×Ÿ ×œ××•××“×Ÿ</option>
            <option value="incomplete">×œ× ×”×•×©×œ×</option>
            <option value="requires-review">×“×¨×•×© ×¡×§×™×¨×”</option>
          </select>
        </div>
        <div>
          <label>×”×¢×¨×•×ª:</label>
          <textarea id="case-comments" rows="3" placeholder="×”×•×¡×£ ×”×¢×¨×•×ª ×œ×’×‘×™ ×”×ª×™×§..."></textarea>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 40px;">
      <button type="button" id="save-validation" class="btn" style="background: #64748b;">
        ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×
      </button>
      <button type="button" id="confirm-validation" class="btn" style="background: #16a34a;" disabled>
        âœ… ××©×¨ ×•×¢×‘×•×¨ ×œ×‘× ×™×™×ª ××•××“×Ÿ
      </button>
      <button type="button" onclick="window.location.href='estimate-builder.html'" class="btn" style="background: #64748b;">
        â¬…ï¸ ×—×–×•×¨ ×œ×‘×•× ×” ××•××“×Ÿ
      </button>
      <button type="button" onclick="window.location.href='selection.html'" class="btn" style="background: #64748b;">
        ğŸ  ×—×–×•×¨ ×œ×“×£ ×”×‘×™×ª
      </button>
    </div>
  </div>

  <div style="background: #1e3a8a; color: white; text-align: center; padding: 20px; font-size: 14px;">
    All rights reserved Â© Carmel Cayouf
  </div>

  <script type="module">
    import { helper, updateHelper } from './helper.js';
    import { loadLegalText } from './vault-loader.js';
    
    let validationData = {};
    let currentProgress = 0;

    // Toggle Section Function (copied from depreciation module)
    function toggleSection(id) {
      const el = document.getElementById(id);
      if (el) {
        const isHidden = el.style.display === 'none';
        el.style.display = isHidden ? 'block' : 'none';
        console.log(`Toggled section ${id}: ${isHidden ? 'shown' : 'hidden'}`);
      }
    }

    // Make toggleSection globally available
    window.toggleSection = toggleSection;

    // Authentication check
    document.addEventListener('DOMContentLoaded', () => {
      console.log('ğŸ”„ Estimate Validation: Initializing...');
      
      const auth = sessionStorage.getItem("auth");
      if (!auth) {
        console.error('âŒ No authentication found');
        showAlert("×”×’×™×©×” ×—×¡×•××” - ×× × ×”×ª×—×‘×¨ ×“×¨×š ×“×£ ×”×‘×™×ª", 'error');
        setTimeout(() => {
          window.location.href = "index.html";
        }, 2000);
        return;
      }

      const helperData = sessionStorage.getItem('helper');
      const selectedReportType = sessionStorage.getItem('selectedReportType');
      
      if (!helperData || selectedReportType !== 'estimate') {
        console.error('âŒ Missing required data for validation');
        showAlert('×©×’×™××”: × ×ª×•× ×™× ×—×¡×¨×™× ×œ××™××•×ª. ×—×•×–×¨ ×œ×“×£ ×”×‘×—×™×¨×”...', 'error');
        setTimeout(() => {
          window.location.href = 'selection.html';
        }, 2000);
        return;
      }

      console.log('âœ… Estimate Validation: Authentication and data validated');
      initializeValidation();
    });

    function initializeValidation() {
      loadSystemValidation();
      loadLegalTextValidation();
      setupEventListeners();
      updateProgress();
    }

    function loadSystemValidation() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Load meta and vehicle data
      const carDetails = helper.car_details || {};
      const meta = helper.meta || {};
      const vehicle = helper.vehicle || {};
      const client = helper.client || {};
      const levi = helper.expertise?.levi_report || {};
      const calc = helper.expertise?.calculations || {};
      
      // Update page title
      if (document.getElementById('pageTitle')) {
        document.getElementById('pageTitle').innerText = `×ª×™×§ ××¡. ${meta.case_id || meta.plate || '...'}`;
      }
      
      // Load car details (× ×ª×•× ×™ ×¨×›×‘)
      document.getElementById('plate-number').value = meta.plate || carDetails.plate || '';
      document.getElementById('manufacturer').value = carDetails.manufacturer || vehicle.manufacturer || '';
      document.getElementById('model').value = carDetails.model || vehicle.model || '';
      document.getElementById('year').value = carDetails.year || vehicle.year || '';
      
      if (document.getElementById('carBasePrice')) {
        document.getElementById('carBasePrice').innerText = levi.base_price || '';
      }
      if (document.getElementById('carReportDate')) {
        document.getElementById('carReportDate').innerText = levi.report_date || '';
      }

      // Load claim data (× ×ª×•× ×™ ×ª×‘×™×¢×”)
      if (document.getElementById('totalClaim')) {
        document.getElementById('totalClaim').innerText = calc.total_damage || '';
      }
      if (document.getElementById('grossPercent')) {
        document.getElementById('grossPercent').innerText = calc.damage_percent ? `${calc.damage_percent}%` : '';
      }
      if (document.getElementById('authorizedClaim')) {
        document.getElementById('authorizedClaim').innerText = calc.total_damage || '';
      }
      if (document.getElementById('finalMarketValue')) {
        document.getElementById('finalMarketValue').innerText = levi.final_price || calc.market_value || '';
      }

      // Load contact data (× ×ª×•× ×™ ×”×ª×§×©×¨×•×ª)
      document.getElementById('ownerName').value = client.name || '';
      document.getElementById('ownerAddress').value = client.address || '';
      document.getElementById('ownerPhone').value = client.phone_number || '';
      document.getElementById('insuranceCompany').value = client.insurance_company || '';
      document.getElementById('insuranceEmail').value = client.insurance_email || '';
      document.getElementById('insuranceAgent').value = client.insurance_agent || '';
      document.getElementById('agentPhone').value = client.insurance_agent_phone || '';
      document.getElementById('agentEmail').value = client.insurance_agent_email || '';

      // Load damage centers
      loadDamageCenters(helper.damage_sections || []);
      
      // Validate all sections
      validateCarDetails();
      validateClaimData();
      validateContactData();
      validateLegalText();
      validateSummary();
    }

    function loadDamageCenters(damageSections) {
      const container = document.getElementById('damage-centers-content');
      
      if (!damageSections || damageSections.length === 0) {
        container.innerHTML = '<p style="color: #dc2626;">×œ× × ××¦××• ××•×§×“×™ × ×–×§ ×‘××§×¡×¤×¨×˜×™×–×”</p>';
        return;
      }

      container.innerHTML = damageSections.map((center, index) => `
        <div class="damage-center-item">
          <div class="damage-center-header">××•×§×“ × ×–×§ ${index + 1}: ${center.zone || '×œ× ××•×’×“×¨'}</div>
          
          <div class="form-grid">
            <div>
              <label>×©×:</label>
              <input type="text" value="${center.zone || ''}" data-field="zone" data-index="${index}">
            </div>
            <div>
              <label>×ª×™××•×¨:</label>
              <input type="text" value="${center.zone_description || ''}" data-field="description" data-index="${index}">
            </div>
          </div>
          
          <div class="damage-center-grid">
            <div class="damage-center-stat">
              <label>×¢×‘×•×“×•×ª: ${center.works?.length || 0}</label>
              <input type="number" value="${calculateWorksTotal(center.works)}" data-field="works_total" data-index="${index}" placeholder="×¡×”×´×› ×¢×œ×•×ª">
            </div>
            <div class="damage-center-stat">
              <label>×—×œ×§×™×: ${center.parts?.length || 0}</label>
              <input type="number" value="${calculatePartsTotal(center.parts)}" data-field="parts_total" data-index="${index}" placeholder="×¡×”×´×› ×¢×œ×•×ª">
            </div>
            <div class="damage-center-stat">
              <label>×ª×™×§×•× ×™×: ${center.repairs?.length || 0}</label>
              <input type="number" value="${calculateRepairsTotal(center.repairs)}" data-field="repairs_total" data-index="${index}" placeholder="×¡×”×´×› ×¢×œ×•×ª">
            </div>
          </div>
        </div>
      `).join('');
    }

    function calculateWorksTotal(works) {
      if (!works || !Array.isArray(works)) return 0;
      return works.reduce((total, work) => total + (parseFloat(work.cost) || 0), 0);
    }

    function calculatePartsTotal(parts) {
      if (!parts || !Array.isArray(parts)) return 0;
      return parts.reduce((total, part) => total + (parseFloat(part.cost) || 0), 0);
    }

    function calculateRepairsTotal(repairs) {
      if (!repairs || !Array.isArray(repairs)) return 0;
      return repairs.reduce((total, repair) => total + (parseFloat(repair.cost) || 0), 0);
    }

    async function loadLegalTextValidation() {
      try {
        // Get estimate type from session
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        const estimateType = helper.estimate_type || '××•×‘×“×Ÿ_×œ×”×œ×›×”';
        
        // Load legal text from existing vault
        const legalText = await loadLegalText(`estimate_${estimateType}`);
        document.getElementById('legal-text-content').value = legalText || '×˜×§×¡×˜ ××©×¤×˜×™ ×œ× × ××¦×';
        validateLegalText();
      } catch (error) {
        console.error('Error loading legal text:', error);
        document.getElementById('legal-text-content').value = '×©×’×™××” ×‘×˜×¢×™× ×ª ×”×˜×§×¡×˜ ×”××©×¤×˜×™';
      }
    }

    function validateCarDetails() {
      const plate = document.getElementById('plate-number').value;
      const manufacturer = document.getElementById('manufacturer').value;
      
      const isValid = plate && manufacturer;
      updateValidationIndicator('car-details-validation', isValid);
      return isValid;
    }

    function validateClaimData() {
      const leviStatus = document.getElementById('levi-status').value;
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      const damageSections = helper.damage_sections || [];
      
      const isValid = leviStatus !== 'missing' && damageSections.length > 0;
      updateValidationIndicator('claim-validation', isValid, leviStatus === 'not-required' ? 'warning' : 'pass');
      return isValid;
    }

    function validateContactData() {
      const ownerName = document.getElementById('ownerName').value;
      const ownerPhone = document.getElementById('ownerPhone').value;
      
      const isValid = ownerName || ownerPhone; // At least one contact method
      updateValidationIndicator('contact-validation', isValid);
      return isValid;
    }

    function validateLegalText() {
      const legalText = document.getElementById('legal-text-content').value.trim();
      const isValid = legalText.length > 0 && !legalText.includes('×©×’×™××”') && !legalText.includes('×œ× × ××¦×');
      updateValidationIndicator('legal-validation', isValid);
      return isValid;
    }

    function validateSummary() {
      const status = document.getElementById('case-status').value;
      const isValid = status === 'ready';
      updateValidationIndicator('summary-validation', isValid, status === 'requires-review' ? 'warning' : (isValid ? 'pass' : 'fail'));
      return isValid;
    }

    function updateValidationIndicator(indicatorId, isValid, type = null) {
      const indicator = document.getElementById(indicatorId);
      if (!indicator) return;

      indicator.className = 'validation-indicator';
      
      if (type === 'warning') {
        indicator.classList.add('validation-warning');
        indicator.textContent = '!';
      } else if (isValid) {
        indicator.classList.add('validation-pass');
        indicator.textContent = 'âœ“';
      } else {
        indicator.classList.add('validation-fail');
        indicator.textContent = 'âœ—';
      }
    }

    function updateProgress() {
      const validations = [
        validateCarDetails(),
        validateClaimData(),
        validateContactData(),
        validateLegalText(),
        validateSummary()
      ];
      
      const completedCount = validations.filter(v => v).length;
      currentProgress = Math.round((completedCount / validations.length) * 100);
      
      document.getElementById('progress-fill').style.width = currentProgress + '%';
      document.getElementById('progress-text').textContent = currentProgress + '% ×”×•×©×œ×';
      
      // Enable confirm button when validation is complete
      const confirmBtn = document.getElementById('confirm-validation');
      confirmBtn.disabled = currentProgress < 100;
    }

    function setupEventListeners() {
      // Save validation data
      document.getElementById('save-validation').addEventListener('click', saveValidationData);
      
      // Confirm and proceed
      document.getElementById('confirm-validation').addEventListener('click', confirmAndProceed);
      
      // Update validation on field changes
      document.addEventListener('change', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
          updateProgress();
        }
      });

      // Auto-save on input
      document.addEventListener('input', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
          saveValidationData();
        }
      });
    }

    function saveValidationData() {
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        // Update car details
        helper.car_details = helper.car_details || {};
        helper.car_details.manufacturer = document.getElementById('manufacturer').value;
        helper.car_details.model = document.getElementById('model').value;
        helper.car_details.year = document.getElementById('year').value;
        
        // Update client data (contact information)
        helper.client = helper.client || {};
        helper.client.name = document.getElementById('ownerName').value;
        helper.client.address = document.getElementById('ownerAddress').value;
        helper.client.phone_number = document.getElementById('ownerPhone').value;
        helper.client.insurance_company = document.getElementById('insuranceCompany').value;
        helper.client.insurance_email = document.getElementById('insuranceEmail').value;
        helper.client.insurance_agent = document.getElementById('insuranceAgent').value;
        helper.client.insurance_agent_phone = document.getElementById('agentPhone').value;
        helper.client.insurance_agent_email = document.getElementById('agentEmail').value;
        
        // Update validation data
        helper.validation = {
          levi_status: document.getElementById('levi-status').value,
          case_status: document.getElementById('case-status').value,
          case_comments: document.getElementById('case-comments').value,
          legal_text: document.getElementById('legal-text-content').value,
          validated_at: new Date().toISOString(),
          validated_by: 'user'
        };

        // Update damage centers with validation data
        const damageInputs = document.querySelectorAll('[data-field]');
        damageInputs.forEach(input => {
          const field = input.dataset.field;
          const index = parseInt(input.dataset.index);
          
          if (helper.damage_sections && helper.damage_sections[index]) {
            if (field === 'zone') {
              helper.damage_sections[index].zone = input.value;
            } else if (field === 'description') {
              helper.damage_sections[index].zone_description = input.value;
            } else if (field.endsWith('_total')) {
              helper.damage_sections[index][field] = parseFloat(input.value) || 0;
            }
          }
        });

        sessionStorage.setItem('helper', JSON.stringify(helper));
        console.log('âœ… Validation data saved successfully');
        
      } catch (error) {
        console.error('Error saving validation data:', error);
        showAlert('×©×’×™××” ×‘×©××™×¨×ª × ×ª×•× ×™ ×”××™××•×ª', 'error');
      }
    }

    function confirmAndProceed() {
      if (currentProgress < 100) {
        showAlert('×™×© ×œ×”×©×œ×™× ××ª ×›×œ ×”××™××•×ª×™× ×œ×¤× ×™ ×”××¢×‘×¨ ×”×œ××”', 'warning');
        return;
      }

      saveValidationData();
      
      // Set validation as completed
      sessionStorage.setItem('estimateValidationCompleted', 'true');
      
      showAlert('××™××•×ª ×”×•×©×œ× ×‘×”×¦×œ×—×”! ×¢×•×‘×¨ ×œ×‘× ×™×™×ª ××•××“×Ÿ...', 'success');
      
      setTimeout(() => {
        window.location.href = 'estimate-report-builder.html';
      }, 1500);
    }

    function showAlert(message, type = 'success') {
      const alertsContainer = document.getElementById('alerts');
      const alert = document.createElement('div');
      alert.className = `alert ${type} show`;
      alert.textContent = message;
      alertsContainer.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    // Make functions globally available
    window.saveValidationData = saveValidationData;
    window.confirmAndProceed = confirmAndProceed;
  </script>
</body>
</html>