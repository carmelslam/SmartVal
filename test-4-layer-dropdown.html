<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test 4-Layer Dropdown - Session 94</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; direction: rtl; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .test-btn { padding: 10px 20px; margin: 5px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .result { background: #f9f9f9; padding: 10px; margin: 10px 0; border-left: 4px solid #007cba; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        #console { background: #2d3748; color: #e2e8f0; padding: 15px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; border-radius: 4px; }
        .layer-1 { border-left: 4px solid #2196F3; }
        .layer-2 { border-left: 4px solid #4CAF50; }
        .layer-3 { border-left: 4px solid #FF9800; }
        .layer-4 { border-left: 4px solid #9C27B0; }
        .dropdown-item { padding: 8px; margin: 2px 0; background: #f9f9f9; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Test 4-Layer Dropdown - Session 94</h1>
    
    <div class="section">
        <h2>ğŸ“Š Status Check</h2>
        <button class="test-btn" onclick="checkStatus()">Check Data Sources</button>
        <button class="test-btn" onclick="loadData()">Load All Data</button>
        <button class="test-btn" onclick="testDropdown()">Test 4-Layer Dropdown</button>
        <button class="test-btn" onclick="clearConsole()">Clear Console</button>
        <div id="statusResult" class="result" style="display: none;"></div>
    </div>
    
    <div class="section">
        <h2>ğŸ” Dropdown Test Results</h2>
        <div id="dropdownResults"></div>
    </div>
    
    <div class="section">
        <h2>ğŸ“ Console Output</h2>
        <div id="console"></div>
    </div>

    <script>
        // Mock Supabase for testing
        window.supabase = {
            from: (table) => ({
                select: (fields) => ({
                    limit: (n) => ({
                        then: async (callback) => {
                            log(`ğŸ”„ Mock Supabase query: ${table}.select(${fields}).limit(${n})`);
                            
                            if (table === 'catalog_items') {
                                const mockCatalog = [
                                    { cat_num_desc: '×‘×•×œ××™ ×§×“××™×™×', pcode: 'SHOCK-001', supplier_name: '×—×œ×§×™ ×¨×›×‘ ×‘×¢"×', price: 450, make: '×˜×•×™×•×˜×”', model: '×§×•×¨×•×œ×”' },
                                    { cat_num_desc: '××¡× ×Ÿ ××•×•×™×¨', pcode: 'AF-001', supplier_name: '×‘×œ××™× ×¤×¨×•', price: 65, make: '×”×•× ×“×”', model: '×¡×™×•×•×™×§' }
                                ];
                                return callback({ data: mockCatalog, error: null });
                            } else if (table === 'invoice_lines') {
                                const mockLines = [
                                    { id: '1', description: '×¤× ×¡ ××—×•×¨×™ ×™××™×Ÿ', quantity: 1, unit_price: 320, line_total: 320 },
                                    { id: '2', description: '××¨××” ×¦×“ ×©×××œ', quantity: 1, unit_price: 180, line_total: 180 }
                                ];
                                return callback({ data: mockLines, error: null });
                            }
                            
                            return callback({ data: [], error: null });
                        }
                    })
                })
            })
        };
        
        // Mock helper data
        window.helper = {
            case_info: {
                supabase_case_id: 'test-case-123'
            },
            parts_search: {
                selected_parts: [
                    { name: '×“×œ×ª ×§×“××™×ª ×™××™×Ÿ', description: '×“×œ×ª ××§×•×¨×™×ª', price: 1200 },
                    { name: '×¨×¤×™×“×•×ª ×‘×œ××™×', description: '×¨×¤×™×“×•×ª ×§×“××™×•×ª', price: 250 }
                ]
            }
        };
        
        // Mock parts bank
        window.PARTS_BANK = {
            '×× ×•×¢': ['×¨××© ×¦×™×œ×™× ×“×¨', '×‘×•×›× ×”', '×’×œ ××¨×›×•×‘×”'],
            '×‘×œ××™×': ['×“×™×¡×§ ×‘×œ××™×', '×§×œ×™×¤×¨', '× ×•×–×œ ×‘×œ××™×'],
            '×ª××•×¨×”': ['×¤× ×¡ ×¨××©×™', '×¤× ×¡ ××—×•×¨×™', '× ×•×¨×ª ××™×ª×•×ª']
        };
        
        function log(message) {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            console.textContent += `[${timestamp}] ${message}\n`;
            console.scrollTop = console.scrollHeight;
            window.console.log(message);
        }
        
        function clearConsole() {
            document.getElementById('console').textContent = '';
            document.getElementById('dropdownResults').innerHTML = '';
            document.getElementById('statusResult').style.display = 'none';
        }
        
        function checkStatus() {
            log('ğŸ” Checking data sources status...');
            
            const status = {
                supabase: !!window.supabase,
                helper: !!window.helper,
                case_id: window.helper?.case_info?.supabase_case_id,
                invoice_lines: !!window.INVOICE_LINES,
                parts_catalog: !!window.PARTS_CATALOG,
                parts_bank: !!window.PARTS_BANK,
                selected_parts: window.helper?.parts_search?.selected_parts?.length || 0
            };
            
            log(`ğŸ“Š Status: ${JSON.stringify(status, null, 2)}`);
            
            const statusDiv = document.getElementById('statusResult');
            statusDiv.innerHTML = `
                <h3>Status Summary:</h3>
                <ul>
                    <li>Supabase: ${status.supabase ? 'âœ…' : 'âŒ'}</li>
                    <li>Helper: ${status.helper ? 'âœ…' : 'âŒ'}</li>
                    <li>Case ID: ${status.case_id || 'âŒ'}</li>
                    <li>Invoice Lines: ${status.invoice_lines ? 'âœ…' : 'âŒ'} (${window.INVOICE_LINES?.length || 0})</li>
                    <li>Parts Catalog: ${status.parts_catalog ? 'âœ…' : 'âŒ'} (${window.PARTS_CATALOG?.length || 0})</li>
                    <li>Parts Bank: ${status.parts_bank ? 'âœ…' : 'âŒ'}</li>
                    <li>Selected Parts: ${status.selected_parts > 0 ? 'âœ…' : 'âŒ'} (${status.selected_parts})</li>
                </ul>
            `;
            statusDiv.style.display = 'block';
        }
        
        async function loadData() {
            log('ğŸ”„ Loading catalog items and invoice lines...');
            
            try {
                await loadCatalogItems();
                await loadInvoiceLinesForDropdown();
                log('âœ… All data loaded successfully');
                checkStatus();
            } catch (err) {
                log(`âŒ Error loading data: ${err.message}`);
            }
        }
        
        async function loadCatalogItems() {
            try {
                if (window.PARTS_CATALOG && window.PARTS_CATALOG.length > 0) {
                    log('âœ… Catalog items already cached: ' + window.PARTS_CATALOG.length);
                    return window.PARTS_CATALOG;
                }
                
                if (!window.supabase) {
                    log('âš ï¸ Supabase not available for catalog loading');
                    return [];
                }
                
                log('ğŸ”„ Loading catalog items from Supabase...');
                const { data: catalogData, error } = await window.supabase
                    .from('catalog_items')
                    .select('cat_num_desc, pcode, supplier_name, price, make, model')
                    .limit(1000);
                
                if (catalogData && !error) {
                    log(`âœ… Loaded ${catalogData.length} catalog items from Supabase`);
                    window.PARTS_CATALOG = catalogData;
                    return catalogData;
                } else {
                    log('âš ï¸ No catalog data loaded: ' + (error?.message || 'Unknown error'));
                    window.PARTS_CATALOG = [];
                    return [];
                }
            } catch (err) {
                log('âŒ Error loading catalog items: ' + err.message);
                window.PARTS_CATALOG = [];
                return [];
            }
        }
        
        async function loadInvoiceLinesForDropdown() {
            try {
                if (window.INVOICE_LINES && window.INVOICE_LINES.length > 0) {
                    log('âœ… Invoice lines already cached: ' + window.INVOICE_LINES.length);
                    return window.INVOICE_LINES;
                }
                
                if (!window.supabase) {
                    log('âš ï¸ Supabase not available');
                    window.INVOICE_LINES = [];
                    return [];
                }
                
                const caseId = window.helper?.case_info?.supabase_case_id;
                if (!caseId) {
                    log('âš ï¸ No case_id available');
                    window.INVOICE_LINES = [];
                    return [];
                }
                
                log('ğŸ”„ Loading invoice lines for case: ' + caseId);
                
                const { data: allLines, error } = await window.supabase
                    .from('invoice_lines')
                    .select('*');
                
                if (error) {
                    log('âŒ Error loading invoice lines: ' + error.message);
                    window.INVOICE_LINES = [];
                    return [];
                }
                
                log(`âœ… Loaded ${allLines?.length || 0} total invoice lines`);
                window.INVOICE_LINES = allLines || [];
                return allLines || [];
                
            } catch (err) {
                log('âŒ Error in loadInvoiceLinesForDropdown: ' + err.message);
                window.INVOICE_LINES = [];
                return [];
            }
        }
        
        function getCombinedDropdownData(query = '') {
            try {
                log('ğŸ” Building 4-layer dropdown data...');
                const helper = window.helper;
                const allParts = [];
                
                // LAYER 1: ğŸ§¾ Invoice lines
                log('ğŸ“‹ Layer 1: Invoice lines...');
                let invoiceCount = 0;
                if (window.INVOICE_LINES && Array.isArray(window.INVOICE_LINES)) {
                    log(`ğŸ“‹ Using cached invoice lines: ${window.INVOICE_LINES.length} items`);
                    
                    window.INVOICE_LINES.forEach(line => {
                        const description = line.description || '';
                        if (description && (!query || description.toLowerCase().includes(query.toLowerCase()))) {
                            const partData = {
                                name: description,
                                description: `×›××•×ª: ${line.quantity || 1}`,
                                price: line.unit_price || line.line_total || 0,
                                source: `ğŸ§¾ ×—×©×‘×•× ×™×ª`,
                                layer: 1,
                                original: line
                            };
                            allParts.push(partData);
                            invoiceCount++;
                        }
                    });
                } else {
                    log('âš ï¸ No invoice lines data available');
                }
                
                // LAYER 2: ğŸ“‹ Selected parts
                log('ğŸ“‹ Layer 2: Selected parts...');
                let selectedCount = 0;
                if (helper?.parts_search?.selected_parts && Array.isArray(helper.parts_search.selected_parts)) {
                    helper.parts_search.selected_parts.forEach(part => {
                        if (part.name && (!query || part.name.toLowerCase().includes(query.toLowerCase()))) {
                            allParts.push({
                                name: part.name,
                                description: part.description || '',
                                price: part.price || part.cost || 0,
                                source: 'ğŸ“‹ ×—×œ×§×™× × ×‘×—×¨×™×',
                                layer: 2,
                                original: part
                            });
                            selectedCount++;
                        }
                    });
                }
                
                // LAYER 3: ğŸ¦ Catalog items
                log('ğŸ“‹ Layer 3: Catalog items...');
                let catalogCount = 0;
                if (window.PARTS_CATALOG && Array.isArray(window.PARTS_CATALOG)) {
                    window.PARTS_CATALOG.forEach(item => {
                        const description = item.cat_num_desc || '';
                        if (description && (!query || description.toLowerCase().includes(query.toLowerCase()))) {
                            allParts.push({
                                name: description,
                                description: `×§×•×“: ${item.pcode} | ×¡×¤×§: ${item.supplier_name} | ×™×¦×¨×Ÿ: ${item.make}`,
                                price: item.price || 0,
                                source: `ğŸ¦ ×§×˜×œ×•×’ ×’×œ×•×‘×œ×™ (${item.supplier_name})`,
                                layer: 3,
                                original: item
                            });
                            catalogCount++;
                        }
                    });
                }
                
                // LAYER 4: ğŸ“„ Parts bank
                log('ğŸ“‹ Layer 4: Parts bank...');
                let bankCount = 0;
                if (window.PARTS_BANK && typeof window.PARTS_BANK === 'object') {
                    Object.keys(window.PARTS_BANK).forEach(categoryName => {
                        const parts = window.PARTS_BANK[categoryName];
                        if (Array.isArray(parts)) {
                            parts.forEach(partName => {
                                const name = typeof partName === 'string' ? partName : partName.name;
                                if (name && (!query || name.toLowerCase().includes(query.toLowerCase()))) {
                                    allParts.push({
                                        name: name,
                                        description: `××§×˜×’×•×¨×™×”: ${categoryName}`,
                                        price: 0,
                                        source: `ğŸ“„ ×‘× ×§ ×—×œ×§×™× (${categoryName})`,
                                        layer: 4,
                                        original: partName
                                    });
                                    bankCount++;
                                }
                            });
                        }
                    });
                }
                
                log(`âœ… Found ${allParts.length} total parts across 4 layers`);
                log(`Layer breakdown: L1=${invoiceCount}, L2=${selectedCount}, L3=${catalogCount}, L4=${bankCount}`);
                
                return allParts;
            } catch (err) {
                log(`âŒ Error in getCombinedDropdownData: ${err.message}`);
                return [];
            }
        }
        
        function testDropdown() {
            log('ğŸ§ª Testing 4-layer dropdown generation...');
            
            const allParts = getCombinedDropdownData('');
            
            // Display in preview
            const preview = document.getElementById('dropdownResults');
            preview.innerHTML = '<h3>ğŸ” 4-Layer Dropdown Results:</h3>';
            
            if (allParts.length === 0) {
                preview.innerHTML += '<div class="result error">âŒ No parts found in any layer!</div>';
                return;
            }
            
            // Group by layer
            const layers = {1: [], 2: [], 3: [], 4: []};
            allParts.forEach(part => {
                if (layers[part.layer]) {
                    layers[part.layer].push(part);
                }
            });
            
            // Display by layer
            Object.keys(layers).forEach(layerNum => {
                const layerParts = layers[layerNum];
                if (layerParts.length > 0) {
                    const layerDiv = document.createElement('div');
                    layerDiv.className = `result layer-${layerNum}`;
                    layerDiv.innerHTML = `
                        <h4>Layer ${layerNum}: ${layerParts.length} items</h4>
                        ${layerParts.slice(0, 3).map(part => `
                            <div class="dropdown-item">
                                <strong>${part.name}</strong><br>
                                <small>${part.description}</small><br>
                                <small style="color: #666;">${part.source} - â‚ª${part.price}</small>
                            </div>
                        `).join('')}
                        ${layerParts.length > 3 ? `<div><small>... and ${layerParts.length - 3} more items</small></div>` : ''}
                    `;
                    preview.appendChild(layerDiv);
                }
            });
            
            log(`âœ… Dropdown test completed with ${allParts.length} total items`);
        }
        
        // Auto-initialize
        window.onload = function() {
            log('ğŸ§ª 4-Layer Dropdown Test Page Loaded');
            checkStatus();
        };
    </script>
</body>
</html>