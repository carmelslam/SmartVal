<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<link rel="stylesheet" href="styles.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 <style>
  body {
    font-family: sans-serif;
    background: #f8fafc;
    margin: 0;
    padding: 20px;
  }

  .container {
    max-width: 500px;
    margin: 40px auto;
    background: white;
    padding: 40px 30px;
    border-radius: 16px;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.15);
    text-align: center;
    position: relative;
    width: 90%;
  }

  h1 {
    font-size: 22px;
    margin: 10px 0;
  }

  h2 {
    font-size: 16px;
    margin-bottom: 20px;
    color: #555;
  }

  .logo {
    width: 120px;
    margin: 0 auto 20px;
    opacity: 0.8;
    display: block;
  }

  .footer {
    margin-top: 25px;
    font-size: 12px;
    color: #999;
  }

  .header {
    text-align: center;
    margin-bottom: 30px;
  }

  .actions {
    margin-top: 24px;
    display: flex;
    gap: 12px;
  }

  button {
    padding: 10px 18px;
    border-radius: 8px;
    border: none;
    font-size: 16px;
    cursor: pointer;
  }

  .add {
    background: #007bff;
    color: #fff;
  }

  .next {
    background: #28a745;
    color: #fff;
  }

  .finish {
    background: #dc3545;
    color: #fff;
  }

  .row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
  }

  .row input,
  .row select {
    flex: 1;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }

  .suggestions {
    position: absolute;
    background: #fff;
    border: 1px solid #ccc;
    z-index: 1000;
    max-height: 150px;
    overflow-y: auto;
    right: 0;
    left: 0;
    top: 100%;
  }

  .suggestions div {
    padding: 8px;
    cursor: pointer;
  }

  .suggestions div:hover {
    background: #f0f0f0;
  }

  .title, .subtitle {
    text-align: center;
    color: #003366;
    font-weight: bold;
  }

  .subtitle {
    font-size: 14px;
    font-weight: normal;
    color: #555;
    margin-top: 4px;
  }
</style>

  <script src="webhook.js"></script>
  <script src="wizard-controller.js"></script>

</head>
<body>
  <div class="header">
     <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" class="logo" alt="Logo" />
    <h1>×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×¤×•×¨×˜×œ</h1>
   <h2>×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</h2>
<h1> ×¡×¢×™×£ ××•×§×“ × ×–×§</h1>
  </div>

<div class="container">
  <h2 id="step-title"></h2>
  <form id="bulkForm" onsubmit="return false;">
    <div id="bulk-content"></div>
    <div class="actions">
      <button class="add" type="button" id="addBtn">×”×•×¡×£</button>
      <button class="next" type="button" id="nextBtn">×”××©×š</button>
      <button class="finish" type="button" id="finishBtn" style="display:none">×¡×™×™× ××•×§×“ × ×–×§</button>
    </div>
  </form>
</div>
<script>
// Authentication check
const auth = sessionStorage.getItem("auth");
if (!auth) {
  alert("×”×’×™×©×” ×—×¡×•××” - ×× × ×”×ª×—×‘×¨ ×“×¨×š ×“×£ ×”×‘×™×ª");
  window.location.href = "index.html";
}

const steps = [
  { key: "center", title: "×‘×—×™×¨×ª ××•×§×“ × ×–×§", type: "center" },
  { key: "description", title: "×ª×™××•×¨ ×”× ×–×§", placeholder: "×”×–×Ÿ ×ª×™××•×¨...", type: "text" },
  { key: "works", title: "×¢×‘×•×“×•×ª × ×“×¨×©×•×ª", placeholder: "×”×–×Ÿ ×¢×‘×•×“×”...", type: "text" },
  { key: "parts", title: "×—×œ×§×™× × ×“×¨×©×™×", type: "external", url: "parts-module.html?mode=wizard" },
  { key: "repairs", title: "×ª×™×§×•× ×™× × ×“×¨×©×™×", placeholder: "×”×–×Ÿ ×ª×™×§×•×Ÿ...", type: "text" }
];
let currentStep = 0;
let currentCenter = { description: [], works: [], parts: [], repairs: [] };
let damageCenters = [];

function renderStep() {
  document.getElementById('step-title').innerText = steps[currentStep].title;
  let html = `<div id="items-list"></div>`;
  document.getElementById('bulk-content').innerHTML = html;
  renderRows();
  document.getElementById('addBtn').style.display = '';
  document.getElementById('nextBtn').style.display = (currentStep < steps.length - 1) ? '' : 'none';
  document.getElementById('finishBtn').style.display = (currentStep === steps.length - 1) ? '' : 'none';
}

function renderRows() {
  const key = steps[currentStep].key;
  const items = currentCenter[key];
  const list = document.getElementById('items-list');
  list.innerHTML = '';

  if (steps[currentStep].type === "center") {
    // Damage center selection with "other" and free text
    const zoneOptions = [
      "×—×–×™×ª","×§×“××™ ×™××™×Ÿ","×™××™×Ÿ ×§×“××™","×™××™×Ÿ","××—×•×¨×™ ×™××™×Ÿ","×™××™×Ÿ ××—×•×¨×™","××—×•×¨×™","××—×•×¨×™ ×©×××œ",
      "×©×××œ ××—×•×¨×™","×©×××œ","×©×××œ ×§×“××™","×§×“××™ ×©×××œ","×¡×‘×™×‘ ×”×¨×›×‘","×¤× ×™× ×”×¨×›×‘","××™×›×× ×™","××—×¨"
    ];
    let zone = items[0]?.zone || "";
    list.innerHTML = `
      <label>××•×§×“ × ×–×§:
        <select id="zoneSelect">
          <option value="">×‘×—×¨ ××•×§×“</option>
          ${zoneOptions.map(opt => `<option${zone === opt ? " selected" : ""}>${opt}</option>`).join("")}
        </select>
      </label>
      <div id="otherZoneBox" style="display:${zone === "××—×¨" ? "block" : "none"};">
        <label>×”×–×Ÿ ××•×§×“ × ×–×§:
          <input type="text" id="otherZoneInput" value="${zone !== "" && !zoneOptions.includes(zone) ? zone : ""}" />
        </label>
      </div>
    `;
    setTimeout(() => {
      const zoneSelect = document.getElementById("zoneSelect");
      const otherZoneBox = document.getElementById("otherZoneBox");
      const otherZoneInput = document.getElementById("otherZoneInput");
      zoneSelect.onchange = function() {
        if (this.value === "××—×¨") {
          otherZoneBox.style.display = "block";
          currentCenter.center = [{ zone: "" }];
        } else {
          otherZoneBox.style.display = "none";
          currentCenter.center = [{ zone: this.value }];
        }
      };
      if (otherZoneInput) {
        otherZoneInput.oninput = function() {
          currentCenter.center = [{ zone: this.value }];
        };
      }
    }, 0);
    return;
  }

  if (steps[currentStep].type === "external") {
    window.location.href = steps[currentStep].url;
    return;
  }

  const row = document.createElement('div');
  row.className = 'row';
  if (steps[currentStep].type === "part") {
    row.innerHTML = `
      <div style="flex:2;position:relative;">
        <input type="text" value="${val.name||''}" placeholder="×©× ×”×—×œ×§" oninput="suggestPart(this,${idx})"/>
        <div class="suggestions"></div>
      </div>
      <input type="text" value="${val.desc||''}" placeholder="×ª×™××•×¨"/>
      <select>
        <option value="">××§×•×¨</option>
        <option value="×—×œ×™×¤×™/××§×•×¨×™">×—×œ×™×¤×™/××§×•×¨×™</option>
        <option value="×—×œ×™×¤×™/××©×•××©">×—×œ×™×¤×™/××©×•××©</option>
        <option value="×—×“×© ××§×•×¨×™">×—×“×© ××§×•×¨×™</option>
        <option value="×—×œ×™×¤×™">×—×œ×™×¤×™</option>
        <option value="××©×•××©">××©×•××©</option>
        <option value="×¨×™×§">×¨×™×§</option>
      </select>
      <button type="button" onclick="removeRow(${idx})">âœ•</button>
    `;
    setTimeout(() => {
      row.querySelector("select").value = val.source || "";
      row.querySelector("select").onchange = e => { currentCenter.parts[idx].source = e.target.value; };
      row.querySelectorAll("input")[0].oninput = e => { currentCenter.parts[idx].name = e.target.value; };
      row.querySelectorAll("input")[1].oninput = e => { currentCenter.parts[idx].desc = e.target.value; };
    }, 0);
  } else {
    row.innerHTML = `
      <input type="text" value="${val}" placeholder="${steps[currentStep].placeholder}"/>
      <button type="button" onclick="removeRow(${idx})">âœ•</button>
    `;
    setTimeout(() => {
      row.querySelector("input").oninput = e => { currentCenter[key][idx] = e.target.value; };
    }, 0);
  }
  list.appendChild(row);
}

window.removeRow = function(idx) {
  const key = steps[currentStep].key;
  currentCenter[key].splice(idx, 1);
  renderRows();
};

document.getElementById('addBtn').onclick = function() {
  const key = steps[currentStep].key;
  if (steps[currentStep].type === "part") {
    currentCenter.parts.push({ name: "", desc: "", source: "" });
  } else {
    currentCenter[key].push("");
  }
  renderRows();
};

document.getElementById('nextBtn').onclick = function() {
  currentStep++;
  renderStep();
};

document.getElementById('finishBtn').onclick = function() {
  // Validate at least one item per bulk
  for (let s of steps) {
    if (!currentCenter[s.key] || currentCenter[s.key].length === 0) {
      alert("×™×© ×œ××œ× ×œ×¤×—×•×ª ×©×“×” ××—×“ ×‘×›×œ ××§×˜×¢.");
      return;
    }
  }
  damageCenters.push(JSON.parse(JSON.stringify(currentCenter)));
  // Save to helper using proper function
  if (typeof updateHelper === 'function') {
    updateHelper('damage_sections', damageCenters, 'damage_center_flow');
  } else {
    // Import and use updateHelper
    import('./helper.js').then(module => {
      module.updateHelper('damage_sections', damageCenters, 'damage_center_flow');
    }).catch(() => {
      // ğŸ”§ PHASE 2.3: Final fallback - use window.helper (single source)
      if (typeof window.helper === 'object') {
        window.helper.damage_sections = damageCenters;
        // Try to save through sessionStorage as emergency fallback
        try {
          sessionStorage.setItem("helper", JSON.stringify(window.helper));
          console.log('âš ï¸ PHASE 2.3: Emergency fallback - saved damage sections to primary storage');
        } catch(e) {
          console.error('âŒ PHASE 2.3: Emergency fallback failed:', e);
        }
      } else {
        console.error('âŒ PHASE 2.3: No helper system available - data may be lost');
      }
    });
  }
  if (confirm("×œ×”×•×¡×™×£ ××•×§×“ × ×–×§ × ×•×¡×£?")) {
    currentCenter = { description: [], works: [], parts: [], repairs: [] };
    currentStep = 0;
    renderStep();
  } else {
    window.location.href = "expertise-summary.html";
  }
};

// Initial row for each bulk
function ensureInitialRow() {
  const key = steps[currentStep].key;
  if (currentCenter[key].length === 0) {
    if (steps[currentStep].type === "part") {
      currentCenter.parts.push({ name: "", desc: "", source: "" });
    } else {
      currentCenter[key].push("");
    }
  }
}
function stepInit() {
  ensureInitialRow();
  renderStep();
}
window.onload = stepInit;

/// --- Parts Suggestion Integration ---
window.suggestPart = function(input, idx) {
  const query = input.value.trim();
  // ğŸ”§ PHASE 2.3: Get helper data from single source (window.helper)
  const helper = window.helper || {};
  const car = helper.car_details || {};
  const plate = car.plate || '';
  const manufacturer = car.manufacturer || '';
  const model = car.model || '';
  const year = car.year || '';
  if (!plate || !manufacturer || !model || !year) return;
  const row = input.closest(".row");
  const box = row.querySelector(".suggestions");
  box.innerHTML = "";
  if (query.length < 2) return;
  fetch(window.webhooks.partsSuggest, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ plate, manufacturer, model, year, query })
  })
  .then(res => res.json())
  .then(data => {
    if (!Array.isArray(data)) return;
    data.forEach(suggestion => {
      const item = document.createElement("div");
      item.textContent = suggestion.name || suggestion;
      item.onclick = () => {
        input.value = suggestion.name || suggestion;
        currentCenter.parts[idx].name = suggestion.name || suggestion;
        box.innerHTML = "";
      };
      box.appendChild(item);
    });
  });
};

// Already included: renderDamageParts()

// Already included: window.addSelectedPartToHelper
</script>
<script>
  const partTable = document.getElementById("selected-parts-list");
  // ğŸ”§ PHASE 2.3: Get helper data from single source (window.helper)
  const helper = window.helper || {};

  const SOURCE_OPTIONS = [
    "××§×•×¨×™", "×ª×—×œ×™×¤×™", "××©×•××©", "×—×“×© ××§×•×¨×™", "×—×œ×™×¤×™", "×©×•×¤×¥", "×™×‘×•×",
    "×¤×™×¨×•×§", "××•×ª×× ××™×©×™×ª", "×¨×™×§", "×—×œ×™×¤×™/××§×•×¨×™", "×—×œ×™×¤×™/××©×•××©"
  ];

  function updatePart(index, field, value) {
    if (!helper.damage_parts[index]) return;
    // Update specific part using helper function
    if (typeof updateHelper === 'function') {
      const updatedParts = [...helper.damage_parts];
      updatedParts[index][field] = value;
      updateHelper('damage_parts', updatedParts, 'damage_center_flow');
    } else {
      // ğŸ”§ PHASE 2.3: Fallback - use window.helper and primary storage only
      if (typeof window.helper === 'object' && window.helper.damage_parts) {
        window.helper.damage_parts[index][field] = value;
        // Save to primary storage only (no competing localStorage)
        try {
          sessionStorage.setItem("helper", JSON.stringify(window.helper));
          console.log('âš ï¸ PHASE 2.3: Damage part updated via emergency fallback');
        } catch(e) {
          console.error('âŒ PHASE 2.3: Failed to save damage part update:', e);
        }
      }
    }
  }

  function renderDamageParts() {
    if (!helper.damage_parts || !Array.isArray(helper.damage_parts)) {
      partTable.innerHTML = "<p>×œ× × ×‘×—×¨×• ×—×œ×§×™× ×¢×“×™×™×Ÿ. ×—×–×•×¨ ×œ××•×“×•×œ ×—×™×¤×•×© ×”×—×œ×§×™× ×›×“×™ ×œ×‘×—×•×¨ ×—×œ×§×™× ×œ×“×•×—.</p>";
      return;
    }

    const table = document.createElement("table");
    table.classList.add("styled-table");
    table.innerHTML = `
      <thead>
        <tr>
          <th>×§×‘×•×¦×”</th>
          <th>×©× ×—×œ×§</th>
          <th>××—×™×¨</th>
          <th>××§×•×¨</th>
        </tr>
      </thead>
      <tbody>
        ${helper.damage_parts.map((part, index) => `
          <tr>
            <td>${part.group || ""}</td>
            <td>${part.name || ""}</td>
            <td><input type="text" value="${part.price || ""}" style="width: 80px;" onchange="updatePart(${index}, 'price', this.value)"></td>
            <td>
              <select onchange="updatePart(${index}, 'source', this.value)">
                ${SOURCE_OPTIONS.map(source => `
                  <option value="${source}" ${part.source === source ? "selected" : ""}>${source}</option>
                `).join("")}
              </select>
            </td>
          </tr>
        `).join("")}
      </tbody>
    `;
    partTable.appendChild(table);
  }

  renderDamageParts();
</script>

</div> <!-- end of .page -->

</body>
</html>
