<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ—ï¸ Test Helper Structure Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-section h3 {
            color: #333;
            margin-top: 0;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .status-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .good { color: #28a745; }
        .bad { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ï¸ ×‘×“×™×§×ª ×ª×™×§×•×Ÿ ××‘× ×” Helper</h1>
        
        <div class="test-section">
            <h3>ğŸ“Š ××¦×‘ × ×•×›×—×™</h3>
            <div id="current-status" class="status-display">Loading...</div>
            <button class="btn btn-info" onclick="checkCurrentStructure()">×‘×“×•×§ ××‘× ×” × ×•×›×—×™</button>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ ×¤×¢×•×œ×•×ª ×ª×™×§×•×Ÿ</h3>
            <div class="btn-row">
                <button class="btn btn-primary" onclick="fixHelperStructure()">×ª×§×Ÿ ××‘× ×” Helper</button>
                <button class="btn btn-success" onclick="enhanceEstimateSections()">×©×“×¨×’ ×—×œ×§×™ ××•××“×Ÿ ×•×“×•×´×—</button>
                <button class="btn btn-warning" onclick="cleanupDuplicates()">× ×§×” ×›×¤×™×œ×•×™×•×ª</button>
                <button class="btn btn-danger" onclick="resetHelper()">××™×¤×•×¡ ××œ×</button>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“‹ ×‘×“×™×§×ª ×¡×•×’×™ ×“×•×´×—×•×ª</h3>
            <div class="btn-row">
                <button class="btn btn-info" onclick="testEstimateTypes()">×‘×“×•×§ ×¡×•×’×™ ××•××“×Ÿ (2)</button>
                <button class="btn btn-info" onclick="testFinalReportTypes()">×‘×“×•×§ ×¡×•×’×™ ×“×•×´×— ×¡×•×¤×™ (5)</button>
            </div>
            
            <h4>×”×’×“×¨×ª ×¡×•×’ ×“×•×´×— ×¤×¢×™×œ:</h4>
            <select id="estimate-type-select">
                <option value="">×‘×—×¨ ×¡×•×’ ××•××“×Ÿ</option>
                <option value="pre_work">××•××“×Ÿ ××§×“×™× (××•×‘×“×Ÿ ×—×œ×§×™)</option>
                <option value="post_work">××•××“×Ÿ ×œ××—×¨ ×¢×‘×•×“×” (××•×‘×“×Ÿ ×œ×”×œ×›×”)</option>
            </select>
            <button class="btn btn-primary" onclick="setEstimateType()">×”×’×“×¨ ×¡×•×’ ××•××“×Ÿ</button>
            
            <br><br>
            
            <select id="final-report-type-select">
                <option value="">×‘×—×¨ ×¡×•×’ ×“×•×´×— ×¡×•×¤×™</option>
                <option value="private_opinion">×—×•×•×ª ×“×¢×ª ×¤×¨×˜×™×ª</option>
                <option value="global_opinion">×—×•×•×ª ×“×¢×ª ×’×œ×•×‘×œ×™×ª</option>
                <option value="damaged_sale_opinion">×—×•×•×ª ×“×¢×ª ××›×™×¨×” ××¦×‘×• ×”× ×™×–×•×§</option>
                <option value="total_loss_opinion">×—×•×•×ª ×“×¢×ª ×˜×•×˜×œ×•×¡×˜</option>
                <option value="legal_total_loss">×—×•×•×ª ×“×¢×ª ××•×‘×“×Ÿ ×œ×”×œ×›×”</option>
            </select>
            <button class="btn btn-primary" onclick="setFinalReportType()">×”×’×“×¨ ×¡×•×’ ×“×•×´×— ×¡×•×¤×™</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ ×ª×•×¦××•×ª ×‘×“×™×§×”</h3>
            <div id="test-results" class="status-display">×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ ×‘×“×™×§×” ×›×“×™ ×œ×¨××•×ª ×ª×•×¦××•×ª...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ” ××‘× ×” Helper ×”××œ×</h3>
            <button class="btn btn-info" onclick="showFullHelper()">×”×¦×’ Helper ××œ×</button>
            <button class="btn btn-warning" onclick="showHelperSummary()">×”×¦×’ ×¡×™×›×•× ××‘× ×”</button>
            <div id="helper-display" class="status-display">×œ×—×¥ ×›×“×™ ×œ×”×¦×™×’...</div>
        </div>
    </div>

    <!-- Load helper.js -->
    <script src="helper.js"></script>

    <script>
        function checkCurrentStructure() {
            const results = [];
            results.push('ğŸ” ×‘×“×™×§×ª ××‘× ×” Helper × ×•×›×—×™:\n');
            
            if (!window.helper) {
                results.push('âŒ Helper ×œ× ×××•×ª×—×œ');
                document.getElementById('current-status').textContent = results.join('\n');
                return;
            }
            
            // Check for misplaced sections
            let issues = 0;
            
            if (window.helper.car_details?.estimate) {
                results.push('ğŸ”´ estimate × ××¦× ×ª×—×ª car_details (×¦×¨×™×š ×œ×”×™×•×ª ×‘×¨××” ×¢×œ×™×•× ×”)');
                issues++;
            }
            
            if (window.helper.expertise?.final_report) {
                results.push('ğŸ”´ final_report × ××¦× ×ª×—×ª expertise (×¦×¨×™×š ×œ×”×™×•×ª ×‘×¨××” ×¢×œ×™×•× ×”)');
                issues++;
            }
            
            // Check for correct top-level sections
            const requiredSections = ['estimate', 'final_report', 'expertise'];
            requiredSections.forEach(section => {
                if (window.helper[section]) {
                    results.push(`âœ… ${section} × ××¦× ×‘×¨××” ×¢×œ×™×•× ×” - × ×›×•×Ÿ`);
                } else {
                    results.push(`ğŸ”´ ${section} ×—×¡×¨ ××”×¨××” ×”×¢×œ×™×•× ×”`);
                    issues++;
                }
            });
            
            // Check enhanced structures
            if (window.helper.estimate?.estimate_types) {
                results.push('âœ… estimate.estimate_types ×§×™×™× (2 ×¡×•×’×™ ××•××“×Ÿ)');
            } else {
                results.push('ğŸŸ¡ estimate.estimate_types ×—×¡×¨ (×¦×¨×™×š ×©×“×¨×•×’)');
            }
            
            if (window.helper.final_report?.report_types) {
                results.push('âœ… final_report.report_types ×§×™×™× (5 ×¡×•×’×™ ×“×•×´×—)');
            } else {
                results.push('ğŸŸ¡ final_report.report_types ×—×¡×¨ (×¦×¨×™×š ×©×“×¨×•×’)');
            }
            
            if (window.helper.system?.active_report_types) {
                results.push('âœ… system.active_report_types ×§×™×™× (×× ×’× ×•×Ÿ ×‘×—×™×¨×ª ×¡×•×’)');
            } else {
                results.push('ğŸŸ¡ system.active_report_types ×—×¡×¨ (×¦×¨×™×š ×©×“×¨×•×’)');
            }
            
            results.push(`\nğŸ“Š ×¡×™×›×•×: ${issues > 0 ? 'ğŸ”´' : 'âœ…'} ${issues} ×‘×¢×™×•×ª × ××¦××•`);
            
            document.getElementById('current-status').textContent = results.join('\n');
        }
        
        function fixHelperStructure() {
            if (window.fixHelperStructure) {
                const fixed = window.fixHelperStructure();
                document.getElementById('test-results').textContent = 
                    `âœ… ×ª×™×§×•×Ÿ ××‘× ×” ×”×•×©×œ×: ${fixed} ×ª×™×§×•× ×™× ×‘×•×¦×¢×•\n\n×¨×¢× ×Ÿ ××ª ×”×‘×“×™×§×” ×œ×¨××•×ª ××ª ×”×ª×•×¦××•×ª.`;
            } else {
                document.getElementById('test-results').textContent = 'âŒ ×¤×•× ×§×¦×™×™×ª fixHelperStructure ×œ× ×–××™× ×”';
            }
        }
        
        function enhanceEstimateSections() {
            if (window.enhanceEstimateSections) {
                const enhanced = window.enhanceEstimateSections();
                document.getElementById('test-results').textContent = 
                    `âœ… ×©×“×¨×•×’ ×—×œ×§×™ ××•××“×Ÿ ×•×“×•×´×— ×”×•×©×œ×: ${enhanced} ×©×“×¨×•×’×™× ×‘×•×¦×¢×•\n\n×¨×¢× ×Ÿ ××ª ×”×‘×“×™×§×” ×œ×¨××•×ª ××ª ×”×ª×•×¦××•×ª.`;
            } else {
                document.getElementById('test-results').textContent = 'âŒ ×¤×•× ×§×¦×™×™×ª enhanceEstimateSections ×œ× ×–××™× ×”';
            }
        }
        
        function cleanupDuplicates() {
            let results = [];
            let totalCleaned = 0;
            
            if (window.cleanupDuplicateOwnerData) {
                const ownerCleaned = window.cleanupDuplicateOwnerData();
                results.push(`ğŸ§¹ × ×•×§×• ${ownerCleaned} ×›×¤×™×œ×•×™×•×ª ×‘× ×ª×•× ×™ ×‘×¢×œ×™×`);
                totalCleaned += ownerCleaned;
            }
            
            if (window.cleanupDuplicateVehicleData) {
                const vehicleCleaned = window.cleanupDuplicateVehicleData();
                results.push(`ğŸ§¹ × ×•×§×• ${vehicleCleaned} ×›×¤×™×œ×•×™×•×ª ×‘× ×ª×•× ×™ ×¨×›×‘`);
                totalCleaned += vehicleCleaned;
            }
            
            results.push(`\nâœ… ×¡×š ×”×›×œ × ×•×§×• ${totalCleaned} ×›×¤×™×œ×•×™×•×ª`);
            document.getElementById('test-results').textContent = results.join('\n');
        }
        
        function resetHelper() {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××¤×¡ ××ª ×›×œ × ×ª×•× ×™ Helper?')) {
                localStorage.removeItem('helper_data');
                sessionStorage.removeItem('helper');
                location.reload();
            }
        }
        
        function testEstimateTypes() {
            const results = [];
            results.push('ğŸ“‹ ×‘×“×™×§×ª ×¡×•×’×™ ××•××“×Ÿ (2 ×¡×•×’×™×):\n');
            
            if (window.helper?.estimate?.estimate_types) {
                const types = window.helper.estimate.estimate_types;
                
                if (types.pre_work) {
                    results.push(`âœ… ×¡×•×’ 1: ${types.pre_work.type} (${types.pre_work.status})`);
                } else {
                    results.push('âŒ ×¡×•×’ 1: ××•××“×Ÿ ××§×“×™× - ×—×¡×¨');
                }
                
                if (types.post_work) {
                    results.push(`âœ… ×¡×•×’ 2: ${types.post_work.type} (${types.post_work.status})`);
                } else {
                    results.push('âŒ ×¡×•×’ 2: ××•××“×Ÿ ×œ××—×¨ ×¢×‘×•×“×” - ×—×¡×¨');
                }
            } else {
                results.push('âŒ estimate_types ×œ× ×§×™×™× - ×™×© ×œ×‘×¦×¢ ×©×“×¨×•×’');
            }
            
            document.getElementById('test-results').textContent = results.join('\n');
        }
        
        function testFinalReportTypes() {
            const results = [];
            results.push('ğŸ“‹ ×‘×“×™×§×ª ×¡×•×’×™ ×“×•×´×— ×¡×•×¤×™ (5 ×¡×•×’×™×):\n');
            
            if (window.helper?.final_report?.report_types) {
                const types = window.helper.final_report.report_types;
                const expectedTypes = [
                    ['private_opinion', '×—×•×•×ª ×“×¢×ª ×¤×¨×˜×™×ª'],
                    ['global_opinion', '×—×•×•×ª ×“×¢×ª ×’×œ×•×‘×œ×™×ª'],
                    ['damaged_sale_opinion', '×—×•×•×ª ×“×¢×ª ××›×™×¨×” ××¦×‘×• ×”× ×™×–×•×§'],
                    ['total_loss_opinion', '×—×•×•×ª ×“×¢×ª ×˜×•×˜×œ×•×¡×˜'],
                    ['legal_total_loss', '×—×•×•×ª ×“×¢×ª ××•×‘×“×Ÿ ×œ×”×œ×›×”']
                ];
                
                expectedTypes.forEach(([key, title], index) => {
                    if (types[key]) {
                        results.push(`âœ… ×¡×•×’ ${index + 1}: ${types[key].type} (${types[key].status})`);
                    } else {
                        results.push(`âŒ ×¡×•×’ ${index + 1}: ${title} - ×—×¡×¨`);
                    }
                });
            } else {
                results.push('âŒ report_types ×œ× ×§×™×™× - ×™×© ×œ×‘×¦×¢ ×©×“×¨×•×’');
            }
            
            document.getElementById('test-results').textContent = results.join('\n');
        }
        
        function setEstimateType() {
            const selectedType = document.getElementById('estimate-type-select').value;
            if (!selectedType) {
                alert('×™×© ×œ×‘×—×•×¨ ×¡×•×’ ××•××“×Ÿ');
                return;
            }
            
            if (window.setActiveReportType) {
                const success = window.setActiveReportType('estimate', selectedType);
                if (success) {
                    document.getElementById('test-results').textContent = 
                        `âœ… ×¡×•×’ ××•××“×Ÿ ×¤×¢×™×œ ×”×•×’×“×¨ ×œ: ${selectedType}\n\n×›×¢×ª ×›×œ × ×ª×•× ×™ ×”××•××“×Ÿ ×™×™×©××¨×• ×‘:\nhelper.estimate.estimate_types.${selectedType}`;
                } else {
                    document.getElementById('test-results').textContent = 'âŒ ×©×’×™××” ×‘×”×’×“×¨×ª ×¡×•×’ ××•××“×Ÿ';
                }
            } else {
                document.getElementById('test-results').textContent = 'âŒ ×¤×•× ×§×¦×™×™×ª setActiveReportType ×œ× ×–××™× ×”';
            }
        }
        
        function setFinalReportType() {
            const selectedType = document.getElementById('final-report-type-select').value;
            if (!selectedType) {
                alert('×™×© ×œ×‘×—×•×¨ ×¡×•×’ ×“×•×´×— ×¡×•×¤×™');
                return;
            }
            
            if (window.setActiveReportType) {
                const success = window.setActiveReportType('final_report', selectedType);
                if (success) {
                    document.getElementById('test-results').textContent = 
                        `âœ… ×¡×•×’ ×“×•×´×— ×¡×•×¤×™ ×¤×¢×™×œ ×”×•×’×“×¨ ×œ: ${selectedType}\n\n×›×¢×ª ×›×œ × ×ª×•× ×™ ×”×“×•×´×— ×”×¡×•×¤×™ ×™×™×©××¨×• ×‘:\nhelper.final_report.report_types.${selectedType}`;
                } else {
                    document.getElementById('test-results').textContent = 'âŒ ×©×’×™××” ×‘×”×’×“×¨×ª ×¡×•×’ ×“×•×´×— ×¡×•×¤×™';
                }
            } else {
                document.getElementById('test-results').textContent = 'âŒ ×¤×•× ×§×¦×™×™×ª setActiveReportType ×œ× ×–××™× ×”';
            }
        }
        
        function showFullHelper() {
            if (window.helper) {
                document.getElementById('helper-display').textContent = JSON.stringify(window.helper, null, 2);
            } else {
                document.getElementById('helper-display').textContent = 'âŒ Helper ×œ× ×××•×ª×—×œ';
            }
        }
        
        function showHelperSummary() {
            if (!window.helper) {
                document.getElementById('helper-display').textContent = 'âŒ Helper ×œ× ×××•×ª×—×œ';
                return;
            }
            
            const summary = [];
            summary.push('ğŸ“Š ×¡×™×›×•× ××‘× ×” Helper:\n');
            
            // Top-level sections
            const sections = Object.keys(window.helper);
            summary.push(`ğŸ”· ×—×œ×§×™× ×‘×¨××” ×¢×œ×™×•× ×” (${sections.length}):`);
            sections.forEach(section => {
                const sectionData = window.helper[section];
                const type = Array.isArray(sectionData) ? 'array' : typeof sectionData;
                const size = Array.isArray(sectionData) ? sectionData.length : 
                           (type === 'object' ? Object.keys(sectionData).length : 1);
                summary.push(`  â€¢ ${section}: ${type} (${size} items)`);
            });
            
            // Active report types
            if (window.helper.system?.active_report_types) {
                summary.push('\nğŸ“‹ ×¡×•×’×™ ×“×•×´×—×•×ª ×¤×¢×™×œ×™×:');
                const activeTypes = window.helper.system.active_report_types;
                summary.push(`  â€¢ ××•××“×Ÿ: ${activeTypes.estimate || '×œ× ×”×•×’×“×¨'}`);
                summary.push(`  â€¢ ×“×•×´×— ×¡×•×¤×™: ${activeTypes.final_report || '×œ× ×”×•×’×“×¨'}`);
            }
            
            // Enhanced structures
            if (window.helper.estimate?.estimate_types) {
                summary.push('\nğŸ“ˆ ×¡×•×’×™ ××•××“×Ÿ ×–××™× ×™×:');
                Object.keys(window.helper.estimate.estimate_types).forEach(type => {
                    summary.push(`  â€¢ ${type}: ${window.helper.estimate.estimate_types[type].type}`);
                });
            }
            
            if (window.helper.final_report?.report_types) {
                summary.push('\nğŸ“‹ ×¡×•×’×™ ×“×•×´×— ×¡×•×¤×™ ×–××™× ×™×:');
                Object.keys(window.helper.final_report.report_types).forEach(type => {
                    summary.push(`  â€¢ ${type}: ${window.helper.final_report.report_types[type].type}`);
                });
            }
            
            document.getElementById('helper-display').textContent = summary.join('\n');
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                checkCurrentStructure();
            }, 1000);
        });
    </script>
</body>
</html>