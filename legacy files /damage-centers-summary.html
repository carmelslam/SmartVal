<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>סיכום מוקדי נזק - ירון כיוף שמאות</title>
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      direction: rtl;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .logo {
      width: 100px;
      height: auto;
      margin-bottom: 15px;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    
    .header p {
      font-size: 16px;
      opacity: 0.9;
    }
    
    .summary-content {
      padding: 40px;
    }
    
    .damage-center-card {
      border: 1px solid #e5e7eb;
      border-radius: 15px;
      margin-bottom: 30px;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .damage-center-card:hover {
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    
    .damage-center-header {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      padding: 25px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .damage-center-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .center-name {
      font-size: 24px;
      font-weight: bold;
      color: #1e3a8a;
    }
    
    .center-number {
      background: #3b82f6;
      color: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 18px;
    }
    
    .center-location {
      color: #64748b;
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    .center-description {
      color: #374151;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .damage-center-body {
      padding: 25px;
    }
    
    .items-section {
      margin-bottom: 25px;
    }
    
    .items-section-title {
      font-size: 18px;
      font-weight: bold;
      color: #1e3a8a;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .items-section-icon {
      font-size: 20px;
    }
    
    .items-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
    }
    
    .item-card {
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 15px;
    }
    
    .item-name {
      font-weight: bold;
      color: #374151;
      margin-bottom: 5px;
    }
    
    .item-details {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 10px;
    }
    
    .item-price {
      font-size: 16px;
      font-weight: bold;
      color: #059669;
    }
    
    .empty-section {
      text-align: center;
      color: #9ca3af;
      font-style: italic;
    }
    
    .center-totals {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border: 1px solid #10b981;
      border-radius: 10px;
      padding: 20px;
      margin-top: 25px;
    }
    
    .totals-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .total-item {
      text-align: center;
    }
    
    .total-label {
      font-size: 14px;
      color: #065f46;
      margin-bottom: 5px;
    }
    
    .total-amount {
      font-size: 20px;
      font-weight: bold;
      color: #047857;
    }
    
    .center-final-total {
      text-align: center;
      padding-top: 20px;
      border-top: 2px solid #10b981;
    }
    
    .center-final-label {
      font-size: 16px;
      color: #065f46;
      margin-bottom: 5px;
    }
    
    .center-final-amount {
      font-size: 28px;
      font-weight: bold;
      color: #047857;
    }
    
    .grand-total-section {
      background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);
      border: 2px solid #f59e0b;
      border-radius: 15px;
      padding: 30px;
      margin-top: 40px;
      text-align: center;
    }
    
    .grand-total-title {
      font-size: 24px;
      font-weight: bold;
      color: #92400e;
      margin-bottom: 20px;
    }
    
    .grand-total-breakdown {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .grand-total-item {
      background: white;
      border-radius: 10px;
      padding: 20px;
      border: 1px solid #f59e0b;
    }
    
    .grand-total-item-label {
      font-size: 14px;
      color: #92400e;
      margin-bottom: 10px;
    }
    
    .grand-total-item-amount {
      font-size: 22px;
      font-weight: bold;
      color: #b45309;
    }
    
    .grand-total-final {
      background: white;
      border: 2px solid #f59e0b;
      border-radius: 15px;
      padding: 25px;
    }
    
    .grand-total-final-label {
      font-size: 18px;
      color: #92400e;
      margin-bottom: 10px;
    }
    
    .grand-total-final-amount {
      font-size: 36px;
      font-weight: bold;
      color: #b45309;
    }
    
    .actions-section {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 40px;
      padding-top: 30px;
      border-top: 1px solid #e5e7eb;
    }
    
    .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: #3b82f6;
      color: white;
    }
    
    .btn-primary:hover {
      background: #2563eb;
    }
    
    .btn-success {
      background: #10b981;
      color: white;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    .btn-secondary {
      background: #6b7280;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #4b5563;
    }
    
    .loading {
      text-align: center;
      padding: 60px;
      color: #6b7280;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .empty-state {
      text-align: center;
      padding: 60px;
      color: #6b7280;
    }
    
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }
    
    .empty-state-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .empty-state-desc {
      font-size: 16px;
      margin-bottom: 30px;
    }
    
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        border-radius: 10px;
      }
      
      .summary-content {
        padding: 20px;
      }
      
      .damage-center-header, .damage-center-body {
        padding: 20px;
      }
      
      .items-grid {
        grid-template-columns: 1fr;
      }
      
      .actions-section {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/04/logo-yaron.webp" alt="ירון כיוף שמאות" class="logo">
      <h1>סיכום מוקדי נזק</h1>
      <p>סקירה מלאה של כל מוקדי הנזק והעלויות</p>
    </div>
    
    <div class="summary-content">
      <div id="loadingState" class="loading">
        <div class="loading-spinner"></div>
        <div>טוען נתוני מוקדי נזק...</div>
      </div>
      
      <div id="emptyState" class="empty-state" style="display:none;">
        <div class="empty-state-icon">📋</div>
        <div class="empty-state-title">אין מוקדי נזק</div>
        <div class="empty-state-desc">לא נמצאו מוקדי נזק במערכת</div>
        <button class="btn btn-primary" onclick="createNewDamageCenter()">צור מוקד נזק חדש</button>
      </div>
      
      <div id="summaryContent" style="display:none;">
        <div id="damageCentersContainer"></div>
        
        <div class="grand-total-section" id="grandTotalSection">
          <div class="grand-total-title">סיכום כל מוקדי הנזק</div>
          
          <div class="grand-total-breakdown">
            <div class="grand-total-item">
              <div class="grand-total-item-label">סה"כ עבודות</div>
              <div class="grand-total-item-amount" id="totalWorks">₪0</div>
            </div>
            <div class="grand-total-item">
              <div class="grand-total-item-label">סה"כ חלפים</div>
              <div class="grand-total-item-amount" id="totalParts">₪0</div>
            </div>
            <div class="grand-total-item">
              <div class="grand-total-item-label">סה"כ תיקונים</div>
              <div class="grand-total-item-amount" id="totalRepairs">₪0</div>
            </div>
            <div class="grand-total-item">
              <div class="grand-total-item-label">מע"מ</div>
              <div class="grand-total-item-amount" id="totalVat">₪0</div>
            </div>
          </div>
          
          <div class="grand-total-final">
            <div class="grand-total-final-label">סה"כ כל מוקדי הנזק</div>
            <div class="grand-total-final-amount" id="grandTotal">₪0</div>
          </div>
        </div>
        
        <div class="actions-section">
          <button class="btn btn-primary" onclick="createNewDamageCenter()">הוסף מוקד נזק</button>
          <button class="btn btn-success" onclick="proceedToNextStep()">המשך לשלב הבא</button>
          <button class="btn btn-secondary" onclick="exportSummary()">יצא סיכום</button>
        </div>
      </div>
    </div>
  </div>
  
  <script src="helper.js" type="module"></script>
  <script>
    let damageCenters = [];
    let grandTotals = {};
    
    // Initialize summary on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadDamageCentersSummary();
    });
    
    function loadDamageCentersSummary() {
      console.log('📊 Loading damage centers summary...');
      
      // Load from comprehensive damage_centers structure using new helper API
      if (typeof window.buildComprehensiveDamageAssessment === 'function') {
        const assessment = window.buildComprehensiveDamageAssessment();
        if (assessment && assessment.centers) {
          damageCenters = assessment.centers;
          grandTotals = assessment.grand_totals;
          console.log('✅ Loaded comprehensive damage assessment:', assessment);
        } else {
          console.log('⚠️ No comprehensive assessment available');
          damageCenters = [];
        }
      } else {
        // Fallback to direct helper access
        let helper = {};
        try {
          helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        } catch (e) {
          console.warn('Failed to parse helper from sessionStorage');
        }
        
        // Check the new canonical structure first
        if (helper.damage_centers && Array.isArray(helper.damage_centers)) {
          damageCenters = helper.damage_centers;
        } else if (helper.damage_centers && helper.damage_centers.centers && Array.isArray(helper.damage_centers.centers)) {
          damageCenters = helper.damage_centers.centers;
        } else if (helper.damage_assessment && helper.damage_assessment.centers && Array.isArray(helper.damage_assessment.centers)) {
          damageCenters = helper.damage_assessment.centers;
        } else {
          damageCenters = [];
        }
      }
      
      console.log(`📊 Loaded ${damageCenters.length} damage centers:`, damageCenters);
      
      // Hide loading
      document.getElementById('loadingState').style.display = 'none';
      
      if (damageCenters.length === 0) {
        document.getElementById('emptyState').style.display = 'block';
      } else {
        displayDamageCentersSummary();
        document.getElementById('summaryContent').style.display = 'block';
      }
    }
    
    function displayDamageCentersSummary() {
      const container = document.getElementById('damageCentersContainer');
      container.innerHTML = '';
      
      let totalWorks = 0;
      let totalParts = 0;
      let totalRepairs = 0;
      let totalVat = 0;
      let grandTotal = 0;
      
      damageCenters.forEach(center => {
        const centerDiv = createDamageCenterCard(center);
        container.appendChild(centerDiv);
        
        // FIXED: Calculate subtotals if missing, then accumulate
        if (!center.subtotals && (center.work_items || center.parts_items || center.repairs_items)) {
          // Calculate subtotals from raw data if missing
          const worksTotal = (center.work_items || []).reduce((sum, item) => sum + (parseFloat(item.cost) || 0), 0);
          const partsTotal = (center.parts_items || []).reduce((sum, item) => sum + (parseFloat(item.cost) || 0), 0);
          const repairsTotal = (center.repairs_items || []).reduce((sum, item) => sum + (parseFloat(item.cost) || 0), 0);
          const subtotal = worksTotal + partsTotal + repairsTotal;
          const vatAmount = subtotal * 0.18; // Default 18% VAT
          
          center.subtotals = {
            works: worksTotal,
            parts: partsTotal,
            repairs: repairsTotal,
            subtotal: subtotal,
            vat_amount: vatAmount,
            total_with_vat: subtotal + vatAmount
          };
          console.log(`📊 Calculated missing subtotals for center ${center.number}: ₪${subtotal + vatAmount}`);
        }
        
        // Accumulate totals
        if (center.subtotals) {
          totalWorks += center.subtotals.works || 0;
          totalParts += center.subtotals.parts || 0;
          totalRepairs += center.subtotals.repairs || 0;
          totalVat += center.subtotals.vat_amount || 0;
          grandTotal += center.subtotals.total_with_vat || 0;
        }
      });
      
      // Update grand totals display
      updateGrandTotalsDisplay(totalWorks, totalParts, totalRepairs, totalVat, grandTotal);
    }
    
    function createDamageCenterCard(center) {
      const cardDiv = document.createElement('div');
      cardDiv.className = 'damage-center-card';
      cardDiv.innerHTML = `
        <div class="damage-center-header">
          <div class="damage-center-title">
            <div class="center-name">מוקד נזק ${center.number}</div>
            <div class="center-number">${center.number}</div>
          </div>
          <div class="center-location">📍 ${center.location || 'לא צוין מיקום'}</div>
          <div class="center-description">${center.description || 'אין תיאור'}</div>
        </div>
        
        <div class="damage-center-body">
          ${createSimpleItemsSection('עבודות נדרשות', center.works?.items || center.work_items || [], '🔧')}
          ${createSimpleItemsSection('חלפים נדרשים', center.parts?.items || center.parts_items || center.parts_required || [], '🔩')}
          ${createSimpleItemsSection('תיקונים נדרשים', center.repairs?.items || center.repairs_items || [], '🔨')}
          
          <div class="center-totals">
            <div class="totals-grid">
              <div class="total-item">
                <div class="total-label">עבודות</div>
                <div class="total-amount">₪${formatNumber(center.totals?.works_subtotal || center.works?.subtotal || center.subtotals?.works || 0)}</div>
              </div>
              <div class="total-item">
                <div class="total-label">חלפים</div>
                <div class="total-amount">₪${formatNumber(center.totals?.parts_subtotal || center.parts?.subtotal || center.subtotals?.parts || 0)}</div>
              </div>
              <div class="total-item">
                <div class="total-label">תיקונים</div>
                <div class="total-amount">₪${formatNumber(center.totals?.repairs_subtotal || center.repairs?.subtotal || center.subtotals?.repairs || 0)}</div>
              </div>
              <div class="total-item">
                <div class="total-label">מע"מ (17%)</div>
                <div class="total-amount">₪${formatNumber(center.totals?.vat_amount || center.subtotals?.vat_amount || 0)}</div>
              </div>
            </div>
            
            <div class="center-final-total">
              <div class="center-final-label">סה"כ מוקד נזק</div>
              <div class="center-final-amount">₪${formatNumber(center.totals?.center_total_with_vat || center.subtotals?.total_with_vat || 0)}</div>
            </div>
          </div>
        </div>
      `;
      
      return cardDiv;
    }
    
    function createSimpleItemsSection(title, items, icon) {
      // Handle array of items
      if (Array.isArray(items)) {
        if (items.length === 0) {
          return `
            <div class="items-section">
              <div class="items-section-title">
                <span class="items-section-icon">${icon}</span>
                ${title}
              </div>
              <div class="empty-section">לא הוגדרו ${title.toLowerCase()}</div>
            </div>
          `;
        }
        
        const itemsHtml = items.map(item => `
          <div class="item-card">
            <div class="item-name">${item.name || item.category || item.description || 'ללא שם'}</div>
            <div class="item-details">
              ${item.description ? `תיאור: ${item.description}<br>` : ''}
              ${item.comments ? `הערות: ${item.comments}<br>` : ''}
              ${item.supplier ? `ספק: ${item.supplier}<br>` : ''}
            </div>
            <div class="item-price">₪${formatNumber(item.cost || item.price || 0)}</div>
          </div>
        `).join('');
        
        return `
          <div class="items-section">
            <div class="items-section-title">
              <span class="items-section-icon">${icon}</span>
              ${title} (${items.length})
            </div>
            <div class="items-list">${itemsHtml}</div>
          </div>
        `;
      }
      
      // Handle object structure (e.g., {"work1": {cost: 100}, "work2": {cost: 200}})
      const itemKeys = Object.keys(items || {});
      if (itemKeys.length === 0) {
        return `
          <div class="items-section">
            <div class="items-section-title">
              <span class="items-section-icon">${icon}</span>
              ${title}
            </div>
            <div class="empty-section">לא הוגדרו ${title.toLowerCase()}</div>
          </div>
        `;
      }
      
      const itemsHtml = itemKeys.map(key => {
        const item = items[key];
        return `
          <div class="item-card">
            <div class="item-name">${key}</div>
            <div class="item-details">
              ${item.description ? `תיאור: ${item.description}<br>` : ''}
              ${item.comments ? `הערות: ${item.comments}<br>` : ''}
              ${item.supplier ? `ספק: ${item.supplier}<br>` : ''}
            </div>
            <div class="item-price">₪${formatNumber(item.cost || item.price || 0)}</div>
          </div>
        `;
      }).join('');
      
      return `
        <div class="items-section">
          <div class="items-section-title">
            <span class="items-section-icon">${icon}</span>
            ${title} (${itemKeys.length})
          </div>
          <div class="items-list">${itemsHtml}</div>
        </div>
      `;
    }
    
    function createItemsSection(title, items, icon) {
      if (items.length === 0) {
        return `
          <div class="items-section">
            <div class="items-section-title">
              <span class="items-section-icon">${icon}</span>
              ${title}
            </div>
            <div class="empty-section">לא הוגדרו ${title.toLowerCase()}</div>
          </div>
        `;
      }
      
      const itemsHtml = items.map(item => `
        <div class="item-card">
          <div class="item-name">${item.name || item.description || 'ללא שם'}</div>
          <div class="item-details">
            ${item.description ? `תיאור: ${item.description}<br>` : ''}
            ${item.quantity ? `כמות: ${item.quantity}<br>` : ''}
            ${item.supplier ? `ספק: ${item.supplier}<br>` : ''}
            ${item.condition ? `מצב: ${item.condition}<br>` : ''}
          </div>
          <div class="item-price">₪${formatNumber(item.cost || item.price || 0)}</div>
        </div>
      `).join('');
      
      return `
        <div class="items-section">
          <div class="items-section-title">
            <span class="items-section-icon">${icon}</span>
            ${title} (${items.length})
          </div>
          <div class="items-grid">
            ${itemsHtml}
          </div>
        </div>
      `;
    }
    
    function updateGrandTotalsDisplay(works, parts, repairs, vat, total) {
      document.getElementById('totalWorks').textContent = `₪${formatNumber(works)}`;
      document.getElementById('totalParts').textContent = `₪${formatNumber(parts)}`;
      document.getElementById('totalRepairs').textContent = `₪${formatNumber(repairs)}`;
      document.getElementById('totalVat').textContent = `₪${formatNumber(vat)}`;
      document.getElementById('grandTotal').textContent = `₪${formatNumber(total)}`;
      
      // Store totals for use in other functions
      grandTotals = {
        works,
        parts,
        repairs,
        vat,
        total
      };
    }
    
    function formatNumber(num) {
      return new Intl.NumberFormat('en-US').format(Math.round(num));
    }
    
    window.createNewDamageCenter = function() {
      // Navigate back to damage center wizard
      window.location.href = 'damage-centers-wizard.html';
    };
    
    window.proceedToNextStep = function() {
      // Save the totals to helper and proceed to next part of workflow
      if (typeof window.calculateAllDamageCentersTotals === 'function') {
        window.calculateAllDamageCentersTotals();
      }
      
      // Update helper with final totals
      if (window.helper && window.helper.damage_centers) {
        window.helper.damage_centers.totals = {
          all_centers_subtotal: grandTotals.total - grandTotals.vat,
          all_centers_vat: grandTotals.vat,
          all_centers_total: grandTotals.total,
          last_calculated: new Date().toISOString()
        };
        
        // Also update financials costs for compatibility with other parts of the system
        if (window.helper.financials) {
          window.helper.financials.costs = {
            works_total: grandTotals.works,
            parts_total: grandTotals.parts,
            repairs_total: grandTotals.repairs,
            subtotal: grandTotals.total - grandTotals.vat
          };
        }
      }
      
      alert(`✅ סיכום מוקדי הנזק הושלם!\n\nסה"כ ${damageCenters.length} מוקדי נזק\nסה"כ עלות: ₪${formatNumber(grandTotals.total)}\n\nהמערכת תמשך לשלב הבא.`);
      
      // Navigate to next part of the workflow (expertise builder or next step)
      // This could be customized based on the specific workflow
      console.log('🚀 Proceeding to next step with totals:', grandTotals);
      
      // You can redirect to the next page in the workflow here
      // window.location.href = 'next-step.html';
    };
    
    window.exportSummary = function() {
      // Create a detailed summary for export
      const summaryData = {
        export_date: new Date().toISOString(),
        damage_centers_count: damageCenters.length,
        damage_centers: damageCenters,
        totals: grandTotals
      };
      
      // Convert to JSON and download
      const dataStr = JSON.stringify(summaryData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = `damage-centers-summary-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      console.log('📊 Summary exported:', summaryData);
    };
    
    // Auto-refresh data every 30 seconds if user stays on page
    setInterval(() => {
      if (document.visibilityState === 'visible') {
        loadDamageCentersSummary();
      }
    }, 30000);
  </script>
</body>
</html>