<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ירון כיוף שמאות — בחירת תהליכי עבודה</title>
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link rel="shortcut icon" href="https://carmelcayouf.com/wp-content/uploads/2025/04/logo-yaron.webp">
  <link rel="apple-touch-icon" href="https://carmelcayouf.com/wp-content/uploads/2025/04/logo-yaron.webp">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
  
  <style>
    :root{
      --bg: #0f172a; 
      --card: #1e293b; 
      --card-hover: #334155;
      --muted: #475569; 
      --ink: #f1f5f9; 
      --ink-dim: #94a3b8;
      --brand: #22c55e; 
      --brand-hover: #16a34a;
      --accent: #3b82f6; 
      --accent-hover: #2563eb;
      --warn: #f59e0b; 
      --danger: #ef4444; 
      --ok: #10b981;
      --shadow: 0 10px 30px rgba(0,0,0,.35); 
      --shadow-lg: 0 20px 40px rgba(0,0,0,.4);
      --radius: 16px;
      --radius-lg: 20px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 80% -10%, #1e293b 0%, #0b1220 60%), var(--bg);
      color: var(--ink);
      font-family: 'Heebo', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, system-ui, sans-serif;
      font-weight: 400;
      line-height: 1.6;
      min-height: 100vh;
    }

    /* Header */
    header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: linear-gradient(180deg, rgba(11,18,32,0.95), rgba(11,18,32,0.8));
      backdrop-filter: blur(16px);
      border-bottom: 1px solid #334155;
      box-shadow: var(--shadow);
      width: 100%; /* changed from max-width: 720px; */
      /* removed max-width */
      left: 0;
      right: 0;
    }

    .shell {
      max-width: 1200px;
      margin: auto;
      padding: 16px;
    }

    header .shell {
      max-width: none; /* allow header to stretch full width */
      width: 100%;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1000px;
      width: 100%;
      padding: 40px 20px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .row {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand img {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      object-fit: cover;
    }

    .brand h1 {
      font-size: 20px;
      margin: 0;
      font-weight: 800;
      letter-spacing: 0.2px;
      background: linear-gradient(135deg, var(--brand), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

  
    h2 {
      font-size: 18px;
      color: #64748b;
      margin-bottom: 30px;
    }

    /* Status Ribbon */
    .ribbon {
      margin-top: 12px;
      background: linear-gradient(90deg, var(--card), #1a2332);
      border: 1px solid #334155;
      border-radius: 14px;
      padding: 10px 14px;
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }

    .badge {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid #334155;
      color: var(--ink);
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--warn);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Main Content */
    main {
      padding: 24px 0;
    }

    /* Quick Actions */
    .quick {
      display: grid;
      grid-template-columns: 1fr 1fr auto auto auto;
      gap: 12px;
      align-items: center;
    }

    @media (max-width: 768px) {
      .quick {
        grid-template-columns: 1fr;
        gap: 8px;
      }
    }

    .input, .select {
      appearance: none;
      width: 100%;
      padding: 14px 16px;
      border-radius: 12px;
      border: 2px solid #334155;
      background: var(--card);
      color: var(--ink);
      font-family: inherit;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .input:focus, .select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .btn {
      border: 0;
      border-radius: 12px;
      padding: 14px 20px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      font-size: 14px;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--brand);
      color: #0a0f0a;
    }

    .btn-primary:hover {
      background: var(--brand-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .btn-ghost {
      background: var(--card);
      color: var(--ink);
      border: 1px solid #334155;
    }

    .btn-ghost:hover {
      background: var(--card-hover);
      border-color: var(--accent);
    }

    .btn[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Grid Layout */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
      gap: 20px;
      margin-top: 24px;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
    }

    /* Cards */
    .card {
      background: linear-gradient(180deg, var(--card), #1a2332);
      border: 1px solid #334155;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 24px;
      transition: all 0.3s ease;
      position: relative;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: #475569;
    }

    .card h2 {
      margin: 0 0 8px;
      font-size: 20px;
      font-weight: 800;
      color: var(--ink);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .sub {
      color: var(--ink-dim);
      font-size: 14px;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    /* Collapsible Cards */
    .collapsible .card-header {
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: -24px -24px 20px -24px;
      padding: 20px 24px;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(34, 197, 94, 0.1));
      border-radius: var(--radius) var(--radius) 0 0;
      border-bottom: 1px solid #334155;
    }

    .collapsible .card-header:hover {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(34, 197, 94, 0.15));
    }

    .collapse-icon {
      transition: transform 0.3s ease;
      font-size: 18px;
      color: var(--accent);
    }

    .collapsible.collapsed .collapse-icon {
      transform: rotate(-180deg);
    }

    .collapsible.collapsed .card-content {
      display: none;
    }

    /* Steps */
    .steps {
      display: grid;
      gap: 12px;
      margin: 16px 0;
    }

    .step {
      display: grid;
      grid-template-columns: 40px 1fr auto;
      gap: 12px;
      align-items: center;
      padding: 16px;
      border-radius: 12px;
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid #334155;
      transition: all 0.2s ease;
    }

    .step:hover {
      background: rgba(30, 41, 59, 0.8);
      border-color: var(--accent);
    }

    .step .ico {
      width: 32px;
      height: 32px;
      display: grid;
      place-items: center;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), var(--brand));
      font-size: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .step .name {
      font-weight: 600;
      color: var(--ink);
    }

    .step .hint {
      font-size: 12px;
      color: var(--ink-dim);
      margin-top: 4px;
    }

    .chip {
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid;
      font-weight: 600;
    }

    .chip.ok { 
      color: var(--ok); 
      border-color: var(--ok); 
      background: rgba(16, 185, 129, 0.1);
    }
    
    .chip.warn { 
      color: var(--warn); 
      border-color: var(--warn); 
      background: rgba(245, 158, 11, 0.1);
    }
    
    .chip.danger { 
      color: var(--danger); 
      border-color: var(--danger); 
      background: rgba(239, 68, 68, 0.1);
    }

    .chip:not(.ok):not(.warn):not(.danger) {
      color: var(--ink-dim);
      border-color: #475569;
      background: rgba(71, 85, 105, 0.1);
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    @media (max-width: 480px) {
      .toolbar {
        flex-direction: column;
      }
    }

    /* Tools Grid - IMPROVED VISIBILITY */
    .tools-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }

    .tool {
      background: linear-gradient(135deg, var(--card), #2a3441);
      border: 2px solid #475569;
      border-radius: 12px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      text-decoration: none;
      color: inherit;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .tool::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--brand), var(--accent));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .tool:hover {
      background: linear-gradient(135deg, var(--card-hover), #334155);
      border-color: var(--accent);
      transform: translateY(-3px);
      box-shadow: var(--shadow);
    }

    .tool:hover::before {
      opacity: 1;
    }

    .tool h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      color: var(--ink);
    }

    .tool .desc {
      font-size: 13px;
      color: var(--ink-dim);
      line-height: 1.4;
    }

    /* Pills and Shortcuts */
    .pills {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 16px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 16px 24px;
      border-radius: 999px;
      border: 2px solid #334155;
      background: var(--card);
      color: var(--ink);
      font-weight: 700;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.3s ease;
      min-width: 180px;
    }

    .pill-lg {
      padding: 20px 32px;
      font-size: 16px;
      min-width: 200px;
    }

    .pill:hover {
      background: var(--card-hover);
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    /* Modal */
    dialog {
      border: 1px solid #334155;
      border-radius: var(--radius-lg);
      background: var(--card);
      color: var(--ink);
      padding: 0;
      max-width: 1000px;
      width: 96vw;
      box-shadow: var(--shadow-lg);
    }

    dialog::backdrop {
      background: rgba(2,6,23,.8);
      backdrop-filter: blur(4px);
    }

    .modal-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #334155;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(34, 197, 94, 0.1));
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }

    .modal-body {
      padding: 24px;
    }

    /* Footer */
    footer {
      opacity: 0.8;
      padding: 32px 0;
      border-top: 1px solid #334155;
      margin-top: 40px;
      font-size: 13px;
      text-align: center;
      background: linear-gradient(180deg, transparent, rgba(15, 23, 42, 0.5));
    }

    .footer-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .footer-logo {
      width: 24px;
      height: 24px;
      border-radius: 6px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .shell {
        padding: 12px;
      }
      
      .brand h1 {
        font-size: 18px;
      }
      
      .card {
        padding: 20px;
      }
      
      .collapsible .card-header {
        margin: -20px -20px 16px -20px;
        padding: 16px 20px;
      }
      
      .tools-grid {
        grid-template-columns: 1fr;
      }
      
      .pills {
        flex-direction: column;
        align-items: center;
      }
      
      .pill, .pill-lg {
        width: 100%;
        max-width: 300px;
      }
    }

    @media (max-width: 480px) {
      .ribbon {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      
      .badge {
        justify-content: center;
      }
    }

    /* Accessibility */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
      
      .dot {
        animation: none;
      }
    }

    /* High contrast mode */
    @media (prefers-contrast: high) {
      :root {
        --bg: #000;
        --card: #111;
        --ink: #fff;
        --brand: #0f0;
        --accent: #00f;
      }
    }

    /* Hidden utility */
    .vh {
      position: absolute !important;
      left: -9999px !important;
      top: auto !important;
      width: 1px !important;
      height: 1px !important;
      overflow: hidden !important;
    }

    /* Header Banner */
    .header-banner {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 32px 0;
    }

    .header-banner > div {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .header-buttons {
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 24px;
    }

    .header-btn {
      padding: 14px 20px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      font-size: 14px;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: 1px solid #334155;
      background: var(--card);
      color: var(--ink);
    }

    .header-btn:hover {
      background: var(--card-hover);
      border-color: var(--accent);
    }

    .header-btn:active {
      transform: translateY(1px);
    }

    .header-btn[style*="background: #2ecc71"] {
      background: #2ecc71;
      color: #fff;
    }

    .header-btn[style*="background: #2ecc71"]:hover {
      background: #27ae60;
    }
  </style>
</head>
<body>
  <header>
    <div class="shell">
      <div class="header-banner">
        <div>
          <!-- Logo and business name, subtitle -->
          <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo" style="height: 64px; margin-bottom: 16px;">
          <div style="font-size: 2rem; font-weight: bold; color: #2ecc71;">ירון כיוף שמאות - פורטל</div>
          <div style="font-size: 1.2rem; color: #aaa;">שמאות והערכת נזקי רכב ורכוש</div>
        </div>
        <!-- Buttons under the banner -->
        <div class="header-buttons">
          <button class="header-btn" id="btnVehicle">📋 פרטי הרכב</button>
          <button class="header-btn" id="btnReports">📄 מסמכים אחרונים</button>
          <button class="header-btn" id="btnLogout" style="background: #2ecc71; color: #fff;">🚪 התנתק</button>
        </div>
      </div>
      <div class="ribbon" id="ribbon">
        <span class="badge"><span class="dot" id="dot-status"></span> סטטוס תיק: <strong id="caseStatus">התחלה</strong></span>
        <span class="badge">🚗 לוחית: <strong id="casePlate">—</strong></span>
        <span class="badge">👤 בעלים: <strong id="caseOwner">—</strong></span>
        <span class="badge">📅 תאריך בדיקה: <strong id="caseDate">—</strong></span>
      </div>
    </div>
  </header>

  <main class="shell">
    <!-- Quick Case Loader -->
    <section class="card" aria-labelledby="quick-nav-title">
      <h2 id="quick-nav-title">🎯טעינת תיק קיים</h2>
      <p class="sub">הזן מס. רכב לטעינת תיק קיים מהמערכת</p>
      <div class="quick">
        <input id="plate" class="input" placeholder="מספר רכב (7-8 ספרות)" inputmode="numeric" required/>
        <input id="owner" class="input" placeholder="שם/ת בעל/ת הרכב" required/>
        <input id="date" class="input" type="date" required/>
        <select id="location" class="select" required>
          <option value="">בחר מקום בדיקה</option>
          <option>חיפה</option>
          <option>תל אביב</option>
          <option>ירושלים</option>
          <option>נתניה</option>
          <option>באר שבע</option>
          <option>אחר</option>
        </select>
        <button id="btnStart" class="btn btn-primary">🚀 טען/צור תיק</button>
      </div>
    </section>

    <!-- Admin & Assistant Shortcuts -->
    <section class="card shortcuts">
      <h2>⚡ קיצורי דרך מהירים</h2>
      <div class="pills">
        <a class="pill pill-lg" id="pill-admin" href="admin.html">⚙️ מרכז ניהול (Admin)</a>
        <button class="pill pill-lg" id="pill-nicole">🤖 שאל את ניקול — מנהלת הידע</button>
      </div>
    </section>

    <!-- Existing Reports -->
    <section class="card reports">
      <h2>📊 תצוגת דו"חות קיימים</h2>
      <p class="sub">לחץ על כל כפתור לפתיחת PDF במצב צף</p>
      <div class="pills">
        <button class="pill" data-report="estimate">📋 אומדן</button>
        <button class="pill" data-report="expertise">🔍 אקספרטיזה</button>
        <button class="pill" data-report="final">📑 חוות דעת סופית</button>
      </div>
    </section>

    <!-- Main Workflow Sections - COLLAPSIBLE -->
    <section class="grid" aria-label="זרימות עבודה ראשיות">
      
      <!-- Expertise Flow -->
      <article class="card collapsible" id="wf-expertise">
        <div class="card-header" data-target="expertise">
          <h2>🔍 פתיחת אקספרטיזה</h2>
          <span class="collapse-icon">▼</span>
        </div>
        <div class="card-content">
          <p class="sub">הבסיס לכל התהליך. יוצר נתוני רכב ומאפיינים, מטמיע נתוני רכב ופותח מוקדי נזק.</p>
          <div class="steps">
            <div class="step">
              <span class="ico">🔑</span>
              <div>
                <div class="name">אימות + פתיחת תיק</div>
                <div class="hint">זיהוי רכב ויצירת מבנה תיק</div>
              </div>
              <span class="chip ok" id="st-open">מוכן</span>
            </div>
            <div class="step">
              <span class="ico">📝</span>
              <div>
                <div class="name">פרטים כלליים</div>
                <div class="hint">מידע בסיסי על הרכב והנזק</div>
              </div>
              <button class="btn btn-ghost go" data-href="general_info.html">פתח</button>
            </div>
            <div class="step">
              <span class="ico">📄</span>
              <div>
                <div class="name">דו"ח לוי יצחק</div>
                <div class="hint">שווי שוק ונתוני ירידת ערך</div>
              </div>
              <button class="btn btn-ghost go" data-href="upload-levi.html">פתח</button>
            </div>
            <div class="step">
              <span class="ico">🧭</span>
              <div>
                <div class="name">אשף מוקדי נזק</div>
                <div class="hint">תיעוד מפורט של כל נזק</div>
              </div>
              <button class="btn btn-ghost go" data-href="damage-centers-wizard.html">פתח</button>
            </div>
            <div class="step">
              <span class="ico">✅</span>
              <div>
                <div class="name">אימות אקספרטיזה</div>
                <div class="hint">בדיקות מערכת + אישור משתמש</div>
              </div>
              <span class="chip" id="st-exp-validate">נעול</span>
            </div>
            <div class="step">
              <span class="ico">📤</span>
              <div>
                <div class="name">סקירה + שליחה</div>
                <div class="hint">בנייה סופית וחתימה דיגיטלית</div>
              </div>
              <span class="chip" id="st-exp-submit">נעול</span>
            </div>
          </div>
          <div class="toolbar">
            <button class="btn btn-primary" id="cta-expertise">🚀 התחל אקספרטיזה</button>
            <button class="btn btn-ghost" id="cta-exp-continue">↩️ המשך אקספרטיזה</button>
          </div>
        </div>
      </article>

      <!-- Estimate Flow -->
      <article class="card collapsible" id="wf-estimate">
        <div class="card-header" data-target="estimate">
          <h2>📋 בניית אומדן (אופציונלי)</h2>
          <span class="collapse-icon">▼</span>
        </div>
        <div class="card-content">
          <p class="sub">אומדן לפני חשבונית. ננעל אוטומטית כאשר מתקבלת חשבונית ממוסך.</p>
          <div class="steps">
            <div class="step">
              <span class="ico">👁️‍🗨️</span>
              <div>
                <div class="name">סקירת דראפט</div>
                <div class="hint">וודא שהאקספרטיזה הושלמה</div>
              </div>
              <span class="chip" id="st-draft">דורש דראפט</span>
            </div>
            <div class="step">
              <span class="ico">📐</span>
              <div>
                <div class="name">בונה אומדן</div>
                <div class="hint">חישובי עלויות ושעות עבודה</div>
              </div>
              <button class="btn btn-ghost go" data-href="estimate-builder.html" disabled>פתח</button>
            </div>
            <div class="step">
              <span class="ico">✅</span>
              <div>
                <div class="name">אימות אומדן</div>
                <div class="hint">בדיקות מתמטיות ומשפטיות</div>
              </div>
              <span class="chip" id="st-est-validate">נעול</span>
            </div>
            <div class="step">
              <span class="ico">📤</span>
              <div>
                <div class="name">סקירה + שליחה</div>
                <div class="hint">יצוא PDF והעברה ללקוח</div>
              </div>
              <span class="chip" id="st-est-submit">נעול</span>
            </div>
          </div>
          <div class="toolbar">
            <button class="btn btn-primary" id="cta-estimate" disabled>📋 פתח אומדן</button>
            <button class="btn btn-ghost" id="cta-est-continue" disabled>↩️ המשך אומדן</button>
          </div>
        </div>
      </article>

      <!-- Final Report Flow -->
      <article class="card collapsible" id="wf-final">
        <div class="card-header" data-target="final">
          <h2>📑 חוות דעת סופית</h2>
          <span class="collapse-icon">▼</span>
        </div>
        <div class="card-content">
          <p class="sub">יעד המערכת הסופי. חיבור כל הנתונים, ירידת ערך, שכ"ט ומסגרות משפטיות.</p>
          <div class="steps">
            <div class="step">
              <span class="ico">👁️</span>
              <div>
                <div class="name">סקירת דראפט אחרון</div>
                <div class="hint">אימות נתוני בסיס</div>
              </div>
              <span class="chip" id="st-final-draft">דורש דראפט</span>
            </div>
            <div class="step">
              <span class="ico">📉</span>
              <div>
                <div class="name">בונה חוות דעת סופית</div>
                <div class="hint">חישובי ירידת ערך ומסקנות</div>
              </div>
              <button class="btn btn-ghost go" data-href="final-report-builder.html" disabled>פתח</button>
            </div>
            <div class="step">
              <span class="ico">💼</span>
              <div>
                <div class="name">מודול שכ"ט/אגרות</div>
                <div class="hint">חישוב עלויות נלוות</div>
              </div>
              <button class="btn btn-ghost go" data-href="fee-module.html" disabled>פתח</button>
            </div>
            <div class="step">
              <span class="ico">🛡️</span>
              <div>
                <div class="name">אימות סופי</div>
                <div class="hint">בדיקות אחרונות וטקסט משפטי</div>
              </div>
              <span class="chip" id="st-final-validate">נעול</span>
            </div>
            <div class="step">
              <span class="ico">🧾</span>
              <div>
                <div class="name">סגירה והפקת PDF</div>
                <div class="hint">יצוא מסמך סופי מחותם</div>
              </div>
              <button class="btn btn-ghost go" data-href="final-report-template-builder.html" disabled>פתח</button>
            </div>
          </div>
          <div class="toolbar">
            <button class="btn btn-primary" id="cta-final" disabled>📑 פתח חוו"ד</button>
            <button class="btn btn-ghost" id="cta-final-continue" disabled>↩️ המשך חוו"ד</button>
          </div>
        </div>
      </article>

      <!-- Tools Section - IMPROVED COLORS -->
      <article class="card collapsible" id="tools">
        <div class="card-header" data-target="tools">
          <h2>🛠️ כלים וכלים נוספים</h2>
          <span class="collapse-icon">▼</span>
        </div>
        <div class="card-content">
          <p class="sub">כלים עזר לתיעוד, חיפוש ועיבוד נתונים במהלך התהליך</p>
          <div class="tools-grid">
            <a class="tool" href="parts-search.html">
              <h3>🔍 מודול חיפוש חלקים</h3>
              <span class="desc">קטלוגים מתקדמים וחיפוש AI מונחה</span>
            </a>
            <a class="tool" href="upload-images.html">
              <h3>📸 מודול תמונות</h3>
              <span class="desc">צילום, גלריה וסימון אוטומטי</span>
            </a>
            <a class="tool" href="invoice-upload.html">
              <h3>🧾 העלאת חשבונית</h3>
              <span class="desc">OCR אוטומטי והחלפת אומדן</span>
            </a>
            <a class="tool" href="upload-levi.html">
              <h3>📊 העלאת דו"ח לוי יצחק</h3>
              <span class="desc">שאיבה אוטומטית ועדכון נתונים</span>
            </a>
            <a class="tool" href="damage-center-works.html">
              <h3>🔧 עבודות נדרשות</h3>
              <span class="desc">ניהול עבודות תיקון ושעות</span>
            </a>
            <a class="tool" href="damage-center-repairs.html">
              <h3>🛠️ תיקונים נדרשים</h3>
              <span class="desc">רשימת תיקונים ועלויות</span>
            </a>
            <a class="tool" href="parts-required.html">
              <h3>⚙️ חלקים נדרשים</h3>
              <span class="desc">מעקב חלקים והזמנות</span>
            </a>
            <a class="tool" href="external-sites.html">
              <h3>🌐 דפדפן אתרים חיצוניים</h3>
              <span class="desc">גישה מהירה לאתרי עזר</span>
            </a>
          </div>
        </div>
      </article>
    </section>

    <!-- Modals -->
    <dialog id="mdlVehicle" aria-labelledby="vehTitle">
      <div class="modal-head">
        <strong id="vehTitle">פרטי הרכב</strong>
        <button class="btn btn-ghost" data-close>✕ סגור</button>
      </div>
      <div class="modal-body">
        <div id="vehBody">—</div>
      </div>
    </dialog>

    <dialog id="pdfModal" aria-label="PDF viewer" style="height:85vh">
      <div class="modal-head">
        <strong>תצוגת PDF</strong>
        <button class="btn btn-ghost" data-close>✕ סגור</button>
      </div>
      <div class="modal-body" style="height:calc(85vh - 56px)">
        <iframe id="pdfFrame" src="" style="width:100%;height:100%;border:0" title="PDF"></iframe>
      </div>
    </dialog>

    <dialog id="mdlReports" aria-labelledby="repTitle">
      <div class="modal-head">
        <strong id="repTitle">מסמכים אחרונים</strong>
        <button class="btn btn-ghost" data-close>✕ סגור</button>
      </div>
      <div class="modal-body">
        <ul id="repList" style="list-style:none;padding:0;margin:0;display:grid;gap:8px"></ul>
      </div>
    </dialog>

    <!-- Dev Panel -->
    <div id="devPanel" class="card" style="display:none;margin-top:16px">
      <h2>🔧 Dev: סימולציה</h2>
      <div class="row" style="gap:18px;flex-wrap:wrap">
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="dep-expertise"> expertise קיים
        </label>
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="dep-draft"> draft קיים
        </label>
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="dep-estimate"> estimate קיים
        </label>
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="dep-levi"> דו״ח לוי
        </label>
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="dep-invoice"> חשבונית קיימת
        </label>
      </div>
    </div>
  </main>

  <!-- Footer with proper branding -->
  <footer>
    <div class="shell">
      <div class="footer-content">
        <img src="https://carmelcayouf.com/wp-content/uploads/2025/04/logo-yaron.webp" alt="לוגו ירון כיוף" class="footer-logo" onerror="this.style.display='none'"/>
        <span>All rights reserved © Carmel Cayouf</span>
    
        <span id="currentYear"></span>
      </div>
    </div>
  </footer>

  <!-- Nicole Assistant Panel -->
  <dialog id="nicole-panel" class="sidepanel" aria-label="Nicole assistant">
    <div class="panel-header">
      <h3>🤖 Nicole — מנהלת הידע</h3>
      <button id="close-nicole" class="btn btn-ghost" aria-label="סגור">✕</button>
    </div>
    <div class="panel-body">
      <ul class="nicole-feed" style="list-style:none;margin:0;padding:0;display:grid;gap:12px">
        <li style="padding:12px;background:rgba(34,197,94,0.1);border:1px solid var(--ok);border-radius:8px;color:var(--ink)">
          ✅ פעולה הבאה: השלם דו"ח לוי עבור התיק הנוכחי
        </li>
        <li style="padding:12px;background:rgba(245,158,11,0.1);border:1px solid var(--warn);border-radius:8px;color:var(--ink)">
          ⚠️ חסרה חשבונית. האומדן נשאר זמני
        </li>
      </ul>
      <div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap">
        <a class="btn btn-ghost" href="upload-levi.html">📄 פתח לוי</a>
        <a class="btn btn-ghost" href="invoice-upload.html">🧾 העלה חשבונית</a>
      </div>
    </div>
  </dialog>

  <!-- Enhanced JavaScript -->
  <script type="module">
  if (!window.__YK_SELECTION_INIT__) {
    window.__YK_SELECTION_INIT__ = true;

    // Set current year in footer
    document.getElementById('currentYear').textContent = new Date().getFullYear();

    // Utilities
    const qs = (s, el=document)=>el.querySelector(s);
    const qsa = (s, el=document)=>[...el.querySelectorAll(s)];
    const state = {
      case:{ plate:"", owner:"", date:"", location:"", status:"התחלה" },
      deps:{expertise:false, draft:false, estimate:false, invoice:false, levi:false},
      reports:[]
    };

    function persist(){ 
      if(!state.case.plate) return; 
      localStorage.setItem("yk_case_"+state.case.plate, JSON.stringify(state)); 
    }
    
    function load(plate){ 
      const raw = localStorage.getItem("yk_case_"+plate); 
      if(!raw) return false; 
      const saved = JSON.parse(raw); 
      Object.assign(state.case, saved.case||{}); 
      Object.assign(state.deps, saved.deps||{}); 
      state.reports = saved.reports||[]; 
      return true; 
    }

    // Collapsible functionality
    function initCollapsibles() {
      qsa('.collapsible .card-header').forEach(header => {
        header.addEventListener('click', () => {
          const card = header.closest('.collapsible');
          const isCollapsed = card.classList.toggle('collapsed');
          
          // Save collapsed state
          const target = header.dataset.target;
          localStorage.setItem(`collapsed_${target}`, isCollapsed);
        });
        
        // Restore collapsed state
        const target = header.dataset.target;
        const isCollapsed = localStorage.getItem(`collapsed_${target}`) === 'true';
        if (isCollapsed) {
          header.closest('.collapsible').classList.add('collapsed');
        }
      });
    }

    // Ribbon status
    function fillRibbon(){
      qs('#casePlate').textContent = state.case.plate || '—';
      qs('#caseOwner').textContent = state.case.owner || '—';
      qs('#caseDate').textContent = state.case.date || '—';
      qs('#caseStatus').textContent = state.case.status;
      
      // Dynamic dot color with animation
      const dot = qs('#dot-status');
      if (state.deps.invoice) {
        dot.style.background = 'var(--ok)';
      } else if (state.deps.estimate || state.deps.draft) {
        dot.style.background = 'var(--warn)';
      } else {
        dot.style.background = '#64748b';
      }
    }

    // Dependencies logic
    function applyDeps(){
      const expReady = state.deps.expertise && state.deps.levi;
      
      // Update step statuses
      if (qs('#st-exp-validate')) qs('#st-exp-validate').textContent = expReady ? 'מוכן' : 'נעול';
      if (qs('#st-exp-submit')) qs('#st-exp-submit').textContent = expReady ? 'מוכן' : 'נעול';
      
      // Update step chips
      if (qs('#st-exp-validate')) {
        qs('#st-exp-validate').className = expReady ? 'chip ok' : 'chip';
      }

      // Damage center button
      const dmgBtn = document.querySelector('#wf-expertise .go[data-href*="damage"]');
      if(dmgBtn) dmgBtn.disabled = !state.deps.levi;

      // Draft status
      if (qs('#st-draft')) {
        qs('#st-draft').textContent = state.deps.draft ? 'מוכן' : 'דורש דראפט';
        qs('#st-draft').className = state.deps.draft ? 'chip ok' : 'chip warn';
      }
      
      // Estimate buttons
      qsa('#wf-estimate .go').forEach(b=>b.disabled = !state.deps.draft);
      if (qs('#cta-estimate')) qs('#cta-estimate').disabled = !state.deps.draft;
      if (qs('#cta-est-continue')) qs('#cta-est-continue').disabled = !state.deps.draft;

      // Invoice override message
      if(state.deps.invoice && qs('#wf-estimate .sub')){ 
        qs('#wf-estimate .sub').innerHTML = '✅ התקבלה חשבונית — ערכי אומדן יוחלפו (מידע היסטורי בלבד).'; 
      }

      // Final report
      const finalOk = state.deps.draft;
      if (qs('#st-final-draft')) {
        qs('#st-final-draft').textContent = finalOk ? 'מוכן' : 'דורש דראפט';
        qs('#st-final-draft').className = finalOk ? 'chip ok' : 'chip warn';
      }
      
      qsa('#wf-final .go').forEach((b,i)=>{ if(i===0) return; b.disabled = !finalOk; });
      if (qs('#cta-final')) qs('#cta-final').disabled = !finalOk; 
      if (qs('#cta-final-continue')) qs('#cta-final-continue').disabled = !finalOk;

      if(state.deps.invoice && qs('#wf-final .sub')){ 
        qs('#wf-final .sub').innerHTML = '💡 מומלץ להשלים ירידת ערך ושכ"ט לאחר קליטת חשבונית.'; 
      }

      // Update case status
      if(state.deps.invoice){ state.case.status='✅ מוכן לסגירה'; }
      else if(state.deps.expertise && !state.deps.levi){ state.case.status='📄 דורש דו״ח לוי'; }
      else if(state.deps.estimate || state.deps.draft){ state.case.status='⚙️ בתהליך'; }
      else { state.case.status='🚀 התחלה'; }
      
      fillRibbon();
      persist();
    }

    // Actions
    function startOrLoadCase(){
      const plateInput = qs('#plate');
      const p = plateInput.value.trim();
      
      // Validate Israeli license plate (7-8 digits)
      if(!p || !/^\d{7,8}$/.test(p)){ 
        alert('הכנס מספר רכב תקין (7-8 ספרות)'); 
        plateInput.focus();
        return; 
      }
      
      const exists = load(p);
      state.case.plate = p;
      state.case.owner = qs('#owner').value.trim() || (exists? state.case.owner : '');
      state.case.date  = qs('#date').value || (exists? state.case.date : new Date().toISOString().slice(0,10));
      state.case.location = qs('#location').value || state.case.location;
      
      if(!exists){ 
        state.deps = {expertise:false, draft:false, estimate:false, invoice:false, levi:false}; 
        state.reports = []; 
      }
      
      applyDeps();
      
      const btnStart = qs('#btnStart');
      btnStart.textContent = exists ? '✅ תיק נטען' : '🆕 תיק נוצר';
      btnStart.style.background = exists ? 'var(--ok)' : 'var(--brand)';
      
      setTimeout(()=>{
        btnStart.textContent='🚀 טען/צור תיק';
        btnStart.style.background = 'var(--brand)';
      }, 2000);
    }

    function openModal(el){ el.showModal(); }
    function closeModal(el){ el.close(); }

    function vehicleDetailsHtml(){
      return `
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">
        <div style="padding:12px;background:rgba(59,130,246,0.1);border-radius:8px">
          <strong style="color:var(--accent)">🚗 לוחית:</strong><br> ${state.case.plate||'—'}
        </div>
        <div style="padding:12px;background:rgba(34,197,94,0.1);border-radius:8px">
          <strong style="color:var(--ok)">👤 בעלים:</strong><br> ${state.case.owner||'—'}
        </div>
        <div style="padding:12px;background:rgba(245,158,11,0.1);border-radius:8px">
          <strong style="color:var(--warn)">🏭 יצרן/דגם:</strong><br> פיג'ו 308
        </div>
        <div style="padding:12px;background:rgba(168,85,247,0.1);border-radius:8px">
          <strong style="color:#a855f7">📅 שנה:</strong><br> 2022
        </div>
        <div style="padding:12px;background:rgba(236,72,153,0.1);border-radius:8px">
          <strong style="color:#ec4899">🔢 VIN:</strong><br> VF3•••
        </div>
        <div style="padding:12px;background:rgba(34,197,94,0.1);border-radius:8px">
          <strong style="color:var(--ok)">💰 שווי שוק (לוי):</strong><br> 88,000 ₪
        </div>
      </div>`
    }

    function reportsListHtml(){
      if(!state.reports.length){
        return '<li style="padding:20px;text-align:center;color:var(--ink-dim)">📄 אין מסמכים להצגה כרגע</li>'
      }
      return state.reports.map(r=>
        `<li><a class="btn btn-ghost" href="${r.href}" target="_blank" style="width:100%;justify-content:flex-start">${r.name}</a></li>`
      ).join('');
    }

    function buildPdfUrl(type){
      const plate = state.case.plate || 'xxxxx';
      return `/pdf/${plate}_${type}.pdf`;
    }

    function paramCase(){
      const params = new URLSearchParams();
      if(state.case.plate) params.set('plate', state.case.plate);
      if(state.case.date) params.set('date', state.case.date);
      if(state.case.owner) params.set('owner', state.case.owner);
      if(state.case.location) params.set('location', state.case.location);
      return '?' + params.toString();
    }

    // Event Listeners
    qs('#btnStart').addEventListener('click', startOrLoadCase);
    
    qs('#btnVehicle').addEventListener('click', ()=>{ 
      qs('#vehBody').innerHTML = vehicleDetailsHtml(); 
      openModal(qs('#mdlVehicle')); 
    });
    
    qs('#btnReports').addEventListener('click', ()=>{ 
      qs('#repList').innerHTML = reportsListHtml(); 
      openModal(qs('#mdlReports')); 
    });
    
    qs('#btnLogout').addEventListener('click', ()=>{
      if(confirm('האם אתה בטוח שברצונך להתנתק?')){
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = 'index.html';
      }
    });

    qsa('[data-close]').forEach(b=> b.addEventListener('click', e=> closeModal(e.target.closest('dialog'))));

    // Nicole assistant
    const pillNicole = document.getElementById('pill-nicole');
    if (pillNicole) {
      pillNicole.addEventListener('click', () => {
        openModal(document.getElementById('nicole-panel'));
      });
    }

    const closeNicole = document.getElementById('close-nicole');
    if (closeNicole) {
      closeNicole.addEventListener('click', () => {
        closeModal(document.getElementById('nicole-panel'));
      });
    }

    // Existing reports → open PDF modal
    qsa('[data-report]').forEach(btn=> btn.addEventListener('click', ()=>{
      const type = btn.getAttribute('data-report');
      const url = buildPdfUrl(type);
      const frame = document.getElementById('pdfFrame');
      frame.src = url;
      openModal(document.getElementById('pdfModal'));
    }));

    // Flow navigation buttons
    qsa('.go').forEach(b=> b.addEventListener('click', e=>{
      const href = e.currentTarget.getAttribute('data-href');
      if(!href || e.currentTarget.disabled) return;
      
      // Update dependencies based on navigation
      if(href.includes('general_info')) state.deps.expertise = true;
      if(href.includes('upload-levi')) state.deps.levi = true;
      if(href.includes('damage-center')) state.deps.draft = true;
      
      applyDeps();
      window.location.href = href + paramCase();
    }));

    // Main CTA buttons
    if (qs('#cta-expertise')) {
      qs('#cta-expertise').addEventListener('click', ()=>{ 
        state.deps.expertise = true; 
        applyDeps(); 
        window.location.href = 'general_info.html' + paramCase(); 
      });
    }

    if (qs('#cta-exp-continue')) {
      qs('#cta-exp-continue').addEventListener('click', ()=>{ 
        window.location.href = 'expertise-summary.html' + paramCase(); 
      });
    }

    if (qs('#cta-estimate')) {
      qs('#cta-estimate').addEventListener('click', ()=> 
        window.location.href = 'estimate-builder.html' + paramCase()
      );
    }

    if (qs('#cta-est-continue')) {
      qs('#cta-est-continue').addEventListener('click', ()=> 
        window.location.href = 'estimate-report-builder.html' + paramCase()
      );
    }

    if (qs('#cta-final')) {
      qs('#cta-final').addEventListener('click', ()=> 
        window.location.href = 'final-report-builder.html' + paramCase()
      );
    }

    if (qs('#cta-final-continue')) {
      qs('#cta-final-continue').addEventListener('click', ()=> 
        window.location.href = 'final-report-template-builder.html' + paramCase()
      );
    }

    // Dev panel toggle (Alt+D)
    window.addEventListener('keydown', (e)=>{ 
      if(e.altKey && e.key.toLowerCase()==='d'){ 
        const p = qs('#devPanel'); 
        p.style.display = p.style.display==='none' ? 'block' : 'none'; 
      }
    });

    // Dev panel checkboxes
    qsa('#devPanel input[type=checkbox]').forEach(cb=> cb.addEventListener('change', ()=>{
      state.deps.expertise = qs('#dep-expertise')?.checked || false;
      state.deps.draft     = qs('#dep-draft')?.checked || false;
      state.deps.estimate  = qs('#dep-estimate')?.checked || false;
      state.deps.invoice   = qs('#dep-invoice')?.checked || false;
      state.deps.levi      = qs('#dep-levi')?.checked || false;
      applyDeps();
    }));

    // Initialize
    initCollapsibles();

    // Prefill date today
    if (qs('#date')) {
      qs('#date').value = new Date().toISOString().slice(0,10);
    }

    // URL parameters
    const qsParams = new URLSearchParams(location.search);
    if(qsParams.get('plate')){
      if (qs('#plate')) qs('#plate').value = qsParams.get('plate');
      if (qs('#owner')) qs('#owner').value = qsParams.get('owner')||'';
      if (qs('#date')) qs('#date').value = qsParams.get('date') || new Date().toISOString().slice(0,10);
      if (qs('#location')) qs('#location').value = qsParams.get('location')||'';
      startOrLoadCase();
    }

    // Initial state
    fillRibbon();
    applyDeps();

    // Keyboard shortcuts
    window.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
          case 'n': // Ctrl+N for new case
            e.preventDefault();
            qs('#plate').focus();
            break;
          case 's': // Ctrl+S for start case
            e.preventDefault();
            startOrLoadCase();
            break;
        }
      }
    });

    console.log('✅ Yaron Kayouf Selection Portal initialized');
  }
  </script>
</body>
</html>