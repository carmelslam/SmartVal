<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×”××©×™××•×ª ×©×œ×™ ×•×©×œ ×”×©×××™× - ×™×¨×•×Ÿ ×›×™×•×£ - ×©×××•×ª ×•×™×™×¢×•×¥</title>
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans Hebrew', Arial, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      direction: rtl;
      line-height: 1.6;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #003366 0%, #004c99 100%);
      padding: 1rem 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      color: white;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo {
      width: 50px;
      height: 50px;
      object-fit: contain;
      background: white;
      border-radius: 8px;
      padding: 5px;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .badge {
      background: #ff6b35;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
      position: absolute;
      top: -5px;
      left: -5px;
    }

    .icon-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      position: relative;
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      border: 1px solid #3a3a3a;
      transition: all 0.3s;
      cursor: pointer;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
      border-color: #003366;
    }

    .stat-label {
      color: #999;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 0.5rem;
    }

    .stat-change {
      font-size: 0.85rem;
      color: #10B981;
    }

    .stat-change.negative {
      color: #EF4444;
    }

    .toolbar {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
      border: 1px solid #3a3a3a;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Noto Sans Hebrew', Arial, sans-serif;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #ff6b35 0%, #ff8556 100%);
      color: white;
      box-shadow: 0 4px 6px rgba(255, 107, 53, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(255, 107, 53, 0.4);
    }

    .btn-secondary {
      background: #3a3a3a;
      color: #e0e0e0;
      border: 1px solid #4a4a4a;
    }

    .btn-secondary:hover {
      background: #4a4a4a;
    }

    .search-box {
      flex: 1;
      min-width: 250px;
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      border: 1px solid #4a4a4a;
      border-radius: 8px;
      background: #1a1a1a;
      color: #e0e0e0;
      font-family: 'Noto Sans Hebrew', Arial, sans-serif;
      font-size: 1rem;
    }

    .search-box::before {
      content: "ğŸ”";
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .task-card {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      border-right: 4px solid #3a3a3a;
      transition: all 0.3s;
      cursor: pointer;
    }

    .task-card:hover {
      transform: translateX(-5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    .task-card.high {
      border-right-color: #F59E0B;
    }

    .task-card.urgent {
      border-right-color: #EF4444;
    }

    .task-card.medium {
      border-right-color: #3B82F6;
    }

    .task-card.low {
      border-right-color: #10B981;
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }

    .task-title {
      font-weight: 600;
      color: #fff;
      font-size: 1rem;
    }

    .priority-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .priority-badge.high {
      background: rgba(245, 158, 11, 0.2);
      color: #F59E0B;
    }

    .priority-badge.urgent {
      background: rgba(239, 68, 68, 0.2);
      color: #EF4444;
    }

    .priority-badge.medium {
      background: rgba(59, 130, 246, 0.2);
      color: #3B82F6;
    }

    .priority-badge.low {
      background: rgba(16, 185, 129, 0.2);
      color: #10B981;
    }

    .task-meta {
      display: flex;
      gap: 1rem;
      font-size: 0.85rem;
      color: #999;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }

    .task-stats {
      display: flex;
      gap: 1rem;
      font-size: 0.85rem;
      color: #999;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.open {
      display: flex;
    }

    .modal-content {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid #3a3a3a;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-header h2 {
      color: #fff;
      font-size: 1.5rem;
    }

    .close-btn {
      background: none;
      border: none;
      color: #999;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      color: #fff;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: #e0e0e0;
      font-weight: 500;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #4a4a4a;
      border-radius: 8px;
      background: #1a1a1a;
      color: #e0e0e0;
      font-family: 'Noto Sans Hebrew', Arial, sans-serif;
      font-size: 1rem;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #999;
    }

    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #999;
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .footer {
      text-align: center;
      padding: 2rem;
      color: #666;
      border-top: 1px solid #3a3a3a;
      margin-top: 3rem;
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      .header {
        padding: 1rem;
      }

      .header h1 {
        font-size: 1.2rem;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }

      .stat-value {
        font-size: 2rem;
      }

      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }

      .search-box {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo" class="logo">
      <span>×™×¨×•×Ÿ ×›×™×•×£ - ×©×××•×ª ×•×™×™×¢×•×¥ - ×”××©×™××•×ª ×©×œ×™</span>
    </h1>
    <div class="header-actions">
      <div class="icon-btn" id="notificationsBtn"></div>
      <div class="icon-btn" onclick="window.location.href='selection.html'">
        ğŸ 
      </div>
      <div class="icon-btn" onclick="window.location.href='selection.html'">
        ğŸ‘¤
      </div>
    </div>
  </header>

  <!-- Notification Center Dropdown -->
  <div id="notificationDropdownContainer"></div>

  <div class="container">
    <!-- Statistics Section -->
    <div class="section-title">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×” ×›×œ×œ×™×ª</div>
    <div class="stats-grid">
      <div class="stat-card" onclick="filterByStatus('active')">
        <div class="stat-label">××©×™××•×ª ×¤×¢×™×œ×•×ª</div>
        <div class="stat-value" id="activeCount">0</div>
        <div class="stat-change" id="activeChange">×˜×•×¢×Ÿ...</div>
      </div>
      <div class="stat-card" onclick="filterByStatus('pending')">
        <div class="stat-label">×××ª×™× ×•×ª ×œ×ª×’×•×‘×”</div>
        <div class="stat-value" id="pendingCount">0</div>
        <div class="stat-change" id="pendingChange">×˜×•×¢×Ÿ...</div>
      </div>
      <div class="stat-card" onclick="filterByStatus('completed')">
        <div class="stat-label">×”×•×©×œ××• ×”×™×•×</div>
        <div class="stat-value" id="completedCount">0</div>
        <div class="stat-change" id="completedChange">×˜×•×¢×Ÿ...</div>
      </div>
      <div class="stat-card" onclick="filterByStatus('overdue')">
        <div class="stat-label">××™×—×•×¨ ×‘×™×¦×•×¢</div>
        <div class="stat-value" id="overdueCount">0</div>
        <div class="stat-change negative" id="overdueChange">×˜×•×¢×Ÿ...</div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <button class="btn btn-primary" onclick="openNewTaskModal()">â• ××©×™××” ×—×“×©×”</button>
      <button class="btn btn-secondary" onclick="openNewThreadModal()">ğŸ§µ ×©×¨×©×•×¨ ×—×“×©</button>
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="×—×™×¤×•×© ××©×™××•×ª..." oninput="searchTasks()">
      </div>
      <select class="btn btn-secondary" id="priorityFilter" onchange="filterTasks()">
        <option value="">×›×œ ×”×¢×“×™×¤×•×™×•×ª</option>
        <option value="urgent">×“×—×•×£</option>
        <option value="high">×’×‘×•×”</option>
        <option value="medium">×‘×™× ×•× ×™</option>
        <option value="low">× ××•×š</option>
      </select>
      <select class="btn btn-secondary" id="statusFilter" onchange="filterTasks()">
        <option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
        <option value="pending">×××ª×™× ×”</option>
        <option value="in_progress">×‘×‘×™×¦×•×¢</option>
        <option value="awaiting_response">×××ª×™× ×” ×œ×ª×©×•×‘×”</option>
        <option value="completed">×”×•×©×œ××”</option>
        <option value="verified">××•×©×¨×”</option>
      </select>
    </div>

    <!-- Tasks Section -->
    <div class="section-title">ğŸ“‹ ××©×™××•×ª ××—×¨×•× ×•×ª</div>
    <div id="tasksContainer">
      <div class="loading">×˜×•×¢×Ÿ ××©×™××•×ª</div>
    </div>
  </div>

  <!-- New Task Modal -->
  <div id="newTaskModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>â• ××©×™××” ×—×“×©×”</h2>
        <button class="close-btn" onclick="closeNewTaskModal()">âœ•</button>
      </div>
      <form id="newTaskForm" onsubmit="createTask(event)">
        <div class="form-group">
          <label for="taskTitle">×›×•×ª×¨×ª ×”××©×™××” *</label>
          <input type="text" id="taskTitle" required>
        </div>
        <div class="form-group">
          <label for="taskDescription">×ª×™××•×¨</label>
          <textarea id="taskDescription"></textarea>
        </div>
        <div class="form-group">
          <label for="taskType">×¡×•×’ ××©×™××”</label>
          <select id="taskType">
            <option value="custom">×›×œ×œ×™×ª</option>
            <option value="case_action">×¤×¢×•×œ×” ×‘×ª×™×§</option>
            <option value="document_request">×‘×§×©×ª ××¡××š</option>
            <option value="review_request">×‘×§×©×ª ×¡×§×™×¨×”</option>
            <option value="data_correction">×ª×™×§×•×Ÿ × ×ª×•× ×™×</option>
            <option value="follow_up">××¢×§×‘</option>
          </select>
        </div>
        <div class="form-group">
          <label for="assignedTo">×”×§×¦×” ×œ- *</label>
          <select id="assignedTo" required>
            <option value="">×‘×—×¨ ××©×ª××©...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="taskPriority">×¢×“×™×¤×•×ª</label>
          <select id="taskPriority">
            <option value="low">× ××•×›×”</option>
            <option value="medium" selected>×‘×™× ×•× ×™×ª</option>
            <option value="high">×’×‘×•×”×”</option>
            <option value="urgent">×“×—×•×¤×”</option>
          </select>
        </div>
        <div class="form-group">
          <label for="dueDate">×ª××¨×™×š ×™×¢×“</label>
          <input type="date" id="dueDate">
        </div>
        <div class="form-group">
          <label for="filingCaseId">××¡×¤×¨ ×ª×™×§ (××•×¤×¦×™×•× ×œ×™)</label>
          <select id="filingCaseId" onchange="onCaseSelected()">
            <option value="">×‘×—×¨ ×ª×™×§...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="plateDropdown">××¡×¤×¨ ×¨×™×©×•×™ (××•×¤×¦×™×•× ×œ×™)</label>
          <select id="plateDropdown" onchange="onPlateDropdownChange()">
            <option value="">×‘×—×¨ ××¡×¤×¨ ×¨×™×©×•×™...</option>
            <option value="__manual__">×”×–× ×” ×™×“× ×™×ª</option>
          </select>
        </div>
        <div class="form-group" id="plateManualGroup" style="display: none;">
          <label for="plateManual">×”×–×Ÿ ××¡×¤×¨ ×¨×™×©×•×™ ×™×“× ×™×ª</label>
          <input type="text" id="plateManual" placeholder="12-345-67">
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
          <button type="submit" class="btn btn-primary" style="flex: 1;">âœ… ×¦×•×¨ ××©×™××”</button>
          <button type="button" class="btn btn-secondary" onclick="closeNewTaskModal()">×‘×™×˜×•×œ</button>
        </div>
      </form>
    </div>
  </div>

  <div class="footer">
    Â©2025 Carmel Cayouf. All rights reserved. SmartVal Pro System by Evalix
  </div>

  <script type="module">
    import { supabase } from './lib/supabaseClient.js';
    import { taskNotifications } from './task-notifications.js';
    import { notificationCenter } from './notification-center.js';

    // Global state
    let allTasks = [];
    let allUsers = [];
    let currentUser = null;

    // Initialize
    async function init() {
      try {
        // Get current user
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          window.location.href = 'index.html';
          return;
        }

        // Get user profile
        const { data: profile } = await supabase
          .from('profiles')
          .select('*')
          .eq('user_id', user.id)
          .single();

        currentUser = profile;
        console.log('Current user:', currentUser);

        // Check access - only assistants can access this page
        if (profile.role !== 'assistant') {
          alert('â›” ××™×Ÿ ×œ×š ×”×¨×©××” ×œ×’×©×ª ×œ×“×£ ×–×”\n\n×“×£ ×–×” ××™×•×¢×“ ×¢×‘×•×¨ ×¢×•×–×¨×•×ª ×‘×œ×‘×“.');
          window.location.href = 'selection.html';
          return;
        }

        // Load users for assignment dropdown
        await loadUsers();

        // Load cases and plates for dropdowns
        await populateCaseDropdown();
        await populatePlateDropdown();

        // Load tasks
        await loadTasks();

        // Update stats
        await updateStats();

        // Set up real-time subscriptions
        setupRealtime();

        // Initialize notification center
        initNotificationCenter();

      } catch (error) {
        console.error('Initialization error:', error);
        showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×');
      }
    }

    // Initialize notification center
    async function initNotificationCenter() {
      try {
        if (!currentUser) return;

        // Inject notification center styles
        const styleElement = document.createElement('div');
        styleElement.innerHTML = notificationCenter.getStyles();
        document.head.appendChild(styleElement.firstElementChild);

        // Inject notification bell icon
        const notifBtn = document.getElementById('notificationsBtn');
        if (notifBtn) {
          notifBtn.innerHTML = notificationCenter.getBellIconHTML();
        }

        // Inject notification dropdown
        const dropdownContainer = document.getElementById('notificationDropdownContainer');
        if (dropdownContainer) {
          dropdownContainer.innerHTML = notificationCenter.getDropdownHTML();
        }

        // Initialize notification center
        await notificationCenter.init(currentUser.user_id);

        console.log('ğŸ”” Notification center initialized');
      } catch (error) {
        console.error('Error initializing notification center:', error);
      }
    }

    // Load all users for assignment dropdown
    async function loadUsers() {
      try {
        const { data, error } = await supabase
          .from('profiles')
          .select('user_id, name, role')
          .order('name');

        if (error) throw error;

        allUsers = data || [];
        populateUserDropdown();

      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    function populateUserDropdown() {
      const select = document.getElementById('assignedTo');
      select.innerHTML = '<option value="">×‘×—×¨ ××©×ª××©...</option>';

      // Assistant can only assign to themselves or assessors
      allUsers.forEach(user => {
        if (user.user_id === currentUser.user_id || user.role === 'assessor') {
          const option = document.createElement('option');
          option.value = user.user_id;
          option.textContent = `${user.name} (${getRoleLabel(user.role)})`;
          select.appendChild(option);
        }
      });
    }

    function getRoleLabel(role) {
      const labels = {
        admin: '×× ×”×œ',
        developer: '××¤×ª×—',
        assistant: '×¢×•×–×¨',
        assessor: '×©×××™',
        viewer: '×¦×•×¤×”'
      };
      return labels[role] || role;
    }

    // Load cases for dropdown
    async function loadCases() {
      try {
        const { data, error } = await supabase
          .from('cases')
          .select('id, filing_case_id, plate')
          .order('filing_case_id', { ascending: false })
          .limit(100);

        if (error) throw error;

        return data || [];
      } catch (error) {
        console.error('Error loading cases:', error);
        return [];
      }
    }

    // Populate case dropdown
    async function populateCaseDropdown() {
      const cases = await loadCases();
      const select = document.getElementById('filingCaseId');
      select.innerHTML = '<option value="">×‘×—×¨ ×ª×™×§...</option>';

      cases.forEach(c => {
        const option = document.createElement('option');
        option.value = c.filing_case_id;
        option.setAttribute('data-uuid', c.id);
        option.setAttribute('data-plate', c.plate || '');
        option.textContent = `${c.filing_case_id}${c.plate ? ' - ' + c.plate : ''}`;
        select.appendChild(option);
      });
    }

    // Populate plate dropdown
    async function populatePlateDropdown() {
      const cases = await loadCases();
      const select = document.getElementById('plateDropdown');
      select.innerHTML = '<option value="">×‘×—×¨ ××¡×¤×¨ ×¨×™×©×•×™...</option><option value="__manual__">×”×–× ×” ×™×“× ×™×ª</option>';

      // Get unique plates
      const uniquePlates = [...new Set(cases.map(c => c.plate).filter(p => p))];

      uniquePlates.forEach(plate => {
        const option = document.createElement('option');
        option.value = plate;
        option.textContent = plate;
        select.appendChild(option);
      });
    }

    // When case is selected, auto-fill plate
    window.onCaseSelected = function() {
      const select = document.getElementById('filingCaseId');
      const selectedOption = select.options[select.selectedIndex];
      const plate = selectedOption.getAttribute('data-plate');

      if (plate) {
        const plateDropdown = document.getElementById('plateDropdown');
        // Try to select the plate in dropdown
        for (let i = 0; i < plateDropdown.options.length; i++) {
          if (plateDropdown.options[i].value === plate) {
            plateDropdown.selectedIndex = i;
            break;
          }
        }
      }
    };

    // When plate dropdown changes
    window.onPlateDropdownChange = function() {
      const dropdown = document.getElementById('plateDropdown');
      const manualGroup = document.getElementById('plateManualGroup');
      const manualInput = document.getElementById('plateManual');

      if (dropdown.value === '__manual__') {
        manualGroup.style.display = 'block';
        manualInput.required = true;
      } else {
        manualGroup.style.display = 'none';
        manualInput.required = false;
        manualInput.value = '';
      }
    };

    // Load tasks for assistant role
    async function loadTasks(includeArchived = false) {
      try {
        // Get all tasks (we'll filter in JavaScript for complex logic)
        let query = supabase
          .from('tasks')
          .select('*')
          .order('created_at', { ascending: false });

        // Filter archived tasks unless viewing archive
        if (!includeArchived) {
          query = query.or('archived.is.null,archived.eq.false');
        }

        const { data: tasks, error: tasksError } = await query;

        if (tasksError) throw tasksError;

        // Get all profiles (for joining)
        const { data: profiles, error: profilesError } = await supabase
          .from('profiles')
          .select('user_id, name, role');

        if (profilesError) throw profilesError;

        // Create a lookup map for profiles
        const profileMap = {};
        (profiles || []).forEach(profile => {
          profileMap[profile.user_id] = profile;
        });

        // Filter tasks for assistant role:
        // 1. Tasks assigned TO this assistant
        // 2. Tasks assigned BY this assistant
        // 3. Tasks assigned to assessors (for monitoring)
        const filteredTasks = (tasks || []).filter(task => {
          const assignedToProfile = profileMap[task.assigned_to];

          return (
            task.assigned_to === currentUser.user_id ||  // Assigned to me
            task.assigned_by === currentUser.user_id ||  // Created by me
            (assignedToProfile && assignedToProfile.role === 'assessor')  // Assigned to assessor
          );
        });

        // Join tasks with profile data
        allTasks = filteredTasks.map(task => ({
          ...task,
          assigned_to_profile: profileMap[task.assigned_to] || null,
          assigned_by_profile: profileMap[task.assigned_by] || null
        }));

        renderTasks(allTasks);

      } catch (error) {
        console.error('Error loading tasks:', error);
        showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”××©×™××•×ª');
      }
    }

    function renderTasks(tasks) {
      const container = document.getElementById('tasksContainer');

      if (!tasks || tasks.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“</div>
            <h3>××™×Ÿ ××©×™××•×ª ×œ×”×¦×’×”</h3>
            <p>×œ×—×¥ ×¢×œ "××©×™××” ×—×“×©×”" ×›×“×™ ×œ×”×ª×—×™×œ</p>
          </div>
        `;
        return;
      }

      container.innerHTML = tasks.map(task => `
        <div class="task-card ${task.priority}">
          <div style="cursor: pointer;" onclick="openTaskDetail('${task.id}')">
            <div class="task-header">
              <div class="task-title">${escapeHtml(task.title)}</div>
              <span class="priority-badge ${task.priority}">
                ${getPriorityIcon(task.priority)} ${getPriorityLabel(task.priority)}
              </span>
            </div>
            <div class="task-meta">
              <span>ğŸ‘¤ ${task.assigned_to_profile?.name || '×œ× ×™×“×•×¢'}</span>
              <span>ğŸ“… ${formatDate(task.due_date) || '×œ×œ× ××•×¢×“'}</span>
              <span>ğŸ“Š ${getStatusLabel(task.status)}</span>
              ${task.plate ? `<span>ğŸš— ${task.plate}</span>` : ''}
            </div>
            <div class="task-stats">
              <span>ğŸ“ˆ ${task.completion_percentage || 0}%</span>
              <span>ğŸ• ${formatRelativeTime(task.created_at)}</span>
            </div>
          </div>
          <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #3a3a3a; display: flex; gap: 0.5rem; justify-content: flex-end;">
            ${(task.status === 'completed' || task.status === 'verified') && !task.archived ? `
              <button onclick="event.stopPropagation(); archiveTask('${task.id}')" style="background: #6B7280; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                ğŸ“¦ ×”×¢×‘×¨ ×œ××¨×›×™×•×Ÿ
              </button>
            ` : ''}
            ${task.archived ? `
              <button onclick="event.stopPropagation(); restoreTask('${task.id}')" style="background: #10B981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                â†©ï¸ ×©×—×–×¨
              </button>
            ` : ''}
          </div>
        </div>
      `).join('');
    }

    // Update statistics
    async function updateStats() {
      try {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // Active tasks (in_progress)
        const activeCount = allTasks.filter(t => t.status === 'in_progress').length;
        document.getElementById('activeCount').textContent = activeCount;

        // Pending tasks (pending or awaiting_response)
        const pendingCount = allTasks.filter(t =>
          t.status === 'pending' || t.status === 'awaiting_response'
        ).length;
        document.getElementById('pendingCount').textContent = pendingCount;

        // Completed today
        const completedToday = allTasks.filter(t => {
          if (!t.completed_at) return false;
          const completedDate = new Date(t.completed_at);
          return completedDate >= today;
        }).length;
        document.getElementById('completedCount').textContent = completedToday;

        // Overdue tasks
        const now = new Date();
        const overdueCount = allTasks.filter(t => {
          if (!t.due_date || t.status === 'completed' || t.status === 'verified') return false;
          return new Date(t.due_date) < now;
        }).length;
        document.getElementById('overdueCount').textContent = overdueCount;

        // Update change indicators (mock for now)
        document.getElementById('activeChange').textContent = `â†‘ +${Math.floor(Math.random() * 5)} ×”×—×•×“×©`;
        document.getElementById('pendingChange').textContent = `â†“ -${Math.floor(Math.random() * 3)} ×”×©×‘×•×¢`;
        document.getElementById('completedChange').textContent = `â†‘ +${completedToday} ×”×™×•×`;
        document.getElementById('overdueChange').textContent = overdueCount > 0 ? 'âš ï¸ ×“×•×¨×© ×˜×™×¤×•×œ' : 'âœ… ×”×›×œ ×‘×¡×“×¨';

      } catch (error) {
        console.error('Error updating stats:', error);
      }
    }

    // Real-time subscriptions
    function setupRealtime() {
      supabase
        .channel('tasks-changes')
        .on('postgres_changes',
          { event: '*', schema: 'public', table: 'tasks' },
          (payload) => {
            console.log('Task changed:', payload);
            loadTasks();
            updateStats();
          }
        )
        .subscribe();
    }

    // Modal functions
    window.openNewTaskModal = function() {
      document.getElementById('newTaskModal').classList.add('open');
    };

    window.closeNewTaskModal = function() {
      document.getElementById('newTaskModal').classList.remove('open');
      document.getElementById('newTaskForm').reset();
    };

    window.openNewThreadModal = function() {
      alert('×™×¦×™×¨×ª ×©×¨×©×•×¨ ×—×“×© - ×‘×¤×™×ª×•×—');
    };

    // Create new task
    window.createTask = async function(event) {
      event.preventDefault();

      try {
        // Get case_id (UUID) from the selected option
        const caseSelect = document.getElementById('filingCaseId');
        const selectedCaseOption = caseSelect.options[caseSelect.selectedIndex];
        const caseId = selectedCaseOption.getAttribute('data-uuid') || null;

        // Get plate - either from dropdown or manual input
        const plateDropdown = document.getElementById('plateDropdown');
        let plate = null;
        if (plateDropdown.value === '__manual__') {
          plate = document.getElementById('plateManual').value || null;
        } else if (plateDropdown.value) {
          plate = plateDropdown.value;
        }

        const formData = {
          title: document.getElementById('taskTitle').value,
          description: document.getElementById('taskDescription').value,
          task_type: document.getElementById('taskType').value,
          assigned_to: document.getElementById('assignedTo').value,
          assigned_by: currentUser.user_id,
          priority: document.getElementById('taskPriority').value,
          due_date: document.getElementById('dueDate').value || null,
          case_id: caseId,
          plate: plate,
          status: 'pending',
          completion_percentage: 0
        };

        const { data, error } = await supabase
          .from('tasks')
          .insert([formData])
          .select()
          .single();

        if (error) throw error;

        console.log('Task created:', data);
        alert('âœ… ×”××©×™××” × ×•×¦×¨×” ×‘×”×¦×œ×—×”!');
        closeNewTaskModal();
        await loadTasks();
        await updateStats();

      } catch (error) {
        console.error('Error creating task:', error);
        alert('âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×”××©×™××”: ' + error.message);
      }
    };

    // Filter and search functions
    window.filterByStatus = function(status) {
      const statusFilter = document.getElementById('statusFilter');
      statusFilter.value = status === 'active' ? 'in_progress' :
                          status === 'overdue' ? '' : status;
      filterTasks();
    };

    window.filterTasks = function() {
      const priority = document.getElementById('priorityFilter').value;
      const status = document.getElementById('statusFilter').value;
      const search = document.getElementById('searchInput').value.toLowerCase();

      let filtered = allTasks;

      if (priority) {
        filtered = filtered.filter(t => t.priority === priority);
      }

      if (status) {
        filtered = filtered.filter(t => t.status === status);
      }

      if (search) {
        filtered = filtered.filter(t =>
          t.title.toLowerCase().includes(search) ||
          (t.description && t.description.toLowerCase().includes(search)) ||
          (t.plate && t.plate.includes(search))
        );
      }

      renderTasks(filtered);
    };

    window.searchTasks = function() {
      filterTasks();
    };

    window.openTaskDetail = function(taskId) {
      window.location.href = `task-detail.html?id=${taskId}`;
    };

    // Utility functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getPriorityIcon(priority) {
      const icons = {
        low: 'ğŸŸ¢',
        medium: 'ğŸ”µ',
        high: 'âš ï¸',
        urgent: 'ğŸ”´'
      };
      return icons[priority] || 'âšª';
    }

    function getPriorityLabel(priority) {
      const labels = {
        low: '× ××•×š',
        medium: '×‘×™× ×•× ×™',
        high: '×’×‘×•×”',
        urgent: '×“×—×•×£'
      };
      return labels[priority] || priority;
    }

    function getStatusLabel(status) {
      const labels = {
        pending: '×××ª×™× ×”',
        in_progress: '×‘×‘×™×¦×•×¢',
        awaiting_response: '×××ª×™× ×” ×œ×ª×©×•×‘×”',
        completed: '×”×•×©×œ××”',
        verified: '××•×©×¨×”',
        cancelled: '×‘×•×˜×œ×”'
      };
      return labels[status] || status;
    }

    function formatDate(dateString) {
      if (!dateString) return null;
      const date = new Date(dateString);
      return date.toLocaleDateString('he-IL', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatRelativeTime(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return '×¢×›×©×™×•';
      if (diffMins < 60) return `×œ×¤× ×™ ${diffMins} ×“×§×•×ª`;
      if (diffHours < 24) return `×œ×¤× ×™ ${diffHours} ×©×¢×•×ª`;
      return `×œ×¤× ×™ ${diffDays} ×™××™×`;
    }

    function showError(message) {
      const container = document.getElementById('tasksContainer');
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">âŒ</div>
          <h3>${message}</h3>
        </div>
      `;
    }

    // Archive and Restore Functions
    window.archiveTask = async function(taskId) {
      if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×¢×‘×™×¨ ××©×™××” ×–×• ×œ××¨×›×™×•×Ÿ?\n\n×ª×•×›×œ ×œ×©×—×–×¨ ××•×ª×” ×‘×›×œ ×¢×ª.')) {
        return;
      }

      try {
        const auth = sessionStorage.getItem('auth');
        if (!auth) {
          alert('âŒ × ×“×¨×©×ª ×”×ª×—×‘×¨×•×ª');
          return;
        }

        const authData = JSON.parse(auth);
        const userId = authData.profile?.user_id || authData.user?.id;

        const { error } = await supabase
          .from('tasks')
          .update({
            archived: true,
            archived_at: new Date().toISOString(),
            archived_by: userId
          })
          .eq('id', taskId);

        if (error) throw error;

        alert('âœ… ×”××©×™××” ×”×•×¢×‘×¨×” ×œ××¨×›×™×•×Ÿ');
        await loadTasks(); // Refresh task list
        await updateStats();

      } catch (error) {
        console.error('Error archiving task:', error);
        alert('âŒ ×©×’×™××” ×‘×”×¢×‘×¨×” ×œ××¨×›×™×•×Ÿ: ' + error.message);
      }
    };

    window.restoreTask = async function(taskId) {
      try {
        const { error } = await supabase
          .from('tasks')
          .update({
            archived: false,
            archived_at: null,
            archived_by: null
          })
          .eq('id', taskId);

        if (error) throw error;

        alert('âœ… ×”××©×™××” ×©×•×—×–×¨×” ××”××¨×›×™×•×Ÿ');
        await loadTasks(); // Refresh task list
        await updateStats();

      } catch (error) {
        console.error('Error restoring task:', error);
        alert('âŒ ×©×’×™××” ×‘×©×—×–×•×¨ ×”××©×™××”: ' + error.message);
      }
    };

    // Initialize on load
    init();
  </script>
</body>
</html>
