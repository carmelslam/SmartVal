<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>×©×œ×‘ 4: ×—×™×©×•×‘×™× ×¡×•×¤×™×™× ×•×¡×™×›×•× - ××©×£ ×—×•×•×ª ×”×“×¢×ª - ×™×¨×•×Ÿ ×›×™×•×£</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" type="image/webp">
  <style>
    body {
      font-family: sans-serif;
      background: #f3f6fb;
      margin: 0;
      min-height: 100vh;
      padding: 0;
      padding-top: 90px;
      overflow-x: hidden;
    }
    .container {
      width: 100%;
      max-width: 820px;
      min-width: 320px;
      background: #fff;
      padding: 32px 24px 24px 24px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.08);
      margin: 32px auto 32px auto;
      box-sizing: border-box;
    }
    .logo {
      display: flex;
      justify-content: center;
      margin-bottom: 8px;
    }
    .logo img {
      width: 112px;
      height: auto;
      display: block;
    }
    .title { font-size: 27px; font-weight: bold; text-align: center; margin-bottom: 2px; font-weight: 900;}
    .subtitle { font-size: 23px; color: #666; text-align: center; margin-bottom: 10px;}
    h1, h2 { color: #1e3a8a; font-size: 25px; text-align: center; margin: 15px 0 8px 0; font-weight: 600;}
    h3 { color: #1e3a8a; font-size: 24px; margin: 22px 0 12px 0; text-align: right; font-weight: 900;}
    .form-section {
      width: 100%;
      max-width: 100%;
      margin-bottom: 20px;
      background: #fafbfe;
      border-radius: 12px;
      padding: 17px 15px 12px 15px;
      box-sizing: border-box;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      overflow: hidden;
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px 18px;
      width: 100%;
    }
    @media (max-width: 600px) {
      .form-grid { grid-template-columns: 1fr; }
      .container {
        width: 98vw;
        max-width: 98vw;
        min-width: 0;
        padding: 14px 2vw 20px 2vw;
      }
    }
    
    /* Mobile viewport fixes */
    @media (max-width: 768px) {
      body {
        width: 100vw;
        overflow-x: hidden !important;
        position: relative;
      }
      
      html {
        width: 100vw;
        overflow-x: hidden !important;
      }
      
      .container {
        width: 95vw;
        max-width: 95vw;
        margin: 32px 2.5vw 32px 2.5vw;
      }
    }
    
    /* Desktop constraint fix */
    @media (min-width: 769px) {
      .container {
        width: 100%;
        max-width: 820px !important;
        margin: 32px auto !important;
      }
    }
    
    label {
      font-size: 18px;
      margin-bottom: 4px;
      display: block;
      text-align: right;
    }
    input, select, textarea {
      width: 100%;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 0px;
      padding: 8px 9px;
      box-sizing: border-box;
      text-align: right !important;
      background: #f9f9f9;
      transition: border .15s;
      outline: none;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #3b82f6;
    }
    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      display: block;
    }
    
    /* Collapsible button styles */
    .collapsible-btn {
      width: 100%;
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      color: white;
      border: none;
      padding: 15px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
    }
    .collapsible-btn:hover {
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }
    
    /* Navigation styles */
    .navigation-section {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
      padding: 20px 0;
      border-top: 2px solid #e5e7eb;
    }
    .nav-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      text-decoration: none;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    .nav-btn:hover {
      background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(32, 201, 151, 0.4);
    }
    .nav-btn.secondary {
      background: linear-gradient(135deg, #6c757d 0%, #adb5bd 100%);
    }
    .nav-btn.secondary:hover {
      background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
    }
    .nav-btn.primary {
      background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
      font-size: 20px;
      padding: 18px 35px;
    }
    .nav-btn.primary:hover {
      background: linear-gradient(135deg, #c82333 0%, #dc3545 100%);
    }
    
    /* Stage indicator */
    .stage-indicator {
      text-align: center;
      margin-bottom: 20px;
      font-size: 16px;
      color: #666;
    }
    .stage-progress {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .stage-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #6b7280;
    }
    .stage-circle.active {
      background: #3b82f6;
      color: white;
    }
    .stage-circle.completed {
      background: #10b981;
      color: white;
    }
    
    /* Final summary styles */
    .final-summary {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      margin: 25px 0;
      font-size: 18px;
      font-weight: bold;
      box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
    }
    
    /* Calculation grid */
    .calc-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 15px;
      align-items: center;
      margin-bottom: 15px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #28a745;
    }
    .calc-label {
      font-weight: 600;
      text-align: right;
      color: #1e3a8a;
    }
    .calc-value {
      font-weight: bold;
      text-align: center;
      background: white;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #dee2e6;
    }
    .calc-input-field {
      text-align: center !important;
      background: white !important;
      border: 2px solid #28a745 !important;
    }
    
    /* Hide certain fields based on report type */
    .differential-only {
      display: none;
    }
    .differential-only.show {
      display: block;
    }
  </style>
</head>
<body>

  <!-- Stage Progress Indicator -->
  <div class="stage-progress">
    <div class="stage-circle completed">1</div>
    <div class="stage-circle completed">2</div>
    <div class="stage-circle completed">3</div>
    <div class="stage-circle active">4</div>
  </div>
  <div class="stage-indicator">×©×œ×‘ 4 ××ª×•×š 4: ×—×™×©×•×‘×™× ×¡×•×¤×™×™× ×•×¡×™×›×•×</div>

  <div class="container">
    <div class="logo">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="×™×¨×•×Ÿ ×›×™×•×£">
    </div>
    <div class="title">××©×£ ×—×•×•×ª ×”×“×¢×ª - ×©×œ×‘ 4</div>
    <div class="subtitle">×—×™×©×•×‘×™× ×¡×•×¤×™×™× ×•×¡×™×›×•×</div>
    
    <!-- ×—×™×©×•×‘ ×™×¨×™×“×ª ×¢×¨×š SECTION -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('valueDepreciation')">×—×™×©×•×‘ ×™×¨×™×“×ª ×¢×¨×š</button>
      <div id="valueDepreciation" style="display:none; margin-top: 15px;">
        <div class="calc-grid">
          <div class="calc-label">×¢×¨×š ×”×©×•×§ ×”××œ× (××©×œ×‘ 3):</div>
          <div class="calc-value">â‚ª<span id="fullMarketValueDisplay">0</span></div>
        </div>
        <div class="calc-grid">
          <div class="calc-label">××—×•×– ×”× ×–×§ (××©×œ×‘ 3):</div>
          <div class="calc-value"><span id="damagePercentDisplay">0</span>%</div>
        </div>
        <div class="form-grid" style="margin-top: 15px;">
          <div>
            <label>××—×•×– ×™×¨×™×“×ª ×¢×¨×š ××•×¢×¨×š:</label>
            <input type="number" id="valueDepreciationPercent" class="calc-input-field" placeholder="%" step="0.1" min="0" max="100">
          </div>
          <div>
            <label>×™×¨×™×“×ª ×¢×¨×š ×‘×©×´×—:</label>
            <input type="number" id="valueDepreciationAmount" class="calc-input-field" placeholder="×¡×›×•× ×‘×©×´×—" step="0.01">
          </div>
        </div>
        <div style="margin-top: 15px;">
          <label>× ×™××•×§ ×œ×™×¨×™×“×ª ×”×¢×¨×š:</label>
          <textarea id="valueDepreciationReason" rows="3" placeholder="×”×¡×‘×¨ ××¤×•×¨×˜ ×œ×—×™×©×•×‘ ×™×¨×™×“×ª ×”×¢×¨×š..."></textarea>
        </div>
      </div>
    </div>

    <!-- ×”×¤×¨×©×™× SECTION (shown only for relevant report types) -->
    <div class="form-section differential-only" id="differentialsSection">
      <button class="collapsible-btn" type="button" onclick="toggleSection('differentials')">×”×¤×¨×©×™×</button>
      <div id="differentials" style="display:none; margin-top: 15px;">
        <div class="calc-grid">
          <div class="calc-label">×¢×œ×•×ª ×›×œ×œ ×”× ×–×§×™×:</div>
          <div class="calc-value">â‚ª<span id="totalDamageForDiff">0</span></div>
        </div>
        <div class="calc-grid">
          <div class="calc-label">×™×¨×™×“×ª ×¢×¨×š ××—×•×©×‘×ª:</div>
          <div class="calc-value">â‚ª<span id="valueDepForDiff">0</span></div>
        </div>
        <div class="form-grid" style="margin-top: 15px;">
          <div>
            <label>×”×©×ª×ª×¤×•×ª ×¢×¦××™×ª:</label>
            <input type="number" id="deductible" class="calc-input-field" placeholder="×¡×›×•× ×‘×©×´×—" step="0.01">
          </div>
          <div>
            <label>×”×¤×¨×©×™× × ×•×¡×¤×™×:</label>
            <input type="number" id="additionalDifferentials" class="calc-input-field" placeholder="×¡×›×•× ×‘×©×´×—" step="0.01">
          </div>
        </div>
        <div class="calc-grid">
          <div class="calc-label">×¡×”×´×› ×”×¤×¨×©×™×:</div>
          <div class="calc-value">â‚ª<span id="totalDifferentials">0</span></div>
        </div>
      </div>
    </div>

    <!-- × ×ª×•× ×™ ×ª×‘×™×¢×” SECTION -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('claimData')">× ×ª×•× ×™ ×ª×‘×™×¢×”</button>
      <div id="claimData" style="display:none; margin-top: 15px;">
        <div class="form-grid">
          <div>
            <label>××¡×¤×¨ ×ª×‘×™×¢×”:</label>
            <input type="text" id="claimNumber" placeholder="××¡×¤×¨ ×ª×‘×™×¢×”">
          </div>
          <div>
            <label>×ª××¨×™×š ××™×¨×•×¢:</label>
            <input type="date" id="eventDate">
          </div>
          <div>
            <label>×—×‘×¨×ª ×‘×™×˜×•×—:</label>
            <input type="text" id="insuranceCompany" placeholder="×©× ×—×‘×¨×ª ×”×‘×™×˜×•×—">
          </div>
          <div>
            <label>×¡×•×›×Ÿ ×‘×™×˜×•×—:</label>
            <input type="text" id="insuranceAgent" placeholder="×©× ×”×¡×•×›×Ÿ">
          </div>
        </div>
        <div style="margin-top: 15px;">
          <label>×ª×™××•×¨ ×”××™×¨×•×¢:</label>
          <textarea id="eventDescription" rows="3" placeholder="×ª×™××•×¨ ××¤×•×¨×˜ ×©×œ ×”××™×¨×•×¢..."></textarea>
        </div>
      </div>
    </div>

    <!-- ×”×¢×¨×•×ª × ×•×¡×¤×•×ª SECTION -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('additionalNotes')">×”×¢×¨×•×ª × ×•×¡×¤×•×ª</button>
      <div id="additionalNotes" style="display:none; margin-top: 15px;">
        <textarea id="generalNotes" rows="5" placeholder="×”×¢×¨×•×ª ×›×œ×œ×™×•×ª × ×•×¡×¤×•×ª ×œ×—×•×•×ª ×”×“×¢×ª..."></textarea>
      </div>
    </div>

    <!-- ×¡×™×›×•× SECTION -->
    <div class="form-section">
      <h3>×¡×™×›×•× ×—×•×•×ª ×”×“×¢×ª</h3>
      <div class="calc-grid">
        <div class="calc-label">×¡×•×’ ×”×“×•×—:</div>
        <div class="calc-value" id="reportTypeSummary">-</div>
      </div>
      <div class="calc-grid">
        <div class="calc-label">×¨×›×‘ × ×“×•×Ÿ:</div>
        <div class="calc-value" id="vehicleSummary">-</div>
      </div>
      <div class="calc-grid">
        <div class="calc-label">×¢×œ×•×ª ×›×œ×œ ×”× ×–×§×™×:</div>
        <div class="calc-value">â‚ª<span id="totalDamageSummary">0</span></div>
      </div>
      <div class="calc-grid">
        <div class="calc-label">×™×¨×™×“×ª ×¢×¨×š ××—×•×©×‘×ª:</div>
        <div class="calc-value">â‚ª<span id="valueDepSummary">0</span></div>
      </div>
      <div class="calc-grid differential-only">
        <div class="calc-label">×¡×”×´×› ×¡×•×¤×™ (×œ××—×¨ ×”×¤×¨×©×™×):</div>
        <div class="calc-value">â‚ª<span id="finalTotalSummary">0</span></div>
      </div>
    </div>

    <!-- ×˜×§×¡×˜ ××©×¤×˜×™ SECTION -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('legalText')">×˜×§×¡×˜ ××©×¤×˜×™</button>
      <div id="legalText" style="display:none; margin-top: 15px;">
        <textarea id="legal-text-content" rows="4" style="width: 100%; min-height: 200px; padding: 15px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8f9fa; line-height: 1.6; font-family: inherit; resize: vertical; box-sizing: border-box;" placeholder="×”×˜×§×¡×˜ ×”××©×¤×˜×™ ×™×˜×¢×Ÿ ×›××Ÿ ×¢× ×”× ×ª×•× ×™× ×”××¢×•×“×›× ×™×..."></textarea>
      </div>
    </div>

    <!-- ×¨×©×™××ª × ×¡×¤×—×™× SECTION -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('attachments')">×¨×©×™××ª × ×¡×¤×—×™×</button>
      <div id="attachments" style="display:none; margin-top: 15px;">
        <textarea id="attachments-content" style="width: 100%; min-height: 120px; padding: 15px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8f9fa; line-height: 1.6; font-family: inherit; resize: vertical; box-sizing: border-box;" placeholder="×¨×©×™××ª ×”× ×¡×¤×—×™× ×ª×˜×¢×Ÿ ×›××Ÿ..."></textarea>
      </div>
    </div>

    <!-- FINAL SUMMARY -->
    <div class="final-summary">
      <div style="font-size: 22px; margin-bottom: 15px;">×¡×™×›×•× ×¡×•×¤×™</div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 16px;">
        <div>
          <div>× ×–×§×™×: â‚ª<span id="finalDamageAmount">0</span></div>
          <div>×™×¨×™×“×ª ×¢×¨×š: â‚ª<span id="finalValueDep">0</span></div>
        </div>
        <div>
          <div class="differential-only">×”×¤×¨×©×™×: â‚ª<span id="finalDifferentials">0</span></div>
          <div style="font-size: 18px; font-weight: 900;">×¡×”×´×› ×¡×•×¤×™: â‚ª<span id="grandTotal">0</span></div>
        </div>
      </div>
    </div>

    <!-- NAVIGATION -->
    <div class="navigation-section">
      <button class="nav-btn secondary" onclick="backToStage3()">â† ×—×–×•×¨ ×œ×©×œ×‘ 3</button>
      <button class="nav-btn primary" onclick="generateFinalReport()">×™×¦×™×¨×ª ×—×•×•×ª ×“×¢×ª ×¡×•×¤×™×ª ğŸ“„</button>
    </div>
  </div>

  <!-- JavaScript -->
  <script src="helper.js"></script>
  <script src="legal-text-engine.js"></script>
  <script>
    // Initialize helper data
    let helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
    
    // Collapsible section toggle
    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }
    
    // Check if report type supports differentials (from original logic)
    function supportsDifferentials() {
      const reportType = helper.final_report?.dropdown_type || '';
      const differentialTypes = [
        '×—×•×•×ª ×“×¢×ª ×¤×¨×˜×™×ª',
        '×—×•×•×ª ×“×¢×ª ×’×œ×•×‘×œ×™×ª', 
        '×—×•×•×ª ×“×¢×ª ××›×™×¨×” ××¦×‘×• ×”× ×™×–×•×§'
      ];
      return differentialTypes.some(type => reportType.includes(type));
    }
    
    // Show/hide differential sections based on report type
    function toggleDifferentialSections() {
      const showDifferentials = supportsDifferentials();
      const diffElements = document.querySelectorAll('.differential-only');
      diffElements.forEach(el => {
        if (showDifferentials) {
          el.classList.add('show');
        } else {
          el.classList.remove('show');
        }
      });
      console.log('ğŸ”„ Differential sections visibility updated:', showDifferentials);
    }
    
    // Calculate value depreciation amount from percentage
    function calculateValueDepreciation() {
      const fullMarketValue = parseFloat(document.getElementById('fullMarketValueDisplay').textContent.replace(/,/g, '')) || 0;
      const depreciationPercent = parseFloat(document.getElementById('valueDepreciationPercent').value) || 0;
      
      if (fullMarketValue > 0 && depreciationPercent > 0) {
        const depreciationAmount = (fullMarketValue * depreciationPercent / 100).toFixed(2);
        document.getElementById('valueDepreciationAmount').value = depreciationAmount;
      }
      updateAllCalculations();
    }
    
    // Calculate total differentials
    function calculateDifferentials() {
      const totalDamage = parseFloat(document.getElementById('totalDamageForDiff').textContent.replace(/,/g, '')) || 0;
      const valueDep = parseFloat(document.getElementById('valueDepForDiff').textContent.replace(/,/g, '')) || 0;
      const deductible = parseFloat(document.getElementById('deductible').value) || 0;
      const additional = parseFloat(document.getElementById('additionalDifferentials').value) || 0;
      
      const totalDifferentials = totalDamage + valueDep - deductible + additional;
      document.getElementById('totalDifferentials').textContent = totalDifferentials.toLocaleString();
      
      updateAllCalculations();
    }
    
    // Update all calculations and summaries
    function updateAllCalculations() {
      const totalDamage = helper.damage_centers_summary?.total_cost || 0;
      const valueDep = parseFloat(document.getElementById('valueDepreciationAmount').value) || 0;
      const totalDiff = parseFloat(document.getElementById('totalDifferentials').textContent.replace(/,/g, '')) || 0;
      
      // Update summary displays
      document.getElementById('totalDamageSummary').textContent = totalDamage.toLocaleString();
      document.getElementById('valueDepSummary').textContent = valueDep.toLocaleString();
      document.getElementById('finalTotalSummary').textContent = totalDiff.toLocaleString();
      
      // Update final summary
      document.getElementById('finalDamageAmount').textContent = totalDamage.toLocaleString();
      document.getElementById('finalValueDep').textContent = valueDep.toLocaleString();
      document.getElementById('finalDifferentials').textContent = totalDiff.toLocaleString();
      
      // Calculate grand total based on report type (original logic)
      let grandTotal = totalDamage + valueDep;
      if (supportsDifferentials()) {
        grandTotal = totalDiff > 0 ? totalDiff : totalDamage + valueDep;
      }
      document.getElementById('grandTotal').textContent = grandTotal.toLocaleString();
    }
    
    // Load legal text from vault (original logic)
    async function loadLegalText() {
      try {
        const reportType = helper.final_report?.dropdown_type || '';
        console.log('ğŸ”„ Loading legal text for report type:', reportType);
        
        if (window.LegalTextEngine) {
          const legalText = await window.LegalTextEngine.getProcessedText(
            reportType,
            'final_report',
            helper
          );
          
          const legalTextElement = document.getElementById('legal-text-content');
          if (legalTextElement) {
            legalTextElement.value = legalText;
            helper.final_report.legal_text = legalText;
            sessionStorage.setItem('helper', JSON.stringify(helper));
          }
        }
      } catch (error) {
        console.error('âŒ Error loading legal text:', error);
      }
    }
    
    // Load attachments from vault (original logic)
    function loadAttachmentsFromVault() {
      const reportType = helper.final_report?.dropdown_type || '';
      
      const attachmentsVault = {
        '×—×•×•×ª ×“×¢×ª ×¤×¨×˜×™×ª': '**×œ×•×˜×”**\n×ª×¦×œ×•××™ ×”×¨×›×‘ ×”× ×™×–×•×§\n×—×©×‘×•× ×™×•×ª ×ª×™×§×•×Ÿ\n×¢×¨×š ×¨×›×‘ ×××•×—×©×‘\n×¦×™×œ×•× ×¨×™×©×™×•×Ÿ ×”×¨×›×‘\n×—×©×›"×˜',
        '×—×•×•×ª ×“×¢×ª ×’×œ×•×‘×œ×™×ª': '**×œ×•×˜×”**\n×ª×¦×œ×•××™ ×”×¨×›×‘ ×”× ×™×–×•×§\n×—×©×‘×•× ×™×•×ª ×ª×™×§×•×Ÿ\n×¢×¨×š ×¨×›×‘ ×××•×—×©×‘\n×¦×™×œ×•× ×¨×™×©×™×•×Ÿ ×”×¨×›×‘\n×—×©×›"×˜\n×“×•×— ××•××—×”',
        '×—×•×•×ª ×“×¢×ª ××›×™×¨×” ××¦×‘×• ×”× ×™×–×•×§': '**×œ×•×˜×”**\n×ª×¦×œ×•××™ ×”×¨×›×‘ ×”× ×™×–×•×§\n×”×¦×¢×•×ª ××—×™×¨ ×œ×ª×™×§×•×Ÿ\n×¢×¨×š ×¨×›×‘ ×××•×—×©×‘\n×¦×™×œ×•× ×¨×™×©×™×•×Ÿ ×”×¨×›×‘',
        '×—×•×•×ª ×“×¢×ª ×˜×•×˜×œ×•×¡×˜': '**×œ×•×˜×”**\n×ª×¦×œ×•××™ ×”×¨×›×‘ ×”× ×™×–×•×§\n×”×¦×¢×•×ª ××—×™×¨ ×œ×ª×™×§×•×Ÿ\n×¢×¨×š ×¨×›×‘ ×××•×—×©×‘\n×¦×™×œ×•× ×¨×™×©×™×•×Ÿ ×”×¨×›×‘\n×“×•×— ×—×‘×¨×ª ×”×‘×™×˜×•×—',
        '×—×•×•×ª ×“×¢×ª ××•×‘×“×Ÿ ×œ×”×œ×›×”': '**×œ×•×˜×”**\n×ª×¦×œ×•××™ ×”×¨×›×‘ ×”× ×™×–×•×§\n×”×¦×¢×•×ª ××—×™×¨ ×œ×ª×™×§×•×Ÿ\n×¢×¨×š ×¨×›×‘ ×××•×—×©×‘\n×¦×™×œ×•× ×¨×™×©×™×•×Ÿ ×”×¨×›×‘\n×“×•×— ××©×˜×¨×”'
      };
      
      const attachmentsText = attachmentsVault[reportType] || '**×œ×•×˜×”**\n×ª×¦×œ×•××™ ×”×¨×›×‘ ×”× ×™×–×•×§\n×—×©×‘×•× ×™×•×ª ×ª×™×§×•×Ÿ\n×¢×¨×š ×¨×›×‘ ×××•×—×©×‘\n×¦×™×œ×•× ×¨×™×©×™×•×Ÿ ×”×¨×›×‘\n×—×©×›"×˜';
      document.getElementById('attachments-content').value = attachmentsText;
      
      helper.final_report.attachments = attachmentsText;
      helper.final_report.attachments_locked = true;
      sessionStorage.setItem('helper', JSON.stringify(helper));
    }
    
    // Load data from previous stages
    function loadPreviousStagesData() {
      // From Stage 2 - damage centers
      const totalDamage = helper.damage_centers_summary?.total_cost || 0;
      document.getElementById('totalDamageForDiff').textContent = totalDamage.toLocaleString();
      
      // From Stage 3 - market values
      const marketValues = helper.market_values || {};
      document.getElementById('fullMarketValueDisplay').textContent = (marketValues.full_market_value || 0).toLocaleString();
      document.getElementById('damagePercentDisplay').textContent = (marketValues.damage_percentage || 0).toFixed(2);
      
      // From Stage 1 - vehicle and report data
      const vehicle = helper.vehicle || {};
      const vehicleDesc = `${vehicle.year || ''} ${vehicle.make || ''} ${vehicle.model || ''}`.trim();
      document.getElementById('vehicleSummary').textContent = vehicleDesc || '-';
      
      const reportType = helper.final_report?.dropdown_type || '-';
      document.getElementById('reportTypeSummary').textContent = reportType;
    }
    
    // Save Stage 4 data
    function saveStage4Data() {
      helper.final_calculations = helper.final_calculations || {};
      
      // Value depreciation
      helper.final_calculations.value_depreciation_percent = parseFloat(document.getElementById('valueDepreciationPercent').value) || 0;
      helper.final_calculations.value_depreciation_amount = parseFloat(document.getElementById('valueDepreciationAmount').value) || 0;
      helper.final_calculations.value_depreciation_reason = document.getElementById('valueDepreciationReason').value;
      
      // Differentials (if applicable based on report type)
      if (supportsDifferentials()) {
        helper.final_calculations.deductible = parseFloat(document.getElementById('deductible').value) || 0;
        helper.final_calculations.additional_differentials = parseFloat(document.getElementById('additionalDifferentials').value) || 0;
        helper.final_calculations.total_differentials = parseFloat(document.getElementById('totalDifferentials').textContent.replace(/,/g, '')) || 0;
      }
      
      // Claim data
      helper.claim_data = helper.claim_data || {};
      helper.claim_data.claim_number = document.getElementById('claimNumber').value;
      helper.claim_data.event_date = document.getElementById('eventDate').value;
      helper.claim_data.insurance_company = document.getElementById('insuranceCompany').value;
      helper.claim_data.insurance_agent = document.getElementById('insuranceAgent').value;
      helper.claim_data.event_description = document.getElementById('eventDescription').value;
      
      // Additional notes and legal text (using original field names)
      helper.additional_notes = document.getElementById('generalNotes').value;
      helper.final_report = helper.final_report || {};
      helper.final_report.legal_text = document.getElementById('legal-text-content').value;
      
      // Attachments (using original format)
      helper.final_report.attachments = document.getElementById('attachments-content').value;
      
      // Save to session storage
      sessionStorage.setItem('helper', JSON.stringify(helper));
      console.log('Stage 4 data saved:', helper);
    }
    
    // Load existing Stage 4 data
    function loadStage4Data() {
      if (helper.final_calculations) {
        const fc = helper.final_calculations;
        if (fc.value_depreciation_percent) document.getElementById('valueDepreciationPercent').value = fc.value_depreciation_percent;
        if (fc.value_depreciation_amount) document.getElementById('valueDepreciationAmount').value = fc.value_depreciation_amount;
        if (fc.value_depreciation_reason) document.getElementById('valueDepreciationReason').value = fc.value_depreciation_reason;
        
        if (fc.deductible) document.getElementById('deductible').value = fc.deductible;
        if (fc.additional_differentials) document.getElementById('additionalDifferentials').value = fc.additional_differentials;
      }
      
      if (helper.claim_data) {
        const cd = helper.claim_data;
        if (cd.claim_number) document.getElementById('claimNumber').value = cd.claim_number;
        if (cd.event_date) document.getElementById('eventDate').value = cd.event_date;
        if (cd.insurance_company) document.getElementById('insuranceCompany').value = cd.insurance_company;
        if (cd.insurance_agent) document.getElementById('insuranceAgent').value = cd.insurance_agent;
        if (cd.event_description) document.getElementById('eventDescription').value = cd.event_description;
      }
      
      if (helper.additional_notes) document.getElementById('generalNotes').value = helper.additional_notes;
      
      // Load legal text (from original logic)
      if (helper.final_report?.legal_text) {
        document.getElementById('legal-text-content').value = helper.final_report.legal_text;
      }
      
      // Load attachments (from original format)
      if (helper.final_report?.attachments) {
        document.getElementById('attachments-content').value = helper.final_report.attachments;
      }
    }
    
    // Navigation functions
    function backToStage3() {
      saveStage4Data();
      window.location.href = 'final-report-stage3.html';
    }
    
    function generateFinalReport() {
      saveStage4Data();
      // TODO: Navigate to final report generation or summary page
      alert('×—×•×•×ª ×”×“×¢×ª ×”×•×©×œ××” ×‘×”×¦×œ×—×”!\n\n×›×œ ×”× ×ª×•× ×™× × ×©××¨×• ×‘××¢×¨×›×ª.');
    }
    
    // Event listeners
    document.getElementById('valueDepreciationPercent').addEventListener('input', calculateValueDepreciation);
    document.getElementById('valueDepreciationAmount').addEventListener('input', function() {
      document.getElementById('valueDepForDiff').textContent = this.value;
      updateAllCalculations();
    });
    
    document.getElementById('deductible').addEventListener('input', calculateDifferentials);
    document.getElementById('additionalDifferentials').addEventListener('input', calculateDifferentials);
    
    // Auto-save on input changes
    document.addEventListener('input', function(e) {
      saveStage4Data();
    });
    
    document.addEventListener('change', function(e) {
      saveStage4Data();
    });
    
    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadPreviousStagesData();
      toggleDifferentialSections();
      loadStage4Data();
      updateAllCalculations();
      
      // Load dynamic content based on report type
      if (helper.final_report?.dropdown_type) {
        loadLegalText().catch(console.error);
        loadAttachmentsFromVault();
      }
    });
  </script>
</body>
</html>