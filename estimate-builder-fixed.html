<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×‘×•× ×” ××•××“×Ÿ - SmartVal</title>
    <link rel="stylesheet" href="global-styles.css">
    <script src="global-scripts.js"></script>
    <script src="legal-text-engine.js"></script>
    <style>
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #fff;
        }
        
        .section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1e40af;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: bold;
            color: #1e40af;
            margin: 0;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #374151;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .btn {
            background: #1e40af;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #1e3a8a;
        }
        
        .btn-secondary {
            background: #6b7280;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .floating-screens {
            position: fixed;
            top: 60px;
            left: 10px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .floating-btn {
            background: #1e40af;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        .floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <!-- Floating Action Buttons -->
    <div class="floating-screens">
        <button class="floating-btn" onclick="showBrowserMenuUnderToggle()" title="×“×¤×“×¤×Ÿ ×¤× ×™××™">ğŸŒ</button>
        <button class="floating-btn" onclick="toggleSection('summary')" title="×”×¦×’/×”×¡×ª×¨ ×¡×™×›×•×">ğŸ“Š</button>
        <button class="floating-btn" onclick="toggleSection('attachments')" title="×”×¦×’/×”×¡×ª×¨ ×§×‘×¦×™× ××¦×•×¨×¤×™×">ğŸ“</button>
        <button class="floating-btn" onclick="saveToHelper()" title="×©××•×¨ × ×ª×•× ×™×">ğŸ’¾</button>
    </div>

    <div class="main-container">
        <h1 style="text-align: center; color: #1e40af; margin-bottom: 30px;">×‘×•× ×” ××•××“×Ÿ ×¨×›×‘ - SmartVal</h1>
        
        <!-- Car Details Section -->
        <div class="section" id="carDetailsSection">
            <div class="section-header">
                <h2 class="section-title">×¤×¨×˜×™ ×”×¨×›×‘</h2>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="carPlate">××¡×¤×¨ ×¨×›×‘:</label>
                    <input type="text" id="carPlate" placeholder="××¡×¤×¨ ×¨×›×‘">
                </div>
                <div class="form-group">
                    <label for="carManufacturer">×™×¦×¨×Ÿ:</label>
                    <input type="text" id="carManufacturer" placeholder="×™×¦×¨×Ÿ ×”×¨×›×‘">
                </div>
                <div class="form-group">
                    <label for="carModel">×“×’×:</label>
                    <input type="text" id="carModel" placeholder="×“×’× ×”×¨×›×‘">
                </div>
                <div class="form-group">
                    <label for="carYear">×©× ×ª ×™×¦×•×¨:</label>
                    <input type="number" id="carYear" placeholder="×©× ×ª ×™×¦×•×¨">
                </div>
                <div class="form-group">
                    <label for="carModelCode">×§×•×“ ×“×’×:</label>
                    <input type="text" id="carModelCode" placeholder="×§×•×“ ×“×’×">
                </div>
                <div class="form-group">
                    <label for="carMileage">×§×™×œ×•××˜×¨××–':</label>
                    <input type="number" id="carMileage" placeholder="×§×™×œ×•××˜×¨××–'">
                </div>
                <div class="form-group">
                    <label for="carBasePrice">××—×™×¨ ×‘×¡×™×¡ (â‚ª):</label>
                    <input type="number" id="carBasePrice" placeholder="××—×™×¨ ×‘×¡×™×¡">
                </div>
                <div class="form-group">
                    <label for="carMarketValue">×©×•×•×™ ×©×•×§ (â‚ª):</label>
                    <input type="number" id="carMarketValue" placeholder="×©×•×•×™ ×©×•×§">
                </div>
                <div class="form-group">
                    <label for="carReportDate">×ª××¨×™×š ×“×•×—:</label>
                    <input type="date" id="carReportDate">
                </div>
            </div>
        </div>

        <!-- Damage Centers Section -->
        <div class="section" id="damageCentersSection">
            <div class="section-header">
                <h2 class="section-title">××•×§×“×™ × ×–×§</h2>
                <button class="btn" onclick="addNewDamageCenter()">×”×•×¡×£ ××•×§×“ × ×–×§ ×—×“×©</button>
            </div>
            <div id="damageCentersContent">
                <div style="display: grid; gap: 15px;" id="editableDamageCenters">
                    <!-- Damage centers will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="section" id="summary" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">×¡×™×›×•× ×”×¢×¨×›×ª × ×–×§</h2>
            </div>
            <div id="summaryContent">
                <!-- Summary calculations will appear here -->
            </div>
        </div>

        <!-- Attachments Section -->
        <div class="section" id="attachments" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">×§×‘×¦×™× ××¦×•×¨×¤×™×</h2>
            </div>
            <div id="attachmentsContent">
                <!-- Attachments will appear here -->
            </div>
        </div>
    </div>

    <script>
    // State management
    const EstimateBuilderState = {
        hasChanges: false,
        currentHelper: null,
        damageCenters: []
    };

    // DOM Content Loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Authentication check
        const auth = sessionStorage.getItem("auth");
        if (!auth) {
            alert("×”×’×™×©×” ×—×¡×•××” - ×× × ×”×ª×—×‘×¨ ×“×¨×š ×“×£ ×”×‘×™×ª");
            window.location.href = "index.html";
        }

        // Initialize helper
        if (!window.helper || Object.keys(window.helper).length === 0) {
            window.helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        }

        // Load existing data
        loadHelperData();
        loadDamageCentersSummary(window.helper);
    });

    // Load helper data into form fields
    function loadHelperData() {
        const helper = window.helper || {};
        
        // Load car details
        if (helper.car_data) {
            const fields = {
                'carPlate': helper.car_data.license_plate,
                'carManufacturer': helper.car_data.manufacturer,
                'carModel': helper.car_data.model,
                'carYear': helper.car_data.year,
                'carModelCode': helper.car_data.model_code,
                'carMileage': helper.car_data.mileage,
                'carBasePrice': helper.car_data.base_price,
                'carMarketValue': helper.car_data.market_value,
                'carReportDate': helper.car_data.report_date
            };

            Object.keys(fields).forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element && fields[fieldId]) {
                    element.value = fields[fieldId];
                }
            });
        }
    }

// ============================================================================
// DAMAGE CENTERS FUNCTIONALITY - COMPLETE FROM FINAL-REPORT-BUILDER
// ============================================================================

// LOAD DAMAGE CENTERS SUMMARY - EDITABLE CARDS
function loadDamageCentersSummary(helper) {
  try {
    const damageCentersContent = document.getElementById('damageCentersContent');
    
    // Load from damage centers helper (primary source) with fallbacks
    // NOTE: Removed damage_assessment.centers - using only helper.centers as source of truth
    const damageCenters = helper.centers || 
                         helper.damage_centers || 
                         helper.expertise?.damage_blocks || [];
    
    if (damageCenters && damageCenters.length > 0) {
      let summaryHTML = '<div style="display: grid; gap: 15px;" id="editableDamageCenters">';
      
      damageCenters.forEach((center, index) => {
        // Adapt centers data structure to damage block structure for compatibility
        const adaptedCenter = adaptCenterToBlock(center, index);
        summaryHTML += createEditableDamageCenterCard(adaptedCenter, index);
      });
      
      summaryHTML += '</div>';
      damageCentersContent.innerHTML = summaryHTML;
      
      // Add event listeners after HTML is created
      setTimeout(addDamageCenterEventListeners, 100);
      
      // Reposition save button if subtotal exists
      setTimeout(repositionDamageCentersSaveButton, 150);
      
    } else {
      damageCentersContent.innerHTML = '<div style="color: #666; text-align: center;">×œ× × ××¦××• × ×ª×•× ×™ ××•×§×“×™ × ×–×§ - ×œ×—×¥ "×”×•×¡×£ ××•×§×“ × ×–×§ ×—×“×©" ×›×“×™ ×œ×”×ª×—×™×œ</div>';
    }
  } catch (error) {
    console.error('Error loading damage centers summary:', error);
    document.getElementById('damageCentersContent').innerHTML = '<div style="color: #dc3545; text-align: center;">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ××•×§×“×™ × ×–×§</div>';
  }
}

// Adapt centers data structure to damage block structure for compatibility
function adaptCenterToBlock(center, index) {
  
  // Centers structure (from wizard) vs damage_blocks structure (from expertise)
  const adaptedBlock = {
    damage_center_name: center.Location || center.damage_center_name || `××•×§×“ × ×–×§ ${index + 1}`,
    // Extract just the number if it contains the full text
    damage_center_number: (() => {
      const num = center["Damage center Number"] || center.damage_center_number || (index + 1);
      // If it's a string that contains "××•×§×“ × ×–×§ ××¡'", extract just the number
      if (typeof num === 'string' && num.includes('××•×§×“')) {
        const match = num.match(/\d+$/);
        return match ? match[0] : String(index + 1);
      }
      return num;
    })(),
    description: center.Description || center.description || '',
    // CORRECT MAPPING: Works data structure from helper.centers
    works: center.Works?.works || center.works || [],
    // CORRECT MAPPING: Parts data is in center.Parts.parts_required for helper.centers
    parts: center.Parts?.parts_required || center.Parts?.parts || center.parts_required || center.parts || center.Parts || [],
    // CORRECT MAPPING: Repairs data structure from helper.centers
    repairs: center.Repairs?.repairs || center.repairs || [],
    works_meta: center.Works?.works_meta || center.works_meta || { total_cost: 0 },
    parts_meta: center.Parts?.parts_meta || center.parts_meta || { total_cost: 0 },
    repairs_meta: center.Repairs?.repairs_meta || center.repairs_meta || { total_cost: 0 },
    total_cost: center.Summary?.["Total with VAT"] || center.total_cost || 0
  };
  
  // Additional normalization for different data structures
  if (Array.isArray(center.Works) && adaptedBlock.works.length === 0) {
    adaptedBlock.works = center.Works;
  }
  if (Array.isArray(center.Parts) && adaptedBlock.parts.length === 0) {
    adaptedBlock.parts = center.Parts;
  }
  if (Array.isArray(center.Repairs) && adaptedBlock.repairs.length === 0) {
    adaptedBlock.repairs = center.Repairs;
  }
  
  console.log(`âœ… Adapted block ${index}:`, adaptedBlock);
  console.log(`ğŸ“‹ Parts found: ${adaptedBlock.parts.length}, Works found: ${adaptedBlock.works.length}`);
  
  return adaptedBlock;
}

// CREATE EDITABLE DAMAGE CENTER CARD
function createEditableDamageCenterCard(block, index) {
  
  const centerNum = block.damage_center_number || (index + 1);
  const centerLocation = block.damage_center_name || block.Location || `××•×§×“ × ×–×§ ${centerNum}`;
  const workCosts = block.work_cost || 0;
  const partsCosts = block.parts_cost || 0;
  const repairsCosts = workCosts + partsCosts;
  const totalWithVAT = repairsCosts * (1 + (window.getHelperVatRate ? window.getHelperVatRate() : (typeof MathEngine !== 'undefined' && MathEngine.getVatRate ? MathEngine.getVatRate() : 18)) / 100);
  
  // Get existing parts, works, repairs from block
  const parts = block.parts || [];
  const works = block.works || [];
  const repairs = block.repairs || [];
  
  console.log(`ğŸ”§ Card ${index} data - Parts: ${parts.length}, Works: ${works.length}, Repairs: ${repairs.length}`);
  console.log(`ğŸ“‹ Parts content:`, parts);
  console.log(`ğŸ”¨ Works content:`, works);
  
  return `
    <div class="editable-damage-card" data-center-index="${index}" style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <!-- Card Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <span style="font-weight: bold; color: #1e3a8a; font-size: 16px;">××•×§×“ × ×–×§ ××¡'</span>
          <input type="text" value="${centerNum}" class="damage-center-number" style="font-weight: bold; color: #1e3a8a; font-size: 16px; border: 1px solid #ddd; padding: 8px; border-radius: 4px; width: 50px; text-align: center;" />
        </div>
        <button onclick="removeDamageCenter(${index})" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">××—×§</button>
      </div>
      
      <!-- Damage Center Location Field -->
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1e3a8a;">×©× ××•×§×“ ×”× ×–×§:</label>
        <input type="text" class="damage-center-location" style="width: 100%; border: 1px solid #ddd; padding: 8px; border-radius: 4px; font-size: 14px;" placeholder="×”×–×Ÿ ×©×/××™×–×•×¨ ××•×§×“ ×”× ×–×§ (×œ×“×•×’××”: ×¤×’×•×© ×§×“××™, ×“×œ×ª × ×”×’, ×•×›×•')" value="${centerLocation}" />
      </div>
      
      <!-- Damage Description Field -->
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1e3a8a;">×ª×™××•×¨ ×”× ×–×§:</label>
        <textarea class="damage-center-description" style="width: 100%; min-height: 60px; border: 1px solid #ddd; padding: 8px; border-radius: 4px; font-size: 14px; resize: vertical;" placeholder="×”×–×Ÿ ×ª×™××•×¨ ××¤×•×¨×˜ ×©×œ ×”× ×–×§ ×‘××•×§×“ ×–×”...">${block.description || ''}</textarea>
      </div>

      <!-- Parts Section (Full Width Row) -->
      <div style="border: 1px solid #e2e8f0; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
        <h4 style="margin: 0 0 10px 0; color: #1e3a8a;">×—×œ×§×™× × ×“×¨×©×™×:</h4>
        <div class="parts-list" data-center="${index}">
          ${parts.map((part, partIndex) => createEditablePartRow(part, index, partIndex)).join('')}
        </div>
        <button onclick="addPartRow(${index})" class="btn" style="background: #28a745; color: white; padding: 6px 12px; margin-top: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">×”×•×¡×£ ×—×œ×§</button>
      </div>

      <!-- Works Section (Full Width Row) -->
      <div style="border: 1px solid #e2e8f0; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
        <h4 style="margin: 0 0 10px 0; color: #1e3a8a;">×¢×‘×•×“×•×ª × ×“×¨×©×•×ª:</h4>
        <div class="works-list" data-center="${index}">
          ${works.map((work, workIndex) => createEditableWorkRow(work, index, workIndex)).join('')}
        </div>
        <button onclick="addWorkRow(${index})" class="btn" style="background: #17a2b8; color: white; padding: 6px 12px; margin-top: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">×”×•×¡×£ ×¢×‘×•×“×”</button>
      </div>

      <!-- Repairs Section (Full Width Row) -->
      <div style="border: 1px solid #e2e8f0; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
        <h4 style="margin: 0 0 10px 0; color: #1e3a8a;">×ª×™×§×•× ×™× × ×“×¨×©×™×:</h4>
        <div class="repairs-list" data-center="${index}">
          ${repairs.map((repair, repairIndex) => createEditableRepairRow(repair, index, repairIndex)).join('')}
        </div>
        <button onclick="addRepairRow(${index})" class="btn" style="background: #ffc107; color: #212529; padding: 6px 12px; margin-top: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">×”×•×¡×£ ×ª×™×§×•×Ÿ</button>
      </div>

      <!-- Cost Summary (Auto-calculated) -->
      <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 14px;">
          <div><strong>×¢×‘×•×“×•×ª:</strong> <span class="work-costs-display">â‚ª${workCosts.toLocaleString()}</span></div>
          <div><strong>×—×œ×¤×™×:</strong> <span class="parts-costs-display">â‚ª${partsCosts.toLocaleString()}</span></div>
          <div><strong>×ª×™×§×•× ×™×:</strong> <span class="repairs-costs-display">â‚ª${repairsCosts.toLocaleString()}</span></div>
          <div><strong>×›×•×œ×œ ××¢"×:</strong> <span class="total-with-vat-display">â‚ª${Math.round(totalWithVAT).toLocaleString()}</span></div>
        </div>
      </div>
    </div>
  `;
}

// CREATE EDITABLE PART ROW WITH SEARCH DROPDOWN
function createEditablePartRow(part, centerIndex, partIndex) {
  const partName = part?.name || '';
  const partDesc = part?.desc || part?.description || part?.×ª×™××•×¨ || '';
  const partPrice = part?.price || 0;
  const partSource = part?.source || part?.××§×•×¨ || '';
  
  return `
    <div class="part-row" data-center="${centerIndex}" data-part="${partIndex}" style="display: grid; grid-template-columns: 2fr 2fr 1fr auto; gap: 8px; margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
      <div style="position: relative;">
        <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×©× ×”×—×œ×§:</label>
        <input type="text" value="${partName}" placeholder="×©× ×”×—×œ×§" class="part-name" 
               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;"
               onkeyup="showPartSuggestions(this, ${centerIndex}, ${partIndex})" />
        <div class="part-suggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; display: none; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
      </div>
      <div>
        <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×ª×™××•×¨:</label>
        <input type="text" value="${partDesc}" placeholder="×ª×™××•×¨ ×”×—×œ×§" class="part-desc" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />
      </div>
      <div>
        <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×¢×œ×•×ª (â‚ª):</label>
        <input type="number" value="${partPrice}" placeholder="0" class="part-price" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" min="0" step="0.01" />
      </div>
      <button onclick="removePartRow(${centerIndex}, ${partIndex})" style="background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; align-self: end;">××—×§</button>
      <input type="hidden" value="${partSource}" class="part-source" />
    </div>
  `;
}

// CREATE EDITABLE WORK ROW WITH DROPDOWN
function createEditableWorkRow(work, centerIndex, workIndex) {
  const workTypes = [
    '×›×œ ×¢×‘×•×“×•×ª ×”×¤×—×—×•×ª ×›×•×œ×œ ×¤×™×¨×•×§×™× ×•×”×¨×›×‘×•×ª','×¢×‘×•×“×•×ª ×¦×‘×¢', '×¢×‘×•×“×•×ª ×—×©××œ', '×¢×‘×•×“×•×ª ××›×•× ××•×ª', 
    '×¢×‘×•×“×•×ª ××–×’×Ÿ', '×¢×‘×•×“×•×ª ×¨×™×¤×•×“', '×¢×‘×•×“×•×ª ×–×’×’×•×ª',
    '××™×˜×•× ×•×–×™×¤×•×ª', '×‘×“×™×§×ª ××ª×œ×”', '×”× ×–×§ ××—×™×™×‘ ×ª×§× ×” 309',
    '×›×™×•×œ ×¨×“××¨', '×”×¢×‘×¨×ª ×—×™×™×©× ×™×', '××—×¨'
  ];
  
  const workType = typeof work === 'object' ? (work.category || work.type) : work;
  const workNote = typeof work === 'object' ? (work.comments || work.note || '') : '';
  const workCost = typeof work === 'object' ? work.cost : 0;
  
  return `
    <div class="work-row" data-center="${centerIndex}" data-work="${workIndex}" style="display: grid; grid-template-columns: 2fr 2fr 1fr auto; gap: 8px; margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
      <div>
        <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×¡×•×’ ×¢×‘×•×“×”:</label>
        <select class="work-type" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" onchange="handleWorkTypeChange(this, ${centerIndex}, ${workIndex})">
          ${workTypes.map(type => `<option value="${type}" ${type === workType ? 'selected' : ''}>${type}</option>`).join('')}
        </select>
        <input type="text" class="work-type-other" placeholder="×”×›× ×¡ ×¡×•×’ ×¢×‘×•×“×” ××—×¨" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; margin-top: 4px; display: ${workType === '××—×¨' ? 'block' : 'none'};" />
      </div>
      <div>
        <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×”×¢×¨×•×ª:</label>
        <input type="text" value="${workNote}" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª" class="work-note" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />
      </div>
      <div>
        <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×¢×œ×•×ª (â‚ª):</label>
        <input type="number" value="${workCost}" placeholder="0" class="work-cost" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" min="0" step="0.01" />
      </div>
      <button onclick="removeWorkRow(${centerIndex}, ${workIndex})" style="background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; align-self: end;">××—×§</button>
    </div>
  `;
}

// CREATE EDITABLE REPAIR ROW
function createEditableRepairRow(repair, centerIndex, repairIndex) {
  const repairText = typeof repair === 'object' ? repair.description : repair;
  const repairCost = typeof repair === 'object' ? repair.cost : 0;
  
  return `
    <div class="repair-row" data-center="${centerIndex}" data-repair="${repairIndex}" style="display: grid; grid-template-columns: 3fr 1fr auto; gap: 8px; margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
      <div>
        <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×ª×™××•×¨ ×”×ª×™×§×•×Ÿ:</label>
        <textarea placeholder="×ª×™××•×¨ ×”×ª×™×§×•×Ÿ" class="repair-text" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; min-height: 60px; resize: vertical;">${repairText}</textarea>
      </div>
      <div>
        <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×¢×œ×•×ª (â‚ª):</label>
        <input type="number" value="${repairCost}" placeholder="0" class="repair-cost" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" min="0" step="0.01" />
      </div>
      <button onclick="removeRepairRow(${centerIndex}, ${repairIndex})" style="background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; height: 32px; margin-top: 14px;">××—×§</button>
    </div>
  `;
}

// PARTS SEARCH FUNCTIONALITY
function showPartSuggestions(input, centerIndex, partIndex) {
  const query = input.value.toLowerCase().trim();
  const suggestionsDiv = input.nextElementSibling;
  
  if (query.length < 2) {
    suggestionsDiv.style.display = 'none';
    return;
  }
  
  // Get stored search results from helper
  const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
  const storedResults = helper.parts_search?.results || [];
  
  // Filter results based on query
  const filteredResults = storedResults.filter(part => 
    part.name?.toLowerCase().includes(query) || 
    part.desc?.toLowerCase().includes(query)
  );
  
  if (filteredResults.length > 0) {
    let suggestionsHTML = '';
    filteredResults.slice(0, 10).forEach(part => {
      suggestionsHTML += `
        <div onclick="selectPartSuggestion('${part.name}', '${part.desc}', '${part.price || 0}', '${part.source || ''}', ${centerIndex}, ${partIndex})" 
             style="padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 13px;"
             onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">
          <strong>${part.name}</strong><br>
          <small style="color: #666;">${part.desc || ''} ${part.price ? '- â‚ª' + part.price : ''}</small>
        </div>
      `;
    });
    
    // Add option to search for new parts
    suggestionsHTML += `
      <div onclick="openPartsSearchModule('${query}', ${centerIndex}, ${partIndex})" 
           style="padding: 8px; cursor: pointer; background: #e3f2fd; border-top: 1px solid #ddd; font-size: 13px; color: #1976d2;"
           onmouseover="this.style.background='#bbdefb'" onmouseout="this.style.background='#e3f2fd'">
        ğŸ” ×—×¤×© ×—×œ×§×™× ×—×“×©×™× ×¢×‘×•×¨: "${query}"
      </div>
    `;
    
    suggestionsDiv.innerHTML = suggestionsHTML;
    suggestionsDiv.style.display = 'block';
  } else {
    // Show only search option if no stored results
    suggestionsDiv.innerHTML = `
      <div onclick="openPartsSearchModule('${query}', ${centerIndex}, ${partIndex})" 
           style="padding: 8px; cursor: pointer; background: #e3f2fd; font-size: 13px; color: #1976d2;"
           onmouseover="this.style.background='#bbdefb'" onmouseout="this.style.background='#e3f2fd'">
        ğŸ” ×—×¤×© ×—×œ×§×™× ×¢×‘×•×¨: "${query}"
      </div>
    `;
    suggestionsDiv.style.display = 'block';
  }
}

// SELECT PART FROM SUGGESTIONS
function selectPartSuggestion(name, desc, price, source, centerIndex, partIndex) {
  const partRow = document.querySelector(`.part-row[data-center="${centerIndex}"][data-part="${partIndex}"]`);
  if (partRow) {
    partRow.querySelector('.part-name').value = name;
    partRow.querySelector('.part-desc').value = desc;
    partRow.querySelector('.part-price').value = price;
    partRow.querySelector('.part-source').value = source;
    
    // Hide suggestions
    partRow.querySelector('.part-suggestions').style.display = 'none';
    
    // Trigger save and recalculation
    saveDamageCenterChanges();
  }
}

// OPEN PARTS SEARCH MODULE
function openPartsSearchModule(query, centerIndex, partIndex) {
  // Store the target location for the search result
  sessionStorage.setItem('partSearchTarget', JSON.stringify({
    centerIndex,
    partIndex,
    query
  }));
  
  // Open independent parts search module
  const partsSearchUrl = 'parts search.html?query=' + encodeURIComponent(query);
  window.open(partsSearchUrl, 'partsSearch', 'width=1000,height=700,scrollbars=yes,resizable=yes');
}

// ADD/REMOVE ROW FUNCTIONS
function addPartRow(centerIndex) {
  const partsList = document.querySelector(`.parts-list[data-center="${centerIndex}"]`);
  const newPartIndex = partsList.children.length;
  const newPartHTML = createEditablePartRow({}, centerIndex, newPartIndex);
  partsList.insertAdjacentHTML('beforeend', newPartHTML);
  
  // Add event listeners to new row
  setTimeout(addDamageCenterEventListeners, 50);
}

function addWorkRow(centerIndex) {
  const worksList = document.querySelector(`.works-list[data-center="${centerIndex}"]`);
  const newWorkIndex = worksList.children.length;
  const newWorkHTML = createEditableWorkRow('', centerIndex, newWorkIndex);
  worksList.insertAdjacentHTML('beforeend', newWorkHTML);
  
  // Add event listeners to new row
  setTimeout(addDamageCenterEventListeners, 50);
}

function addRepairRow(centerIndex) {
  const repairsList = document.querySelector(`.repairs-list[data-center="${centerIndex}"]`);
  const newRepairIndex = repairsList.children.length;
  const newRepairHTML = createEditableRepairRow('', centerIndex, newRepairIndex);
  repairsList.insertAdjacentHTML('beforeend', newRepairHTML);
  
  // Add event listeners to new row
  setTimeout(addDamageCenterEventListeners, 50);
}

function removePartRow(centerIndex, partIndex) {
  const partRow = document.querySelector(`.part-row[data-center="${centerIndex}"][data-part="${partIndex}"]`);
  if (partRow) {
    partRow.remove();
    saveDamageCenterChanges();
  }
}

function removeWorkRow(centerIndex, workIndex) {
  const workRow = document.querySelector(`.work-row[data-center="${centerIndex}"][data-work="${workIndex}"]`);
  if (workRow) {
    workRow.remove();
    saveDamageCenterChanges();
  }
}

function removeRepairRow(centerIndex, repairIndex) {
  const repairRow = document.querySelector(`.repair-row[data-center="${centerIndex}"][data-repair="${repairIndex}"]`);
  if (repairRow) {
    repairRow.remove();
    saveDamageCenterChanges();
  }
}

function removeDamageCenter(centerIndex) {
  if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ××•×§×“ ×”× ×–×§ ×”×–×”?')) {
    const centerCard = document.querySelector(`.editable-damage-card[data-center-index="${centerIndex}"]`);
    if (centerCard) {
      centerCard.remove();
      saveDamageCenterChanges();
    }
  }
}

function addNewDamageCenter() {
  const container = document.getElementById('editableDamageCenters');
  if (!container) {
    // If no container exists, create it
    document.getElementById('damageCentersContent').innerHTML = '<div style="display: grid; gap: 15px;" id="editableDamageCenters"></div>';
  }
  
  const newIndex = document.querySelectorAll('.editable-damage-card').length;
  const newBlock = {
    damage_center_name: `××•×§×“ × ×–×§ ${newIndex + 1}`,
    parts: [],
    works: [],
    repairs: [],
    work_cost: 0,
    parts_cost: 0
  };
  
  const newCardHTML = createEditableDamageCenterCard(newBlock, newIndex);
  document.getElementById('editableDamageCenters').insertAdjacentHTML('beforeend', newCardHTML);
  
  setTimeout(addDamageCenterEventListeners, 100);
}

// SAVE DAMAGE CENTER CHANGES TO HELPER
function saveDamageCenterChanges() {
  try {
    // ğŸ”§ 2-WAY DATA FLOW: Save back to helper.centers (the source of truth)
    const helper = window.helper || {};
    
    // Initialize centers if not exists
    if (!helper.centers) helper.centers = [];
    
    // Clean up any redundant damage_assessment.centers (duplicate section)
    if (helper.damage_assessment?.centers) {
      console.log('ğŸ§¹ Cleaning up redundant damage_assessment.centers');
      delete helper.damage_assessment.centers;
      if (Object.keys(helper.damage_assessment).length === 0) {
        delete helper.damage_assessment;
      }
    }
    
    // Also maintain expertise.damage_blocks for backward compatibility
    if (!helper.expertise) helper.expertise = {};
    if (!helper.expertise.damage_blocks) helper.expertise.damage_blocks = [];
    
    // Clear both structures
    helper.centers = [];
    helper.expertise.damage_blocks = [];
    
    // Store damage center names for depreciation section
    const damageCenterNames = [];
    
    // Collect data from all damage center cards
    document.querySelectorAll('.editable-damage-card').forEach((card, index) => {
      // Extract just the number from the damage center number field
      const centerNumberField = card.querySelector('.damage-center-number').value;
      // Extract the number (e.g., "××•×§×“ × ×–×§ ××¡' 1" -> "1")
      const numberMatch = centerNumberField.match(/\d+$/);
      const centerNumber = numberMatch ? numberMatch[0] : String(index + 1);
      const centerLocation = card.querySelector('.damage-center-location').value;
      const centerDescription = card.querySelector('.damage-center-description').value;
      
      // Collect parts
      const parts = [];
      card.querySelectorAll('.part-row').forEach(row => {
        const name = row.querySelector('.part-name').value;
        const desc = row.querySelector('.part-desc').value;
        const price = row.querySelector('.part-price').value;
        const source = row.querySelector('.part-source').value;
        
        if (name.trim()) {
          parts.push({ name, desc, price: parseFloat(price) || 0, source });
        }
      });
      
      // Collect works
      const works = [];
      card.querySelectorAll('.work-row').forEach(row => {
        let type = row.querySelector('.work-type').value;
        const note = row.querySelector('.work-note').value;
        const cost = parseFloat(row.querySelector('.work-cost').value) || 0;
        
        // If "××—×¨" is selected, get the custom text from the input
        if (type === '××—×¨') {
          const otherInput = row.querySelector('.work-type-other');
          if (otherInput && otherInput.value.trim()) {
            type = otherInput.value.trim();
          }
        }
        
        if (type) {
          works.push({ category: type, comments: note, cost });
        }
      });
      
      // Collect repairs
      const repairs = [];
      card.querySelectorAll('.repair-row').forEach(row => {
        const text = row.querySelector('.repair-text').value;
        const cost = parseFloat(row.querySelector('.repair-cost').value) || 0;
        
        if (text.trim()) {
          repairs.push({ description: text, cost });
        }
      });
      
      // Calculate costs using individual cost fields
      const partsCost = parts.reduce((sum, part) => sum + (parseFloat(part.price) || 0), 0);
      const workCost = works.reduce((sum, work) => sum + (parseFloat(work.cost) || 0), 0);
      const repairsCost = repairs.reduce((sum, repair) => sum + (parseFloat(repair.cost) || 0), 0);
      const totalCost = partsCost + workCost + repairsCost;
      
      // Create center object in helper.centers format (source of truth)
      const centerObject = {
        Id: `dc_${Date.now()}_${index + 1}`, // Generate unique ID
        "Damage center Number": centerNumber || (index + 1),
        Location: centerLocation,
        Description: centerDescription,
        Parts: {
          parts_required: parts,
          parts_meta: {
            total_items: parts.length,
            total_cost: partsCost
          }
        },
        Works: {
          works: works,
          works_meta: {
            total_items: works.length,
            total_cost: workCost
          }
        },
        Repairs: {
          repairs: repairs,
          repairs_meta: {
            total_items: repairs.length,
            total_cost: repairsCost
          }
        },
        Summary: {
          "Total with VAT": totalCost * (1 + (window.getHelperVatRate ? window.getHelperVatRate() : (typeof MathEngine !== 'undefined' && MathEngine.getVatRate ? MathEngine.getVatRate() : 18)) / 100)
        }
      };
      
      // Save to helper.centers (primary source)
      helper.centers.push(centerObject);
      
      // Also save to damage_blocks for backward compatibility
      helper.expertise.damage_blocks.push({
        damage_center_name: centerLocation,
        damage_center_number: index + 1,
        center_header: centerNumber,
        description: centerDescription,
        parts,
        works,
        repairs,
        parts_cost: partsCost,
        work_cost: workCost,
        repairs_cost: repairsCost
      });
      
      // Store damage center data for depreciation section (complete object)
      if (centerLocation.trim()) {
        damageCenterNames.push({
          name: centerLocation.trim(),
          number: centerNumber || (index + 1),
          description: centerDescription || '',
          RepairNature: '' // This will be populated from helper.centers when available
        });
      }
      
      // Update cost display for this card
      updateCostDisplay(card, partsCost, workCost, repairsCost);
    });
    
    // Save updated helper
    sessionStorage.setItem('helper', JSON.stringify(helper));
    
    // DON'T auto-update depreciation - preserve manual entries
    // updateDepreciationFromDamageCenters(damageCenterNames);
    
    // Update/recreate damage_assessment summary sections with current data
    updateDamageAssessmentSummary(helper);
    
    // Trigger floating screen refresh
    triggerFloatingScreenRefresh();
    
    console.log('Damage centers saved:', helper.expertise.damage_blocks);
    
  } catch (error) {
    console.error('Error saving damage center changes:', error);
  }
}

// ADD EVENT LISTENERS
function addDamageCenterEventListeners() {
  // Remove existing listeners by cloning elements (prevents duplicates)
  document.querySelectorAll('.damage-center-number, .damage-center-location, .damage-center-name, .damage-center-area-name, .damage-center-description, .part-name, .part-desc, .part-price, .work-type, .work-type-other, .work-note, .work-cost, .repair-text, .repair-cost').forEach(input => {
    // Check if already has listeners
    if (!input.hasAttribute('data-listeners-added')) {
      input.addEventListener('change', () => {
        saveDamageCenterChanges();
        updateAllCostDisplays();
      });
      input.addEventListener('blur', () => {
        saveDamageCenterChanges();
        updateAllCostDisplays();
      });
      input.addEventListener('input', () => {
        updateAllCostDisplays();
      });
      
      // Mark as having listeners to prevent duplicates
      input.setAttribute('data-listeners-added', 'true');
      console.log(`ğŸ“ Added event listeners to: ${input.className}`);
    }
  });
  
  // Hide suggestions when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.part-row')) {
      document.querySelectorAll('.part-suggestions').forEach(div => {
        div.style.display = 'none';
      });
    }
  });
}

// UPDATE WORK COST FROM TYPE SELECTION
function updateWorkCostFromType(selectElement, centerIndex, workIndex) {
  // REMOVED: Predefined work rates that were forcing costs
  // Work costs should be manually entered based on specific case requirements
  
  // Only trigger save and recalculation without changing cost
  saveDamageCenterChanges();
  updateAllCostDisplays();
  
  console.log(`ğŸ”§ Work type changed: ${selectElement.value} (cost remains manual)`);
}

function handleWorkTypeChange(selectElement, centerIndex, workIndex) {
  const workRow = selectElement.closest('.work-row');
  const otherInput = workRow.querySelector('.work-type-other');
  
  if (selectElement.value === '××—×¨') {
    otherInput.style.display = 'block';
    otherInput.focus();
  } else {
    otherInput.style.display = 'none';
    otherInput.value = '';
  }
  
  // Call the original function
  updateWorkCostFromType(selectElement, centerIndex, workIndex);
}

// COST CALCULATION FUNCTIONS
function calculateWorkCost(works) {
  return works.reduce((total, work) => {
    const cost = typeof work === 'object' ? (work.cost || 0) : 0;
    return total + parseFloat(cost);
  }, 0);
}

function calculateRepairsCost(repairs) {
  return repairs.reduce((total, repair) => {
    const cost = typeof repair === 'object' ? (repair.cost || 0) : 0;
    return total + parseFloat(cost);
  }, 0);
}

function calculatePartsCost(parts) {
  return parts.reduce((total, part) => {
    const cost = typeof part === 'object' ? (part.price || 0) : 0;
    return total + parseFloat(cost);
  }, 0);
}

function updateCostDisplay(card, partsCost, workCost, repairsCost) {
  const totalCost = partsCost + workCost + repairsCost;
  const totalWithVAT = totalCost * (1 + (window.getHelperVatRate ? window.getHelperVatRate() : (typeof MathEngine !== 'undefined' && MathEngine.getVatRate ? MathEngine.getVatRate() : 18)) / 100);
  
  // Update display elements
  const workDisplay = card.querySelector('.work-costs-display');
  const partsDisplay = card.querySelector('.parts-costs-display');
  const repairsDisplay = card.querySelector('.repairs-costs-display');
  const totalDisplay = card.querySelector('.total-with-vat-display');
  
  if (workDisplay) {
    workDisplay.textContent = `â‚ª${workCost.toLocaleString()}`;
    console.log(`ğŸ’¼ Work costs updated: â‚ª${workCost.toLocaleString()}`);
  }
  if (partsDisplay) {
    partsDisplay.textContent = `â‚ª${partsCost.toLocaleString()}`;
    console.log(`ğŸ”§ Parts costs updated: â‚ª${partsCost.toLocaleString()}`);
  }
  if (repairsDisplay) {
    repairsDisplay.textContent = `â‚ª${repairsCost.toLocaleString()}`;
    console.log(`ğŸ”¨ Repairs costs updated (ONLY repairs): â‚ª${repairsCost.toLocaleString()}`);
  }
  if (totalDisplay) {
    totalDisplay.textContent = `â‚ª${Math.round(totalWithVAT).toLocaleString()}`;
    console.log(`ğŸ’° Total with VAT updated: â‚ª${Math.round(totalWithVAT).toLocaleString()}`);
  }
}

function updateAllCostDisplays() {
  document.querySelectorAll('.editable-damage-card').forEach(card => {
    // Recalculate costs for this card using individual cost fields
    let partsCost = 0;
    card.querySelectorAll('.part-row').forEach(row => {
      const price = parseFloat(row.querySelector('.part-price').value) || 0;
      partsCost += price;
    });
    
    let workCost = 0;
    card.querySelectorAll('.work-row').forEach(row => {
      const cost = parseFloat(row.querySelector('.work-cost').value) || 0;
      workCost += cost;
    });
    
    let repairsCost = 0;
    card.querySelectorAll('.repair-row').forEach(row => {
      const cost = parseFloat(row.querySelector('.repair-cost').value) || 0;
      repairsCost += cost;
    });
    
    updateCostDisplay(card, partsCost, workCost, repairsCost);
  });
  
  // Update summary section totals
  updateSummaryTotalsFromDamageCenters();
  
  // Update damage centers subtotal
  updateDamageCentersSubtotal();
}

function updateSummaryTotalsFromDamageCenters() {
  let totalClaimBeforeVAT = 0;
  
  document.querySelectorAll('.editable-damage-card').forEach(card => {
    // Calculate total cost for each damage center (parts + works + repairs)
    let partsCost = 0;
    card.querySelectorAll('.part-row').forEach(row => {
      const price = parseFloat(row.querySelector('.part-price').value) || 0;
      partsCost += price;
    });
    
    let workCost = 0;
    card.querySelectorAll('.work-row').forEach(row => {
      const cost = parseFloat(row.querySelector('.work-cost').value) || 0;
      workCost += cost;
    });
    
    let repairsCost = 0;
    card.querySelectorAll('.repair-row').forEach(row => {
      const cost = parseFloat(row.querySelector('.repair-cost').value) || 0;
      repairsCost += cost;
    });
    
    totalClaimBeforeVAT += partsCost + workCost + repairsCost;
  });
  
  // Calculate total claim with VAT (admin configured rate)
  const totalClaimWithVAT = Math.round(totalClaimBeforeVAT * (1 + (window.getHelperVatRate ? window.getHelperVatRate() : (typeof MathEngine !== 'undefined' && MathEngine.getVatRate ? MathEngine.getVatRate() : 18)) / 100));
  
  // Update summary fields
  const sumClaimField = document.getElementById('sumClaim');
  const totalClaimField = document.getElementById('totalClaim');
  
  if (totalClaimWithVAT > 0) {
    const formattedAmount = `â‚ª${totalClaimWithVAT.toLocaleString()}`;
    
    // Update both summary claim and total claim fields WITH VAT
    if (sumClaimField) {
      sumClaimField.value = formattedAmount;
    }
    // Update main total claim field (div element)
    if (totalClaimField && totalClaimField.tagName === 'DIV') {
      totalClaimField.innerText = formattedAmount;
    } else if (totalClaimField) {
      totalClaimField.value = formattedAmount;
    }
    
    console.log(`ğŸ’° Updated total claim with VAT: ${totalClaimBeforeVAT.toLocaleString()} â†’ ${totalClaimWithVAT.toLocaleString()}`);
    
    // SAFE SUMMARY UPDATE: Update helper directly instead of triggering events that cascade
    setTimeout(() => {
      if (sumClaimField) {
        // Update helper directly without triggering event cascade that overrides calculations
        const helper = window.helper || JSON.parse(sessionStorage.getItem('helper') || '{}');
        helper.final_report = helper.final_report || {};
        helper.final_report.summary = helper.final_report.summary || {};
        helper.final_report.summary.total_claim = formattedAmount;
        sessionStorage.setItem('helper', JSON.stringify(helper));
        console.log('ğŸ”’ SAFE UPDATE: Updated total_claim in helper without triggering calculation overrides');
      }
    }, 100);
    
    // New bulk system will handle gross calculations when total claim changes
  }
}

function updateDamageCentersSubtotal() {
  let totalWorks = 0;
  let totalParts = 0;
  let totalRepairs = 0;
  
  // Calculate totals from all damage center cards
  document.querySelectorAll('.editable-damage-card').forEach(card => {
    // Sum parts costs
    card.querySelectorAll('.part-row').forEach(row => {
      const price = parseFloat(row.querySelector('.part-price').value) || 0;
      totalParts += price;
    });
    
    // Sum work costs
    card.querySelectorAll('.work-row').forEach(row => {
      const cost = parseFloat(row.querySelector('.work-cost').value) || 0;
      totalWorks += cost;
    });
    
    // Sum repair costs
    card.querySelectorAll('.repair-row').forEach(row => {
      const cost = parseFloat(row.querySelector('.repair-cost').value) || 0;
      totalRepairs += cost;
    });
  });
  
  let rawTotalWithoutVat = totalWorks + totalParts + totalRepairs;
  let rawTotalWithVat = rawTotalWithoutVat * (1 + (window.getHelperVatRate ? window.getHelperVatRate() : (typeof MathEngine !== 'undefined' && MathEngine.getVatRate ? MathEngine.getVatRate() : 18)) / 100);
  
  // Calculate category-specific differentials
  let finalTotalWorks = totalWorks;
  let finalTotalParts = totalParts;
  let finalTotalRepairs = totalRepairs;
  let finalTotalWithoutVat = rawTotalWithoutVat;
  let finalTotalWithVat = rawTotalWithVat;
  
  const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
  if (helper.final_report?.differential?.has_differentials && helper.final_report?.differential?.items) {
    const differentialItems = helper.final_report.differential.items;
    
    // Calculate category-specific differential totals
    let worksDiff = 0, partsDiff = 0, repairsDiff = 0, otherDiff = 0;
    let worksDiffWithVat = 0, partsDiffWithVat = 0, repairsDiffWithVat = 0, otherDiffWithVat = 0;
    
    differentialItems.forEach(item => {
      const amount = item.amount_without_vat || 0;
      const amountWithVat = item.amount_with_vat || 0;
      
      switch(item.nature) {
        case 'works':
          worksDiff += amount;
          worksDiffWithVat += amountWithVat;
          break;
        case 'parts':
          partsDiff += amount;
          partsDiffWithVat += amountWithVat;
          break;
        case 'repairs':
          repairsDiff += amount;
          repairsDiffWithVat += amountWithVat;
          break;
        default:
          otherDiff += amount;
          otherDiffWithVat += amountWithVat;
          break;
      }
    });
    
    // Apply category-specific differentials
    finalTotalWorks = Math.max(0, totalWorks - worksDiff);
    finalTotalParts = Math.max(0, totalParts - partsDiff);
    finalTotalRepairs = Math.max(0, totalRepairs - repairsDiff);
    
    // Recalculate totals with category-specific deductions
    const finalRawTotal = finalTotalWorks + finalTotalParts + finalTotalRepairs;
    finalTotalWithoutVat = finalRawTotal - otherDiff; // Other differentials affect overall total
    
    // Apply VAT to the final amount (after subtracting "other" differentials without VAT)
    const vatRate = window.getHelperVatRate ? window.getHelperVatRate() : (typeof MathEngine !== 'undefined' && MathEngine.getVatRate ? MathEngine.getVatRate() : 18);
    finalTotalWithVat = finalTotalWithoutVat * (1 + vatRate / 100);
    
    console.log('ğŸ“‰ Applying category-specific differentials:', {
      worksDiff, partsDiff, repairsDiff, otherDiff,
      finalTotalWorks, finalTotalParts, finalTotalRepairs,
      finalTotalWithoutVat, finalTotalWithVat
    });
  }
  
  // Update subtotal display elements with final calculated values
  const subtotalElement = document.getElementById('damageCentersSubtotal');
  if (subtotalElement) {
    subtotalElement.innerHTML = `
      <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0; margin-top: 15px;">
        <h4 style="margin: 0 0 10px 0; color: #1e3a8a; text-align: center;">×¡×™×›×•× ××•×§×“×™ × ×–×§</h4>
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; font-size: 14px; text-align: center;">
          <div><strong>×¢×‘×•×“×•×ª:</strong><br>â‚ª${Math.round(finalTotalWorks).toLocaleString()}</div>
          <div><strong>×—×œ×§×™×:</strong><br>â‚ª${Math.round(finalTotalParts).toLocaleString()}</div>
          <div><strong>×ª×™×§×•× ×™×:</strong><br>â‚ª${Math.round(finalTotalRepairs).toLocaleString()}</div>
          <div><strong>×œ×œ× ××¢"×:</strong><br>â‚ª${Math.round(finalTotalWithoutVat).toLocaleString()}</div>
          <div style="background: #e3f2fd; padding: 8px; border-radius: 4px;"><strong>×›×•×œ×œ ××¢"×:</strong><br>â‚ª${Math.round(finalTotalWithVat).toLocaleString()}</div>
        </div>
      </div>
    `;
  }
}

function repositionDamageCentersSaveButton() {
  try {
    const damageCentersSection = document.getElementById('damageCentersSummary');
    const saveButton = damageCentersSection?.querySelector('.section-save-button');
    const subtotal = damageCentersSection?.querySelector('#damageCentersSubtotal');
    
    if (saveButton && subtotal) {
      const buttonContainer = saveButton.parentElement;
      // Move button container to before the subtotal
      subtotal.parentNode.insertBefore(buttonContainer, subtotal);
      console.log('âœ… Repositioned damage centers save button before summary');
    }
  } catch (error) {
    console.error('Error repositioning damage centers save button:', error);
  }
}

// Helper functions for integration with other systems
function updateDamageAssessmentSummary(helper) {
  try {
    // Calculate current totals from helper.centers
    let totalWorks = 0;
    let totalParts = 0; 
    let totalRepairs = 0;
    let totalCenters = 0;
    
    if (helper.centers && helper.centers.length > 0) {
      totalCenters = helper.centers.length;
      
      helper.centers.forEach(center => {
        // Add works costs
        if (center.Works?.works) {
          totalWorks += center.Works.works.reduce((sum, work) => sum + (work.cost || 0), 0);
        }
        
        // Add parts costs
        if (center.Parts?.parts_required) {
          totalParts += center.Parts.parts_required.reduce((sum, part) => sum + (part.price || 0), 0);
        }
        
        // Add repairs costs
        if (center.Repairs?.repairs) {
          totalRepairs += center.Repairs.repairs.reduce((sum, repair) => sum + (repair.cost || 0), 0);
        }
      });
    }
    
    // Update damage_assessment summary structure in helper
    if (!helper.damage_assessment) helper.damage_assessment = {};
    helper.damage_assessment.summary = {
      total_centers: totalCenters,
      total_works_cost: totalWorks,
      total_parts_cost: totalParts,
      total_repairs_cost: totalRepairs,
      total_cost_without_vat: totalWorks + totalParts + totalRepairs,
      total_cost_with_vat: Math.round((totalWorks + totalParts + totalRepairs) * (1 + (window.getHelperVatRate ? window.getHelperVatRate() : 18) / 100))
    };
    
    console.log('ğŸ“Š Updated damage assessment summary:', helper.damage_assessment.summary);
    
  } catch (error) {
    console.error('Error updating damage assessment summary:', error);
  }
}

// Helper function for floating screen refresh (placeholder - needs actual implementation)
function triggerFloatingScreenRefresh() {
  try {
    console.log('ğŸ”„ Triggering floating screen refresh after helper update');
    
    // Update helper with current damage centers calculations
    const helper = window.helper || {};
    
    // Ensure calculations structure exists
    helper.calculations = helper.calculations || {};
    helper.expertise = helper.expertise || {};
    
    // Save updated helper
    sessionStorage.setItem('helper', JSON.stringify(helper));
    
    // Trigger any external refresh functions if they exist
    if (typeof window.refreshLeviData === 'function') {
      window.refreshLeviData();
    }
    if (typeof window.refreshCarData === 'function') {
      window.refreshCarData();
    }
    if (typeof window.refreshInvoiceData === 'function') {
      window.refreshInvoiceData();
    }
    if (typeof window.refreshPartsResults === 'function') {
      window.refreshPartsResults();
    }
    
  } catch (error) {
    console.error('Error triggering floating screen refresh:', error);
  }
}

// ============================================================================
// GLOBAL WINDOW EXPORTS - Make functions available globally
// ============================================================================
window.loadDamageCentersSummary = loadDamageCentersSummary;
window.createEditableDamageCenterCard = createEditableDamageCenterCard;
window.createEditablePartRow = createEditablePartRow;
window.createEditableWorkRow = createEditableWorkRow;
window.createEditableRepairRow = createEditableRepairRow;
window.showPartSuggestions = showPartSuggestions;
window.selectPartSuggestion = selectPartSuggestion;
window.openPartsSearchModule = openPartsSearchModule;
window.addPartRow = addPartRow;
window.addWorkRow = addWorkRow;
window.addRepairRow = addRepairRow;
window.removePartRow = removePartRow;
window.removeWorkRow = removeWorkRow;
window.removeRepairRow = removeRepairRow;
window.removeDamageCenter = removeDamageCenter;
window.addNewDamageCenter = addNewDamageCenter;
window.saveDamageCenterChanges = saveDamageCenterChanges;
window.addDamageCenterEventListeners = addDamageCenterEventListeners;
window.updateWorkCostFromType = updateWorkCostFromType;
window.handleWorkTypeChange = handleWorkTypeChange;
window.calculateWorkCost = calculateWorkCost;
window.calculateRepairsCost = calculateRepairsCost;
window.calculatePartsCost = calculatePartsCost;
window.updateCostDisplay = updateCostDisplay;
window.updateAllCostDisplays = updateAllCostDisplays;
window.updateSummaryTotalsFromDamageCenters = updateSummaryTotalsFromDamageCenters;
window.updateDamageCentersSubtotal = updateDamageCentersSubtotal;
window.repositionDamageCentersSaveButton = repositionDamageCentersSaveButton;
window.updateDamageAssessmentSummary = updateDamageAssessmentSummary;
window.triggerFloatingScreenRefresh = triggerFloatingScreenRefresh;
window.adaptCenterToBlock = adaptCenterToBlock;

// ============================================================================
// END OF DAMAGE CENTERS FUNCTIONALITY
// ============================================================================

    // Toggle section visibility
    function toggleSection(sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
            const isVisible = section.style.display !== 'none';
            section.style.display = isVisible ? 'none' : 'block';
        }
    }

    // Custom browser menu
    function showBrowserMenuUnderToggle() {
        const menu = document.createElement('div');
        menu.style.cssText = `
            position: fixed;
            top: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            z-index: 99999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-family: sans-serif;
            direction: rtl;
            min-width: 280px;
        `;
        
        menu.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 15px; color: #2c3e50; font-size: 16px;">×‘×—×¨ ××ª×¨ ×œ×¤×ª×™×—×”:</div>
            <button onclick="window.openInternalBrowser('car-part.co.il'); this.parentElement.remove();" style="width: 100%; padding: 12px; margin-bottom: 8px; border: none; background: #28a745; color: white; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 500;">
                ğŸ”§ Car Part - ×—×œ×§×™ ×¨×›×‘
            </button>
            <button onclick="window.openInternalBrowser('portal.levi-itzhak.co.il'); this.parentElement.remove();" style="width: 100%; padding: 12px; margin-bottom: 8px; border: none; background: #007bff; color: white; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 500;">
                ğŸ“Š ×¤×•×¨×˜×œ ×œ×•×™ ×™×¦×—×§
            </button>
            <button onclick="this.parentElement.remove();" style="width: 100%; padding: 10px; border: 1px solid #ccc; background: white; color: #666; border-radius: 6px; cursor: pointer; font-size: 14px;">
                ×‘×™×˜×•×œ
            </button>
        `;
        
        document.body.appendChild(menu);
        
        // Remove menu when clicking outside
        setTimeout(() => {
            document.addEventListener('click', function removeMenu(e) {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', removeMenu);
                }
            });
        }, 100);
    }

    // Save to helper (placeholder)
    function saveToHelper() {
        // Implementation will be added
        alert('×”× ×ª×•× ×™× × ×©××¨×• ×‘×”×¦×œ×—×”');
    }

    </script>
</body>
</html>