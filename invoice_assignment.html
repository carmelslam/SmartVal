<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>×©×™×•×š ×¤×¨×™×˜×™ ×—×©×‘×•× ×™×ª ×œ××•×§×“×™ × ×–×§ - ×™×¨×•×Ÿ ×›×™×•×£</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" type="image/webp">
  <style>
    /* SESSION 86: Modern Mobile-First Design */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 20px 10px;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 20px;
      text-align: center;
    }

    .logo {
      width: 80px;
      height: 80px;
      margin: 0 auto 15px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo img {
      width: 60px;
      height: auto;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .header p {
      font-size: 16px;
      opacity: 0.9;
    }

    .content {
      padding: 30px 20px;
    }

    .section {
      margin-bottom: 30px;
    }

    .section-title {
      font-size: 22px;
      font-weight: 600;
      color: #667eea;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title .icon {
      font-size: 24px;
    }

    /* Loading and Status States */
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-message {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .success-message {
      background: #efe;
      border: 1px solid #cfc;
      color: #3c3;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }

    /* Invoice Section */
    .invoice-group {
      background: #f9f9f9;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid #667eea;
    }

    .invoice-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .invoice-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    .invoice-meta {
      font-size: 14px;
      color: #666;
    }

    /* Category Tables */
    .category-section {
      margin-bottom: 25px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .category-section:last-child {
      margin-bottom: 0;
    }

    .category-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 15px;
      border-radius: 8px 8px 0 0;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 16px;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
    }

    /* Category-specific colors */
    .category-section[data-category="part"] .category-header {
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
    }

    .category-section[data-category="work"] .category-header {
      background: linear-gradient(135deg, #fb7185 0%, #e11d48 100%);
    }

    .category-section[data-category="repair"] .category-header {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    }

    .category-section[data-category="other"] .category-header {
      background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
    }

    .category-count {
      background: rgba(255,255,255,0.2);
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
    }

    .items-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 0 0 8px 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .items-table th,
    .items-table td {
      padding: 12px;
      text-align: right;
      border-bottom: 1px solid #eee;
    }

    .items-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #555;
      font-size: 14px;
      border-bottom: 2px solid #e9ecef;
    }

    .items-table td {
      font-size: 14px;
    }

    .items-table tr:hover {
      background: #f8f9ff;
    }

    .items-table tr.assigned {
      background: #e8f5e9;
      border-right: 3px solid #4caf50;
    }

    /* Form Controls */
    .dc-selector {
      width: 100%;
      padding: 8px 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      transition: border-color 0.3s;
    }

    .dc-selector:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .dc-selector:disabled {
      background: #e8f4f8;
      color: #1976d2;
      font-weight: 600;
      border-color: #90caf9;
      cursor: not-allowed;
      opacity: 1; /* Override default disabled opacity */
    }

    /* Action Buttons */
    .btn {
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
      text-align: center;
      white-space: nowrap;
    }

    .btn-assign {
      background: #4caf50;
      color: white;
    }

    .btn-assign:hover {
      background: #45a049;
      transform: translateY(-1px);
    }

    .btn-unassign {
      background: #f44336;
      color: white;
    }

    .btn-unassign:hover {
      background: #da190b;
      transform: translateY(-1px);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    /* Summary Panel */
    .summary-panel {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      padding: 25px;
      position: sticky;
      top: 20px;
    }

    .summary-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      text-align: center;
    }

    .summary-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 25px;
    }

    .stat-item {
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-label {
      font-size: 12px;
      opacity: 0.8;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
    }

    .center-summary {
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }

    .center-summary h4 {
      margin-bottom: 10px;
      font-size: 16px;
    }

    .center-summary ul {
      list-style: none;
      padding: 0;
    }

    .center-summary li {
      padding: 3px 0;
      font-size: 14px;
      opacity: 0.9;
    }

    .center-total {
      font-weight: 600;
      margin-top: 10px;
      text-align: center;
      font-size: 16px;
    }

    /* Primary Action Button */
    .primary-btn {
      background: #4caf50;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
      cursor: pointer;
      transition: all 0.3s;
    }

    .primary-btn:hover {
      background: #45a049;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
    }

    .primary-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .secondary-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .secondary-btn:hover {
      background: #5a6268;
      transform: translateY(-1px);
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .container {
        margin: 0;
        border-radius: 0;
      }

      .header {
        padding: 20px 15px;
      }

      .header h1 {
        font-size: 24px;
      }

      .content {
        padding: 20px 15px;
      }

      .invoice-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .items-table {
        font-size: 12px;
      }

      .items-table th,
      .items-table td {
        padding: 8px 6px;
      }

      .category-header {
        font-size: 14px;
        padding: 10px 12px;
      }

      .category-count {
        font-size: 11px;
      }

      /* Better mobile table handling */
      .items-table {
        overflow-x: auto;
        display: block;
        white-space: nowrap;
        min-width: 800px;
      }

      .items-table thead,
      .items-table tbody,
      .items-table tr {
        display: table;
        width: 100%;
        table-layout: fixed;
      }

      /* Mobile: Better table handling */
      @media (max-width: 768px) {
        .items-table {
          min-width: 700px;
          font-size: 11px;
        }
        
        .items-table th,
        .items-table td {
          padding: 6px 4px;
        }
        
        .dc-selector {
          font-size: 11px;
          padding: 4px 6px;
        }
        
        .btn {
          font-size: 11px;
          padding: 4px 8px;
        }
      }
      
      @media (max-width: 480px) {
        .items-table th:first-child,
        .items-table td:first-child {
          display: none;
        }
        
        .items-table {
          min-width: 600px;
        }
        
        .category-header {
          font-size: 13px;
          padding: 8px 10px;
        }
      }

      .dc-selector {
        font-size: 12px;
        padding: 6px 8px;
      }

      .btn {
        font-size: 12px;
        padding: 6px 12px;
      }

      .summary-stats {
        grid-template-columns: 1fr;
      }

      .summary-panel {
        position: static;
        margin-top: 20px;
      }
    }

    /* Large Screen Layout */
    @media (min-width: 1200px) {
      .content {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 30px;
        align-items: start;
      }

      .invoices-section {
        grid-column: 1;
      }

      .summary-section {
        grid-column: 2;
      }
    }

    /* No Results State */
    .no-results {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .no-results .icon {
      font-size: 48px;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    /* Currency formatting */
    .currency {
      font-weight: 600;
      color: #2e7d32;
      direction: ltr;
      text-align: left;
    }

    /* Table improvements */
    .items-table tbody tr:hover {
      background: #f8f9ff !important;
      transition: background 0.2s ease;
    }

    .items-table tbody tr.assigned:hover {
      background: #e8f5e9 !important;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .empty-state .icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.3;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="logo">
        <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="×œ×•×’×•">
      </div>
      <h1>×™×¨×•×Ÿ ×›×™×•×£ - ×©×××•×ª ×•×™×™×¢×•×¥</h1>
      <p>×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</p>
      <h2 style="font-size: 20px; margin-top: 15px; color: rgba(255,255,255,0.9);">×©×™×•×š ×¤×¨×™×˜×™ ×—×©×‘×•× ×™×ª ×œ××•×§×“×™ × ×–×§</h2>
    </div>

    <div class="content">
      <!-- Main Content Area -->
      <div class="invoices-section">
        <!-- Loading State -->
        <div id="loading-state" class="loading">
          <div class="spinner"></div>
          <p>×˜×•×¢×Ÿ × ×ª×•× ×™ ×—×©×‘×•× ×™×•×ª...</p>
        </div>

        <!-- Error State -->
        <div id="error-state" class="error-message" style="display: none;">
          <strong>×©×’×™××”:</strong> <span id="error-message"></span>
        </div>

        <!-- Success Messages -->
        <div id="success-state" class="success-message" style="display: none;">
          <span id="success-message"></span>
        </div>

        <!-- Assignment Status Messages -->
        <div id="assignment-status-section" style="display: none;">
          <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 10px 0; color: #1976d2; font-size: 16px;">ğŸ“‹ ×¡×˜×˜×•×¡ ×©×™×•×š ×—×©×‘×•× ×™×•×ª</h3>
            <div id="assignment-status-content">
              <!-- Dynamic content will be inserted here -->
            </div>
          </div>
        </div>

        <!-- No Results State -->
        <div id="no-results-state" class="no-results" style="display: none;">
          <div class="icon">ğŸ“„</div>
          <h3>×œ× × ××¦××• ×—×©×‘×•× ×™×•×ª</h3>
          <p>×œ× × ××¦××• ×—×©×‘×•× ×™×•×ª ×¢×‘×•×¨ ×ª×™×§ ×–×”. ×× × ×”×¢×œ×” ×—×©×‘×•× ×™×•×ª ×ª×—×™×œ×”.</p>
        </div>

        <!-- Invoices Content -->
        <div id="invoices-content" style="display: none;">
          <!-- Dynamic content will be inserted here -->
        </div>
      </div>

      <!-- Summary Panel -->
      <div class="summary-section">
        <div class="summary-panel">
          <div class="summary-title">×¡×™×›×•× ×©×™×•×›×™×</div>
          
          <div class="summary-stats">
            <div class="stat-item">
              <div class="stat-label">×¡×”"×› ×©×™×•×›×™×</div>
              <div class="stat-value" id="total-assignments">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">×¡×”"×› ×¢×œ×•×ª</div>
              <div class="stat-value" id="total-cost">â‚ª0</div>
            </div>
          </div>

          <div id="assignments-by-center">
            <div class="empty-state">
              <div class="icon">ğŸ“‹</div>
              <p>×˜×¨× ×‘×•×¦×¢×• ×©×™×•×›×™×</p>
            </div>
          </div>

          <div style="display: flex; flex-direction: column; gap: 10px;">
            <!-- Split into Save and Redirect buttons -->
            <button id="save-assignments-btn" class="primary-btn" disabled>
              ğŸ’¾ ×©××•×¨ ×©×™×•×›×™×
            </button>

            <button id="continue-to-report-btn" class="secondary-btn">
              â¡ï¸ ×”××©×š ×œ×“×•×— ×¡×•×¤×™
            </button>

            <div style="display: flex; gap: 10px;">
              <button id="back-to-invoices-btn" class="secondary-btn" style="flex: 1;">
                ğŸ”™ ×—×–×•×¨ ×œ×—×©×‘×•× ×™×•×ª
              </button>
              <button id="back-to-home-btn" class="secondary-btn" style="flex: 1;">
                ğŸ  ×—×–×•×¨ ×œ×‘×™×ª
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SESSION 86: Add footer with business branding -->
  <div class="footer" style="text-align: center; font-size: 12px; margin-top: 20px; color: #95a5a6; padding: 20px;">
    @2025 Carmel Cayouf. All rights reserved. SmartVal Pro System by Evalix Â©
  </div>

  <!-- SESSION 86: Load helper.js first, then Supabase -->
  <script src="helper.js"></script>
  <script type="module">
    // Import Supabase client and expose globally for non-module code
    import { supabase } from './lib/supabaseClient.js';
    window.supabase = supabase;
    console.log('âœ… SESSION 86: Supabase client loaded and exposed globally');
  </script>
  <script>
    // SESSION 86: Global State Management
    let currentCase = null;
    let invoiceLines = [];
    let damageCenters = [];
    let existingAssignments = new Map();
    let assignmentStats = {
      totalAssignments: 0,
      totalCost: 0,
      byCenter: {}
    };

    // SESSION 86: Initialize on page load with delay for Supabase
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('ğŸš€ SESSION 86: Invoice Assignment UI Starting...');
      
      // Wait for Supabase to be loaded
      let attempts = 0;
      while (!window.supabase && attempts < 10) {
        console.log('â³ Waiting for Supabase client...');
        await new Promise(resolve => setTimeout(resolve, 200));
        attempts++;
      }
      
      if (!window.supabase) {
        showError('×©×’×™××”: ×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××ª ××¢×¨×›×ª ×”× ×ª×•× ×™×');
        return;
      }
      
      console.log('âœ… SESSION 86: Supabase client ready, initializing...');
      await initializeAssignmentUI();
    });

    /**
     * SESSION 86: Initialize the assignment UI
     */
    async function initializeAssignmentUI() {
      try {
        showLoading('×˜×•×¢×Ÿ × ×ª×•× ×™×...');

        // Get current case from helper or URL params
        currentCase = await getCurrentCase();
        if (!currentCase) {
          showError('×œ× × ××¦× ×ª×™×§ ×¤×¢×™×œ. ×× × ×‘×—×¨ ×ª×™×§ ×ª×—×™×œ×”.');
          return;
        }

        console.log('ğŸ“‹ SESSION 86: Current case:', currentCase);

        // Load damage centers
        damageCenters = await loadDamageCenters(currentCase.id);
        if (!damageCenters || damageCenters.length === 0) {
          showError('×œ× × ××¦××• ××•×§×“×™ × ×–×§. × × ×œ×™×¦×•×¨ ××•×§×“×™ × ×–×§ ×ª×—×™×œ×”.');
          return;
        }

        console.log('ğŸ¯ SESSION 86: Loaded damage centers:', damageCenters.length);

        // Load invoice lines for this case only
        invoiceLines = await loadInvoiceLinesForCase(currentCase.id);
        if (!invoiceLines || invoiceLines.length === 0) {
          showNoResults();
          return;
        }

        console.log('ğŸ“„ SESSION 86: Loaded invoice lines:', invoiceLines.length);

        // Load existing assignments
        existingAssignments = await loadExistingAssignments(currentCase.id);
        console.log('ğŸ”— SESSION 86: Existing assignments:', existingAssignments.size);

        // Initialize helper.final_report if needed
        initializeFinalReportHelper();

        // Render the UI
        renderInvoicesContent();
        updateSummaryPanel();
        attachEventListeners();

        hideLoading();
        showContent();

      } catch (error) {
        console.error('âŒ SESSION 86: Initialization failed:', error);
        showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×: ' + error.message);
      }
    }

    /**
     * SESSION 86: Get current case from helper or URL
     */
    async function getCurrentCase() {
      console.log('ğŸ” SESSION 86: Getting current case...');
      
      // Try to get from helper first
      console.log('ğŸ“‹ SESSION 86: Checking window.helper:', !!window.helper);
      if (window.helper) {
        console.log('ğŸ“‹ SESSION 86: Helper data:', {
          plate: window.helper.plate,
          case_id: window.helper.case_id,
          case_info: window.helper.case_info,
          vehicle: window.helper.vehicle,
          meta: window.helper.meta
        });
        
        // SESSION 86 FIX: Get plate from multiple possible locations
        const plate = window.helper.plate || 
                     window.helper.vehicle?.plate || 
                     window.helper.meta?.plate ||
                     window.helper.case_info?.plate;
        
        const caseId = window.helper.case_info?.supabase_case_id || 
                      window.helper.case_id;
        
        if (caseId && plate) {
          const caseData = {
            id: caseId,
            plate: plate,
            owner: window.helper.owner || window.helper.case_info?.owner || ''
          };
          console.log('âœ… SESSION 86: Using helper case data:', caseData);
          return caseData;
        } else if (caseId) {
          // Even if no plate, try with case ID only
          const caseData = {
            id: caseId,
            plate: 'unknown',
            owner: window.helper.owner || window.helper.case_info?.owner || ''
          };
          console.log('âš ï¸ SESSION 86: Using helper case data without plate:', caseData);
          return caseData;
        }
      }

      // Try URL parameters
      console.log('ğŸ”— SESSION 86: Checking URL parameters...');
      const urlParams = new URLSearchParams(window.location.search);
      const caseId = urlParams.get('case_id');
      const plate = urlParams.get('plate');
      
      if (caseId && plate) {
        const urlData = { id: caseId, plate: plate, owner: '' };
        console.log('âœ… SESSION 86: Using URL case data:', urlData);
        return urlData;
      }

      // Try session storage
      console.log('ğŸ’¾ SESSION 86: Checking session storage...');
      const stored = sessionStorage.getItem('currentCase');
      if (stored) {
        try {
          const sessionData = JSON.parse(stored);
          console.log('âœ… SESSION 86: Using session case data:', sessionData);
          return sessionData;
        } catch (e) {
          console.error('âŒ SESSION 86: Failed to parse session case data:', e);
        }
      }

      // Try helper from session storage
      console.log('ğŸ’¾ SESSION 86: Checking helper in session storage...');
      const helperStored = sessionStorage.getItem('helper');
      if (helperStored) {
        try {
          const helper = JSON.parse(helperStored);
          console.log('ğŸ’¾ SESSION 86: Session helper data:', {
            plate: helper.plate,
            case_id: helper.case_id,
            case_info: helper.case_info,
            vehicle: helper.vehicle,
            meta: helper.meta
          });
          
          // SESSION 86 FIX: Get plate from multiple possible locations
          const plate = helper.plate || 
                       helper.vehicle?.plate || 
                       helper.meta?.plate ||
                       helper.case_info?.plate;
          
          const caseId = helper.case_info?.supabase_case_id || 
                        helper.case_id;
          
          if (caseId && plate) {
            const helperData = {
              id: caseId,
              plate: plate,
              owner: helper.owner || helper.case_info?.owner || ''
            };
            console.log('âœ… SESSION 86: Using session helper case data:', helperData);
            return helperData;
          } else if (caseId) {
            // Even if no plate, try with case ID only
            const helperData = {
              id: caseId,
              plate: 'unknown',
              owner: helper.owner || helper.case_info?.owner || ''
            };
            console.log('âš ï¸ SESSION 86: Using session helper case data without plate:', helperData);
            return helperData;
          }
        } catch (e) {
          console.error('âŒ SESSION 86: Failed to parse session helper:', e);
        }
      }

      console.log('âŒ SESSION 86: No case data found anywhere');
      return null;
    }

    /**
     * SESSION 86: Load damage centers from helper
     */
    async function loadDamageCenters(caseId) {
      // Primary: Load from helper.centers (the ultimate source of truth)
      if (window.helper && window.helper.centers) {
        return window.helper.centers;
      }

      // Fallback: Load from helper.damage_centers
      if (window.helper && window.helper.damage_centers) {
        return window.helper.damage_centers;
      }

      // Last resort: Create dummy center for testing
      return [{
        Id: 'dc_1',
        'Damage center Number': '1',
        Location: '××•×§×“ × ×–×§ ×›×œ×œ×™',
        Description: '××•×§×“ × ×–×§ ×¨××©×™'
      }];
    }

    /**
     * SESSION 86: Load invoice lines for specific case only
     */
    async function loadInvoiceLinesForCase(caseId) {
      try {
        console.log('ğŸ” SESSION 86: Loading invoices for case:', caseId);
        console.log('ğŸ” SESSION 86: Current case plate:', currentCase.plate);
        
        // Load invoices for assignment/reassignment (PENDING, ASSIGNED, ACCEPTED)
        const { data: invoices, error: invError } = await window.supabase
          .from('invoices')
          .select('id, invoice_number, supplier_name, plate, total_amount, case_id, status')
          .eq('case_id', caseId)
          .or('status.eq.PENDING,status.eq.ASSIGNED,status.eq.ACCEPTED');  // Allow reassignment

        console.log('ğŸ“„ SESSION 86: Invoices by case_id:', invoices?.length || 0, invoices);

        if (invError) {
          console.error('âŒ SESSION 86: Error loading by case_id:', invError);
          throw invError;
        }
        
        let finalInvoices = invoices || [];
        
        // If no invoices found by case_id, try by plate as fallback
        if (!finalInvoices || finalInvoices.length === 0) {
          console.log('ğŸ” SESSION 86: No invoices by case_id, trying by plate...');
          
          const { data: invoicesByPlate, error: plateError } = await window.supabase
            .from('invoices')
            .select('id, invoice_number, supplier_name, plate, total_amount, case_id, status')
            .eq('plate', currentCase.plate)
            .or('status.eq.PENDING,status.eq.ASSIGNED,status.eq.ACCEPTED');  // Allow reassignment
            
          console.log('ğŸ“„ SESSION 86: Invoices by plate:', invoicesByPlate?.length || 0, invoicesByPlate);
          
          if (plateError) {
            console.error('âŒ SESSION 86: Error loading by plate:', plateError);
          } else {
            finalInvoices = invoicesByPlate || [];
          }
        }
        
        // If still no invoices, get all invoices for debugging
        if (!finalInvoices || finalInvoices.length === 0) {
          console.log('ğŸ” SESSION 86: No invoices found, getting all for debugging...');
          
          const { data: allInvoices, error: allError } = await window.supabase
            .from('invoices')
            .select('id, invoice_number, supplier_name, plate, total_amount, case_id')
            .limit(10);
            
          console.log('ğŸ“„ SESSION 86: Sample of all invoices:', allInvoices?.length || 0, allInvoices);
          
          if (allError) {
            console.error('âŒ SESSION 86: Error loading all invoices:', allError);
          }
          
          return [];
        }

        console.log('ğŸ“„ SESSION 86: Final invoices to process:', finalInvoices.length);

        // SESSION 86 FIX: Get invoice lines for each invoice separately (no .in() method)
        let allLines = [];
        for (const invoice of finalInvoices) {
          console.log('ğŸ“„ SESSION 86: Loading lines for invoice:', invoice.id);
          
          const { data: lines, error: linesError } = await window.supabase
            .from('invoice_lines')
            .select('*')
            .eq('invoice_id', invoice.id)
            .order('line_number', { ascending: true });

          if (linesError) {
            console.error('âŒ SESSION 86: Error loading lines for invoice:', invoice.id, linesError);
            continue; // Skip this invoice but continue with others
          }

          if (lines && lines.length > 0) {
            // Enrich lines with invoice info
            const enrichedLines = lines.map(line => ({
              ...line,
              _invoice_number: invoice.invoice_number,
              _supplier_name: invoice.supplier_name,
              _plate: invoice.plate,
              _invoice_total: invoice.total_amount,
              _invoice_status: invoice.status // Add invoice status to lines
            }));
            
            allLines = allLines.concat(enrichedLines);
            console.log('ğŸ“„ SESSION 86: Added', enrichedLines.length, 'lines from invoice:', invoice.invoice_number);
          }
        }

        console.log('ğŸ“„ SESSION 86: Total loaded invoice lines:', allLines.length);
        return allLines;

      } catch (error) {
        console.error('âŒ SESSION 86: Failed to load invoice lines:', error);
        throw error;
      }
    }

    /**
     * SESSION 86: Load existing assignments from database
     */
    async function loadExistingAssignments(caseId) {
      try {
        // Load assignments from main storage: invoice_damage_center_mappings (both pending and applied)
        const { data: mappings, error } = await window.supabase
          .from('invoice_damage_center_mappings')
          .select('*')
          .eq('case_id', caseId)
          .or('mapping_status.eq.pending,mapping_status.eq.applied');

        if (error) {
          console.error('âŒ Error loading mappings from database:', error);
        }

        const assignmentsMap = new Map();
        
        // Process database mappings (primary source)
        if (mappings && mappings.length > 0) {
          console.log('ğŸ“‹ Found', mappings.length, 'existing assignments in database');
          mappings.forEach(mapping => {
            assignmentsMap.set(mapping.invoice_line_id, mapping.damage_center_id);
          });
        }

        // Also check helper.final_report.invoice_assignments as secondary source
        if (window.helper?.final_report?.invoice_assignments) {
          console.log('ğŸ“‹ Found', window.helper.final_report.invoice_assignments.length, 'assignments in helper');
          window.helper.final_report.invoice_assignments.forEach(assignment => {
            // Only add if not already in database assignments
            if (!assignmentsMap.has(assignment.invoice_line_id)) {
              assignmentsMap.set(assignment.invoice_line_id, assignment.damage_center_id);
            }
          });
        }

        console.log('ğŸ“‹ Total assignments loaded:', assignmentsMap.size);
        return assignmentsMap;
      } catch (error) {
        console.error('âŒ SESSION 86: Failed to load existing assignments:', error);
        return new Map();
      }
    }

    /**
     * SESSION 86: Initialize helper.final_report structure
     */
    function initializeFinalReportHelper() {
      if (!window.helper) {
        window.helper = {};
      }

      if (!window.helper.final_report) {
        window.helper.final_report = {
          case_id: currentCase.id,
          plate: currentCase.plate,
          invoice_assignments: [],
          assignments_by_center: {},
          total_assignments: 0,
          pending_assignments: 0,
          applied_assignments: 0,
          total_assigned_cost: 0,
          last_assignment_at: null,
          last_applied_at: null
        };
      }
    }

    /**
     * Generate assignment status messages
     */
    function generateAssignmentStatusMessages() {
      // Group lines by invoice to get invoice-level status
      const invoiceGroups = groupLinesByInvoice(invoiceLines);
      const totalInvoices = invoiceGroups.length;
      let assignedInvoicesList = [];
      let unassignedInvoicesList = [];

      invoiceGroups.forEach(group => {
        const totalLines = group.parts.length + group.works.length + group.repairs.length + group.other.length;
        let assignedLines = 0;
        
        // Count assigned lines for this invoice
        [group.parts, group.works, group.repairs, group.other].forEach(categoryLines => {
          categoryLines.forEach(line => {
            if (existingAssignments.has(line.id)) {
              assignedLines++;
            }
          });
        });

        // Get actual invoice status from database and convert to Hebrew
        const invoiceStatus = getInvoiceStatusInHebrew(group.invoice_status || 'PENDING');
        const isFullyAssigned = assignedLines === totalLines && totalLines > 0;
        const isPartiallyAssigned = assignedLines > 0 && assignedLines < totalLines;

        // Use actual invoice status from database, not just line assignment count
        if (group.invoice_status === 'ASSIGNED' || group.invoice_status === 'ACCEPTED' || isFullyAssigned) {
          assignedInvoicesList.push({
            number: group.invoice_number || '×œ× ××–×•×”×”',
            supplier: group.supplier_name || '×¡×¤×§ ×œ× ×™×“×•×¢',
            assignedLines,
            totalLines,
            status: invoiceStatus,
            dbStatus: group.invoice_status || 'PENDING'
          });
        } else if (isPartiallyAssigned || group.invoice_status === 'PENDING') {
          unassignedInvoicesList.push({
            number: group.invoice_number || '×œ× ××–×•×”×”', 
            supplier: group.supplier_name || '×¡×¤×§ ×œ× ×™×“×•×¢',
            assignedLines,
            totalLines,
            status: isPartiallyAssigned ? '×—×œ×§×™' : invoiceStatus,
            dbStatus: group.invoice_status || 'PENDING'
          });
        } else {
          unassignedInvoicesList.push({
            number: group.invoice_number || '×œ× ××–×•×”×”',
            supplier: group.supplier_name || '×¡×¤×§ ×œ× ×™×“×•×¢', 
            assignedLines: 0,
            totalLines,
            status: invoiceStatus,
            dbStatus: group.invoice_status || 'PENDING'
          });
        }
      });

      let statusHtml = `
        <div style="margin-bottom: 15px;">
          <strong>× ××¦××• ${totalInvoices} ×—×©×‘×•× ×™×•×ª ×¢×‘×•×¨ ×¨×›×‘ ××¡×¤×¨: ${currentCase.plate}</strong>
        </div>
      `;

      if (assignedInvoicesList.length > 0) {
        statusHtml += `
          <div style="background: #e8f5e9; border-radius: 6px; padding: 10px; margin-bottom: 10px;">
            <strong style="color: #2e7d32;">âœ… ×—×©×‘×•× ×™×•×ª ××•×©×œ××•×ª ×”×©×™×•×š:</strong>
            <ul style="margin: 5px 0 0 20px; padding: 0;">
        `;
        assignedInvoicesList.forEach(invoice => {
          statusHtml += `
            <li>×—×©×‘×•× ×™×ª ××¡' ${invoice.number} - ${invoice.supplier} 
                <span style="color: #2e7d32; font-weight: bold;">[${invoice.status}]</span> 
                (${invoice.assignedLines}/${invoice.totalLines} ×¤×¨×™×˜×™×)
            </li>
          `;
        });
        statusHtml += `</ul></div>`;
      }

      if (unassignedInvoicesList.length > 0) {
        statusHtml += `
          <div style="background: #fff3e0; border-radius: 6px; padding: 10px;">
            <strong style="color: #f57c00;">âš ï¸ ×—×©×‘×•× ×™×•×ª ×”×“×•×¨×©×•×ª ×”×©×œ××ª ×©×™×•×š:</strong>
            <ul style="margin: 5px 0 0 20px; padding: 0;">
        `;
        unassignedInvoicesList.forEach(invoice => {
          const statusColor = invoice.status === '×××ª×™×Ÿ ×œ×©×™×•×š' ? '#d32f2f' : '#ff9800';
          statusHtml += `
            <li>×—×©×‘×•× ×™×ª ××¡' ${invoice.number} - ${invoice.supplier} 
                <span style="color: ${statusColor}; font-weight: bold;">[${invoice.status}]</span> 
                (${invoice.assignedLines}/${invoice.totalLines} ×¤×¨×™×˜×™×)
            </li>
          `;
        });
        statusHtml += `</ul></div>`;
      }

      return statusHtml;
    }

    /**
     * Convert invoice status to Hebrew
     */
    function getInvoiceStatusInHebrew(status) {
      switch(status?.toUpperCase()) {
        case 'PENDING': return '×××ª×™×Ÿ ×œ×©×™×•×š';
        case 'ASSIGNED': return '××©×•×™×š';
        case 'ACCEPTED': return '×××•×©×¨';
        case 'PAID': return '×©×•×œ×';
        case 'CANCELLED': return '××‘×•×˜×œ';
        default: return '×œ× ×™×“×•×¢';
      }
    }

    /**
     * SESSION 86: Render invoices content
     */
    function renderInvoicesContent() {
      const container = document.getElementById('invoices-content');
      
      // Group lines by invoice
      const invoiceGroups = groupLinesByInvoice(invoiceLines);
      
      let html = '';
      invoiceGroups.forEach(group => {
        html += renderInvoiceGroup(group);
      });

      container.innerHTML = html;
      
      // Update assignment status messages
      const statusSection = document.getElementById('assignment-status-section');
      const statusContent = document.getElementById('assignment-status-content');
      statusContent.innerHTML = generateAssignmentStatusMessages();
      statusSection.style.display = 'block';
      
      // Set pre-selected damage centers for assigned items
      setTimeout(() => {
        existingAssignments.forEach((dcId, lineId) => {
          const selector = document.querySelector(`select[data-line-id="${lineId}"]`);
          if (selector) {
            selector.value = dcId;
          }
        });
      }, 100);
    }

    /**
     * SESSION 86: Group invoice lines by invoice
     */
    function groupLinesByInvoice(lines) {
      const grouped = {};
      
      lines.forEach(line => {
        const invoiceId = line.invoice_id;
        if (!grouped[invoiceId]) {
          grouped[invoiceId] = {
            invoice_id: invoiceId,
            invoice_number: line._invoice_number,
            supplier_name: line._supplier_name,
            plate: line._plate,
            total_amount: line._invoice_total,
            invoice_status: line._invoice_status, // Add invoice status
            parts: [],
            works: [],
            repairs: [],
            other: []
          };
        }

        // Use the actual category from database metadata
        const categoryFromMeta = (line.metadata?.category || '').toUpperCase();
        const category = categoryFromMeta || line.item_category || 'OTHER';
        
        if (category === 'PART' || category === 'part') {
          grouped[invoiceId].parts.push(line);
        } else if (category === 'WORK' || category === 'work') {
          grouped[invoiceId].works.push(line);
        } else if (category === 'REPAIR' || category === 'repair') {
          grouped[invoiceId].repairs.push(line);
        } else {
          grouped[invoiceId].other.push(line);
        }
      });

      return Object.values(grouped);
    }

    /**
     * SESSION 86: Render single invoice group
     */
    function renderInvoiceGroup(group) {
      const totalLines = group.parts.length + group.works.length + group.repairs.length + group.other.length;
      
      return `
        <div class="invoice-group">
          <div class="invoice-header">
            <div class="invoice-title">
              ${group.supplier_name || '×¡×¤×§ ×œ× ×™×“×•×¢'} - ×—×©×‘×•× ×™×ª ${group.invoice_number || '×œ× ××–×•×”×”'}
            </div>
            <div class="invoice-meta">
              ×¨×›×‘: ${group.plate} | ×¡×”"×› ×¤×¨×™×˜×™×: ${totalLines} | ×¡×›×•×: ${formatCurrency(group.total_amount || 0)}
            </div>
          </div>

          ${renderCategorySection('×—×œ×§×™×', group.parts, 'part')}
          ${renderCategorySection('×¢×‘×•×“×•×ª', group.works, 'work')}
          ${renderCategorySection('×ª×™×§×•× ×™×', group.repairs, 'repair')}
          ${group.other.length > 0 ? renderCategorySection('××—×¨', group.other, 'other') : ''}
        </div>
      `;
    }

    /**
     * SESSION 86: Render category section (parts/works/repairs) with proper division
     */
    function renderCategorySection(title, items, category) {
      const dcOptions = damageCenters.map(dc => 
        `<option value="${dc.Id || dc.id}">${dc['Damage center Number'] || dc.number || '?'} - ${dc.Description || dc.Location || '×œ×œ× ×ª×™××•×¨'}</option>`
      ).join('');

      // Get category icon
      const categoryIcon = getCategoryIcon(category);

      return `
        <div class="category-section" data-category="${category}">
          <div class="category-header">
            <span>${categoryIcon} ${title}</span>
            <span class="category-count">${items.length}</span>
          </div>
          <table class="items-table">
            <thead>
              <tr>
                <th style="width: 12%;">××§"×˜</th>
                <th style="width: 20%;">×ª×™××•×¨</th>
                <th style="width: 6%;">×›××•×ª</th>
                <th style="width: 10%;">××—×™×¨ ×™×—×™×“×”</th>
                <th style="width: 8%;">×¡×”"×›</th>
                <th style="width: 32%;">××•×§×“ × ×–×§</th>
                <th style="width: 12%;">×¤×¢×•×œ×•×ª</th>
              </tr>
            </thead>
            <tbody>
              ${items.length > 0 
                ? items.map(item => renderItemRow(item, dcOptions)).join('')
                : `<tr><td colspan="7" style="text-align: center; padding: 20px; color: #666; font-style: italic;">××™×Ÿ ×¤×¨×™×˜×™ ${title} ×‘×—×©×‘×•× ×™×ª ×–×•</td></tr>`
              }
            </tbody>
          </table>
        </div>
      `;
    }

    /**
     * SESSION 86: Render single item row
     */
    function renderItemRow(item, dcOptions) {
      const isAssigned = existingAssignments.has(item.id);
      const assignedDcId = existingAssignments.get(item.id);
      const rowClass = isAssigned ? 'assigned' : '';
      
      // Use the actual category from database metadata
      const categoryFromMeta = (item.metadata?.category || '').toUpperCase();
      const itemCategory = categoryFromMeta || item.item_category || 'other';

      // Get catalog number from metadata
      const catalogNumber = item.metadata?.['××§×´×˜ ×—×œ×§'] || 
                           item.metadata?.['××§\'×˜ ×—×œ×§'] || 
                           item.metadata?.['××§"×˜ ×—×œ×§'] || 
                           item.metadata?.code || 
                           item.code || '';

      return `
        <tr class="${rowClass}" data-line-id="${item.id}" data-category="${itemCategory}">
          <td style="font-family: monospace; font-size: 12px; color: #666;">${catalogNumber}</td>
          <td>${item.description || '×œ×œ× ×ª×™××•×¨'}</td>
          <td>${item.quantity || 1}</td>
          <td>${formatCurrency(item.unit_price || 0)}</td>
          <td>${formatCurrency(item.line_total || 0)}</td>
          <td>
            <select class="dc-selector" data-line-id="${item.id}" ${isAssigned ? 'data-original-value="' + assignedDcId + '" disabled' : ''}>
              <option value="">×‘×—×¨ ××•×§×“ × ×–×§...</option>
              ${dcOptions}
            </select>
          </td>
          <td style="white-space: nowrap; padding: 4px;">
            ${isAssigned 
              ? `<button class="btn btn-unassign" data-dc-id="${assignedDcId}" style="margin-left: 2px;">×‘×˜×œ ×©×™×•×š</button>
                 <button class="btn btn-edit" data-line-id="${item.id}" style="background: #ff9800; color: white; margin-left: 2px;">×¢×¨×•×š</button>`
              : `<button class="btn btn-assign">×©×™×™×š</button>`
            }
          </td>
        </tr>
      `;
    }

    /**
     * SESSION 86: Update summary panel
     */
    function updateSummaryPanel() {
      // Calculate stats
      let totalAssignments = 0;
      let totalCost = 0;
      const byCenter = {};

      existingAssignments.forEach((dcId, lineId) => {
        const line = invoiceLines.find(l => l.id === lineId);
        if (line) {
          totalAssignments++;
          totalCost += parseFloat(line.line_total || 0);

          if (!byCenter[dcId]) {
            const dc = damageCenters.find(d => (d.Id || d.id) === dcId);
            byCenter[dcId] = {
              name: `${dc?.['Damage center Number'] || dc?.number || '?'} - ${dc?.Description || dc?.Location || '×œ×œ× ×ª×™××•×¨'}`,
              count: 0,
              cost: 0
            };
          }
          byCenter[dcId].count++;
          byCenter[dcId].cost += parseFloat(line.line_total || 0);
        }
      });

      // Update UI
      document.getElementById('total-assignments').textContent = totalAssignments;
      document.getElementById('total-cost').textContent = formatCurrency(totalCost);

      const centerContainer = document.getElementById('assignments-by-center');
      if (totalAssignments === 0) {
        centerContainer.innerHTML = `
          <div class="empty-state">
            <div class="icon">ğŸ“‹</div>
            <p>×˜×¨× ×‘×•×¦×¢×• ×©×™×•×›×™×</p>
          </div>
        `;
      } else {
        let centerHtml = '';
        Object.values(byCenter).forEach(center => {
          centerHtml += `
            <div class="center-summary">
              <h4>${center.name}</h4>
              <ul>
                <li>${center.count} ×¤×¨×™×˜×™×</li>
              </ul>
              <div class="center-total">${formatCurrency(center.cost)}</div>
            </div>
          `;
        });
        centerContainer.innerHTML = centerHtml;
      }

      // Enable/disable save button
      const saveBtn = document.getElementById('save-assignments-btn');
      saveBtn.disabled = totalAssignments === 0;
      
      // Update assignment status messages
      const statusContent = document.getElementById('assignment-status-content');
      if (statusContent) {
        statusContent.innerHTML = generateAssignmentStatusMessages();
      }
      
      // Store stats globally
      assignmentStats = { totalAssignments, totalCost, byCenter };
    }

    /**
     * SESSION 86: Attach event listeners
     */
    function attachEventListeners() {
      // Assign buttons
      document.querySelectorAll('.btn-assign').forEach(btn => {
        btn.addEventListener('click', handleAssignClick);
      });

      // Unassign buttons
      document.querySelectorAll('.btn-unassign').forEach(btn => {
        btn.addEventListener('click', handleUnassignClick);
      });

      // Edit buttons
      document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', handleEditClick);
      });

      // Note: Selector change events removed - dropdowns now controlled through edit workflow only

      // Save button (no redirect)
      document.getElementById('save-assignments-btn').addEventListener('click', saveAssignments);

      // Continue to report button (redirect only)
      document.getElementById('continue-to-report-btn').addEventListener('click', continueToReport);

      // Navigation buttons
      document.getElementById('back-to-invoices-btn')?.addEventListener('click', () => {
        window.location.href = 'invoice upload.html';
      });
      
      document.getElementById('back-to-home-btn')?.addEventListener('click', () => {
        window.location.href = 'selection.html';
      });
    }

    /**
     * SESSION 86: Handle assign button click
     */
    async function handleAssignClick(event) {
      const btn = event.target;
      const row = btn.closest('tr');
      const lineId = row.dataset.lineId;
      const selector = row.querySelector('.dc-selector');
      const dcId = selector.value;

      if (!dcId) {
        showError('× × ×œ×‘×—×•×¨ ××•×§×“ × ×–×§');
        return;
      }

      try {
        btn.disabled = true;
        btn.textContent = '×©×•××¨...';

        // Get invoice line to determine correct category from metadata
        const invoiceLine = invoiceLines.find(l => l.id === lineId);
        const categoryFromMeta = (invoiceLine?.metadata?.category || '').toUpperCase();
        const fieldType = (categoryFromMeta || invoiceLine?.item_category || 'other').toLowerCase();
        
        // Get damage center details
        const damageCenter = damageCenters.find(dc => (dc.Id || dc.id) === dcId);
        const damageCenterName = `${damageCenter?.['Damage center Number'] || '?'} - ${damageCenter?.Description || damageCenter?.Location || '×œ×œ× ×ª×™××•×¨'}`;
        
        // Get catalog code
        const catalogCode = invoiceLine?.metadata?.['××§×´×˜ ×—×œ×§'] || 
                           invoiceLine?.metadata?.['××§\'×˜ ×—×œ×§'] || 
                           invoiceLine?.metadata?.['××§"×˜ ×—×œ×§'] || 
                           invoiceLine?.metadata?.code || 
                           invoiceLine?.code || '';
        
        // Clean supplier vs garage name
        const supplierName = invoiceLine?._supplier_name?.includes('××•×¡×š') ? '' : (invoiceLine?._supplier_name || '');
        const garageName = invoiceLine?._supplier_name?.includes('××•×¡×š') ? invoiceLine?._supplier_name : '';
        
        // Create mapping in database with complete data
        const { data: mapping, error } = await window.supabase
          .from('invoice_damage_center_mappings')
          .insert({
            invoice_id: invoiceLine.invoice_id,
            invoice_line_id: lineId,
            case_id: currentCase.id,
            damage_center_id: dcId,
            damage_center_name: damageCenterName,
            field_type: fieldType,
            original_field_data: {
              description: invoiceLine.description,
              quantity: invoiceLine.quantity,
              unit_price: invoiceLine.unit_price,
              line_total: invoiceLine.line_total,
              catalog_code: catalogCode,
              supplier_name: supplierName,
              garage_name: garageName,
              invoice_number: invoiceLine._invoice_number,
              plate: invoiceLine._plate
            },
            mapped_data: {
              damage_center_id: dcId,
              damage_center_name: damageCenterName,
              field_type: fieldType,
              assigned_at: new Date().toISOString(),
              catalog_code: catalogCode
            },
            mapping_status: 'pending',
            validation_status: 'approved',
            mapping_confidence: 100,
            is_user_modified: true
            // mapped_by: null // Skip this field for now due to UUID constraints
          })
          .select()
          .single();
          
        console.log('ğŸ’¾ Database mapping result:', { mapping, error });

        if (error) throw error;

        // Update invoice status from PENDING to ASSIGNED (first assignment for this invoice)
        try {
          const { error: invoiceUpdateError } = await window.supabase
            .from('invoices')
            .update({ status: 'ASSIGNED' })
            .eq('id', invoiceLine.invoice_id)
            .eq('status', 'PENDING');  // Only update if still PENDING
          
          if (invoiceUpdateError) {
            console.warn('âš ï¸ Could not update invoice status (may already be ASSIGNED):', invoiceUpdateError);
          } else {
            console.log('âœ… Updated invoice status from PENDING to ASSIGNED');
          }
        } catch (statusError) {
          console.warn('âš ï¸ Invoice status update failed:', statusError);
          // Don't throw - assignment was successful
        }

        // Update local state
        existingAssignments.set(lineId, dcId);
        
        // Update helper.final_report with new assignment
        console.log('ğŸ” Current helper state:', {
          hasHelper: !!window.helper,
          hasFinalReport: !!window.helper?.final_report,
          hasAssignments: !!window.helper?.final_report?.invoice_assignments,
          assignmentsLength: window.helper?.final_report?.invoice_assignments?.length || 0
        });
        
        if (!window.helper.final_report.invoice_assignments) {
          window.helper.final_report.invoice_assignments = [];
          console.log('âš™ï¸ Initialized empty invoice_assignments array');
        }
        
        const assignment = {
          assignment_id: mapping?.id || Math.random().toString(36).substr(2, 9),
          invoice_line_id: lineId,
          invoice_id: invoiceLine.invoice_id,
          damage_center_id: dcId,
          damage_center_name: damageCenterName,
          field_type: fieldType,
          catalog_code: catalogCode,
          supplier_name: supplierName,
          garage_name: garageName,
          invoice_line: {
            ...invoiceLine,
            catalog_code: catalogCode,
            supplier_name: supplierName,
            garage_name: garageName,
            item_category: fieldType, // Override with correct category
            corrected_category: categoryFromMeta || fieldType.toUpperCase(),
            original_item_category: invoiceLine.item_category // Keep original for reference
          },
          assigned_at: new Date().toISOString(),
          assigned_by: window.helper?.user_id || null,
          assignment_status: 'pending',
          applied_at: null,
          applied_by: null
        };
        
        window.helper.final_report.invoice_assignments.push(assignment);
        console.log('âœ… Added assignment to helper.final_report:', assignment);
        console.log('ğŸ“Š New assignments count:', window.helper.final_report.invoice_assignments.length);
        
        // Save helper to sessionStorage immediately
        sessionStorage.setItem('helper', JSON.stringify(window.helper));
        console.log('ğŸ’¾ Saved updated helper to sessionStorage');

        // Update UI - recreate button structure for assigned state
        row.classList.add('assigned');
        selector.value = dcId;
        selector.dataset.originalValue = dcId;
        
        // Replace assign button with unassign + edit buttons
        const buttonCell = btn.parentNode;
        buttonCell.innerHTML = `
          <button class="btn btn-unassign" data-dc-id="${dcId}" style="margin-left: 2px;">×‘×˜×œ ×©×™×•×š</button>
          <button class="btn btn-edit" data-line-id="${lineId}" style="background: #ff9800; color: white; margin-left: 2px;">×¢×¨×•×š</button>
        `;
        
        // Re-attach event listeners for new buttons
        const newUnassignBtn = buttonCell.querySelector('.btn-unassign');
        const newEditBtn = buttonCell.querySelector('.btn-edit');
        newUnassignBtn.addEventListener('click', handleUnassignClick);
        newEditBtn.addEventListener('click', handleEditClick);

        updateSummaryPanel();
        showSuccess('×”×©×™×•×š × ×©××¨ ×‘×”×¦×œ×—×”');

      } catch (error) {
        console.error('âŒ SESSION 86: Assign failed:', error);
        showError('×©×’×™××” ×‘×©×™×•×š: ' + error.message);
        btn.disabled = false;
        btn.textContent = '×©×™×™×š';
      }
    }

    /**
     * SESSION 86: Handle unassign button click
     */
    async function handleUnassignClick(event) {
      const btn = event.target;
      const row = btn.closest('tr');
      const lineId = row.dataset.lineId;

      try {
        btn.disabled = true;
        btn.textContent = '××•×—×§...';

        // Delete from database
        const { error } = await window.supabase
          .from('invoice_damage_center_mappings')
          .delete()
          .eq('invoice_line_id', lineId)
          .eq('case_id', currentCase.id)
          .eq('mapping_status', 'pending');

        if (error) throw error;

        // Update local state
        existingAssignments.delete(lineId);
        
        // Remove from helper.final_report
        if (window.helper.final_report && window.helper.final_report.invoice_assignments) {
          const assignmentIndex = window.helper.final_report.invoice_assignments.findIndex(
            a => a.invoice_line_id === lineId && a.assignment_status === 'pending'
          );
          if (assignmentIndex !== -1) {
            const removedAssignment = window.helper.final_report.invoice_assignments.splice(assignmentIndex, 1)[0];
            console.log('âœ… Removed assignment from helper.final_report:', removedAssignment);
            console.log('ğŸ“Š Remaining assignments count:', window.helper.final_report.invoice_assignments.length);
            
            // Save helper to sessionStorage immediately
            sessionStorage.setItem('helper', JSON.stringify(window.helper));
            console.log('ğŸ’¾ Saved updated helper to sessionStorage after removal');
          } else {
            console.log('âš ï¸ Assignment not found in helper for line:', lineId);
          }
        } else {
          console.log('âš ï¸ No helper.final_report.invoice_assignments found');
        }

        // Update UI - recreate button structure for unassigned state
        row.classList.remove('assigned');
        const selector = row.querySelector('.dc-selector');
        selector.disabled = false;
        selector.value = '';
        selector.dataset.originalValue = '';
        
        // Replace unassign/edit buttons with single assign button
        const buttonCell = btn.parentNode;
        buttonCell.innerHTML = `
          <button class="btn btn-assign">×©×™×™×š</button>
        `;
        
        // Re-attach event listener for new assign button
        const newAssignBtn = buttonCell.querySelector('.btn-assign');
        newAssignBtn.addEventListener('click', handleAssignClick);

        updateSummaryPanel();
        showSuccess('×”×©×™×•×š ×‘×•×˜×œ ×‘×”×¦×œ×—×”');

      } catch (error) {
        console.error('âŒ SESSION 86: Unassign failed:', error);
        showError('×©×’×™××” ×‘×‘×™×˜×•×œ ×©×™×•×š: ' + error.message);
        btn.disabled = false;
        btn.textContent = '×‘×˜×œ ×©×™×•×š';
      }
    }

    /**
     * Handle edit button click - Enable editing for assigned line
     */
    function handleEditClick(event) {
      const btn = event.target;
      const lineId = btn.dataset.lineId;
      const row = btn.closest('tr');
      const selector = row.querySelector('.dc-selector');
      const unassignBtn = row.querySelector('.btn-unassign');
      
      // Check if already in edit mode (prevent duplicates)
      if (row.querySelector('button[onclick*="handleEditSave"]')) {
        return; // Already in edit mode
      }
      
      // Enable selector for editing and highlight it
      selector.disabled = false;
      selector.style.background = '#fff3cd'; // Highlight that it's in edit mode
      
      // Hide edit button, show save/cancel buttons
      btn.style.display = 'none';
      
      // Add save and cancel buttons (only if they don't exist)
      const saveBtn = document.createElement('button');
      saveBtn.className = 'btn btn-save-edit';
      saveBtn.style.cssText = 'background: #28a745; color: white; margin-left: 2px;';
      saveBtn.textContent = 'ğŸ’¾ ×©××•×¨';
      saveBtn.onclick = () => handleEditSave(lineId, row);
      
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn btn-cancel-edit';  
      cancelBtn.style.cssText = 'background: #6c757d; color: white; margin-left: 2px;';
      cancelBtn.textContent = 'âŒ ×‘×˜×œ';
      cancelBtn.onclick = () => handleEditCancel(lineId, row);
      
      btn.parentNode.appendChild(saveBtn);
      btn.parentNode.appendChild(cancelBtn);
      
      // Hide unassign button during edit
      if (unassignBtn) {
        unassignBtn.style.display = 'none';
      }
    }

    // handleSelectorChange function removed - dropdowns now controlled through edit workflow only

    /**
     * Handle edit save - Save the reassignment
     */
    async function handleEditSave(lineId, row) {
      const selector = row.querySelector('.dc-selector');
      const newDcId = selector.value;
      const originalDcId = selector.dataset.originalValue;
      
      if (!newDcId) {
        showError('× × ×œ×‘×—×•×¨ ××•×§×“ × ×–×§ ×—×“×©');
        return;
      }
      
      if (newDcId === originalDcId) {
        // No change - just cancel edit mode
        handleEditCancel(lineId, row);
        return;
      }
      
      try {
        // Show saving state
        const saveBtn = row.querySelector('.btn-save-edit');
        if (saveBtn) {
          saveBtn.disabled = true;
          saveBtn.textContent = 'ğŸ’¾ ×©×•××¨...';
        }
        
        // Delete old assignment
        const { error: deleteError } = await window.supabase
          .from('invoice_damage_center_mappings')
          .delete()
          .eq('invoice_line_id', lineId)
          .eq('case_id', currentCase.id)
          .or('mapping_status.eq.pending,mapping_status.eq.applied');
          
        if (deleteError) throw deleteError;
        
        // Update local state first
        existingAssignments.delete(lineId);
        existingAssignments.set(lineId, newDcId);
        
        // Create new assignment directly (simplified)
        const invoiceLine = invoiceLines.find(l => l.id === lineId);
        const damageCenter = damageCenters.find(dc => (dc.Id || dc.id) === newDcId);
        const damageCenterName = `${damageCenter?.['Damage center Number'] || '?'} - ${damageCenter?.Description || damageCenter?.Location || '×œ×œ× ×ª×™××•×¨'}`;
        
        // Create new mapping in database
        const { error: insertError } = await window.supabase
          .from('invoice_damage_center_mappings')
          .insert({
            invoice_id: invoiceLine.invoice_id,
            invoice_line_id: lineId,
            case_id: currentCase.id,
            damage_center_id: newDcId,
            damage_center_name: damageCenterName,
            field_type: (invoiceLine?.metadata?.category || invoiceLine?.item_category || 'other').toLowerCase(),
            original_field_data: {
              description: invoiceLine.description,
              quantity: invoiceLine.quantity,
              unit_price: invoiceLine.unit_price,
              line_total: invoiceLine.line_total,
              catalog_code: invoiceLine?.metadata?.code || invoiceLine?.code || '',
              supplier_name: invoiceLine?._supplier_name?.includes('××•×¡×š') ? '' : (invoiceLine?._supplier_name || ''),
              garage_name: invoiceLine?._supplier_name?.includes('××•×¡×š') ? invoiceLine?._supplier_name : '',
              invoice_number: invoiceLine._invoice_number,
              plate: invoiceLine._plate
            },
            mapped_data: {
              damage_center_id: newDcId,
              damage_center_name: damageCenterName,
              field_type: (invoiceLine?.metadata?.category || invoiceLine?.item_category || 'other').toLowerCase(),
              assigned_at: new Date().toISOString()
            },
            mapping_status: 'pending',
            validation_status: 'approved',
            mapping_confidence: 100,
            is_user_modified: true
          });
          
        if (insertError) throw insertError;
        
        // Update selector's original value
        selector.dataset.originalValue = newDcId;
        
        // Exit edit mode
        handleEditCancel(lineId, row);
        updateSummaryPanel();
        showSuccess('×©×™×•×š ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”');
        
      } catch (error) {
        console.error('âŒ Edit save failed:', error);
        showError('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×©×™×•×š: ' + error.message);
        
        // Reset selector to original value
        selector.value = originalDcId;
        handleEditCancel(lineId, row);
      }
    }

    /**
     * Handle edit cancel - Exit edit mode without saving
     */
    function handleEditCancel(lineId, row) {
      const selector = row.querySelector('.dc-selector');
      const editBtn = row.querySelector('.btn-edit');
      const unassignBtn = row.querySelector('.btn-unassign');
      
      // Reset selector to disabled state (only editable through edit button)
      selector.disabled = true; // Disable it again after edit
      selector.style.background = ''; // Remove edit highlight
      selector.value = selector.dataset.originalValue || '';
      
      // Remove all dynamically created buttons (save/cancel)
      const dynamicButtons = row.querySelectorAll('.btn-save-edit, .btn-cancel-edit');
      dynamicButtons.forEach(btn => btn.remove());
      
      // Show edit and unassign buttons again
      if (editBtn) {
        editBtn.style.display = '';
      }
      if (unassignBtn) {
        unassignBtn.style.display = '';
      }
    }

    /**
     * Save assignments (without redirect)
     */
    async function saveAssignments() {
      const saveBtn = document.getElementById('save-assignments-btn');
      const originalText = saveBtn.textContent;
      
      try {
        // Show saving animation
        saveBtn.disabled = true;
        saveBtn.innerHTML = `
          <span style="display: inline-flex; align-items: center; gap: 8px;">
            <div style="width: 16px; height: 16px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            ×©×•××¨ ×©×™×•×›×™×...
          </span>
        `;
        
        // Add CSS animation for spinner if not exists
        if (!document.getElementById('spinner-style')) {
          const style = document.createElement('style');
          style.id = 'spinner-style';
          style.textContent = `
            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
          `;
          document.head.appendChild(style);
        }
        
        // Simulate save process with delay for user feedback
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Update helper.final_report
        if (window.helper && window.helper.final_report) {
          window.helper.final_report.total_assignments = assignmentStats.totalAssignments;
          window.helper.final_report.pending_assignments = assignmentStats.totalAssignments;
          window.helper.final_report.total_assigned_cost = assignmentStats.totalCost;
          window.helper.final_report.assignments_by_center = assignmentStats.byCenter;
          window.helper.final_report.last_assignment_at = new Date().toISOString();
        }

        // Save to session storage
        sessionStorage.setItem('helper_final_report', JSON.stringify(window.helper.final_report));
        sessionStorage.setItem('currentCase', JSON.stringify(currentCase));

        // Show success animation
        saveBtn.innerHTML = `
          <span style="display: inline-flex; align-items: center; gap: 8px;">
            âœ… × ×©××¨ ×‘×”×¦×œ×—×”!
          </span>
        `;
        saveBtn.style.background = '#28a745';
        
        // Show success message
        showSuccess('×©×™×•×›×™× × ×©××¨×• ×‘×”×¦×œ×—×”');
        
        // Reset button after delay - keep table visible
        setTimeout(() => {
          saveBtn.innerHTML = originalText;
          saveBtn.disabled = assignmentStats.totalAssignments === 0;
          saveBtn.style.background = '';
          
          // DON'T refresh the UI - keep table visible after save
          // Only update summary stats without rebuilding the table
          updateSummaryPanel();
        }, 2000);
        
      } catch (error) {
        console.error('âŒ Save failed:', error);
        showError('×©×’×™××” ×‘×©××™×¨×”: ' + error.message);
        
        // Reset button on error
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = assignmentStats.totalAssignments === 0;
        saveBtn.style.background = '';
      }
    }

    /**
     * Continue to final report builder (redirect only)
     */
    function continueToReport() {
      window.location.href = 'final-report-builder.html';
    }

    // Utility Functions
    function formatCurrency(amount) {
      return new Intl.NumberFormat('he-IL', {
        style: 'currency',
        currency: 'ILS',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(amount || 0);
    }

    function getCategoryIcon(category) {
      switch(category) {
        case 'part': return 'ğŸ”§';
        case 'work': return 'ğŸ‘·';
        case 'repair': return 'ğŸ”¨';
        default: return 'ğŸ“';
      }
    }

    /**
     * SESSION 86: Categorize items based on description text (copied from invoice upload)
     */
    function categorizeItem(text) {
      const lowerText = (text || '').toLowerCase();
      
      // Parts keywords
      if (lowerText.includes('×—×œ×§') || lowerText.includes('×¤× ×¡') || lowerText.includes('××¨××”') || 
          lowerText.includes('×“×œ×ª') || lowerText.includes('×¤×’×•×©') || lowerText.includes('×’×œ×’×œ') ||
          lowerText.includes('×¦××™×’') || lowerText.includes('×× ×•×¢') || lowerText.includes('part') ||
          lowerText.includes('××’×Ÿ') || lowerText.includes('×›× ×£') || lowerText.includes('××›×¡×”') ||
          lowerText.includes('×§×™×©×•×˜') || lowerText.includes('×¨×©×ª') || lowerText.includes('×©××©×”')) {
        return 'part';
      }
      
      // Work/Labor keywords  
      if (lowerText.includes('×¢×‘×•×“×”') || lowerText.includes('×©×¢×ª') || lowerText.includes('×©×¢×•×ª') ||
          lowerText.includes('×”×ª×§× ×”') || lowerText.includes('labor') || lowerText.includes('work') ||
          lowerText.includes('×”×•×‘×œ×”') || lowerText.includes('×—×™×©×•×‘×™') || lowerText.includes('×¢×™×‘×•×“')) {
        return 'work';
      }
      
      // Repair keywords
      if (lowerText.includes('×ª×™×§×•×Ÿ') || lowerText.includes('×ª×™×§') || lowerText.includes('repair') ||
          lowerText.includes('×¦×‘×¢') || lowerText.includes('paint') || lowerText.includes('×¨×™×ª×•×š') ||
          lowerText.includes('×—×™×–×•×§') || lowerText.includes('×©×™×§×•×') || lowerText.includes('×©×™××•×Ÿ')) {
        return 'repair';
      }
      
      return 'other';
    }

    function generateCaseId() {
      return 'case_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function showLoading(message) {
      document.getElementById('loading-state').style.display = 'block';
      document.getElementById('loading-state').querySelector('p').textContent = message;
      hideOtherStates();
    }

    function hideLoading() {
      document.getElementById('loading-state').style.display = 'none';
    }

    function showContent() {
      document.getElementById('invoices-content').style.display = 'block';
    }

    function showError(message) {
      document.getElementById('error-message').textContent = message;
      document.getElementById('error-state').style.display = 'block';
      hideOtherStates();
    }

    function showSuccess(message) {
      document.getElementById('success-message').textContent = message;
      document.getElementById('success-state').style.display = 'block';
      setTimeout(() => {
        document.getElementById('success-state').style.display = 'none';
      }, 3000);
    }

    function showNoResults() {
      document.getElementById('no-results-state').style.display = 'block';
      hideOtherStates();
    }

    function hideOtherStates() {
      document.getElementById('invoices-content').style.display = 'none';
      document.getElementById('no-results-state').style.display = 'none';
      document.getElementById('error-state').style.display = 'none';
    }
    
    
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
  </script>
</body>
</html>