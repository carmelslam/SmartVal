<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîß Debug Helper Data Flow</title>
  <style>
    body { font-family: Arial; padding: 20px; direction: rtl; }
    .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 8px; }
    .result { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px; }
    .success { background: #d4edda; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; border: 1px solid #f5c6cb; }
    button { margin: 5px; padding: 10px 15px; }
  </style>
</head>
<body>
  <h1>üîß Debug Helper Data Flow</h1>
  
  <div class="test-section">
    <h3>Test 1: Basic Helper Import & Access</h3>
    <button onclick="testHelperImport()">Test Helper Import</button>
    <div id="import-result" class="result"></div>
  </div>
  
  <div class="test-section">
    <h3>Test 2: Manual Data Addition</h3>
    <button onclick="testManualUpdate()">Add Test Data to Helper</button>
    <div id="manual-result" class="result"></div>
  </div>
  
  <div class="test-section">
    <h3>Test 3: SessionStorage Check</h3>
    <button onclick="testSessionStorage()">Check SessionStorage</button>
    <div id="session-result" class="result"></div>
  </div>
  
  <div class="test-section">
    <h3>Test 4: URL Parameter Simulation</h3>
    <button onclick="testURLParams()">Simulate URL Parameters</button>
    <div id="url-result" class="result"></div>
  </div>
  
  <div class="test-section">
    <h3>Test 5: Floating Screen Data Check</h3>
    <button onclick="testFloatingScreenData()">Check Floating Screen Data Source</button>
    <div id="floating-result" class="result"></div>
  </div>

  <script type="module">
    let helperModule = null;
    
    window.testHelperImport = async function() {
      const resultDiv = document.getElementById('import-result');
      try {
        helperModule = await import('./helper.js');
        console.log('Helper module imported:', helperModule);
        
        const helper = helperModule.helper;
        const updateHelper = helperModule.updateHelper;
        
        resultDiv.innerHTML = `
          <strong>‚úÖ SUCCESS:</strong><br>
          - Helper object exists: ${!!helper}<br>
          - UpdateHelper function exists: ${typeof updateHelper === 'function'}<br>
          - Helper structure: ${Object.keys(helper).join(', ')}<br>
          - Current plate: ${helper.meta?.plate || 'None'}<br>
          - Current manufacturer: ${helper.vehicle?.manufacturer || 'None'}
        `;
        resultDiv.className = 'result success';
        
        // Make helper globally available for other tests
        window.helper = helper;
        window.updateHelper = updateHelper;
        
      } catch (error) {
        resultDiv.innerHTML = `<strong>‚ùå ERROR:</strong> ${error.message}`;
        resultDiv.className = 'result error';
        console.error('Helper import error:', error);
      }
    };
    
    window.testManualUpdate = function() {
      const resultDiv = document.getElementById('manual-result');
      try {
        if (!window.updateHelper) {
          throw new Error('Helper not imported yet - run Test 1 first');
        }
        
        // Test data
        const testData = {
          plate: 'DEBUG-123',
          manufacturer: '◊ò◊°◊ò',
          model: '◊ì◊ô◊ë◊ï◊í',
          year: '2023'
        };
        
        console.log('Adding test data:', testData);
        const result = window.updateHelper('car_details', testData, 'debug_test');
        
        resultDiv.innerHTML = `
          <strong>Update Result:</strong> ${result}<br>
          <strong>Helper after update:</strong><br>
          - Plate: ${window.helper.meta?.plate || 'None'}<br>
          - Manufacturer: ${window.helper.vehicle?.manufacturer || 'None'}<br>
          - Model: ${window.helper.vehicle?.model || 'None'}<br>
          - Car Details Plate: ${window.helper.car_details?.plate || 'None'}
        `;
        resultDiv.className = result ? 'result success' : 'result error';
        
      } catch (error) {
        resultDiv.innerHTML = `<strong>‚ùå ERROR:</strong> ${error.message}`;
        resultDiv.className = 'result error';
        console.error('Manual update error:', error);
      }
    };
    
    window.testSessionStorage = function() {
      const resultDiv = document.getElementById('session-result');
      try {
        const helperData = sessionStorage.getItem('helper');
        const carData = sessionStorage.getItem('carData');
        const currentCaseData = sessionStorage.getItem('currentCaseData');
        
        if (helperData) {
          const parsed = JSON.parse(helperData);
          resultDiv.innerHTML = `
            <strong>‚úÖ SessionStorage Helper Found:</strong><br>
            - Size: ${helperData.length} characters<br>
            - Sections: ${Object.keys(parsed).join(', ')}<br>
            - Plate: ${parsed.meta?.plate || 'None'}<br>
            - Manufacturer: ${parsed.vehicle?.manufacturer || 'None'}<br>
            - CarData also exists: ${!!carData}<br>
            - CurrentCaseData exists: ${!!currentCaseData}
          `;
          resultDiv.className = 'result success';
        } else {
          resultDiv.innerHTML = `
            <strong>‚ö†Ô∏è NO HELPER DATA:</strong><br>
            - SessionStorage 'helper': None<br>
            - SessionStorage 'carData': ${carData ? 'EXISTS' : 'None'}<br>
            - SessionStorage 'currentCaseData': ${currentCaseData ? 'EXISTS' : 'None'}
          `;
          resultDiv.className = 'result error';
        }
        
      } catch (error) {
        resultDiv.innerHTML = `<strong>‚ùå ERROR:</strong> ${error.message}`;
        resultDiv.className = 'result error';
        console.error('Session storage error:', error);
      }
    };
    
    window.testURLParams = async function() {
      const resultDiv = document.getElementById('url-result');
      try {
        if (!helperModule) {
          throw new Error('Helper not imported yet - run Test 1 first');
        }
        
        // Simulate URL parameters
        const testURL = new URL(window.location);
        testURL.searchParams.set('plate', 'URL-456');
        testURL.searchParams.set('manufacturer', '◊ô◊ï◊†◊ì◊ê◊ô');
        testURL.searchParams.set('model', '◊ê◊ú◊†◊ò◊®◊î');
        testURL.searchParams.set('year', '2022');
        
        // Update URL temporarily
        window.history.pushState(null, '', testURL);
        
        // Call checkForIncomingData
        if (typeof helperModule.checkForIncomingData === 'function') {
          helperModule.checkForIncomingData();
          
          setTimeout(() => {
            const helper = helperModule.helper;
            resultDiv.innerHTML = `
              <strong>URL Parameters Test:</strong><br>
              - URL updated with test params: ‚úÖ<br>
              - checkForIncomingData called: ‚úÖ<br>
              - Helper plate after URL check: ${helper.meta?.plate || 'None'}<br>
              - Helper manufacturer: ${helper.vehicle?.manufacturer || 'None'}<br>
              - SessionStorage updated: ${sessionStorage.getItem('helper') ? 'Yes' : 'No'}
            `;
            resultDiv.className = helper.meta?.plate ? 'result success' : 'result error';
          }, 1000);
          
        } else {
          throw new Error('checkForIncomingData function not found');
        }
        
      } catch (error) {
        resultDiv.innerHTML = `<strong>‚ùå ERROR:</strong> ${error.message}`;
        resultDiv.className = 'result error';
        console.error('URL params error:', error);
      }
    };
    
    window.testFloatingScreenData = function() {
      const resultDiv = document.getElementById('floating-result');
      try {
        // Check what data sources floating screens use
        const helperData = sessionStorage.getItem('helper');
        const carData = sessionStorage.getItem('carData');
        const currentCaseData = sessionStorage.getItem('currentCaseData');
        const builderState = sessionStorage.getItem('builderCurrentState');
        
        let analysis = '<strong>Floating Screen Data Sources:</strong><br>';
        
        if (helperData) {
          const helper = JSON.parse(helperData);
          analysis += `- Helper Data: ‚úÖ (plate: ${helper.meta?.plate || 'None'})<br>`;
        } else {
          analysis += '- Helper Data: ‚ùå None<br>';
        }
        
        if (carData) {
          const car = JSON.parse(carData);
          analysis += `- CarData: ‚úÖ (plate: ${car.plate || 'None'})<br>`;
        } else {
          analysis += '- CarData: ‚ùå None<br>';
        }
        
        if (currentCaseData) {
          analysis += '- CurrentCaseData: ‚úÖ<br>';
        } else {
          analysis += '- CurrentCaseData: ‚ùå None<br>';
        }
        
        if (builderState) {
          analysis += '- BuilderState: ‚úÖ<br>';
        } else {
          analysis += '- BuilderState: ‚ùå None<br>';
        }
        
        // Check if window.helper exists
        analysis += `- Window.helper: ${window.helper ? '‚úÖ' : '‚ùå'}<br>`;
        analysis += `- Window.currentCaseData: ${window.currentCaseData ? '‚úÖ' : '‚ùå'}<br>`;
        
        resultDiv.innerHTML = analysis;
        resultDiv.className = helperData ? 'result success' : 'result error';
        
      } catch (error) {
        resultDiv.innerHTML = `<strong>‚ùå ERROR:</strong> ${error.message}`;
        resultDiv.className = 'result error';
        console.error('Floating screen data error:', error);
      }
    };
    
    // Auto-run test 1 on page load
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Debug page loaded, running initial helper import test...');
      setTimeout(window.testHelperImport, 500);
    });
  </script>
</body>
</html>