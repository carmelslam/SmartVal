<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>×‘× ×™×™×ª ××•××“×Ÿ - ×™×¨×•×Ÿ ×›×™×•×£</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" type="image/webp">
  <style>
    body {
      font-family: sans-serif;
      background: #f3f6fb;
      margin: 0;
      min-height: 100vh;
      padding: 0;
      padding-top: 90px;
      overflow-x: hidden;
    }
    .container {
      width: 100%;
      max-width:750px;
      background: #fff;
      padding: 32px 24px 24px 24px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.08);
      margin: 32px auto 32px auto;
      box-sizing: border-box;
    }
    .logo {
      display: flex;
      justify-content: center;
      margin-bottom: 8px;
    }
    .logo img {
      width: 112px;
      height: auto;
      display: block;
    }
    .title { font-size: 27px; font-weight: bold; text-align: center; margin-bottom: 2px; font-weight: 900;}
    .subtitle { font-size: 23px; color: #666; text-align: center; margin-bottom: 10px;}
    h1, h2 { color: #1e3a8a; font-size: 25px; text-align: center; margin: 15px 0 8px 0; font-weight: 600;}
    h3 { color: #1e3a8a; font-size: 24px; margin: 22px 0 12px 0; text-align: right; font-weight: 900;}
    .form-section {
      width: 100%;
      margin-bottom: 20px;
      background: #fafbfe;
      border-radius: 12px;
      padding: 17px 15px 12px 15px;
      box-sizing: border-box;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px 18px;
      width: 100%;
    }
    @media (max-width: 600px) {
      .form-grid { grid-template-columns: 1fr; }
      .container { padding: 14px 2vw 20px 2vw; }
    }
    
    /* Mobile viewport fixes */
    @media (max-width: 768px) {
      body {
        width: 100vw;
        overflow-x: hidden !important;
        position: relative;
      }
      
      html {
        width: 100vw;
        overflow-x: hidden !important;
      }
      
      .container {
        width: 95vw;
        max-width: 95vw;
        margin: 32px 2.5vw 32px 2.5vw;
      }
    }
    label {
      font-size: 18px;
      margin-bottom: 4px;
      display: block;
      text-align: right;
    }
    input, select, textarea {
      width: 100%;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 0px;
      padding: 8px 9px;
      box-sizing: border-box;
      text-align: right;
      background: #f9f9f9;
      transition: border .15s;
      outline: none;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #3b82f6;
    }
    .readonly-box {
      background: #f4f6fa;
      border-radius: 6px;
      border: 1px solid #eee;
      padding: 7px 8px;
      min-height: 20px;
      font-size: 16px;
      color: #333;
      text-align: right;
    }
    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      display: block;
    }
    
    /* FLOATING SCREENS STYLING - COPIED FROM DEPRECIATION */
    .floating-toggles-top {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 8px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .toggle-square {
      width: 80px;
      height: 70px;
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: white;
      text-align: center;
      border: 2px solid transparent;
    }

    .toggle-square:hover {
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .toggle-square.active {
      border-color: #fbbf24;
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
    }

    .toggle-icon {
      font-size: 18px;
      margin-bottom: 2px;
    }

    .toggle-text {
      font-size: 10px;
      font-weight: 600;
      line-height: 1.1;
    }
    @media (max-width: 768px) {
      .floating-toggles-top {
        top: 5px;
        gap: 4px;
        padding: 6px;
      }
      .toggle-square {
        width: 65px;
        height: 60px;
      }
      .toggle-icon {
        font-size: 16px;
      }
      .toggle-text {
        font-size: 9px;
      }
      
      /* Mobile fixes for depreciation table */
      #depreciationBulkTable .dep-row {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 8px !important;
        background: #f8f9fa;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 12px;
        border: 1px solid #e9ecef;
      }
      
      #depreciationBulkTable .dep-row > div {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      
      #depreciationBulkTable .dep-row > div::before {
        font-weight: bold;
        font-size: 12px;
        color: #495057;
      }
      
      #depreciationBulkTable .dep-row > div:nth-child(1)::before {
        content: "×”×—×œ×§ ×”× ×™×–×•×§:";
      }
      
      #depreciationBulkTable .dep-row > div:nth-child(2)::before {
        content: "××”×•×ª ×”×ª×™×§×•×Ÿ:";
      }
      
      #depreciationBulkTable .dep-row > div:nth-child(3)::before {
        content: "% ×™×¨×™×“×ª ×¢×¨×š:";
      }
      
      #depreciationBulkTable .dep-row > div:nth-child(4)::before {
        content: "×¢×¨×š ×‘-â‚ª:";
      }
      
      #depreciationBulkTable .dep-row > div:nth-child(5)::before {
        content: "×¤×¢×•×œ×•×ª:";
      }
      
      /* Hide table headers on mobile */
      #depreciationSection > div:first-child {
        display: none !important;
      }
      
      /* Fix button spacing on mobile */
      .btn.add {
        width: 100% !important;
        margin-top: 8px !important;
      }
      
      /* Navigation buttons mobile responsive */
      .nav-btn {
        font-size: 14px !important;
        padding: 10px 8px !important;
        min-height: 44px !important;
      }
      
      /* Damage centers mobile responsive */
      #damageCentersContent > div > div > div:nth-child(n+1) {
        grid-template-columns: 1fr 1fr !important;
        gap: 4px !important;
      }
      
      /* Levi adjustments mobile responsive */
      .levi-adjustments-grid {
        grid-template-columns: 1fr !important;
        gap: 4px !important;
      }
      
      .levi-adjustment-row {
        grid-template-columns: 1fr !important;
        gap: 4px !important;
        padding: 8px !important;
      }
      
      .levi-adjustment-row > div {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
      }
      
      .levi-adjustment-row > div:nth-child(1)::after {
        content: "";
      }
      
      .levi-adjustment-row > div:nth-child(2)::before {
        content: "××—×•×–: ";
        font-weight: bold;
        color: #495057;
      }
      
      .levi-adjustment-row > div:nth-child(3)::before {
        content: "×¢×¨×š: ";
        font-weight: bold;
        color: #495057;
      }
      
      /* Custom summary rows mobile responsive */
      .custom-summary-row {
        grid-template-columns: 1fr !important;
        gap: 8px !important;
      }
      
      .custom-summary-row > input {
        margin-bottom: 4px;
      }
    }
    
    .collapsible-btn {
      background: #e0e7f1;
      font-family: sans-serif;
      color: #1e3a8a;
      border: none;
      padding: 7px 18px;
      border-radius: 7px;
      margin-bottom: 8px;
      margin-top: 2px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      text-align: right;
      width: auto;
      display: inline-block;
    }

    .collapsible-btn:hover {
      background: #d1d9e6;
    }

    .btn.add {
      background: #28a745;
      margin-top: 7px;
      margin-bottom: 0;
      width: auto;
      padding: 8px 18px;
      font-size: 16px;
      display: block;
    }

    /* Navigation Buttons Styling */
    .nav-btn {
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      min-height: 48px;
    }

    .save-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    .save-btn:hover {
      background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    .preview-btn {
      background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
    }
    .preview-btn:hover {
      background: linear-gradient(135deg, #138496 0%, #1ea085 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
    }

    .generate-btn {
      background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);
    }
    .generate-btn:hover {
      background: linear-gradient(135deg, #0056b3 0%, #520dc2 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }

    .back-btn {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    }
    .back-btn:hover {
      background: linear-gradient(135deg, #545b62 0%, #3d4142 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
    }
    
    .footer {
      margin-top: 40px;
      font-size: 12px;
      color: #aaa;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- FLOATING SCREEN TOGGLES - TOP OF PAGE -->
  <div class="floating-toggles-top">
    <div class="toggle-square" onclick="toggleFloatingScreen('leviReport')">
      <div class="toggle-icon">ğŸ“Š</div>
      <div class="toggle-text">×“×•"×— ×œ×•×™ ×™×¦×—×§</div>
    </div>
    <div class="toggle-square" onclick="toggleFloatingScreen('carDetails')">
      <div class="toggle-icon">ğŸš—</div>
      <div class="toggle-text">×¤×¨×˜×™ ×¨×›×‘</div>
    </div>
    <div class="toggle-square" onclick="toggleFloatingScreen('internalBrowser')">
      <div class="toggle-icon">ğŸŒ</div>
      <div class="toggle-text">×“×¤×“×¤×Ÿ ×¤× ×™××™</div>
    </div>
  </div>

  <div class="container">
    <div class="logo"><img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo"></div>
    <div class="title">×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×¤×•×¨×˜×œ</div>
    <div class="subtitle">×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</div>
    <h1>×‘× ×™×™×ª ××•××“×Ÿ × ×–×§×™ ×¨×›×‘</h1>
    <h2 id="pageTitle">×¨×›×‘ ××¡. ...</h2>

    <!-- ESTIMATE TYPE SELECTION -->
    <div class="form-section" id="estimate-type">
      <h3>×¡×•×’ ×”××•××“×Ÿ</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
        <label style="border: 1px solid #ddd; padding: 10px; border-radius: 6px; cursor: pointer;">
          <input type="radio" name="estimate-type" value="××•×‘×“×Ÿ_×œ×”×œ×›×”" checked style="width: auto; margin-left: 8px;">
          ××•××“×Ÿ ×¨××©×•× ×™ - ××•×‘×“×Ÿ ×œ×”×œ×›×”
        </label>
        <label style="border: 1px solid #ddd; padding: 10px; border-radius: 6px; cursor: pointer;">
          <input type="radio" name="estimate-type" value="×˜×•×˜×œ×•×¡" style="width: auto; margin-left: 8px;">
          ××•××“×Ÿ ×¨××©×•× ×™ - ×˜×•×˜×œ×•×¡
        </label>
      </div>
    </div>

    <!-- VEHICLE DATA - EDITABLE FROM HELPER -->
    <div class="form-section">
      <h3>× ×ª×•× ×™ ×¨×›×‘</h3>
      <div class="form-grid" id="vehicleData">
        <div>
          <label>××¡×¤×¨ ×¨×›×‘:</label>
          <input type="text" id="carPlate" />
        </div>
        <div>
          <label>×ª×•×¦×¨×ª:</label>
          <input type="text" id="carManufacturer" />
        </div>
        <div>
          <label>×“×’×:</label>
          <input type="text" id="carModel" />
        </div>
        <div>
          <label>×©× ×ª ×™×™×¦×•×¨:</label>
          <input type="text" id="carYear" />
        </div>
        <div>
          <label>××—×™×¨ ×‘×¡×™×¡:</label>
          <input type="text" id="carBasePrice" />
        </div>
        <div>
          <label>×¢×¨×š ×”×©×•×§ ×©×œ ×”×¨×›×‘:</label>
          <input type="text" id="carMarketValue" />
        </div>
        <div>
          <label>×ª××¨×™×š ×”×¤×§×”:</label>
          <input type="text" id="carReportDate" />
        </div>
      </div>
    </div>

    <!-- COLLAPSIBLE PRICE DATA -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('priceData')">× ×ª×•× ×™ ×ª×‘×™×¢×” (×”×¦×’/×”×¡×ª×¨)</button>
      <div id="priceData" style="display:none;">
        <div class="form-grid">
          <div><label>×¡×”×´×› ×ª×‘×™×¢×”:</label><input type="text" id="totalClaim" /></div>
          <div><label>×—×™×©×•×‘ ×”×¢×¨×š ×œ× ×–×§ ×’×•×œ××™:</label><input type="text" id="leviPriceList" /></div>
          <div><label>×—×™×©×•×‘ ×”××—×•×– ×”×’×•×œ××™:</label><input type="text" id="grossPercent" /></div>
          <div><label>×¡×”"×› ×ª×‘×™×¢×” (×××•×©×¨):</label><input type="text" id="authorizedClaim" /></div>
        </div>
      </div>
    </div>

    <!-- COLLAPSIBLE CONTACT DATA -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('contactData')">× ×ª×•× ×™ ×”×ª×§×©×¨×•×ª (×”×¦×’/×”×¡×ª×¨)</button>
      <div id="contactData" style="display:none;">
        <div class="form-grid">
          <div><label>×©× ×‘×¢×œ ×”×¨×›×‘:</label><input type="text" id="ownerName" /></div>
          <div><label>×›×ª×•×‘×ª ×‘×¢×œ ×”×¨×›×‘:</label><input type="text" id="ownerAddress" /></div>
          <div><label>×˜×œ×¤×•×Ÿ ×‘×¢×œ ×”×¨×›×‘:</label><input type="text" id="ownerPhone" /></div>
          <div><label>×—×‘×¨×ª ×‘×™×˜×•×—:</label><input type="text" id="insuranceCompany" /></div>
          <div><label>××™××™×™×œ ×—×‘×¨×ª ×‘×™×˜×•×—:</label><input type="text" id="insuranceEmail" /></div>
          <div><label>×¡×•×›×Ÿ ×‘×™×˜×•×—:</label><input type="text" id="insuranceAgent" /></div>
          <div><label>×˜×œ×¤×•×Ÿ ×¡×•×›×Ÿ ×‘×™×˜×•×—:</label><input type="text" id="agentPhone" /></div>
          <div><label>××™××™×™×œ ×¡×•×›×Ÿ ×‘×™×˜×•×—:</label><input type="text" id="agentEmail" /></div>
        </div>
      </div>
    </div>

    <!-- DAMAGE CENTERS SUMMARY SECTION -->
    <div class="form-section">
      <h3>×¡×™×›×•× ××•×§×“×™ × ×–×§</h3>
      <div id="damageCentersSummary">
        <div style="background: #f8f9fa; border-radius: 6px; padding: 15px; min-height: 50px;" id="damageCentersContent">
          <div style="color: #666; text-align: center;">×˜×•×¢×Ÿ × ×ª×•× ×™ ××•×§×“×™ × ×–×§...</div>
        </div>
      </div>
    </div>

    <!-- DEPRECIATION CALCULATION SECTION -->
    <div class="form-section" id="depreciationSection">
      <h3>×—×™×©×•×‘ ×™×¨×™×“×ª ×¢×¨×š ×œ×¤×™ ××•×§×“×™ × ×–×§</h3>
      <div style="display:grid; grid-template-columns:1fr 1fr 120px 120px 80px; gap:14px; margin-bottom:10px;">
        <div><label>×”×—×œ×§ ×”× ×™×–×•×§:</label></div>
        <div><label>××”×•×ª ×”×ª×™×§×•×Ÿ:</label></div>
        <div><label>% ×™×¨×™×“×ª ×¢×¨×š:</label></div>
        <div><label>×¢×¨×š ×‘-â‚ª:</label></div>
        <div><label>×¤×¢×•×œ×•×ª:</label></div>
      </div>
      <div id="depreciationBulkTable"></div>
      <button class="btn add" type="button" onclick="addDepField()">×”×•×¡×£ ×©×“×”</button>
      <div style="margin-top:14px;">
        <label>×™×¨×™×“×ª ×¢×¨×š ×’×œ×•×‘×œ×™:</label>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:14px;">
          <input type="text" id="globalDep1" placeholder="% ×™×¨×™×“×ª ×¢×¨×š" />
          <input type="text" id="globalDepValue" placeholder="×¢×¨×š ×‘-â‚ª" readonly style="background:#f4f6fa;" />
        </div>
      </div>
      <div style="margin-top:14px;">
        <label>×™××™ ××•×¡×š ××©×•×¢×¨×™×:</label>
        <input type="number" id="garageDays" placeholder="××¡×¤×¨ ×™××™ ×¢×‘×•×“×”" style="width: 200px;" />
      </div>
    </div>

    <!-- SUMMARY SECTION WITH ORANGE STYLING -->
    <div class="form-section" style="background: linear-gradient(135deg, #ff8c00 0%, #ff7300 100%); color: white; border-radius: 12px; padding: 20px;">
      <h3 style="color: white; text-align: center; margin-bottom: 20px; font-size: 26px;">×¡×™×›×•× ×”××•××“×Ÿ</h3>
      
      <div style="background: rgba(255,255,255,0.95); color: #333; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
        <div class="form-grid">
          <div>
            <label style="color: #333;">×¡×•×’ ×“×•"×—:</label>
            <input type="text" id="reportType" style="background: #f0f0f0; color: #333;" readonly />
          </div>
          <div>
            <label style="color: #333;">×¢×¨×š ×”×©×•×§ ×©×œ ×”×¨×›×‘:</label>
            <input type="text" id="sumMarketValue" style="background: white; color: #333;" />
          </div>
        </div>
        <div class="form-grid">
          <div>
            <label style="color: #333;">×¡×”×´×› ×ª×‘×™×¢×”:</label>
            <input type="text" id="sumClaim" style="background: white; color: #333;" />
          </div>
          <div>
            <label style="color: #333;">×¤×™×¦×•×™ ×‘×’×™×Ÿ ×™×¨×™×“×ª ×¢×¨×š:</label>
            <input type="text" id="depCompensation" style="background: white; color: #333;" />
          </div>
        </div>
      </div>
      
      <!-- ×ª×•×¡×¤×•×ª ×•×”×•×¨×“×•×ª SECTION - MOVED BEFORE VAT CALCULATION -->
      <div style="background: rgba(255,255,255,0.95); color: #333; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
        <label style="color: #333; font-weight: bold; margin-bottom: 10px; display: block;">×ª×•×¡×¤×•×ª ×•×”×•×¨×“×•×ª:</label>
        <div class="levi-adjustments-section" id="leviAdjustments-estimate" style="background: #f8f9fa; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
          <div style="font-weight: bold; margin-bottom: 8px; color: #495057; font-size: 14px;">×”×ª×××•×ª ××“×•"×— ×œ×•×™ ×™×¦×—×§:</div>
          <div class="levi-adjustments-grid" style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 8px; font-size: 13px;">
            <div style="font-weight: bold;">××”×•×ª ×”×”×ª×××”</div>
            <div style="font-weight: bold;">××—×•×–</div>
            <div style="font-weight: bold;">×¢×¨×š (â‚ª)</div>
          </div>
          <div id="leviAdjustmentsRows-estimate"></div>
        </div>
        <div style="margin-bottom: 8px; font-weight: bold; color: #495057; font-size: 14px;">×ª×•×¡×¤×•×ª × ×•×¡×¤×•×ª:</div>
        <div class="form-grid" id="sumAdditionsGridEstimate"></div>
        <button class="btn add" type="button" onclick="addCustomSummaryField('estimate')" style="color: #333; background: #28a745;">×”×•×¡×£ ×©×“×” × ×•×¡×£</button>
      </div>
      
      <!-- VAT AND TOTAL CALCULATION SECTION -->
      <div style="background: rgba(255,255,255,0.95); color: #333; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
        <div class="form-grid">
          <div>
            <label style="color: #333;">××¢×´× (18%):</label>
            <input type="text" id="sumVAT" style="background: white; color: #333;" readonly />
          </div>
          <div>
            <label style="color: #333;">×¡×”×´×› ×ª×‘×™×¢×”:</label>
            <input type="text" id="sumTotalClaim" style="background: #e8f5e8; color: #333; font-weight: bold;" readonly />
          </div>
        </div>
      </div>
    </div>

    <!-- ADDITIONAL NOTES -->
    <div class="form-section">
      <h3>×”×¢×¨×•×ª × ×•×¡×¤×•×ª ×œ××•××“×Ÿ</h3>
      <textarea id="additional-notes" placeholder="×”×•×¡×£ ×”×¢×¨×•×ª, ×”××œ×¦×•×ª ××• ××™×“×¢ × ×•×¡×£ ×œ××•××“×Ÿ..." style="min-height: 80px;"></textarea>
    </div>

    <!-- Navigation Buttons -->
    <div class="form-section">
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
        <button type="button" class="nav-btn save-btn" onclick="saveEstimate()">×©××•×¨ ××•××“×Ÿ</button>
        <button type="button" class="nav-btn preview-btn" onclick="previewEstimate()">×ª×¦×•×’×” ××§×“×™××”</button>
        <button type="button" class="nav-btn generate-btn" onclick="generateEstimate()">×¦×•×¨ ×“×•"×— ××•××“×Ÿ</button>
        <button type="button" class="nav-btn back-btn" onclick="window.location.href='selection.html'">×—×–×•×¨ ×œ×“×£ ×”×‘×—×™×¨×”</button>
      </div>
    </div>

    <!-- LEGAL TEXT SECTION - EDITABLE -->
    <div class="form-section" id="legal-text">
      <h3>×˜×§×¡×˜ ××©×¤×˜×™ ×œ××•××“×Ÿ</h3>
      <div style="margin-bottom: 10px;">
        <button type="button" onclick="loadLegalTextFromVault()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-left: 10px;">×˜×¢×Ÿ ××”×›×¡×¤×ª</button>
        <button type="button" onclick="resetLegalText()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">××™×¤×•×¡ ×˜×§×¡×˜</button>
      </div>
      <textarea id="legal-text-content" style="width: 100%; min-height: 200px; padding: 15px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8f9fa; line-height: 1.6; font-family: inherit; resize: vertical; box-sizing: border-box;" placeholder="×”×˜×§×¡×˜ ×”××©×¤×˜×™ ×™×˜×¢×Ÿ ×›××Ÿ ×¢× ×”× ×ª×•× ×™× ×”××¢×•×“×›× ×™×...">
        ×”×˜×§×¡×˜ ×”××©×¤×˜×™ ×™×˜×¢×Ÿ ×›××Ÿ ×¢× ×”× ×ª×•× ×™× ×”××¢×•×“×›× ×™×...
      </textarea>
      <div style="margin-top: 8px; font-size: 14px; color: #666;">
        ğŸ’¡ ×”×˜×§×¡×˜ × ×™×ª×Ÿ ×œ×¢×¨×™×›×” ×œ×¦×•×¨×š ×”×ª×××” ×œ×“×•×— ×”×¡×¤×¦×™×¤×™. ×”×©×™× ×•×™×™× ×œ× ×™×©×¤×™×¢×• ×¢×œ ×”×›×¡×¤×ª ×”××§×•×¨×™×ª.
      </div>
    </div>

    <div class="footer">All rights reserved Â© Carmel Cayouf</div>
  </div>

  
  <script>
    // Authentication check
    const auth = sessionStorage.getItem("auth");
    if (!auth) {
      alert("×”×’×™×©×” ×—×¡×•××” - ×× × ×”×ª×—×‘×¨ ×“×¨×š ×“×£ ×”×‘×™×ª");
      window.location.href = "index.html";
    }

    // FLOATING SCREENS TOGGLE FUNCTION - COPIED FROM DEPRECIATION MODULE
    window.toggleFloatingScreen = function(screenType) {
      console.log('Toggling floating screen:', screenType);
      
      const screens = {
        leviReport: () => {
          if (window.toggleLeviReport) {
            window.toggleLeviReport();
          } else {
            console.log('Levi report floating screen not available');
          }
        },
        carDetails: () => {
          if (window.toggleCarDetails) {
            window.toggleCarDetails();
          } else {
            console.log('Car details floating screen not available');
          }
        },
        internalBrowser: () => {
          if (window.showBrowserMenu) {
            showBrowserMenuUnderToggle();
          } else {
            console.log('Internal browser not available');
          }
        }
      };
      
      if (screens[screenType]) {
        screens[screenType]();
      } else {
        console.log('Unknown screen type:', screenType);
      }
    };

    // CUSTOM BROWSER MENU - COPIED FROM DEPRECIATION MODULE
    function showBrowserMenuUnderToggle() {
      const menu = document.createElement('div');
      menu.style.cssText = `
        position: fixed;
        top: 90px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 20px;
        z-index: 99999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        font-family: sans-serif;
        direction: rtl;
        min-width: 280px;
      `;
      
      menu.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 15px; color: #2c3e50; font-size: 16px;">×‘×—×¨ ××ª×¨ ×œ×¤×ª×™×—×”:</div>
        <button onclick="window.openInternalBrowser('car-part.co.il'); this.parentElement.remove();" style="width: 100%; padding: 12px; margin-bottom: 8px; border: none; background: #28a745; color: white; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 500;">
          ğŸ”§ Car Part - ×—×œ×§×™ ×¨×›×‘
        </button>
        <button onclick="window.openInternalBrowser('portal.levi-itzhak.co.il'); this.parentElement.remove();" style="width: 100%; padding: 12px; margin-bottom: 8px; border: none; background: #007bff; color: white; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 500;">
          ğŸ“Š ×¤×•×¨×˜×œ ×œ×•×™ ×™×¦×—×§
        </button>
        <button onclick="this.parentElement.remove();" style="width: 100%; padding: 10px; border: 1px solid #ccc; background: white; color: #666; border-radius: 6px; cursor: pointer; font-size: 14px;">
          ×‘×™×˜×•×œ
        </button>
      `;
      
      document.body.appendChild(menu);
      
      // Remove menu when clicking outside
      setTimeout(() => {
        document.addEventListener('click', function removeMenu(e) {
          if (!menu.contains(e.target)) {
            menu.remove();
            document.removeEventListener('click', removeMenu);
          }
        });
      }, 100);
    }

    // COLLAPSIBLE SECTION TOGGLE
    window.toggleSection = function(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        section.style.display = section.style.display === 'none' ? 'block' : 'none';
      }
    };

    // BUTTON FUNCTIONS - NO DEBUG ALERTS
    window.saveEstimate = function() {
      const selectedTypeElement = document.querySelector('input[name="estimate-type"]:checked');
      if (!selectedTypeElement) {
        alert('×× × ×‘×—×¨ ×¡×•×’ ××•××“×Ÿ');
        return;
      }
      
      const selectedType = selectedTypeElement.value;
      const additionalNotes = document.getElementById('additional-notes')?.value || '';
      
      // Get summary data
      const summaryData = {
        market_value: document.getElementById('sumMarketValue')?.value || '',
        total_claim: document.getElementById('sumClaim')?.value || '',
        vat: document.getElementById('sumVAT')?.value || '',
        total_with_vat: document.getElementById('sumTotalClaim')?.value || '',
        dep_compensation: document.getElementById('depCompensation')?.value || ''
      };
      
      // Get depreciation data
      const depreciationData = {
        global_percent: document.getElementById('globalDep1')?.value || '',
        global_value: document.getElementById('globalDepValue')?.value || '',
        bulk_items: []
      };
      
      // Collect depreciation bulk items
      const depRows = document.querySelectorAll('#depreciationBulkTable .dep-row');
      depRows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        if (inputs.length >= 4) {
          depreciationData.bulk_items.push({
            damaged_part: inputs[0].value,
            repair_type: inputs[1].value,
            percent: inputs[2].value,
            value: inputs[3].value
          });
        }
      });
      
      // Get legal text
      const legalText = document.getElementById('legal-text-content')?.value || '';
      
      // Save to helper
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      helper.estimate_type = selectedType;
      helper.estimate_notes = additionalNotes;
      helper.estimate_summary = summaryData;
      helper.estimate_depreciation = depreciationData;
      helper.estimate_legal_text = legalText;
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      alert('××•××“×Ÿ × ×©××¨ ×‘×”×¦×œ×—×”');
    };

    window.previewEstimate = function() {
      // First save all data
      window.saveEstimate();
      
      // Set report type and navigate
      sessionStorage.setItem('selectedReportType', 'estimate');
      window.location.href = 'estimate-validation.html';
    };

    window.generateEstimate = function() {
      // First save all data
      window.saveEstimate();
      
      // Set report type and navigate to final report generation
      sessionStorage.setItem('selectedReportType', 'estimate');
      window.location.href = 'estimate-report-builder.html';
    };

    // LOAD DATA FROM HELPER
    function loadDataFromHelper() {
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        // Load car details - AUTO-FILLED from helper data (pulled from helper)
        if (helper.car_details || helper.meta || helper.vehicle || helper.levi_report || helper.levisummary) {
          // Auto-fill plate number from multiple sources
          const plateValue = helper.meta?.plate || helper.car_details?.plate || helper.vehicle?.plate_number || '';
          document.getElementById('carPlate').value = plateValue;
          
          // Auto-fill manufacturer from multiple sources  
          const manufacturerValue = helper.car_details?.manufacturer || helper.vehicle?.manufacturer || helper.levi_report?.manufacturer || '';
          document.getElementById('carManufacturer').value = manufacturerValue;
          
          // Auto-fill model from multiple sources
          const modelValue = helper.car_details?.model || helper.vehicle?.model || helper.levi_report?.model || '';
          document.getElementById('carModel').value = modelValue;
          
          // Auto-fill year from multiple sources
          const yearValue = helper.car_details?.year || helper.vehicle?.year || helper.levi_report?.year || '';
          document.getElementById('carYear').value = yearValue;
          
          // Auto-fill base price from Levi report
          const basePriceValue = helper.levi_report?.base_price || helper.levisummary?.base_price || helper.car_details?.base_price || '';
          document.getElementById('carBasePrice').value = basePriceValue ? `â‚ª${parseFloat(basePriceValue).toLocaleString()}` : '';
          
          // Auto-fill market value from Levi report final price
          const marketValue = helper.levi_report?.final_price || helper.levisummary?.final_price || helper.expertise?.calculations?.market_value || '';
          document.getElementById('carMarketValue').value = marketValue ? `â‚ª${parseFloat(marketValue).toLocaleString()}` : '';
          
          // Auto-fill report date
          const reportDate = helper.levi_report?.report_date || helper.car_details?.report_date || new Date().toISOString().split('T')[0];
          document.getElementById('carReportDate').value = reportDate;
        }
        
        // Load claims data - AUTO-FILLED from helper calculations and damage data
        if (helper.expertise?.calculations || helper.damage_sections || helper.expertise?.damage_blocks) {
          const calc = helper.expertise?.calculations || {};
          
          // Auto-fill total claim from damage calculations
          const totalDamage = calc.total_damage || calculateTotalFromDamageSections(helper) || '';
          document.getElementById('totalClaim').value = totalDamage ? `â‚ª${parseFloat(totalDamage).toLocaleString()}` : '';
          
          // Auto-fill Levi price list from final price
          const leviPrice = helper.levi_report?.final_price || helper.levisummary?.final_price || '';
          document.getElementById('leviPriceList').value = leviPrice ? `â‚ª${parseFloat(leviPrice).toLocaleString()}` : '';
          
          // Auto-fill damage percentage
          const damagePercent = calc.damage_percent || calculateDamagePercentageFromValues(totalDamage, leviPrice) || '';
          document.getElementById('grossPercent').value = damagePercent ? `${damagePercent}%` : '';
          
          // Auto-fill authorized claim (same as total claim)
          document.getElementById('authorizedClaim').value = totalDamage ? `â‚ª${parseFloat(totalDamage).toLocaleString()}` : '';
        }
        
        // Load contact data - AUTO-FILLED from helper client data
        if (helper.client || helper.car_details) {
          // Auto-fill owner name from multiple sources
          const ownerName = helper.client?.name || helper.car_details?.owner || '';
          document.getElementById('ownerName').value = ownerName;
          
          // Auto-fill contact details
          document.getElementById('ownerAddress').value = helper.client?.address || helper.car_details?.ownerAddress || '';
          document.getElementById('ownerPhone').value = helper.client?.phone_number || helper.client?.phone || helper.car_details?.ownerPhone || '';
          
          // Auto-fill insurance details
          document.getElementById('insuranceCompany').value = helper.client?.insurance_company || helper.car_details?.insuranceCompany || '';
          document.getElementById('insuranceEmail').value = helper.client?.insurance_email || helper.car_details?.insuranceEmail || '';
          
          // Auto-fill agent details
          document.getElementById('insuranceAgent').value = helper.client?.insurance_agent || helper.car_details?.agentName || '';
          document.getElementById('agentPhone').value = helper.client?.insurance_agent_phone || helper.client?.agent_phone || helper.car_details?.agentPhone || '';
          document.getElementById('agentEmail').value = helper.client?.insurance_agent_email || helper.client?.agent_email || helper.car_details?.agentEmail || '';
        }
        
        // Update page title with plate
        document.getElementById('pageTitle').textContent = `×¨×›×‘ ××¡. ${helper.meta?.plate || helper.car_details?.plate || '...'}`;
        
        // Load summary data
        loadSummaryData(helper);
        
        // Load depreciation data
        loadDepreciationData(helper);
        
        // Load damage centers summary
        loadDamageCentersSummary(helper);
        
        // Load Levi adjustments
        loadLeviAdjustments(helper);
        
        // Add change listeners for all editable fields
        addFieldChangeListeners();
        
      } catch (error) {
        console.error('Error loading data from helper:', error);
      }
    }

    // LOAD SUMMARY DATA AND CALCULATIONS
    function loadSummaryData(helper) {
      try {
        // Set report type based on estimate type selection
        const selectedType = document.querySelector('input[name="estimate-type"]:checked')?.value || '××•×‘×“×Ÿ_×œ×”×œ×›×”';
        const reportTypeText = selectedType === '××•×‘×“×Ÿ_×œ×”×œ×›×”' ? '××•××“×Ÿ ×¨××©×•× ×™ - ××•×‘×“×Ÿ ×œ×”×œ×›×”' : '××•××“×Ÿ ×¨××©×•× ×™ - ×˜×•×˜×œ×•×¡';
        document.getElementById('reportType').value = reportTypeText;
        
        // AUTO-FILL SUMMARY DATA FROM ALL SOURCES - PROPERLY LINKED
        // Market Value - ALWAYS from Levi final price
        const marketValue = helper.levi_report?.final_price || helper.levisummary?.final_price || helper.expertise?.calculations?.market_value || 0;
        document.getElementById('sumMarketValue').value = marketValue ? `â‚ª${parseFloat(marketValue).toLocaleString()}` : '';
        
        // Total Claim - from damage calculations or sections
        const totalClaim = helper.expertise?.calculations?.total_damage || calculateTotalFromDamageSections(helper) || 0;
        document.getElementById('sumClaim').value = totalClaim ? `â‚ª${parseFloat(totalClaim).toLocaleString()}` : '';
        
        // Depreciation Compensation - CALCULATE from global percentage
        const globalDepPercent = parseFloat(helper.estimate_depreciation?.global_percent?.replace('%', '')) || 0;
        const depCompensation = marketValue * (globalDepPercent / 100);
        document.getElementById('depCompensation').value = depCompensation ? `â‚ª${Math.round(depCompensation).toLocaleString()}` : '';
        
        // Calculate subtotal (claim + depreciation compensation)
        const subtotal = parseFloat(totalClaim) + parseFloat(depCompensation);
        
        // Calculate VAT (18% on subtotal)
        const vat = subtotal * 0.18;
        document.getElementById('sumVAT').value = vat ? `â‚ª${Math.round(vat).toLocaleString()}` : '';
        
        // Calculate final total (subtotal + VAT)
        const finalTotal = subtotal + vat;
        document.getElementById('sumTotalClaim').value = finalTotal ? `â‚ª${Math.round(finalTotal).toLocaleString()}` : '';
        
        // Load saved estimate notes if available
        if (helper.estimate_notes) {
          document.getElementById('additional-notes').value = helper.estimate_notes;
        }
        
        // Load garage days from helper - PROPERLY LINKED
        const garageDays = helper.estimate_work_days || helper.expertise?.depreciation?.work_days || '';
        if (garageDays && document.getElementById('garageDays')) {
          document.getElementById('garageDays').value = garageDays;
        }
        
        // Load global depreciation percentage - PROPERLY LINKED
        const globalDepPercent = helper.estimate_depreciation?.global_percent || helper.expertise?.depreciation?.global_percent || '';
        if (globalDepPercent && document.getElementById('globalDep1')) {
          document.getElementById('globalDep1').value = globalDepPercent;
        }
        
        // Load saved legal text if available, otherwise load from vault
        if (helper.estimate_legal_text) {
          document.getElementById('legal-text-content').value = helper.estimate_legal_text;
        } else {
          // Load default legal text from vault on first load
          setTimeout(loadLegalTextFromVault, 500); // Delay to ensure all fields are loaded
        }
        
        // Add event listeners for real-time calculations
        addSummaryCalculationListeners();
        
      } catch (error) {
        console.error('Error loading summary data:', error);
      }
    }

    // ADD CALCULATION LISTENERS FOR SUMMARY WITH MATH.JS - CORRECTED LOGIC
    function addSummaryCalculationListeners() {
      const sumMarketValueInput = document.getElementById('sumMarketValue');
      const sumClaimInput = document.getElementById('sumClaim');
      const depCompensationInput = document.getElementById('depCompensation');
      const sumVATInput = document.getElementById('sumVAT');
      const sumTotalInput = document.getElementById('sumTotalClaim');

      function calculateSummaryTotals() {
        try {
          // Auto-fill market value from car details market price
          const carMarketValue = document.getElementById('carMarketValue')?.value.replace(/[â‚ª,]/g, '') || '0';
          if (carMarketValue && carMarketValue !== '0' && sumMarketValueInput) {
            sumMarketValueInput.value = `â‚ª${parseFloat(carMarketValue).toLocaleString()}`;
          }
          
          // Get values - market price + claim + compensation = total
          const marketValue = parseFloat(sumMarketValueInput?.value.replace(/[â‚ª,]/g, '') || '0') || 0;
          const claimValue = parseFloat(sumClaimInput?.value.replace(/[â‚ª,]/g, '') || '0') || 0;
          const depValue = parseFloat(depCompensationInput?.value.replace(/[â‚ª,]/g, '') || '0') || 0;
          
          // PROPERLY LINK DEPRECIATION COMPENSATION TO GLOBAL PERCENTAGE
          // Auto-calculate depreciation compensation from global percentage
          const globalDepPercent = parseFloat(document.getElementById('globalDep1')?.value?.replace('%', '') || '0');
          if (globalDepPercent > 0 && marketValue > 0) {
            const calculatedDepValue = (marketValue * globalDepPercent) / 100;
            if (depCompensationInput && Math.abs(depValue - calculatedDepValue) > 1) {
              depCompensationInput.value = `â‚ª${Math.round(calculatedDepValue).toLocaleString()}`;
            }
          }
          
          // Calculate subtotal: claim + compensation (market price is separate)
          const finalDepValue = parseFloat(depCompensationInput?.value.replace(/[â‚ª,]/g, '') || '0') || 0;
          const subtotal = claimValue + finalDepValue;
          
          // Automatic calculation with math.js - Calculate VAT (18% on subtotal)
          const vatRate = 0.18;
          const vat = Math.round(subtotal * vatRate);
          
          // Calculate final total (subtotal + VAT) - automatic calculation with math.js
          const total = subtotal + vat;
          
          // Update readonly fields with formatted values - auto-filled from relevant fields
          if (sumVATInput) {
            sumVATInput.value = vat ? `â‚ª${vat.toLocaleString()}` : '';
            sumVATInput.readOnly = true;
            sumVATInput.style.background = '#f4f6fa';
          }
          
          if (sumTotalInput) {
            sumTotalInput.value = total ? `â‚ª${total.toLocaleString()}` : '';
            sumTotalInput.readOnly = true;
            sumTotalInput.style.background = '#e8f5e8';
          }
          
          
        } catch (error) {
          console.error('Error in summary calculations:', error);
        }
      }

      // Add listeners to trigger calculations for all relevant fields
      if (sumMarketValueInput) {
        sumMarketValueInput.addEventListener('input', calculateSummaryTotals);
      }
      if (sumClaimInput) {
        sumClaimInput.addEventListener('input', calculateSummaryTotals);
      }
      if (depCompensationInput) {
        depCompensationInput.addEventListener('input', calculateSummaryTotals);
      }
      
      // Auto-update when car market value changes
      const carMarketValueInput = document.getElementById('carMarketValue');
      if (carMarketValueInput) {
        carMarketValueInput.addEventListener('input', calculateSummaryTotals);
      }
      
      // Add listeners for custom additions if they exist
      function addCustomFieldListeners() {
        const customFields = document.querySelectorAll('#sumAdditionsGridEstimate input');
        customFields.forEach(field => {
          field.addEventListener('input', calculateSummaryTotals);
        });
      }
      
      // Initial calculation and setup
      calculateSummaryTotals();
      addCustomFieldListeners();
      
      // Re-add listeners when custom fields are added
      const originalAddField = window.addCustomSummaryField;
      window.addCustomSummaryField = function(summaryType) {
        originalAddField(summaryType);
        setTimeout(addCustomFieldListeners, 100);
      };
    }

    // LOAD DEPRECIATION DATA
    function loadDepreciationData(helper) {
      try {
        // Load saved depreciation data if available
        if (helper.estimate_depreciation) {
          // Load global depreciation
          document.getElementById('globalDep1').value = helper.estimate_depreciation.global_percent || '';
          document.getElementById('globalDepValue').value = helper.estimate_depreciation.global_value || '';
          
          // Load bulk depreciation table
          if (helper.estimate_depreciation.bulk_items) {
            helper.estimate_depreciation.bulk_items.forEach(item => {
              addDepField(item);
            });
          }
        }
      } catch (error) {
        console.error('Error loading depreciation data:', error);
      }
    }

    // LOAD DAMAGE CENTERS SUMMARY
    function loadDamageCentersSummary(helper) {
      try {
        const damageCentersContent = document.getElementById('damageCentersContent');
        
        if (helper.expertise?.damage_blocks && helper.expertise.damage_blocks.length > 0) {
          let summaryHTML = '<div style="display: grid; gap: 10px;">';
          
          helper.expertise.damage_blocks.forEach((block, index) => {
            const centerNum = index + 1;
            const centerName = block.damage_center_name || `××•×§×“ × ×–×§ ${centerNum}`;
            const workCosts = block.work_cost || 0;
            const partsCosts = block.parts_cost || 0;
            const repairsCosts = workCosts + partsCosts;
            const totalWithVAT = repairsCosts * 1.18;
            
            summaryHTML += `
              <div style="background: white; border-radius: 6px; padding: 12px; border: 1px solid #e2e8f0;">
                <div style="font-weight: bold; color: #1e3a8a; margin-bottom: 8px;">××•×§×“ ${centerNum}: ${centerName}</div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 14px;">
                  <div><strong>×¢×‘×•×“×•×ª:</strong> â‚ª${workCosts.toLocaleString()}</div>
                  <div><strong>×—×œ×¤×™×:</strong> â‚ª${partsCosts.toLocaleString()}</div>
                  <div><strong>×ª×™×§×•× ×™×:</strong> â‚ª${repairsCosts.toLocaleString()}</div>
                  <div><strong>×›×•×œ×œ ××¢"×:</strong> â‚ª${Math.round(totalWithVAT).toLocaleString()}</div>
                </div>
              </div>
            `;
          });
          
          summaryHTML += '</div>';
          damageCentersContent.innerHTML = summaryHTML;
        } else {
          damageCentersContent.innerHTML = '<div style="color: #666; text-align: center;">×œ× × ××¦××• × ×ª×•× ×™ ××•×§×“×™ × ×–×§</div>';
        }
      } catch (error) {
        console.error('Error loading damage centers summary:', error);
        document.getElementById('damageCentersContent').innerHTML = '<div style="color: #dc3545; text-align: center;">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ××•×§×“×™ × ×–×§</div>';
      }
    }

    // LOAD LEVI ADJUSTMENTS
    function loadLeviAdjustments(helper) {
      try {
        const adjustmentsContainer = document.getElementById('leviAdjustmentsRows-estimate');
        
        if (helper.levi_report?.adjustments && helper.levi_report.adjustments.length > 0) {
          let adjustmentsHTML = '';
          
          helper.levi_report.adjustments.forEach((adjustment, index) => {
            adjustmentsHTML += `
              <div class="levi-adjustment-row" style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 8px; padding: 4px 0; border-bottom: 1px solid #e9ecef;">
                <div style="font-size: 13px;">${adjustment.description || '×”×ª×××”'}</div>
                <div style="font-size: 13px; text-align: center;">${adjustment.percentage || '0'}%</div>
                <div style="font-size: 13px; text-align: center;">â‚ª${adjustment.value ? adjustment.value.toLocaleString() : '0'}</div>
              </div>
            `;
          });
          
          adjustmentsContainer.innerHTML = adjustmentsHTML;
        } else {
          adjustmentsContainer.innerHTML = '<div style="color: #666; text-align: center; padding: 10px; font-size: 13px;">×œ× × ××¦××• ×”×ª×××•×ª ××“×•"×— ×œ×•×™ ×™×¦×—×§</div>';
        }
      } catch (error) {
        console.error('Error loading Levi adjustments:', error);
        document.getElementById('leviAdjustmentsRows-estimate').innerHTML = '<div style="color: #dc3545; text-align: center; padding: 10px; font-size: 13px;">×©×’×™××” ×‘×˜×¢×™× ×ª ×”×ª×××•×ª ×œ×•×™ ×™×¦×—×§</div>';
      }
    }

    // ADD CUSTOM SUMMARY FIELD
    function addCustomSummaryField(summaryType) {
      const container = document.getElementById('sumAdditionsGridEstimate');
      const fieldIndex = container.children.length;
      
      const fieldRow = document.createElement('div');
      fieldRow.className = 'custom-summary-row';
      fieldRow.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr auto; gap: 8px; margin-bottom: 8px;';
      
      fieldRow.innerHTML = `
        <input type="text" placeholder="×©× ×”×©×“×”" style="font-size: 14px;" />
        <input type="text" placeholder="×¢×¨×š" style="font-size: 14px;" />
        <button type="button" onclick="this.parentElement.remove()" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">××—×§</button>
      `;
      
      container.appendChild(fieldRow);
    }

    // ADD FIELD CHANGE LISTENERS
    function addFieldChangeListeners() {
      // Car details listeners
      ['carPlate', 'carManufacturer', 'carModel', 'carYear', 'carBasePrice', 'carMarketValue', 'carReportDate'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('change', updateHelperFromField);
        }
      });
      
      // Claims data listeners
      ['totalClaim', 'leviPriceList', 'grossPercent', 'authorizedClaim'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('change', updateHelperFromField);
        }
      });
      
      // Contact data listeners
      ['ownerName', 'ownerAddress', 'ownerPhone', 'insuranceCompany', 'insuranceEmail', 'insuranceAgent', 'agentPhone', 'agentEmail'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('change', updateHelperFromField);
        }
      });
      
      // Summary data listeners
      ['sumMarketValue', 'sumClaim', 'sumVAT', 'sumTotalClaim', 'depCompensation'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('change', updateHelperFromField);
        }
      });
      
      // Estimate type change listener
      document.querySelectorAll('input[name="estimate-type"]').forEach(radio => {
        radio.addEventListener('change', function() {
          updateReportType();
          loadLegalText();
        });
      });
    }

    // UPDATE HELPER FROM FIELD
    function updateHelperFromField(event) {
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        const fieldId = event.target.id;
        const value = event.target.value;
        
        // Update the appropriate helper section based on field
        if (['carPlate', 'carManufacturer', 'carModel', 'carYear', 'carBasePrice', 'carMarketValue', 'carReportDate'].includes(fieldId)) {
          helper.car_details = helper.car_details || {};
          const mapping = {
            'carPlate': 'plate',
            'carManufacturer': 'manufacturer',
            'carModel': 'model',
            'carYear': 'year',
            'carBasePrice': 'base_price',
            'carMarketValue': 'market_value',
            'carReportDate': 'report_date'
          };
          helper.car_details[mapping[fieldId]] = value;
          
          // Also update meta for plate
          if (fieldId === 'carPlate') {
            helper.meta = helper.meta || {};
            helper.meta.plate = value;
          }
        } else if (['ownerName', 'ownerAddress', 'ownerPhone', 'insuranceCompany', 'insuranceEmail', 'insuranceAgent', 'agentPhone', 'agentEmail'].includes(fieldId)) {
          helper.client = helper.client || {};
          const mapping = {
            'ownerName': 'name',
            'ownerAddress': 'address',
            'ownerPhone': 'phone',
            'insuranceCompany': 'insurance_company',
            'insuranceEmail': 'insurance_email',
            'insuranceAgent': 'insurance_agent',
            'agentPhone': 'agent_phone',
            'agentEmail': 'agent_email'
          };
          helper.client[mapping[fieldId]] = value;
        } else if (['sumMarketValue', 'sumClaim', 'sumVAT', 'sumTotalClaim', 'depCompensation'].includes(fieldId)) {
          helper.estimate_summary = helper.estimate_summary || {};
          const mapping = {
            'sumMarketValue': 'market_value',
            'sumClaim': 'total_claim',
            'sumVAT': 'vat',
            'sumTotalClaim': 'total_with_vat',
            'depCompensation': 'dep_compensation'
          };
          helper.estimate_summary[mapping[fieldId]] = value;
        }
        
        // Save updated helper
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        // Update page title if plate changed
        if (fieldId === 'carPlate') {
          document.getElementById('pageTitle').textContent = `×¨×›×‘ ××¡. ${value || '...'}`;
        }
        
        // Update legal text with new data
        loadLegalText();
        
      } catch (error) {
        console.error('Error updating helper from field:', error);
      }
    }

    // UPDATE REPORT TYPE
    function updateReportType() {
      const selectedType = document.querySelector('input[name="estimate-type"]:checked')?.value || '××•×‘×“×Ÿ_×œ×”×œ×›×”';
      const reportTypeText = selectedType === '××•×‘×“×Ÿ_×œ×”×œ×›×”' ? '××•××“×Ÿ ×¨××©×•× ×™ - ××•×‘×“×Ÿ ×œ×”×œ×›×”' : '××•××“×Ÿ ×¨××©×•× ×™ - ×˜×•×˜×œ×•×¡';
      document.getElementById('reportType').value = reportTypeText;
    }

    // ADD DEPRECIATION FIELD
    function addDepField(data = null) {
      const container = document.getElementById('depreciationBulkTable');
      const index = container.children.length;
      
      const row = document.createElement('div');
      row.className = 'dep-row';
      row.style.cssText = 'display:grid; grid-template-columns:1fr 1fr 120px 120px 80px; gap:14px; margin-bottom:10px;';
      
      row.innerHTML = `
        <div><input type="text" placeholder="×”×—×œ×§ ×”× ×™×–×•×§" value="${data?.damaged_part || ''}" /></div>
        <div><input type="text" placeholder="××”×•×ª ×”×ª×™×§×•×Ÿ" value="${data?.repair_type || ''}" /></div>
        <div><input type="text" placeholder="% ×™×¨×™×“×ª ×¢×¨×š" value="${data?.percent || ''}" /></div>
        <div><input type="text" placeholder="×¢×¨×š ×‘-â‚ª" value="${data?.value || ''}" readonly style="background:#f4f6fa;" /></div>
        <div><button type="button" onclick="this.parentElement.parentElement.remove()" style="background:#dc3545; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">××—×§</button></div>
      `;
      
      container.appendChild(row);
      
      // Add listeners for calculation
      const percentInput = row.querySelector('input[placeholder="% ×™×¨×™×“×ª ×¢×¨×š"]');
      const valueInput = row.querySelector('input[placeholder="×¢×¨×š ×‘-â‚ª"]');
      
      percentInput.addEventListener('input', function() {
        let percent = parseFloat(this.value) || 0;
        
        // Auto-add % symbol if not present and user enters a number
        if (this.value && !this.value.includes('%') && !isNaN(percent)) {
          this.value = percent + '%';
        }
        
        // Calculate value from market price automatically
        const marketValueField = document.getElementById('carMarketValue') || document.getElementById('sumMarketValue');
        const marketValueStr = marketValueField?.value.replace(/[â‚ª,]/g, '') || '0';
        const marketValue = parseFloat(marketValueStr) || 0;
        
        const calculatedValue = (marketValue * percent) / 100;
        valueInput.value = calculatedValue ? `â‚ª${Math.round(calculatedValue).toLocaleString()}` : '';
      });
    }

    // LOAD LEGAL TEXT FROM VAULT SYSTEM
    function loadLegalText() {
      const selectedType = document.querySelector('input[name="estimate-type"]:checked')?.value || '××•×‘×“×Ÿ_×œ×”×œ×›×”';
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Legal text vault from final report legal texts vault.md - EXACT COPY
      const legalTextsVault = {
        '××•×‘×“×Ÿ_×œ×”×œ×›×”': `×¢×¨×š ×”×¨×›×‘ ×”××¦×•×™×™×Ÿ ×œ×¢×™×œ ×‘×”×ª×× ×œ××—×™×¨×•×Ÿ ×•××™× ×• ××ª×™×™×—×¡ ×œ××§×•×¨×™×•×ª ×”×¨×›×‘ ×‘×¢×‘×¨ ×•××¨×•×¢ ×ª××•× ×ª×™.

×”×¦×¢×” ×–×• ××™× ×” ×¡×•×¤×™×ª ×•×™×ª×›×Ÿ ×©×™× ×•×™×™× ×‘××”×œ×š ×ª×™×§×•×Ÿ ×”×¨×›×‘.

×”×¢×¨×›×ª× ×• ××ª×™×™×—×¡×ª ×œ× ×–×§×™× ×›×¤×™ ×©×”×•×¦×’×• ×‘×¤× ×™× ×•, ×•×œ× ×¡×™×‘×•×ª ×”××§×¨×” ×›×¤×™ ×©×ª×•××¨×• ×œ× ×• ×¢"×™ ×‘×¢×œ ×”×¨×›×‘ ××©×¨ ×œ×“×‘×¨×™×•.

×§×•×“ ×“×’× ×¨×™×©×™×•×Ÿ ×”×¨×›×‘ × ×‘×“×§ ×‘×”×ª×× ×œ×˜×‘×œ×ª ×”××¨×” ×©×œ ×œ×•×™ ×™×¦×—×§ ×•× ××¦× %×§×•×“_×“×’×%.

××—×•×– ×”× ×–×§ ×‘×¨×›×‘ ×”× "×œ ×”×•× %××—×•×–_× ×–×§% ××¢×¨×š ×”×¨×›×‘.

×”×¦×¢×” ×–×• ××™× ×” ×›×•×œ×œ×ª × ×–×§×™× ×‘×œ×ª×™ × ×¨××™× ××¨××© ×”×¢×œ×•×œ×™× ×œ×”×ª×’×œ×•×ª ×‘××”×œ×š ×¤×™×¨×•×§ ×•/××• ×ª×™×§×•×Ÿ.

×œ×”×¢×¨×›×ª×™× ×• ×™×¨×™×“×ª ×¢×¨×š ×¦×¤×•×™×” ×› %×™×¨×™×“×ª_×¢×¨×š% ××¢×¨×š ×”×¨×›×‘ ×”× "×œ ×××™×¨×•×¢ ×”× ×“×•×Ÿ.

×œ×˜×¢× ×ª ×‘×¢×œ ×”×¨×›×‘ %××•×§×“×™_× ×–×§% ××•×§×“×™ ×”× ×–×§ ×××™×¨×•×¢ ×”× ×“×•×Ÿ.

×œ××•×¨ ×”×™×§×£ ×”× ×–×§×™× ×× ×• ×××œ×¦×™× ×œ×¡×œ×§ ××ª ×”×ª×‘×™×¢×” ×”× "×œ ×¢×œ ×‘×¡×™×¡ "××•×‘×“×Ÿ ×œ×”×œ×›×”" ×œ×œ× ×ª×™×§×•×Ÿ ×‘×¤×•×¢×œ.

×œ×”×¢×¨×›×ª×™× ×• ×–××Ÿ ×”×©×”×™×™×” ×‘××•×¡×š ×œ×¦×•×¨×š ×ª×™×§×•×Ÿ %×™××™_××•×¡×š% ×™××™ ×¢×‘×•×“×”.`,
        
        '×˜×•×˜×œ×•×¡': `×—×•×•×ª ×“×¢×ª×™× ×• ××ª×‘×¦×¢×ª ×‘×˜×¨× ×ª×™×§×•× ×™× ×‘×¤×•×¢×œ ×•××™× ×” ×›×•×œ×œ×ª × ×–×§×™× ×¡××•×™×™×.

×‘×”×ª×× ×œ×‘×“×™×§×” ×”× ×–×§ ×‘×¨×›×‘ ××•×¢×¨×š ×‘×™×•×ª×¨ ×-60% ××¢×¨×š ×”×¨×›×‘, ×•××©×›×š ×”×¨×›×‘ ××¡×•×•×’ ×›×˜×•×˜×œ×•×¡.

×¢×¨×š ×”×¨×›×‘ ×”××—×•×©×‘ ×œ×¤×™ ××—×™×¨×•×Ÿ ×œ×•×™ ×™×¦×—×§: %×©×•×•×™_×¨×›×‘%.

×©×•×•×™ ×”×©×¨×™×“×™×: %×©×•×•×™_×©×¨×™×“×™×%.

× ×™×›×•×™ ×™×¨×™×“×ª ×¢×¨×š: %×™×¨×™×“×ª_×¢×¨×š%

×”×¢×¨×›×ª × ×–×§×™× ××‘×•×¡×¡×ª ×¢×œ ×”× ×ª×•× ×™× ×©× ××¡×¨×• ×¢×´×™ ×‘×¢×œ ×”×¨×›×‘, ××©×¨ ×œ×“×‘×¨×™×•.

×”×¦×”×¨×”: ×× ×™ ×”×—×ª×´×: ×™×¨×•×Ÿ ×›×™×•×£, ×ª×¢×•×“×ª ×©×××™ ××¡' 1097. ×”× × ×™ × ×•×ª×Ÿ ××ª ×—×•×•×ª ×“×¢×ª×™ ×–×• ×‘××§×•× ×¢×“×•×ª ×‘×©×‘×•×¢×” ×‘×‘×™×ª ××©×¤×˜. ×”×“×™×Ÿ ×©×œ ×—×•×•×ª ×“×¢×ª ×–×• ×”×•× ×›×“×™×Ÿ ×¢×“×•×ª ×‘×©×‘×•×¢×”.`
      };
      
      let legalText = legalTextsVault[selectedType] || legalTextsVault['××•×‘×“×Ÿ_×œ×”×œ×›×”'];
      
      // COMPLETE placeholder mapping - ALL VARIABLES PROPERLY LINKED
      const placeholders = {
        '%××¡×¤×¨_×¨×›×‘%': document.getElementById('carPlate')?.value || helper.meta?.plate || '[××¡×¤×¨ ×¨×›×‘]',
        '%×ª×•×¦×¨×ª%': document.getElementById('carManufacturer')?.value || helper.car_details?.manufacturer || '[×ª×•×¦×¨×ª]',
        '%×“×’×%': document.getElementById('carModel')?.value || helper.car_details?.model || '[×“×’×]',
        '%×©× ×”%': document.getElementById('carYear')?.value || helper.car_details?.year || '[×©× ×”]',
        '%×‘×¢×œ_×¨×›×‘%': document.getElementById('ownerName')?.value || helper.client?.name || '[×©× ×‘×¢×œ ×”×¨×›×‘]',
        '%×§×•×“_×“×’×%': helper.car_details?.model_code || helper.levi_report?.model_code || '[×§×•×“ ×“×’×]',
        '%××—×•×–_× ×–×§%': calculateDamagePercentage() || helper.expertise?.calculations?.damage_percent || '[××—×•×– × ×–×§]',
        '%×™×¨×™×“×ª_×¢×¨×š%': document.getElementById('globalDep1')?.value || helper.estimate_depreciation?.global_percent || '[×™×¨×™×“×ª ×¢×¨×š]',
        '%××•×§×“×™_× ×–×§%': helper.expertise?.damage_blocks?.length || '[××¡×¤×¨ ××•×§×“×™×]',
        '%×™××™_××•×¡×š%': document.getElementById('garageDays')?.value || helper.estimate_work_days || helper.expertise?.depreciation?.work_days || '[×™××™ ××•×¡×š]',
        '%×©×•×•×™_×¨×›×‘%': document.getElementById('carMarketValue')?.value || document.getElementById('sumMarketValue')?.value || (helper.expertise?.calculations?.market_value ? `â‚ª${helper.expertise.calculations.market_value.toLocaleString()}` : '[×©×•×•×™ ×¨×›×‘]'),
        '%×©×•×•×™_×©×¨×™×“×™×%': helper.estimate_salvage_value ? `â‚ª${helper.estimate_salvage_value.toLocaleString()}` : '[×©×•×•×™ ×©×¨×™×“×™×]'
      };
      
      // Replace placeholders
      for (const [placeholder, value] of Object.entries(placeholders)) {
        legalText = legalText.replace(new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), value);
      }
      
      document.getElementById('legal-text-content').value = legalText;
    }

    // LOAD LEGAL TEXT FROM VAULT - SEPARATE FUNCTION FOR BUTTON
    function loadLegalTextFromVault() {
      const selectedType = document.querySelector('input[name="estimate-type"]:checked')?.value || '××•×‘×“×Ÿ_×œ×”×œ×›×”';
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Legal text vault - same as above
      const legalTextsVault = {
        '××•×‘×“×Ÿ_×œ×”×œ×›×”': `×¢×¨×š ×”×¨×›×‘ ×”××¦×•×™×™×Ÿ ×œ×¢×™×œ ×‘×”×ª×× ×œ××—×™×¨×•×Ÿ ×•××™× ×• ××ª×™×™×—×¡ ×œ××§×•×¨×™×•×ª ×”×¨×›×‘ ×‘×¢×‘×¨ ×•××¨×•×¢ ×ª××•× ×ª×™.

×”×¦×¢×” ×–×• ××™× ×” ×¡×•×¤×™×ª ×•×™×ª×›×Ÿ ×©×™× ×•×™×™× ×‘××”×œ×š ×ª×™×§×•×Ÿ ×”×¨×›×‘.

×”×¢×¨×›×ª× ×• ××ª×™×™×—×¡×ª ×œ× ×–×§×™× ×›×¤×™ ×©×”×•×¦×’×• ×‘×¤× ×™× ×•, ×•×œ× ×¡×™×‘×•×ª ×”××§×¨×” ×›×¤×™ ×©×ª×•××¨×• ×œ× ×• ×¢"×™ ×‘×¢×œ ×”×¨×›×‘ ××©×¨ ×œ×“×‘×¨×™×•.

×§×•×“ ×“×’× ×¨×™×©×™×•×Ÿ ×”×¨×›×‘ × ×‘×“×§ ×‘×”×ª×× ×œ×˜×‘×œ×ª ×”××¨×” ×©×œ ×œ×•×™ ×™×¦×—×§ ×•× ××¦× %×§×•×“_×“×’×%.

××—×•×– ×”× ×–×§ ×‘×¨×›×‘ ×”× "×œ ×”×•× %××—×•×–_× ×–×§% ××¢×¨×š ×”×¨×›×‘.

×”×¦×¢×” ×–×• ××™× ×” ×›×•×œ×œ×ª × ×–×§×™× ×‘×œ×ª×™ × ×¨××™× ××¨××© ×”×¢×œ×•×œ×™× ×œ×”×ª×’×œ×•×ª ×‘××”×œ×š ×¤×™×¨×•×§ ×•/××• ×ª×™×§×•×Ÿ.

×œ×”×¢×¨×›×ª×™× ×• ×™×¨×™×“×ª ×¢×¨×š ×¦×¤×•×™×” ×› %×™×¨×™×“×ª_×¢×¨×š% ××¢×¨×š ×”×¨×›×‘ ×”× "×œ ×××™×¨×•×¢ ×”× ×“×•×Ÿ.

×œ×˜×¢× ×ª ×‘×¢×œ ×”×¨×›×‘ %××•×§×“×™_× ×–×§% ××•×§×“×™ ×”× ×–×§ ×××™×¨×•×¢ ×”× ×“×•×Ÿ.

×œ××•×¨ ×”×™×§×£ ×”× ×–×§×™× ×× ×• ×××œ×¦×™× ×œ×¡×œ×§ ××ª ×”×ª×‘×™×¢×” ×”× "×œ ×¢×œ ×‘×¡×™×¡ "××•×‘×“×Ÿ ×œ×”×œ×›×”" ×œ×œ× ×ª×™×§×•×Ÿ ×‘×¤×•×¢×œ.

×œ×”×¢×¨×›×ª×™× ×• ×–××Ÿ ×”×©×”×™×™×” ×‘××•×¡×š ×œ×¦×•×¨×š ×ª×™×§×•×Ÿ %×™××™_××•×¡×š% ×™××™ ×¢×‘×•×“×”.`,
        
        '×˜×•×˜×œ×•×¡': `×—×•×•×ª ×“×¢×ª×™× ×• ××ª×‘×¦×¢×ª ×‘×˜×¨× ×ª×™×§×•× ×™× ×‘×¤×•×¢×œ ×•××™× ×” ×›×•×œ×œ×ª × ×–×§×™× ×¡××•×™×™×.

×‘×”×ª×× ×œ×‘×“×™×§×” ×”× ×–×§ ×‘×¨×›×‘ ××•×¢×¨×š ×‘×™×•×ª×¨ ×-60% ××¢×¨×š ×”×¨×›×‘, ×•××©×›×š ×”×¨×›×‘ ××¡×•×•×’ ×›×˜×•×˜×œ×•×¡.

×¢×¨×š ×”×¨×›×‘ ×”××—×•×©×‘ ×œ×¤×™ ××—×™×¨×•×Ÿ ×œ×•×™ ×™×¦×—×§: %×©×•×•×™_×¨×›×‘%.

×©×•×•×™ ×”×©×¨×™×“×™×: %×©×•×•×™_×©×¨×™×“×™×%.

× ×™×›×•×™ ×™×¨×™×“×ª ×¢×¨×š: %×™×¨×™×“×ª_×¢×¨×š%

×”×¢×¨×›×ª × ×–×§×™× ××‘×•×¡×¡×ª ×¢×œ ×”× ×ª×•× ×™× ×©× ××¡×¨×• ×¢×´×™ ×‘×¢×œ ×”×¨×›×‘, ××©×¨ ×œ×“×‘×¨×™×•.

×”×¦×”×¨×”: ×× ×™ ×”×—×ª×´×: ×™×¨×•×Ÿ ×›×™×•×£, ×ª×¢×•×“×ª ×©×××™ ××¡' 1097. ×”× × ×™ × ×•×ª×Ÿ ××ª ×—×•×•×ª ×“×¢×ª×™ ×–×• ×‘××§×•× ×¢×“×•×ª ×‘×©×‘×•×¢×” ×‘×‘×™×ª ××©×¤×˜. ×”×“×™×Ÿ ×©×œ ×—×•×•×ª ×“×¢×ª ×–×• ×”×•× ×›×“×™×Ÿ ×¢×“×•×ª ×‘×©×‘×•×¢×”.`
      };
      
      let legalText = legalTextsVault[selectedType] || legalTextsVault['××•×‘×“×Ÿ_×œ×”×œ×›×”'];
      
      // Enhanced placeholder mapping to actual field values
      const placeholders = {
        '%××¡×¤×¨_×¨×›×‘%': document.getElementById('carPlate')?.value || helper.meta?.plate || helper.car_details?.plate || '[××¡×¤×¨ ×¨×›×‘]',
        '%×ª×•×¦×¨×ª%': document.getElementById('carManufacturer')?.value || helper.car_details?.manufacturer || helper.vehicle?.manufacturer || '[×ª×•×¦×¨×ª]',
        '%×“×’×%': document.getElementById('carModel')?.value || helper.car_details?.model || helper.vehicle?.model || '[×“×’×]',
        '%×©× ×”%': document.getElementById('carYear')?.value || helper.car_details?.year || helper.vehicle?.year || '[×©× ×”]',
        '%×‘×¢×œ_×¨×›×‘%': document.getElementById('ownerName')?.value || helper.client?.name || helper.car_details?.owner || '[×©× ×‘×¢×œ ×”×¨×›×‘]',
        '%×§×•×“_×“×’×%': helper.car_details?.model_code || helper.levi_report?.model_code || helper.levisummary?.model_code || '[×§×•×“ ×“×’×]',
        '%××—×•×–_× ×–×§%': (helper.expertise?.calculations?.damage_percent || 0) + '%',
        '%×™×¨×™×“×ª_×¢×¨×š%': (document.getElementById('globalDep1')?.value || helper.estimate_depreciation?.global_percent || '0').replace('%', '') + '%',
        '%××•×§×“×™_× ×–×§%': (helper.expertise?.damage_blocks?.length || helper.damage_centers?.length || helper.damage_sections?.length || 0).toString(),
        '%×™××™_××•×¡×š%': document.getElementById('garageDays')?.value || helper.estimate_work_days || helper.expertise?.depreciation?.work_days || '[×™××™ ××•×¡×š]',
        '%×©×•×•×™_×¨×›×‘%': document.getElementById('sumMarketValue')?.value || document.getElementById('carMarketValue')?.value || (helper.levi_report?.final_price ? `â‚ª${parseFloat(helper.levi_report.final_price).toLocaleString()}` : '[×©×•×•×™ ×¨×›×‘]'),
        '%×©×•×•×™_×©×¨×™×“×™×%': helper.estimate_salvage_value ? `â‚ª${helper.estimate_salvage_value.toLocaleString()}` : '[×©×•×•×™ ×©×¨×™×“×™×]',
      };
      
      // Replace placeholders
      for (const [placeholder, value] of Object.entries(placeholders)) {
        legalText = legalText.replace(new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), value);
      }
      
      document.getElementById('legal-text-content').value = legalText;
      
      // Save the legal text to helper for the specific estimate
      const helper_updated = JSON.parse(sessionStorage.getItem('helper') || '{}');
      helper_updated.estimate_legal_text = legalText;
      sessionStorage.setItem('helper', JSON.stringify(helper_updated));
      
      console.log('Legal text loaded from vault and saved to estimate');
    }

    // RESET LEGAL TEXT
    function resetLegalText() {
      const selectedType = document.querySelector('input[name="estimate-type"]:checked')?.value || '××•×‘×“×Ÿ_×œ×”×œ×›×”';
      const typeText = selectedType === '××•×‘×“×Ÿ_×œ×”×œ×›×”' ? '××•×‘×“×Ÿ ×œ×”×œ×›×”' : '×˜×•×˜×œ×•×¡';
      
      document.getElementById('legal-text-content').value = `×˜×§×¡×˜ ××©×¤×˜×™ ×œ××•××“×Ÿ ${typeText} - ××•×›×Ÿ ×œ×¢×¨×™×›×”`;
      
      // Clear saved legal text from helper
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      delete helper.estimate_legal_text;
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      console.log('Legal text reset');
    }

    // ADD GLOBAL DEPRECIATION CALCULATION
    function updateGlobalDepreciationCalculation() {
      const globalDepInput = document.getElementById('globalDep1');
      const globalDepValueInput = document.getElementById('globalDepValue');
      
      if (globalDepInput && globalDepValueInput) {
        globalDepInput.addEventListener('input', function() {
          let percent = parseFloat(this.value) || 0;
          
          // Auto-add % symbol if not present and user enters a number
          if (this.value && !this.value.includes('%') && !isNaN(percent)) {
            this.value = percent + '%';
          }
          
          // Calculate value from market price automatically
          const marketValueField = document.getElementById('carMarketValue') || document.getElementById('sumMarketValue');
          const marketValueStr = marketValueField?.value.replace(/[â‚ª,]/g, '') || '0';
          const marketValue = parseFloat(marketValueStr) || 0;
          
          const calculatedValue = (marketValue * percent) / 100;
          globalDepValueInput.value = calculatedValue ? `â‚ª${Math.round(calculatedValue).toLocaleString()}` : '';
        });
      }
    }
    
    // CALCULATE DAMAGE PERCENTAGE
    function calculateDamagePercentage() {
      try {
        const totalClaimField = document.getElementById('sumClaim')?.value || document.getElementById('totalClaim')?.value || '0';
        const marketValueField = document.getElementById('sumMarketValue')?.value || document.getElementById('carMarketValue')?.value || '0';
        
        const totalClaim = parseFloat(totalClaimField.replace(/[â‚ª,]/g, '')) || 0;
        const marketValue = parseFloat(marketValueField.replace(/[â‚ª,]/g, '')) || 0;
        
        if (marketValue > 0 && totalClaim > 0) {
          const percentage = (totalClaim / marketValue) * 100;
          return Math.round(percentage);
        }
        return 0;
      } catch (error) {
        console.error('Error calculating damage percentage:', error);
        return 0;
      }
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      loadDataFromHelper();
      loadLegalText();
      updateGlobalDepreciationCalculation();
      
      // Add listener to garage days field
      const garageDaysField = document.getElementById('garageDays');
      if (garageDaysField) {
        garageDaysField.addEventListener('input', loadLegalText);
      }
      
      // Add listener to legal text textarea to save changes
      const legalTextArea = document.getElementById('legal-text-content');
      if (legalTextArea) {
        legalTextArea.addEventListener('input', function() {
          const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
          helper.estimate_legal_text = this.value;
          sessionStorage.setItem('helper', JSON.stringify(helper));
        });
      }
      
      // Update legal text when estimate type changes
      document.querySelectorAll('input[name="estimate-type"]').forEach(radio => {
        radio.addEventListener('change', function() {
          updateReportType();
          loadLegalText();
        });
      });
    });

    // HELPER FUNCTIONS FOR AUTO-FILL CALCULATIONS
    function calculateTotalFromDamageSections(helper) {
      try {
        if (helper.damage_sections && Array.isArray(helper.damage_sections)) {
          return helper.damage_sections.reduce((total, section) => {
            const sectionTotal = (parseFloat(section.works_total) || 0) + 
                                (parseFloat(section.parts_total) || 0) + 
                                (parseFloat(section.repairs_total) || 0);
            return total + sectionTotal;
          }, 0);
        }
        
        if (helper.expertise?.damage_blocks && Array.isArray(helper.expertise.damage_blocks)) {
          return helper.expertise.damage_blocks.reduce((total, block) => {
            const blockTotal = (parseFloat(block.work_cost) || 0) + 
                              (parseFloat(block.parts_cost) || 0);
            return total + blockTotal;
          }, 0);
        }
        
        return 0;
      } catch (error) {
        console.error('Error calculating total from damage sections:', error);
        return 0;
      }
    }
    
    function calculateDamagePercentageFromValues(totalDamage, marketValue) {
      try {
        const damage = parseFloat(totalDamage) || 0;
        const market = parseFloat(marketValue) || 0;
        
        if (market > 0 && damage > 0) {
          return Math.round((damage / market) * 100);
        }
        return 0;
      } catch (error) {
        console.error('Error calculating damage percentage:', error);
        return 0;
      }
    }

    // Make functions global
    window.loadDataFromHelper = loadDataFromHelper;
    window.loadLegalText = loadLegalText;
    window.loadLegalTextFromVault = loadLegalTextFromVault;
    window.resetLegalText = resetLegalText;
    window.addDepField = addDepField;
    window.updateReportType = updateReportType;
    window.addCustomSummaryField = addCustomSummaryField;
    window.loadDamageCentersSummary = loadDamageCentersSummary;
    window.loadLeviAdjustments = loadLeviAdjustments;
    window.updateGlobalDepreciationCalculation = updateGlobalDepreciationCalculation;
    window.calculateDamagePercentage = calculateDamagePercentage;
    window.calculateTotalFromDamageSections = calculateTotalFromDamageSections;
    window.calculateDamagePercentageFromValues = calculateDamagePercentageFromValues;
  </script>
  
  <script src="internal-browser.js"></script>
  <script src="levi-floating.js"></script>
  <script src="car-details-floating.js"></script>
</body>
</html>