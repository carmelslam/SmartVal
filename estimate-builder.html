<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>בניית אומדן - ירון כיוף</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" type="image/webp">
  <style>
    body {
      font-family: sans-serif;
      background: #f3f6fb;
      margin: 0;
      min-height: 100vh;
      padding: 0;
      padding-top: 90px;
      overflow-x: hidden;
    }
    .container {
      width: 100%;
      max-width:750px;
      background: #fff;
      padding: 32px 24px 24px 24px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.08);
      margin: 32px auto 32px auto;
      box-sizing: border-box;
    }
    .logo {
      display: flex;
      justify-content: center;
      margin-bottom: 8px;
    }
    .logo img {
      width: 112px;
      height: auto;
      display: block;
    }
    .title { font-size: 27px; font-weight: bold; text-align: center; margin-bottom: 2px; font-weight: 900;}
    .subtitle { font-size: 23px; color: #666; text-align: center; margin-bottom: 10px;}
    h1, h2 { color: #1e3a8a; font-size: 25px; text-align: center; margin: 15px 0 8px 0; font-weight: 600;}
    h3 { color: #1e3a8a; font-size: 24px; margin: 22px 0 12px 0; text-align: right; font-weight: 900;}
    .form-section {
      width: 100%;
      margin-bottom: 20px;
      background: #fafbfe;
      border-radius: 12px;
      padding: 17px 15px 12px 15px;
      box-sizing: border-box;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px 18px;
      width: 100%;
    }
    @media (max-width: 600px) {
      .form-grid { grid-template-columns: 1fr; }
      .container { padding: 14px 2vw 20px 2vw; }
    }
    
    /* Mobile viewport fixes */
    @media (max-width: 768px) {
      body {
        width: 100vw;
        overflow-x: hidden !important;
        position: relative;
      }
      
      html {
        width: 100vw;
        overflow-x: hidden !important;
      }
      
      .container {
        width: 95vw;
        max-width: 95vw;
        margin: 32px 2.5vw 32px 2.5vw;
      }
    }
    label {
      font-size: 18px;
      margin-bottom: 4px;
      display: block;
      text-align: right;
    }
    input, select, textarea {
      width: 100%;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 0px;
      padding: 8px 9px;
      box-sizing: border-box;
      text-align: right;
      background: #f9f9f9;
      transition: border .15s;
      outline: none;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #3b82f6;
    }
    .readonly-box {
      background: #f4f6fa;
      border-radius: 6px;
      border: 1px solid #eee;
      padding: 7px 8px;
      min-height: 20px;
      font-size: 16px;
      color: #333;
      text-align: right;
    }
    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      display: block;
    }
    
    /* FLOATING SCREENS STYLING - COPIED FROM DEPRECIATION */
    .floating-toggles-top {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 8px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .toggle-square {
      width: 80px;
      height: 70px;
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: white;
      text-align: center;
      border: 2px solid transparent;
    }

    .toggle-square:hover {
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .toggle-square.active {
      border-color: #fbbf24;
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
    }

    .toggle-icon {
      font-size: 18px;
      margin-bottom: 2px;
    }

    .toggle-text {
      font-size: 10px;
      font-weight: 600;
      line-height: 1.1;
    }
    @media (max-width: 768px) {
      .floating-toggles-top {
        top: 5px;
        gap: 4px;
        padding: 6px;
      }
      .toggle-square {
        width: 65px;
        height: 60px;
      }
      .toggle-icon {
        font-size: 16px;
      }
      .toggle-text {
        font-size: 9px;
      }
    }
    
    .collapsible-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      width: 100%;
      text-align: right;
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }

    .collapsible-btn:hover {
      background: #0056b3;
    }
    
    .footer {
      margin-top: 40px;
      font-size: 12px;
      color: #aaa;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- FLOATING SCREEN TOGGLES - TOP OF PAGE -->
  <div class="floating-toggles-top">
    <div class="toggle-square" onclick="toggleFloatingScreen('leviReport')">
      <div class="toggle-icon">📊</div>
      <div class="toggle-text">דו"ח לוי יצחק</div>
    </div>
    <div class="toggle-square" onclick="toggleFloatingScreen('carDetails')">
      <div class="toggle-icon">🚗</div>
      <div class="toggle-text">פרטי רכב</div>
    </div>
    <div class="toggle-square" onclick="toggleFloatingScreen('internalBrowser')">
      <div class="toggle-icon">🌐</div>
      <div class="toggle-text">דפדפן פנימי</div>
    </div>
  </div>

  <div class="container">
    <div class="logo"><img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo"></div>
    <div class="title">ירון כיוף שמאות - פורטל</div>
    <div class="subtitle">שמאות והערכת נזקי רכב ורכוש</div>
    <h1>בניית אומדן נזקי רכב</h1>
    <h2 id="pageTitle">רכב מס. ...</h2>

    <!-- ESTIMATE TYPE SELECTION -->
    <div class="form-section" id="estimate-type">
      <h3>סוג האומדן</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
        <label style="border: 1px solid #ddd; padding: 10px; border-radius: 6px; cursor: pointer;">
          <input type="radio" name="estimate-type" value="אובדן_להלכה" checked style="width: auto; margin-left: 8px;">
          אומדן ראשוני - אובדן להלכה
        </label>
        <label style="border: 1px solid #ddd; padding: 10px; border-radius: 6px; cursor: pointer;">
          <input type="radio" name="estimate-type" value="טוטלוס" style="width: auto; margin-left: 8px;">
          אומדן ראשוני - טוטלוס
        </label>
      </div>
    </div>

    <!-- VEHICLE DATA - READONLY FROM HELPER -->
    <div class="form-section" id="vehicle-details">
      <h3>נתוני רכב</h3>
      <div class="form-grid" id="vehicleData">
        <div>
          <label>מספר רכב:</label>
          <div class="readonly-box" id="carPlate"></div>
        </div>
        <div>
          <label>תוצרת:</label>
          <div class="readonly-box" id="carManufacturer"></div>
        </div>
        <div>
          <label>דגם:</label>
          <div class="readonly-box" id="carModel"></div>
        </div>
        <div>
          <label>שנת ייצור:</label>
          <div class="readonly-box" id="carYear"></div>
        </div>
        <div>
          <label>מחיר בסיס:</label>
          <div class="readonly-box" id="carBasePrice"></div>
        </div>
        <div>
          <label>תאריך הפקה:</label>
          <div class="readonly-box" id="carReportDate"></div>
        </div>
      </div>
    </div>

    <!-- COLLAPSIBLE PRICE DATA -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('priceData')">נתוני תביעה (הצג/הסתר)</button>
      <div id="priceData" style="display:none;">
        <div class="form-grid">
          <div><label>סה״כ תביעה:</label><div class="readonly-box" id="totalClaim"></div></div>
          <div><label>חישוב הערך לנזק גולמי:</label><div class="readonly-box" id="leviPriceList"></div></div>
          <div><label>חישוב האחוז הגולמי:</label><div class="readonly-box" id="grossPercent"></div></div>
          <div><label>סה"כ תביעה (מאושר):</label><div class="readonly-box" id="authorizedClaim"></div></div>
          <div><label>ערך השוק של הרכב:</label><div class="readonly-box" id="finalMarketValue"></div></div>
        </div>
      </div>
    </div>

    <!-- COLLAPSIBLE CONTACT DATA -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('contactData')">נתוני התקשרות (הצג/הסתר)</button>
      <div id="contactData" style="display:none;">
        <div class="form-grid">
          <div><label>שם בעל הרכב:</label><div class="readonly-box" id="ownerName"></div></div>
          <div><label>כתובת בעל הרכב:</label><div class="readonly-box" id="ownerAddress"></div></div>
          <div><label>טלפון בעל הרכב:</label><div class="readonly-box" id="ownerPhone"></div></div>
          <div><label>חברת ביטוח:</label><div class="readonly-box" id="insuranceCompany"></div></div>
          <div><label>אימייל חברת ביטוח:</label><div class="readonly-box" id="insuranceEmail"></div></div>
          <div><label>סוכן ביטוח:</label><div class="readonly-box" id="insuranceAgent"></div></div>
          <div><label>טלפון סוכן ביטוח:</label><div class="readonly-box" id="agentPhone"></div></div>
          <div><label>אימייל סוכן ביטוח:</label><div class="readonly-box" id="agentEmail"></div></div>
        </div>
      </div>
    </div>

    <!-- ADDITIONAL NOTES -->
    <div class="form-section">
      <h3>הערות נוספות לאומדן</h3>
      <textarea id="additional-notes" placeholder="הוסף הערות, המלצות או מידע נוסף לאומדן..." style="min-height: 80px;"></textarea>
    </div>

    <!-- Navigation Buttons -->
    <div class="form-section">
      <div class="form-grid">
        <div>
          <button type="button" class="btn" style="background: #28a745;" onclick="saveEstimate()">שמור אומדן</button>
        </div>
        <div>
          <button type="button" class="btn" style="background: #17a2b8;" onclick="previewEstimate()">תצוגה מקדימה</button>
        </div>
      </div>
      <div class="form-grid" style="margin-top: 10px;">
        <div>
          <button type="button" class="btn" style="background: #007bff;" onclick="generateEstimate()">צור דו"ח אומדן</button>
        </div>
        <div>
          <button type="button" class="btn" style="background: #6c757d;" onclick="window.location.href='selection.html'">חזור לדף הבחירה</button>
        </div>
      </div>
    </div>

    <!-- LEGAL TEXT SECTION -->
    <div class="form-section" id="legal-text">
      <h3>טקסט משפטי לאומדן</h3>
      <div style="background: #f8f9fa; border: 1px solid #e2e8f0; border-radius: 6px; padding: 15px; min-height: 100px; white-space: pre-wrap; line-height: 1.6;" id="legal-text-content">
        הטקסט המשפטי יטען כאן עם הנתונים המעודכנים...
      </div>
    </div>

    <div class="footer">All rights reserved © Carmel Cayouf</div>
  </div>

  
  <script>
    // Authentication check
    const auth = sessionStorage.getItem("auth");
    if (!auth) {
      alert("הגישה חסומה - אנא התחבר דרך דף הבית");
      window.location.href = "index.html";
    }

    // FLOATING SCREENS TOGGLE FUNCTION - COPIED FROM DEPRECIATION MODULE
    window.toggleFloatingScreen = function(screenType) {
      console.log('Toggling floating screen:', screenType);
      
      const screens = {
        leviReport: () => {
          if (window.toggleLeviReport) {
            window.toggleLeviReport();
          } else {
            console.log('Levi report floating screen not available');
          }
        },
        carDetails: () => {
          if (window.toggleCarDetails) {
            window.toggleCarDetails();
          } else {
            console.log('Car details floating screen not available');
          }
        },
        internalBrowser: () => {
          if (window.showBrowserMenu) {
            showBrowserMenuUnderToggle();
          } else {
            console.log('Internal browser not available');
          }
        }
      };
      
      if (screens[screenType]) {
        screens[screenType]();
      } else {
        console.log('Unknown screen type:', screenType);
      }
    };

    // CUSTOM BROWSER MENU - COPIED FROM DEPRECIATION MODULE
    function showBrowserMenuUnderToggle() {
      const menu = document.createElement('div');
      menu.style.cssText = `
        position: fixed;
        top: 90px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 20px;
        z-index: 99999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        font-family: sans-serif;
        direction: rtl;
        min-width: 280px;
      `;
      
      menu.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 15px; color: #2c3e50; font-size: 16px;">בחר אתר לפתיחה:</div>
        <button onclick="window.openInternalBrowser('car-part.co.il'); this.parentElement.remove();" style="width: 100%; padding: 12px; margin-bottom: 8px; border: none; background: #28a745; color: white; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 500;">
          🔧 Car Part - חלקי רכב
        </button>
        <button onclick="window.openInternalBrowser('portal.levi-itzhak.co.il'); this.parentElement.remove();" style="width: 100%; padding: 12px; margin-bottom: 8px; border: none; background: #007bff; color: white; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 500;">
          📊 פורטל לוי יצחק
        </button>
        <button onclick="this.parentElement.remove();" style="width: 100%; padding: 10px; border: 1px solid #ccc; background: white; color: #666; border-radius: 6px; cursor: pointer; font-size: 14px;">
          ביטול
        </button>
      `;
      
      document.body.appendChild(menu);
      
      // Remove menu when clicking outside
      setTimeout(() => {
        document.addEventListener('click', function removeMenu(e) {
          if (!menu.contains(e.target)) {
            menu.remove();
            document.removeEventListener('click', removeMenu);
          }
        });
      }, 100);
    }

    // COLLAPSIBLE SECTION TOGGLE
    window.toggleSection = function(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        section.style.display = section.style.display === 'none' ? 'block' : 'none';
      }
    };

    // BUTTON FUNCTIONS - NO DEBUG ALERTS
    window.saveEstimate = function() {
      const selectedTypeElement = document.querySelector('input[name="estimate-type"]:checked');
      if (!selectedTypeElement) {
        alert('אנא בחר סוג אומדן');
        return;
      }
      
      const selectedType = selectedTypeElement.value;
      const additionalNotes = document.getElementById('additional-notes')?.value || '';
      
      // Save to helper
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      helper.estimate_type = selectedType;
      helper.estimate_notes = additionalNotes;
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      alert('אומדן נשמר בהצלחה');
    };

    window.previewEstimate = function() {
      const selectedTypeElement = document.querySelector('input[name="estimate-type"]:checked');
      if (!selectedTypeElement) {
        alert('אנא בחר סוג אומדן');
        return;
      }
      
      const selectedType = selectedTypeElement.value;
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      helper.estimate_type = selectedType;
      sessionStorage.setItem('helper', JSON.stringify(helper));
      sessionStorage.setItem('selectedReportType', 'estimate');
      
      window.location.href = 'estimate-validation.html';
    };

    window.generateEstimate = function() {
      const selectedTypeElement = document.querySelector('input[name="estimate-type"]:checked');
      if (!selectedTypeElement) {
        alert('אנא בחר סוג אומדן');
        return;
      }
      
      const selectedType = selectedTypeElement.value;
      const additionalNotes = document.getElementById('additional-notes')?.value || '';
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      helper.estimate_type = selectedType;
      helper.estimate_notes = additionalNotes;
      sessionStorage.setItem('helper', JSON.stringify(helper));
      sessionStorage.setItem('selectedReportType', 'estimate');
      
      window.location.href = 'estimate-validation.html';
    };

    // LOAD DATA FROM HELPER
    function loadDataFromHelper() {
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        // Load car details
        if (helper.car_details || helper.meta) {
          document.getElementById('carPlate').textContent = helper.meta?.plate || '[מספר רכב]';
          document.getElementById('carManufacturer').textContent = helper.car_details?.manufacturer || '[תוצרת]';
          document.getElementById('carModel').textContent = helper.car_details?.model || '[דגם]';
          document.getElementById('carYear').textContent = helper.car_details?.year || '[שנה]';
          document.getElementById('carBasePrice').textContent = helper.car_details?.base_price ? `₪${helper.car_details.base_price}` : '[מחיר בסיס]';
          document.getElementById('carReportDate').textContent = helper.car_details?.report_date || '[תאריך הפקה]';
        }
        
        // Load claims data
        if (helper.expertise?.calculations) {
          const calc = helper.expertise.calculations;
          document.getElementById('totalClaim').textContent = calc.total_damage ? `₪${calc.total_damage.toLocaleString()}` : '₪0';
          document.getElementById('leviPriceList').textContent = helper.levi_report?.final_price ? `₪${helper.levi_report.final_price.toLocaleString()}` : '₪0';
          document.getElementById('grossPercent').textContent = calc.damage_percent ? `${calc.damage_percent}%` : '0%';
          document.getElementById('authorizedClaim').textContent = calc.total_damage ? `₪${calc.total_damage.toLocaleString()}` : '₪0';
          document.getElementById('finalMarketValue').textContent = calc.market_value ? `₪${calc.market_value.toLocaleString()}` : '₪0';
        }
        
        // Load contact data
        if (helper.client) {
          document.getElementById('ownerName').textContent = helper.client.name || '[שם בעל הרכב]';
          document.getElementById('ownerAddress').textContent = helper.client.address || '[כתובת]';
          document.getElementById('ownerPhone').textContent = helper.client.phone || '[טלפון]';
          document.getElementById('insuranceCompany').textContent = helper.client.insurance_company || '[חברת ביטוח]';
          document.getElementById('insuranceEmail').textContent = helper.client.insurance_email || '[אימייל חברה]';
          document.getElementById('insuranceAgent').textContent = helper.client.insurance_agent || '[סוכן ביטוח]';
          document.getElementById('agentPhone').textContent = helper.client.agent_phone || '[טלפון סוכן]';
          document.getElementById('agentEmail').textContent = helper.client.agent_email || '[אימייל סוכן]';
        }
        
        // Update page title with plate
        document.getElementById('pageTitle').textContent = `רכב מס. ${helper.meta?.plate || '...'}`;
        
      } catch (error) {
        console.error('Error loading data from helper:', error);
      }
    }

    // LOAD LEGAL TEXT
    function loadLegalText() {
      const selectedType = document.querySelector('input[name="estimate-type"]:checked')?.value || 'אובדן_להלכה';
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Simple legal text with placeholders filled
      const legalTemplate = selectedType === 'אובדן_להלכה' 
        ? `אומדן ראשוני - אובדן להלכה
רכב מספר: ${helper.meta?.plate || '[מספר רכב]'}
תוצרת: ${helper.car_details?.manufacturer || '[תוצרת]'} ${helper.car_details?.model || '[דגם]'}
שנת ייצור: ${helper.car_details?.year || '[שנה]'}
בעל הרכב: ${helper.client?.name || '[שם בעל הרכב]'}

האומדן נערך על פי בדיקת הנזקים והערכת עלות התיקון.
המומחיות כוללת את כל הנזקים הנראים לעין.`
        : `אומדן ראשוני - טוטלוס  
רכב מספר: ${helper.meta?.plate || '[מספר רכב]'}
תוצרת: ${helper.car_details?.manufacturer || '[תוצרת]'} ${helper.car_details?.model || '[דגם]'}
שנת ייצור: ${helper.car_details?.year || '[שנה]'}
בעל הרכב: ${helper.client?.name || '[שם בעל הרכב]'}

הרכב נפסק כטוטלוס על פי הערכת הנזקים.
ערך השוק מול עלות התיקון מצדיק פסילה מוחלטת.`;
      
      document.getElementById('legal-text-content').textContent = legalTemplate;
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      loadDataFromHelper();
      loadLegalText();
      
      // Update legal text when estimate type changes
      document.querySelectorAll('input[name="estimate-type"]').forEach(radio => {
        radio.addEventListener('change', loadLegalText);
      });
    });

    // Make functions global
    window.loadDataFromHelper = loadDataFromHelper;
    window.loadLegalText = loadLegalText;
  </script>
  
  <script src="internal-browser.js"></script>
  <script src="levi-floating.js"></script>
  <script src="car-details-floating.js"></script>
</body>
</html>