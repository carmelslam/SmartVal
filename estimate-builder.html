<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×‘× ×™×™×ª ××•××“×Ÿ - ×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª</title>
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      margin: 0;
      padding: 20px;
      padding-top: 90px; /* Space for floating toggles */
      direction: rtl;
      text-align: right;
    }

    /* FLOATING SCREENS STYLING */
    .floating-toggles-top {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 8px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .toggle-square {
      width: 80px;
      height: 70px;
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: white;
      text-align: center;
      border: 2px solid transparent;
    }

    .toggle-square:hover {
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .toggle-square.active {
      border-color: #fbbf24;
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
    }

    .toggle-icon {
      font-size: 20px;
      margin-bottom: 4px;
    }

    .toggle-text {
      font-size: 10px;
      font-weight: 600;
      line-height: 1.2;
    }

    @media (max-width: 768px) {
      .floating-toggles-top {
        gap: 4px;
        padding: 6px;
      }
      
      .toggle-square {
        width: 70px;
        height: 60px;
      }
      
      .toggle-icon {
        font-size: 18px;
      }
      
      .toggle-text {
        font-size: 9px;
      }
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #1e3a8a 0%, #475569 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .logo {
      width: 60px;
      height: 60px;
      margin: 0 auto 20px;
      border-radius: 50%;
      background: white;
      padding: 5px;
      display: block;
    }

    .business-name {
      font-size: 24px;
      font-weight: 600;
      margin: 15px 0 5px 0;
      color: white;
    }

    .business-subtitle {
      font-size: 16px;
      opacity: 0.9;
      margin: 0 0 15px 0;
      color: #e2e8f0;
    }

    .page-title {
      font-size: 28px;
      font-weight: 300;
      margin: 15px 0 0 0;
      color: white;
      border-top: 1px solid rgba(255,255,255,0.3);
      padding-top: 15px;
    }


    .content {
      padding: 30px;
    }

    .section {
      margin-bottom: 40px;
      padding: 25px;
      border: 1px solid #e1e8ed;
      border-radius: 10px;
      background: #fafbfc;
    }

    .section h3 {
      margin: 0 0 20px 0;
      color: #1e3a8a;
      font-size: 20px;
      border-bottom: 2px solid #3b82f6;
      padding-bottom: 10px;
    }

    .row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .field {
      flex: 1;
      min-width: 200px;
    }

    .field label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #475569;
    }

    .field input,
    .field select,
    .field textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #64748b;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .damage-center {
      background: white;
      border: 2px solid #e74c3c;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      position: relative;
    }

    .center-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #ecf0f1;
    }

    .center-header h4 {
      margin: 0;
      color: #e74c3c;
      font-size: 18px;
    }

    .remove-damage-center {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      transition: background-color 0.3s ease;
    }

    .remove-damage-center:hover {
      background: #c0392b;
    }

    .parts-section,
    .repairs-section {
      margin: 20px 0;
    }

    .parts-section h5,
    .repairs-section h5 {
      color: #1e3a8a;
      margin: 0 0 15px 0;
      font-size: 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    th {
      background: #1e3a8a;
      color: white;
      padding: 12px;
      text-align: center;
      font-weight: 600;
    }

    td {
      padding: 10px;
      border-bottom: 1px solid #ecf0f1;
    }

    td input,
    td select {
      width: 100%;
      padding: 8px;
      border: 1px solid #64748b;
      border-radius: 4px;
      font-size: 13px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #1e3a8a);
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #1e3a8a, #1e40af);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #64748b, #475569);
      color: white;
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #475569, #334155);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(100, 116, 139, 0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, #27ae60, #229954);
      color: white;
    }

    .btn-success:hover {
      background: linear-gradient(135deg, #229954, #1e8449);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
    }

    .totals-section {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      color: white;
      padding: 25px;
      border-radius: 10px;
      margin-top: 30px;
    }

    .totals-section h3 {
      margin: 0 0 20px 0;
      border-bottom: 2px solid rgba(255,255,255,0.3);
      padding-bottom: 10px;
    }

    .total-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .total-line:last-child {
      font-size: 20px;
      font-weight: bold;
      border-top: 2px solid rgba(255,255,255,0.3);
      padding-top: 15px;
      margin-top: 15px;
    }

    .legal-text-preview {
      background: #ecf0f1;
      padding: 20px;
      border-radius: 8px;
      margin-top: 15px;
    }

    .legal-text-preview h4 {
      color: #1e3a8a;
      margin: 0 0 15px 0;
    }

    .legal-text {
      line-height: 1.6;
      color: #475569;
      font-size: 14px;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 40px;
      padding: 30px;
      background: #f8f9fa;
      border-radius: 10px;
    }

    .depreciation-field {
      background: #fff3cd;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ffeaa7;
      margin-top: 15px;
      display: none; /* Hidden for estimates */
    }

    .depreciation-field label {
      color: #856404;
      font-weight: 600;
    }

    .estimate-type-section {
      background: #e8f5e8;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .estimate-type-section h3 {
      color: #2d5a2d;
      margin: 0 0 15px 0;
    }

    .estimate-type-radio {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }

    .estimate-type-radio label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .damage-validation {
      background: #f0f8ff;
      border: 2px solid #4682b4;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .damage-validation h3 {
      color: #4682b4;
      margin: 0 0 15px 0;
    }

    .damage-override {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .damage-override-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .override-toggle {
      background: #ffc107;
      color: #212529;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
    }

    .override-toggle:hover {
      background: #e0a800;
    }

    .additional-notes {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .additional-notes h3 {
      color: #475569;
      margin: 0 0 15px 0;
    }

    .additional-notes textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid #64748b;
      border-radius: 5px;
      font-family: inherit;
      resize: vertical;
    }

    .add-part-row,
    .add-repair-row {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      margin-top: 10px;
    }

    .add-part-row:hover,
    .add-repair-row:hover {
      background: #1e3a8a;
    }

    @media (max-width: 768px) {
      .row {
        flex-direction: column;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .action-buttons .btn {
        margin-bottom: 10px;
      }
    }

    .loading {
      display: none;
      text-align: center;
      color: #64748b;
    }

    .loading.show {
      display: block;
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alert.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .alert.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .alert.show {
      display: block;
    }

    .footer {
      background: #1e3a8a;
      color: white;
      text-align: center;
      padding: 20px;
      margin-top: 40px;
      font-size: 14px;
    }

    .form-section {
      background: #fafbfc;
      border: 1px solid #e1e8ed;
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 20px;
    }

    .form-section h3 {
      margin: 0 0 20px 0;
      color: #1e3a8a;
      font-size: 20px;
      border-bottom: 2px solid #3b82f6;
      padding-bottom: 10px;
    }

    .btn.add {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      padding: 8px 16px;
      font-size: 12px;
      margin-top: 10px;
    }

    .btn.add:hover {
      background: linear-gradient(135deg, #20c997, #17a2b8);
      transform: translateY(-1px);
    }
  </style>
</head>
<body>
  <!-- FLOATING SCREEN TOGGLES - TOP OF PAGE -->
  <div class="floating-toggles-top">
    <div class="toggle-square" onclick="toggleFloatingScreen('leviReport')">
      <div class="toggle-icon">ğŸ“Š</div>
      <div class="toggle-text">×“×•"×— ×œ×•×™ ×™×¦×—×§</div>
    </div>
    <div class="toggle-square" onclick="toggleFloatingScreen('carDetails')">
      <div class="toggle-icon">ğŸš—</div>
      <div class="toggle-text">×¤×¨×˜×™ ×¨×›×‘</div>
    </div>
    <div class="toggle-square" onclick="toggleFloatingScreen('internalBrowser')">
      <div class="toggle-icon">ğŸŒ</div>
      <div class="toggle-text">×“×¤×“×¤×Ÿ ×¤× ×™××™</div>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo" class="logo">
      <div class="business-name">×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×¤×•×¨×˜×œ</div>
      <div class="business-subtitle">×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</div>
      <div class="page-title">×‘× ×™×™×ª ××•××“×Ÿ × ×–×§×™ ×¨×›×‘</div>
    </div>

    <div class="content">
      <div id="alerts"></div>
      
      <form id="estimate-form">
        <!-- Vehicle Information Section -->
        <div id="vehicle-info"></div>

        <!-- Estimate Type Selection -->
        <div class="estimate-type-section">
          <h3>×¡×•×’ ×”××•××“×Ÿ</h3>
          <div class="estimate-type-radio">
            <label>
              <input type="radio" name="estimate-type" value="××•×‘×“×Ÿ_×œ×”×œ×›×”" checked>
              ××•××“×Ÿ ×¨××©×•× ×™ - ××•×‘×“×Ÿ ×œ×”×œ×›×”
            </label>
            <label>
              <input type="radio" name="estimate-type" value="×˜×•×˜×œ×•×¡">
              ××•××“×Ÿ ×¨××©×•× ×™ - ×˜×•×˜×œ×•×¡
            </label>
          </div>
          <div class="legal-text-preview" id="legal-text-preview">
            <h4>×ª×¦×•×’×” ××§×“×™××” ×©×œ ×”×˜×§×¡×˜ ×”××©×¤×˜×™:</h4>
            <div class="legal-text" id="legal-text"></div>
          </div>
        </div>

        <!-- Damage Centers Validation -->
        <div class="damage-validation">
          <h3>××™××•×ª ××•×§×“×™ × ×–×§ ××”××§×¡×¤×¨×˜×™×–×”</h3>
          <div id="damage-validation-list"></div>
        </div>

<!-- 5. ESTIMATE DEPRECIATION BULK SECTION -->
    <div class="form-section" id="depreciationSection">
      <h3>×—×™×©×•×‘ ×™×¨×™×“×ª ×¢×¨×š ×œ×¤×™ ××•×§×“×™ × ×–×§</h3>
      <div style="display:grid; grid-template-columns:1fr 1fr 120px 120px 80px; gap:14px; margin-bottom:10px;">
        <div><label>×”×—×œ×§ ×”× ×™×–×•×§:</label></div>
        <div><label>××”×•×ª ×”×ª×™×§×•×Ÿ:</label></div>
        <div><label>% ×™×¨×™×“×ª ×¢×¨×š:</label></div>
        <div><label>×¢×¨×š ×‘-â‚ª:</label></div>
        <div><label>×¤×¢×•×œ×•×ª:</label></div>
      </div>
      <div id="depreciationBulkTable"></div>
      <button class="btn add" type="button" onclick="addDepField()">×”×•×¡×£ ×©×“×”</button>
      <div style="margin-top:14px;">
        <label>×™×¨×™×“×ª ×¢×¨×š ×’×œ×•×‘×œ×™:</label>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:14px;">
          <input type="number" id="globalDep1" placeholder="% ×™×¨×™×“×ª ×¢×¨×š" />
          <input type="number" id="globalDepValue" placeholder="×¢×¨×š ×‘-â‚ª" readonly style="background:#f4f6fa;" />
        </div>
      </div>
    </div>
    


        <!-- Additional Notes Section -->
        <div class="additional-notes">
          <h3>×”×¢×¨×•×ª × ×•×¡×¤×•×ª ×œ××•××“×Ÿ</h3>
          <textarea id="additional-notes" placeholder="×”×•×¡×£ ×”×¢×¨×•×ª, ×”××œ×¦×•×ª ××• ××™×“×¢ × ×•×¡×£ ×œ××•××“×Ÿ..."></textarea>
        </div>

        <!-- Totals Display (No fees/depreciation) -->
        <div class="totals-section" id="totals-display">
          <h3>×¡×”"×› ×ª×‘×™×¢×”</h3>
          <div class="total-line">
            <span>×¡×š × ×–×§×™×:</span>
            <span id="base-damage-total">â‚ª0</span>
          </div>
          <div class="total-line">
            <span>××¢"× (<span id="vat-rate">18</span>%):</span>
            <span id="vat-amount">â‚ª0</span>
          </div>
          <div class="total-line">
            <span>×¡×”"×› ×ª×‘×™×¢×”:</span>
            <span id="total-claim">â‚ª0</span>
          </div>
        </div>

        <!-- Action Buttons - COPIED STYLE FROM DEPRECIATION MODULE -->
        <div class="action-buttons">
          <button type="button" class="btn btn-primary" onclick="saveEstimate()">
            ğŸ’¾ ×©××•×¨ ××•××“×Ÿ
          </button>
          <button type="button" class="btn btn-secondary" onclick="previewEstimate()">
            ğŸ‘ï¸ ×ª×¦×•×’×” ××§×“×™××”
          </button>
          <button type="button" class="btn btn-success" onclick="generateEstimate()">
            ğŸ“„ ×¦×•×¨ ×“×•"×— ××•××“×Ÿ
          </button>
          <button type="button" class="btn btn-secondary" onclick="window.location.href='selection.html'">
            ğŸ  ×—×–×•×¨ ×œ×“×£ ×”×‘×™×ª
          </button>
        </div>
      </form>

      <div class="loading" id="loading">
        <p>â³ ××¢×‘×“ × ×ª×•× ×™×...</p>
      </div>
    </div>
    
    <div class="footer">
      All rights reserved Â© Carmel Cayouf
    </div>
  </div>

  <script type="module" src="./estimate-generator.js"></script>
  <script type="module" src="./helper.js"></script>
  <script type="module" src="./validation.js"></script>
  <script type="module" src="./math.js"></script>
  <script type="module" src="./webhook.js"></script>
  <script type="module" src="./vault-loader.js"></script>
  
  <!-- FLOATING SCREENS SCRIPTS -->
  <script type="module" src="./levi-floating.js"></script>
  <script type="module" src="./car-details-floating.js"></script>
  <script type="module" src="./internal-browser.js"></script>

  <script>
    // Utility functions for UI feedback
    function showAlert(message, type = 'success') {
      const alertsContainer = document.getElementById('alerts');
      const alert = document.createElement('div');
      alert.className = `alert ${type} show`;
      alert.textContent = message;
      alertsContainer.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    function showLoading(show = true) {
      const loading = document.getElementById('loading');
      if (show) {
        loading.classList.add('show');
      } else {
        loading.classList.remove('show');
      }
    }

    // Override alert function to use custom styling
    window.originalAlert = window.alert;
    window.alert = function(message) {
      if (message.includes('âŒ')) {
        showAlert(message, 'error');
      } else if (message.includes('âœ…') || message.includes('ğŸ“')) {
        showAlert(message, 'success');
      } else {
        window.originalAlert(message);
      }
    };

    // FLOATING SCREENS TOGGLE FUNCTION - COPIED FROM DEPRECIATION MODULE
    window.toggleFloatingScreen = function(screenType) {
      console.log('Toggling floating screen:', screenType);
      
      const screens = {
        leviReport: () => {
          if (window.toggleLeviReport) {
            window.toggleLeviReport();
          } else {
            console.log('Levi report floating screen not available');
          }
        },
        carDetails: () => {
          if (window.toggleCarDetails) {
            window.toggleCarDetails();
          } else {
            console.log('Car details floating screen not available');
          }
        },
        internalBrowser: () => {
          if (window.openInternalBrowser) {
            window.openInternalBrowser('https://www.google.com', '×—×™×¤×•×© ××™×“×¢');
          } else {
            console.log('Internal browser not available');
          }
        }
      };
      
      if (screens[screenType]) {
        screens[screenType]();
      } else {
        console.log('Unknown screen type:', screenType);
      }
    };

    // Enhanced authentication and data validation check
    document.addEventListener('DOMContentLoaded', () => {
      console.log('ğŸ”„ Estimate Builder: Initializing...');
      
      // Authentication check
      const auth = sessionStorage.getItem("auth");
      if (!auth) {
        console.error('âŒ No authentication found');
        showAlert("×”×’×™×©×” ×—×¡×•××” - ×× × ×”×ª×—×‘×¨ ×“×¨×š ×“×£ ×”×‘×™×ª", 'error');
        setTimeout(() => {
          window.location.href = "index.html";
        }, 2000);
        return;
      }

      // Comprehensive data validation
      const plateNumber = sessionStorage.getItem('plate');
      const helperData = sessionStorage.getItem('helper');
      const selectedReportType = sessionStorage.getItem('selectedReportType');
      
      console.log('ğŸ“Š Estimate Builder validation:', {
        hasAuth: !!auth,
        hasPlate: !!plateNumber,
        hasHelper: !!helperData,
        hasReportType: !!selectedReportType,
        reportType: selectedReportType
      });
      
      // AUTO-FILL LOGIC: Allow both scenarios
      // 1. Coming from report selection with existing data -> auto-fill
      // 2. Coming from report selection without data -> start empty but allow manual entry
      // 3. Coming from estimate workflow -> normal validation but more flexible
      
      const isFromReportSelection = selectedReportType === 'estimate';
      
      console.log('ğŸ” Entry point analysis:', {
        isFromReportSelection,
        selectedReportType,
        hasPlate: !!plateNumber,
        hasHelper: !!helperData
      });
      
      // More flexible validation - only redirect if we're clearly in a bad state
      // Allow direct access or when coming from valid workflows
      
      // If coming from a different report type, redirect appropriately
      if (selectedReportType === 'final') {
        console.warn('âš ï¸ Redirecting to final report builder');
        showAlert('××¢×‘×™×¨ ×œ×‘× ×™×™×ª ×“×•"×— ×¡×•×¤×™...', 'warning');
        setTimeout(() => {
          window.location.href = 'depreciation-module.html';
        }, 2000);
        return;
      }
      
      // For all other cases (estimate, no type, or direct access), allow through
      console.log('âœ… Allowing access to estimate builder');
      
      // Handle different entry points
      let helper = null;
      
      if (helperData) {
        // Try to parse existing helper data
        try {
          helper = JSON.parse(helperData);
          if (!helper || typeof helper !== 'object') {
            throw new Error('Invalid helper data structure');
          }
          console.log('âœ… Helper data loaded successfully');
          showAlert('×‘×•× ×” ××•××“×Ÿ - × ×ª×•× ×™× ×§×™×™××™× × ×˜×¢× ×• ×‘×”×¦×œ×—×”', 'success');
        } catch (error) {
          console.error('âš ï¸ Invalid helper data, starting empty:', error);
          helper = null;
          showAlert('× ×ª×•× ×™× ×§×™×™××™× ×¤×’×•××™× - ××ª×—×™×œ ×¨×™×§', 'warning');
        }
      }
      
      if (!helper) {
        // No data or invalid data - start empty
        console.log('ğŸ“ Starting with empty builder');
        showAlert('×‘×•× ×” ××•××“×Ÿ - ××ª×—×™×œ ×‘×™×¦×™×¨×ª ××•××“×Ÿ ×—×“×©', 'info');
        // Initialize empty helper structure
        helper = {
          meta: { plate: plateNumber || '' },
          vehicle: {},
          client: {},
          damage_sections: [],
          calculations: {}
        };
      }
      
      console.log('âœ… Estimate Builder: Initialization complete');

      // Check for post-session mode
      const urlParams = new URLSearchParams(window.location.search);
      const isPostSession = urlParams.get('mode') === 'post-session';
      
      if (isPostSession) {
        initializePostSessionMode();
      } else {
        initializeSessionMode();
      }

      // Set up auto-save on unload
      window.addEventListener('beforeunload', (e) => {
        if (window.estimateGenerator && typeof window.estimateGenerator.export === 'function') {
          // Auto-save for post-session mode
        }
      });
    });

    function initializePostSessionMode() {
      // Check if case is loaded
      const caseLoaded = sessionStorage.getItem('caseLoaded');
      if (!caseLoaded) {
        showAlert('×× × ×˜×¢×Ÿ ×ª×™×§ ×§×™×™× ×ª×—×™×œ×” ××“×£ ×”×‘×—×™×¨×”', 'error');
        setTimeout(() => {
          window.location.href = 'selection.html';
        }, 2000);
        return;
      }

      // Load vehicle info
      loadVehicleInfo();
      
      // Load damage centers for validation
      loadDamageCentersValidation();
      
      // Set up estimate type handlers
      setupEstimateTypeHandlers();
      
      // Action buttons now use direct onclick handlers (depreciation module style)
      
      // Calculate initial totals
      calculateEstimateTotals();
    }

    function initializeSessionMode() {
      // Load existing session data for estimate building
      console.log('ğŸ”„ Initializing session mode for estimate building');
      
      // Load helper data and populate fields
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      if (helper && helper.meta && helper.meta.plate) {
        console.log('ğŸ“‹ Loading existing case data for plate:', helper.meta.plate);
        loadVehicleInfo();
        loadDamageCentersValidation();
        setupEstimateTypeHandlers();
        setupPostSessionActions();
        calculateEstimateTotals();
      }
    }

    function loadVehicleInfo() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Check if data was prepared by report selection page
      let carDetails = helper.car_details || {};
      let generalInfo = helper.general_info || {};
      let meta = helper.meta || {};
      
      const buildersReady = sessionStorage.getItem('buildersPopulated');
      if (buildersReady) {
        console.log('ğŸ”§ Loading car details from report selection page...');
        
        // Load car details from report selection page
        const carDetailsData = sessionStorage.getItem('builderData_carDetails');
        if (carDetailsData) {
          try {
            const builderCarDetails = JSON.parse(carDetailsData);
            carDetails = { ...carDetails, ...builderCarDetails };
            console.log('âœ… Car details loaded from report selection:', builderCarDetails);
          } catch (e) {
            console.error('Error parsing car details:', e);
          }
        }
        
        // Load general info from report selection page
        const generalInfoData = sessionStorage.getItem('builderData_generalInfo');
        if (generalInfoData) {
          try {
            const builderGeneralInfo = JSON.parse(generalInfoData);
            generalInfo = { ...generalInfo, ...builderGeneralInfo };
            console.log('âœ… General info loaded from report selection:', builderGeneralInfo);
          } catch (e) {
            console.error('Error parsing general info:', e);
          }
        }
        
        // Load meta info from report selection page
        const metaData = sessionStorage.getItem('builderData_meta');
        if (metaData) {
          try {
            const builderMeta = JSON.parse(metaData);
            meta = { ...meta, ...builderMeta };
            console.log('âœ… Meta info loaded from report selection:', builderMeta);
          } catch (e) {
            console.error('Error parsing meta info:', e);
          }
        }
      }
      
      const vehicleInfo = document.getElementById('vehicle-info');
      
      vehicleInfo.innerHTML = `
        <div class="section">
          <h3>×¤×¨×˜×™ ×¨×›×‘</h3>
          <div class="row">
            <div class="field">
              <label>××¡×¤×¨ ×¨×›×‘:</label>
              <input type="text" value="${generalInfo.plate_number || meta.plate || carDetails.plate || ''}" readonly>
            </div>
            <div class="field">
              <label>×™×¦×¨×Ÿ:</label>
              <input type="text" value="${carDetails.manufacturer || ''}" readonly>
            </div>
            <div class="field">
              <label>×“×’×:</label>
              <input type="text" value="${carDetails.model || ''}" readonly>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>×©× ×ª ×™×¦×•×¨:</label>
              <input type="text" value="${carDetails.year || ''}" readonly>
            </div>
            <div class="field">
              <label>×ª××¨×™×š ×‘×“×™×§×”:</label>
              <input type="text" value="${meta.inspection_date || carDetails.report_date || ''}" readonly>
            </div>
          </div>
        </div>
      `;
    }

    function loadDamageCentersValidation() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      const damageList = document.getElementById('damage-validation-list');
      
      if (!helper.damage_sections || helper.damage_sections.length === 0) {
        damageList.innerHTML = '<p>×œ× × ××¦××• ××•×§×“×™ × ×–×§ ×‘××§×¡×¤×¨×˜×™×–×”</p>';
        return;
      }

      damageList.innerHTML = helper.damage_sections.map((center, index) => `
        <div class="damage-override" data-index="${index}">
          <div class="damage-override-header">
            <h4>××•×§×“ × ×–×§ ${index + 1}: ${center.zone || '×œ× ××•×’×“×¨'}</h4>
            <button type="button" class="override-toggle" onclick="toggleDamageOverride(${index})">
              ×¢×¨×•×š × ×ª×•× ×™×
            </button>
          </div>
          <div class="row">
            <div class="field">
              <label>××–×•×¨ × ×–×§:</label>
              <input type="text" id="zone-${index}" value="${center.zone || ''}" readonly>
            </div>
            <div class="field">
              <label>×ª×™××•×¨ ×›×œ×œ×™:</label>
              <input type="text" id="desc-${index}" value="${center.zone_description || ''}" readonly>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>××¡×¤×¨ ×—×œ×§×™×:</label>
              <input type="text" value="${center.parts?.length || 0}" readonly>
            </div>
            <div class="field">
              <label>××¡×¤×¨ ×ª×™×§×•× ×™×:</label>
              <input type="text" value="${center.repairs?.length || 0}" readonly>
            </div>
          </div>
        </div>
      `).join('');
    }

    function toggleDamageOverride(index) {
      const zoneInput = document.getElementById(`zone-${index}`);
      const descInput = document.getElementById(`desc-${index}`);
      const button = event.target;
      
      if (zoneInput.readOnly) {
        zoneInput.readOnly = false;
        descInput.readOnly = false;
        button.textContent = '×©××•×¨ ×©×™× ×•×™×™×';
        button.style.background = '#28a745';
      } else {
        zoneInput.readOnly = true;
        descInput.readOnly = true;
        button.textContent = '×¢×¨×•×š × ×ª×•× ×™×';
        button.style.background = '#ffc107';
        
        // Update helper data
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        if (helper.damage_sections && helper.damage_sections[index]) {
          helper.damage_sections[index].zone = zoneInput.value;
          helper.damage_sections[index].zone_description = descInput.value;
          sessionStorage.setItem('helper', JSON.stringify(helper));
        }
        
        showAlert('×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”');
      }
    }

    function setupEstimateTypeHandlers() {
      const typeInputs = document.querySelectorAll('input[name="estimate-type"]');
      typeInputs.forEach(input => {
        input.addEventListener('change', updateLegalTextPreview);
      });
      
      // Load initial preview
      updateLegalTextPreview();
    }

    async function updateLegalTextPreview() {
      const selectedType = document.querySelector('input[name="estimate-type"]:checked').value;
      const legalTextDiv = document.getElementById('legal-text');
      
      try {
        // Load legal text from vault
        const vault = window.vaultTexts || {};
        const estimateKey = `estimate_${selectedType}`;
        const text = vault[estimateKey]?.text || '×˜×§×¡×˜ ××©×¤×˜×™ ×œ× × ××¦×';
        
        legalTextDiv.textContent = text.substring(0, 200) + '...';
      } catch (error) {
        legalTextDiv.textContent = '×©×’×™××” ×‘×˜×¢×™× ×ª ×”×˜×§×¡×˜ ×”××©×¤×˜×™';
      }
    }

    function calculateEstimateTotals() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      const baseDamage = helper.expertise?.calculations?.base_damage || 0;
      
      // Import MathEngine to get VAT rate from admin hub settings
      import('./math.js').then(({ MathEngine }) => {
        const vatRate = MathEngine.getVatRate(); // Get VAT from math.js (controlled by admin hub)
        const vat = Math.round(baseDamage * vatRate / 100);
        const total = baseDamage + vat;
        
        document.getElementById('base-damage-total').textContent = `â‚ª${baseDamage.toLocaleString()}`;
        document.getElementById('vat-rate').textContent = vatRate;
        document.getElementById('vat-amount').textContent = `â‚ª${vat.toLocaleString()}`;
        document.getElementById('total-claim').textContent = `â‚ª${total.toLocaleString()}`;
      }).catch(() => {
        // Fallback to default 18% if math.js not available
        const vatRate = 18;
        const vat = Math.round(baseDamage * vatRate / 100);
        const total = baseDamage + vat;
        
        document.getElementById('base-damage-total').textContent = `â‚ª${baseDamage.toLocaleString()}`;
        document.getElementById('vat-rate').textContent = vatRate;
        document.getElementById('vat-amount').textContent = `â‚ª${vat.toLocaleString()}`;
        document.getElementById('total-claim').textContent = `â‚ª${total.toLocaleString()}`;
      });
    }

    // GLOBAL BUTTON FUNCTIONS - COPIED STYLE FROM DEPRECIATION MODULE
    window.saveEstimate = function() {
      console.log('ğŸ’¾ Save estimate button clicked');
      const selectedTypeElement = document.querySelector('input[name="estimate-type"]:checked');
      if (!selectedTypeElement) {
        showAlert('×× × ×‘×—×¨ ×¡×•×’ ××•××“×Ÿ', 'error');
        return;
      }
      const selectedType = selectedTypeElement.value;
      const additionalNotes = document.getElementById('additional-notes').value;
      
      // Update helper with estimate type and additional data
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      helper.estimate_type = selectedType;
      helper.estimate_notes = additionalNotes;
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      if (window.estimateGenerator) {
        window.estimateGenerator.setType(selectedType);
        if (additionalNotes) {
          window.estimateGenerator.addNotes(additionalNotes);
        }
      }
      
      showAlert('××•××“×Ÿ × ×©××¨ ×‘×”×¦×œ×—×”', 'success');
    };

    window.previewEstimate = function() {
      console.log('ğŸ‘ï¸ Preview estimate button clicked');
      const selectedTypeElement = document.querySelector('input[name="estimate-type"]:checked');
      if (!selectedTypeElement) {
        showAlert('×× × ×‘×—×¨ ×¡×•×’ ××•××“×Ÿ', 'error');
        return;
      }
      const selectedType = selectedTypeElement.value;
      
      // Update helper with current estimate type
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      helper.estimate_type = selectedType;
      sessionStorage.setItem('helper', JSON.stringify(helper));
      sessionStorage.setItem('selectedReportType', 'estimate');
      
      // Proceed to validation
      window.location.href = 'estimate-validation.html';
    };

    window.generateEstimate = function() {
      console.log('ğŸ“„ Generate estimate button clicked');
      const selectedTypeElement = document.querySelector('input[name="estimate-type"]:checked');
      if (!selectedTypeElement) {
        showAlert('×× × ×‘×—×¨ ×¡×•×’ ××•××“×Ÿ', 'error');
        return;
      }
      const selectedType = selectedTypeElement.value;
      const additionalNotes = document.getElementById('additional-notes').value;
      
      // Update helper with all estimate data
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      helper.estimate_type = selectedType;
      helper.estimate_notes = additionalNotes;
      sessionStorage.setItem('helper', JSON.stringify(helper));
      sessionStorage.setItem('selectedReportType', 'estimate');
      
      // Proceed to validation
      window.location.href = 'estimate-validation.html';
    };

    // Depreciation functions for enhanced estimate builder
    function addDepField() {
      const table = document.getElementById('depreciationBulkTable');
      const index = table.children.length;
      
      const row = document.createElement('div');
      row.style.cssText = 'display:grid; grid-template-columns:1fr 1fr 120px 120px 80px; gap:14px; margin-bottom:10px;';
      row.innerHTML = `
        <input type="text" placeholder="×”×—×œ×§ ×”× ×™×–×•×§" id="depPart${index}" />
        <input type="text" placeholder="××”×•×ª ×”×ª×™×§×•×Ÿ" id="depRepair${index}" />
        <input type="number" placeholder="%" id="depPercent${index}" onchange="calculateDepValue(${index})" />
        <input type="number" placeholder="â‚ª" id="depValue${index}" readonly style="background:#f4f6fa;" />
        <button type="button" onclick="removeDepField(${index})" style="background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;">×”×¡×¨</button>
      `;
      table.appendChild(row);
    }

    function removeDepField(index) {
      const table = document.getElementById('depreciationBulkTable');
      if (table.children[index]) {
        table.children[index].remove();
      }
    }

    function calculateDepValue(index) {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      const marketValue = helper.calculations?.market_value || 0;
      const percentInput = document.getElementById(`depPercent${index}`);
      const valueInput = document.getElementById(`depValue${index}`);
      
      if (percentInput && valueInput && marketValue > 0) {
        const percent = parseFloat(percentInput.value) || 0;
        const value = Math.round(marketValue * percent / 100);
        valueInput.value = value;
      }
    }

    // Make functions global
    window.toggleDamageOverride = toggleDamageOverride;
    window.addDepField = addDepField;
    window.removeDepField = removeDepField;
    window.calculateDepValue = calculateDepValue;

    // Enhanced form validation
    document.addEventListener('input', (e) => {
      if (e.target.matches('input[type="number"]')) {
        const value = parseFloat(e.target.value);
        if (value < 0) {
          e.target.value = 0;
          showAlert('×”×¢×¨×š ×œ× ×™×›×•×œ ×œ×”×™×•×ª ×©×œ×™×œ×™', 'error');
        }
      }
    });

    // Add keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        switch (e.key) {
          case 's':
            e.preventDefault();
            if (window.saveEstimate) window.saveEstimate();
            break;
          case 'p':
            e.preventDefault();
            if (window.previewEstimate) window.previewEstimate();
            break;
        }
      }
    });
  </script>

  <!-- Floating Screens Scripts - COPIED FROM DEPRECIATION MODULE -->
  <script src="internal-browser.js"></script>
  <script src="levi-floating.js"></script>
  <script src="car-details-floating.js"></script>
</body>
</html>