<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>×‘× ×™×™×ª ××•××“×Ÿ - ×™×¨×•×Ÿ ×›×™×•×£</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" type="image/webp">
  <style>
    body {
      font-family: sans-serif;
      background: #f3f6fb;
      margin: 0;
      min-height: 100vh;
      padding: 0;
      padding-top: 90px;
      overflow-x: hidden;
    }
    .container {
      width: 100%;
      max-width:750px;
      background: #fff;
      padding: 32px 24px 24px 24px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.08);
      margin: 32px auto 32px auto;
      box-sizing: border-box;
    }
    .logo {
      display: flex;
      justify-content: center;
      margin-bottom: 8px;
    }
    .logo img {
      width: 112px;
      height: auto;
      display: block;
    }
    .title { font-size: 27px; font-weight: bold; text-align: center; margin-bottom: 2px; font-weight: 900;}
    .subtitle { font-size: 23px; color: #666; text-align: center; margin-bottom: 10px;}
    h1, h2 { color: #1e3a8a; font-size: 25px; text-align: center; margin: 15px 0 8px 0; font-weight: 600;}
    h3 { color: #1e3a8a; font-size: 24px; margin: 22px 0 12px 0; text-align: right; font-weight: 900;}
    .form-section {
      width: 100%;
      margin-bottom: 20px;
      background: #fafbfe;
      border-radius: 12px;
      padding: 17px 15px 12px 15px;
      box-sizing: border-box;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px 18px;
      width: 100%;
    }
    @media (max-width: 600px) {
      .form-grid { grid-template-columns: 1fr; }
      .container { padding: 14px 2vw 20px 2vw; }
    }
    
    /* Mobile viewport fixes */
    @media (max-width: 768px) {
      body {
        width: 100vw;
        overflow-x: hidden !important;
        position: relative;
      }
      
      html {
        width: 100vw;
        overflow-x: hidden !important;
      }
      
      .container {
        width: 95vw;
        max-width: 95vw;
        margin: 32px 2.5vw 32px 2.5vw;
      }
    }
    label {
      font-size: 18px;
      margin-bottom: 4px;
      display: block;
      text-align: right;
    }
    input, select, textarea {
      width: 100%;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 0px;
      padding: 8px 9px;
      box-sizing: border-box;
      text-align: right;
      background: #f9f9f9;
      transition: border .15s;
      outline: none;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #3b82f6;
    }
    .readonly-box {
      background: #f4f6fa;
      border-radius: 6px;
      border: 1px solid #eee;
      padding: 7px 8px;
      min-height: 20px;
      font-size: 16px;
      color: #333;
      text-align: right;
    }
    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      display: block;
    }
    
    /* FLOATING SCREENS STYLING - COPIED FROM DEPRECIATION */
    .floating-toggles-top {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 8px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .toggle-square {
      width: 80px;
      height: 70px;
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: white;
      text-align: center;
      border: 2px solid transparent;
    }

    .toggle-square:hover {
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .toggle-square.active {
      border-color: #fbbf24;
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
    }

    .toggle-icon {
      font-size: 18px;
      margin-bottom: 2px;
    }

    .toggle-text {
      font-size: 10px;
      font-weight: 600;
      line-height: 1.1;
    }
    @media (max-width: 768px) {
      .floating-toggles-top {
        top: 5px;
        gap: 4px;
        padding: 6px;
      }
      .toggle-square {
        width: 65px;
        height: 60px;
      }
      .toggle-icon {
        font-size: 16px;
      }
      .toggle-text {
        font-size: 9px;
      }
      
      /* Mobile fixes for depreciation table */
      #depreciationBulkTable .dep-row {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 8px !important;
        background: #f8f9fa;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 12px;
        border: 1px solid #e9ecef;
      }
      
      #depreciationBulkTable .dep-row > div {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      
      #depreciationBulkTable .dep-row > div::before {
        font-weight: bold;
        font-size: 12px;
        color: #495057;
      }
      
      #depreciationBulkTable .dep-row > div:nth-child(1)::before {
        content: "×”×—×œ×§ ×”× ×™×–×•×§:";
      }
      
      #depreciationBulkTable .dep-row > div:nth-child(2)::before {
        content: "××”×•×ª ×”×ª×™×§×•×Ÿ:";
      }
      
      #depreciationBulkTable .dep-row > div:nth-child(3)::before {
        content: "% ×™×¨×™×“×ª ×¢×¨×š:";
      }
      
      #depreciationBulkTable .dep-row > div:nth-child(4)::before {
        content: "×¢×¨×š ×‘-â‚ª:";
      }
      
      #depreciationBulkTable .dep-row > div:nth-child(5)::before {
        content: "×¤×¢×•×œ×•×ª:";
      }
      
      /* Hide table headers on mobile */
      #depreciationSection > div:first-child {
        display: none !important;
      }
      
      /* Fix button spacing on mobile */
      .btn.add {
        width: 100% !important;
        margin-top: 8px !important;
      }
      
      /* Navigation buttons mobile responsive */
      .nav-btn {
        font-size: 14px !important;
        padding: 10px 8px !important;
        min-height: 44px !important;
      }
      
      /* Damage centers mobile responsive */
      #damageCentersContent > div > div > div:nth-child(n+1) {
        grid-template-columns: 1fr 1fr !important;
        gap: 4px !important;
      }
      
      /* Levi adjustments mobile responsive */
      .levi-adjustments-grid {
        grid-template-columns: 1fr !important;
        gap: 4px !important;
      }
      
      .levi-adjustment-row {
        grid-template-columns: 1fr !important;
        gap: 4px !important;
        padding: 8px !important;
      }
      
      .levi-adjustment-row > div {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
      }
      
      .levi-adjustment-row > div:nth-child(1)::after {
        content: "";
      }
      
      .levi-adjustment-row > div:nth-child(2)::before {
        content: "××—×•×–: ";
        font-weight: bold;
        color: #495057;
      }
      
      .levi-adjustment-row > div:nth-child(3)::before {
        content: "×¢×¨×š: ";
        font-weight: bold;
        color: #495057;
      }
      
      /* Custom summary rows mobile responsive */
      .custom-summary-row {
        grid-template-columns: 1fr !important;
        gap: 8px !important;
      }
      
      .custom-summary-row > input {
        margin-bottom: 4px;
      }
    }
    
    .collapsible-btn {
      background: #e0e7f1;
      font-family: sans-serif;
      color: #1e3a8a;
      border: none;
      padding: 7px 18px;
      border-radius: 7px;
      margin-bottom: 8px;
      margin-top: 2px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      text-align: right;
      width: auto;
      display: inline-block;
    }

    .collapsible-btn:hover {
      background: #d1d9e6;
    }

    .btn.add {
      background: #28a745;
      margin-top: 7px;
      margin-bottom: 0;
      width: auto;
      padding: 8px 18px;
      font-size: 16px;
      display: block;
    }

    /* Navigation Buttons Styling */
    .nav-btn {
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      min-height: 48px;
    }

    .save-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    .save-btn:hover {
      background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    .preview-btn {
      background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
    }
    .preview-btn:hover {
      background: linear-gradient(135deg, #138496 0%, #1ea085 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
    }

    .generate-btn {
      background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);
    }
    .generate-btn:hover {
      background: linear-gradient(135deg, #0056b3 0%, #520dc2 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }

    .back-btn {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    }
    .back-btn:hover {
      background: linear-gradient(135deg, #545b62 0%, #3d4142 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
    }
    
    .footer {
      margin-top: 40px;
      font-size: 12px;
      color: #aaa;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- FLOATING SCREEN TOGGLES - TOP OF PAGE -->
  <div class="floating-toggles-top">
    <div class="toggle-square" onclick="toggleFloatingScreen('leviReport')">
      <div class="toggle-icon">ğŸ“Š</div>
      <div class="toggle-text">×“×•"×— ×œ×•×™ ×™×¦×—×§</div>
    </div>
    <div class="toggle-square" onclick="toggleFloatingScreen('carDetails')">
      <div class="toggle-icon">ğŸš—</div>
      <div class="toggle-text">×¤×¨×˜×™ ×¨×›×‘</div>
    </div>
    <div class="toggle-square" onclick="toggleFloatingScreen('internalBrowser')">
      <div class="toggle-icon">ğŸŒ</div>
      <div class="toggle-text">×“×¤×“×¤×Ÿ ×¤× ×™××™</div>
    </div>
  </div>

  <div class="container">
    <div class="logo"><img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo"></div>
    <div class="title">×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×¤×•×¨×˜×œ</div>
    <div class="subtitle">×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</div>
    <h1>×‘× ×™×™×ª ××•××“×Ÿ × ×–×§×™ ×¨×›×‘</h1>
    <h2 id="pageTitle">×¨×›×‘ ××¡. ...</h2>

    <!-- ESTIMATE TYPE SELECTION -->
    <div class="form-section" id="estimate-type">
      <h3>×¡×•×’ ×”××•××“×Ÿ</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
        <label style="border: 1px solid #ddd; padding: 10px; border-radius: 6px; cursor: pointer;">
          <input type="radio" name="estimate-type" value="××•×‘×“×Ÿ_×œ×”×œ×›×”" checked style="width: auto; margin-left: 8px;">
          ××•××“×Ÿ ×¨××©×•× ×™ - ××•×‘×“×Ÿ ×œ×”×œ×›×”
        </label>
        <label style="border: 1px solid #ddd; padding: 10px; border-radius: 6px; cursor: pointer;">
          <input type="radio" name="estimate-type" value="×˜×•×˜×œ×•×¡" style="width: auto; margin-left: 8px;">
          ××•××“×Ÿ ×¨××©×•× ×™ - ×˜×•×˜×œ×•×¡
        </label>
      </div>
    </div>

    <!-- VEHICLE DATA - EDITABLE FROM HELPER -->
    <div class="form-section">
      <h3>× ×ª×•× ×™ ×¨×›×‘</h3>
      <div class="form-grid" id="vehicleData">
        <div>
          <label>××¡×¤×¨ ×¨×›×‘:</label>
          <input type="text" id="carPlate" />
        </div>
        <div>
          <label>×ª×•×¦×¨×ª:</label>
          <input type="text" id="carManufacturer" />
        </div>
        <div>
          <label>×“×’×:</label>
          <input type="text" id="carModel" />
        </div>
        <div>
          <label>×©× ×ª ×™×™×¦×•×¨:</label>
          <input type="text" id="carYear" />
        </div>
        <div>
          <label>×§×•×“ ×“×’×:</label>
          <input type="text" id="carModelCode" />
        </div>
        <div>
          <label>××—×™×¨ ×‘×¡×™×¡:</label>
          <input type="text" id="carBasePrice" />
        </div>
        <div>
          <label>×¢×¨×š ×”×©×•×§ ×©×œ ×”×¨×›×‘:</label>
          <input type="text" id="carMarketValue" />
        </div>
        <div>
          <label>×ª××¨×™×š ×”×¤×§×”:</label>
          <input type="text" id="carReportDate" />
        </div>
      </div>
    </div>


    <!-- COLLAPSIBLE CONTACT DATA -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('contactData')">× ×ª×•× ×™ ×”×ª×§×©×¨×•×ª (×”×¦×’/×”×¡×ª×¨)</button>
      <div id="contactData" style="display:none;">
        <div class="form-grid">
          <div><label>×©× ×‘×¢×œ ×”×¨×›×‘:</label><input type="text" id="ownerName" /></div>
          <div><label>×›×ª×•×‘×ª ×‘×¢×œ ×”×¨×›×‘:</label><input type="text" id="ownerAddress" /></div>
          <div><label>×˜×œ×¤×•×Ÿ ×‘×¢×œ ×”×¨×›×‘:</label><input type="text" id="ownerPhone" /></div>
          <div><label>×—×‘×¨×ª ×‘×™×˜×•×—:</label><input type="text" id="insuranceCompany" /></div>
          <div><label>××™××™×™×œ ×—×‘×¨×ª ×‘×™×˜×•×—:</label><input type="text" id="insuranceEmail" /></div>
          <div><label>×¡×•×›×Ÿ ×‘×™×˜×•×—:</label><input type="text" id="insuranceAgent" /></div>
          <div><label>×˜×œ×¤×•×Ÿ ×¡×•×›×Ÿ ×‘×™×˜×•×—:</label><input type="text" id="agentPhone" /></div>
          <div><label>××™××™×™×œ ×¡×•×›×Ÿ ×‘×™×˜×•×—:</label><input type="text" id="agentEmail" /></div>
        </div>
      </div>
    </div>

    <!-- DAMAGE CENTERS SUMMARY SECTION - EDITABLE -->
    <div class="form-section">
      <h3>×¡×™×›×•× ××•×§×“×™ × ×–×§ (× ×™×ª×Ÿ ×œ×¢×¨×™×›×”)</h3>
      <div id="damageCentersSummary">
        <div style="background: #f8f9fa; border-radius: 6px; padding: 15px; min-height: 50px;" id="damageCentersContent">
          <div style="color: #666; text-align: center;">×˜×•×¢×Ÿ × ×ª×•× ×™ ××•×§×“×™ × ×–×§...</div>
        </div>
        <button type="button" class="btn add" onclick="addNewDamageCenter()" style="margin-top: 10px;">×”×•×¡×£ ××•×§×“ × ×–×§ ×—×“×©</button>
      </div>
    </div>

    <!-- COLLAPSIBLE PRICE DATA -->
    <div class="form-section">
      <button class="collapsible-btn" type="button" onclick="toggleSection('priceData')">× ×ª×•× ×™ ×ª×‘×™×¢×” (×”×¦×’/×”×¡×ª×¨)</button>
      <div id="priceData" style="display:none;">
        <div class="form-grid">
          <div><label>×¡×”×´×› ×ª×‘×™×¢×”:</label><input type="text" id="totalClaim" style="background: #f8f9fa;" readonly /></div>
          <div><label>×¢×¨×š ×”×¨×›×‘ ×œ× ×–×§ ×’×•×œ××™:</label><input type="text" id="leviPriceList" style="background: #f8f9fa;" readonly /></div>
          <div><label>×—×™×©×•×‘ ×”××—×•×– ×”×’×•×œ××™:</label><input type="text" id="grossPercent" style="background: #f8f9fa;" readonly /></div>
          <div><label>×¡×”"×› ×ª×‘×™×¢×” (×××•×©×¨):</label><input type="text" id="authorizedClaim" /></div>
        </div>
      </div>
    </div>

    <!-- DEPRECIATION CALCULATION SECTION -->
    <div class="form-section" id="depreciationSection">
      <h3>×—×™×©×•×‘ ×™×¨×™×“×ª ×¢×¨×š ×œ×¤×™ ××•×§×“×™ × ×–×§</h3>
      <div style="display:grid; grid-template-columns:1fr 1fr 120px 120px 80px; gap:14px; margin-bottom:10px;">
        <div><label>×”×—×œ×§ ×”× ×™×–×•×§:</label></div>
        <div><label>××”×•×ª ×”×ª×™×§×•×Ÿ:</label></div>
        <div><label>% ×™×¨×™×“×ª ×¢×¨×š:</label></div>
        <div><label>×¢×¨×š ×‘-â‚ª:</label></div>
        <div><label>×¤×¢×•×œ×•×ª:</label></div>
      </div>
      <div id="depreciationBulkTable"></div>
      <button class="btn add" type="button" onclick="addDepField()">×”×•×¡×£ ×©×“×”</button>
      <div style="margin-top:14px;">
        <label>×™×¨×™×“×ª ×¢×¨×š ×’×œ×•×‘×œ×™:</label>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:14px;">
          <input type="text" id="globalDep1" placeholder="% ×™×¨×™×“×ª ×¢×¨×š" />
          <input type="text" id="globalDepValue" placeholder="×¢×¨×š ×‘-â‚ª" readonly style="background:#f4f6fa;" />
        </div>
      </div>
      <div style="margin-top:14px;">
        <label>×™××™ ××•×¡×š ××©×•×¢×¨×™×:</label>
        <input type="number" id="garageDays" placeholder="××¡×¤×¨ ×™××™ ×¢×‘×•×“×”" style="width: 200px;" />
      </div>
    </div>

    <!-- SUMMARY SECTION WITH ORANGE STYLING -->
    <div class="form-section" style="background: linear-gradient(135deg, #ff8c00 0%, #ff7300 100%); color: white; border-radius: 12px; padding: 20px;">
      <h3 style="color: white; text-align: center; margin-bottom: 20px; font-size: 26px;">×¡×™×›×•× ×”××•××“×Ÿ</h3>
      
      <div style="background: rgba(255,255,255,0.95); color: #333; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
        <div class="form-grid">
          <div>
            <label style="color: #333;">×¡×•×’ ×“×•"×—:</label>
            <input type="text" id="reportType" style="background: #f0f0f0; color: #333;" readonly />
          </div>
          <div>
            <label style="color: #333;">×¢×¨×š ×”×©×•×§ ×©×œ ×”×¨×›×‘:</label>
            <input type="text" id="sumMarketValue" style="background: white; color: #333;" />
          </div>
        </div>
        <div class="form-grid">
          <div>
            <label style="color: #333;">×¡×”×´×› ×ª×‘×™×¢×”:</label>
            <input type="text" id="sumClaim" style="background: white; color: #333;" />
          </div>
          <div>
            <label style="color: #333;">×¤×™×¦×•×™ ×‘×’×™×Ÿ ×™×¨×™×“×ª ×¢×¨×š:</label>
            <input type="text" id="depCompensation" style="background: white; color: #333;" />
          </div>
        </div>
        <div class="form-grid">
          <div>
            <label style="color: #333;">×©×•×•×™ ×”×©×¨×™×“×™× (××•×¤×¦×™×•× ×œ×™) - ××•×¤×—×ª ××”×¡×›×•×:</label>
            <input type="text" id="salvageValue" style="background: #fff5f5; color: #333; border: 1px solid #f87171;" placeholder="â‚ª0" />
          </div>
          <div style="display: flex; align-items: center; font-size: 13px; color: #666; padding: 8px;">
            â– ×©×“×” ××•×¤×¦×™×•× ×œ×™ - ××•×¤×—×ª ××”×¡×›×•× ×”×¡×•×¤×™ ×× ××•×œ×
          </div>
        </div>
      </div>
      
      <!-- ×ª×•×¡×¤×•×ª ×•×”×•×¨×“×•×ª SECTION - MOVED BEFORE VAT CALCULATION -->
      <div style="background: rgba(255,255,255,0.95); color: #333; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
        <label style="color: #333; font-weight: bold; margin-bottom: 10px; display: block;">×ª×•×¡×¤×•×ª ×•×”×•×¨×“×•×ª:</label>
        <div class="unified-adjustments-section" id="unifiedAdjustments-estimate" style="background: #f8f9fa; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
          <div style="font-weight: bold; margin-bottom: 8px; color: #495057; font-size: 14px;">×”×ª×××•×ª ××“×•"×— ×œ×•×™ ×™×¦×—×§ ×•×’×•×¨××™× × ×•×¡×¤×™×:</div>
          <div class="levi-adjustments-grid" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 8px; font-size: 13px;">
            <div style="font-weight: bold;">××”×•×ª ×”×”×ª×××”</div>
            <div style="font-weight: bold;">×¡×•×’</div>
            <div style="font-weight: bold;">××—×•×–</div>
            <div style="font-weight: bold;">×¢×¨×š (â‚ª)</div>
            <div style="font-weight: bold;">×¤×¢×•×œ×•×ª</div>
          </div>
          <div id="allAdjustmentsRows-estimate"></div>
          <button class="btn add" type="button" onclick="addCustomAdjustmentField()" style="color: #333; background: #28a745; margin-top: 8px; font-size: 13px;">×”×•×¡×£ ×”×ª×××” × ×•×¡×¤×ª</button>
        </div>
      </div>
      
      <!-- VAT AND TOTAL CALCULATION SECTION -->
      <div style="background: rgba(255,255,255,0.95); color: #333; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
        <div class="form-grid">
          <div>
            <label style="color: #333;">××¢×´× (18%):</label>
            <input type="text" id="sumVAT" style="background: white; color: #333;" readonly />
          </div>
          <div>
            <label style="color: #333:">×¡×”×´×› × ×›×œ×œ ×‘××•××“×Ÿ</label>
            <input type="text" id="sumTotalClaim" style="background: #e8f5e8; color: #333; font-weight: bold;" readonly />
          </div>
        </div>
      </div>
    </div>

    <!-- ADDITIONAL NOTES -->
    <div class="form-section">
      <h3>×”×¢×¨×•×ª × ×•×¡×¤×•×ª ×œ××•××“×Ÿ</h3>
      <textarea id="additional-notes" placeholder="×”×•×¡×£ ×”×¢×¨×•×ª, ×”××œ×¦×•×ª ××• ××™×“×¢ × ×•×¡×£ ×œ××•××“×Ÿ..." style="min-height: 80px;"></textarea>
    </div>

    <!-- Navigation Buttons -->
    <div class="form-section">
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
        <button type="button" class="nav-btn save-btn" onclick="saveEstimate()">×©××•×¨ ××•××“×Ÿ</button>
        <button type="button" class="nav-btn preview-btn" onclick="previewEstimate()">×ª×¦×•×’×” ××§×“×™××”</button>
        <button type="button" class="nav-btn generate-btn" onclick="generateEstimate()">×¦×•×¨ ×“×•"×— ××•××“×Ÿ</button>
        <button type="button" class="nav-btn back-btn" onclick="window.location.href='selection.html'">×—×–×•×¨ ×œ×“×£ ×”×‘×—×™×¨×”</button>
      </div>
    </div>

    <!-- LEGAL TEXT SECTION - EDITABLE -->
    <div class="form-section" id="legal-text">
      <h3>×˜×§×¡×˜ ××©×¤×˜×™ ×œ××•××“×Ÿ</h3>
      <div style="margin-bottom: 10px;">
        <button type="button" onclick="loadLegalTextFromVault()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-left: 10px;">×˜×¢×Ÿ ××”×›×¡×¤×ª</button>
        <button type="button" onclick="resetLegalText()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">××™×¤×•×¡ ×˜×§×¡×˜</button>
      </div>
      <textarea id="legal-text-content" style="width: 100%; min-height: 200px; padding: 15px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8f9fa; line-height: 1.6; font-family: inherit; resize: vertical; box-sizing: border-box;" placeholder="×”×˜×§×¡×˜ ×”××©×¤×˜×™ ×™×˜×¢×Ÿ ×›××Ÿ ×¢× ×”× ×ª×•× ×™× ×”××¢×•×“×›× ×™×...">×”×˜×§×¡×˜ ×”××©×¤×˜×™ ×™×˜×¢×Ÿ ×›××Ÿ ×¢× ×”× ×ª×•× ×™× ×”××¢×•×“×›× ×™×...</textarea>
      <div style="margin-top: 8px; font-size: 14px; color: #666;">
        ğŸ’¡ ×”×˜×§×¡×˜ × ×™×ª×Ÿ ×œ×¢×¨×™×›×” ×œ×¦×•×¨×š ×”×ª×××” ×œ×“×•×— ×”×¡×¤×¦×™×¤×™. ×”×©×™× ×•×™×™× ×œ× ×™×©×¤×™×¢×• ×¢×œ ×”×›×¡×¤×ª ×”××§×•×¨×™×ª.
      </div>
    </div>

    <div class="footer">All rights reserved Â© Carmel Cayouf</div>
  </div>

  
  <script>
    // Authentication check
    const auth = sessionStorage.getItem("auth");
    if (!auth) {
      alert("×”×’×™×©×” ×—×¡×•××” - ×× × ×”×ª×—×‘×¨ ×“×¨×š ×“×£ ×”×‘×™×ª");
      window.location.href = "index.html";
    }

    // FLOATING SCREENS TOGGLE FUNCTION - COPIED FROM DEPRECIATION MODULE
    window.toggleFloatingScreen = function(screenType) {
      console.log('Toggling floating screen:', screenType);
      
      const screens = {
        leviReport: () => {
          if (window.toggleLeviReport) {
            window.toggleLeviReport();
          } else {
            console.log('Levi report floating screen not available');
          }
        },
        carDetails: () => {
          if (window.toggleCarDetails) {
            window.toggleCarDetails();
          } else {
            console.log('Car details floating screen not available');
          }
        },
        internalBrowser: () => {
          if (window.showBrowserMenu) {
            showBrowserMenuUnderToggle();
          } else {
            console.log('Internal browser not available');
          }
        }
      };
      
      if (screens[screenType]) {
        screens[screenType]();
      } else {
        console.log('Unknown screen type:', screenType);
      }
    };

    // CUSTOM BROWSER MENU - COPIED FROM DEPRECIATION MODULE
    function showBrowserMenuUnderToggle() {
      const menu = document.createElement('div');
      menu.style.cssText = `
        position: fixed;
        top: 90px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 20px;
        z-index: 99999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        font-family: sans-serif;
        direction: rtl;
        min-width: 280px;
      `;
      
      menu.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 15px; color: #2c3e50; font-size: 16px;">×‘×—×¨ ××ª×¨ ×œ×¤×ª×™×—×”:</div>
        <button onclick="window.openInternalBrowser('car-part.co.il'); this.parentElement.remove();" style="width: 100%; padding: 12px; margin-bottom: 8px; border: none; background: #28a745; color: white; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 500;">
          ğŸ”§ Car Part - ×—×œ×§×™ ×¨×›×‘
        </button>
        <button onclick="window.openInternalBrowser('portal.levi-itzhak.co.il'); this.parentElement.remove();" style="width: 100%; padding: 12px; margin-bottom: 8px; border: none; background: #007bff; color: white; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 500;">
          ğŸ“Š ×¤×•×¨×˜×œ ×œ×•×™ ×™×¦×—×§
        </button>
        <button onclick="this.parentElement.remove();" style="width: 100%; padding: 10px; border: 1px solid #ccc; background: white; color: #666; border-radius: 6px; cursor: pointer; font-size: 14px;">
          ×‘×™×˜×•×œ
        </button>
      `;
      
      document.body.appendChild(menu);
      
      // Remove menu when clicking outside
      setTimeout(() => {
        document.addEventListener('click', function removeMenu(e) {
          if (!menu.contains(e.target)) {
            menu.remove();
            document.removeEventListener('click', removeMenu);
          }
        });
      }, 100);
    }

    // COLLAPSIBLE SECTION TOGGLE
    window.toggleSection = function(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        section.style.display = section.style.display === 'none' ? 'block' : 'none';
      }
    };

    // BUTTON FUNCTIONS - NO DEBUG ALERTS
    window.saveEstimate = function() {
      const selectedTypeElement = document.querySelector('input[name="estimate-type"]:checked');
      if (!selectedTypeElement) {
        alert('×× × ×‘×—×¨ ×¡×•×’ ××•××“×Ÿ');
        return;
      }
      
      const selectedType = selectedTypeElement.value;
      const additionalNotes = document.getElementById('additional-notes')?.value || '';
      
      // Get summary data
      const summaryData = {
        market_value: document.getElementById('sumMarketValue')?.value || '',
        total_claim: document.getElementById('sumClaim')?.value || '',
        vat: document.getElementById('sumVAT')?.value || '',
        total_with_vat: document.getElementById('sumTotalClaim')?.value || '',
        dep_compensation: document.getElementById('depCompensation')?.value || '',
        salvage_value: document.getElementById('salvageValue')?.value || ''
      };
      
      // Get depreciation data
      const depreciationData = {
        global_percent: document.getElementById('globalDep1')?.value || '',
        global_value: document.getElementById('globalDepValue')?.value || '',
        bulk_items: []
      };
      
      // Collect depreciation bulk items
      const depRows = document.querySelectorAll('#depreciationBulkTable .dep-row');
      depRows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        if (inputs.length >= 4) {
          depreciationData.bulk_items.push({
            damaged_part: inputs[0].value,
            repair_type: inputs[1].value,
            percent: inputs[2].value,
            value: inputs[3].value
          });
        }
      });
      
      // Save to helper
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      helper.estimate_type = selectedType;
      helper.estimate_notes = additionalNotes;
      helper.estimate_summary = summaryData;
      helper.estimate_depreciation = depreciationData;
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      alert('××•××“×Ÿ × ×©××¨ ×‘×”×¦×œ×—×”');
    };

    window.previewEstimate = function() {
      // First save all data
      window.saveEstimate();
      
      // Set report type and navigate
      sessionStorage.setItem('selectedReportType', 'estimate');
      window.location.href = 'estimate-validation.html';
    };

    window.generateEstimate = function() {
      // First save all data
      window.saveEstimate();
      
      // Set report type and navigate to final report generation
      sessionStorage.setItem('selectedReportType', 'estimate');
      window.location.href = 'estimate-report-builder.html';
    };

    // LOAD DATA FROM HELPER
    function loadDataFromHelper() {
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        // Load car details (now editable) and sync vehicle structure
        if (helper.car_details || helper.meta) {
          document.getElementById('carPlate').value = helper.meta?.plate || helper.car_details?.plate || '';
          document.getElementById('carManufacturer').value = helper.car_details?.manufacturer || '';
          document.getElementById('carModel').value = helper.car_details?.model || '';
          document.getElementById('carYear').value = helper.car_details?.year || '';
          document.getElementById('carModelCode').value = helper.car_details?.model_code || helper.vehicle?.model_code || '';
          document.getElementById('carBasePrice').value = helper.car_details?.base_price ? `â‚ª${helper.car_details.base_price}` : '';
          document.getElementById('carMarketValue').value = helper.expertise?.calculations?.market_value ? `â‚ª${helper.expertise.calculations.market_value.toLocaleString()}` : '';
          document.getElementById('carReportDate').value = helper.car_details?.report_date || '';
          
          // Ensure vehicle structure is populated on load
          helper.vehicle = helper.vehicle || {};
          helper.vehicle.manufacturer = helper.car_details?.manufacturer || helper.vehicle.manufacturer || '';
          helper.vehicle.model = helper.car_details?.model || helper.vehicle.model || '';
          helper.vehicle.year = helper.car_details?.year || helper.vehicle.year || '';
          helper.vehicle.model_code = helper.car_details?.model_code || helper.vehicle.model_code || '';
          helper.vehicle.plate_number = helper.meta?.plate || helper.car_details?.plate || helper.vehicle.plate_number || '';
          sessionStorage.setItem('helper', JSON.stringify(helper));
        }
        
        // Load claims data (now editable) - with fallback to manual input data
        const calc = helper.expertise?.calculations || {};
        const claimsData = helper.claims_data || {};
        
        // Load with priority: manual input (claims_data) > calculated data (expertise.calculations)
        document.getElementById('totalClaim').value = claimsData.total_claim || 
          (calc.total_damage ? `â‚ª${calc.total_damage.toLocaleString()}` : '');
        document.getElementById('leviPriceList').value = claimsData.levi_price_list || 
          (helper.calculations?.vehicle_value_gross ? `â‚ª${helper.calculations.vehicle_value_gross.toLocaleString()}` : '') ||
          (helper.levi_report?.final_price ? `â‚ª${helper.levi_report.final_price.toLocaleString()}` : '');
        document.getElementById('grossPercent').value = claimsData.gross_percent || 
          (helper.calculations?.damage_percent ? `${helper.calculations.damage_percent}%` : '') ||
          (calc.damage_percent ? `${calc.damage_percent}%` : '');
        document.getElementById('authorizedClaim').value = claimsData.authorized_claim || 
          (calc.total_damage ? `â‚ª${calc.total_damage.toLocaleString()}` : '');
          
        console.log('ğŸ’° Loaded claims data:', { 
          from_claims_data: claimsData, 
          from_calculations: calc 
        });
        
        // Update gross market value field with calculated value
        updateGrossMarketValueField();
        
        // Load contact data (now editable) and sync to car_details
        if (helper.client) {
          document.getElementById('ownerName').value = helper.client.name || '';
          document.getElementById('ownerAddress').value = helper.client.address || '';
          document.getElementById('ownerPhone').value = helper.client.phone || '';
          document.getElementById('insuranceCompany').value = helper.client.insurance_company || '';
          document.getElementById('insuranceEmail').value = helper.client.insurance_email || '';
          document.getElementById('insuranceAgent').value = helper.client.insurance_agent || '';
          document.getElementById('agentPhone').value = helper.client.agent_phone || '';
          document.getElementById('agentEmail').value = helper.client.agent_email || '';
          
          // Sync client data to car_details structure for floating screen compatibility
          helper.car_details = helper.car_details || {};
          helper.car_details.owner = helper.client.name || '';
          helper.car_details.ownerAddress = helper.client.address || '';
          helper.car_details.ownerPhone = helper.client.phone || '';
          helper.car_details.insuranceCompany = helper.client.insurance_company || '';
          helper.car_details.agentName = helper.client.insurance_agent || '';
          helper.car_details.agentPhone = helper.client.agent_phone || '';
          
          // Note: garageName and garagePhone are not in the builder, so they'll remain empty
          helper.car_details.garageName = helper.car_details.garageName || '';
          helper.car_details.garagePhone = helper.car_details.garagePhone || '';
          
          sessionStorage.setItem('helper', JSON.stringify(helper));
        }
        
        // Update page title with plate
        document.getElementById('pageTitle').textContent = `×¨×›×‘ ××¡. ${helper.meta?.plate || helper.car_details?.plate || '...'}`;
        
        // Load summary data
        loadSummaryData(helper);
        
        // Load depreciation data
        loadDepreciationData(helper);
        
        // Load damage centers summary
        loadDamageCentersSummary(helper);
        
        // Load all adjustments (Levi + custom) using unified system
        loadAllAdjustments(helper);
        
        // Add change listeners for all editable fields
        addFieldChangeListeners();
        
      } catch (error) {
        console.error('Error loading data from helper:', error);
      }
    }

    // LOAD SUMMARY DATA AND CALCULATIONS
    function loadSummaryData(helper) {
      try {
        // Set report type based on estimate type selection
        const selectedType = document.querySelector('input[name="estimate-type"]:checked')?.value || '××•×‘×“×Ÿ_×œ×”×œ×›×”';
        const reportTypeText = selectedType === '××•×‘×“×Ÿ_×œ×”×œ×›×”' ? '××•××“×Ÿ ×¨××©×•× ×™ - ××•×‘×“×Ÿ ×œ×”×œ×›×”' : '××•××“×Ÿ ×¨××©×•× ×™ - ×˜×•×˜×œ×•×¡';
        document.getElementById('reportType').value = reportTypeText;
        
        // Check if we have saved summary data first
        if (helper.estimate_summary) {
          document.getElementById('sumMarketValue').value = helper.estimate_summary.market_value || '';
          document.getElementById('sumClaim').value = helper.estimate_summary.total_claim || '';
          document.getElementById('sumVAT').value = helper.estimate_summary.vat || '';
          document.getElementById('sumTotalClaim').value = helper.estimate_summary.total_with_vat || '';
          document.getElementById('depCompensation').value = helper.estimate_summary.dep_compensation || '';
          document.getElementById('salvageValue').value = helper.estimate_summary.salvage_value || '';
        } else {
          // Load from helper calculations if no saved summary
          const marketValue = helper.expertise?.calculations?.market_value || 0;
          const totalClaim = helper.expertise?.calculations?.total_damage || 0;
          
          // Set market value and claim
          document.getElementById('sumMarketValue').value = marketValue ? `â‚ª${marketValue.toLocaleString()}` : '';
          document.getElementById('sumClaim').value = totalClaim ? `â‚ª${totalClaim.toLocaleString()}` : '';
          
          // Calculate VAT (18%)
          const vat = totalClaim * 0.18;
          document.getElementById('sumVAT').value = vat ? `â‚ª${Math.round(vat).toLocaleString()}` : '';
          
          // Calculate total with VAT
          const totalWithVAT = totalClaim + vat;
          document.getElementById('sumTotalClaim').value = totalWithVAT ? `â‚ª${Math.round(totalWithVAT).toLocaleString()}` : '';
          
          // Set depreciation compensation
          const depCompensation = helper.expertise?.calculations?.depreciation_compensation || 0;
          document.getElementById('depCompensation').value = depCompensation ? `â‚ª${depCompensation.toLocaleString()}` : '';
        }
        
        // Load saved estimate notes if available
        if (helper.estimate_notes) {
          document.getElementById('additional-notes').value = helper.estimate_notes;
        }
        
        // Add event listeners for real-time calculations
        addSummaryCalculationListeners();
        
        // TRIGGER INITIAL AUTO-FILL FOR SUMMARY FIELDS
        setTimeout(() => {
          if (window.addSummaryCalculationListeners) {
            const calculateEvent = new Event('input', { bubbles: true });
            
            // Trigger auto-fill from totalClaim to sumClaim
            const totalClaimField = document.getElementById('totalClaim');
            if (totalClaimField && totalClaimField.value) {
              totalClaimField.dispatchEvent(calculateEvent);
            }
            
            // Trigger auto-fill from globalDepValue to depCompensation
            const globalDepField = document.getElementById('globalDepValue');
            if (globalDepField && globalDepField.value) {
              globalDepField.dispatchEvent(calculateEvent);
            }
          }
        }, 200);
        
      } catch (error) {
        console.error('Error loading summary data:', error);
      }
    }

    // ADD CALCULATION LISTENERS FOR SUMMARY WITH MATH.JS - CORRECTED LOGIC
    function addSummaryCalculationListeners() {
      const sumMarketValueInput = document.getElementById('sumMarketValue');
      const sumClaimInput = document.getElementById('sumClaim');
      const depCompensationInput = document.getElementById('depCompensation');
      const sumVATInput = document.getElementById('sumVAT');
      const sumTotalInput = document.getElementById('sumTotalClaim');

      function calculateSummaryTotals() {
        try {
          // Auto-fill market value from car details market price
          const carMarketValue = document.getElementById('carMarketValue')?.value.replace(/[â‚ª,]/g, '') || '0';
          if (carMarketValue && carMarketValue !== '0' && sumMarketValueInput) {
            sumMarketValueInput.value = `â‚ª${parseFloat(carMarketValue).toLocaleString()}`;
          }
          
          // AUTO-FILL SUMMARY CLAIM FROM CLAIMS SECTION
          const totalClaimValue = document.getElementById('totalClaim')?.value;
          if (totalClaimValue && sumClaimInput) {
            sumClaimInput.value = totalClaimValue;
          }
          
          // AUTO-FILL DEPRECIATION COMPENSATION FROM GLOBAL DEPRECIATION VALUE
          const globalDepValue = document.getElementById('globalDepValue')?.value;
          if (globalDepValue && depCompensationInput) {
            depCompensationInput.value = globalDepValue;
          }
          
          // Get values - market price + claim + compensation - salvage = total
          const marketValue = parseFloat(sumMarketValueInput?.value.replace(/[â‚ª,]/g, '') || '0') || 0;
          const claimValue = parseFloat(sumClaimInput?.value.replace(/[â‚ª,]/g, '') || '0') || 0;
          const depValue = parseFloat(depCompensationInput?.value.replace(/[â‚ª,]/g, '') || '0') || 0;
          const salvageValue = parseFloat(document.getElementById('salvageValue')?.value.replace(/[â‚ª,]/g, '') || '0') || 0;
          
          // Calculate subtotal: claim + compensation - salvage value = subtotal (market price is separate)
          const subtotal = claimValue + depValue - salvageValue;
          
          // Automatic calculation with math.js - Calculate VAT (18% on subtotal)
          const vatRate = 0.18;
          const vat = Math.round(subtotal * vatRate);
          
          // Calculate final total (subtotal + VAT) - automatic calculation with math.js
          const total = subtotal + vat;
          
          // Update readonly fields with formatted values - auto-filled from relevant fields
          if (sumVATInput) {
            sumVATInput.value = vat ? `â‚ª${vat.toLocaleString()}` : '';
            sumVATInput.readOnly = true;
            sumVATInput.style.background = '#f4f6fa';
          }
          
          if (sumTotalInput) {
            sumTotalInput.value = total ? `â‚ª${total.toLocaleString()}` : '';
            sumTotalInput.readOnly = true;
            sumTotalInput.style.background = '#e8f5e8';
          }
          
        } catch (error) {
          console.error('Error in summary calculations:', error);
        }
      }

      // Add listeners to trigger calculations for all relevant fields
      if (sumMarketValueInput) {
        sumMarketValueInput.addEventListener('input', calculateSummaryTotals);
      }
      if (sumClaimInput) {
        sumClaimInput.addEventListener('input', calculateSummaryTotals);
      }
      if (depCompensationInput) {
        depCompensationInput.addEventListener('input', calculateSummaryTotals);
      }
      
      // Auto-update when car market value changes
      const carMarketValueInput = document.getElementById('carMarketValue');
      if (carMarketValueInput) {
        carMarketValueInput.addEventListener('input', () => {
          calculateSummaryTotals();
          triggerGlobalDepreciationCalc(); // Recalculate global depreciation when market value changes
        });
      }
      
      // Auto-update when summary market value changes
      if (sumMarketValueInput) {
        sumMarketValueInput.addEventListener('input', () => {
          calculateSummaryTotals();
          triggerGlobalDepreciationCalc(); // Recalculate global depreciation when market value changes
        });
      }
      
      // ADD EVENT LISTENERS FOR SOURCE FIELDS TO AUTO-UPDATE SUMMARY
      const totalClaimInput = document.getElementById('totalClaim');
      if (totalClaimInput) {
        totalClaimInput.addEventListener('input', calculateSummaryTotals);
      }
      
      const globalDepValueInput = document.getElementById('globalDepValue');
      if (globalDepValueInput) {
        globalDepValueInput.addEventListener('input', calculateSummaryTotals);
      }
      
      // ADD EVENT LISTENER FOR SALVAGE VALUE TO TRIGGER RECALCULATION
      const salvageValueInput = document.getElementById('salvageValue');
      if (salvageValueInput) {
        salvageValueInput.addEventListener('input', calculateSummaryTotals);
      }
      
      // Add listeners for custom additions if they exist
      function addCustomFieldListeners() {
        const customFields = document.querySelectorAll('#sumAdditionsGridEstimate input');
        customFields.forEach(field => {
          field.addEventListener('input', calculateSummaryTotals);
        });
      }
      
      // Initial calculation and setup
      calculateSummaryTotals();
      addCustomFieldListeners();
      
      // Re-add listeners when custom fields are added
      const originalAddField = window.addCustomSummaryField;
      window.addCustomSummaryField = function(summaryType) {
        originalAddField(summaryType);
        setTimeout(addCustomFieldListeners, 100);
      };
    }

    // LOAD DEPRECIATION DATA
    function loadDepreciationData(helper) {
      try {
        // Load saved depreciation data if available
        if (helper.estimate_depreciation) {
          // Load global depreciation
          document.getElementById('globalDep1').value = helper.estimate_depreciation.global_percent || '';
          document.getElementById('globalDepValue').value = helper.estimate_depreciation.global_value || '';
          
          // Load bulk depreciation table
          if (helper.estimate_depreciation.bulk_items) {
            helper.estimate_depreciation.bulk_items.forEach(item => {
              addDepField(item);
            });
          }
        }
      } catch (error) {
        console.error('Error loading depreciation data:', error);
      }
    }

    // LOAD DAMAGE CENTERS SUMMARY - EDITABLE CARDS
    function loadDamageCentersSummary(helper) {
      try {
        const damageCentersContent = document.getElementById('damageCentersContent');
        
        if (helper.expertise?.damage_blocks && helper.expertise.damage_blocks.length > 0) {
          let summaryHTML = '<div style="display: grid; gap: 15px;" id="editableDamageCenters">';
          
          helper.expertise.damage_blocks.forEach((block, index) => {
            summaryHTML += createEditableDamageCenterCard(block, index);
          });
          
          summaryHTML += '</div>';
          damageCentersContent.innerHTML = summaryHTML;
          
          // Add event listeners after HTML is created
          setTimeout(addDamageCenterEventListeners, 100);
          
        } else {
          damageCentersContent.innerHTML = '<div style="color: #666; text-align: center;">×œ× × ××¦××• × ×ª×•× ×™ ××•×§×“×™ × ×–×§ - ×œ×—×¥ "×”×•×¡×£ ××•×§×“ × ×–×§ ×—×“×©" ×›×“×™ ×œ×”×ª×—×™×œ</div>';
        }
      } catch (error) {
        console.error('Error loading damage centers summary:', error);
        document.getElementById('damageCentersContent').innerHTML = '<div style="color: #dc3545; text-align: center;">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ××•×§×“×™ × ×–×§</div>';
      }
    }

    // CREATE EDITABLE DAMAGE CENTER CARD
    function createEditableDamageCenterCard(block, index) {
      const centerNum = index + 1;
      const centerName = block.damage_center_name || `××•×§×“ × ×–×§ ${centerNum}`;
      const workCosts = block.work_cost || 0;
      const partsCosts = block.parts_cost || 0;
      const repairsCosts = workCosts + partsCosts;
      const totalWithVAT = repairsCosts * 1.18;
      
      // Get existing parts, works, repairs from block
      const parts = block.parts || [];
      const works = block.works || [];
      const repairs = block.repairs || [];
      
      return `
        <div class="editable-damage-card" data-center-index="${index}" style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <!-- Card Header -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <input type="text" value="${centerName}" class="damage-center-name" style="font-weight: bold; color: #1e3a8a; font-size: 16px; border: 1px solid #ddd; padding: 8px; border-radius: 4px; width: 70%;" />
            <button onclick="removeDamageCenter(${index})" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">××—×§</button>
          </div>

          <!-- Parts Section (Full Width Row) -->
          <div style="border: 1px solid #e2e8f0; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
            <h4 style="margin: 0 0 10px 0; color: #1e3a8a;">×—×œ×§×™× × ×“×¨×©×™×:</h4>
            <div class="parts-list" data-center="${index}">
              ${parts.map((part, partIndex) => createEditablePartRow(part, index, partIndex)).join('')}
            </div>
            <button onclick="addPartRow(${index})" class="btn" style="background: #28a745; color: white; padding: 6px 12px; margin-top: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">×”×•×¡×£ ×—×œ×§</button>
          </div>

          <!-- Works Section (Full Width Row) -->
          <div style="border: 1px solid #e2e8f0; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
            <h4 style="margin: 0 0 10px 0; color: #1e3a8a;">×¢×‘×•×“×•×ª × ×“×¨×©×•×ª:</h4>
            <div class="works-list" data-center="${index}">
              ${works.map((work, workIndex) => createEditableWorkRow(work, index, workIndex)).join('')}
            </div>
            <button onclick="addWorkRow(${index})" class="btn" style="background: #17a2b8; color: white; padding: 6px 12px; margin-top: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">×”×•×¡×£ ×¢×‘×•×“×”</button>
          </div>

          <!-- Repairs Section (Full Width Row) -->
          <div style="border: 1px solid #e2e8f0; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
            <h4 style="margin: 0 0 10px 0; color: #1e3a8a;">×ª×™×§×•× ×™× × ×“×¨×©×™×:</h4>
            <div class="repairs-list" data-center="${index}">
              ${repairs.map((repair, repairIndex) => createEditableRepairRow(repair, index, repairIndex)).join('')}
            </div>
            <button onclick="addRepairRow(${index})" class="btn" style="background: #ffc107; color: #212529; padding: 6px 12px; margin-top: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">×”×•×¡×£ ×ª×™×§×•×Ÿ</button>
          </div>

          <!-- Cost Summary (Auto-calculated) -->
          <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 14px;">
              <div><strong>×¢×‘×•×“×•×ª:</strong> <span class="work-costs-display">â‚ª${workCosts.toLocaleString()}</span></div>
              <div><strong>×—×œ×¤×™×:</strong> <span class="parts-costs-display">â‚ª${partsCosts.toLocaleString()}</span></div>
              <div><strong>×ª×™×§×•× ×™×:</strong> <span class="repairs-costs-display">â‚ª${repairsCosts.toLocaleString()}</span></div>
              <div><strong>×›×•×œ×œ ××¢"×:</strong> <span class="total-with-vat-display">â‚ª${Math.round(totalWithVAT).toLocaleString()}</span></div>
            </div>
          </div>
        </div>
      `;
    }

    // CREATE EDITABLE PART ROW WITH SEARCH DROPDOWN
    function createEditablePartRow(part, centerIndex, partIndex) {
      const partName = part?.name || '';
      const partDesc = part?.desc || part?.description || '';
      const partPrice = part?.price || 0;
      const partSource = part?.source || '';
      
      return `
        <div class="part-row" data-center="${centerIndex}" data-part="${partIndex}" style="display: grid; grid-template-columns: 2fr 2fr 1fr auto; gap: 8px; margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
          <div style="position: relative;">
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×©× ×”×—×œ×§:</label>
            <input type="text" value="${partName}" placeholder="×©× ×”×—×œ×§" class="part-name" 
                   style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;"
                   onkeyup="showPartSuggestions(this, ${centerIndex}, ${partIndex})" />
            <div class="part-suggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; display: none; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×ª×™××•×¨:</label>
            <input type="text" value="${partDesc}" placeholder="×ª×™××•×¨ ×”×—×œ×§" class="part-desc" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×¢×œ×•×ª (â‚ª):</label>
            <input type="number" value="${partPrice}" placeholder="0" class="part-price" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" min="0" step="0.01" />
          </div>
          <button onclick="removePartRow(${centerIndex}, ${partIndex})" style="background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; align-self: end;">××—×§</button>
          <input type="hidden" value="${partSource}" class="part-source" />
        </div>
      `;
    }

    // CREATE EDITABLE WORK ROW WITH DROPDOWN
    function createEditableWorkRow(work, centerIndex, workIndex) {
      const workTypes = [
        '×¢×‘×•×“×•×ª ×¦×‘×¢', '×¢×‘×•×“×•×ª ×—×©××œ', '×¢×‘×•×“×•×ª ××›×•× ××•×ª', 
        '×¢×‘×•×“×•×ª ××–×’×Ÿ', '×¢×‘×•×“×•×ª ×¨×™×¤×•×“', '×¢×‘×•×“×•×ª ×–×’×’×•×ª',
        '××™×˜×•× ×•×–×™×¤×•×ª', '×‘×“×™×§×ª ××ª×œ×”', '×”× ×–×§ ××—×™×™×‘ ×ª×§× ×” 309',
        '×›×™×•×œ ×¨×“××¨', '×”×¢×‘×¨×ª ×—×™×™×©× ×™×', '××—×¨'
      ];
      
      const workType = typeof work === 'object' ? work.type : work;
      const workNote = typeof work === 'object' ? work.note : '';
      const workCost = typeof work === 'object' ? work.cost : 0;
      
      return `
        <div class="work-row" data-center="${centerIndex}" data-work="${workIndex}" style="display: grid; grid-template-columns: 2fr 2fr 1fr auto; gap: 8px; margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×¡×•×’ ×¢×‘×•×“×”:</label>
            <select class="work-type" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" onchange="updateWorkCostFromType(this, ${centerIndex}, ${workIndex})">
              ${workTypes.map(type => `<option value="${type}" ${type === workType ? 'selected' : ''}>${type}</option>`).join('')}
            </select>
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×”×¢×¨×•×ª:</label>
            <input type="text" value="${workNote}" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª" class="work-note" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×¢×œ×•×ª (â‚ª):</label>
            <input type="number" value="${workCost}" placeholder="0" class="work-cost" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" min="0" step="0.01" />
          </div>
          <button onclick="removeWorkRow(${centerIndex}, ${workIndex})" style="background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; align-self: end;">××—×§</button>
        </div>
      `;
    }

    // CREATE EDITABLE REPAIR ROW
    function createEditableRepairRow(repair, centerIndex, repairIndex) {
      const repairText = typeof repair === 'object' ? repair.description : repair;
      const repairCost = typeof repair === 'object' ? repair.cost : 0;
      
      return `
        <div class="repair-row" data-center="${centerIndex}" data-repair="${repairIndex}" style="display: grid; grid-template-columns: 3fr 1fr auto; gap: 8px; margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×ª×™××•×¨ ×”×ª×™×§×•×Ÿ:</label>
            <textarea placeholder="×ª×™××•×¨ ×”×ª×™×§×•×Ÿ" class="repair-text" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; min-height: 60px; resize: vertical;">${repairText}</textarea>
          </div>
          <div>
            <label style="font-size: 12px; color: #666; margin-bottom: 2px; display: block;">×¢×œ×•×ª (â‚ª):</label>
            <input type="number" value="${repairCost}" placeholder="0" class="repair-cost" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" min="0" step="0.01" />
          </div>
          <button onclick="removeRepairRow(${centerIndex}, ${repairIndex})" style="background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; height: 32px; margin-top: 14px;">××—×§</button>
        </div>
      `;
    }

    // LOAD LEVI ADJUSTMENTS
    // UNIFIED ADJUSTMENTS SYSTEM - Combines Levi adjustments and custom additions
    function loadAllAdjustments(helper) {
      try {
        const adjustmentsContainer = document.getElementById('allAdjustmentsRows-estimate');
        let adjustmentsHTML = '';
        
        // 1. Load Levi adjustments (read-only from Levi report)
        if (helper.levi_report?.adjustments && helper.levi_report.adjustments.length > 0) {
          console.log('ğŸ“„ Loading Levi adjustments:', helper.levi_report.adjustments);
          helper.levi_report.adjustments.forEach((adjustment, index) => {
            adjustmentsHTML += createAdjustmentRow({
              description: adjustment.description || '×”×ª×××” ××œ×•×™ ×™×¦×—×§',
              percentage: adjustment.percentage || 0,
              value: adjustment.value || 0,
              source: 'levi',
              index: index,
              readonly: true
            });
          });
        } else {
          console.log('ğŸ“„ No Levi adjustments found in helper.levi_report.adjustments');
        }
        
        // 2. Load custom adjustments (editable, stored in helper.levi.custom_adjustments)
        if (helper.levi?.custom_adjustments && helper.levi.custom_adjustments.length > 0) {
          console.log('ğŸ“„ Loading custom adjustments:', helper.levi.custom_adjustments);
          helper.levi.custom_adjustments.forEach((adjustment, index) => {
            adjustmentsHTML += createAdjustmentRow({
              description: adjustment.description || '×”×ª×××” ××•×ª×××ª ××™×©×™×ª',
              percentage: adjustment.percentage || 0,
              value: adjustment.value || 0,
              source: 'custom',
              index: index,
              readonly: false,
              adjustmentType: adjustment.adjustmentType || 'addition'
            });
          });
        } else {
          console.log('ğŸ“„ No custom adjustments found in helper.levi.custom_adjustments');
        }
        
        if (!adjustmentsHTML) {
          adjustmentsHTML = '<div style="color: #666; text-align: center; padding: 10px; font-size: 13px;">×œ× × ××¦××• ×”×ª×××•×ª - ×”×©×ª××© ×‘×›×¤×ª×•×¨ "×”×•×¡×£ ×”×ª×××” × ×•×¡×¤×ª"</div>';
        }
        
        adjustmentsContainer.innerHTML = adjustmentsHTML;
        
        // Add event listeners for all adjustments
        setTimeout(() => {
          addAdjustmentEventListeners();
          
          // Trigger initial auto-calculation for existing custom adjustments
          if (helper.levi?.custom_adjustments && helper.levi.custom_adjustments.length > 0) {
            console.log('ğŸ”„ Triggering initial calculation for existing adjustments');
            helper.levi.custom_adjustments.forEach((adjustment, index) => {
              if (adjustment.percentage && adjustment.percentage !== 0) {
                console.log(`ğŸš€ Initial calculation for adjustment ${index}: ${adjustment.percentage}%`);
                calculateAdjustmentValue('custom', index, adjustment.percentage);
              }
            });
          }
        }, 300);
        
      } catch (error) {
        console.error('Error loading all adjustments:', error);
        document.getElementById('allAdjustmentsRows-estimate').innerHTML = '<div style="color: #dc3545; text-align: center; padding: 10px; font-size: 13px;">×©×’×™××” ×‘×˜×¢×™× ×ª ×”×ª×××•×ª</div>';
      }
    }
    
    // Create unified adjustment row HTML
    function createAdjustmentRow(params) {
      const { description, percentage, value, source, index, readonly, adjustmentType } = params;
      const rowId = `adjustment-${source}-${index}`;
      
      // Determine type and colors
      let typeLabel, typeColor;
      if (source === 'levi') {
        typeLabel = '×œ×•×™ ×™×¦×—×§';
        typeColor = '#007bff';
      } else {
        // For custom adjustments, use the explicit type or infer from values
        const currentType = adjustmentType || (percentage < 0 || value < 0 ? 'subtraction' : 'addition');
        typeLabel = currentType === 'addition' ? '×ª×•×¡×¤×ª' : '×”×¤×—×ª×”';
        typeColor = currentType === 'addition' ? '#28a745' : '#dc3545';
      }
      
      if (readonly) {
        // Read-only Levi adjustments (5-column layout)
        return `
          <div class="adjustment-row" id="${rowId}" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 8px; padding: 8px; border-bottom: 1px solid #e9ecef; background: #f8f9fa;">
            <div style="font-size: 13px;">
              <span style="background: ${typeColor}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 8px;">${typeLabel}</span>
              ${description}
            </div>
            <div style="font-size: 13px; text-align: center; color: ${typeColor}; font-weight: bold;">${typeLabel}</div>
            <div style="font-size: 13px; text-align: center;">${percentage}%</div>
            <div style="font-size: 13px; text-align: center;">â‚ª${value.toLocaleString()}</div>
            <div style="font-size: 11px; color: #666;">×§×¨×™××” ×‘×œ×‘×“</div>
          </div>
        `;
      } else {
        // Editable custom adjustments with type dropdown (5-column layout)
        const currentAdjustmentType = adjustmentType || 'addition';
        return `
          <div class="adjustment-row" id="${rowId}" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 8px; padding: 8px; border-bottom: 1px solid #e9ecef;">
            <input type="text" value="${description}" data-field="description" data-source="${source}" data-index="${index}" 
                   style="font-size: 13px; border: 1px solid #ddd; padding: 4px; border-radius: 3px;" 
                   placeholder="×ª×™××•×¨ ×”×”×ª×××”" />
            <select data-field="adjustmentType" data-source="${source}" data-index="${index}"
                    style="font-size: 13px; border: 1px solid #ddd; padding: 4px; border-radius: 3px; background: white;">
              <option value="addition" ${currentAdjustmentType === 'addition' ? 'selected' : ''} style="color: #28a745;">×ª×•×¡×¤×ª</option>
              <option value="subtraction" ${currentAdjustmentType === 'subtraction' ? 'selected' : ''} style="color: #dc3545;">×”×¤×—×ª×”</option>
            </select>
            <input type="number" value="${Math.abs(percentage)}" data-field="percentage" data-source="${source}" data-index="${index}"
                   style="font-size: 13px; border: 1px solid #ddd; padding: 4px; border-radius: 3px; text-align: center;" 
                   placeholder="0" step="0.1" min="0" />
            <input type="number" value="${Math.abs(value)}" data-field="value" data-source="${source}" data-index="${index}"
                   style="font-size: 13px; border: 1px solid #ddd; padding: 4px; border-radius: 3px; text-align: center; background: #f8f9fa;" 
                   placeholder="××•×˜×•××˜×™" step="100" min="0" readonly title="××—×•×©×‘ ××•×˜×•××˜×™×ª: ××—×•×– Ã— ××—×™×¨ ×‘×¡×™×¡" />
            <button type="button" onclick="removeCustomAdjustment('${source}', ${index})" 
                    style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">××—×§</button>
          </div>
        `;
      }
    }

    // ADD CUSTOM ADJUSTMENT FIELD - Unified system
    function addCustomAdjustmentField() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Initialize custom adjustments array if it doesn't exist
      if (!helper.levi) helper.levi = {};
      if (!helper.levi.custom_adjustments) helper.levi.custom_adjustments = [];
      
      // Add new empty adjustment with default type
      const newAdjustment = {
        description: '',
        percentage: 0,
        value: 0,
        adjustmentType: 'addition'
      };
      
      helper.levi.custom_adjustments.push(newAdjustment);
      
      // Save to sessionStorage
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      // Reload all adjustments to show the new one
      loadAllAdjustments(helper);
      
      console.log('Added new custom adjustment, total custom adjustments:', helper.levi.custom_adjustments.length);
      
      // Ensure event listeners are attached to the new row
      const newIndex = helper.levi.custom_adjustments.length - 1;
      setTimeout(() => {
        console.log('ğŸ†• Setting up new adjustment row with event listeners');
        addAdjustmentEventListeners();
        
        // Focus on the new row's description field
        const newDescriptionInput = document.querySelector(`input[data-field="description"][data-source="custom"][data-index="${newIndex}"]`);
        if (newDescriptionInput) {
          newDescriptionInput.focus();
        }
        
        // Trigger initial calculation if it has a percentage
        const newAdjustment = helper.levi.custom_adjustments[newIndex];
        if (newAdjustment && newAdjustment.percentage !== 0) {
          calculateAdjustmentValue('custom', newIndex, newAdjustment.percentage);
        }
      }, 150);
    }
    
    // REMOVE CUSTOM ADJUSTMENT
    function removeCustomAdjustment(source, index) {
      if (source !== 'custom') return; // Only allow removing custom adjustments
      
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      if (helper.levi?.custom_adjustments && helper.levi.custom_adjustments[index]) {
        helper.levi.custom_adjustments.splice(index, 1);
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        // Reload all adjustments
        loadAllAdjustments(helper);
        
        // Re-attach event listeners after removal
        setTimeout(() => {
          addAdjustmentEventListeners();
        }, 100);
        
        console.log('Removed custom adjustment at index:', index);
      }
    }
    
    // ADD EVENT LISTENERS FOR ADJUSTMENT FIELDS
    function addAdjustmentEventListeners() {
      // Remove existing event listeners to prevent duplicates
      const existingInputs = document.querySelectorAll('#allAdjustmentsRows-estimate input[data-source="custom"], #allAdjustmentsRows-estimate select[data-source="custom"]');
      existingInputs.forEach(element => {
        // Clone element to remove all event listeners
        const newElement = element.cloneNode(true);
        element.parentNode.replaceChild(newElement, element);
      });
      
      // Add fresh event listeners to all adjustment inputs
      const adjustmentInputs = document.querySelectorAll('#allAdjustmentsRows-estimate input[data-source="custom"], #allAdjustmentsRows-estimate select[data-source="custom"]');
      
      console.log(`ğŸ”— Adding event listeners to ${adjustmentInputs.length} adjustment inputs`);
      
      adjustmentInputs.forEach(element => {
        // Input event for real-time updates
        element.addEventListener('input', function() {
          const source = this.dataset.source;
          const index = parseInt(this.dataset.index);
          const field = this.dataset.field;
          
          console.log(`ğŸ“ Input changed: ${field} for ${source}[${index}] = ${this.value}`);
          
          let value;
          if (field === 'description') {
            value = this.value;
          } else if (field === 'adjustmentType') {
            value = this.value;
          } else {
            value = parseFloat(this.value) || 0;
          }
          
          updateCustomAdjustmentInHelper(source, index, field, value);
          
          // Auto-calculate value when percentage changes
          if (field === 'percentage') {
            console.log(`ğŸ”¢ Triggering auto-calculation for percentage: ${value}%`);
            calculateAdjustmentValue(source, index, value);
          }
          
          // Debug: Check if helper is updated
          const currentHelper = JSON.parse(sessionStorage.getItem('helper') || '{}');
          console.log(`ğŸ” DEBUG: Helper after adjustment update:`, currentHelper.levi?.custom_adjustments);
          console.log(`ğŸ” DEBUG: Helper expertise.levi_report:`, currentHelper.expertise?.levi_report);
          
          // Trigger floating screen refresh when adjustments change
          triggerFloatingScreenRefresh();
        });
        
        // Change event for final updates
        element.addEventListener('change', function() {
          // Trigger calculation update on change
          calculateSummaryTotals();
          
          // Trigger floating screen refresh when adjustments change
          triggerFloatingScreenRefresh();
          
          // If adjustment type changed, reload to update display
          if (this.dataset.field === 'adjustmentType') {
            const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
            setTimeout(() => loadAllAdjustments(helper), 50);
          }
        });
        
        // For percentage fields, trigger auto-calculation on focus out
        if (element.dataset.field === 'percentage') {
          element.addEventListener('blur', function() {
            const value = parseFloat(this.value) || 0;
            if (value !== 0) {
              console.log(`ğŸ¯ Blur event: Recalculating for percentage ${value}%`);
              calculateAdjustmentValue(this.dataset.source, parseInt(this.dataset.index), value);
            }
          });
        }
      });
    }
    
    // AUTO-CALCULATE ADJUSTMENT VALUE FROM PERCENTAGE
    function calculateAdjustmentValue(source, index, percentage) {
      if (source !== 'custom') return;
      
      // Get base price from car details
      const basePrice = getBasePriceForCalculation();
      
      if (basePrice > 0 && percentage !== 0) {
        const calculatedValue = Math.round((basePrice * Math.abs(percentage)) / 100);
        
        console.log(`Auto-calculating adjustment value: ${percentage}% Ã— â‚ª${basePrice.toLocaleString()} = â‚ª${calculatedValue.toLocaleString()}`);
        
        // Update the value field in DOM
        const valueInput = document.querySelector(`input[data-field="value"][data-source="${source}"][data-index="${index}"]`);
        if (valueInput) {
          valueInput.value = calculatedValue;
        }
        
        // Update helper with calculated value
        updateCustomAdjustmentInHelper(source, index, 'value', calculatedValue);
      }
    }
    
    // GET BASE PRICE FOR CALCULATION
    function getBasePriceForCalculation() {
      // Try multiple sources for base price
      let basePrice = 0;
      
      // Priority 1: Car base price field
      const carBasePriceField = document.getElementById('carBasePrice');
      if (carBasePriceField && carBasePriceField.value) {
        const carBasePriceStr = carBasePriceField.value.replace(/[â‚ª,]/g, '') || '0';
        basePrice = parseFloat(carBasePriceStr) || 0;
      }
      
      // Priority 2: Helper data
      if (basePrice === 0) {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        basePrice = helper?.vehicle_value_base || 
                   helper?.car_details?.base_price || 
                   helper?.levi?.base_price || 
                   helper?.levi_report?.base_price || 0;
      }
      
      console.log('Base price for calculation:', basePrice);
      return basePrice;
    }
    
    // RECALCULATE ALL ADJUSTMENT VALUES (when base price changes)
    function recalculateAllAdjustmentValues() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      if (helper.levi?.custom_adjustments && helper.levi.custom_adjustments.length > 0) {
        console.log('ğŸ”„ Recalculating all adjustment values due to base price change');
        
        helper.levi.custom_adjustments.forEach((adjustment, index) => {
          if (adjustment.percentage && adjustment.percentage !== 0) {
            calculateAdjustmentValue('custom', index, adjustment.percentage);
          }
        });
      }
    }
    
    // UPDATE CUSTOM ADJUSTMENT IN HELPER
    function updateCustomAdjustmentInHelper(source, index, field, value) {
      if (source !== 'custom') return;
      
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      if (helper.levi?.custom_adjustments && helper.levi.custom_adjustments[index]) {
        const adjustment = helper.levi.custom_adjustments[index];
        
        // Update the field
        adjustment[field] = value;
        
        // Apply proper signs based on adjustment type when updating numeric fields
        if (field === 'percentage' || field === 'value') {
          const adjustmentType = adjustment.adjustmentType || 'addition';
          const absoluteValue = Math.abs(value);
          
          if (adjustmentType === 'subtraction') {
            adjustment[field] = -absoluteValue;
          } else {
            adjustment[field] = absoluteValue;
          }
        }
        
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        console.log(`Updated custom adjustment ${index}.${field} to:`, adjustment[field]);
        console.log('Full adjustment object:', adjustment);
        
        // Update the structured Levi data for floating screen compatibility
        updateLeviDataStructure(helper);
        
        // Helper is already updated above with sessionStorage.setItem
        console.log('âœ… Helper updated with adjustment data');
      }
    }
    
    // UPDATE LEVI DATA STRUCTURE FOR FLOATING SCREEN COMPATIBILITY
    function updateLeviDataStructure(helper) {
      try {
        // Ensure expertise.levi_report exists
        if (!helper.expertise) helper.expertise = {};
        if (!helper.expertise.levi_report) helper.expertise.levi_report = {};
        
        // Map basic vehicle info from other helper sections
        if (helper.car_details) {
          helper.expertise.levi_report.manufacturer = helper.car_details.manufacturer || helper.vehicle?.manufacturer;
          helper.expertise.levi_report.year = helper.car_details.year || helper.vehicle?.year;
          helper.expertise.levi_report.base_price = helper.car_details.base_price;
          helper.expertise.levi_report.final_price = helper.car_details.market_value;
          helper.expertise.levi_report.vehicle_type = helper.vehicle?.vehicle_type || '';
          helper.expertise.levi_report.model_code = helper.vehicle?.model_code || '';
          helper.expertise.levi_report.category = helper.vehicle?.category || '';
          helper.expertise.levi_report.full_model = helper.vehicle?.model || helper.car_details.model;
        }
        
        // Process custom adjustments into the structure expected by Levi floating screen
        if (helper.levi?.custom_adjustments) {
          // Initialize all adjustment fields to ensure they exist
          helper.expertise.levi_report.registration = '';
          helper.expertise.levi_report.registration_percent = '';
          helper.expertise.levi_report.registration_value = '';
          helper.expertise.levi_report.registration_total = '';
          helper.expertise.levi_report.ownership = '';
          helper.expertise.levi_report.ownership_percent = '';
          helper.expertise.levi_report.ownership_value = '';
          helper.expertise.levi_report.ownership_total = '';
          helper.expertise.levi_report.km = '';
          helper.expertise.levi_report.km_percent = '';
          helper.expertise.levi_report.km_value = '';
          helper.expertise.levi_report.km_total = '';
          helper.expertise.levi_report.owners = '';
          helper.expertise.levi_report.owners_percent = '';
          helper.expertise.levi_report.owners_value = '';
          helper.expertise.levi_report.owners_total = '';
          helper.expertise.levi_report.features = '';
          helper.expertise.levi_report.features_percent = '';
          helper.expertise.levi_report.features_value = '';
          helper.expertise.levi_report.features_total = '';
          
          helper.levi.custom_adjustments.forEach((adjustment, index) => {
            const desc = adjustment.description ? adjustment.description.toLowerCase() : '';
            
            console.log(`ğŸ” Mapping adjustment ${index}: "${adjustment.description}" (${adjustment.percentage}%, â‚ª${adjustment.value})`);
            
            // Map based on description keywords ONLY (check specific terms first to avoid conflicts)
            if (desc.includes('×¢×œ×™×” ×œ×›×‘×™×©') || desc.includes('registration') || desc.includes('×¨×™×©×•×™')) {
              helper.expertise.levi_report.registration = adjustment.description || '×¢×œ×™×” ×œ×›×‘×™×©';
              helper.expertise.levi_report.registration_percent = Math.abs(adjustment.percentage || 0);
              helper.expertise.levi_report.registration_value = Math.abs(adjustment.value || 0);
              helper.expertise.levi_report.registration_total = Math.abs(adjustment.value || 0);
              console.log(`âœ… Mapped to registration: ${adjustment.description}`);
            } else if (desc.includes('××¡×¤×¨ ×‘×¢×œ×™×') || desc.includes('owners')) {
              helper.expertise.levi_report.owners = adjustment.description || '××¡×¤×¨ ×‘×¢×œ×™×';
              helper.expertise.levi_report.owners_percent = Math.abs(adjustment.percentage || 0);
              helper.expertise.levi_report.owners_value = Math.abs(adjustment.value || 0);
              helper.expertise.levi_report.owners_total = Math.abs(adjustment.value || 0);
              console.log(`âœ… Mapped to owners: ${adjustment.description}`);
            } else if (desc.includes('×‘×¢×œ×•×ª') || desc.includes('ownership')) {
              helper.expertise.levi_report.ownership = adjustment.description || '×‘×¢×œ×•×ª';
              helper.expertise.levi_report.ownership_percent = Math.abs(adjustment.percentage || 0);
              helper.expertise.levi_report.ownership_value = Math.abs(adjustment.value || 0);
              helper.expertise.levi_report.ownership_total = Math.abs(adjustment.value || 0);
              console.log(`âœ… Mapped to ownership: ${adjustment.description}`);
            } else if (desc.includes('×§×´×') || desc.includes('km') || desc.includes('×§×™×œ×•××˜×¨×™×')) {
              helper.expertise.levi_report.km = adjustment.description || '××¡ ×§×´×';
              helper.expertise.levi_report.km_percent = Math.abs(adjustment.percentage || 0);
              helper.expertise.levi_report.km_value = Math.abs(adjustment.value || 0);
              helper.expertise.levi_report.km_total = Math.abs(adjustment.value || 0);
              console.log(`âœ… Mapped to km: ${adjustment.description}`);
            } else if (desc.includes('×××¤×™×™× ×™×') || desc.includes('features')) {
              helper.expertise.levi_report.features = adjustment.description || '×××¤×™×™× ×™×';
              helper.expertise.levi_report.features_percent = Math.abs(adjustment.percentage || 0);
              helper.expertise.levi_report.features_value = Math.abs(adjustment.value || 0);
              helper.expertise.levi_report.features_total = Math.abs(adjustment.value || 0);
              console.log(`âœ… Mapped to features: ${adjustment.description}`);
            } else {
              console.log(`âš ï¸ No mapping found for: "${adjustment.description}" - will be stored in helper for validation/report`);
            }
          });
        }
        
        // Update helper in sessionStorage
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        console.log('ğŸ“Š Updated Levi data structure for floating screen compatibility');
        
      } catch (error) {
        console.error('Error updating Levi data structure:', error);
      }
    }
    
    // CALCULATE SUMMARY TOTALS - Updates helper with calculated totals
    function calculateSummaryTotals() {
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        // Calculate Levi adjustment totals
        let leviTotal = 0;
        if (helper.levi?.adjustments) {
          leviTotal = helper.levi.adjustments.reduce((sum, adj) => sum + (parseFloat(adj.value) || 0), 0);
        }
        if (helper.levi?.custom_adjustments) {
          leviTotal += helper.levi.custom_adjustments.reduce((sum, adj) => sum + (parseFloat(adj.value) || 0), 0);
        }
        
        // Calculate damage center totals
        let damageTotal = 0;
        if (helper.expertise?.damage_blocks) {
          helper.expertise.damage_blocks.forEach(block => {
            damageTotal += (parseFloat(block.parts_cost) || 0) + (parseFloat(block.work_cost) || 0) + (parseFloat(block.repairs_cost) || 0);
          });
        }
        
        // Update helper with calculated totals
        helper.summary_totals = {
          levi_total: leviTotal,
          damage_total: damageTotal,
          total_before_vat: leviTotal + damageTotal,
          total_with_vat: Math.round((leviTotal + damageTotal) * 1.18),
          calculated_at: new Date().toISOString()
        };
        
        sessionStorage.setItem('helper', JSON.stringify(helper));
        console.log('âœ… Summary totals calculated and updated in helper:', helper.summary_totals);
        
        // Trigger floating screen updates when helper changes
        triggerFloatingScreenRefresh();
        
      } catch (error) {
        console.error('Error calculating summary totals:', error);
      }
    }

    // TRIGGER FLOATING SCREEN REFRESH - Updates all helper-dependent floating screens
    function triggerFloatingScreenRefresh() {
      try {
        console.log('ğŸ”„ Triggering floating screen refresh after helper update');
        
        // Debug: Check which refresh functions are available
        console.log('Debug: Available refresh functions:', {
          refreshLeviData: typeof window.refreshLeviData,
          refreshCarData: typeof window.refreshCarData, 
          refreshInvoiceData: typeof window.refreshInvoiceData,
          refreshPartsResults: typeof window.refreshPartsResults
        });
        
        // Refresh Levi floating screen if open
        if (window.refreshLeviData && typeof window.refreshLeviData === 'function') {
          console.log('ğŸ”„ Refreshing Levi floating screen');
          window.refreshLeviData();
        } else {
          console.log('âš ï¸ refreshLeviData not available or not a function');
        }
        
        // Refresh Car Details floating screen if open
        if (window.refreshCarData && typeof window.refreshCarData === 'function') {
          console.log('ğŸ”„ Refreshing Car Details floating screen');
          window.refreshCarData();
        } else {
          console.log('âš ï¸ refreshCarData not available or not a function');
        }
        
        // Refresh Invoice floating screen if open
        if (window.refreshInvoiceData && typeof window.refreshInvoiceData === 'function') {
          console.log('ğŸ”„ Refreshing Invoice floating screen');
          window.refreshInvoiceData();
        } else {
          console.log('âš ï¸ refreshInvoiceData not available or not a function');
        }
        
        // Refresh Parts Search floating screen (corrected function name)
        if (window.refreshPartsResults && typeof window.refreshPartsResults === 'function') {
          console.log('ğŸ”„ Refreshing Parts Search floating screen');
          window.refreshPartsResults();
        } else {
          console.log('âš ï¸ refreshPartsResults not available or not a function');
        }
        
        // Alternative: Try to reload data directly from iframe/floating screens
        setTimeout(() => {
          // Try to refresh via postMessage to floating screens
          const floatingScreens = document.querySelectorAll('.floating-screen[style*="block"]');
          floatingScreens.forEach(screen => {
            console.log('ğŸ”„ Found open floating screen:', screen.id);
            const iframe = screen.querySelector('iframe');
            if (iframe && iframe.contentWindow) {
              try {
                iframe.contentWindow.postMessage({
                  type: 'refreshData',
                  source: 'estimate-builder',
                  timestamp: new Date().toISOString()
                }, '*');
              } catch (e) {
                console.log('Could not post message to iframe:', e);
              }
            }
          });
        }, 100);
        
        // Dispatch custom event for any other modules listening
        window.dispatchEvent(new CustomEvent('helperDataUpdated', {
          detail: { 
            timestamp: new Date().toISOString(),
            source: 'estimate-builder'
          }
        }));
        
      } catch (error) {
        console.error('Error triggering floating screen refresh:', error);
      }
    }

    // LEGACY FUNCTION - Keep for compatibility but redirect to unified system
    function addCustomSummaryField(summaryType) {
      // Redirect to new unified system
      addCustomAdjustmentField();
    }
    
    // DEBUG FUNCTION - Test the complete data flow chain
    window.testDataFlow = function() {
      console.log('ğŸ§ª TESTING DATA FLOW CHAIN');
      
      // 1. Check if helper exists
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      console.log('1ï¸âƒ£ Helper exists:', !!helper);
      console.log('   Helper keys:', Object.keys(helper));
      
      // 2. Test manual helper update
      console.log('2ï¸âƒ£ Testing manual helper update...');
      helper.test_field = 'test_value_' + Date.now();
      helper.car_details = helper.car_details || {};
      helper.car_details.manufacturer = 'TEST_MANUFACTURER';
      sessionStorage.setItem('helper', JSON.stringify(helper));
      console.log('   Helper updated with test data');
      
      // 3. Test floating screen refresh
      console.log('3ï¸âƒ£ Testing floating screen refresh...');
      triggerFloatingScreenRefresh();
      
      // 4. Check if refresh functions are available
      console.log('4ï¸âƒ£ Checking refresh function availability:');
      console.log('   refreshLeviData:', typeof window.refreshLeviData);
      console.log('   refreshCarData:', typeof window.refreshCarData);
      console.log('   refreshInvoiceData:', typeof window.refreshInvoiceData);
      console.log('   refreshPartsResults:', typeof window.refreshPartsResults);
      
      // 5. Test manual adjustment input
      console.log('5ï¸âƒ£ Testing manual adjustment input...');
      const adjustmentInputs = document.querySelectorAll('#allAdjustmentsRows-estimate input[data-source="custom"]');
      console.log('   Found adjustment inputs:', adjustmentInputs.length);
      
      if (adjustmentInputs.length > 0) {
        const firstInput = adjustmentInputs[0];
        console.log('   First input element:', firstInput);
        console.log('   First input data attributes:', {
          source: firstInput.dataset.source,
          index: firstInput.dataset.index,
          field: firstInput.dataset.field
        });
        
        // Simulate input change
        firstInput.value = 'TEST_ADJUSTMENT_' + Date.now();
        firstInput.dispatchEvent(new Event('input', { bubbles: true }));
        console.log('   Simulated input change');
      }
      
      console.log('ğŸ§ª DATA FLOW TEST COMPLETE');
    };

    // ADD FIELD CHANGE LISTENERS
    function addFieldChangeListeners() {
      // Car details listeners
      ['carPlate', 'carManufacturer', 'carModel', 'carYear', 'carModelCode', 'carBasePrice', 'carMarketValue', 'carReportDate'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('change', function(event) {
            updateHelperFromField(event);
            
            // Recalculate adjustment values when base price changes
            if (id === 'carBasePrice') {
              console.log('ğŸ“Š Base price changed, recalculating all adjustment values');
              setTimeout(() => {
                recalculateAllAdjustmentValues();
              }, 100);
            }
          });
        }
      });
      
      // Claims data listeners (leviPriceList and grossPercent are now auto-calculated and readonly)
      ['totalClaim', 'authorizedClaim'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('change', function(event) {
            updateHelperFromField(event);
            
            // Trigger gross percentage recalculation when total claim changes
            if (id === 'totalClaim') {
              setTimeout(updateGrossPercentageField, 100);
            }
          });
        }
      });
      
      // Contact data listeners
      ['ownerName', 'ownerAddress', 'ownerPhone', 'insuranceCompany', 'insuranceEmail', 'insuranceAgent', 'agentPhone', 'agentEmail'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('change', updateHelperFromField);
        }
      });
      
      // Summary data listeners
      ['sumMarketValue', 'sumClaim', 'sumVAT', 'sumTotalClaim', 'depCompensation', 'salvageValue'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('change', updateHelperFromField);
        }
      });
      
      // Estimate type change listener
      document.querySelectorAll('input[name="estimate-type"]').forEach(radio => {
        radio.addEventListener('change', function() {
          updateReportType();
          loadLegalText();
        });
      });
    }

    // UPDATE HELPER FROM FIELD
    function updateHelperFromField(event) {
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        const fieldId = event.target.id;
        const value = event.target.value;
        
        console.log(`ğŸ“ Field change detected: ${fieldId} = "${value}"`);
        
        // Update the appropriate helper section based on field
        if (['carPlate', 'carManufacturer', 'carModel', 'carYear', 'carModelCode', 'carBasePrice', 'carMarketValue', 'carReportDate'].includes(fieldId)) {
          helper.car_details = helper.car_details || {};
          helper.vehicle = helper.vehicle || {};
          
          const mapping = {
            'carPlate': 'plate',
            'carManufacturer': 'manufacturer',
            'carModel': 'model',
            'carYear': 'year',
            'carModelCode': 'model_code',
            'carBasePrice': 'base_price',
            'carMarketValue': 'market_value',
            'carReportDate': 'report_date'
          };
          
          // Update car_details (builder format)
          helper.car_details[mapping[fieldId]] = value;
          
          // Also update vehicle structure (floating screen format)
          if (fieldId === 'carManufacturer') {
            helper.vehicle.manufacturer = value;
            console.log('ğŸš— Updated vehicle manufacturer:', value);
          } else if (fieldId === 'carModel') {
            helper.vehicle.model = value;
            console.log('ğŸš— Updated vehicle model:', value);
          } else if (fieldId === 'carYear') {
            helper.vehicle.year = value;
            console.log('ğŸš— Updated vehicle year:', value);
          } else if (fieldId === 'carModelCode') {
            helper.vehicle.model_code = value;
            console.log('ğŸš— Updated vehicle model code:', value);
          } else if (fieldId === 'carPlate') {
            helper.vehicle.plate_number = value;
            helper.meta = helper.meta || {};
            helper.meta.plate = value;
            console.log('ğŸš— Updated vehicle plate:', value);
          }
          
          // Also update meta for plate
          if (fieldId === 'carPlate') {
            helper.meta = helper.meta || {};
            helper.meta.plate = value;
          }
        } else if (['ownerName', 'ownerAddress', 'ownerPhone', 'insuranceCompany', 'insuranceEmail', 'insuranceAgent', 'agentPhone', 'agentEmail'].includes(fieldId)) {
          helper.client = helper.client || {};
          helper.car_details = helper.car_details || {};
          
          const mapping = {
            'ownerName': 'name',
            'ownerAddress': 'address',
            'ownerPhone': 'phone',
            'insuranceCompany': 'insurance_company',
            'insuranceEmail': 'insurance_email',
            'insuranceAgent': 'insurance_agent',
            'agentPhone': 'agent_phone',
            'agentEmail': 'agent_email'
          };
          
          // Update client structure (main format)
          helper.client[mapping[fieldId]] = value;
          
          // Also update car_details structure (floating screen format)
          if (fieldId === 'ownerName') {
            helper.car_details.owner = value;
          } else if (fieldId === 'ownerAddress') {
            helper.car_details.ownerAddress = value;
          } else if (fieldId === 'ownerPhone') {
            helper.car_details.ownerPhone = value;
          } else if (fieldId === 'insuranceCompany') {
            helper.car_details.insuranceCompany = value;
          } else if (fieldId === 'insuranceAgent') {
            helper.car_details.agentName = value;
          } else if (fieldId === 'agentPhone') {
            helper.car_details.agentPhone = value;
          }
        } else if (['totalClaim', 'authorizedClaim'].includes(fieldId)) {
          // Claims data mapping
          helper.claims_data = helper.claims_data || {};
          const mapping = {
            'totalClaim': 'total_claim',
            'authorizedClaim': 'authorized_claim'
          };
          helper.claims_data[mapping[fieldId]] = value;
          
          // Also update expertise.calculations for compatibility
          helper.expertise = helper.expertise || {};
          helper.expertise.calculations = helper.expertise.calculations || {};
          if (fieldId === 'totalClaim' || fieldId === 'authorizedClaim') {
            // Remove currency formatting and parse number
            const numericValue = parseFloat(value.replace(/[â‚ª,]/g, '')) || 0;
            helper.expertise.calculations.total_damage = numericValue;
          }
          
          console.log(`ğŸ’° Updated claims data: ${fieldId} = "${value}"`);
        } else if (['sumMarketValue', 'sumClaim', 'sumVAT', 'sumTotalClaim', 'depCompensation', 'salvageValue'].includes(fieldId)) {
          helper.estimate_summary = helper.estimate_summary || {};
          const mapping = {
            'sumMarketValue': 'market_value',
            'sumClaim': 'total_claim',
            'sumVAT': 'vat',
            'sumTotalClaim': 'total_with_vat',
            'depCompensation': 'dep_compensation',
            'salvageValue': 'salvage_value'
          };
          helper.estimate_summary[mapping[fieldId]] = value;
        }
        
        // Save updated helper
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        // Trigger floating screen updates when helper changes
        triggerFloatingScreenRefresh();
        
        // Update page title if plate changed
        if (fieldId === 'carPlate') {
          document.getElementById('pageTitle').textContent = `×¨×›×‘ ××¡. ${value || '...'}`;
        }
        
        // Update legal text with new data
        loadLegalText();
        
        // Special handling for salvage value changes
        if (fieldId === 'salvageValue') {
          console.log('Salvage value updated:', value);
        }
        
      } catch (error) {
        console.error('Error updating helper from field:', error);
      }
    }

    // UPDATE REPORT TYPE
    function updateReportType() {
      const selectedType = document.querySelector('input[name="estimate-type"]:checked')?.value || '××•×‘×“×Ÿ_×œ×”×œ×›×”';
      const reportTypeText = selectedType === '××•×‘×“×Ÿ_×œ×”×œ×›×”' ? '××•××“×Ÿ ×¨××©×•× ×™ - ××•×‘×“×Ÿ ×œ×”×œ×›×”' : '××•××“×Ÿ ×¨××©×•× ×™ - ×˜×•×˜×œ×•×¡';
      document.getElementById('reportType').value = reportTypeText;
    }

    // ADD DEPRECIATION FIELD
    function addDepField(data = null) {
      const container = document.getElementById('depreciationBulkTable');
      const index = container.children.length;
      
      const row = document.createElement('div');
      row.className = 'dep-row';
      row.style.cssText = 'display:grid; grid-template-columns:1fr 1fr 120px 120px 80px; gap:14px; margin-bottom:10px;';
      
      row.innerHTML = `
        <div><input type="text" placeholder="×”×—×œ×§ ×”× ×™×–×•×§" value="${data?.damaged_part || ''}" /></div>
        <div><input type="text" placeholder="××”×•×ª ×”×ª×™×§×•×Ÿ" value="${data?.repair_type || ''}" /></div>
        <div><input type="text" placeholder="% ×™×¨×™×“×ª ×¢×¨×š" value="${data?.percent || ''}" /></div>
        <div><input type="text" placeholder="×¢×¨×š ×‘-â‚ª" value="${data?.value || ''}" readonly style="background:#f4f6fa;" /></div>
        <div><button type="button" onclick="this.parentElement.parentElement.remove()" style="background:#dc3545; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">××—×§</button></div>
      `;
      
      container.appendChild(row);
      
      // Add listeners for calculation
      const percentInput = row.querySelector('input[placeholder="% ×™×¨×™×“×ª ×¢×¨×š"]');
      const valueInput = row.querySelector('input[placeholder="×¢×¨×š ×‘-â‚ª"]');
      
      percentInput.addEventListener('input', function() {
        let percent = parseFloat(this.value) || 0;
        
        // Auto-add % symbol if not present and user enters a number
        if (this.value && !this.value.includes('%') && !isNaN(percent)) {
          this.value = percent + '%';
        }
        
        // Calculate value from market price automatically
        const marketValueField = document.getElementById('carMarketValue') || document.getElementById('sumMarketValue');
        const marketValueStr = marketValueField?.value.replace(/[â‚ª,]/g, '') || '0';
        const marketValue = parseFloat(marketValueStr) || 0;
        
        const calculatedValue = (marketValue * percent) / 100;
        valueInput.value = calculatedValue ? `â‚ª${Math.round(calculatedValue).toLocaleString()}` : '';
      });
    }

    // LOAD LEGAL TEXT FROM VAULT SYSTEM
    function loadLegalText() {
      const selectedType = document.querySelector('input[name="estimate-type"]:checked')?.value || '××•×‘×“×Ÿ_×œ×”×œ×›×”';
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Legal text vault from final report legal texts vault.md - EXACT COPY
      const legalTextsVault = {
        '××•×‘×“×Ÿ_×œ×”×œ×›×”': `×¢×¨×š ×”×¨×›×‘ ×”××¦×•×™×™×Ÿ ×œ×¢×™×œ ×‘×”×ª×× ×œ××—×™×¨×•×Ÿ ×•××™× ×• ××ª×™×™×—×¡ ×œ××§×•×¨×™×•×ª ×”×¨×›×‘ ×‘×¢×‘×¨ ×•××¨×•×¢ ×ª××•× ×ª×™.

×”×¦×¢×” ×–×• ××™× ×” ×¡×•×¤×™×ª ×•×™×ª×›×Ÿ ×©×™× ×•×™×™× ×‘××”×œ×š ×ª×™×§×•×Ÿ ×”×¨×›×‘.

×”×¢×¨×›×ª× ×• ××ª×™×™×—×¡×ª ×œ× ×–×§×™× ×›×¤×™ ×©×”×•×¦×’×• ×‘×¤× ×™× ×•, ×•×œ× ×¡×™×‘×•×ª ×”××§×¨×” ×›×¤×™ ×©×ª×•××¨×• ×œ× ×• ×¢"×™ ×‘×¢×œ ×”×¨×›×‘ ××©×¨ ×œ×“×‘×¨×™×•.

×§×•×“ ×“×’× ×¨×™×©×™×•×Ÿ ×”×¨×›×‘ × ×‘×“×§ ×‘×”×ª×× ×œ×˜×‘×œ×ª ×”××¨×” ×©×œ ×œ×•×™ ×™×¦×—×§ ×•× ××¦× %×§×•×“_×“×’×%.

××—×•×– ×”× ×–×§ ×‘×¨×›×‘ ×”× "×œ ×”×•× %××—×•×–_× ×–×§% ××¢×¨×š ×”×¨×›×‘.

×”×¦×¢×” ×–×• ××™× ×” ×›×•×œ×œ×ª × ×–×§×™× ×‘×œ×ª×™ × ×¨××™× ××¨××© ×”×¢×œ×•×œ×™× ×œ×”×ª×’×œ×•×ª ×‘××”×œ×š ×¤×™×¨×•×§ ×•/××• ×ª×™×§×•×Ÿ.

×œ×”×¢×¨×›×ª×™× ×• ×™×¨×™×“×ª ×¢×¨×š ×¦×¤×•×™×” ×› %×™×¨×™×“×ª_×¢×¨×š% ××¢×¨×š ×”×¨×›×‘ ×”× "×œ ×××™×¨×•×¢ ×”× ×“×•×Ÿ.

×œ×˜×¢× ×ª ×‘×¢×œ ×”×¨×›×‘ %××•×§×“×™_× ×–×§% ××•×§×“×™ ×”× ×–×§ ×××™×¨×•×¢ ×”× ×“×•×Ÿ.

×œ××•×¨ ×”×™×§×£ ×”× ×–×§×™× ×× ×• ×××œ×¦×™× ×œ×¡×œ×§ ××ª ×”×ª×‘×™×¢×” ×”× "×œ ×¢×œ ×‘×¡×™×¡ "××•×‘×“×Ÿ ×œ×”×œ×›×”" ×œ×œ× ×ª×™×§×•×Ÿ ×‘×¤×•×¢×œ.

×œ×”×¢×¨×›×ª×™× ×• ×–××Ÿ ×”×©×”×™×™×” ×‘××•×¡×š ×œ×¦×•×¨×š ×ª×™×§×•×Ÿ %×™××™_××•×¡×š% ×™××™ ×¢×‘×•×“×”.`,
        
        '×˜×•×˜×œ×•×¡': `×—×•×•×ª ×“×¢×ª×™× ×• ××ª×‘×¦×¢×ª ×‘×˜×¨× ×ª×™×§×•× ×™× ×‘×¤×•×¢×œ ×•××™× ×” ×›×•×œ×œ×ª × ×–×§×™× ×¡××•×™×™×.

×‘×”×ª×× ×œ×‘×“×™×§×” ×”× ×–×§ ×‘×¨×›×‘ ××•×¢×¨×š ×‘×™×•×ª×¨ ×-60% ××¢×¨×š ×”×¨×›×‘, ×•××©×›×š ×”×¨×›×‘ ××¡×•×•×’ ×›×˜×•×˜×œ×•×¡.

×¢×¨×š ×”×¨×›×‘ ×”××—×•×©×‘ ×œ×¤×™ ××—×™×¨×•×Ÿ ×œ×•×™ ×™×¦×—×§: %×©×•×•×™_×¨×›×‘%.

×©×•×•×™ ×”×©×¨×™×“×™×: %×©×•×•×™_×©×¨×™×“×™×%.

× ×™×›×•×™ ×™×¨×™×“×ª ×¢×¨×š: %×™×¨×™×“×ª_×¢×¨×š%

×”×¢×¨×›×ª × ×–×§×™× ××‘×•×¡×¡×ª ×¢×œ ×”× ×ª×•× ×™× ×©× ××¡×¨×• ×¢×´×™ ×‘×¢×œ ×”×¨×›×‘, ××©×¨ ×œ×“×‘×¨×™×•.

×”×¦×”×¨×”: ×× ×™ ×”×—×ª×´×: ×™×¨×•×Ÿ ×›×™×•×£, ×ª×¢×•×“×ª ×©×××™ ××¡' 1097. ×”× × ×™ × ×•×ª×Ÿ ××ª ×—×•×•×ª ×“×¢×ª×™ ×–×• ×‘××§×•× ×¢×“×•×ª ×‘×©×‘×•×¢×” ×‘×‘×™×ª ××©×¤×˜. ×”×“×™×Ÿ ×©×œ ×—×•×•×ª ×“×¢×ª ×–×• ×”×•× ×›×“×™×Ÿ ×¢×“×•×ª ×‘×©×‘×•×¢×”.`
      };
      
      let legalText = legalTextsVault[selectedType] || legalTextsVault['××•×‘×“×Ÿ_×œ×”×œ×›×”'];
      
      // Enhanced placeholder mapping to actual field values - Fixed for exact vault text matching
      const placeholders = {
        '%××¡×¤×¨_×¨×›×‘%': document.getElementById('carPlate')?.value || helper.meta?.plate || '[××¡×¤×¨ ×¨×›×‘]',
        '%×ª×•×¦×¨×ª%': document.getElementById('carManufacturer')?.value || helper.car_details?.manufacturer || '[×ª×•×¦×¨×ª]',
        '%×“×’×%': document.getElementById('carModel')?.value || helper.car_details?.model || '[×“×’×]',
        '%×©× ×”%': document.getElementById('carYear')?.value || helper.car_details?.year || '[×©× ×”]',
        '%×‘×¢×œ_×¨×›×‘%': document.getElementById('ownerName')?.value || helper.client?.name || '[×©× ×‘×¢×œ ×”×¨×›×‘]',
        '%×§×•×“_×“×’×%': document.getElementById('carModelCode')?.value || helper.car_details?.model_code || helper.levi_report?.model_code || '[×§×•×“ ×“×’×]',
        '%××—×•×–_× ×–×§%': document.getElementById('grossPercent')?.value || helper.claims_data?.gross_percent || calculateDamagePercentage() || helper.expertise?.calculations?.damage_percent || '[××—×•×– × ×–×§]',
        '%×™×¨×™×“×ª_×¢×¨×š%': document.getElementById('globalDep1')?.value || helper.estimate_depreciation?.global_percent || '[×™×¨×™×“×ª ×¢×¨×š]',
        '%××•×§×“×™_× ×–×§%': helper.expertise?.damage_blocks?.length || '[××¡×¤×¨ ××•×§×“×™×]',
        '%×™××™_××•×¡×š%': document.getElementById('garageDays')?.value || helper.estimate_work_days || helper.expertise?.depreciation?.work_days || '[×™××™ ××•×¡×š]',
        '%×©×•×•×™_×¨×›×‘%': document.getElementById('carMarketValue')?.value || document.getElementById('sumMarketValue')?.value || (helper.expertise?.calculations?.market_value ? `â‚ª${helper.expertise.calculations.market_value.toLocaleString()}` : '[×©×•×•×™ ×¨×›×‘]'),
        '%×©×•×•×™_×©×¨×™×“×™×%': (() => {
          const salvageInput = document.getElementById('salvageValue')?.value;
          const helperSalvage = helper.estimate_summary?.salvage_value || helper.estimate_salvage_value;
          
          if (salvageInput && salvageInput.trim() !== '' && salvageInput !== 'â‚ª0') {
            return salvageInput;
          } else if (helperSalvage && helperSalvage !== 'â‚ª0') {
            return helperSalvage;
          } else {
            return '[×©×•×•×™ ×©×¨×™×“×™×]';
          }
        })()
      };
      
      // Replace placeholders
      for (const [placeholder, value] of Object.entries(placeholders)) {
        legalText = legalText.replace(new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), value);
      }
      
      document.getElementById('legal-text-content').value = legalText;
    }

    // LOAD LEGAL TEXT FROM VAULT - SEPARATE FUNCTION FOR BUTTON
    function loadLegalTextFromVault() {
      loadLegalText();
      
      // Save the legal text to helper for the specific estimate
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      helper.estimate_legal_text = document.getElementById('legal-text-content').value;
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      console.log('Legal text loaded from vault and saved to estimate');
    }

    // RESET LEGAL TEXT
    function resetLegalText() {
      const selectedType = document.querySelector('input[name="estimate-type"]:checked')?.value || '××•×‘×“×Ÿ_×œ×”×œ×›×”';
      const typeText = selectedType === '××•×‘×“×Ÿ_×œ×”×œ×›×”' ? '××•×‘×“×Ÿ ×œ×”×œ×›×”' : '×˜×•×˜×œ×•×¡';
      
      document.getElementById('legal-text-content').value = `×˜×§×¡×˜ ××©×¤×˜×™ ×œ××•××“×Ÿ ${typeText} - ××•×›×Ÿ ×œ×¢×¨×™×›×”`;
      
      // Clear saved legal text from helper
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      delete helper.estimate_legal_text;
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      console.log('Legal text reset');
    }

    // ADD GLOBAL DEPRECIATION CALCULATION
    function updateGlobalDepreciationCalculation() {
      const globalDepInput = document.getElementById('globalDep1');
      const globalDepValueInput = document.getElementById('globalDepValue');
      
      if (globalDepInput && globalDepValueInput) {
        globalDepInput.addEventListener('input', function() {
          let percent = parseFloat(this.value) || 0;
          
          // Auto-add % symbol if not present and user enters a number
          if (this.value && !this.value.includes('%') && !isNaN(percent)) {
            this.value = percent + '%';
          }
          
          // Calculate value from market price automatically - try multiple sources
          let marketValue = 0;
          
          // First try summary market value (priority)
          const sumMarketValueField = document.getElementById('sumMarketValue');
          if (sumMarketValueField && sumMarketValueField.value) {
            const sumMarketStr = sumMarketValueField.value.replace(/[â‚ª,]/g, '') || '0';
            marketValue = parseFloat(sumMarketStr) || 0;
          }
          
          // If no summary value, try car details market value
          if (marketValue === 0) {
            const carMarketValueField = document.getElementById('carMarketValue');
            if (carMarketValueField && carMarketValueField.value) {
              const carMarketStr = carMarketValueField.value.replace(/[â‚ª,]/g, '') || '0';
              marketValue = parseFloat(carMarketStr) || 0;
            }
          }
          
          console.log('Global depreciation calculation:', {
            percent,
            marketValue,
            calculation: (marketValue * percent) / 100
          });
          
          const calculatedValue = (marketValue * percent) / 100;
          globalDepValueInput.value = calculatedValue ? `â‚ª${Math.round(calculatedValue).toLocaleString()}` : '';
          
          // TRIGGER SUMMARY UPDATE when global depreciation value changes
          if (window.addSummaryCalculationListeners) {
            const sumCalculate = document.querySelector('[data-summary-calculate]');
            if (sumCalculate) {
              sumCalculate.click();
            }
          }
          
          // Direct trigger for summary calculations
          setTimeout(() => {
            const event = new Event('input', { bubbles: true });
            globalDepValueInput.dispatchEvent(event);
          }, 100);
        });
      }
    }
    
    // CALCULATE DAMAGE PERCENTAGE
    function calculateDamagePercentage() {
      try {
        const totalClaim = parseFloat(document.getElementById('sumClaim')?.value.replace(/[â‚ª,]/g, '') || '0') || 0;
        
        // Try to get vehicle_value_gross from helper first (gross market value for damage calculation)
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        const vehicleValueGross = helper.calculations?.vehicle_value_gross || 0;
        
        // Fallback to market value if vehicle_value_gross not available
        const marketValue = parseFloat(document.getElementById('sumMarketValue')?.value.replace(/[â‚ª,]/g, '') || '0') || 0;
        const calculationBase = vehicleValueGross > 0 ? vehicleValueGross : marketValue;
        
        if (calculationBase > 0 && totalClaim > 0) {
          const percentage = (totalClaim / calculationBase) * 100;
          console.log(`ğŸ“Š Damage percentage calculation: ${totalClaim.toLocaleString()} Ã· ${calculationBase.toLocaleString()} = ${Math.round(percentage)}%`);
          return Math.round(percentage) + '%';
        }
        return '[××—×•×– × ×–×§]';
      } catch (error) {
        return '[××—×•×– × ×–×§]';
      }
    }

    // UPDATE GROSS MARKET VALUE FIELD
    function updateGrossMarketValueField() {
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        const vehicleValueGross = helper.calculations?.vehicle_value_gross;
        
        if (vehicleValueGross && vehicleValueGross > 0) {
          const leviPriceListField = document.getElementById('leviPriceList');
          if (leviPriceListField) {
            leviPriceListField.value = `â‚ª${vehicleValueGross.toLocaleString()}`;
            
            // Update helper claims data to maintain consistency
            helper.claims_data = helper.claims_data || {};
            helper.claims_data.levi_price_list = `â‚ª${vehicleValueGross.toLocaleString()}`;
            sessionStorage.setItem('helper', JSON.stringify(helper));
            
            console.log(`ğŸ’° Updated gross market value field: â‚ª${vehicleValueGross.toLocaleString()}`);
          }
        }
        
        // Also update the gross percentage calculation
        updateGrossPercentageField();
      } catch (error) {
        console.error('Error updating gross market value field:', error);
      }
    }

    // UPDATE GROSS PERCENTAGE FIELD
    function updateGrossPercentageField() {
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        const vehicleValueGross = helper.calculations?.vehicle_value_gross;
        
        // Get total claim from the field or helper
        const totalClaimField = document.getElementById('totalClaim');
        const totalClaimValue = totalClaimField?.value || '';
        const totalClaim = parseFloat(totalClaimValue.replace(/[â‚ª,]/g, '')) || 0;
        
        if (vehicleValueGross && vehicleValueGross > 0 && totalClaim > 0) {
          // Calculate gross percentage: (Total Claim Ã· Gross Market Value) Ã— 100
          const grossPercentage = (totalClaim / vehicleValueGross) * 100;
          const formattedPercentage = `${Math.round(grossPercentage * 100) / 100}%`;
          
          const grossPercentField = document.getElementById('grossPercent');
          if (grossPercentField) {
            grossPercentField.value = formattedPercentage;
            
            // Update helper claims data to maintain consistency
            helper.claims_data = helper.claims_data || {};
            helper.claims_data.gross_percent = formattedPercentage;
            
            // Also update expertise.calculations for system compatibility
            helper.expertise = helper.expertise || {};
            helper.expertise.calculations = helper.expertise.calculations || {};
            helper.expertise.calculations.damage_percent = Math.round(grossPercentage * 100) / 100;
            
            sessionStorage.setItem('helper', JSON.stringify(helper));
            
            console.log(`ğŸ“Š Updated gross percentage: ${totalClaim.toLocaleString()} Ã· ${vehicleValueGross.toLocaleString()} = ${formattedPercentage}`);
          }
        }
      } catch (error) {
        console.error('Error updating gross percentage field:', error);
      }
    }

    // TRIGGER GLOBAL DEPRECIATION CALCULATION
    function triggerGlobalDepreciationCalc() {
      const globalDepInput = document.getElementById('globalDep1');
      if (globalDepInput && globalDepInput.value) {
        const event = new Event('input', { bubbles: true });
        globalDepInput.dispatchEvent(event);
      }
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      loadDataFromHelper();
      loadLegalText();
      updateGlobalDepreciationCalculation();
      
      // Initialize adjustment system with event listeners
      setTimeout(() => {
        console.log('ğŸš€ Initializing adjustment system on page load');
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        // Load all adjustments if they exist
        if (helper.levi?.custom_adjustments || helper.levi?.adjustments) {
          loadAllAdjustments(helper);
        }
        
        // Ensure event listeners are attached
        addAdjustmentEventListeners();
        
        // Trigger initial auto-calculation for existing adjustments
        if (helper.levi?.custom_adjustments && helper.levi.custom_adjustments.length > 0) {
          console.log('ğŸ”„ Running initial auto-calculation for existing adjustments');
          helper.levi.custom_adjustments.forEach((adjustment, index) => {
            if (adjustment.percentage && adjustment.percentage !== 0) {
              calculateAdjustmentValue('custom', index, adjustment.percentage);
            }
          });
        }
      }, 400);
      
      // Trigger initial calculation after page loads
      setTimeout(triggerGlobalDepreciationCalc, 500);
      
      // Add listener to garage days field
      const garageDaysField = document.getElementById('garageDays');
      if (garageDaysField) {
        garageDaysField.addEventListener('input', loadLegalText);
      }
      
      // Add listener to legal text textarea to save changes
      const legalTextArea = document.getElementById('legal-text-content');
      if (legalTextArea) {
        legalTextArea.addEventListener('input', function() {
          const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
          helper.estimate_legal_text = this.value;
          sessionStorage.setItem('helper', JSON.stringify(helper));
        });
      }
      
      // Update legal text when estimate type changes
      document.querySelectorAll('input[name="estimate-type"]').forEach(radio => {
        radio.addEventListener('change', function() {
          updateReportType();
          loadLegalText();
        });
      });
    });

    // PARTS SEARCH FUNCTIONALITY
    function showPartSuggestions(input, centerIndex, partIndex) {
      const query = input.value.toLowerCase().trim();
      const suggestionsDiv = input.nextElementSibling;
      
      if (query.length < 2) {
        suggestionsDiv.style.display = 'none';
        return;
      }
      
      // Get stored search results from helper
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      const storedResults = helper.parts_search?.results || [];
      
      // Filter results based on query
      const filteredResults = storedResults.filter(part => 
        part.name?.toLowerCase().includes(query) || 
        part.desc?.toLowerCase().includes(query)
      );
      
      if (filteredResults.length > 0) {
        let suggestionsHTML = '';
        filteredResults.slice(0, 10).forEach(part => {
          suggestionsHTML += `
            <div onclick="selectPartSuggestion('${part.name}', '${part.desc}', '${part.price || 0}', '${part.source || ''}', ${centerIndex}, ${partIndex})" 
                 style="padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 13px;"
                 onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">
              <strong>${part.name}</strong><br>
              <small style="color: #666;">${part.desc || ''} ${part.price ? '- â‚ª' + part.price : ''}</small>
            </div>
          `;
        });
        
        // Add option to search for new parts
        suggestionsHTML += `
          <div onclick="openPartsSearchModule('${query}', ${centerIndex}, ${partIndex})" 
               style="padding: 8px; cursor: pointer; background: #e3f2fd; border-top: 1px solid #ddd; font-size: 13px; color: #1976d2;"
               onmouseover="this.style.background='#bbdefb'" onmouseout="this.style.background='#e3f2fd'">
            ğŸ” ×—×¤×© ×—×œ×§×™× ×—×“×©×™× ×¢×‘×•×¨: "${query}"
          </div>
        `;
        
        suggestionsDiv.innerHTML = suggestionsHTML;
        suggestionsDiv.style.display = 'block';
      } else {
        // Show only search option if no stored results
        suggestionsDiv.innerHTML = `
          <div onclick="openPartsSearchModule('${query}', ${centerIndex}, ${partIndex})" 
               style="padding: 8px; cursor: pointer; background: #e3f2fd; font-size: 13px; color: #1976d2;"
               onmouseover="this.style.background='#bbdefb'" onmouseout="this.style.background='#e3f2fd'">
            ğŸ” ×—×¤×© ×—×œ×§×™× ×¢×‘×•×¨: "${query}"
          </div>
        `;
        suggestionsDiv.style.display = 'block';
      }
    }

    // SELECT PART FROM SUGGESTIONS
    function selectPartSuggestion(name, desc, price, source, centerIndex, partIndex) {
      const partRow = document.querySelector(`.part-row[data-center="${centerIndex}"][data-part="${partIndex}"]`);
      if (partRow) {
        partRow.querySelector('.part-name').value = name;
        partRow.querySelector('.part-desc').value = desc;
        partRow.querySelector('.part-price').value = price;
        partRow.querySelector('.part-source').value = source;
        
        // Hide suggestions
        partRow.querySelector('.part-suggestions').style.display = 'none';
        
        // Trigger save and recalculation
        saveDamageCenterChanges();
      }
    }

    // OPEN PARTS SEARCH MODULE
    function openPartsSearchModule(query, centerIndex, partIndex) {
      // Store the target location for the search result
      sessionStorage.setItem('partSearchTarget', JSON.stringify({
        centerIndex,
        partIndex,
        query
      }));
      
      // Open independent parts search module
      const partsSearchUrl = 'parts search.html?query=' + encodeURIComponent(query);
      window.open(partsSearchUrl, 'partsSearch', 'width=1000,height=700,scrollbars=yes,resizable=yes');
    }

    // ADD/REMOVE ROW FUNCTIONS
    function addPartRow(centerIndex) {
      const partsList = document.querySelector(`.parts-list[data-center="${centerIndex}"]`);
      const newPartIndex = partsList.children.length;
      const newPartHTML = createEditablePartRow({}, centerIndex, newPartIndex);
      partsList.insertAdjacentHTML('beforeend', newPartHTML);
      
      // Add event listeners to new row
      setTimeout(addDamageCenterEventListeners, 50);
    }

    function addWorkRow(centerIndex) {
      const worksList = document.querySelector(`.works-list[data-center="${centerIndex}"]`);
      const newWorkIndex = worksList.children.length;
      const newWorkHTML = createEditableWorkRow('', centerIndex, newWorkIndex);
      worksList.insertAdjacentHTML('beforeend', newWorkHTML);
      
      // Add event listeners to new row
      setTimeout(addDamageCenterEventListeners, 50);
    }

    function addRepairRow(centerIndex) {
      const repairsList = document.querySelector(`.repairs-list[data-center="${centerIndex}"]`);
      const newRepairIndex = repairsList.children.length;
      const newRepairHTML = createEditableRepairRow('', centerIndex, newRepairIndex);
      repairsList.insertAdjacentHTML('beforeend', newRepairHTML);
      
      // Add event listeners to new row
      setTimeout(addDamageCenterEventListeners, 50);
    }

    function removePartRow(centerIndex, partIndex) {
      const partRow = document.querySelector(`.part-row[data-center="${centerIndex}"][data-part="${partIndex}"]`);
      if (partRow) {
        partRow.remove();
        saveDamageCenterChanges();
      }
    }

    function removeWorkRow(centerIndex, workIndex) {
      const workRow = document.querySelector(`.work-row[data-center="${centerIndex}"][data-work="${workIndex}"]`);
      if (workRow) {
        workRow.remove();
        saveDamageCenterChanges();
      }
    }

    function removeRepairRow(centerIndex, repairIndex) {
      const repairRow = document.querySelector(`.repair-row[data-center="${centerIndex}"][data-repair="${repairIndex}"]`);
      if (repairRow) {
        repairRow.remove();
        saveDamageCenterChanges();
      }
    }

    function removeDamageCenter(centerIndex) {
      if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ××•×§×“ ×”× ×–×§ ×”×–×”?')) {
        const centerCard = document.querySelector(`.editable-damage-card[data-center-index="${centerIndex}"]`);
        if (centerCard) {
          centerCard.remove();
          saveDamageCenterChanges();
        }
      }
    }

    function addNewDamageCenter() {
      const container = document.getElementById('editableDamageCenters');
      if (!container) {
        // If no container exists, create it
        document.getElementById('damageCentersContent').innerHTML = '<div style="display: grid; gap: 15px;" id="editableDamageCenters"></div>';
      }
      
      const newIndex = document.querySelectorAll('.editable-damage-card').length;
      const newBlock = {
        damage_center_name: `××•×§×“ × ×–×§ ${newIndex + 1}`,
        parts: [],
        works: [],
        repairs: [],
        work_cost: 0,
        parts_cost: 0
      };
      
      const newCardHTML = createEditableDamageCenterCard(newBlock, newIndex);
      document.getElementById('editableDamageCenters').insertAdjacentHTML('beforeend', newCardHTML);
      
      setTimeout(addDamageCenterEventListeners, 100);
    }

    // SAVE DAMAGE CENTER CHANGES TO HELPER
    function saveDamageCenterChanges() {
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        // Initialize expertise.damage_blocks if not exists
        if (!helper.expertise) helper.expertise = {};
        if (!helper.expertise.damage_blocks) helper.expertise.damage_blocks = [];
        
        // Clear existing damage blocks
        helper.expertise.damage_blocks = [];
        
        // Collect data from all damage center cards
        document.querySelectorAll('.editable-damage-card').forEach((card, index) => {
          const centerName = card.querySelector('.damage-center-name').value;
          
          // Collect parts
          const parts = [];
          card.querySelectorAll('.part-row').forEach(row => {
            const name = row.querySelector('.part-name').value;
            const desc = row.querySelector('.part-desc').value;
            const price = row.querySelector('.part-price').value;
            const source = row.querySelector('.part-source').value;
            
            if (name.trim()) {
              parts.push({ name, desc, price: parseFloat(price) || 0, source });
            }
          });
          
          // Collect works
          const works = [];
          card.querySelectorAll('.work-row').forEach(row => {
            const type = row.querySelector('.work-type').value;
            const note = row.querySelector('.work-note').value;
            const cost = parseFloat(row.querySelector('.work-cost').value) || 0;
            
            if (type) {
              works.push({ type, note, cost });
            }
          });
          
          // Collect repairs
          const repairs = [];
          card.querySelectorAll('.repair-row').forEach(row => {
            const text = row.querySelector('.repair-text').value;
            const cost = parseFloat(row.querySelector('.repair-cost').value) || 0;
            
            if (text.trim()) {
              repairs.push({ description: text, cost });
            }
          });
          
          // Calculate costs using individual cost fields
          const partsCost = parts.reduce((sum, part) => sum + (parseFloat(part.price) || 0), 0);
          const workCost = works.reduce((sum, work) => sum + (parseFloat(work.cost) || 0), 0);
          const repairsCost = repairs.reduce((sum, repair) => sum + (parseFloat(repair.cost) || 0), 0);
          const totalCost = partsCost + workCost + repairsCost;
          
          helper.expertise.damage_blocks.push({
            damage_center_name: centerName,
            parts,
            works,
            repairs,
            parts_cost: partsCost,
            work_cost: workCost
          });
          
          // Update cost display for this card
          updateCostDisplay(card, partsCost, workCost, repairsCost);
        });
        
        // Save updated helper
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        console.log('Damage centers saved:', helper.expertise.damage_blocks);
        
      } catch (error) {
        console.error('Error saving damage center changes:', error);
      }
    }

    // ADD EVENT LISTENERS
    function addDamageCenterEventListeners() {
      // Remove existing listeners by cloning elements (prevents duplicates)
      document.querySelectorAll('.damage-center-name, .part-name, .part-desc, .part-price, .work-type, .work-note, .work-cost, .repair-text, .repair-cost').forEach(input => {
        // Check if already has listeners
        if (!input.hasAttribute('data-listeners-added')) {
          input.addEventListener('change', () => {
            saveDamageCenterChanges();
            updateAllCostDisplays();
          });
          input.addEventListener('blur', () => {
            saveDamageCenterChanges();
            updateAllCostDisplays();
          });
          input.addEventListener('input', () => {
            updateAllCostDisplays();
          });
          
          // Mark as having listeners to prevent duplicates
          input.setAttribute('data-listeners-added', 'true');
          console.log(`ğŸ“ Added event listeners to: ${input.className}`);
        }
      });
      
      // Hide suggestions when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.part-row')) {
          document.querySelectorAll('.part-suggestions').forEach(div => {
            div.style.display = 'none';
          });
        }
      });
    }

    // UPDATE WORK COST FROM TYPE SELECTION
    function updateWorkCostFromType(selectElement, centerIndex, workIndex) {
      // REMOVED: Predefined work rates that were forcing costs
      // Work costs should be manually entered based on specific case requirements
      
      // Only trigger save and recalculation without changing cost
      saveDamageCenterChanges();
      updateAllCostDisplays();
      
      console.log(`ğŸ”§ Work type changed: ${selectElement.value} (cost remains manual)`);
    }

    // COST CALCULATION FUNCTIONS
    function calculateWorkCost(works) {
      return works.reduce((total, work) => {
        const cost = typeof work === 'object' ? (work.cost || 0) : 0;
        return total + parseFloat(cost);
      }, 0);
    }

    function calculateRepairsCost(repairs) {
      return repairs.reduce((total, repair) => {
        const cost = typeof repair === 'object' ? (repair.cost || 0) : 0;
        return total + parseFloat(cost);
      }, 0);
    }

    function updateCostDisplay(card, partsCost, workCost, repairsCost) {
      const totalCost = partsCost + workCost + repairsCost;
      const totalWithVAT = totalCost * 1.18;
      
      // Update display elements
      const workDisplay = card.querySelector('.work-costs-display');
      const partsDisplay = card.querySelector('.parts-costs-display');
      const repairsDisplay = card.querySelector('.repairs-costs-display');
      const totalDisplay = card.querySelector('.total-with-vat-display');
      
      if (workDisplay) workDisplay.textContent = `â‚ª${workCost.toLocaleString()}`;
      if (partsDisplay) partsDisplay.textContent = `â‚ª${partsCost.toLocaleString()}`;
      if (repairsDisplay) repairsDisplay.textContent = `â‚ª${repairsCost.toLocaleString()}`; // FIXED: Show only repairs cost, not total
      if (totalDisplay) totalDisplay.textContent = `â‚ª${Math.round(totalWithVAT).toLocaleString()}`;
    }

    function updateAllCostDisplays() {
      document.querySelectorAll('.editable-damage-card').forEach(card => {
        // Recalculate costs for this card using individual cost fields
        let partsCost = 0;
        card.querySelectorAll('.part-row').forEach(row => {
          const price = parseFloat(row.querySelector('.part-price').value) || 0;
          partsCost += price;
        });
        
        let workCost = 0;
        card.querySelectorAll('.work-row').forEach(row => {
          const cost = parseFloat(row.querySelector('.work-cost').value) || 0;
          workCost += cost;
        });
        
        let repairsCost = 0;
        card.querySelectorAll('.repair-row').forEach(row => {
          const cost = parseFloat(row.querySelector('.repair-cost').value) || 0;
          repairsCost += cost;
        });
        
        updateCostDisplay(card, partsCost, workCost, repairsCost);
      });
      
      // Update summary section totals
      updateSummaryTotalsFromDamageCenters();
    }

    function updateSummaryTotalsFromDamageCenters() {
      let totalClaim = 0;
      
      document.querySelectorAll('.editable-damage-card').forEach(card => {
        // Calculate total cost for each damage center (parts + works + repairs)
        let partsCost = 0;
        card.querySelectorAll('.part-row').forEach(row => {
          const price = parseFloat(row.querySelector('.part-price').value) || 0;
          partsCost += price;
        });
        
        let workCost = 0;
        card.querySelectorAll('.work-row').forEach(row => {
          const cost = parseFloat(row.querySelector('.work-cost').value) || 0;
          workCost += cost;
        });
        
        let repairsCost = 0;
        card.querySelectorAll('.repair-row').forEach(row => {
          const cost = parseFloat(row.querySelector('.repair-cost').value) || 0;
          repairsCost += cost;
        });
        
        totalClaim += partsCost + workCost + repairsCost;
      });
      
      // Update summary fields
      const sumClaimField = document.getElementById('sumClaim');
      const totalClaimField = document.getElementById('totalClaim');
      
      if (totalClaim > 0) {
        const formattedAmount = `â‚ª${totalClaim.toLocaleString()}`;
        
        // Update both summary claim and total claim fields
        if (sumClaimField) {
          sumClaimField.value = formattedAmount;
        }
        if (totalClaimField) {
          totalClaimField.value = formattedAmount;
        }
        
        // Trigger summary recalculation
        setTimeout(() => {
          if (sumClaimField) {
            const event = new Event('input', { bubbles: true });
            sumClaimField.dispatchEvent(event);
          }
        }, 100);
        
        // Also trigger gross percentage recalculation since total claim changed
        setTimeout(updateGrossPercentageField, 150);
      }
    }

    // Make functions global
    window.loadDataFromHelper = loadDataFromHelper;
    window.loadLegalText = loadLegalText;
    window.loadLegalTextFromVault = loadLegalTextFromVault;
    window.resetLegalText = resetLegalText;
    window.addDepField = addDepField;
    window.updateReportType = updateReportType;
    window.addCustomSummaryField = addCustomSummaryField;
    window.loadDamageCentersSummary = loadDamageCentersSummary;
    window.loadAllAdjustments = loadAllAdjustments;
    window.updateGlobalDepreciationCalculation = updateGlobalDepreciationCalculation;
    window.calculateDamagePercentage = calculateDamagePercentage;
    window.triggerGlobalDepreciationCalc = triggerGlobalDepreciationCalc;
    window.showPartSuggestions = showPartSuggestions;
    window.selectPartSuggestion = selectPartSuggestion;
    window.openPartsSearchModule = openPartsSearchModule;
    window.addPartRow = addPartRow;
    window.addWorkRow = addWorkRow;
    window.addRepairRow = addRepairRow;
    window.removePartRow = removePartRow;
    window.removeWorkRow = removeWorkRow;
    window.removeRepairRow = removeRepairRow;
    window.removeDamageCenter = removeDamageCenter;
    window.addNewDamageCenter = addNewDamageCenter;
    window.saveDamageCenterChanges = saveDamageCenterChanges;
    window.addDamageCenterEventListeners = addDamageCenterEventListeners;
    window.calculateWorkCost = calculateWorkCost;
    window.updateWorkCostFromType = updateWorkCostFromType;
    window.updateCostDisplay = updateCostDisplay;
    window.updateAllCostDisplays = updateAllCostDisplays;
    window.updateSummaryTotalsFromDamageCenters = updateSummaryTotalsFromDamageCenters;
    window.updateGrossMarketValueField = updateGrossMarketValueField;
    window.updateGrossPercentageField = updateGrossPercentageField;

    // MESSAGE LISTENER FOR PARTS SEARCH RESULTS
    window.addEventListener('message', function(event) {
      if (event.data.type === 'PARTS_SELECTED') {
        try {
          const { parts, target } = event.data;
          const { centerIndex, partIndex } = target;
          
          // Find the specific part row
          const targetCard = document.querySelector(`.editable-damage-card[data-center-index="${centerIndex}"]`);
          if (targetCard) {
            const partRows = targetCard.querySelectorAll('.part-row');
            const targetRow = partRows[partIndex];
            
            if (targetRow && parts.length > 0) {
              // Fill the first selected part into the target row
              const firstPart = parts[0];
              const nameInput = targetRow.querySelector('.part-name');
              const descInput = targetRow.querySelector('.part-desc');
              const priceInput = targetRow.querySelector('.part-price');
              const sourceInput = targetRow.querySelector('.part-source');
              
              if (nameInput) nameInput.value = firstPart.name || '';
              if (descInput) descInput.value = firstPart.description || '';
              if (priceInput) priceInput.value = firstPart.price || '';
              if (sourceInput) sourceInput.value = firstPart.source || '';
              
              // Add additional parts if more than one selected
              if (parts.length > 1) {
                const partsList = targetCard.querySelector('.parts-list');
                for (let i = 1; i < parts.length; i++) {
                  const part = parts[i];
                  const newPartIndex = partsList.children.length;
                  const newPartHTML = createEditablePartRow(part, centerIndex, newPartIndex);
                  partsList.insertAdjacentHTML('beforeend', newPartHTML);
                }
              }
              
              // Save changes and update costs
              saveDamageCenterChanges();
              updateAllCostDisplays();
              
              console.log(`âœ… Added ${parts.length} parts to damage center ${centerIndex + 1}`);
            }
          }
        } catch (error) {
          console.error('Error processing parts selection:', error);
        }
      }
    });
  </script>
  
  <script src="internal-browser.js"></script>
  <script src="levi-floating.js"></script>
  <script src="car-details-floating.js"></script>
</body>
</html>