<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>בניית אומדן - ירון כיוף שמאות</title>
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <style>
    body {
      font-family: sans-serif;
      background: #f3f6fb;
      margin: 0;
      min-height: 100vh;
      padding: 0;
      padding-top: 90px;
      overflow-x: hidden;
    }

    /* FLOATING SCREENS STYLING */
    .floating-toggles-top {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 8px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .toggle-square {
      width: 80px;
      height: 70px;
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: white;
      text-align: center;
      border: 2px solid transparent;
    }

    .toggle-square:hover {
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .toggle-square.active {
      border-color: #fbbf24;
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
    }

    .toggle-icon {
      font-size: 20px;
      margin-bottom: 4px;
    }

    .toggle-text {
      font-size: 10px;
      font-weight: 600;
      line-height: 1.2;
    }

    @media (max-width: 768px) {
      .floating-toggles-top {
        gap: 4px;
        padding: 6px;
      }
      
      .toggle-square {
        width: 70px;
        height: 60px;
      }
      
      .toggle-icon {
        font-size: 18px;
      }
      
      .toggle-text {
        font-size: 9px;
      }
    }

    .container {
      width: 100%;
      max-width:750px;
      background: #fff;
      padding: 32px 24px 24px 24px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.08);
      margin: 32px auto 32px auto;
      box-sizing: border-box;
    }

    .header {
      background: linear-gradient(135deg, #1e3a8a 0%, #475569 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .logo {
      width: 60px;
      height: 60px;
      margin: 0 auto 20px;
      border-radius: 50%;
      background: white;
      padding: 5px;
      display: block;
    }

    .business-name {
      font-size: 24px;
      font-weight: 600;
      margin: 15px 0 5px 0;
      color: white;
    }

    .business-subtitle {
      font-size: 16px;
      opacity: 0.9;
      margin: 0 0 15px 0;
      color: #e2e8f0;
    }

    .page-title {
      font-size: 28px;
      font-weight: 300;
      margin: 15px 0 0 0;
      color: white;
      border-top: 1px solid rgba(255,255,255,0.3);
      padding-top: 15px;
    }


    .content {
      padding: 30px;
    }

    .section {
      margin-bottom: 40px;
      padding: 25px;
      border: 1px solid #e1e8ed;
      border-radius: 10px;
      background: #fafbfc;
    }

    .section h3 {
      margin: 0 0 20px 0;
      color: #1e3a8a;
      font-size: 20px;
      border-bottom: 2px solid #3b82f6;
      padding-bottom: 10px;
    }

    .row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .field {
      flex: 1;
      min-width: 200px;
    }

    .field label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #475569;
    }

    .field input,
    .field select,
    .field textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #64748b;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .damage-center {
      background: white;
      border: 2px solid #e74c3c;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      position: relative;
    }

    .center-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #ecf0f1;
    }

    .center-header h4 {
      margin: 0;
      color: #e74c3c;
      font-size: 18px;
    }

    .remove-damage-center {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      transition: background-color 0.3s ease;
    }

    .remove-damage-center:hover {
      background: #c0392b;
    }

    .parts-section,
    .repairs-section {
      margin: 20px 0;
    }

    .parts-section h5,
    .repairs-section h5 {
      color: #1e3a8a;
      margin: 0 0 15px 0;
      font-size: 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    th {
      background: #1e3a8a;
      color: white;
      padding: 12px;
      text-align: center;
      font-weight: 600;
    }

    td {
      padding: 10px;
      border-bottom: 1px solid #ecf0f1;
    }

    td input,
    td select {
      width: 100%;
      padding: 8px;
      border: 1px solid #64748b;
      border-radius: 4px;
      font-size: 13px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #1e3a8a);
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #1e3a8a, #1e40af);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #64748b, #475569);
      color: white;
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #475569, #334155);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(100, 116, 139, 0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, #27ae60, #229954);
      color: white;
    }

    .btn-success:hover {
      background: linear-gradient(135deg, #229954, #1e8449);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
    }

    .totals-section {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      color: white;
      padding: 25px;
      border-radius: 10px;
      margin-top: 30px;
    }

    .totals-section h3 {
      margin: 0 0 20px 0;
      border-bottom: 2px solid rgba(255,255,255,0.3);
      padding-bottom: 10px;
    }

    .total-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .total-line:last-child {
      font-size: 20px;
      font-weight: bold;
      border-top: 2px solid rgba(255,255,255,0.3);
      padding-top: 15px;
      margin-top: 15px;
    }

    .legal-text-preview {
      background: #ecf0f1;
      padding: 20px;
      border-radius: 8px;
      margin-top: 15px;
    }

    .legal-text-preview h4 {
      color: #1e3a8a;
      margin: 0 0 15px 0;
    }

    .legal-text {
      line-height: 1.6;
      color: #475569;
      font-size: 14px;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 40px;
      padding: 30px;
      background: #f8f9fa;
      border-radius: 10px;
    }

    .depreciation-field {
      background: #fff3cd;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ffeaa7;
      margin-top: 15px;
      display: none; /* Hidden for estimates */
    }

    .depreciation-field label {
      color: #856404;
      font-weight: 600;
    }

    .estimate-type-section {
      background: #e8f5e8;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .estimate-type-section h3 {
      color: #2d5a2d;
      margin: 0 0 15px 0;
    }

    .estimate-type-radio {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }

    .estimate-type-radio label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .damage-validation {
      background: #f0f8ff;
      border: 2px solid #4682b4;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .damage-validation h3 {
      color: #4682b4;
      margin: 0 0 15px 0;
    }

    .damage-override {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .damage-override-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .override-toggle {
      background: #ffc107;
      color: #212529;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
    }

    .override-toggle:hover {
      background: #e0a800;
    }

    .additional-notes {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .additional-notes h3 {
      color: #475569;
      margin: 0 0 15px 0;
    }

    .additional-notes textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid #64748b;
      border-radius: 5px;
      font-family: inherit;
      resize: vertical;
    }

    .add-part-row,
    .add-repair-row {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      margin-top: 10px;
    }

    .add-part-row:hover,
    .add-repair-row:hover {
      background: #1e3a8a;
    }

    @media (max-width: 768px) {
      .row {
        flex-direction: column;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .action-buttons .btn {
        margin-bottom: 10px;
      }
    }

    .loading {
      display: none;
      text-align: center;
      color: #64748b;
    }

    /* COPIED STYLES FROM DEPRECIATION MODULE */
    .collapsible-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      width: 100%;
      text-align: right;
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }

    .collapsible-btn:hover {
      background: #0056b3;
    }

    .readonly-box {
      background: #f8f9fa;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 8px 12px;
      min-height: 20px;
      color: #495057;
      font-size: 14px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    .form-grid label {
      font-weight: 600;
      margin-bottom: 5px;
      display: block;
      color: #374151;
    }

    /* SUMMARY SECTION STYLES - COPIED FROM DEPRECIATION MODULE */
    .summary-block {
      background: #f8fffe;
      border: 2px solid #10b981;
      border-radius: 12px;
      padding: 20px;
    }

    .summary-block h3 {
      color: #047857;
      margin-bottom: 20px;
      font-size: 18px;
      border-bottom: 2px solid #10b981;
      padding-bottom: 8px;
    }

    .levi-adjustments-section {
      border: 1px solid #e5e7eb;
      border-radius: 6px;
    }

    .btn.add {
      background: #10b981;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
    }

    .btn.add:hover {
      background: #059669;
    }

    .loading.show {
      display: block;
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alert.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .alert.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .alert.show {
      display: block;
    }

    .footer {
      background: #1e3a8a;
      color: white;
      text-align: center;
      padding: 20px;
      margin-top: 40px;
      font-size: 14px;
    }

    .form-section {
      background: #fafbfc;
      border: 1px solid #e1e8ed;
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 20px;
    }

    .form-section h3 {
      margin: 0 0 20px 0;
      color: #1e3a8a;
      font-size: 20px;
      border-bottom: 2px solid #3b82f6;
      padding-bottom: 10px;
    }

    .btn.add {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      padding: 8px 16px;
      font-size: 12px;
      margin-top: 10px;
    }

    .btn.add:hover {
      background: linear-gradient(135deg, #20c997, #17a2b8);
      transform: translateY(-1px);
    }
  </style>
</head>
<body>
  <!-- FLOATING SCREEN TOGGLES - TOP OF PAGE -->
  <div class="floating-toggles-top">
    <div class="toggle-square" onclick="toggleFloatingScreen('leviReport')">
      <div class="toggle-icon">📊</div>
      <div class="toggle-text">דו"ח לוי יצחק</div>
    </div>
    <div class="toggle-square" onclick="toggleFloatingScreen('carDetails')">
      <div class="toggle-icon">🚗</div>
      <div class="toggle-text">פרטי רכב</div>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo" class="logo">
      <div class="business-name">ירון כיוף שמאות - פורטל</div>
      <div class="business-subtitle">שמאות והערכת נזקי רכב ורכוש</div>
      <div class="page-title">בניית אומדן נזקי רכב</div>
    </div>

    <div class="content">
      <div id="alerts"></div>
      
      <form id="estimate-form">
        <!-- Vehicle Information Section -->
        <div id="vehicle-info"></div>

        <!-- Estimate Type Selection -->
        <div class="estimate-type-section" id="estimate-type">
          <h3>סוג האומדן</h3>
          <div class="estimate-type-radio">
            <label>
              <input type="radio" name="estimate-type" value="אובדן_להלכה" checked>
              אומדן ראשוני - אובדן להלכה
            </label>
            <label>
              <input type="radio" name="estimate-type" value="טוטלוס">
              אומדן ראשוני - טוטלוס
            </label>
          </div>
        </div>

        <!-- Car Details Section - COPIED FROM DEPRECIATION MODULE -->
        <div class="form-section" id="vehicle-details">
          <h3>נתוני רכב</h3>
          <div class="form-grid" id="vehicleData">
            <div>
              <label>מספר רכב:</label>
              <input type="text" id="carPlate" placeholder="הכנס מספר רכב">
            </div>
            <div>
              <label>תוצרת:</label>
              <input type="text" id="carManufacturer" placeholder="תוצרת הרכב">
            </div>
            <div>
              <label>דגם:</label>
              <input type="text" id="carModel" placeholder="דגם הרכב">
            </div>
            <div>
              <label>שנת ייצור:</label>
              <input type="number" id="carYear" placeholder="שנת ייצור">
            </div>
            <div>
              <label>מחיר בסיס:</label>
              <input type="number" id="carBasePrice" placeholder="מחיר בסיס">
            </div>
            <div>
              <label>תאריך הפקה:</label>
              <input type="date" id="carReportDate">
            </div>
          </div>
        </div>

        <!-- Collapsible Claims Data Section - COPIED FROM DEPRECIATION MODULE -->
        <div class="form-section">
          <button class="collapsible-btn" type="button" onclick="toggleSection('priceData')">נתוני תביעה (הצג/הסתר)</button>
          <div id="priceData" style="display:none;">
            <div class="form-grid">
              <div><label>סה״כ תביעה:</label><div class="readonly-box" id="totalClaim"></div></div>
              <div><label>חישוב הערך לנזק גולמי:</label><div class="readonly-box" id="leviPriceList"></div></div>
              <div><label>חישוב האחוז הגולמי:</label><div class="readonly-box" id="grossPercent"></div></div>
              <div><label>סה"כ תביעה (מאושר):</label><div class="readonly-box" id="authorizedClaim"></div></div>
              <div><label>ערך השוק של הרכב:</label><div class="readonly-box" id="finalMarketValue"></div></div>
            </div>
          </div>
        </div>

        <!-- Collapsible Contact Data Section - COPIED FROM DEPRECIATION MODULE -->
        <div class="form-section">
          <button class="collapsible-btn" type="button" onclick="toggleSection('contactData')">נתוני התקשרות (הצג/הסתר)</button>
          <div id="contactData" style="display:none;">
            <div class="form-grid">
              <div><label>שם בעל הרכב:</label><div class="readonly-box" id="ownerName"></div></div>
              <div><label>כתובת בעל הרכב:</label><div class="readonly-box" id="ownerAddress"></div></div>
              <div><label>טלפון בעל הרכב:</label><div class="readonly-box" id="ownerPhone"></div></div>
              <div><label>חברת ביטוח:</label><div class="readonly-box" id="insuranceCompany"></div></div>
              <div><label>אימייל חברת ביטוח:</label><div class="readonly-box" id="insuranceEmail"></div></div>
              <div><label>סוכן ביטוח:</label><div class="readonly-box" id="insuranceAgent"></div></div>
              <div><label>טלפון סוכן ביטוח:</label><div class="readonly-box" id="agentPhone"></div></div>
              <div><label>אימייל סוכן ביטוח:</label><div class="readonly-box" id="agentEmail"></div></div>
            </div>
          </div>
        </div>

        <!-- Damage Centers Validation -->
        <div class="damage-validation">
          <h3>אימות מוקדי נזק מהאקספרטיזה</h3>
          <div id="damage-validation-list"></div>
        </div>

<!-- 5. ESTIMATE DEPRECIATION BULK SECTION -->
    <div class="form-section" id="depreciationSection">
      <h3>חישוב ירידת ערך לפי מוקדי נזק</h3>
      <div style="display:grid; grid-template-columns:1fr 1fr 120px 120px 80px; gap:14px; margin-bottom:10px;">
        <div><label>החלק הניזוק:</label></div>
        <div><label>מהות התיקון:</label></div>
        <div><label>% ירידת ערך:</label></div>
        <div><label>ערך ב-₪:</label></div>
        <div><label>פעולות:</label></div>
      </div>
      <div id="depreciationBulkTable"></div>
      <button class="btn add" type="button" onclick="addDepField()">הוסף שדה</button>
      <div style="margin-top:14px;">
        <label>ירידת ערך גלובלי:</label>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:14px;">
          <input type="number" id="globalDep1" placeholder="% ירידת ערך" />
          <input type="number" id="globalDepValue" placeholder="ערך ב-₪" readonly style="background:#f4f6fa;" />
        </div>
      </div>
    </div>
    


        <!-- Additional Notes Section -->
        <div class="additional-notes">
          <h3>הערות נוספות לאומדן</h3>
          <textarea id="additional-notes" placeholder="הוסף הערות, המלצות או מידע נוסף לאומדן..."></textarea>
        </div>

        <!-- Complex Summary Section - COPIED FROM DEPRECIATION MODULE AND ADAPTED FOR ESTIMATE -->
        <div class="form-section summary-block" id="summaryEstimate">
          <h3>סיכום - חוות דעת פרדטיזה - אומדן</h3>
          <div class="form-grid">
            <div>
              <label>ערך השוק של הרכב:</label>
              <input type="text" id="sumMarketValueEstimate" />
            </div>
            <div>
              <label>סה"כ תביעה:</label>
              <input type="text" id="sumTotalClaimEstimate" />
            </div>
          </div>
          <div style="margin:16px 0 0 0;">
            <label>פיצוי בגין ירידת ערך:</label>
            <input type="text" id="compensationEstimate" placeholder="פיצוי ירידת ערך" />
          </div>
          <div style="margin:16px 0 0 0;">
            <label>תוספות והורדות:</label>
            <div class="levi-adjustments-section" id="leviAdjustments-estimate" style="background: #f8f9fa; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
              <div style="font-weight: bold; margin-bottom: 8px; color: #495057; font-size: 14px;">התאמות מדו"ח לוי יצחק:</div>
              <div class="levi-adjustments-grid" style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 8px; font-size: 13px;">
                <div style="font-weight: bold;">מהות ההתאמה</div>
                <div style="font-weight: bold;">אחוז</div>
                <div style="font-weight: bold;">ערך (₪)</div>
              </div>
              <div id="leviAdjustmentsRows-estimate"></div>
            </div>
            <div style="margin-bottom: 8px; font-weight: bold; color: #495057; font-size: 14px;">תוספות נוספות:</div>
            <div class="form-grid" id="sumAdditionsGridEstimate"></div>
            <button class="btn add" type="button" onclick="addCustomSummaryField('summaryEstimate')">הוסף שדה נוסף</button>
          </div>
          <div class="form-grid" style="margin-top:16px;">
            <div>
              <label>סה״כ נכלל בחוות הדעת (לפני מע"מ):</label>
              <input type="text" id="sumTotalEstimate" readonly />
            </div>
            <div>
              <label>מע"מ (<span id="vat-rate">18</span>%):</label>
              <input type="text" id="vatAmountEstimate" readonly />
            </div>
          </div>
          <div class="form-grid" style="margin-top:8px;">
            <div>
              <label>סה״כ סופי כולל מע"מ:</label>
              <input type="text" id="sumTotalFinalEstimate" readonly style="background:#e8f5e8; border:2px solid #28a745; font-weight:bold;" />
            </div>
          </div>
        </div>

        <!-- Action Buttons - COPIED STYLE FROM DEPRECIATION MODULE -->
        <div class="action-buttons">
          <button type="button" class="btn btn-primary" onclick="saveEstimate()">
            💾 שמור אומדן
          </button>
          <button type="button" class="btn btn-secondary" onclick="previewEstimate()">
            👁️ תצוגה מקדימה
          </button>
          <button type="button" class="btn btn-success" onclick="generateEstimate()">
            📄 צור דו"ח אומדן
          </button>
          <button type="button" class="btn btn-secondary" onclick="window.location.href='selection.html'">
            🏠 חזור לדף הבית
          </button>
          <button type="button" class="btn btn-warning" onclick="alert('TEST: Button onclick works!')">
            🧪 TEST
          </button>
        </div>

        <!-- Legal Text Section - MOVED TO END AS SPECIFIED -->
        <div class="form-section legal-text-section" id="legal-text">
          <h3>טקסט משפטי לאומדן</h3>
          <div class="legal-text-preview" id="legal-text-preview">
            <h4>תצוגה מקדימה של הטקסט המשפטי:</h4>
            <div class="legal-text" id="legal-text" style="background: #f8f9fa; border: 1px solid #e2e8f0; border-radius: 6px; padding: 15px; min-height: 100px; white-space: pre-wrap; line-height: 1.6;">
              הטקסט המשפטי יטען כאן עם הנתונים המעודכנים...
            </div>
          </div>
        </div>
      </form>

      <div class="loading" id="loading">
        <p>⏳ מעבד נתונים...</p>
      </div>
    </div>
    
    <div class="footer">
      All rights reserved © Carmel Cayouf
    </div>
  </div>

  <script type="module" src="./estimate-generator.js"></script>
  <script type="module" src="./helper.js"></script>
  <script type="module" src="./validation.js"></script>
  <script type="module" src="./math.js"></script>
  <script type="module" src="./webhook.js"></script>
  <script type="module" src="./vault-loader.js"></script>
  
  <!-- FLOATING SCREENS SCRIPTS -->
  <script type="module" src="./levi-floating.js"></script>
  <script type="module" src="./car-details-floating.js"></script>
  <script type="module" src="./internal-browser.js"></script>

  <script>
    // Utility functions for UI feedback
    function showAlert(message, type = 'success') {
      const alertsContainer = document.getElementById('alerts');
      const alert = document.createElement('div');
      alert.className = `alert ${type} show`;
      alert.textContent = message;
      alertsContainer.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    function showLoading(show = true) {
      const loading = document.getElementById('loading');
      if (show) {
        loading.classList.add('show');
      } else {
        loading.classList.remove('show');
      }
    }

    // Override alert function to use custom styling
    window.originalAlert = window.alert;
    window.alert = function(message) {
      if (message.includes('❌')) {
        showAlert(message, 'error');
      } else if (message.includes('✅') || message.includes('📝')) {
        showAlert(message, 'success');
      } else {
        window.originalAlert(message);
      }
    };

    // FLOATING SCREENS TOGGLE FUNCTION - COPIED FROM DEPRECIATION MODULE
    window.toggleFloatingScreen = function(screenType) {
      console.log('Toggling floating screen:', screenType);
      
      const screens = {
        leviReport: () => {
          if (window.toggleLeviReport) {
            window.toggleLeviReport();
          } else {
            console.log('Levi report floating screen not available');
          }
        },
        carDetails: () => {
          if (window.toggleCarDetails) {
            window.toggleCarDetails();
          } else {
            console.log('Car details floating screen not available');
          }
        },
        internalBrowser: () => {
          if (window.showBrowserMenu) {
            showBrowserMenuUnderToggle();
          } else {
            console.log('Internal browser not available');
          }
        }
      };
      
      if (screens[screenType]) {
        screens[screenType]();
      } else {
        console.log('Unknown screen type:', screenType);
      }
    };

    // CUSTOM BROWSER MENU - COPIED FROM DEPRECIATION MODULE
    function showBrowserMenuUnderToggle() {
      const menu = document.createElement('div');
      menu.style.cssText = `
        position: fixed;
        top: 90px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 20px;
        z-index: 99999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        font-family: sans-serif;
        direction: rtl;
        min-width: 280px;
      `;
      
      menu.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 15px; color: #2c3e50; font-size: 16px;">בחר אתר לפתיחה:</div>
        <button onclick="window.openInternalBrowser('car-part.co.il'); this.parentElement.remove();" style="width: 100%; padding: 12px; margin-bottom: 8px; border: none; background: #28a745; color: white; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 500;">
          🔧 Car Part - חלקי רכב
        </button>
        <button onclick="window.openInternalBrowser('portal.levi-itzhak.co.il'); this.parentElement.remove();" style="width: 100%; padding: 12px; margin-bottom: 8px; border: none; background: #007bff; color: white; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 500;">
          📊 פורטל לוי יצחק
        </button>
        <button onclick="this.parentElement.remove();" style="width: 100%; padding: 10px; border: 1px solid #ccc; background: white; color: #666; border-radius: 6px; cursor: pointer; font-size: 14px;">
          ביטול
        </button>
      `;
      
      document.body.appendChild(menu);
      
      // Remove menu when clicking outside
      setTimeout(() => {
        document.addEventListener('click', function removeMenu(e) {
          if (!menu.contains(e.target)) {
            menu.remove();
            document.removeEventListener('click', removeMenu);
          }
        });
      }, 100);
    }

    // Enhanced authentication and data validation check
    document.addEventListener('DOMContentLoaded', () => {
      console.log('🔄 Estimate Builder: Initializing...');
      
      // Authentication check
      const auth = sessionStorage.getItem("auth");
      if (!auth) {
        console.error('❌ No authentication found');
        showAlert("הגישה חסומה - אנא התחבר דרך דף הבית", 'error');
        setTimeout(() => {
          window.location.href = "index.html";
        }, 2000);
        return;
      }

      // Comprehensive data validation
      const plateNumber = sessionStorage.getItem('plate');
      const helperData = sessionStorage.getItem('helper');
      const selectedReportType = sessionStorage.getItem('selectedReportType');
      
      console.log('📊 Estimate Builder validation:', {
        hasAuth: !!auth,
        hasPlate: !!plateNumber,
        hasHelper: !!helperData,
        hasReportType: !!selectedReportType,
        reportType: selectedReportType
      });
      
      // AUTO-FILL LOGIC: Allow both scenarios
      // 1. Coming from report selection with existing data -> auto-fill
      // 2. Coming from report selection without data -> start empty but allow manual entry
      // 3. Coming from estimate workflow -> normal validation but more flexible
      
      const isFromReportSelection = selectedReportType === 'estimate';
      
      console.log('🔍 Entry point analysis:', {
        isFromReportSelection,
        selectedReportType,
        hasPlate: !!plateNumber,
        hasHelper: !!helperData
      });
      
      // More flexible validation - only redirect if we're clearly in a bad state
      // Allow direct access or when coming from valid workflows
      
      // If coming from a different report type, redirect appropriately
      if (selectedReportType === 'final') {
        console.warn('⚠️ Redirecting to final report builder');
        showAlert('מעביר לבניית דו"ח סופי...', 'warning');
        setTimeout(() => {
          window.location.href = 'depreciation-module.html';
        }, 2000);
        return;
      }
      
      // For all other cases (estimate, no type, or direct access), allow through
      console.log('✅ Allowing access to estimate builder');
      
      // Handle different entry points
      let helper = null;
      
      if (helperData) {
        // Try to parse existing helper data
        try {
          helper = JSON.parse(helperData);
          if (!helper || typeof helper !== 'object') {
            throw new Error('Invalid helper data structure');
          }
          console.log('✅ Helper data loaded successfully');
          showAlert('בונה אומדן - נתונים קיימים נטענו בהצלחה', 'success');
        } catch (error) {
          console.error('⚠️ Invalid helper data, starting empty:', error);
          helper = null;
          showAlert('נתונים קיימים פגומים - מתחיל ריק', 'warning');
        }
      }
      
      if (!helper) {
        // No data or invalid data - start empty
        console.log('📝 Starting with empty builder');
        showAlert('בונה אומדן - מתחיל ביצירת אומדן חדש', 'info');
        // Initialize empty helper structure
        helper = {
          meta: { plate: plateNumber || '' },
          vehicle: {},
          client: {},
          damage_sections: [],
          calculations: {}
        };
      }
      
      console.log('✅ Estimate Builder: Initialization complete');

      // Check for post-session mode
      const urlParams = new URLSearchParams(window.location.search);
      const isPostSession = urlParams.get('mode') === 'post-session';
      
      if (isPostSession) {
        initializePostSessionMode();
      } else {
        initializeSessionMode();
      }

      // Set up auto-save on unload
      window.addEventListener('beforeunload', (e) => {
        if (window.estimateGenerator && typeof window.estimateGenerator.export === 'function') {
          // Auto-save for post-session mode
        }
      });
    });

    function initializePostSessionMode() {
      // Check if case is loaded
      const caseLoaded = sessionStorage.getItem('caseLoaded');
      if (!caseLoaded) {
        showAlert('אנא טען תיק קיים תחילה מדף הבחירה', 'error');
        setTimeout(() => {
          window.location.href = 'selection.html';
        }, 2000);
        return;
      }

      // Load vehicle info
      loadVehicleInfo();
      
      // Load damage centers for validation
      loadDamageCentersValidation();
      
      // Set up estimate type handlers
      setupEstimateTypeHandlers();
      
      // Set up car details handlers for legal text updates
      setupCarDetailsHandlers();
      
      // Load data from helper
      loadDataFromHelper();
      
      // Load initial legal text
      loadEstimateLegalText();
      
      // Action buttons now use direct onclick handlers (depreciation module style)
      
      // Calculate initial totals
      calculateEstimateTotals();
      
      // Handle anchor navigation from validation page
      handleAnchorNavigation();
    }

    // ANCHOR NAVIGATION HANDLER
    function handleAnchorNavigation() {
      const hash = window.location.hash;
      if (hash) {
        console.log('🔗 Navigating to anchor:', hash);
        
        setTimeout(() => {
          const targetElement = document.querySelector(hash);
          if (targetElement) {
            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Highlight the section temporarily
            targetElement.style.background = '#fff3cd';
            targetElement.style.border = '2px solid #ffc107';
            targetElement.style.borderRadius = '8px';
            
            setTimeout(() => {
              targetElement.style.background = '';
              targetElement.style.border = '';
              targetElement.style.borderRadius = '';
            }, 3000);
            
            // If it's a collapsible section, expand it
            const collapsibleContent = targetElement.querySelector('[style*="display:none"]');
            if (collapsibleContent) {
              collapsibleContent.style.display = 'block';
            }
          }
        }, 500);
      }
    }

    function initializeSessionMode() {
      // Load existing session data for estimate building
      console.log('🔄 Initializing session mode for estimate building');
      
      // Load helper data and populate fields
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      if (helper && helper.meta && helper.meta.plate) {
        console.log('📋 Loading existing case data for plate:', helper.meta.plate);
        loadVehicleInfo();
        loadDamageCentersValidation();
        setupEstimateTypeHandlers();
        setupPostSessionActions();
        calculateEstimateTotals();
      }
    }

    function loadVehicleInfo() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Check if data was prepared by report selection page
      let carDetails = helper.car_details || {};
      let generalInfo = helper.general_info || {};
      let meta = helper.meta || {};
      
      const buildersReady = sessionStorage.getItem('buildersPopulated');
      if (buildersReady) {
        console.log('🔧 Loading car details from report selection page...');
        
        // Load car details from report selection page
        const carDetailsData = sessionStorage.getItem('builderData_carDetails');
        if (carDetailsData) {
          try {
            const builderCarDetails = JSON.parse(carDetailsData);
            carDetails = { ...carDetails, ...builderCarDetails };
            console.log('✅ Car details loaded from report selection:', builderCarDetails);
          } catch (e) {
            console.error('Error parsing car details:', e);
          }
        }
        
        // Load general info from report selection page
        const generalInfoData = sessionStorage.getItem('builderData_generalInfo');
        if (generalInfoData) {
          try {
            const builderGeneralInfo = JSON.parse(generalInfoData);
            generalInfo = { ...generalInfo, ...builderGeneralInfo };
            console.log('✅ General info loaded from report selection:', builderGeneralInfo);
          } catch (e) {
            console.error('Error parsing general info:', e);
          }
        }
        
        // Load meta info from report selection page
        const metaData = sessionStorage.getItem('builderData_meta');
        if (metaData) {
          try {
            const builderMeta = JSON.parse(metaData);
            meta = { ...meta, ...builderMeta };
            console.log('✅ Meta info loaded from report selection:', builderMeta);
          } catch (e) {
            console.error('Error parsing meta info:', e);
          }
        }
      }
      
      const vehicleInfo = document.getElementById('vehicle-info');
      
      vehicleInfo.innerHTML = `
        <div class="section">
          <h3>פרטי רכב</h3>
          <div class="row">
            <div class="field">
              <label>מספר רכב:</label>
              <input type="text" value="${generalInfo.plate_number || meta.plate || carDetails.plate || ''}" readonly>
            </div>
            <div class="field">
              <label>יצרן:</label>
              <input type="text" value="${carDetails.manufacturer || ''}" readonly>
            </div>
            <div class="field">
              <label>דגם:</label>
              <input type="text" value="${carDetails.model || ''}" readonly>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>שנת יצור:</label>
              <input type="text" value="${carDetails.year || ''}" readonly>
            </div>
            <div class="field">
              <label>תאריך בדיקה:</label>
              <input type="text" value="${meta.inspection_date || carDetails.report_date || ''}" readonly>
            </div>
          </div>
        </div>
      `;
    }

    function loadDamageCentersValidation() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      const damageList = document.getElementById('damage-validation-list');
      
      if (!helper.damage_sections || helper.damage_sections.length === 0) {
        damageList.innerHTML = '<p>לא נמצאו מוקדי נזק באקספרטיזה</p>';
        return;
      }

      damageList.innerHTML = helper.damage_sections.map((center, index) => `
        <div class="damage-override" data-index="${index}">
          <div class="damage-override-header">
            <h4>מוקד נזק ${index + 1}: ${center.zone || 'לא מוגדר'}</h4>
            <button type="button" class="override-toggle" onclick="toggleDamageOverride(${index})">
              ערוך נתונים
            </button>
          </div>
          <div class="row">
            <div class="field">
              <label>אזור נזק:</label>
              <input type="text" id="zone-${index}" value="${center.zone || ''}" readonly>
            </div>
            <div class="field">
              <label>תיאור כללי:</label>
              <input type="text" id="desc-${index}" value="${center.zone_description || ''}" readonly>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>מספר חלקים:</label>
              <input type="text" value="${center.parts?.length || 0}" readonly>
            </div>
            <div class="field">
              <label>מספר תיקונים:</label>
              <input type="text" value="${center.repairs?.length || 0}" readonly>
            </div>
          </div>
        </div>
      `).join('');
    }

    function toggleDamageOverride(index) {
      const zoneInput = document.getElementById(`zone-${index}`);
      const descInput = document.getElementById(`desc-${index}`);
      const button = event.target;
      
      if (zoneInput.readOnly) {
        zoneInput.readOnly = false;
        descInput.readOnly = false;
        button.textContent = 'שמור שינויים';
        button.style.background = '#28a745';
      } else {
        zoneInput.readOnly = true;
        descInput.readOnly = true;
        button.textContent = 'ערוך נתונים';
        button.style.background = '#ffc107';
        
        // Update helper data
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        if (helper.damage_sections && helper.damage_sections[index]) {
          helper.damage_sections[index].zone = zoneInput.value;
          helper.damage_sections[index].zone_description = descInput.value;
          sessionStorage.setItem('helper', JSON.stringify(helper));
        }
        
        showAlert('שינויים נשמרו בהצלחה');
      }
    }

    function setupEstimateTypeHandlers() {
      const typeInputs = document.querySelectorAll('input[name="estimate-type"]');
      typeInputs.forEach(input => {
        input.addEventListener('change', updateLegalTextPreview);
      });
      
      // Load initial preview
      updateLegalTextPreview();
    }

    async function updateLegalTextPreview() {
      const selectedType = document.querySelector('input[name="estimate-type"]:checked').value;
      const legalTextDiv = document.getElementById('legal-text');
      
      try {
        // Load legal text from vault
        const vault = window.vaultTexts || {};
        const estimateKey = `estimate_${selectedType}`;
        const text = vault[estimateKey]?.text || 'טקסט משפטי לא נמצא';
        
        legalTextDiv.textContent = text.substring(0, 200) + '...';
      } catch (error) {
        legalTextDiv.textContent = 'שגיאה בטעינת הטקסט המשפטי';
      }
    }

    function calculateEstimateTotals() {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      const baseDamage = helper.expertise?.calculations?.base_damage || 0;
      
      // Import MathEngine to get VAT rate from admin hub settings
      import('./math.js').then(({ MathEngine }) => {
        const vatRate = MathEngine.getVatRate(); // Get VAT from math.js (controlled by admin hub)
        const vat = Math.round(baseDamage * vatRate / 100);
        const total = baseDamage + vat;
        
        document.getElementById('base-damage-total').textContent = `₪${baseDamage.toLocaleString()}`;
        document.getElementById('vat-rate').textContent = vatRate;
        document.getElementById('vat-amount').textContent = `₪${vat.toLocaleString()}`;
        document.getElementById('total-claim').textContent = `₪${total.toLocaleString()}`;
      }).catch(() => {
        // Fallback to default 18% if math.js not available
        const vatRate = 18;
        const vat = Math.round(baseDamage * vatRate / 100);
        const total = baseDamage + vat;
        
        document.getElementById('base-damage-total').textContent = `₪${baseDamage.toLocaleString()}`;
        document.getElementById('vat-rate').textContent = vatRate;
        document.getElementById('vat-amount').textContent = `₪${vat.toLocaleString()}`;
        document.getElementById('total-claim').textContent = `₪${total.toLocaleString()}`;
      });
    }

    // GLOBAL BUTTON FUNCTIONS - WITH COMPREHENSIVE DEBUGGING
    window.saveEstimate = function() {
      try {
        console.log('💾 Save estimate button clicked');
        alert('DEBUG: Save estimate button was clicked!');
        
        const selectedTypeElement = document.querySelector('input[name="estimate-type"]:checked');
        console.log('Selected type element:', selectedTypeElement);
        
        if (!selectedTypeElement) {
          alert('ERROR: אנא בחר סוג אומדן');
          showAlert('אנא בחר סוג אומדן', 'error');
          return;
        }
        
        const selectedType = selectedTypeElement.value;
        const additionalNotes = document.getElementById('additional-notes')?.value || '';
        
        console.log('Estimate data:', { selectedType, additionalNotes });
        
        // Update helper with estimate type and additional data
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        helper.estimate_type = selectedType;
        helper.estimate_notes = additionalNotes;
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        if (window.estimateGenerator) {
          window.estimateGenerator.setType(selectedType);
          if (additionalNotes) {
            window.estimateGenerator.addNotes(additionalNotes);
          }
        }
        
        // Save data to helper
        saveDataToHelper();
        
        alert('SUCCESS: אומדן נשמר בהצלחה');
        showAlert('אומדן נשמר בהצלחה', 'success');
        
      } catch (error) {
        console.error('❌ Error in saveEstimate:', error);
        alert('ERROR: שגיאה בשמירת האומדן - ' + error.message);
      }
    };

    window.previewEstimate = function() {
      try {
        console.log('👁️ Preview estimate button clicked');
        alert('DEBUG: Preview estimate button was clicked!');
        
        const selectedTypeElement = document.querySelector('input[name="estimate-type"]:checked');
        console.log('Selected type element:', selectedTypeElement);
        
        if (!selectedTypeElement) {
          alert('ERROR: אנא בחר סוג אומדן');
          showAlert('אנא בחר סוג אומדן', 'error');
          return;
        }
        
        const selectedType = selectedTypeElement.value;
        console.log('Selected type:', selectedType);
        
        // Save current data to helper
        saveDataToHelper();
        
        // Update helper with current estimate type
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        helper.estimate_type = selectedType;
        sessionStorage.setItem('helper', JSON.stringify(helper));
        sessionStorage.setItem('selectedReportType', 'estimate');
        
        alert('SUCCESS: מעביר לתצוגה מקדימה...');
        
        // Proceed to validation
        window.location.href = 'estimate-validation.html';
        
      } catch (error) {
        console.error('❌ Error in previewEstimate:', error);
        alert('ERROR: שגיאה בתצוגה מקדימה - ' + error.message);
      }
    };

    window.generateEstimate = function() {
      try {
        console.log('📄 Generate estimate button clicked');
        alert('DEBUG: Generate estimate button was clicked!');
        
        const selectedTypeElement = document.querySelector('input[name="estimate-type"]:checked');
        console.log('Selected type element:', selectedTypeElement);
        
        if (!selectedTypeElement) {
          alert('ERROR: אנא בחר סוג אומדן');
          showAlert('אנא בחר סוג אומדן', 'error');
          return;
        }
        
        const selectedType = selectedTypeElement.value;
        const additionalNotes = document.getElementById('additional-notes')?.value || '';
        
        console.log('Generate data:', { selectedType, additionalNotes });
        
        // Save current data to helper
        saveDataToHelper();
        
        // Update helper with all estimate data
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        helper.estimate_type = selectedType;
        helper.estimate_notes = additionalNotes;
        sessionStorage.setItem('helper', JSON.stringify(helper));
        sessionStorage.setItem('selectedReportType', 'estimate');
        
        alert('SUCCESS: מעביר ליצירת דו"ח...');
        
        // Proceed to validation
        window.location.href = 'estimate-validation.html';
        
      } catch (error) {
        console.error('❌ Error in generateEstimate:', error);
        alert('ERROR: שגיאה ביצירת האומדן - ' + error.message);
      }
    };

    // Depreciation functions for enhanced estimate builder
    function addDepField() {
      const table = document.getElementById('depreciationBulkTable');
      const index = table.children.length;
      
      const row = document.createElement('div');
      row.style.cssText = 'display:grid; grid-template-columns:1fr 1fr 120px 120px 80px; gap:14px; margin-bottom:10px;';
      row.innerHTML = `
        <input type="text" placeholder="החלק הניזוק" id="depPart${index}" />
        <input type="text" placeholder="מהות התיקון" id="depRepair${index}" />
        <input type="number" placeholder="%" id="depPercent${index}" onchange="calculateDepValue(${index})" />
        <input type="number" placeholder="₪" id="depValue${index}" readonly style="background:#f4f6fa;" />
        <button type="button" onclick="removeDepField(${index})" style="background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;">הסר</button>
      `;
      table.appendChild(row);
    }

    function removeDepField(index) {
      const table = document.getElementById('depreciationBulkTable');
      if (table.children[index]) {
        table.children[index].remove();
      }
    }

    function calculateDepValue(index) {
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      const marketValue = helper.calculations?.market_value || 0;
      const percentInput = document.getElementById(`depPercent${index}`);
      const valueInput = document.getElementById(`depValue${index}`);
      
      if (percentInput && valueInput && marketValue > 0) {
        const percent = parseFloat(percentInput.value) || 0;
        const value = Math.round(marketValue * percent / 100);
        valueInput.value = value;
      }
    }

    // COLLAPSIBLE SECTION TOGGLE - COPIED FROM DEPRECIATION MODULE
    window.toggleSection = function(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        section.style.display = section.style.display === 'none' ? 'block' : 'none';
      }
    };

    // ADD CUSTOM SUMMARY FIELD - COPIED FROM DEPRECIATION MODULE
    window.addCustomSummaryField = function(summaryType) {
      const grid = document.getElementById(`sumAdditionsGrid${summaryType.replace('summary', '')}`);
      if (!grid) return;
      
      const index = grid.children.length;
      const fieldDiv = document.createElement('div');
      fieldDiv.style.cssText = 'grid-column: 1 / -1; display: grid; grid-template-columns: 2fr 1fr 80px; gap: 8px; margin-bottom: 8px;';
      
      fieldDiv.innerHTML = `
        <input type="text" placeholder="תיאור התוספת/הורדה" id="addDesc${summaryType}${index}" />
        <input type="number" placeholder="סכום" id="addAmount${summaryType}${index}" />
        <button type="button" onclick="this.parentElement.remove()" style="background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;">הסר</button>
      `;
      
      grid.appendChild(fieldDiv);
    };

    // LEGAL TEXT MANAGEMENT - WITH PLACEHOLDER REPLACEMENT
    function loadEstimateLegalText() {
      try {
        const selectedType = document.querySelector('input[name="estimate-type"]:checked')?.value || 'אובדן_להלכה';
        
        // Load legal text template from vault-loader
        import('./vault-loader.js').then(({ loadLegalText }) => {
          const legalTextKey = selectedType === 'אובדן_להלכה' ? 'estimate_loss' : 'estimate_total';
          const legalText = loadLegalText(legalTextKey) || 'הטקסט המשפטי לא זמין';
          
          // Replace placeholders with actual data
          updateLegalTextWithData(legalText);
          
        }).catch(error => {
          console.error('Error loading legal text:', error);
          document.getElementById('legal-text').textContent = 'שגיאה בטעינת הטקסט המשפטי';
        });
      } catch (error) {
        console.error('Error in loadEstimateLegalText:', error);
        document.getElementById('legal-text').textContent = 'שגיאה בטעינת הטקסט המשפטי';
      }
    }

    function updateLegalTextWithData(template) {
      try {
        // Get current form data
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        const carPlate = document.getElementById('carPlate')?.value || helper.meta?.plate || '[מספר רכב]';
        const carManufacturer = document.getElementById('carManufacturer')?.value || helper.car_details?.manufacturer || '[תוצרת]';
        const carModel = document.getElementById('carModel')?.value || helper.car_details?.model || '[דגם]';
        const carYear = document.getElementById('carYear')?.value || helper.car_details?.year || '[שנה]';
        const ownerName = document.getElementById('ownerName')?.textContent || helper.client?.name || '[שם בעל הרכב]';
        
        // Replace placeholders in template
        let updatedText = template
          .replace(/\{\{plate\}\}/g, carPlate)
          .replace(/\{\{manufacturer\}\}/g, carManufacturer)
          .replace(/\{\{model\}\}/g, carModel)
          .replace(/\{\{year\}\}/g, carYear)
          .replace(/\{\{owner_name\}\}/g, ownerName)
          .replace(/\{\{date\}\}/g, new Date().toLocaleDateString('he-IL'));
        
        // Update the legal text display
        document.getElementById('legal-text').textContent = updatedText;
        
      } catch (error) {
        console.error('Error updating legal text:', error);
        document.getElementById('legal-text').textContent = 'שגיאה בעדכון הטקסט המשפטי';
      }
    }

    // Update legal text when estimate type changes
    function setupEstimateTypeHandlers() {
      const estimateTypeRadios = document.querySelectorAll('input[name="estimate-type"]');
      estimateTypeRadios.forEach(radio => {
        radio.addEventListener('change', () => {
          loadEstimateLegalText();
        });
      });
    }

    // Update legal text when car details change
    function setupCarDetailsHandlers() {
      const carFields = ['carPlate', 'carManufacturer', 'carModel', 'carYear'];
      carFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('input', () => {
            // Debounce the update
            clearTimeout(window.legalTextUpdateTimeout);
            window.legalTextUpdateTimeout = setTimeout(() => {
              loadEstimateLegalText();
            }, 500);
          });
        }
      });
    }

    // DATA LOADING FUNCTIONS
    function loadDataFromHelper() {
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        // Load car details
        if (helper.car_details) {
          const carFields = {
            'carPlate': helper.meta?.plate || helper.car_details.plate,
            'carManufacturer': helper.car_details.manufacturer,
            'carModel': helper.car_details.model,
            'carYear': helper.car_details.year,
            'carBasePrice': helper.car_details.base_price,
            'carReportDate': helper.car_details.report_date
          };
          
          Object.entries(carFields).forEach(([fieldId, value]) => {
            const field = document.getElementById(fieldId);
            if (field && value) {
              field.value = value;
            }
          });
        }
        
        // Load claims data in readonly sections
        if (helper.expertise?.calculations) {
          const calculations = helper.expertise.calculations;
          const readonlyFields = {
            'totalClaim': calculations.total_damage || 0,
            'leviPriceList': helper.levi_report?.final_price || 0,
            'grossPercent': calculations.damage_percent || 0,
            'authorizedClaim': calculations.total_damage || 0,
            'finalMarketValue': calculations.market_value || 0
          };
          
          Object.entries(readonlyFields).forEach(([fieldId, value]) => {
            const field = document.getElementById(fieldId);
            if (field) {
              field.textContent = typeof value === 'number' ? `₪${value.toLocaleString()}` : value;
            }
          });
        }
        
        // Load contact data
        if (helper.client) {
          const contactFields = {
            'ownerName': helper.client.name,
            'ownerAddress': helper.client.address,
            'ownerPhone': helper.client.phone,
            'insuranceCompany': helper.client.insurance_company,
            'insuranceEmail': helper.client.insurance_email,
            'insuranceAgent': helper.client.insurance_agent,
            'agentPhone': helper.client.agent_phone,
            'agentEmail': helper.client.agent_email
          };
          
          Object.entries(contactFields).forEach(([fieldId, value]) => {
            const field = document.getElementById(fieldId);
            if (field && value) {
              field.textContent = value;
            }
          });
        }
        
        console.log('✅ Data loaded from helper successfully');
        
      } catch (error) {
        console.error('❌ Error loading data from helper:', error);
      }
    }

    function saveDataToHelper() {
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        // Save car details
        helper.car_details = helper.car_details || {};
        helper.car_details.manufacturer = document.getElementById('carManufacturer')?.value || '';
        helper.car_details.model = document.getElementById('carModel')?.value || '';
        helper.car_details.year = document.getElementById('carYear')?.value || '';
        helper.car_details.base_price = document.getElementById('carBasePrice')?.value || '';
        helper.car_details.report_date = document.getElementById('carReportDate')?.value || '';
        
        // Update plate in meta
        helper.meta = helper.meta || {};
        helper.meta.plate = document.getElementById('carPlate')?.value || '';
        
        // Save estimate specific data
        helper.estimate_data = helper.estimate_data || {};
        helper.estimate_data.market_value = document.getElementById('sumMarketValueEstimate')?.value || '';
        helper.estimate_data.total_claim = document.getElementById('sumTotalClaimEstimate')?.value || '';
        helper.estimate_data.compensation = document.getElementById('compensationEstimate')?.value || '';
        
        sessionStorage.setItem('helper', JSON.stringify(helper));
        console.log('✅ Data saved to helper successfully');
        
      } catch (error) {
        console.error('❌ Error saving data to helper:', error);
      }
    }

    // Make functions global
    window.toggleDamageOverride = toggleDamageOverride;
    window.addDepField = addDepField;
    window.removeDepField = removeDepField;
    window.calculateDepValue = calculateDepValue;
    window.loadEstimateLegalText = loadEstimateLegalText;
    window.loadDataFromHelper = loadDataFromHelper;
    window.saveDataToHelper = saveDataToHelper;

    // Enhanced form validation
    document.addEventListener('input', (e) => {
      if (e.target.matches('input[type="number"]')) {
        const value = parseFloat(e.target.value);
        if (value < 0) {
          e.target.value = 0;
          showAlert('הערך לא יכול להיות שלילי', 'error');
        }
      }
    });

    // Add keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        switch (e.key) {
          case 's':
            e.preventDefault();
            if (window.saveEstimate) window.saveEstimate();
            break;
          case 'p':
            e.preventDefault();
            if (window.previewEstimate) window.previewEstimate();
            break;
        }
      }
    });
  </script>

  <!-- Floating Screens Scripts - COPIED FROM DEPRECIATION MODULE -->
  <script src="internal-browser.js"></script>
  <script src="levi-floating.js"></script>
  <script src="car-details-floating.js"></script>
</body>
</html>