<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>חלקים נדרשים - ירון כיוף</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" type="image/webp">
  <style>
    body {
      font-family: sans-serif;
      background: #f3f6fb;
      margin: 0;
      padding: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      max-width: 700px;
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      width: 100%;
      text-align: center;
      position: relative;
      box-sizing: border-box;
      overflow-x: auto;
    }
    .logo img {
      width: 120px;
      margin-bottom: 15px;
    }
    .title { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
    .subtitle { font-size: 18px; color: #666; margin-bottom: 5px; }
    .legal-note {
      color: red;
      font-weight: bold;
      margin-bottom: 15px;
    }
    h2 {
      font-size: 20px;
      color: #007bff;
      margin-bottom: 20px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .top-bar button {
      width: 48%;
      background-color: #6c757d;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
    }
    .logout-btn {
      background-color: #dc3545 !important;
    }
    .footer {
      margin-top: 30px;
      font-size: 12px;
      color: #aaa;
    }
    * {
  box-sizing: border-box;
}

form button {
  width: 48%;
  margin: 5px 1%;
}

.row {
  display: flex;
  flex-wrap: nowrap;
  justify-content: space-between;
  gap: 10px;
}

    .row {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      align-items: stretch;
      position: relative;
      flex-wrap: wrap;
      box-sizing: border-box;
      width: 100%;
    }
    .row .input-wrap {
      flex: 2 1 160px;
      min-width: 120px;
      box-sizing: border-box;
    }
    .row input.name {
      Flex:non;
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 100%;
      min-width: 80px;
      box-sizing: border-box;
    }

.row input.desc {
  flex: 2 1 120px;
  min-width: 80px;
  width: 100%;
  box-sizing: border-box;
  padding: 10px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #ccc;
}
.row input.price {
  flex: 0 0 70px;
  width: 70px;
  min-width: 50px;
  max-width: 90px;
  box-sizing: border-box;
  padding: 10px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #ccc;
  text-align: left;
}

.row select.source {
  flex: 1 1 100px;
  min-width: 80px;
  width: 100%;
  box-sizing: border-box;
  padding: 10px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.row .suggestions {
  position: absolute;
  top: 100%;
  right: 0;
  left: 0;
  background: white;
  border: 1px solid #ccc;
  border-radius: 8px;
  text-align: right;
  z-index: 1000;
  max-height: 200px;
  overflow-y: auto;
}


    .suggestions div {
      padding: 8px 12px;
      cursor: pointer;
    }

    .suggestions div:hover {
      background-color: #f0f0f0;
    }
    .button-row {
  display: flex;
  justify-content: space-between;
  gap: 10px;
    }


    button {
      width: 50%;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      color: white;
      background-color: #007bff;
      margin-top: 15px;
      cursor: pointer;
    }

    .btn-secondary {
      background-color: #6c757d;
    }
   .suggestions {
  position: absolute;
  background: white;
  border: 1px solid #ccc;
  z-index: 1000;
  max-height: 200px;
  overflow-y: auto;
  right: 0;
  left: 0;
  top: 100%;
}
.button-vehiclePopup {
    display: flex;
    gap: 10px;
    width: 100%;
    margin-top: 10px;
    margin-bottom: 10px;
}

.suggestions div {
  padding: 10px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
}

.suggestions div:hover {
  background: #f2f2f2;
}
#vehiclePopup {
      background: #f1f1f1;
      padding: 10px;
      border-radius: 10px;
      margin: 10px 0;
      display: none;
      font-size: 14px;
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/04/logo-yaron.webp" alt="Logo">
    </div>
    <div class="title">ירון כיוף שמאות - פורטל</div>
    <div class="subtitle">שמאי רכב והערכת נזקי רכוש</div>
    <div class="legal-note">מפרט תיקון - הערכת נזק (מבלי לפגוע בזכויות)</div>
    <h2 id="pageTitle">רכב מס. ...: חלקים נדרשים</h2>

    
  <button onclick="toggleVehicle()">פרטי הרכב</button>
       <div id="vehiclePopup"></div>

    <div class="top-bar">
    
      <button onclick="window.location.href='selection.html'">עמוד הבית</button>
      <button class="logout-btn" onclick="logout()">התנתק</button>
    </div>
      
    <form id="partsForm">
      <div id="carDetailsBox" style="display:none;">
        <input id="inputPlate" placeholder="מספר רכב" type="text" />
        <input id="inputManufacturer" placeholder="יצרן" type="text" />
        <input id="inputModel" placeholder="דגם" type="text" />
        <input id="inputYear" placeholder="שנה" type="number" />
      </div>
      <div id="partsList">
        <div class="row">
          <div class="input-wrap">
            <input type="text" class="name" placeholder="שם החלק" required oninput="suggestPart(this)">
            <select class="suggest-dropdown" style="display:none;"></select>
          </div>
          <input type="text" class="desc" placeholder="תיאור" required oninput="suggestPart(this)">
          <input type="text" class="price" placeholder="מחיר" required>
          <select class="source" required>
            <option value="">מקור</option>
            <option value="חליפי/מקורי">חליפי/מקורי</option>
            <option value="חליפי/משומש">חליפי/משומש</option>
            <option value="חדש מקורי">חדש מקורי</option>
            <option value="חליפי">חליפי</option>
            <option value="משומש">משומש</option>
            <option value="ריק">ריק</option>
          </select>
        </div>
      </div>

    <div class="button-row">
  <button type="button" class="btn-secondary" onclick="addPart()">הוסף חלק</button>
  <button type="submit">המשך</button>
</div>

    </form>

    <div class="footer">All rights reserved © Carmel Cayouf</div>
  </div>

  <script>
    // Authentication check
    const auth = sessionStorage.getItem("auth");
    if (!auth) {
      alert("הגישה חסומה - אנא התחבר דרך דף הבית");
      window.location.href = "index.html";
    }

    // Get data from helper instead of legacy storage
    let globalHelper = {};
    try { globalHelper = JSON.parse(sessionStorage.getItem("helper") || '{}'); } catch(e){}
    const plate = globalHelper.meta?.plate || globalHelper.vehicle?.plate || '';
    const manufacturer = globalHelper.vehicle?.manufacturer || '';
    const model = globalHelper.vehicle?.model || '';
    const year = globalHelper.vehicle?.year || '';

    if (!plate || !manufacturer || !model || !year) {
      alert("שגיאה: חסר מידע קריטי.");
    }

    document.getElementById("pageTitle").innerText = `רכב מס. ${plate}: חלקים נדרשים`;

    function logout() {
      sessionStorage.clear();
      window.location.href = "index.html";
    }

  function addPart() {
  const row = document.createElement("div");
  row.className = "row";
  row.innerHTML = `
    <div class="input-wrap">
          <input type="text" class="name" placeholder="שם החלק" required oninput="suggestPart(this)">
          <select class="suggest-dropdown" style="display:none;"></select>
        </div>
        <input type="text" class="desc" placeholder="תיאור" required oninput="suggestPart(this)">
        <input type="text" class="price" placeholder="מחיר" required>
        <select class="source" required>
          <option value="">מקור</option>
          <option value="חליפי/מקורי">חליפי/מקורי</option>
          <option value="חליפי/משומש">חליפי/משומש</option>
          <option value="חדש מקורי">חדש מקורי</option>
          <option value="חליפי">חליפי</option>
          <option value="משומש">משומש</option>
          <option value="ריק">ריק</option>
        </select>
  `;
  document.getElementById("partsList").appendChild(row);
}


    document.getElementById("partsForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const allParts = [];

      document.querySelectorAll("#partsList .row").forEach(row => {
        const name = row.querySelector(".name").value.trim();
        const desc = row.querySelector(".desc").value.trim();
        const price = row.querySelector(".price").value.trim();
        const source = row.querySelector(".source").value;
        if (name && desc && source) {
          allParts.push({ part: name, desc, price, source });
        }
      });

      // Detect mode: wizard (default) or standalone (from nav)
    const urlParams = new URLSearchParams(window.location.search);
    const isStandalone = urlParams.get('standalone') === '1';

      // Enhanced part validation and processing
      const validParts = [];
      const invalidParts = [];
      
      allParts.forEach(part => {
        if (!part.part || !part.desc) {
          invalidParts.push({ part, error: 'שם החלק ותיאור הם שדות חובה' });
        } else if (part.price && isNaN(parseFloat(part.price))) {
          invalidParts.push({ part, error: 'מחיר חייב להיות מספר תקין' });
        } else {
          validParts.push({
            ...part,
            addedAt: new Date().toISOString(),
            fromWizard: !isStandalone
          });
        }
      });
      
      if (invalidParts.length > 0) {
        alert(`נמצאו ${invalidParts.length} חלקים לא תקינים:\n` + 
              invalidParts.map(item => `${item.part.part || 'לא מוגדר'}: ${item.error}`).join('\n'));
        return;
      }

      if (isStandalone) {
        // Standalone: save to helper only (no custom localStorage)
        try {
          // Use helper even in standalone mode
          if (typeof updateHelper === 'function') {
            updateHelper('parts_search', { results: validParts, last_updated: new Date().toISOString() }, 'parts_required_standalone');
          } else {
            let helper = {};
            try { helper = JSON.parse(sessionStorage.getItem("helper") || '{}'); } catch(e){}
            helper.parts_search = helper.parts_search || {};
            helper.parts_search.results = validParts;
            helper.parts_search.last_updated = new Date().toISOString();
            sessionStorage.setItem("helper", JSON.stringify(helper));
          }
          const partsData = {
            parts: validParts,
            vehicle: getCarDetails(),
            timestamp: new Date().toISOString(),
            mode: 'standalone'
          };
          existingParts.push(partsData);
          // REMOVED: No custom localStorage - helper handles all storage
          
          alert(`✅ נשמרו ${validParts.length} חלקים בהצלחה (מצב עצמאי)\n` + 
                validParts.map(p => `• ${p.part} - ${p.desc}`).join('\n'));
        } catch (e) {
          console.error('Error saving parts:', e);
          alert('שגיאה בשמירת החלקים');
        }
      } else {
        // ✅ UNIFIED HELPER INTEGRATION: Use proper helper functions
        import('./helper.js').then(helperModule => {
          // Save parts to damage center draft
          helperModule.updateHelper('damage_center_draft', { parts: validParts });
          
          // Also save to parts_search for future suggestions
          const existingResults = helperModule.helper.parts_search?.results || [];
          const allResults = [...existingResults, ...validParts];
          helperModule.updateHelper('parts_search', { 
            results: allResults,
            last_updated: new Date().toISOString(),
            source: 'parts_required_module'
          });
          
          // Broadcast update to other modules
          helperModule.broadcastHelperUpdate(['parts_search', 'damage_center_draft'], 'parts_required');
          
        }).catch(error => {
          console.error('Error importing helper module:', error);
          // Fallback to direct helper manipulation
          let helper = {};
          try { helper = JSON.parse(sessionStorage.getItem("helper") || '{}'); } catch(e){}
          helper.damage_center_draft = helper.damage_center_draft || {};
          helper.damage_center_draft.parts = validParts;
          helper.parts_search = helper.parts_search || { results: [] };
          helper.parts_search.results = [...(helper.parts_search.results || []), ...validParts];
          sessionStorage.setItem("helper", JSON.stringify(helper));
        });
        
        // REMOVED: No localStorage needed - helper system handles persistence
        
        window.location.href = "damage-center-repairs.html";
      }
    });

    // Detect mode: wizard (default) or standalone (from nav)
    const urlParams = new URLSearchParams(window.location.search);
    const isStandalone = urlParams.get('standalone') === '1';

    // Show car details input if standalone
    if (isStandalone) {
      document.getElementById('carDetailsBox').style.display = '';
      document.getElementById('pageTitle').innerText = "מודול חלקים - חיפוש עצמאי";
    } else {
      // ...existing code to set pageTitle from session...
    }

    function getCarDetails() {
      if (isStandalone) {
        return {
          plate: document.getElementById("inputPlate").value.trim(),
          manufacturer: document.getElementById("inputManufacturer").value.trim(),
          model: document.getElementById("inputModel").value.trim(),
          year: document.getElementById("inputYear").value.trim()
        };
      } else {
        // ✅ UNIFIED HELPER INTEGRATION: Use proper helper import
        try {
          const helperData = JSON.parse(sessionStorage.getItem("helper") || '{}');
          return {
            plate: helperData.meta?.plate || helperData.vehicle?.plate_number || helperData.car_details?.plate || "",
            manufacturer: helperData.vehicle?.manufacturer || helperData.car_details?.manufacturer || "",
            model: helperData.vehicle?.model || helperData.car_details?.model || "",
            year: helperData.vehicle?.year || helperData.car_details?.year || ""
          };
        } catch(e) {
          console.error('Error reading helper data:', e);
          // No fallback to legacy storage - return empty if helper fails
          return {
            plate: "",
            manufacturer: "",
            model: "",
            year: ""
          };
        }
      }
    }

    // --- Suggestion logic with dropdown ---
    function suggestPart(input) {
      const row = input.closest('.row');
      const nameInput = row.querySelector('.name');
      const descInput = row.querySelector('.desc');
      const priceInput = row.querySelector('.price');
      const sourceSelect = row.querySelector('.source');
      const dropdown = row.querySelector('.suggest-dropdown');

      // Use the value of the input that triggered the event
      const query = input.value.trim();
      const { plate, manufacturer, model, year } = getCarDetails();

      if (!query || query.length < 2) {
        dropdown.style.display = "none";
        return;
      }

      // Get suggestions from multiple sources
      const suggestions = [];
      
      // Search in parts search results from helper (primary source)
      if (window.helper && window.helper.parts_search && window.helper.parts_search.search_results) {
        window.helper.parts_search.search_results.forEach(part => {
          if (part.name && part.name.toLowerCase().includes(query.toLowerCase()) ||
              part.description && part.description.toLowerCase().includes(query.toLowerCase())) {
            suggestions.push({ 
              name: part.name || part.description, 
              desc: part.description || part.name, 
              source: part.condition || part.source || 'לא צוין',
              price: part.price || '',
              supplier: part.supplier || '',
              location: part.location || '',
              availability: part.availability || '',
              searchResult: true // Mark as from search results
            });
          }
        });
      }
      
      // Search in stored helper results
      // REMOVED: No localStorage fallback - helper only
      let storedHelper = {};
      try {
        storedHelper = JSON.parse(sessionStorage.getItem("helper") || '{}');
      } catch (e) {
        storedHelper = {};
      }
      const allResults = storedHelper?.parts_search?.results || [];
      
      allResults.forEach(result => {
        if ((result.name || '').toLowerCase().includes(query.toLowerCase()) ||
            (result.desc || '').toLowerCase().includes(query.toLowerCase())) {
          suggestions.push({
            name: result.name || result.desc,
            desc: result.desc || result.name,
            price: result.price,
            source: result.source
          });
        }
      });

      if (suggestions.length === 0) {
        dropdown.innerHTML = '';
        dropdown.style.display = "none";
        return;
      }

      // Remove duplicates and limit to 10 results
      const uniqueSuggestions = suggestions.filter((suggestion, index, self) => 
        index === self.findIndex(s => s.name === suggestion.name)
      ).slice(0, 10);

      dropdown.innerHTML = '<option value="">בחר הצעה...</option>' +
        uniqueSuggestions.map((s, i) => `
          <option value="${i}">${s.name}${s.category ? ` (${s.category})` : ''}${s.price ? ` - ₪${s.price}` : ''}</option>
        `).join('');
      dropdown.style.display = "";
      dropdown._suggestions = uniqueSuggestions;

      // Enhanced selection handling
      dropdown.onchange = function () {
        const idx = this.value;
        if (!this._suggestions || !this._suggestions[idx]) return;
        const suggestion = this._suggestions[idx];
        nameInput.value = suggestion.name || "";
        descInput.value = suggestion.desc || "";
        if (suggestion.price) priceInput.value = suggestion.price;
        if (suggestion.source) sourceSelect.value = suggestion.source;
        dropdown.style.display = "none";
        
        // Trigger change event for potential additional processing
        nameInput.dispatchEvent(new Event('change'));
      };
    }
    // ...existing code for addPart, etc...
  </script>
  <script type="module">
    // Try to load parts bank for better suggestions
    try {
      import('./parts.js').then(module => {
        window.PARTS_BANK = module.PARTS_BANK;
        console.log('Parts bank loaded for suggestions');
      }).catch(e => console.warn('Could not load parts bank'));
    } catch (e) {
      console.warn('Module import not supported');
    }
  </script>
  <script src="parts-floating.js"></script>
</body>
</html>
