<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>חלקים נדרשים - ירון כיוף</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href=" https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" type="image/webp">
  <style>
    body {
      font-family: sans-serif;
      background: #f3f6fb;
      margin: 0;
      padding: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
   .container {
      max-width: 600px;
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      width: 100%;
      text-align: center;
      position: relative;
    }
    .logo img {
      width: 120px;
      margin-bottom: 15px;
    }
    .title { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
    .subtitle { font-size: 18px; color: #666; margin-bottom: 5px; }
    .legal-note {
      color: red;
      font-weight: bold;
      margin-bottom: 15px;
    }
    h2 {
      font-size: 20px;
      color: #007bff;
      margin-bottom: 20px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .top-bar button {
      width: 48%;
      background-color: #6c757d;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
    }
    .logout-btn {
      background-color: #dc3545 !important;
    }
    .footer {
      margin-top: 30px;
      font-size: 12px;
      color: #aaa;
    }
    * {
  box-sizing: border-box;
}

form button {
  width: 48%;
  margin: 5px 1%;
}

.row {
  display: flex;
  flex-wrap: nowrap;
  justify-content: space-between;
  gap: 10px;
}

   .row {
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
  align-items: stretch;
  position: relative;
}

.row input.name {
  Flex:non;
  padding: 10px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.row input.desc {
  flex: auto ;
  padding: 10px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.row select.source {
  Flex:0;
  padding: 10px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.row .suggestions {
  position: absolute;
  top: 100%;
  right: 0;
  left: 0;
  background: white;
  border: 1px solid #ccc;
  border-radius: 8px;
  text-align: right;
  z-index: 1000;
  max-height: 200px;
  overflow-y: auto;
}


    .suggestions div {
      padding: 8px 12px;
      cursor: pointer;
    }

    .suggestions div:hover {
      background-color: #f0f0f0;
    }
    .button-row {
  display: flex;
  justify-content: space-between;
  gap: 10px;
    }


    button {add button
      width: 50%;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      color: white;
      background-color: #007bff;
      margin-top: 15px;
      cursor: pointer;
    }

    .btn-secondary {
      background-color: #6c757d;
    }
   .suggestions {
  position: absolute;
  background: white;
  border: 1px solid #ccc;
  z-index: 1000;
  max-height: 200px;
  overflow-y: auto;
  right: 0;
  left: 0;
  top: 100%;
}
.button-vehiclePopup {
    display: flex;
    gap: 10px;
    Width: 100%;
    margin-top: 20px;
    Align-right
    margin-top: 10px;
    margin-bottom: 10px;
  }

.suggestions div {
  padding: 10px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
}

.suggestions div:hover {
  background: #f2f2f2;
}
#vehiclePopup {
      background: #f1f1f1;
      padding: 10px;
      border-radius: 10px;
      margin: 10px 0;
      display: none;
      font-size: 14px;
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo">
    </div>
    <div class="title">ירון כיוף שמאות - פורטל</div>
    <div class="subtitle">שמאי רכב והערכת נזקי רכוש</div>
    <div class="legal-note">מפרט תיקון - הערכת נזק (מבלי לפגוע בזכויות)</div>
    <h2 id="pageTitle">רכב מס. ...: חלקים נדרשים</h2>

    
  <button onclick="toggleVehicle()">פרטי הרכב</button>
       <div id="vehiclePopup"></div>

    <div class="top-bar">
    
      <button onclick="window.location.href='selection.html'">עמוד הבית</button>
      <button class="logout-btn" onclick="logout()">התנתק</button>
    </div>
      
    <form id="partsForm">
      <div id="carDetailsBox" style="display:none;">
        <input id="inputPlate" placeholder="מספר רכב" type="text" />
        <input id="inputManufacturer" placeholder="יצרן" type="text" />
        <input id="inputModel" placeholder="דגם" type="text" />
        <input id="inputYear" placeholder="שנה" type="number" />
      </div>
      <div id="partsList">
        <div class="row">
          <div class="input-wrap">
            <input type="text" class="name" placeholder="שם החלק" required oninput="suggestPart(this)">
            <div class="suggestions"></div>
          </div>
          <input type="text" class="desc" placeholder="תיאור" required>
          <select class="source" required>
            <option value="">מקור</option>
            <option value="חליפי/מקורי">חליפי/מקורי</option>
            <option value="חליפי/משומש">חליפי/משומש</option>
            <option value="חדש מקורי">חדש מקורי</option>
            <option value="חליפי">חליפי</option>
            <option value="משומש">משומש</option>
            <option value="ריק">ריק</option>
          </select>
        </div>
      </div>

    <div class="button-row">
  <button type="button" class="btn-secondary" onclick="addPart()">הוסף חלק</button>
  <button type="submit">המשך</button>
</div>

    </form>

    <div class="footer">All rights reserved © Carmel Cayouf</div>
  </div>

  <script>
    const plate = sessionStorage.getItem("plate");
    const manufacturer = sessionStorage.getItem("manufacturer");
    const model = sessionStorage.getItem("model");
    const year = sessionStorage.getItem("year");

    if (!plate || !manufacturer || !model || !year) {
      alert("שגיאה: חסר מידע קריטי.");
    }

    document.getElementById("pageTitle").innerText = `רכב מס. ${plate}: חלקים נדרשים`;

    function logout() {
      sessionStorage.clear();
      window.location.href = "index.html";
    }

  function addPart() {
  const row = document.createElement("div");
  row.className = "row";
  row.innerHTML = `
    <input type="text" class="name" placeholder="שם החלק" required oninput="suggestPart(this)">
    <input type="text" class="desc" placeholder="תיאור" required>
    <select class="source" required>
      <option value="">מקור</option>
      <option value="חליפי/מקורי">חליפי/מקורי</option>
      <option value="חליפי/משומש">חליפי/משומש</option>
      <option value="חדש מקורי">חדש מקורי</option>
      <option value="חליפי">חליפי</option>
      <option value="משומש">משומש</option>
      <option value="ריק">ריק</option>
    </select>
    <div class="suggestions"></div>
  `;
  document.getElementById("partsList").appendChild(row);
}


    document.getElementById("partsForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const allParts = [];

      document.querySelectorAll("#partsList .row").forEach(row => {
        const name = row.querySelector(".name").value.trim();
        const desc = row.querySelector(".desc").value.trim();
        const source = row.querySelector(".source").value;
        if (name && desc && source) {
          allParts.push({ part: name, desc, source });
        }
      });

      // Detect mode: wizard (default) or standalone (from nav)
    const urlParams = new URLSearchParams(window.location.search);
    const isStandalone = urlParams.get('standalone') === '1';

    if (isStandalone) {
        // Standalone: just show results or allow export, do not save to helper
        alert("חלקים נאספו (מצב עצמאי):\n" + allParts.map(p => p.part).join(", "));
        // Optionally: display results below or allow export
      } else {
        // Wizard: save to helper.damage_center_draft.parts and go to next bulk
        let helper = {};
        try { helper = JSON.parse(sessionStorage.getItem("helper") || '{}'); } catch(e){}
        helper.damage_center_draft = helper.damage_center_draft || {};
        helper.damage_center_draft.parts = allParts;
        sessionStorage.setItem("helper", JSON.stringify(helper));
        window.location.href = "damage-center-repairs.html";
      }
    });

    // Detect mode: wizard (default) or standalone (from nav)
    const urlParams = new URLSearchParams(window.location.search);
    const isStandalone = urlParams.get('standalone') === '1';

    // Show car details input if standalone
    if (isStandalone) {
      document.getElementById('carDetailsBox').style.display = '';
      document.getElementById('pageTitle').innerText = "מודול חלקים - חיפוש עצמאי";
    } else {
      // ...existing code to set pageTitle from session...
    }

    function getCarDetails() {
      if (isStandalone) {
        return {
          plate: document.getElementById("inputPlate").value.trim(),
          manufacturer: document.getElementById("inputManufacturer").value.trim(),
          model: document.getElementById("inputModel").value.trim(),
          year: document.getElementById("inputYear").value.trim()
        };
      } else {
        let helper = {};
        try { helper = JSON.parse(sessionStorage.getItem("helper") || '{}'); } catch(e){}
        const car = helper.car_details || {};
        return {
          plate: car.plate || sessionStorage.getItem("plate") || "",
          manufacturer: car.manufacturer || sessionStorage.getItem("manufacturer") || "",
          model: car.model || sessionStorage.getItem("model") || "",
          year: car.year || sessionStorage.getItem("year") || ""
        };
      }
    }

    function suggestPart(input) {
      const query = input.value.trim();
      const { plate, manufacturer, model, year } = getCarDetails();
      if (query.length < 2) return;
      // Only text-based search (no image)
      sendPartSearch({ plate, manufacturer, model, year, query })
        .then(results => {
          const box = input.parentElement.querySelector('.suggestions');
          box.innerHTML = "";
          if (Array.isArray(results) && results.length) {
            results.forEach(suggestion => {
              const item = document.createElement("div");
              item.textContent = suggestion.name || suggestion;
              item.onclick = () => {
                input.value = suggestion.name || suggestion;
                const row = input.closest(".row");
                if (row && row.querySelector(".desc")) row.querySelector(".desc").value = suggestion.desc || "";
                if (row && row.querySelector(".source")) row.querySelector(".source").value = suggestion.source || "";
                box.innerHTML = "";
              };
              box.appendChild(item);
            });
          } else {
            box.innerHTML = "<div>לא נמצאו תוצאות</div>";
          }
        })
        .catch(() => {
          const box = input.parentElement.querySelector('.suggestions');
          box.innerHTML = "<div>שגיאה בחיפוש</div>";
        });
    }

    // Image search logic
const imageInput = document.getElementById('partImageInput');
const searchByImageBtn = document.getElementById('searchByImageBtn');
const imageStatus = document.getElementById('imageSearchStatus');
const imageSuggestions = document.getElementById('imageSuggestions');

searchByImageBtn.onclick = async function() {
  imageStatus.textContent = "";
  imageSuggestions.innerHTML = "";
  const file = imageInput.files && imageInput.files[0];
  if (!file) {
    imageStatus.textContent = "בחר תמונה תחילה";
    return;
  }
  const { plate, manufacturer, model, year } = getCarDetails();
  imageStatus.textContent = "מחפש חלקים לפי תמונה...";
  try {
    const results = await sendPartSearch({ plate, manufacturer, model, year, imageFile: file });
    imageStatus.textContent = "הצעות שהתקבלו:";
    if (Array.isArray(results) && results.length) {
      results.forEach(suggestion => {
        const item = document.createElement("div");
        item.textContent = suggestion.name || suggestion;
        item.onclick = () => {
          // Autofill first empty part row
          const row = document.querySelector("#partsList .row .name:placeholder-shown")?.closest('.row') ||
                      document.querySelector("#partsList .row");
          if (row) {
            row.querySelector(".name").value = suggestion.name || suggestion;
            if (row.querySelector(".desc")) row.querySelector(".desc").value = suggestion.desc || "";
            if (row.querySelector(".source")) row.querySelector(".source").value = suggestion.source || "";
          }
          imageSuggestions.innerHTML = "";
        };
        imageSuggestions.appendChild(item);
      });
    } else {
      imageSuggestions.innerHTML = "<div>לא נמצאו תוצאות</div>";
    }
  } catch (e) {
    imageStatus.textContent = "שגיאה בחיפוש לפי תמונה";
  }
};

// ...existing code...
  </script>
  <script src="car-details-float.js"></script>
</body>
</html>
