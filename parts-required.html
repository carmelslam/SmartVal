<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>×—×œ×§×™× × ×“×¨×©×™× - ×™×¨×•×Ÿ ×›×™×•×£</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" type="image/webp">
  <style>
    body {
      font-family: sans-serif;
      background: #f3f6fb;
      margin: 0;
      padding: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      max-width: 700px;
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      width: 100%;
      text-align: center;
      position: relative;
      box-sizing: border-box;
      overflow-x: auto;
    }
    .logo img {
      width: 120px;
      margin-bottom: 15px;
    }
    .title { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
    .subtitle { font-size: 18px; color: #666; margin-bottom: 5px; }
    .legal-note {
      color: red;
      font-weight: bold;
      margin-bottom: 15px;
    }
    h2 {
      font-size: 20px;
      color: #007bff;
      margin-bottom: 20px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .top-bar button {
      width: 48%;
      background-color: #6c757d;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
    }
    .logout-btn {
      background-color: #dc3545 !important;
    }
    .footer {
      margin-top: 30px;
      font-size: 12px;
      color: #aaa;
    }
    * {
  box-sizing: border-box;
}

form button {
  width: 48%;
  margin: 5px 1%;
}

.row {
  display: flex;
  flex-wrap: nowrap;
  justify-content: space-between;
  gap: 10px;
}

    .row {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      align-items: center;
      position: relative;
      flex-wrap: wrap;
      box-sizing: border-box;
      width: 100%;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #f8fafc;
    }
    .row .input-wrap {
      flex: 2 1 160px;
      min-width: 120px;
      box-sizing: border-box;
    }
    .row input.name {
      Flex:non;
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 100%;
      min-width: 80px;
      box-sizing: border-box;
    }

.row input.desc {
  flex: 2 1 120px;
  min-width: 80px;
  width: 100%;
  box-sizing: border-box;
  padding: 10px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #ccc;
}
.row input.quantity {
  flex: 0 0 60px;
  width: 60px;
  min-width: 50px;
  max-width: 70px;
  box-sizing: border-box;
  padding: 8px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #ccc;
  text-align: center;
}

.row input.price {
  flex: 0 0 80px;
  width: 80px;
  min-width: 60px;
  max-width: 100px;
  box-sizing: border-box;
  padding: 10px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #ccc;
  text-align: left;
}

.row select.source {
  flex: 1 1 100px;
  min-width: 80px;
  width: 100%;
  box-sizing: border-box;
  padding: 10px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.row .suggestions {
  position: absolute;
  top: 100%;
  right: 0;
  left: 0;
  background: white;
  border: 1px solid #ccc;
  border-radius: 8px;
  text-align: right;
  z-index: 1000;
  max-height: 200px;
  overflow-y: auto;
}


    .suggestions div {
      padding: 8px 12px;
      cursor: pointer;
    }

    .suggestions div:hover {
      background-color: #f0f0f0;
    }
    .button-row {
  display: flex;
  justify-content: space-between;
  gap: 10px;
    }


    button {
      width: 50%;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      color: white;
      background-color: #007bff;
      margin-top: 15px;
      cursor: pointer;
    }

    .btn-secondary {
      background-color: #6c757d;
    }
   .suggestions {
  position: absolute;
  background: white;
  border: 1px solid #ccc;
  z-index: 1000;
  max-height: 200px;
  overflow-y: auto;
  right: 0;
  left: 0;
  top: 100%;
}
.button-vehiclePopup {
    display: flex;
    gap: 10px;
    width: 100%;
    margin-top: 10px;
    margin-bottom: 10px;
}

.suggestions div {
  padding: 10px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
}

.suggestions div:hover {
  background: #f2f2f2;
}
#vehiclePopup {
      background: #f1f1f1;
      padding: 10px;
      border-radius: 10px;
      margin: 10px 0;
      display: none;
      font-size: 14px;
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/04/logo-yaron.webp" alt="Logo">
    </div>
    <div class="title">×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×¤×•×¨×˜×œ</div>
    <div class="subtitle">×©×××™ ×¨×›×‘ ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×•×©</div>
    <div class="legal-note">××¤×¨×˜ ×ª×™×§×•×Ÿ - ×”×¢×¨×›×ª × ×–×§ (××‘×œ×™ ×œ×¤×’×•×¢ ×‘×–×›×•×™×•×ª)</div>
    <h2 id="pageTitle">×¨×›×‘ ××¡. ...: ×—×œ×§×™× × ×“×¨×©×™×</h2>

    
  <button onclick="toggleVehicle()">×¤×¨×˜×™ ×”×¨×›×‘</button>
       <div id="vehiclePopup"></div>

    <!-- Removed navigation buttons when in wizard -->
      
    <form id="partsForm">
      <div id="carDetailsBox" style="display:none;">
        <input id="inputPlate" placeholder="××¡×¤×¨ ×¨×›×‘" type="text" />
        <input id="inputManufacturer" placeholder="×™×¦×¨×Ÿ" type="text" />
        <input id="inputModel" placeholder="×“×’×" type="text" />
        <input id="inputYear" placeholder="×©× ×”" type="number" />
      </div>
      <div id="partsList">
        <div class="row" data-row-index="0">
          <div class="input-wrap">
            <input type="text" class="name" placeholder="×©× ×”×—×œ×§" oninput="suggestPart(this)">
            <select class="suggest-dropdown" style="display:none;"></select>
          </div>
          <input type="text" class="desc" placeholder="×ª×™××•×¨" oninput="suggestPart(this)">
          <input type="number" class="quantity" placeholder="×›××•×ª" value="1" min="1" style="width: 60px; margin-left: 8px;">
          <input type="text" class="price" placeholder="××—×™×¨">
          <select class="source">
            <option value="">××§×•×¨</option>
            <option value="×—×œ×™×¤×™/××§×•×¨×™">×—×œ×™×¤×™/××§×•×¨×™</option>
            <option value="×—×œ×™×¤×™/××©×•××©">×—×œ×™×¤×™/××©×•××©</option>
            <option value="×—×“×© ××§×•×¨×™">×—×“×© ××§×•×¨×™</option>
            <option value="×—×œ×™×¤×™">×—×œ×™×¤×™</option>
            <option value="××©×•××©">××©×•××©</option>
            <option value="×¨×™×§">×¨×™×§</option>
          </select>
          <div class="row-actions" style="display: flex; gap: 5px; margin-right: 8px;">
            <button type="button" class="btn-edit" onclick="editPartRow(0)" title="×¢×¨×•×š ×—×œ×§" style="
              background: #f59e0b; color: white; border: none; padding: 6px 10px; 
              border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: bold;
            ">âœï¸</button>
            <button type="button" class="btn-delete" onclick="deletePartRow(0)" title="××—×§ ×—×œ×§" style="
              background: #dc3545; color: white; border: none; padding: 6px 10px; 
              border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: bold;
            ">ğŸ—‘ï¸</button>
          </div>
        </div>
      </div>

      <button type="button" class="btn-secondary" onclick="addPart()">×”×•×¡×£ ×—×œ×§</button>

    </form>

    <div class="footer">All rights reserved Â© Carmel Cayouf</div>
  </div>

  <script>
    // âœ… NEW: Listen for messages from damage centers wizard
    window.addEventListener('message', function(event) {
      console.log('ğŸ“¨ Parts required received message:', event.data);
      
      switch(event.data.type) {
        case 'damageCenterContext':
          handleWizardContext(event.data);
          break;
        case 'wizardReady':
          console.log('âœ… Wizard ready signal received');
          // Send ready confirmation back
          if (window.parent && window.parent.postMessage) {
            window.parent.postMessage({
              type: 'moduleReady',
              module: 'parts',
              source: 'parts_required_iframe'
            }, '*');
          }
          break;
      }
    });
    
    // âœ… NEW: Handle wizard context
    function handleWizardContext(contextData) {
      console.log('ğŸ¯ Parts required handling wizard context:', contextData);
      
      try {
        // Update global helper with wizard data
        if (contextData.helper) {
          window.helper = contextData.helper;
          globalHelper = contextData.helper;
        }
        
        // Store search results globally for suggestions
        if (contextData.searchResults && contextData.searchResults.length > 0) {
          window.wizardSearchResults = contextData.searchResults;
          console.log(`âœ… Received ${contextData.searchResults.length} search results from wizard`);
          
          // Update helper with search results if not already present
          if (!window.helper.parts_search) {
            window.helper.parts_search = {};
          }
          if (!window.helper.parts_search.current_session) {
            window.helper.parts_search.current_session = {};
          }
          if (!window.helper.parts_search.current_session.results) {
            window.helper.parts_search.current_session.results = contextData.searchResults;
          }
        }
        
        // Pre-fill with existing selected parts
        if (contextData.selectedParts && contextData.selectedParts.length > 0) {
          contextData.selectedParts.forEach(part => {
            addPartFromData(part);
          });
          console.log(`âœ… Pre-filled ${contextData.selectedParts.length} parts from wizard`);
        }
        
        // Show wizard mode indicator
        showWizardModeUI(contextData);
        
      } catch (error) {
        console.error('âŒ Failed to handle wizard context:', error);
      }
    }
    
    // âœ… NEW: Show wizard-specific UI
    function showWizardModeUI(contextData) {
      const container = document.querySelector('.container');
      if (container) {
        const wizardIndicator = document.createElement('div');
        wizardIndicator.style.cssText = `
          background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
          color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px;
          text-align: center; font-weight: bold;
        `;
        wizardIndicator.innerHTML = `ğŸ”§ ×‘×—×™×¨×ª ×—×œ×¤×™× - ××©×£ ××•×§×“×™ × ×–×§ (××•×§×“ ${contextData.damageCenter?.number || '×—×“×©'})`;
        
        container.insertBefore(wizardIndicator, container.firstChild);
      }
    }
    
    // Authentication check
    const auth = sessionStorage.getItem("auth");
    if (!auth) {
      alert("×”×’×™×©×” ×—×¡×•××” - ×× × ×”×ª×—×‘×¨ ×“×¨×š ×“×£ ×”×‘×™×ª");
      window.location.href = "index.html";
    }

    // Get data from helper instead of legacy storage
    let globalHelper = {};
    try { globalHelper = JSON.parse(sessionStorage.getItem("helper") || '{}'); } catch(e){}
    const plate = globalHelper.meta?.plate || globalHelper.vehicle?.plate || '';
    const manufacturer = globalHelper.vehicle?.manufacturer || '';
    const model = globalHelper.vehicle?.model || '';
    const year = globalHelper.vehicle?.year || '';

    if (!plate || !manufacturer || !model || !year) {
      alert("×©×’×™××”: ×—×¡×¨ ××™×“×¢ ×§×¨×™×˜×™.");
    }

    document.getElementById("pageTitle").innerText = `×¨×›×‘ ××¡. ${plate}: ×—×œ×§×™× × ×“×¨×©×™×`;

    function logout() {
      sessionStorage.clear();
      window.location.href = "index.html";
    }

  function addPart() {
  const partsList = document.getElementById("partsList");
  const newRowIndex = partsList.children.length;
  
  const row = document.createElement("div");
  row.className = "row";
  row.setAttribute("data-row-index", newRowIndex);
  row.innerHTML = `
    <div class="input-wrap">
          <input type="text" class="name" placeholder="×©× ×”×—×œ×§" oninput="suggestPart(this)">
          <select class="suggest-dropdown" style="display:none;"></select>
        </div>
        <input type="text" class="desc" placeholder="×ª×™××•×¨" oninput="suggestPart(this)">
        <input type="number" class="quantity" placeholder="×›××•×ª" value="1" min="1" style="width: 60px; margin-left: 8px;">
        <input type="text" class="price" placeholder="××—×™×¨">
        <select class="source">
          <option value="">××§×•×¨</option>
          <option value="×—×œ×™×¤×™/××§×•×¨×™">×—×œ×™×¤×™/××§×•×¨×™</option>
          <option value="×—×œ×™×¤×™/××©×•××©">×—×œ×™×¤×™/××©×•××©</option>
          <option value="×—×“×© ××§×•×¨×™">×—×“×© ××§×•×¨×™</option>
          <option value="×—×œ×™×¤×™">×—×œ×™×¤×™</option>
          <option value="××©×•××©">××©×•××©</option>
          <option value="×¨×™×§">×¨×™×§</option>
        </select>
        <div class="row-actions" style="display: flex; gap: 5px; margin-right: 8px;">
          <button type="button" class="btn-edit" onclick="editPartRow(${newRowIndex})" title="×¢×¨×•×š ×—×œ×§" style="
            background: #f59e0b; color: white; border: none; padding: 6px 10px; 
            border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: bold;
          ">âœï¸</button>
          <button type="button" class="btn-delete" onclick="deletePartRow(${newRowIndex})" title="××—×§ ×—×œ×§" style="
            background: #dc3545; color: white; border: none; padding: 6px 10px; 
            border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: bold;
          ">ğŸ—‘ï¸</button>
        </div>
  `;
  partsList.appendChild(row);
  
  console.log(`â• Added new part row ${newRowIndex}`);
}

// Save parts data to helper without navigation
function savePartsData() {
  const allParts = [];

  document.querySelectorAll("#partsList .row").forEach(row => {
    const name = row.querySelector(".name").value.trim();
    const desc = row.querySelector(".desc").value.trim();
    const quantity = parseInt(row.querySelector(".quantity")?.value) || 1;
    const price = row.querySelector(".price").value.trim();
    const source = row.querySelector(".source").value;
    
    // âœ… CHANGED: Include quantity in parts data
    if (name || desc || price || source) {
      allParts.push({ 
        part: name, 
        desc, 
        quantity: quantity,
        price, 
        source 
      });
    }
  });

  // âœ… CHANGED: Enhanced part validation - allow saving with 0 parts
  const validParts = [];
  const invalidParts = [];
  
  allParts.forEach(part => {
    // âœ… REMOVED: No longer require both name and desc - be more flexible
    // Only validate price format if a price was entered
    if (part.price && isNaN(parseFloat(part.price))) {
      invalidParts.push({ part, error: '××—×™×¨ ×—×™×™×‘ ×œ×”×™×•×ª ××¡×¤×¨ ×ª×§×™×Ÿ' });
    } else {
      // Check if this part came from search results and preserve full JSON data
      let searchResultData = {};
      const storedHelper = JSON.parse(sessionStorage.getItem("helper") || '{}');
      const searchResults = storedHelper?.parts_search?.search_results || [];
      
      // Find matching search result to preserve full data
      const matchingResult = searchResults.find(result => 
        (result.name && result.name.toLowerCase().includes(part.part.toLowerCase())) ||
        (result.description && result.description.toLowerCase().includes(part.part.toLowerCase()))
      );
      
      if (matchingResult) {
        searchResultData = {
          supplier: matchingResult.supplier || '',
          location: matchingResult.location || '',
          availability: matchingResult.availability || '',
          part_number: matchingResult.part_number || '',
          brand: matchingResult.brand || '',
          condition: matchingResult.condition || '',
          warranty: matchingResult.warranty || '',
          search_metadata: {
            search_engine: matchingResult.search_engine || '',
            result_rank: matchingResult.result_rank || 0,
            confidence_score: matchingResult.confidence_score || 0,
            matched_keywords: matchingResult.matched_keywords || []
          }
        };
      }
      
      validParts.push({
        ...part,
        ...searchResultData,
        addedAt: new Date().toISOString(),
        fromWizard: true,
        fromSearch: !!matchingResult
      });
    }
  });
  
  if (invalidParts.length > 0) {
    alert(`× ××¦××• ${invalidParts.length} ×—×œ×§×™× ×œ× ×ª×§×™× ×™×:\n` + 
          invalidParts.map(item => `${item.part.part || '×œ× ××•×’×“×¨'}: ${item.error}`).join('\n'));
    return;
  }

  console.log('ğŸ’¾ Saving parts data to helper...');
  
  // Send data to parent wizard if in iframe
  if (window.parent !== window) {
    const partsData = {
      type: 'moduleData',
      module: 'parts',
      data: {
        parts: validParts
      }
    };
    window.parent.postMessage(partsData, '*');
    console.log('ğŸ“¤ Parts data sent to parent wizard:', partsData);
  }
  
  try {
    // Get current helper data
    let helper = {};
    try {
      helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
    } catch (e) {
      console.warn('Failed to parse helper from sessionStorage, using empty object');
      helper = {};
    }
    
    // Initialize damage_assessment structure if needed
    helper.damage_assessment = helper.damage_assessment || {};
    helper.damage_assessment.parts = helper.damage_assessment.parts || {};
    
    // Store parts data in proper helper structure
    helper.damage_assessment.parts = {
      parts_items: validParts,
      updated_at: new Date().toISOString(),
      updated_by: 'parts_required_module'
    };
    
    // ALSO store in parts_search.selected_parts as requested
    helper.parts_search = helper.parts_search || {};
    helper.parts_search.selected_parts = validParts.map(part => ({
      ...part,
      selected_at: new Date().toISOString(),
      selected_in_module: 'parts_required'
    }));
    
    console.log(`âœ… Also saved ${validParts.length} parts to helper.parts_search.selected_parts`);
    
    // Update meta information
    helper.meta = helper.meta || {};
    helper.meta.last_updated = new Date().toISOString();
    
    // Save to session storage
    sessionStorage.setItem('helper', JSON.stringify(helper));
    
    console.log('âœ… Parts data saved to helper:', helper.damage_assessment.parts);
    
    // Show save confirmation
    const saveBtn = document.querySelector('.save-btn');
    const originalText = saveBtn.textContent;
    saveBtn.textContent = 'âœ… × ×©××¨';
    saveBtn.style.background = '#155724';
    
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.style.background = '#28a745';
    }, 2000);
    
    // Trigger helper update broadcast if available
    if (typeof window.broadcastHelperUpdate === 'function') {
      window.broadcastHelperUpdate(['damage_assessment'], 'parts_required_module');
    }
    
  } catch (error) {
    console.error('âŒ Failed to save parts data to helper:', error);
    alert('×©×’×™××” ×‘×©××™×¨×ª ×”× ×ª×•× ×™×');
  }
}

    document.getElementById("partsForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const allParts = [];

      document.querySelectorAll("#partsList .row").forEach(row => {
        const name = row.querySelector(".name").value.trim();
        const desc = row.querySelector(".desc").value.trim();
        const price = row.querySelector(".price").value.trim();
        const source = row.querySelector(".source").value;
        if (name && desc && source) {
          allParts.push({ part: name, desc, price, source });
        }
      });

      // Detect mode: wizard (default) or standalone (from nav)
    const urlParams = new URLSearchParams(window.location.search);
    const isStandalone = urlParams.get('standalone') === '1';

      // âœ… CHANGED: Enhanced part validation - allow saving with 0 parts (same as savePartsData)
      const validParts = [];
      const invalidParts = [];
      
      allParts.forEach(part => {
        // âœ… REMOVED: No longer require both name and desc - be more flexible
        if (part.price && isNaN(parseFloat(part.price))) {
          invalidParts.push({ part, error: '××—×™×¨ ×—×™×™×‘ ×œ×”×™×•×ª ××¡×¤×¨ ×ª×§×™×Ÿ' });
        } else {
          // Check if this part came from search results and preserve full JSON data
          let searchResultData = {};
          const storedHelper = JSON.parse(sessionStorage.getItem("helper") || '{}');
          const searchResults = storedHelper?.parts_search?.search_results || [];
          
          // Find matching search result to preserve full data
          const matchingResult = searchResults.find(result => 
            (result.name && result.name.toLowerCase().includes(part.part.toLowerCase())) ||
            (result.description && result.description.toLowerCase().includes(part.part.toLowerCase()))
          );
          
          if (matchingResult) {
            searchResultData = {
              supplier: matchingResult.supplier || '',
              location: matchingResult.location || '',
              availability: matchingResult.availability || '',
              part_number: matchingResult.part_number || '',
              brand: matchingResult.brand || '',
              condition: matchingResult.condition || '',
              warranty: matchingResult.warranty || '',
              search_metadata: {
                search_engine: matchingResult.search_engine || '',
                result_rank: matchingResult.result_rank || 0,
                confidence_score: matchingResult.confidence_score || 0,
                matched_keywords: matchingResult.matched_keywords || []
              }
            };
          }
          
          validParts.push({
            ...part,
            ...searchResultData,
            addedAt: new Date().toISOString(),
            fromWizard: !isStandalone,
            fromSearch: !!matchingResult
          });
        }
      });
      
      if (invalidParts.length > 0) {
        alert(`× ××¦××• ${invalidParts.length} ×—×œ×§×™× ×œ× ×ª×§×™× ×™×:\n` + 
              invalidParts.map(item => `${item.part.part || '×œ× ××•×’×“×¨'}: ${item.error}`).join('\n'));
        return;
      }

      if (isStandalone) {
        // Standalone: save to helper only (no custom localStorage)
        try {
          // Use helper even in standalone mode
          if (typeof updateHelper === 'function') {
            updateHelper('parts_search', { results: validParts, last_updated: new Date().toISOString() }, 'parts_required_standalone');
          } else {
            let helper = {};
            try { helper = JSON.parse(sessionStorage.getItem("helper") || '{}'); } catch(e){}
            helper.parts_search = helper.parts_search || {};
            helper.parts_search.results = validParts;
            helper.parts_search.last_updated = new Date().toISOString();
            sessionStorage.setItem("helper", JSON.stringify(helper));
          }
          const partsData = {
            parts: validParts,
            vehicle: getCarDetails(),
            timestamp: new Date().toISOString(),
            mode: 'standalone'
          };
          existingParts.push(partsData);
          // REMOVED: No custom localStorage - helper handles all storage
          
          alert(`âœ… × ×©××¨×• ${validParts.length} ×—×œ×§×™× ×‘×”×¦×œ×—×” (××¦×‘ ×¢×¦×××™)\n` + 
                validParts.map(p => `â€¢ ${p.part} - ${p.desc}`).join('\n'));
        } catch (e) {
          console.error('Error saving parts:', e);
          alert('×©×’×™××” ×‘×©××™×¨×ª ×”×—×œ×§×™×');
        }
      } else {
        // Send data to parent wizard if in iframe
        if (window.parent !== window) {
          const partsData = {
            type: 'moduleData',
            module: 'parts',
            data: {
              parts: validParts
            }
          };
          window.parent.postMessage(partsData, '*');
          console.log('ğŸ“¤ Parts data sent to parent wizard:', partsData);
        }
        
        // âœ… FIXED: Save parts to damage_centers structure with ACTUAL DATA
        console.log('ğŸ”„ Updating helper with parts data AND damage centers...');
        
        try {
          // Get current helper data
          let helper = {};
          try {
            helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
          } catch (e) {
            console.warn('Failed to parse helper from sessionStorage, using empty object');
            helper = {};
          }
          
          // Initialize damage_assessment structure if needed
          helper.damage_assessment = helper.damage_assessment || {};
          helper.damage_assessment.parts = helper.damage_assessment.parts || {};
          
          // Store parts data in legacy damage_assessment structure
          helper.damage_assessment.parts = {
            parts_items: validParts,
            updated_at: new Date().toISOString(),
            updated_by: 'parts_required_module'
          };
          
          // Simple parts data save for damage blocks
          helper.parts_data = helper.parts_data || {};
          helper.parts_data.selected_parts = validParts;
          helper.parts_data.total_cost = validParts.reduce((sum, part) => sum + (parseFloat(part.price) || 0), 0);
          
          // Also save to search results
          if (!helper.parts_search) helper.parts_search = {};
          const existingResults = helper.parts_search.results || [];
          helper.parts_search.results = [...existingResults, ...validParts];
          helper.parts_search.last_updated = new Date().toISOString();
          
          // Update meta information
          helper.meta = helper.meta || {};
          helper.meta.last_updated = new Date().toISOString();
          
          // Save to session storage
          sessionStorage.setItem('helper', JSON.stringify(helper));
          
          console.log('âœ… Helper updated successfully with parts data:', helper.damage_assessment.parts);
          console.log('âœ… Damage centers updated with parts:', currentCenter.parts_items);
          
          // Trigger helper update broadcast if available
          if (typeof window.broadcastHelperUpdate === 'function') {
            window.broadcastHelperUpdate(['damage_assessment', 'damage_centers'], 'parts_required_module');
          }
          
        } catch (error) {
          console.error('âŒ Failed to update helper with parts data:', error);
          alert('×©×’×™××” ×‘×©××™×¨×ª ×—×œ×§×™ ×”×¨×›×‘');
          return;
        }
        
        window.location.href = "repairs-required.html";
      }
    });

    // Detect mode: wizard (default) or standalone (from nav)
    const urlParams = new URLSearchParams(window.location.search);
    const isStandalone = urlParams.get('standalone') === '1';

    // Show car details input if standalone
    if (isStandalone) {
      document.getElementById('carDetailsBox').style.display = '';
      document.getElementById('pageTitle').innerText = "××•×“×•×œ ×—×œ×§×™× - ×—×™×¤×•×© ×¢×¦×××™";
    } else {
      // ...existing code to set pageTitle from session...
    }

    function getCarDetails() {
      if (isStandalone) {
        return {
          plate: document.getElementById("inputPlate").value.trim(),
          manufacturer: document.getElementById("inputManufacturer").value.trim(),
          model: document.getElementById("inputModel").value.trim(),
          year: document.getElementById("inputYear").value.trim()
        };
      } else {
        // âœ… UNIFIED HELPER INTEGRATION: Use proper helper import
        try {
          const helperData = JSON.parse(sessionStorage.getItem("helper") || '{}');
          return {
            plate: helperData.meta?.plate || helperData.vehicle?.plate_number || helperData.car_details?.plate || "",
            manufacturer: helperData.vehicle?.manufacturer || helperData.car_details?.manufacturer || "",
            model: helperData.vehicle?.model || helperData.car_details?.model || "",
            year: helperData.vehicle?.year || helperData.car_details?.year || ""
          };
        } catch(e) {
          console.error('Error reading helper data:', e);
          // No fallback to legacy storage - return empty if helper fails
          return {
            plate: "",
            manufacturer: "",
            model: "",
            year: ""
          };
        }
      }
    }

    // --- Suggestion logic with dropdown ---
    function suggestPart(input) {
      const row = input.closest('.row');
      const nameInput = row.querySelector('.name');
      const descInput = row.querySelector('.desc');
      const priceInput = row.querySelector('.price');
      const sourceSelect = row.querySelector('.source');
      const dropdown = row.querySelector('.suggest-dropdown');

      // Use the value of the input that triggered the event
      const query = input.value.trim();
      const { plate, manufacturer, model, year } = getCarDetails();

      if (!query || query.length < 2) {
        dropdown.style.display = "none";
        return;
      }

      // Get suggestions from multiple sources
      const suggestions = [];
      
      // âœ… FIXED: Search in parts search results from helper (primary source)
      // Try both old and new helper structures for compatibility
      const searchResults = [];
      
      // Wizard search results (highest priority - from recent webhook)
      if (window.wizardSearchResults && window.wizardSearchResults.length > 0) {
        searchResults.push(...window.wizardSearchResults);
        console.log(`ğŸ” Using ${window.wizardSearchResults.length} wizard search results for suggestions`);
      }
      
      // New structure (from wizard integration)
      if (window.helper && window.helper.parts_search && window.helper.parts_search.current_session && window.helper.parts_search.current_session.results) {
        searchResults.push(...window.helper.parts_search.current_session.results);
      }
      
      // Legacy structure (backwards compatibility)
      if (window.helper && window.helper.parts_search && window.helper.parts_search.search_results) {
        searchResults.push(...window.helper.parts_search.search_results);
      }
      
      // Process search results (handle both flat and nested structures)
      searchResults.forEach(item => {
        // Handle nested structure (webhook groups with search_results)
        if (item.search_results && Array.isArray(item.search_results)) {
          item.search_results.forEach(part => {
            const partName = part.×ª×™××•×¨ || part.description || part.name || '';
            const partDesc = part.×ª×™××•×¨ || part.description || part.name || '';
            
            if (partName.toLowerCase().includes(query.toLowerCase()) ||
                partDesc.toLowerCase().includes(query.toLowerCase())) {
              suggestions.push({ 
                name: partName,
                desc: partDesc,
                source: part['×¡×•×’ ×—×œ×§'] || part.type || '×œ× ×¦×•×™×Ÿ',
                price: (part.××—×™×¨ || part.price || '').toString().replace('â‚ª', '').trim(),
                supplier: part.×¡×¤×§ || part.supplier || '',
                location: part.××™×§×•× || part.location || '',
                availability: part.×–××™× ×•×ª || part.availability || '',
                searchResult: true, // Mark as from search results
                group: item.group || '×›×œ×œ×™'
              });
            }
          });
        }
        // Handle flat structure (legacy compatibility)
        else {
          const part = item;
          if ((part.name && part.name.toLowerCase().includes(query.toLowerCase())) ||
              (part.description && part.description.toLowerCase().includes(query.toLowerCase())) ||
              (part.desc && part.desc.toLowerCase().includes(query.toLowerCase()))) {
            suggestions.push({ 
              name: part.name || part.description || part.desc, 
              desc: part.description || part.desc || part.name, 
              source: part.condition || part.source || '×œ× ×¦×•×™×Ÿ',
              price: part.price || '',
              supplier: part.supplier || '',
              location: part.location || '',
              availability: part.availability || '',
              searchResult: true // Mark as from search results
            });
          }
        }
      });
      
      // Search in stored helper results
      // REMOVED: No localStorage fallback - helper only
      let storedHelper = {};
      try {
        storedHelper = JSON.parse(sessionStorage.getItem("helper") || '{}');
      } catch (e) {
        storedHelper = {};
      }
      const allResults = storedHelper?.parts_search?.results || [];
      
      allResults.forEach(result => {
        if ((result.name || '').toLowerCase().includes(query.toLowerCase()) ||
            (result.desc || '').toLowerCase().includes(query.toLowerCase())) {
          suggestions.push({
            name: result.name || result.desc,
            desc: result.desc || result.name,
            price: result.price,
            source: result.source
          });
        }
      });

      if (suggestions.length === 0) {
        dropdown.innerHTML = '';
        dropdown.style.display = "none";
        return;
      }

      // Remove duplicates and limit to 10 results
      const uniqueSuggestions = suggestions.filter((suggestion, index, self) => 
        index === self.findIndex(s => s.name === suggestion.name)
      ).slice(0, 10);

      dropdown.innerHTML = '<option value="">×‘×—×¨ ×”×¦×¢×”...</option>' +
        uniqueSuggestions.map((s, i) => `
          <option value="${i}">${s.name}${s.category ? ` (${s.category})` : ''}${s.price ? ` - â‚ª${s.price}` : ''}</option>
        `).join('');
      dropdown.style.display = "";
      dropdown._suggestions = uniqueSuggestions;

      // Enhanced selection handling
      dropdown.onchange = function () {
        const idx = this.value;
        if (!this._suggestions || !this._suggestions[idx]) return;
        const suggestion = this._suggestions[idx];
        nameInput.value = suggestion.name || "";
        descInput.value = suggestion.desc || "";
        if (suggestion.price) priceInput.value = suggestion.price;
        if (suggestion.source) sourceSelect.value = suggestion.source;
        dropdown.style.display = "none";
        
        // Trigger change event for potential additional processing
        nameInput.dispatchEvent(new Event('change'));
      };
    }
    // Calculate and display totals
    function calculatePartsTotals() {
      const parts = [];
      
      document.querySelectorAll("#partsList .part-row").forEach(row => {
        const partInput = row.querySelector('.part-name');
        const priceInput = row.querySelector('.part-price');
        const sourceSelect = row.querySelector('.source');
        
        const partName = partInput ? partInput.value.trim() : '';
        const price = priceInput ? parseFloat(priceInput.value) || 0 : 0;
        const source = sourceSelect ? sourceSelect.value : '';
        
        if (partName && price > 0) {
          parts.push({ 
            part: partName, 
            price: price,
            source: source
          });
        }
      });
      
      const total = parts.reduce((sum, part) => sum + part.price, 0);
      
      // Display total in the page
      let totalDisplay = document.getElementById('partsTotal');
      if (!totalDisplay) {
        totalDisplay = document.createElement('div');
        totalDisplay.id = 'partsTotal';
        totalDisplay.style.cssText = 'background: #e8f5e8; padding: 15px; margin: 20px 0; border-radius: 8px; font-weight: bold; text-align: center; border: 2px solid #4caf50;';
        document.querySelector('.container').insertBefore(totalDisplay, document.querySelector('.footer'));
      }
      
      totalDisplay.innerHTML = `
        <div style="font-size: 18px; color: #2e7d32; margin-bottom: 5px;">×¡×™×›×•× ×—×œ×¤×™×</div>
        <div style="font-size: 24px; color: #1b5e20;">â‚ª${total.toLocaleString()}</div>
        <div style="font-size: 14px; color: #424242;">×›×•×œ×œ ××¢"×: â‚ª${(total * 1.17).toLocaleString()}</div>
      `;
      
      return { parts, total };
    }
    
    // âœ… NEW: Send parts selection updates to wizard
    function sendPartsUpdateToWizard() {
      if (window.parent && window.parent.postMessage && window.parent !== window) {
        try {
          const partsData = calculatePartsTotals();
          
          // Separate selected and unselected parts
          const allSearchResults = [];
          
          // Get all search results from helper
          if (globalHelper.parts_search && globalHelper.parts_search.current_session && globalHelper.parts_search.current_session.results) {
            allSearchResults.push(...globalHelper.parts_search.current_session.results);
          }
          
          // Identify unselected parts (from search results that weren't selected)
          const selectedPartNames = partsData.parts.map(p => p.name.toLowerCase());
          const unselectedParts = allSearchResults.filter(result => 
            !selectedPartNames.includes((result.name || result.description || '').toLowerCase())
          );
          
          // Send update to wizard
          window.parent.postMessage({
            type: 'partsSelectionUpdate',
            selectedParts: partsData.parts,
            unselectedParts: unselectedParts,
            total: partsData.total,
            source: 'parts_required_iframe'
          }, '*');
          
          console.log(`ğŸ“¤ Sent parts update to wizard: ${partsData.parts.length} selected, ${unselectedParts.length} unselected`);
          
        } catch (error) {
          console.error('âŒ Failed to send parts update to wizard:', error);
        }
      }
    }
    
    // Auto-calculate when data changes and send updates to wizard
    document.addEventListener('change', function() {
      calculatePartsTotals();
      sendPartsUpdateToWizard();
    });
    document.addEventListener('input', function() {
      calculatePartsTotals();
      sendPartsUpdateToWizard();
    });
    
    // âœ… NEW: Helper function to add part from data (for pre-filling from wizard)
    function addPartFromData(partData) {
      const partsList = document.getElementById('partsList');
      const newRow = document.createElement('div');
      newRow.className = 'row';
      
      const rowIndex = partsList.children.length;
      newRow.setAttribute('data-row-index', rowIndex);
      
      newRow.innerHTML = `
        <div class="input-wrap">
          <input type="text" class="name" placeholder="×©× ×”×—×œ×§" oninput="suggestPart(this)" value="${partData.name || partData.part || ''}">
          <select class="suggest-dropdown" style="display:none;"></select>
        </div>
        <input type="text" class="desc" placeholder="×ª×™××•×¨" oninput="suggestPart(this)" value="${partData.description || partData.desc || ''}">
        <input type="number" class="quantity" placeholder="×›××•×ª" value="${partData.quantity || partData.qty || 1}" min="1" style="width: 60px; margin-left: 8px;">
        <input type="text" class="price" placeholder="××—×™×¨" value="${partData.price || ''}">
        <select class="source">
          <option value="">××§×•×¨</option>
          <option value="×—×œ×™×¤×™/××§×•×¨×™" ${partData.source === '×—×œ×™×¤×™/××§×•×¨×™' ? 'selected' : ''}>×—×œ×™×¤×™/××§×•×¨×™</option>
          <option value="×—×œ×™×¤×™/××©×•××©" ${partData.source === '×—×œ×™×¤×™/××©×•××©' ? 'selected' : ''}>×—×œ×™×¤×™/××©×•××©</option>
          <option value="×—×“×© ××§×•×¨×™" ${partData.source === '×—×“×© ××§×•×¨×™' ? 'selected' : ''}>×—×“×© ××§×•×¨×™</option>
          <option value="×—×œ×™×¤×™" ${partData.source === '×—×œ×™×¤×™' ? 'selected' : ''}>×—×œ×™×¤×™</option>
          <option value="××©×•××©" ${partData.source === '××©×•××©' ? 'selected' : ''}>××©×•××©</option>
          <option value="×¨×™×§" ${partData.source === '×¨×™×§' ? 'selected' : ''}>×¨×™×§</option>
        </select>
        <div class="row-actions" style="display: flex; gap: 5px; margin-right: 8px;">
          <button type="button" class="btn-edit" onclick="editPartRow(${rowIndex})" title="×¢×¨×•×š ×—×œ×§" style="
            background: #f59e0b; color: white; border: none; padding: 6px 10px; 
            border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: bold;
          ">âœï¸</button>
          <button type="button" class="btn-delete" onclick="deletePartRow(${rowIndex})" title="××—×§ ×—×œ×§" style="
            background: #dc3545; color: white; border: none; padding: 6px 10px; 
            border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: bold;
          ">ğŸ—‘ï¸</button>
        </div>
      `;
      
      partsList.appendChild(newRow);
    }
    
    // âœ… NEW: Edit/Delete functionality for individual parts
    let editingRowIndex = -1;
    
    function editPartRow(rowIndex) {
      const rows = document.querySelectorAll('#partsList .row');
      const row = rows[rowIndex];
      
      if (!row) {
        console.error('Row not found:', rowIndex);
        return;
      }
      
      if (editingRowIndex === rowIndex) {
        // Already editing this row, finish editing
        finishEditingRow(rowIndex);
        return;
      }
      
      // If editing another row, finish that first
      if (editingRowIndex >= 0) {
        finishEditingRow(editingRowIndex);
      }
      
      // Start editing this row
      editingRowIndex = rowIndex;
      const editBtn = row.querySelector('.btn-edit');
      editBtn.textContent = 'ğŸ’¾';
      editBtn.title = '×©××•×¨ ×©×™× ×•×™×™×';
      editBtn.style.background = '#10b981';
      
      // Make fields more prominent for editing
      row.style.background = '#fffbeb';
      row.style.borderColor = '#f59e0b';
      row.style.borderWidth = '2px';
      
      console.log(`ğŸ“ Started editing row ${rowIndex}`);
    }
    
    function finishEditingRow(rowIndex) {
      const rows = document.querySelectorAll('#partsList .row');
      const row = rows[rowIndex];
      
      if (!row) return;
      
      const editBtn = row.querySelector('.btn-edit');
      editBtn.textContent = 'âœï¸';
      editBtn.title = '×¢×¨×•×š ×—×œ×§';
      editBtn.style.background = '#f59e0b';
      
      // Reset row styling
      row.style.background = '#f8fafc';
      row.style.borderColor = '#e5e7eb';
      row.style.borderWidth = '1px';
      
      editingRowIndex = -1;
      console.log(`ğŸ’¾ Finished editing row ${rowIndex}`);
    }
    
    function deletePartRow(rowIndex) {
      const rows = document.querySelectorAll('#partsList .row');
      const row = rows[rowIndex];
      
      if (!row) {
        console.error('Row not found:', rowIndex);
        return;
      }
      
      // Get part info for confirmation
      const name = row.querySelector('.name').value.trim();
      const desc = row.querySelector('.desc').value.trim();
      const partInfo = name || desc || '×—×œ×§ ×œ×œ× ×©×';
      
      const confirmDelete = confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×—×œ×§?\n\n${partInfo}`);
      
      if (confirmDelete) {
        row.remove();
        
        // Update row indices for remaining rows
        updateRowIndices();
        
        console.log(`ğŸ—‘ï¸ Deleted row ${rowIndex}: ${partInfo}`);
        
        // Show notification if available
        if (typeof showNotification === 'function') {
          showNotification(`× ××—×§ ×—×œ×§: ${partInfo}`, 'success');
        }
      }
    }
    
    function updateRowIndices() {
      const rows = document.querySelectorAll('#partsList .row');
      rows.forEach((row, index) => {
        row.setAttribute('data-row-index', index);
        
        // Update button onclick handlers
        const editBtn = row.querySelector('.btn-edit');
        const deleteBtn = row.querySelector('.btn-delete');
        
        if (editBtn) editBtn.onclick = () => editPartRow(index);
        if (deleteBtn) deleteBtn.onclick = () => deletePartRow(index);
      });
      
      // Reset editing state if we were editing a deleted row
      if (editingRowIndex >= rows.length) {
        editingRowIndex = -1;
      }
    }
    
    // Make functions globally available
    window.editPartRow = editPartRow;
    window.deletePartRow = deletePartRow;
    window.updateRowIndices = updateRowIndices;
  </script>
  <script type="module">
    // Try to load parts bank for better suggestions
    try {
      import('./parts.js').then(module => {
        window.PARTS_BANK = module.PARTS_BANK;
        console.log('Parts bank loaded for suggestions');
      }).catch(e => console.warn('Could not load parts bank'));
    } catch (e) {
      console.warn('Module import not supported');
    }
  </script>
  <script src="parts-floating.js"></script>
</body>
</html>
