<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>עבודות נדרשות - ירון כיוף - שמאות וייעוץ</title>
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <!-- Only HTML from <style> onward is different -->
<style>
  body {
    font-family: sans-serif;
    background: #f3f6fb;
    margin: 0;
    padding: 30px;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
  }

  .container {
      max-width: 500px;
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      width: 100%;
      text-align: center;
      position: relative;
    }

  .title { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
    .subtitle { font-size: 18px; color: #666; margin-bottom: 5px; }
    .legal-note {
      color: red;
      font-weight: bold;
      margin-bottom: 15px;
    }
    h2 {
      font-size: 20px;
      color: #007bff;
      margin-bottom: 20px;
    }

  .logo img {
      width: 120px;
      opacity: 0.9;
      margin-bottom: 15px;
    }
  .top-bar {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
  }

   .top-bar button {
      width: 48%;
      background-color: #6c757d;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
    }

  .logout-btn {
      background-color: #dc3545 !important;
    }
  .home-btn { background: #6c757d; }

.row {
    display: flex;
    flex-direction: row;
    gap: 10px;
    margin-bottom: 12px;
    align-items: center;
  }

  .row select, .row input {
   flex: 2  ;
  padding: 10px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

  select, #takana389 {
    width:70%;
  }
  select, input {
    width: 70%;
  }

  #takana389 {
    margin-bottom: 20px;
    padding: 12px;
    width: 70%;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }

      .btn-group {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }

  .button-vehiclePopup {
    display: flex;
    width: 100%;
    gap: 10px;
    margin-top: 10px;
    justify-content: flex-end;
    margin-bottom: 10px;
  }


  .add-btn { background: #6c757d; }
  .save-btn { background: #28a745; }
  .submit-btn { background: #007bff; }

  button {
     margin-top: 10px;
      width: 40%;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      color: white;
      background-color: #007bff;
      cursor: pointer;
  }

    .footer {
      margin-top: 30px;
      font-size: 12px;
      color: #aaa;
  }

 #vehiclePopup {
      background: #f1f1f1;
      padding: 10px;
      border-radius: 10px;
      margin: 10px 0;
      display: none;
      font-size: 14px;
      text-align: right;
    }
    
    /* Mobile CSS Optimizations */
    @media (max-width: 768px) {
      body {
        padding: 15px;
        font-size: 16px; /* Prevent zoom on iOS */
      }
      
      .container {
        max-width: 100%;
        padding: 20px 15px;
        margin: 0;
        border-radius: 10px;
      }
      
      .title {
        font-size: 20px;
        margin-bottom: 8px;
      }
      
      .subtitle {
        font-size: 16px;
        margin-bottom: 15px;
      }
      
      .legal-note {
        font-size: 14px;
        margin-bottom: 20px;
        line-height: 1.4;
      }
      
      h2 {
        font-size: 18px;
        margin-bottom: 15px;
      }
      
      .logo img {
        width: 100px;
        margin-bottom: 10px;
      }
      
      /* Mobile-optimized form elements */
      #takana389 {
        width: 100%;
        padding: 15px;
        font-size: 16px;
        margin-bottom: 20px;
        border-radius: 8px;
        border: 2px solid #ddd;
        background-color: #fff;
        box-sizing: border-box;
      }
      
      .row {
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        border: 1px solid #e9ecef;
      }
      
      .row select,
      .row input {
        width: 100%;
        padding: 15px;
        font-size: 16px;
        border-radius: 8px;
        border: 2px solid #ddd;
        background-color: #fff;
        box-sizing: border-box;
        margin-bottom: 10px;
      }
      
      .row select:focus,
      .row input:focus,
      #takana389:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
      }
      
      /* Larger touch targets for mobile */
      button {
        width: 100%;
        padding: 15px 20px;
        font-size: 16px;
        margin-top: 15px;
        border-radius: 10px;
        min-height: 50px;
        touch-action: manipulation;
      }
      
      .add-btn {
        background: #28a745;
        color: white;
        border: none;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .add-btn:active {
        transform: translateY(1px);
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      }
      
      /* Mobile form styling */
      form {
        margin-top: 20px;
      }
      
      label {
        display: block;
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 8px;
        color: #333;
      }
      
      /* Work list mobile styling */
      #worksList {
        margin-bottom: 20px;
      }
      
      /* Better spacing on mobile */
      .container > * {
        margin-bottom: 15px;
      }
      
      /* Footer mobile styling */
      .footer {
        font-size: 11px;
        margin-top: 25px;
        text-align: center;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      
      .container {
        padding: 15px 10px;
      }
      
      .title {
        font-size: 18px;
      }
      
      .subtitle {
        font-size: 14px;
      }
      
      h2 {
        font-size: 16px;
      }
      
      .logo img {
        width: 80px;
      }
      
      .row {
        padding: 12px;
        gap: 12px;
      }
      
      .row select,
      .row input,
      #takana389 {
        padding: 12px;
        font-size: 16px;
      }
      
      button {
        padding: 12px 16px;
        font-size: 15px;
        min-height: 45px;
      }
    }
</style>

</head>
<body>
   <div class="container">
    <div class="logo">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/04/logo-yaron.webp" alt="Logo">
    </div>
    <div class="title">ירון כיוף - שמאות וייעוץ</div>
    <div class="subtitle">שמאי רכב והערכת נזקי רכוש</div>
    <div class="legal-note">מפרט תיקון - הערכת נזק (מבלי לפגוע בזכויות)</div>
    <h2 id="pageTitle">רכב מס. ...: עבודות נדרשות</h2>
   
    <!-- Removed navigation buttons when in wizard -->
      

    <form id="workForm">
      <div>
        <label for="takana389"><strong>האם תקנה 389 חלה?</strong></label>
        <select id="takana389">
          <option value="">בחר</option>
          <option>כן</option>
          <option>לא</option>
          <option>לא רלוונטי</option>
        </select>
      </div>

      <div id="worksList">
        <!-- work rows go here -->
      </div>

      <button type="button" class="add-btn" onclick="addWorkRow()">הוסף עבודה</button>
    </form>

    <div class="footer">All rights reserved © Carmel Cayouf</div>
  </div>

  <script>
    // Get data from helper instead of legacy storage
    let globalHelper = {};
    try { globalHelper = JSON.parse(sessionStorage.getItem("helper") || '{}'); } catch(e){}
    const plate = globalHelper.meta?.plate || globalHelper.vehicle?.plate || '';
    const manufacturer = globalHelper.vehicle?.manufacturer || '';
    const model = globalHelper.vehicle?.model || '';
    const year = globalHelper.vehicle?.year || '';
    document.getElementById("pageTitle").innerText = `רכב מס. ${plate}: עבודות נדרשות`;

    if (!plate || !manufacturer || !model || !year) {
      alert("שגיאה: חסר מידע קריטי.");
 }

function logout() {
  sessionStorage.clear();
  location.href = "index.html";
}

const workOptions = [
"כל עבודות הפחחות כולל פירוקים והרכבות", "עבודות צבע", "עבודות חשמל", "עבודות מכונאות", "עבודות מזגן", "עבודות ריפוד",
  "עבודות זגגות", "איטום וזיפות", "בדיקת מתלה",
  "כיול רדאר", "העברת חיישנים", "אחר"
];

function addWorkRow() {
  const row = document.createElement("div");
  row.className = "row";
 
  // Work type dropdown
  const select = document.createElement("select");
  select.innerHTML = `<option value="">בחר סוג עבודה</option>` + workOptions.map(opt => `<option>${opt}</option>`).join("");
  select.style.flex = "2";

  // Cost input field
  const costInput = document.createElement("input");
  costInput.type = "number";
  costInput.placeholder = "עלות (₪)";
  costInput.style.flex = "1";
  costInput.min = "0";
  costInput.step = "0.01";

  // Comments input field  
  const commentsInput = document.createElement("input");
  commentsInput.placeholder = "הערות / פירוט";
  commentsInput.style.flex = "2";

  row.appendChild(select);
  row.appendChild(costInput);
  row.appendChild(commentsInput);
  document.getElementById("worksList").appendChild(row);
}

addWorkRow(); // first default

// ✅ FIX: Restore takana389 field value on page load
function restoreTakana389Field() {
  try {
    const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
    const activeCenterId = helper.damage_assessment?.current_center_id || 
                          helper.damage_centers?.current_center_id ||
                          sessionStorage.getItem('active_damage_center_id');
    
    if (activeCenterId && helper.damage_assessment?.centers) {
      const activeCenter = helper.damage_assessment.centers.find(c => c.id === activeCenterId);
      if (activeCenter && activeCenter.takana389) {
        const takanaField = document.getElementById('takana389');
        if (takanaField) {
          takanaField.value = activeCenter.takana389;
          console.log('✅ Restored takana389 field value:', activeCenter.takana389);
        }
      }
    }
  } catch (error) {
    console.error('❌ Error restoring takana389 field:', error);
  }
}

// Restore field value when page loads
restoreTakana389Field();

// Save work data to helper without navigation
function saveWorkData() {
  const takana = document.getElementById("takana389").value;
  const works = [];

  document.querySelectorAll("#worksList .row").forEach(row => {
    const select = row.querySelector("select").value;
    const costInput = row.querySelectorAll("input")[0];
    const commentsInput = row.querySelectorAll("input")[1];
    const cost = costInput ? parseFloat(costInput.value) || 0 : 0;
    const comments = commentsInput ? commentsInput.value : "";
    
    if (select) {
      works.push({ 
        category: select, 
        cost: cost,
        comments: comments 
      });
    }
  });

  console.log('💾 Saving work data to helper...');
  
  // Send data to parent wizard if in iframe
  if (window.parent !== window) {
    const workData = {
      type: 'moduleData',
      module: 'work',
      data: {
        works: works,
        takana389: takana
      }
    };
    window.parent.postMessage(workData, '*');
    console.log('📤 Work data sent to parent wizard:', workData);
  }
  
  try {
    // Get current helper data
    let helper = {};
    try {
      helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
    } catch (e) {
      console.warn('Failed to parse helper from sessionStorage, using empty object');
      helper = {};
    }
    
    // ARCHITECTURAL FIX: Only save work data if there's an active damage center
    // This prevents orphaned data accumulation in damage_assessment
    
    const activeCenterId = helper.damage_assessment?.current_center_id || 
                          helper.damage_centers?.current_center_id ||
                          sessionStorage.getItem('active_damage_center_id');
                          
    if (!activeCenterId) {
      console.log('⚠️ No active damage center - work data will not be saved to prevent orphaned data');
      console.log('📝 Work items:', works);
      console.log('📝 Takana 389:', takana);
      
      // Store in temporary session storage for potential recovery
      sessionStorage.setItem('pending_work_data', JSON.stringify({
        works: works,
        takana389: takana,
        timestamp: new Date().toISOString(),
        source: 'work_module'
      }));
      
      alert('⚠️ לא ניתן לשמור נתוני עבודות ללא מוקד נזק פעיל. אנא צור/ערוך מוקד נזק תחילה.');
      return;
    }
    
    console.log('✅ Active damage center detected:', activeCenterId);
    console.log('💾 Saving work data to active damage center instead of global assessment');
    
    // Save work data to specific damage center, not global assessment
    helper.damage_assessment = helper.damage_assessment || {};
    helper.damage_assessment.centers = helper.damage_assessment.centers || [];
    
    // Find the active center
    let activeCenter = helper.damage_assessment.centers.find(center => 
      center.id === activeCenterId || center.current_center_id === activeCenterId
    );
    
    if (!activeCenter) {
      console.log('❌ Active center not found in centers array, work data not saved');
      alert('שגיאה: לא נמצא מוקד נזק פעיל');
      return;
    }
    
    // Save work items directly to the active damage center
    activeCenter.work_items = activeCenter.work_items || [];
    
    // Replace all work items in this center with current data
    activeCenter.work_items = works.map(work => ({
      ...work,
      center_id: activeCenterId,
      updated_at: new Date().toISOString(),
      source: 'work_module'
    }));
    
    // Also store takana389 in center
    activeCenter.takana389 = takana;
    activeCenter.work_updated_at = new Date().toISOString();
    
    console.log(`✅ Saved ${works.length} work items to damage center ${activeCenterId}`);
    
    // DO NOT save to global damage_assessment - this prevents orphaned data
    
    // Update meta information
    helper.meta = helper.meta || {};
    helper.meta.last_updated = new Date().toISOString();
    
    // Save to session storage
    sessionStorage.setItem('helper', JSON.stringify(helper));
    
    console.log('✅ Work data saved to helper:', helper.damage_assessment.works);
    
    // Show save confirmation
    const saveBtn = document.querySelector('.save-btn');
    const originalText = saveBtn.textContent;
    saveBtn.textContent = '✅ נשמר';
    saveBtn.style.background = '#155724';
    
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.style.background = '#28a745';
    }, 2000);
    
    // Trigger helper update broadcast if available
    if (typeof window.broadcastHelperUpdate === 'function') {
      window.broadcastHelperUpdate(['damage_assessment'], 'work_module');
    }
    
  } catch (error) {
    console.error('❌ Failed to save work data to helper:', error);
    
    // Enhanced error feedback
    const errorDiv = document.createElement('div');
    errorDiv.style.cssText = `
      background: #fee2e2;
      border: 2px solid #ef4444;
      color: #dc2626;
      padding: 12px;
      border-radius: 8px;
      margin: 10px 0;
      font-weight: bold;
      text-align: center;
    `;
    errorDiv.textContent = '❌ שגיאה בשמירת הנתונים. אנא בדוק את הנתונים ונסה שוב.';
    
    const container = document.querySelector('.container');
    container.insertBefore(errorDiv, container.querySelector('.footer'));
    
    // Auto-remove error message after 5 seconds
    setTimeout(() => errorDiv.remove(), 5000);
  }
}

// Auto-send data to parent wizard when work changes (for wizard mode)
function autoSendWorkData() {
  if (window.parent !== window) {
    const takana = document.getElementById("takana389").value;
    const works = [];

    document.querySelectorAll("#worksList .row").forEach(row => {
      const select = row.querySelector("select").value;
      const costInput = row.querySelectorAll("input")[0];
      const commentsInput = row.querySelectorAll("input")[1];
      const cost = costInput ? parseFloat(costInput.value) || 0 : 0;
      const comments = commentsInput ? commentsInput.value : "";
      
      if (select) {
        works.push({ 
          category: select, 
          cost: cost,
          comments: comments 
        });
      }
    });

    const workData = {
      type: 'moduleData',
      module: 'work',
      data: {
        works: works,
        takana389: takana
      }
    };
    window.parent.postMessage(workData, '*');
    console.log('📤 Work data auto-sent to parent wizard:', workData);
  }
}

// Auto-send when work data changes
document.addEventListener('change', autoSendWorkData);
document.addEventListener('input', autoSendWorkData);

// Calculate and display totals
function calculateWorkTotals() {
  const works = [];
  
  document.querySelectorAll("#worksList .row").forEach(row => {
    const select = row.querySelector("select").value;
    const costInput = row.querySelectorAll("input")[0];
    const cost = costInput ? parseFloat(costInput.value) || 0 : 0;
    
    if (select && cost > 0) {
      works.push({ category: select, cost: cost });
    }
  });
  
  const total = works.reduce((sum, work) => sum + work.cost, 0);
  
  // Display total in the page if we have a display element
  let totalDisplay = document.getElementById('workTotal');
  if (!totalDisplay) {
    totalDisplay = document.createElement('div');
    totalDisplay.id = 'workTotal';
    totalDisplay.style.cssText = 'background: #e3f2fd; padding: 15px; margin: 20px 0; border-radius: 8px; font-weight: bold; text-align: center; border: 2px solid #2196f3;';
    document.querySelector('.container').insertBefore(totalDisplay, document.querySelector('.footer'));
  }
  
  // ✅ FIXED: Use proper VAT calculation instead of hardcoded 1.17
  const vatPercentage = 17; // Default VAT percentage
  const vatMultiplier = 1 + (vatPercentage / 100);
  
  // SESSION 41: Round totals to whole numbers (no decimals)
  const roundedTotal = Math.round(total);
  const roundedTotalWithVat = Math.round(total * vatMultiplier);
  
  totalDisplay.innerHTML = `
    <div style="font-size: 18px; color: #1976d2; margin-bottom: 5px;">סיכום עבודות</div>
    <div style="font-size: 24px; color: #0d47a1;">₪${roundedTotal.toLocaleString()}</div>
    <div style="font-size: 14px; color: #424242;">כולל מע"מ (${vatPercentage}%): ₪${roundedTotalWithVat.toLocaleString()}</div>
  `;
  
  return { works, total };
}

// Auto-calculate when data changes
document.addEventListener('change', calculateWorkTotals);
document.addEventListener('input', calculateWorkTotals);

  </script>
<script src="helper.js" type="module"></script>
<script src="car-details-floating.js"></script>
</body>
</html>
