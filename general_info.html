<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>פרטים כלליים - ירון כיוף</title>
  <link rel="icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" type="image/webp" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Assistant&display=swap" />
  <style>
    body {
      font-family: 'Assistant', sans-serif;
      background: #f3f6fb;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 30px;
    }
    .container {
      max-width: 540px;
      width: 100%;
      background: white;
      padding: 40px 30px;
      border-radius: 16px;
      text-align: center;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      position: relative;
    }
    .logo img {
      width: 120px;
      margin-bottom: 20px;
    }
    .title { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
    .subtitle { font-size: 18px; color: #666; margin-bottom: 20px; }
    h2 { font-size: 20px; color: #1e3a8a; margin-bottom: 15px; }
    input, select {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    button {
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      font-size: 16px;
      font-weight: 600;
      border-radius: 10px;
      box-sizing: border-box;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      background: linear-gradient(135deg, #3b82f6, #1e40af);
      color: white;
    }
    button:hover {
      background: linear-gradient(135deg, #1e40af, #1e3a8a);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
    }
    button.btn-secondary {
      background: linear-gradient(135deg, #64748b, #475569);
    }
    button.btn-secondary:hover {
      background: linear-gradient(135deg, #475569, #334155);
    }
    button.btn-success {
      background: linear-gradient(135deg, #27ae60, #229954);
    }
    button.btn-success:hover {
      background: linear-gradient(135deg, #229954, #1e8449);
    }
    .footer {
      margin-top: 30px;
      font-size: 12px;
      color: #999;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo"><img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo"/></div>
    <div class="title">ירון כיוף - שמאות וייעוץ</div>
    <div class="subtitle">שמאי רכב והערכת נזקי רכוש</div>
    <h2 id="pageTitle">רכב מס. ...: פרטים כלליים</h2>

    <label style="display: block; text-align: right; margin-bottom: 5px; font-weight: bold;">מד אוץ:</label>
    <input id="km" placeholder="מד אוץ" type="text" />
    <label style="display: block; text-align: right; margin-bottom: 5px; font-weight: bold;">תאריך נזק:</label>
    <input id="damage_date_independent" placeholder="תאריך נזק" type="date" style="background: white !important;" />
    <label style="display: block; text-align: right; margin-bottom: 5px; font-weight: bold;">שם בעל הרכב:</label>
    <input id="owner_name" placeholder="שם בעל הרכב" type="text" style="text-align: right; direction: rtl;" />
    <label style="display: block; text-align: right; margin-bottom: 5px; font-weight: bold;">טלפון בעל הרכב:</label>
    <input id="owner_phone" placeholder="מספר טלפון" type="tel" autocomplete="tel" style="text-align: right; direction: rtl;" />
    <label style="display: block; text-align: right; margin-bottom: 5px; font-weight: bold;">כתובת בעל הרכב:</label>
    <input id="owner_address" placeholder="כתובת בעל הרכב" type="text" />
    <label style="display: block; text-align: right; margin-bottom: 5px; font-weight: bold;">שם מוסך:</label>
    <input id="garage_name" placeholder="שם מוסך" type="text" />
    <label style="display: block; text-align: right; margin-bottom: 5px; font-weight: bold;">טלפון מוסך:</label>
    <input id="garage_phone" placeholder="טלפון מוסך" type="text" />
    <label style="display: block; text-align: right; margin-bottom: 5px; font-weight: bold;">אימייל מוסך:</label>
    <input id="garage_email" placeholder="אימייל מוסך" type="email" autocomplete="email" />

    <label style="display: block; text-align: right; margin-bottom: 5px; font-weight: bold;">שם סוכן ביטוח:</label>
    <input id="agent_name" placeholder="שם סוכן ביטוח" type="text" />
    <label style="display: block; text-align: right; margin-bottom: 5px; font-weight: bold;">טלפון סוכן ביטוח:</label>
    <input id="agent_phone" placeholder="טלפון סוכן ביטוח" type="text" />
    <label style="display: block; text-align: right; margin-bottom: 5px; font-weight: bold;">אימייל סוכן ביטוח:</label>
    <input id="agent_email" placeholder="אימייל סוכן ביטוח" type="email" autocomplete="email" />

    <label style="display: block; text-align: right; margin-bottom: 5px; font-weight: bold;">חברת ביטוח:</label>
    <select id="insuranceCompany">
      <option value="">בחר חברת ביטוח</option>
      <option value="הראל">הראל</option>
      <option value="איילון">איילון</option>
      <option value="הפניקס">הפניקס</option>
      <option value="מנורה">מנורה</option>
      <option value="מגדל">מגדל</option>
      <option value="ליברה">ליברה</option>
      <option value="כלל ביטוח">כלל ביטוח</option>
      <option value="ביטוח ישיר">ביטוח ישיר</option>
      <option value="אחר">אחר</option>
    </select>
    <input id="otherInsuranceCompany" placeholder="ציין חברת ביטוח אחרת" type="text" style="display:none;" />

    <label style="display: block; text-align: right; margin-bottom: 5px; font-weight: bold;">אימייל חברת ביטוח:</label>
    <input id="insuranceEmail" placeholder="אימייל חברת ביטוח" type="email" autocomplete="email" />

    <label style="display: block; text-align: right; margin-bottom: 5px; font-weight: bold;">סוג נזק:</label>
    <select id="damageType">
      <option value="">בחר סוג נזק</option>
      <option value="תאונה">תאונה</option>
      <option value="שפשוף">שפשוף</option>
      <option value="פריצה">פריצה</option>
      <option value="נזק מזג אוויר">נזק מזג אוויר</option>
      <option value="הצפה">הצפה</option>
      <option value="שריפה">שריפה</option>
      <option value="אחר">אחר</option>
    </select>
    <input id="otherDamageType" placeholder="פירוט אחר" type="text" style="display:none;" />

    <button id="submitBtn">שמור פרטים</button>

    <!-- Return button -->
    <button class="btn-secondary" onclick="window.location.href='selection.html'">חזור לדף הבחירה</button>
    
    <!-- Success message and continue button (hidden initially) -->
    <div id="successSection" style="display: none; margin-top: 20px;">
      <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 15px; margin-bottom: 15px; color: #155724; text-align: center;">
        ✅ פרטים נשמרו בהצלחה
      </div>
      <button id="continueBtn" class="btn-success">
        המשך להעלאת דו"ח לוי יצחק
      </button>
    </div>

    <div class="footer">@2025 Carmel Cayouf. All rights reserved. SmartVal Pro System by Eval ©</div>
  </div>

  <!-- Vehicle popup removed to prevent redundant plate display -->

  <script type="module">
    import { sendToWebhook } from './webhook.js';
    import { updateHelperWithEvents } from './helper-events.js';
    // Legacy auth.js imports removed in Phase 6 - using Supabase Auth
    import { caseOwnershipService } from './services/caseOwnershipService.js';
    // SESSION 56: helper.js is NOT an ES6 module - use window.updateHelper, window.helper
    // import { helper, updateHelper, broadcastHelperUpdate } from './helper.js';
    
    // Phase 6: Case ownership check
    (async () => {
      const plateNumber = window.helper?.plate || sessionStorage.getItem('currentPlate');
      
      if (plateNumber) {
        const ownershipCheck = await caseOwnershipService.canEditCase(plateNumber);
        
        if (!ownershipCheck.canEdit) {
          alert(ownershipCheck.reason || 'אין לך הרשאה לערוך תיק זה.\n\nרק הבעלים, מנהל או מפתח יכולים לערוך.');
          window.location.href = 'selection.html';
          return;
        }
        
        console.log('✅ Case ownership verified - user can edit general info');
      }
    })();
    
    document.getElementById("insuranceCompany").addEventListener("change", function () {
      const otherInsurance = document.getElementById("otherInsuranceCompany");
      otherInsurance.style.display = this.value === "אחר" ? "block" : "none";
    });

    document.getElementById("damageType").addEventListener("change", function () {
      const otherInput = document.getElementById("otherDamageType");
      otherInput.style.display = this.value === "אחר" ? "block" : "none";
    });

    // Check Supabase authentication
    const authData = sessionStorage.getItem("auth");
    if (!authData) {
      alert("התחברות נדרשת");
      window.location.href = "index.html";
    }
    
    // Validate Supabase session
    let password = null;
    (async () => {
      try {
        const auth = JSON.parse(authData);
        if (auth.user && auth.session) {
          console.log('✅ Valid Supabase session for:', auth.user.email);
          // No password needed for Supabase auth - Phase 6
        } else {
          console.error('❌ Invalid auth data structure');
          alert("שגיאה באימות הזדהות - נדרשת התחברות מחדש");
          window.location.href = "index.html";
        }
      } catch (error) {
        console.error('❌ Auth validation failed:', error);
        alert("שגיאה באימות הזדהות");
        window.location.href = "index.html";
      }
    })();

    // ✅ FIXED: Use helper system instead of old carData
    let helperData = {};
    let plateNumber = '';
    
    try {
      console.log('🔄 PHASE 2.2: Loading general info data from helper ONLY (single source)...');
      
      // 🔧 PHASE 2.2: SINGLE SOURCE LOADING - window.helper is authoritative
      if (typeof window.helper === 'object' && window.helper !== null) {
        helperData = window.helper;
        console.log('✅ PHASE 2.2: Loaded general info from window.helper (authoritative source)');
      } else {
        // Emergency fallback: sessionStorage only if window.helper unavailable
        helperData = JSON.parse(sessionStorage.getItem("helper") || '{}');
        if (Object.keys(helperData).length > 0) {
          window.helper = helperData; // Sync to window.helper
          console.log('⚠️ PHASE 2.2: Emergency fallback - loaded from sessionStorage, synced to window.helper');
        }
      }
      
      plateNumber = helperData.meta?.plate || helperData.vehicle?.plate_number || '';
      
    } catch (e) {
      console.error('❌ PHASE 2.2: Error loading helper data:', e);
    }
    
    if (!plateNumber) {
      alert("יש לפתוח תיק לפני מילוי פרטים כלליים");
      window.location.href = "open-cases.html";
    }

    if (plateNumber) document.getElementById("pageTitle").innerText = `רכב מס. ${plateNumber}: פרטים כלליים`;
    
    // ✅ AUTO-POPULATE: Load data from helper into form fields
    setTimeout(() => {
      console.log('🔍 Attempting to auto-populate general info fields...');
      
      // 🔧 PHASE 2.2: Get helper data from single source (window.helper)
      const helperData = window.helper || {};
      console.log('📊 PHASE 2.2: Current helper data (from window.helper):', helperData);
      
      // 🔧 CLEAN DAMAGE DATE FIELD: Initialize independently from case_info.damage_date
      const damageDateField = document.getElementById('damage_date_independent');
      
      if (damageDateField) {
        // RESTORE: Load saved damage date if user manually entered it before
        if (window.helper?.case_info?.damage_date && window.helper?.meta?.damage_date_manual) {
          damageDateField.value = window.helper.case_info.damage_date;
          console.log('🔧 RESTORE: Loaded saved damage date from helper:', window.helper.case_info.damage_date);
        } else {
          // Start empty for new entry
          damageDateField.value = '';
          console.log('🔧 SIMPLE: Damage date field starts empty - user must enter manually');
        }
        
        // DIRECT: Add immediate event listener for damage date
        damageDateField.addEventListener('change', function() {
          console.log('🔥 DIRECT: Damage date changed to:', this.value);
          
          if (this.value) {
            // Try window.updateHelper first
            if (typeof window.updateHelper === 'function') {
              window.updateHelper('case_info', { damage_date: this.value }, 'general_info_direct');
              window.updateHelper('meta', { damage_date_manual: true }, 'general_info_direct');
              console.log('🔥 DIRECT: Saved damage date via updateHelper:', this.value);
            } else {
              console.error('❌ DIRECT: updateHelper function not found!');
            }
            
            // FALLBACK: Direct helper update
            if (window.helper) {
              if (!window.helper.case_info) window.helper.case_info = {};
              if (!window.helper.meta) window.helper.meta = {};
              
              window.helper.case_info.damage_date = this.value;
              window.helper.meta.damage_date_manual = true;
              
              // Save to sessionStorage
              try {
                sessionStorage.setItem('helper', JSON.stringify(window.helper));
                console.log('🔥 FALLBACK: Saved damage date directly to helper and sessionStorage:', this.value);
              } catch (e) {
                console.error('❌ FALLBACK: Failed to save to sessionStorage:', e);
              }
            }
            
            console.log('🔥 FINAL: Helper case_info now:', window.helper?.case_info);
          }
        });
      }
      
      // SESSION 56: helper.js is NOT an ES6 module - use window.refreshAllModuleForms
      import('./helper.js').then(helperModule => {
        
        if (typeof window.refreshAllModuleForms === 'function') {
          console.log('🔄 Calling refreshAllModuleForms...');
          window.refreshAllModuleForms();
          console.log('✅ General info fields auto-populated from helper');
          
          // 🔧 PRESERVE: Don't let auto-population interfere with damage date field
          const damageDateField = document.getElementById('damage_date_independent');
          if (damageDateField) {
            const currentValue = damageDateField.value;
            console.log('🔧 PRESERVE: Damage date field preserved during auto-population:', currentValue);
            // Don't change the damage date field - it's already set correctly above
          }
        } else {
          console.error('❌ refreshAllModuleForms function not found!');
        }
      }).catch(error => {
        console.error('❌ Could not import helper module:', error);
      });
    }, 500); // Small delay to ensure DOM is ready

    // Fix: Ensure garage email field is always editable
    const garageEmailField = document.getElementById("garage_email");
    if (garageEmailField) {
      garageEmailField.removeAttribute('readonly');
      garageEmailField.removeAttribute('disabled');
      garageEmailField.style.pointerEvents = 'auto';
      garageEmailField.style.backgroundColor = 'white';
      console.log('✅ Garage email field made editable');
    }

    // When saving, keep field names consistent with helper/contact structure
    document.getElementById("submitBtn").addEventListener("click", async () => {
      // Password not needed for Supabase auth - skip password check entirely
      
      // ✅ CENTRALIZED: Get plate and owner from centralized helper functions
      const plateFromHelper = window.getPlateNumber ? window.getPlateNumber() : '';
      const ownerFromHelper = window.getOwnerName ? window.getOwnerName() : '';
      
      const data = {
        plate: plateFromHelper,
        owner: document.getElementById("owner_name").value.trim() || ownerFromHelper,
        garageName: document.getElementById("garage_name").value.trim(),
        garagePhone: document.getElementById("garage_phone").value.trim(),
        garageEmail: document.getElementById("garage_email").value.trim(),
        agentName: document.getElementById("agent_name").value.trim(),
        insurance_agent_phone: document.getElementById("agent_phone").value.trim(),
        insurance_agent_email: document.getElementById("agent_email").value.trim(),
        insuranceCompany: (document.getElementById("insuranceCompany").value === "אחר" ? document.getElementById("otherInsuranceCompany").value.trim() : document.getElementById("insuranceCompany").value.trim()),
        insuranceEmail: document.getElementById("insuranceEmail").value.trim(),
        odo: document.getElementById("km").value.trim(),
        damageDate: (() => {
          const damageDate = document.getElementById("damage_date_independent").value;
          if (damageDate) {
            // Store damage date flag in helper instead of sessionStorage
            updateHelper('meta', { damage_date_manual: true }, 'general_info');
            console.log('✅ User manually entered damage date:', damageDate);
          }
          return damageDate;
        })(),
        ownerPhone: document.getElementById("owner_phone").value.trim(),
        ownerAddress: document.getElementById("owner_address").value.trim(),
        damageType: (document.getElementById("damageType").value === "אחר" ? document.getElementById("otherDamageType").value.trim() : document.getElementById("damageType").value.trim()),
        password: password
      };

      console.log("📤 Sending General Info:", data);

      try {
        // Show loading state
        document.getElementById("submitBtn").disabled = true;
        document.getElementById("submitBtn").innerText = "שומר נתונים...";
        
        // Phase 6: Capture user ID for tracking
        const { userId, userName } = caseOwnershipService.getCurrentUser();
        
        // Update helper with proper structure
        const stakeholdersData = {
          owner: {
            name: data.owner,
            phone: data.ownerPhone,
            address: data.ownerAddress
          },
          garage: {
            name: data.garageName,
            phone: data.garagePhone,
            email: data.garageEmail
          },
          insurance: {
            company: data.insuranceCompany,
            email: data.insuranceEmail,
            agent: {
              name: data.agentName,
              phone: data.insurance_agent_phone,
              email: data.insurance_agent_email
            }
          }
        };
        
        const vehicleData = {
          plate_number: data.plate,
          km: data.odo
        };
        
        const caseData = {
          damage_date: data.damageDate,
          damage_type: data.damageType
        };
        
        // Update helper sections
        window.updateHelper('stakeholders', stakeholdersData, 'general_info');
        window.updateHelper('vehicle', vehicleData, 'general_info');
        window.updateHelper('case_info', caseData, 'general_info');
        
        // Also update meta for completeness (including user tracking)
        window.updateHelper('meta', {
          last_updated: new Date().toISOString(),
          source: 'general_info_form',
          updated_by: userId,
          updated_by_name: userName
        }, 'general_info');
        
        // Force save to storage
        if (window.saveHelperToStorage) {
          window.saveHelperToStorage();
          console.log('✅ Helper data saved to storage');
        }
        
        // Broadcast update for other components
        if (window.broadcastHelperUpdate) {
          window.broadcastHelperUpdate('stakeholders', stakeholdersData);
          window.broadcastHelperUpdate('vehicle', vehicleData);
          window.broadcastHelperUpdate('case_info', caseData);
        }
        
        await sendToWebhook('FILL_FINAL_REPORT', data);
        showSuccessAndContinue();
      } catch (error) {
        // Reset button state on error
        document.getElementById("submitBtn").disabled = false;
        document.getElementById("submitBtn").innerText = "שמור פרטים";
        alert("שגיאת שליחה: " + error);
      }
    });

    function showSuccessAndContinue() {
      // Hide the form and show success section
      document.getElementById("submitBtn").style.display = "none";
      document.getElementById("successSection").style.display = "block";
      
      // Add continue button functionality
      document.getElementById("continueBtn").addEventListener("click", function() {
        window.location.href = "upload-levi.html";
      });
    }
  </script>
  <script type="module" src="helper-events.js"></script>
  <script src="internal-browser.js"></script>
  <script src="assistant-floating.js"></script>
  <script src="onesignal-integration.js"></script>
  <script type="module">
    // SESSION 56: helper.js is NOT an ES6 module - use window.helper, window.updateHelper
    // import { helper, updateHelper, broadcastHelperUpdate } from './helper.js';
    
    console.log('🚀 General info page loaded - checking for car data and auto-filling...');
    
    // ✅ SIMPLIFIED: Use helper system for auto-fill
    function checkAndAutoFillForm() {
      try {
        console.log('🔄 Auto-filling form from helper system...');
        
        // 🔧 PHASE 2.2: Get data from helper system (single source)
        const helperData = window.helper || {};
        
        if (helperData && (helperData.meta?.plate || helperData.vehicle?.plate_number)) {
          console.log('📋 Helper data found for auto-fill:', helperData);
          
          // Auto-fill using helper's populate function (already implemented above)
          // The helper.refreshAllModuleForms() call in the import section handles this
          
          // Show notification about auto-filled data - DISABLED to remove UI popups
          // showHelperDataNotification(helperData); // Commented out to prevent UI notifications
          console.log('✅ Auto-fill completed successfully (UI notification disabled)');
          
        } else {
          console.log('📋 No helper data available for auto-fill');
        }
        
      } catch (error) {
        console.error('Error checking helper data for auto-fill:', error);
      }
    }
    
    // Auto-fill form fields with car data (respects manual overrides)
    function autoFillFormFields(carData) {
      console.log('🖊️ Auto-filling form fields with car data:', carData);
      
      const fieldMappings = {
        'plate': ['plate', 'vehicle_number', 'car_number'],
        'manufacturer': ['manufacturer', 'make'],
        'model': ['model'],
        'owner': ['owner', 'owner_name', 'client_name'],
        'location': ['location']  // FIXED: Removed garage fields - garage is separate from location
      };
      
      let filledCount = 0;
      let skippedCount = 0;
      
      Object.entries(fieldMappings).forEach(([dataKey, fieldIds]) => {
        if (carData[dataKey]) {
          fieldIds.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field && !field.value) {
              // SESSION 56: helper.js doesn't have isFieldManuallyModified - skip this check
              import('./helper.js').then(module => {
                // if (window.isFieldManuallyModified && window.isFieldManuallyModified(fieldId)) {
                //   console.log(`⏭️ Skipping auto-fill for ${fieldId} - manually modified`);
                //   skippedCount++;
                //   return;
                // }
                
                field.value = carData[dataKey];
                field.style.background = '#e8f5e8'; // Light green to indicate auto-filled
                filledCount++;
                console.log(`✅ Auto-filled ${fieldId} with ${carData[dataKey]}`);
              }).catch(error => {
                // Fallback: fill without override protection if helper import fails
                field.value = carData[dataKey];
                field.style.background = '#e8f5e8';
                filledCount++;
                console.log(`✅ Auto-filled ${fieldId} with ${carData[dataKey]} (fallback)`);
              });
            }
          });
        }
      });
      
      if (filledCount > 0 || skippedCount > 0) {
        console.log(`✅ Auto-fill complete: ${filledCount} filled, ${skippedCount} skipped (manual override)`);
        
        // Update helper with the form data
        window.updateHelper('car_details', carData);
        window.updateHelper('meta', {
          plate: carData.plate,
          owner_name: carData.owner,
          inspection_location: carData.location
        });
      }
    }
    
    // ✅ REMOVED: showHelperDataNotification function to prevent page tilt issues
    
    // Check for car data when page loads
    window.addEventListener('load', function() {
      console.log('General info page DOM loaded');
      setTimeout(checkAndAutoFillForm, 1000);
    });
    
    // Also check periodically for the first 15 seconds in case data arrives later
    let checkCount = 0;
    const checkInterval = setInterval(() => {
      checkCount++;
      checkAndAutoFillForm();
      
      // Stop checking after 5 attempts (15 seconds)
      if (checkCount >= 5) {
        clearInterval(checkInterval);
      }
    }, 3000);
    
    // ✅ MANUAL INPUT OVERRIDE SYSTEM: Add listeners to all form fields
    // This detects when user manually modifies fields and prevents automatic overrides
    function initializeManualOverrideDetection() {
      console.log('🔒 Initializing manual override detection for general info form');
      
      // List of all form fields that should be tracked for manual input
      const trackedFields = [
        'km', 'damage_date_independent', 'owner_name', 'owner_phone', 'owner_address',
        'garage_name', 'garage_phone', 'garage_email',
        'agent_name', 'agent_phone', 'agent_email',
        'insuranceCompany', 'otherInsuranceCompany',
        'insuranceEmail', 'damageType', 'otherDamageType'
      ];
      
      trackedFields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element) {
          // Add event listeners for manual input detection
          ['input', 'change', 'keyup', 'paste'].forEach(eventType => {
            element.addEventListener(eventType, function(event) {
              // Only mark as manual if user is actively typing/changing
              if (event.isTrusted && this.value !== this.defaultValue) {
                // Special handling for damage_date_independent field
                if (fieldId === 'damage_date_independent' && this.value) {
                  console.log('🔥 SIMPLE: User entered damage date:', this.value);
                  window.updateHelper('meta', { damage_date_manual: true }, 'general_info');
                  window.updateHelper('case_info', { damage_date: this.value }, 'general_info');
                  console.log('🔥 SIMPLE: Damage date saved to helper.case_info.damage_date:', this.value);
                  console.log('🔥 SIMPLE: Current helper.case_info:', window.helper?.case_info);
                }
                
                import('./helper.js').then(module => {
                  if (typeof window.markFieldAsManuallyModified === 'function') {
                    window.markFieldAsManuallyModified(fieldId, this.value, 'general_info');
                  }
                }).catch(error => {
                  console.error('Error importing helper for manual override:', error);
                });
              }
            }, { passive: true });
          });
          
          // Also detect focus events (user clicking into field)
          element.addEventListener('focus', function() {
            this.dataset.userFocused = 'true';
          });
          
          // Mark as manually modified when user leaves field with changes
          element.addEventListener('blur', function() {
            if (this.dataset.userFocused === 'true' && this.value !== this.defaultValue) {
              import('./helper.js').then(module => {
                if (typeof window.markFieldAsManuallyModified === 'function') {
                  window.markFieldAsManuallyModified(fieldId, this.value, 'general_info');
                }
              }).catch(error => {
                console.error('Error importing helper for manual override:', error);
              });
            }
            delete this.dataset.userFocused;
          });
          
          console.log(`✅ Manual override detection added to field: ${fieldId}`);
        }
      });
      
      console.log(`🔒 Manual override detection initialized for ${trackedFields.length} fields`);
    }
    
    // Initialize manual override detection when page loads
    document.addEventListener('DOMContentLoaded', initializeManualOverrideDetection);
    
  </script>
  <script src="helper.js" type="module"></script>
  <script src="universal-data-sync.js"></script>
  <script src="universal-data-capture.js" type="module"></script>
  <script src="force-populate-forms.js"></script>
<!-- 🚀 DATA CAPTURE ENGINE - Simple solution -->
<script src="data-capture-engine.js"></script>
<script src="services/autoSaveService.js" type="module"></script>

</body>
</html>
