<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug is_current Values</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f5f5f5; text-align: right; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .result { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 4px; border: 1px solid #ddd; white-space: pre-line; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .success { background: #d4edda; border-color: #c3e6cb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Debug is_current Values</h1>
        
        <button onclick="checkCurrentFlags()">בדוק כל ה-is_current values</button>
        <button onclick="fixCurrentFlags()">תקן is_current flags</button>
        
        <div id="results"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://nvqrptokmwdhvpiufrad.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52cXJwdG9rbXdkaHZwaXVmcmFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzU0ODUsImV4cCI6MjA3MTYxMTQ4NX0.yvFalmZE7Xpvo_j6wzRj44Pa7Bx9LQegcyLzbz3QL5s';
        
        window.checkCurrentFlags = async function() {
            addResult('בודק כל ה-is_current flags...', 'info');
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/case_helper?select=id,case_id,helper_name,version,is_current,updated_at&order=updated_at.desc`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('שגיאה בשליפת נתונים');
                }
                
                const data = await response.json();
                
                let result = `נמצאו ${data.length} helpers:\n\n`;
                
                // Group by case_id
                const groupedByCaseId = {};
                data.forEach(helper => {
                    if (!groupedByCaseId[helper.case_id]) {
                        groupedByCaseId[helper.case_id] = [];
                    }
                    groupedByCaseId[helper.case_id].push(helper);
                });
                
                Object.keys(groupedByCaseId).forEach(caseId => {
                    const helpers = groupedByCaseId[caseId];
                    const currentHelpers = helpers.filter(h => h.is_current);
                    
                    result += `Case ID: ${caseId}\n`;
                    result += `  Total helpers: ${helpers.length}\n`;
                    result += `  Current helpers: ${currentHelpers.length}\n`;
                    
                    if (currentHelpers.length !== 1) {
                        result += `  ❌ PROBLEM: Should have exactly 1 current helper, found ${currentHelpers.length}\n`;
                    }
                    
                    helpers.forEach(h => {
                        result += `  - ${h.helper_name} | is_current: ${h.is_current} | updated: ${h.updated_at}\n`;
                    });
                    result += '\n';
                });
                
                addResult(result, 'success');
                
            } catch (error) {
                addResult(`❌ שגיאה: ${error.message}`, 'error');
            }
        };
        
        window.fixCurrentFlags = async function() {
            const confirmed = confirm('האם אתה רוצה לתקן את ה-is_current flags?\n\nזה יגדיר רק את הגרסה האחרונה של כל case כ-current.');
            if (!confirmed) return;
            
            addResult('מתקן is_current flags...', 'info');
            try {
                // First, set all to false
                const updateAllResponse = await fetch(`${SUPABASE_URL}/rest/v1/case_helper`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_current: false })
                });
                
                if (!updateAllResponse.ok) {
                    throw new Error('שגיאה בעדכון כללי');
                }
                
                // Get all helpers grouped by case_id
                const response = await fetch(`${SUPABASE_URL}/rest/v1/case_helper?select=id,case_id,helper_name,updated_at&order=case_id,updated_at.desc`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                const data = await response.json();
                
                // Group by case_id and set latest as current
                const groupedByCaseId = {};
                data.forEach(helper => {
                    if (!groupedByCaseId[helper.case_id]) {
                        groupedByCaseId[helper.case_id] = [];
                    }
                    groupedByCaseId[helper.case_id].push(helper);
                });
                
                let fixed = 0;
                for (const caseId of Object.keys(groupedByCaseId)) {
                    const helpers = groupedByCaseId[caseId];
                    const latestHelper = helpers[0]; // First is latest due to desc order
                    
                    const updateResponse = await fetch(`${SUPABASE_URL}/rest/v1/case_helper?id=eq.${latestHelper.id}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ is_current: true })
                    });
                    
                    if (updateResponse.ok) {
                        fixed++;
                    }
                }
                
                addResult(`✅ תוקן! ${fixed} cases עם is_current מתוקן`, 'success');
                
            } catch (error) {
                addResult(`❌ שגיאה: ${error.message}`, 'error');
            }
        };
        
        function addResult(text, type) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = text;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }
    </script>
</body>
</html>