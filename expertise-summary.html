<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>סיום האקספרטיזה - ירון כיוף</title>
  <link rel="icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" type="image/webp" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #1e293b 100%);
      background-attachment: fixed;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* Animated background particles */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image:
        radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
      animation: float 20s ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes float {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.1); }
    }

    .container {
      max-width: 650px;
      width: 100%;
      background: rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(20px);
      padding: 40px 35px;
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .logo img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      margin-bottom: 20px;
      border: 3px solid rgba(99, 102, 241, 0.3);
      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
      animation: logoGlow 3s ease-in-out infinite;
    }

    @keyframes logoGlow {
      0%, 100% { box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3); }
      50% { box-shadow: 0 8px 32px rgba(139, 92, 246, 0.5); }
    }

    .title {
      font-size: 26px;
      font-weight: 700;
      background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    .subtitle {
      font-size: 16px;
      color: #94a3b8;
      margin-bottom: 25px;
      font-weight: 500;
    }

    h2 {
      font-size: 22px;
      color: #e0e7ff;
      margin-bottom: 30px;
      font-weight: 600;
    }

    label {
      display: block;
      text-align: right;
      margin-top: 18px;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #cbd5e1;
    }

    select, input, textarea {
      width: 100%;
      padding: 14px 16px;
      margin-top: 8px;
      font-size: 15px;
      border-radius: 12px;
      border: 1.5px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      color: #e2e8f0;
      box-sizing: border-box;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: inherit;
    }

    select option {
      background: #1e293b;
      color: #e2e8f0;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
      line-height: 1.5;
    }

    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: #6366f1;
      background: rgba(255, 255, 255, 0.08);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1), 0 8px 16px rgba(0, 0, 0, 0.2);
      transform: translateY(-2px);
    }

    .footer {
      margin-top: 35px;
      padding-top: 25px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 11px;
      color: #64748b;
      font-weight: 500;
      letter-spacing: 0.3px;
    }

    .note-box {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      text-align: right;
      margin-top: 25px;
      display: none;
      color: #cbd5e1;
    }

    /* Navigation Buttons Styling */
    .nav-btn {
      padding: 14px 18px;
      border: none;
      border-radius: 14px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: inherit;
      font-size: 14px;
      position: relative;
      overflow: hidden;
    }

    .nav-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .nav-btn:hover::before {
      left: 100%;
    }

    .nav-btn:hover {
      transform: translateY(-2px);
    }

    .nav-btn:active {
      transform: translateY(0);
    }

    .save-btn {
      background: linear-gradient(135deg, #10b981, #059669);
      box-shadow: 0 4px 14px rgba(16, 185, 129, 0.4);
    }

    .save-btn:hover {
      background: linear-gradient(135deg, #059669, #047857);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
    }

    .preview-btn {
      background: linear-gradient(135deg, #06b6d4, #0891b2);
      box-shadow: 0 4px 14px rgba(6, 182, 212, 0.4);
    }

    .preview-btn:hover {
      background: linear-gradient(135deg, #0891b2, #0e7490);
      box-shadow: 0 6px 20px rgba(6, 182, 212, 0.5);
    }

    .generate-btn {
      background: linear-gradient(135deg, #6366f1, #4f46e5);
      box-shadow: 0 4px 14px rgba(99, 102, 241, 0.4);
    }

    .generate-btn:hover {
      background: linear-gradient(135deg, #4f46e5, #4338ca);
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
    }

    .back-btn {
      background: linear-gradient(135deg, #64748b, #475569);
      box-shadow: 0 4px 14px rgba(100, 116, 139, 0.4);
    }

    .back-btn:hover {
      background: linear-gradient(135deg, #475569, #334155);
      box-shadow: 0 6px 20px rgba(100, 116, 139, 0.5);
    }

    .form-section {
      margin-top: 30px;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .container {
        padding: 30px 25px;
      }

      .form-section > div {
        grid-template-columns: 1fr !important;
        gap: 10px !important;
      }

      .logo img {
        width: 80px;
        height: 80px;
      }

      .title {
        font-size: 22px;
      }

      h2 {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo"><img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo"/></div>
    <div class="title">ירון כיוף - שמאות וייעוץ</div>
    <div class="subtitle">שמאות והערכת נזקי רכב ורכוש</div>
    <h2 id="pageTitle">סיום האקספרטיזה לרכב מס׳ ...</h2>

    <label for="directive">הנחיית תיק / סטטוס תיק</label>
    <select id="directive">
      <option value="">ללא סטטוס</option>
      <option>לתיקון</option>
      <option>טוטאלוס TL</option>
      <option>לא לתיקון בשלב זה להכין הצעת מחיר</option>
      <option>אובדן להלכה</option>
      <option>מכירה במצבו הניזוק</option>
      <option>להכין הצעת מחיר</option>
    </select>

    <label for="technician">שם השמאי:</label>
    <select id="technician">
      <option>ירון כיוף</option>
    </select>

    <label for="license">מספר רישיון:</label>
    <select id="license">
      <option>1097</option>
    </select>

    <label for="expertiseDate">תאריך האקספרטיזה:</label>
    <input type="date" id="expertiseDate" style="text-align: center;" onchange="saveExpertiseDate()">

    <label for="summaryNotes">הערות נוספות:</label>
    <textarea id="summaryNotes" placeholder="תיאור, המלצות, הערות כלליות"></textarea>

    <!-- New button layout matching estimate-builder.html -->
    <div class="form-section">
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
        <button type="button" class="nav-btn save-btn" onclick="saveExpertise()">שמור אקספירטיזה</button>
        <button type="button" class="nav-btn preview-btn" onclick="previewExpertise()">תצוגה מקדימה</button>
        <button type="button" class="nav-btn generate-btn" onclick="generateExpertise()">צור אקספירטיזה</button>
        <button type="button" class="nav-btn back-btn" onclick="window.location.href='selection.html'">חזור לדף הבחירה</button>
      </div>
    </div>

    <div class="footer">@2025 Carmel Cayouf. All rights reserved. SmartVal Pro System by Eval ©</div>
  </div>

  <script type="module">
    import { sendToWebhook } from './webhook.js';
    import { caseOwnershipService } from './services/caseOwnershipService.js';
    
    // Phase 6: Case ownership check
    (async () => {
      const plateNumber = window.helper?.plate || sessionStorage.getItem('currentPlate');
      
      if (plateNumber) {
        const ownershipCheck = await caseOwnershipService.canEditCase(plateNumber);
        
        if (!ownershipCheck.canEdit) {
          alert(ownershipCheck.reason || 'אין לך הרשאה לערוך תיק זה.\n\nרק הבעלים, מנהל או מפתח יכולים לערוך.');
          window.location.href = 'selection.html';
          return;
        }
        
        console.log('✅ Case ownership verified - user can edit expertise summary');
      }
    })();
    
    // Get helper from window or sessionStorage
    const helper = window.helper || JSON.parse(sessionStorage.getItem('helper') || '{}');
    const plate = helper?.vehicle?.plate || sessionStorage.getItem('plate') || 'לא ידוע';
    const date = new Date().toLocaleDateString('he-IL');
    document.getElementById('pageTitle').innerText = `סיום האקספרטיזה לרכב מס׳ ${plate}`;
    
    // Populate form fields from saved data
    function populateFormFromHelper() {
      // Get fresh helper data each time
      const currentHelper = window.helper || JSON.parse(sessionStorage.getItem('helper') || '{}');
      const savedSummary = currentHelper?.expertise?.summary;
      console.log('Loading saved summary data:', savedSummary);
      
      if (savedSummary) {
        // Set directive/status
        if (savedSummary.directive) {
          const directiveSelect = document.getElementById('directive');
          directiveSelect.value = savedSummary.directive;
        }
        
        // Set technician
        if (savedSummary.technician) {
          const technicianSelect = document.getElementById('technician');
          technicianSelect.value = savedSummary.technician;
        }
        
        // Set license
        if (savedSummary.license) {
          const licenseSelect = document.getElementById('license');
          licenseSelect.value = savedSummary.license;
        }
        
        // Set expertise date
        if (savedSummary.expertise_date) {
          const dateInput = document.getElementById('expertiseDate');
          dateInput.value = savedSummary.expertise_date;
        }
        
        // Set notes
        if (savedSummary.notes) {
          const notesTextarea = document.getElementById('summaryNotes');
          notesTextarea.value = savedSummary.notes;
        }
        
        console.log('Form populated with saved data');
      }
      
      // If no expertise date is saved yet, default to inspection date
      const dateInput = document.getElementById('expertiseDate');
      if (!dateInput.value && currentHelper?.case_info?.inspection_date) {
        // Convert inspection_date to YYYY-MM-DD format for date input
        const inspectionDate = new Date(currentHelper.case_info.inspection_date);
        if (!isNaN(inspectionDate)) {
          const formattedDate = inspectionDate.toISOString().split('T')[0];
          dateInput.value = formattedDate;
          
          // Auto-save this default date
          if (!currentHelper.expertise) {
            currentHelper.expertise = {};
          }
          if (!currentHelper.expertise.summary) {
            currentHelper.expertise.summary = {};
          }
          currentHelper.expertise.summary.expertise_date = formattedDate;
          
          // Update helper
          window.helper = currentHelper;
          sessionStorage.setItem('helper', JSON.stringify(currentHelper));
          
          console.log('Auto-populated expertise date from inspection date:', formattedDate);
        }
      }
    }
    
    // Wait for DOM to be ready, then populate form
    // Also wait a bit for helper.js to load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(populateFormFromHelper, 100);
      });
    } else {
      setTimeout(populateFormFromHelper, 100);
    }

    // Save expertise date when changed
    window.saveExpertiseDate = function() {
      const helper = window.helper || JSON.parse(sessionStorage.getItem('helper') || '{}');
      const dateValue = document.getElementById('expertiseDate').value;
      
      // Phase 6: Capture user ID
      const { userId, userName } = caseOwnershipService.getCurrentUser();
      
      // Initialize expertise section if needed
      if (!helper.expertise) {
        helper.expertise = {};
      }
      if (!helper.expertise.summary) {
        helper.expertise.summary = {};
      }
      
      // Save the date
      helper.expertise.summary.expertise_date = dateValue;
      
      // Add user tracking
      if (!helper.meta) helper.meta = {};
      helper.meta.updated_by = userId;
      helper.meta.updated_by_name = userName;
      helper.meta.last_updated = new Date().toISOString();
      
      // Update helper in window and sessionStorage
      window.helper = helper;
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      console.log('Expertise date saved:', dateValue);
    };

    // New button functions matching estimate-builder.html pattern
    window.saveExpertise = function() {
      // Get current helper object
      const helper = window.helper || JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Phase 6: Capture user ID
      const { userId, userName } = caseOwnershipService.getCurrentUser();
      
      // Create expertise summary data
      const summaryData = {
        directive: document.getElementById('directive').value,
        technician: document.getElementById('technician').value,
        license: document.getElementById('license').value,
        expertise_date: document.getElementById('expertiseDate').value,
        notes: document.getElementById('summaryNotes').value,
        status: document.getElementById('directive').value || 'בתהליך',
        completed_at: new Date().toISOString(),
        plate: plate
      };
      
      // Initialize expertise section if it doesn't exist
      if (!helper.expertise) {
        helper.expertise = {};
      }
      
      // Save to helper.expertise.summary
      helper.expertise.summary = summaryData;
      
      // Add user tracking
      if (!helper.meta) helper.meta = {};
      helper.meta.updated_by = userId;
      helper.meta.updated_by_name = userName;
      helper.meta.last_updated = new Date().toISOString();
      
      // Update helper in window and sessionStorage
      window.helper = helper;
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      // Also send to webhook for persistence
      const payload = {
        ...summaryData,
        action: 'save_expertise_summary',
        submittedAt: new Date().toISOString()
      };
      
      sendToWebhook('SAVE_EXPERTISE_SUMMARY', payload)
        .then(() => {
          console.log('Summary saved to helper:', helper.expertise.summary);
          alert("האקספירטיזה נשמרה בהצלחה.");
        })
        .catch((error) => {
          console.error('Error saving expertise summary:', error);
          // Still show success since we saved to helper locally
          alert("האקספירטיזה נשמרה מקומית בהצלחה.");
        });
    };

    window.previewExpertise = function() {
      // Get current helper object
      const helper = window.helper || JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Create expertise summary data
      const summaryData = {
        directive: document.getElementById('directive').value,
        technician: document.getElementById('technician').value,
        license: document.getElementById('license').value,
        notes: document.getElementById('summaryNotes').value,
        status: document.getElementById('directive').value || 'בתצוגה מקדימה',
        completed_at: new Date().toISOString(),
        plate: plate
      };
      
      // Initialize expertise section if it doesn't exist
      if (!helper.expertise) {
        helper.expertise = {};
      }
      
      // Save to helper.expertise.summary
      helper.expertise.summary = summaryData;
      
      // Update helper in window and sessionStorage
      window.helper = helper;
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      // Store in session for legacy compatibility
      sessionStorage.setItem('expertiseSummaryData', JSON.stringify(summaryData));
      
      // Open preview in PiP modal
      openExpertisePreviewPiP('expertise builder.html', 'תצוגה מקדימה - אקספרטיזה');
    };

    window.generateExpertise = function() {
      // Get current helper object
      const helper = window.helper || JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Create expertise summary data
      const summaryData = {
        directive: document.getElementById('directive').value,
        technician: document.getElementById('technician').value,
        license: document.getElementById('license').value,
        notes: document.getElementById('summaryNotes').value,
        status: 'נוצר',
        completed_at: new Date().toISOString(),
        plate: plate
      };
      
      // Initialize expertise section if it doesn't exist
      if (!helper.expertise) {
        helper.expertise = {};
      }
      
      // Save to helper.expertise.summary
      helper.expertise.summary = summaryData;
      
      // Update helper in window and sessionStorage
      window.helper = helper;
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      const payload = {
        ...summaryData,
        action: 'generate_expertise',
        submittedAt: new Date().toISOString()
      };
      
      sendToWebhook('LAUNCH_EXPERTISE', payload)
        .then(() => {
          console.log('Expertise generated with summary:', helper.expertise.summary);
          alert("האקספירטיזה נוצרה בהצלחה.");
          // Redirect to validation page after successful generation
          window.location.href = 'expertise-validation.html';
        })
        .catch((error) => {
          console.error('Error generating expertise:', error);
          // Still redirect since we saved locally
          alert("האקספירטיזה נוצרה מקומית בהצלחה.");
          window.location.href = 'expertise-validation.html';
        });
    };

    // Expertise Preview PiP function
    function openExpertisePreviewPiP(url, title) {
      // Create floating modal for expertise preview
      const modal = document.createElement('div');
      modal.id = 'expertisePreviewModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.8);
        z-index: 99999;
        display: flex;
        justify-content: center;
        align-items: center;
      `;
      
      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        width: 95vw;
        height: 95vh;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        position: relative;
      `;
      
      const modalHeader = document.createElement('div');
      modalHeader.style.cssText = `
        background: #2c3e50;
        color: white;
        padding: 15px 20px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
        direction: rtl;
      `;
      modalHeader.innerHTML = `
        <span>${title}</span>
        <button onclick="closeExpertisePreviewPiP()" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold;">✕ סגור</button>
      `;
      
      const iframe = document.createElement('iframe');
      iframe.style.cssText = `
        width: 100%;
        height: calc(100% - 60px);
        border: none;
        border-radius: 0 0 12px 12px;
      `;
      iframe.src = url;
      
      modalContent.appendChild(modalHeader);
      modalContent.appendChild(iframe);
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      
      // Close modal when clicking outside
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeExpertisePreviewPiP();
        }
      });
    }

    window.closeExpertisePreviewPiP = function() {
      const modal = document.getElementById('expertisePreviewModal');
      if (modal) {
        modal.remove();
      }
    };
  </script>
  
  <!-- Helper integration -->
  <script type="module" src="./helper.js"></script>
  
  <!-- Floating screens integration -->
  <script src="car-details-floating.js"></script>
  <script src="levi-floating.js"></script>
  <script src="parts-search-results-floating.js"></script>
  <script src="internal-browser.js"></script>
</body>
</html>
