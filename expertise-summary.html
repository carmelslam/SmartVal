<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>סיום האקספרטיזה - ירון כיוף</title>
  <link rel="icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" type="image/webp" />
  <style>
    body {
      font-family: 'Assistant', sans-serif;
      background: #f3f6fb;
      margin: 0;
      padding: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      max-width: 600px;
      width: 100%;
      background: white;
      padding: 40px 30px;
      border-radius: 16px;
      text-align: center;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }
    .logo img {
      width: 120px;
      margin-bottom: 20px;
    }
    h2 {
      font-size: 22px;
      color: #007bff;
      margin-bottom: 25px;
    }
    label {
      display: block;
      text-align: right;
      margin-top: 10px;
      font-size: 14px;
      font-weight: bold;
    }
    select, input, textarea, button {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    textarea { resize: vertical; height: 60px; }
    button {
      background: #007bff;
      color: white;
      font-weight: bold;
      margin-top: 20px;
      cursor: pointer;
      border: none;
    }
    .footer {
      margin-top: 30px;
      font-size: 12px;
      color: #999;
    }
    .note-box {
      background: #f4f4f4;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
      text-align: right;
      margin-top: 25px;
      display: none;
    }
    
    /* Navigation Buttons Styling */
    .nav-btn {
      padding: 12px 16px;
      border: none;
      border-radius: 10px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .nav-btn:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .save-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    .save-btn:hover {
      background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
      transform: translateY(-2px);
    }
    .preview-btn {
      background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
    }
    .preview-btn:hover {
      background: linear-gradient(135deg, #138496 0%, #1ea085 100%);
      transform: translateY(-2px);
    }
    .generate-btn {
      background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);
    }
    .generate-btn:hover {
      background: linear-gradient(135deg, #0056b3 0%, #520dc2 100%);
      transform: translateY(-2px);
    }
    .back-btn {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    }
    .back-btn:hover {
      background: linear-gradient(135deg, #545b62 0%, #3d4142 100%);
      transform: translateY(-2px);
    }
    .form-section {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo"><img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="Logo"/></div>
    <div class="title" style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">ירון כיוף - פורטל שמאות</div>
    <div class="subtitle" style="font-size: 18px; color: #666; margin-bottom: 20px;">שמאות והערכת נזקי רכב ורכוש</div>
    <h2 id="pageTitle">סיום האקספרטיזה לרכב מס׳ ...</h2>

    <label for="directive">הנחיית תיק / סטטוס תיק</label>
    <select id="directive">
      <option value="">ללא סטטוס</option>
      <option>לתיקון</option>
      <option>טוטאלוס TL</option>
      <option>לא לתיקון בשלב זה להכין הצעת מחיר</option>
      <option>אובדן להלכה</option>
      <option>מכירה במצבו הניזוק</option>
      <option>להכין הצעת מחיר</option>
    </select>

    <label for="technician">שם השמאי:</label>
    <select id="technician">
      <option>ירון כיוף</option>
    </select>

    <label for="license">מספר רישיון:</label>
    <select id="license">
      <option>1097</option>
    </select>

    <label for="expertiseDate">תאריך האקספרטיזה:</label>
    <input type="date" id="expertiseDate" style="text-align: center;" onchange="saveExpertiseDate()">

    <label for="summaryNotes">הערות נוספות:</label>
    <textarea id="summaryNotes" placeholder="תיאור, המלצות, הערות כלליות"></textarea>

    <!-- New button layout matching estimate-builder.html -->
    <div class="form-section">
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
        <button type="button" class="nav-btn save-btn" onclick="saveExpertise()">שמור אקספירטיזה</button>
        <button type="button" class="nav-btn preview-btn" onclick="previewExpertise()">תצוגה מקדימה</button>
        <button type="button" class="nav-btn generate-btn" onclick="generateExpertise()">צור אקספירטיזה</button>
        <button type="button" class="nav-btn back-btn" onclick="window.location.href='selection.html'">חזור לדף הבחירה</button>
      </div>
    </div>

    <div class="footer">All rights reserved © Carmel Cayouf</div>
  </div>

  <script type="module">
    import { sendToWebhook } from './webhook.js';
    // Get helper from window or sessionStorage
    const helper = window.helper || JSON.parse(sessionStorage.getItem('helper') || '{}');
    const plate = helper?.vehicle?.plate || sessionStorage.getItem('plate') || 'לא ידוע';
    const date = new Date().toLocaleDateString('he-IL');
    document.getElementById('pageTitle').innerText = `סיום האקספרטיזה לרכב מס׳ ${plate}`;
    
    // Populate form fields from saved data
    function populateFormFromHelper() {
      // Get fresh helper data each time
      const currentHelper = window.helper || JSON.parse(sessionStorage.getItem('helper') || '{}');
      const savedSummary = currentHelper?.expertise?.summary;
      console.log('Loading saved summary data:', savedSummary);
      
      if (savedSummary) {
        // Set directive/status
        if (savedSummary.directive) {
          const directiveSelect = document.getElementById('directive');
          directiveSelect.value = savedSummary.directive;
        }
        
        // Set technician
        if (savedSummary.technician) {
          const technicianSelect = document.getElementById('technician');
          technicianSelect.value = savedSummary.technician;
        }
        
        // Set license
        if (savedSummary.license) {
          const licenseSelect = document.getElementById('license');
          licenseSelect.value = savedSummary.license;
        }
        
        // Set expertise date
        if (savedSummary.expertise_date) {
          const dateInput = document.getElementById('expertiseDate');
          dateInput.value = savedSummary.expertise_date;
        }
        
        // Set notes
        if (savedSummary.notes) {
          const notesTextarea = document.getElementById('summaryNotes');
          notesTextarea.value = savedSummary.notes;
        }
        
        console.log('Form populated with saved data');
      }
      
      // If no expertise date is saved yet, default to inspection date
      const dateInput = document.getElementById('expertiseDate');
      if (!dateInput.value && currentHelper?.case_info?.inspection_date) {
        // Convert inspection_date to YYYY-MM-DD format for date input
        const inspectionDate = new Date(currentHelper.case_info.inspection_date);
        if (!isNaN(inspectionDate)) {
          const formattedDate = inspectionDate.toISOString().split('T')[0];
          dateInput.value = formattedDate;
          
          // Auto-save this default date
          if (!currentHelper.expertise) {
            currentHelper.expertise = {};
          }
          if (!currentHelper.expertise.summary) {
            currentHelper.expertise.summary = {};
          }
          currentHelper.expertise.summary.expertise_date = formattedDate;
          
          // Update helper
          window.helper = currentHelper;
          sessionStorage.setItem('helper', JSON.stringify(currentHelper));
          
          console.log('Auto-populated expertise date from inspection date:', formattedDate);
        }
      }
    }
    
    // Wait for DOM to be ready, then populate form
    // Also wait a bit for helper.js to load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(populateFormFromHelper, 100);
      });
    } else {
      setTimeout(populateFormFromHelper, 100);
    }

    // Save expertise date when changed
    window.saveExpertiseDate = function() {
      const helper = window.helper || JSON.parse(sessionStorage.getItem('helper') || '{}');
      const dateValue = document.getElementById('expertiseDate').value;
      
      // Initialize expertise section if needed
      if (!helper.expertise) {
        helper.expertise = {};
      }
      if (!helper.expertise.summary) {
        helper.expertise.summary = {};
      }
      
      // Save the date
      helper.expertise.summary.expertise_date = dateValue;
      
      // Update helper in window and sessionStorage
      window.helper = helper;
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      console.log('Expertise date saved:', dateValue);
    };

    // New button functions matching estimate-builder.html pattern
    window.saveExpertise = function() {
      // Get current helper object
      const helper = window.helper || JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Create expertise summary data
      const summaryData = {
        directive: document.getElementById('directive').value,
        technician: document.getElementById('technician').value,
        license: document.getElementById('license').value,
        expertise_date: document.getElementById('expertiseDate').value,
        notes: document.getElementById('summaryNotes').value,
        status: document.getElementById('directive').value || 'בתהליך',
        completed_at: new Date().toISOString(),
        plate: plate
      };
      
      // Initialize expertise section if it doesn't exist
      if (!helper.expertise) {
        helper.expertise = {};
      }
      
      // Save to helper.expertise.summary
      helper.expertise.summary = summaryData;
      
      // Update helper in window and sessionStorage
      window.helper = helper;
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      // Also send to webhook for persistence
      const payload = {
        ...summaryData,
        action: 'save_expertise_summary',
        submittedAt: new Date().toISOString()
      };
      
      sendToWebhook('SAVE_EXPERTISE_SUMMARY', payload)
        .then(() => {
          console.log('Summary saved to helper:', helper.expertise.summary);
          alert("האקספירטיזה נשמרה בהצלחה.");
        })
        .catch((error) => {
          console.error('Error saving expertise summary:', error);
          // Still show success since we saved to helper locally
          alert("האקספירטיזה נשמרה מקומית בהצלחה.");
        });
    };

    window.previewExpertise = function() {
      // Get current helper object
      const helper = window.helper || JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Create expertise summary data
      const summaryData = {
        directive: document.getElementById('directive').value,
        technician: document.getElementById('technician').value,
        license: document.getElementById('license').value,
        notes: document.getElementById('summaryNotes').value,
        status: document.getElementById('directive').value || 'בתצוגה מקדימה',
        completed_at: new Date().toISOString(),
        plate: plate
      };
      
      // Initialize expertise section if it doesn't exist
      if (!helper.expertise) {
        helper.expertise = {};
      }
      
      // Save to helper.expertise.summary
      helper.expertise.summary = summaryData;
      
      // Update helper in window and sessionStorage
      window.helper = helper;
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      // Store in session for legacy compatibility
      sessionStorage.setItem('expertiseSummaryData', JSON.stringify(summaryData));
      
      // Open preview in PiP modal
      openExpertisePreviewPiP('expertise builder.html', 'תצוגה מקדימה - אקספרטיזה');
    };

    window.generateExpertise = function() {
      // Get current helper object
      const helper = window.helper || JSON.parse(sessionStorage.getItem('helper') || '{}');
      
      // Create expertise summary data
      const summaryData = {
        directive: document.getElementById('directive').value,
        technician: document.getElementById('technician').value,
        license: document.getElementById('license').value,
        notes: document.getElementById('summaryNotes').value,
        status: 'נוצר',
        completed_at: new Date().toISOString(),
        plate: plate
      };
      
      // Initialize expertise section if it doesn't exist
      if (!helper.expertise) {
        helper.expertise = {};
      }
      
      // Save to helper.expertise.summary
      helper.expertise.summary = summaryData;
      
      // Update helper in window and sessionStorage
      window.helper = helper;
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      const payload = {
        ...summaryData,
        action: 'generate_expertise',
        submittedAt: new Date().toISOString()
      };
      
      sendToWebhook('LAUNCH_EXPERTISE', payload)
        .then(() => {
          console.log('Expertise generated with summary:', helper.expertise.summary);
          alert("האקספירטיזה נוצרה בהצלחה.");
          // Redirect to validation page after successful generation
          window.location.href = 'expertise-validation.html';
        })
        .catch((error) => {
          console.error('Error generating expertise:', error);
          // Still redirect since we saved locally
          alert("האקספירטיזה נוצרה מקומית בהצלחה.");
          window.location.href = 'expertise-validation.html';
        });
    };

    // Expertise Preview PiP function
    function openExpertisePreviewPiP(url, title) {
      // Create floating modal for expertise preview
      const modal = document.createElement('div');
      modal.id = 'expertisePreviewModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.8);
        z-index: 99999;
        display: flex;
        justify-content: center;
        align-items: center;
      `;
      
      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        width: 95vw;
        height: 95vh;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        position: relative;
      `;
      
      const modalHeader = document.createElement('div');
      modalHeader.style.cssText = `
        background: #2c3e50;
        color: white;
        padding: 15px 20px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
        direction: rtl;
      `;
      modalHeader.innerHTML = `
        <span>${title}</span>
        <button onclick="closeExpertisePreviewPiP()" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold;">✕ סגור</button>
      `;
      
      const iframe = document.createElement('iframe');
      iframe.style.cssText = `
        width: 100%;
        height: calc(100% - 60px);
        border: none;
        border-radius: 0 0 12px 12px;
      `;
      iframe.src = url;
      
      modalContent.appendChild(modalHeader);
      modalContent.appendChild(iframe);
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      
      // Close modal when clicking outside
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeExpertisePreviewPiP();
        }
      });
    }

    window.closeExpertisePreviewPiP = function() {
      const modal = document.getElementById('expertisePreviewModal');
      if (modal) {
        modal.remove();
      }
    };
  </script>
  
  <!-- Helper integration -->
  <script type="module" src="./helper.js"></script>
  
  <!-- Floating screens integration -->
  <script src="car-details-floating.js"></script>
  <script src="levi-floating.js"></script>
  <script src="parts-search-results-floating.js"></script>
  <script src="internal-browser.js"></script>
</body>
</html>
