<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Real-time Sync</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            text-align: center;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #dc3545;
        }
        
        .status-indicator.connected {
            background: #28a745;
        }
        
        .status-indicator.connecting {
            background: #ffc107;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: dark; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        
        .helper-editor {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .helper-editor textarea {
            width: 100%;
            height: 200px;
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }
        
        .log-container {
            background: #212529;
            color: #fff;
            border-radius: 5px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin: 2px 0;
            padding: 2px;
        }
        
        .log-info { color: #17a2b8; }
        .log-success { color: #28a745; }
        .log-warning { color: #ffc107; }
        .log-error { color: #dc3545; }
        
        .multi-session {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .session-panel {
            border: 2px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
        }
        
        .session-1 { border-color: #007bff; }
        .session-2 { border-color: #28a745; }
        
        .session-title {
            font-weight: bold;
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 3px;
        }
        
        .session-1 .session-title { background: #007bff; color: white; }
        .session-2 .session-title { background: #28a745; color: white; }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #007bff;
            color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transform: translateX(100%);
            transition: transform 0.3s;
            z-index: 1000;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success { background: #28a745; }
        .notification.warning { background: #ffc107; color: #000; }
        .notification.error { background: #dc3545; }
    </style>
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <h1>üîÑ Real-time Sync Test</h1>
        
        <div class="status-bar">
            <div class="status-item">
                <span class="status-indicator" id="connection-status"></span>
                <span id="connection-text">Disconnected</span>
            </div>
            
            <div class="status-item">
                <strong>Case:</strong> <span id="current-case">None</span>
            </div>
            
            <div class="status-item">
                <strong>Sync Status:</strong> <span id="sync-status">Idle</span>
            </div>
            
            <div class="status-item">
                <strong>Session:</strong> <span id="session-id"></span>
            </div>
        </div>
        
        <div class="button-group">
            <button class="btn-primary" onclick="initializeRealtime()">üîå Connect</button>
            <button class="btn-success" onclick="createTestCase()">üìù Create Test Case</button>
            <button class="btn-warning" onclick="simulateChange()">‚ö° Simulate Change</button>
            <button class="btn-danger" onclick="disconnect()">üîå Disconnect</button>
            <button class="btn-secondary" onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>
    </div>
    
    <div class="multi-session">
        <div class="session-panel session-1">
            <div class="session-title">Session 1 (This Window)</div>
            
            <div class="helper-editor">
                <label><strong>Helper Data:</strong></label>
                <textarea id="helper-data" placeholder="Helper JSON will appear here..."></textarea>
            </div>
            
            <div class="button-group">
                <button class="btn-primary" onclick="updateHelper()">üíæ Update Helper</button>
                <button class="btn-success" onclick="loadFromSupabase()">üì• Load from Supabase</button>
            </div>
        </div>
        
        <div class="session-panel session-2">
            <div class="session-title">Session 2 (Open Another Window)</div>
            
            <p style="color: #666;">
                <strong>Instructions for testing:</strong><br>
                1. Open this same page in another browser window<br>
                2. Connect both sessions to the same case<br>
                3. Make changes in one window<br>
                4. Watch changes appear in the other window instantly!
            </p>
            
            <div class="button-group">
                <button class="btn-primary" onclick="openSecondWindow()">ü™ü Open Second Window</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <h3>üìã Real-time Log</h3>
        <div class="log-container" id="log-container">
            <div class="log-entry log-info">[Ready] Real-time sync test page loaded</div>
        </div>
    </div>
    
    <!-- Notification area -->
    <div id="notification" class="notification"></div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://nvqrptokmwdhvpiufrad.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52cXJwdG9rbXdkaHZwaXVmcmFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzU0ODUsImV4cCI6MjA3MTYxMTQ4NX0.yvFalmZE7Xpvo_j6wzRj44Pa7Bx9LQegcyLzbz3QL5s';
        
        // Initialize Supabase
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Global state
        let currentCaseId = null;
        let currentPlate = null;
        let sessionId = 'session_' + Math.random().toString(36).substr(2, 9);
        let realtimeChannel = null;
        let isConnected = false;
        
        // Initialize session
        document.getElementById('session-id').textContent = sessionId;
        
        // Logging function
        function log(message, type = 'info') {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `[${timestamp}] ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }
        
        // Update UI status
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connection-status');
            const text = document.getElementById('connection-text');
            
            if (connected) {
                indicator.className = 'status-indicator connected';
                text.textContent = 'Connected';
            } else {
                indicator.className = 'status-indicator';
                text.textContent = 'Disconnected';
            }
            
            isConnected = connected;
        }
        
        function updateSyncStatus(status) {
            document.getElementById('sync-status').textContent = status;
        }
        
        function updateCurrentCase(plate, caseId) {
            currentPlate = plate;
            currentCaseId = caseId;
            document.getElementById('current-case').textContent = plate || 'None';
        }
        
        // Initialize real-time connection
        async function initializeRealtime() {
            log('üîå Initializing real-time connection...', 'info');
            updateConnectionStatus(false);
            document.getElementById('connection-status').className = 'status-indicator connecting';
            
            try {
                // Test basic connection
                const { data, error } = await supabaseClient
                    .from('cases')
                    .select('count')
                    .limit(1);
                
                if (error) throw error;
                
                log('‚úÖ Supabase connection successful', 'success');
                updateConnectionStatus(true);
                showNotification('Connected to real-time sync!', 'success');
                
            } catch (error) {
                log(`‚ùå Connection failed: ${error.message}`, 'error');
                updateConnectionStatus(false);
                showNotification('Connection failed!', 'error');
            }
        }
        
        // Create test case
        async function createTestCase() {
            if (!isConnected) {
                showNotification('Please connect first!', 'warning');
                return;
            }
            
            log('üìù Creating test case...', 'info');
            updateSyncStatus('Creating...');
            
            try {
                const testPlate = 'SYNC-' + Date.now();
                const testHelper = {
                    meta: { plate: testPlate },
                    case_info: {
                        customer_name: 'Real-time Test Customer',
                        created_at: new Date().toISOString()
                    },
                    vehicle: {
                        plate: testPlate,
                        make: 'Toyota',
                        model: 'Test Vehicle'
                    },
                    last_modified: new Date().toISOString(),
                    modified_by: sessionId,
                    version: 1,
                    realtime_test: true
                };
                
                // Create case
                const { data: newCase, error: caseError } = await supabaseClient
                    .from('cases')
                    .insert({
                        plate: testPlate,
                        owner_name: testHelper.case_info.customer_name,
                        status: 'OPEN'
                    })
                    .select()
                    .single();
                
                if (caseError) throw caseError;
                
                // Save helper
                const { data: savedHelper, error: helperError } = await supabaseClient
                    .from('case_helper')
                    .insert({
                        case_id: newCase.id,
                        version: 1,
                        is_current: true,
                        helper_name: `${testPlate}_helper_v1`,
                        helper_json: testHelper,
                        source: 'realtime_test',
                        sync_status: 'synced'
                    })
                    .select()
                    .single();
                
                if (helperError) throw helperError;
                
                // Update UI
                updateCurrentCase(testPlate, newCase.id);
                document.getElementById('helper-data').value = JSON.stringify(testHelper, null, 2);
                
                // Subscribe to changes
                await subscribeToCase(newCase.id);
                
                log(`‚úÖ Test case created: ${testPlate}`, 'success');
                updateSyncStatus('Subscribed');
                showNotification(`Test case created: ${testPlate}`, 'success');
                
            } catch (error) {
                log(`‚ùå Error creating test case: ${error.message}`, 'error');
                updateSyncStatus('Error');
                showNotification('Failed to create test case!', 'error');
            }
        }
        
        // Subscribe to case changes
        async function subscribeToCase(caseId) {
            if (realtimeChannel) {
                supabaseClient.removeChannel(realtimeChannel);
            }
            
            log(`üîî Subscribing to case ${caseId}...`, 'info');
            
            realtimeChannel = supabaseClient
                .channel(`case-${caseId}`)
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'case_helper',
                        filter: `case_id=eq.${caseId}`
                    },
                    (payload) => handleRealtimeChange(payload)
                )
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        log('‚úÖ Subscribed to real-time changes', 'success');
                        updateSyncStatus('Subscribed');
                    } else if (status === 'CHANNEL_ERROR') {
                        log('‚ùå Failed to subscribe', 'error');
                        updateSyncStatus('Error');
                    }
                });
        }
        
        // Handle real-time changes
        function handleRealtimeChange(payload) {
            const { eventType, new: newRecord, old: oldRecord } = payload;
            
            log(`üì° Real-time change: ${eventType}`, 'info');
            
            if (eventType === 'INSERT' || eventType === 'UPDATE') {
                if (newRecord && newRecord.is_current) {
                    // Check if this change is from another session
                    const remoteModifiedBy = newRecord.helper_json?.modified_by;
                    const isOwnChange = remoteModifiedBy === sessionId;
                    
                    if (!isOwnChange) {
                        log(`üì• Remote change from: ${remoteModifiedBy}`, 'warning');
                        
                        // Update helper display
                        document.getElementById('helper-data').value = 
                            JSON.stringify(newRecord.helper_json, null, 2);
                        
                        showNotification(
                            `Helper updated by ${remoteModifiedBy}`, 
                            'info'
                        );
                        
                        // Flash the textarea to indicate change
                        const textarea = document.getElementById('helper-data');
                        textarea.style.background = '#fff3cd';
                        setTimeout(() => {
                            textarea.style.background = '#fff';
                        }, 2000);
                    } else {
                        log('üîÑ Own change detected, ignoring', 'info');
                    }
                }
            }
        }
        
        // Update helper
        async function updateHelper() {
            if (!currentCaseId) {
                showNotification('No active case!', 'warning');
                return;
            }
            
            const helperText = document.getElementById('helper-data').value;
            if (!helperText.trim()) {
                showNotification('No helper data to update!', 'warning');
                return;
            }
            
            try {
                let helper = JSON.parse(helperText);
                
                // Add modification tracking
                helper.last_modified = new Date().toISOString();
                helper.modified_by = sessionId;
                helper.version = (helper.version || 1) + 1;
                
                log('üíæ Updating helper...', 'info');
                updateSyncStatus('Updating...');
                
                // Mark all previous as not current
                await supabaseClient
                    .from('case_helper')
                    .update({ is_current: false })
                    .eq('case_id', currentCaseId);
                
                // Insert new version
                const { data, error } = await supabaseClient
                    .from('case_helper')
                    .insert({
                        case_id: currentCaseId,
                        version: helper.version,
                        is_current: true,
                        helper_name: `${currentPlate}_helper_v${helper.version}`,
                        helper_json: helper,
                        source: 'realtime_test',
                        sync_status: 'synced'
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Update display
                document.getElementById('helper-data').value = JSON.stringify(helper, null, 2);
                
                log(`‚úÖ Helper updated to v${helper.version}`, 'success');
                updateSyncStatus('Subscribed');
                showNotification('Helper updated successfully!', 'success');
                
            } catch (error) {
                log(`‚ùå Error updating helper: ${error.message}`, 'error');
                updateSyncStatus('Error');
                showNotification('Failed to update helper!', 'error');
            }
        }
        
        // Simulate a change (for testing)
        async function simulateChange() {
            const textarea = document.getElementById('helper-data');
            const helperText = textarea.value;
            
            if (!helperText.trim()) {
                showNotification('Create a test case first!', 'warning');
                return;
            }
            
            try {
                let helper = JSON.parse(helperText);
                
                // Add a random change
                const changes = [
                    () => { helper.test_field = 'Random value: ' + Math.random().toString(36).substr(2, 5); },
                    () => { helper.vehicle.color = ['Red', 'Blue', 'White', 'Black'][Math.floor(Math.random() * 4)]; },
                    () => { helper.case_info.notes = 'Updated at ' + new Date().toLocaleTimeString(); },
                    () => { helper.damage_assessment = { damage_level: Math.floor(Math.random() * 10) + 1 }; }
                ];
                
                // Apply random change
                changes[Math.floor(Math.random() * changes.length)]();
                
                // Update textarea and trigger update
                textarea.value = JSON.stringify(helper, null, 2);
                await updateHelper();
                
            } catch (error) {
                showNotification('Invalid JSON in helper data!', 'error');
            }
        }
        
        // Load from Supabase
        async function loadFromSupabase() {
            if (!currentCaseId) {
                showNotification('No active case!', 'warning');
                return;
            }
            
            try {
                log('üì• Loading from Supabase...', 'info');
                
                const { data, error } = await supabaseClient
                    .from('case_helper')
                    .select('helper_json, version, helper_name')
                    .eq('case_id', currentCaseId)
                    .eq('is_current', true)
                    .single();
                
                if (error) throw error;
                
                document.getElementById('helper-data').value = 
                    JSON.stringify(data.helper_json, null, 2);
                
                log(`‚úÖ Loaded ${data.helper_name}`, 'success');
                showNotification(`Loaded ${data.helper_name}`, 'success');
                
            } catch (error) {
                log(`‚ùå Error loading: ${error.message}`, 'error');
                showNotification('Failed to load from Supabase!', 'error');
            }
        }
        
        // Disconnect
        function disconnect() {
            if (realtimeChannel) {
                supabaseClient.removeChannel(realtimeChannel);
                realtimeChannel = null;
            }
            
            updateConnectionStatus(false);
            updateSyncStatus('Idle');
            updateCurrentCase(null, null);
            
            log('üîå Disconnected from real-time sync', 'info');
            showNotification('Disconnected', 'info');
        }
        
        // Open second window for testing
        function openSecondWindow() {
            const newWindow = window.open(window.location.href, '_blank');
            showNotification('Second window opened for multi-session testing!', 'info');
        }
        
        // Clear log
        function clearLog() {
            document.getElementById('log-container').innerHTML = 
                '<div class="log-entry log-info">[Ready] Log cleared</div>';
        }
        
        // Auto-connect on load
        window.addEventListener('load', () => {
            log('üöÄ Real-time test page ready', 'info');
            log('üí° Tip: Create a test case, then open another window to test real-time sync!', 'info');
        });
        
        // Cleanup on unload
        window.addEventListener('beforeunload', () => {
            if (realtimeChannel) {
                supabaseClient.removeChannel(realtimeChannel);
            }
        });
    </script>
</body>
</html>