<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <title>ğŸ”§ Fix Browser Storage Issues</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f5f5f5; text-align: right; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .result { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 4px; border: 1px solid #ddd; white-space: pre-line; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Fix Browser Storage Issues</h1>
        <p>This tool fixes IndexedDB and browser storage issues that prevent the selection page from loading.</p>
        
        <button onclick="clearBrowserStorage()">ğŸ§¹ Clear Browser Storage</button>
        <button onclick="testStorage()">ğŸ” Test Storage</button>
        <button onclick="fixOneSignalStorage()">ğŸ“± Fix OneSignal Storage</button>
        
        <div id="results"></div>
    </div>

    <script>
        async function clearBrowserStorage() {
            addResult('ğŸ§¹ Clearing browser storage...', 'info');
            
            try {
                // Clear localStorage
                const localStorageCount = localStorage.length;
                localStorage.clear();
                addResult(`âœ… Cleared ${localStorageCount} localStorage items`, 'success');
                
                // Clear sessionStorage  
                const sessionStorageCount = sessionStorage.length;
                sessionStorage.clear();
                addResult(`âœ… Cleared ${sessionStorageCount} sessionStorage items`, 'success');
                
                // Clear IndexedDB databases
                if ('indexedDB' in window) {
                    try {
                        // Try to clear OneSignal database specifically
                        const dbDeleteRequest = indexedDB.deleteDatabase('OneSignalSDK');
                        dbDeleteRequest.onsuccess = () => {
                            addResult('âœ… Cleared OneSignal IndexedDB database', 'success');
                        };
                        dbDeleteRequest.onerror = () => {
                            addResult('âš ï¸ Could not clear OneSignal database (may not exist)', 'warning');
                        };
                        
                        // Try to clear other common databases
                        const commonDbs = ['localforage', 'keyval-store', 'idb-keyval'];
                        for (const dbName of commonDbs) {
                            indexedDB.deleteDatabase(dbName);
                        }
                        
                        addResult('âœ… Attempted to clear IndexedDB databases', 'success');
                    } catch (error) {
                        addResult(`âš ï¸ IndexedDB cleanup error: ${error.message}`, 'warning');
                    }
                } else {
                    addResult('âŒ IndexedDB not supported in this browser', 'error');
                }
                
                // Clear cache if available
                if ('caches' in window) {
                    try {
                        const cacheNames = await caches.keys();
                        await Promise.all(cacheNames.map(name => caches.delete(name)));
                        addResult(`âœ… Cleared ${cacheNames.length} cache entries`, 'success');
                    } catch (error) {
                        addResult(`âš ï¸ Cache cleanup error: ${error.message}`, 'warning');
                    }
                }
                
                addResult('ğŸ‰ Browser storage cleanup completed!', 'success');
                addResult('ğŸ’¡ Now reload the selection page to test if the errors are fixed', 'info');
                
            } catch (error) {
                addResult(`âŒ Storage cleanup error: ${error.message}`, 'error');
            }
        }
        
        async function testStorage() {
            addResult('ğŸ” Testing browser storage capabilities...', 'info');
            
            // Test localStorage
            try {
                localStorage.setItem('test', 'value');
                localStorage.removeItem('test');
                addResult('âœ… localStorage: Working', 'success');
            } catch (error) {
                addResult(`âŒ localStorage: Failed - ${error.message}`, 'error');
            }
            
            // Test sessionStorage
            try {
                sessionStorage.setItem('test', 'value');
                sessionStorage.removeItem('test');
                addResult('âœ… sessionStorage: Working', 'success');
            } catch (error) {
                addResult(`âŒ sessionStorage: Failed - ${error.message}`, 'error');
            }
            
            // Test IndexedDB
            if ('indexedDB' in window) {
                try {
                    const request = indexedDB.open('test-db', 1);
                    request.onsuccess = () => {
                        addResult('âœ… IndexedDB: Working', 'success');
                        indexedDB.deleteDatabase('test-db');
                    };
                    request.onerror = () => {
                        addResult('âŒ IndexedDB: Failed to open', 'error');
                    };
                } catch (error) {
                    addResult(`âŒ IndexedDB: Error - ${error.message}`, 'error');
                }
            } else {
                addResult('âŒ IndexedDB: Not supported', 'error');
            }
        }
        
        async function fixOneSignalStorage() {
            addResult('ğŸ“± Fixing OneSignal storage issues...', 'info');
            
            try {
                // Clear OneSignal specific storage
                const oneSignalKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.includes('OneSignal')) {
                        oneSignalKeys.push(key);
                    }
                }
                
                oneSignalKeys.forEach(key => localStorage.removeItem(key));
                addResult(`âœ… Removed ${oneSignalKeys.length} OneSignal localStorage items`, 'success');
                
                // Clear OneSignal IndexedDB
                if ('indexedDB' in window) {
                    const oneSignalDbs = ['OneSignalSDK', 'OneSignal', 'onesignal'];
                    for (const dbName of oneSignalDbs) {
                        try {
                            indexedDB.deleteDatabase(dbName);
                            addResult(`âœ… Deleted ${dbName} database`, 'success');
                        } catch (error) {
                            addResult(`âš ï¸ Could not delete ${dbName}: ${error.message}`, 'warning');
                        }
                    }
                }
                
                addResult('ğŸ‰ OneSignal storage cleanup completed!', 'success');
                addResult('ğŸ’¡ OneSignal will reinitialize cleanly on next page load', 'info');
                
            } catch (error) {
                addResult(`âŒ OneSignal cleanup error: ${error.message}`, 'error');
            }
        }
        
        function addResult(text, type) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = text;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }
        
        // Auto-run storage test on page load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                addResult('ğŸ”§ Browser Storage Fix Tool Loaded', 'info');
                addResult('ğŸ’¡ Click "Test Storage" to diagnose issues or "Clear Browser Storage" to fix them', 'info');
            }, 500);
        });
    </script>
</body>
</html>