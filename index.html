<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×™×¨×•×Ÿ ×›×™×•×£ - ×©×××•×ª ×•×™×™×¢×•×¥</title>

  <!-- Favicon -->
  <link rel="icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" type="image/webp" />
  <link rel="shortcut icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" />
  <link rel="apple-touch-icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" />
  <!-- Fallback for favicon.ico requests -->
  <link rel="icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" type="image/x-icon" />
  
  <!-- OneSignal Push -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- OneSignal Push - Only initialize after authentication -->
  <script>
    // OneSignal will be initialized after user authentication in post-login pages
    console.log('ğŸ“± OneSignal Login: Skipping initialization until after authentication');
  </script>
  <style>
    body {
      font-family: sans-serif;
      background: linear-gradient(to bottom right, #1e3a8a, #3b82f6);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      background: white;
      padding: 40px 30px;
      border-radius: 16px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.15);
      max-width: 400px;
      width: 90%;
      text-align: center;
      position: relative;
    }
    .logo {
      width: 120px;
      margin-bottom: 20px;
      opacity: 0.8;
      transition: all 1.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    
    /* Logo success animation */
    .logo.success-animation {
      transform: scale(6) rotate(360deg);
      opacity: 1;
      z-index: 1000;
      position: fixed;
      top: 50%;
      left: 50%;
      margin-top: -60px;
      margin-left: -60px;
    }
    
    /* Overlay for smooth transition */
    .success-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1e3a8a, #3b82f6);
      z-index: 999;
      opacity: 0;
      transition: opacity 0.8s ease;
      pointer-events: none;
    }
    
    .success-overlay.active {
      opacity: 0.95;
    }
    h1 {
      font-size: 22px;
      margin: 10px 0;
      color: #1e3a8a;
    }
    h2 {
      font-size: 16px;
      margin-bottom: 20px;
      color: #64748b;
    }
    input[type="email"],
    input[type="password"] {
      padding: 12px;
      font-size: 16px;
      width: 100%;
      border: 1px solid #64748b;
      border-radius: 8px;
      margin-bottom: 15px;
      box-sizing: border-box;
    }
    input[type="email"]::placeholder,
    input[type="password"]::placeholder {
      text-align: right;
    }
    .forgot-password {
      text-align: center;
      margin-top: 15px;
    }
    .forgot-password a {
      color: #1e3a8a;
      text-decoration: none;
      font-size: 14px;
      cursor: pointer;
    }
    .forgot-password a:hover {
      text-decoration: underline;
    }
    .error-message {
      color: #dc2626;
      font-size: 14px;
      margin-bottom: 15px;
      text-align: center;
      display: none;
    }
    .error-message.show {
      display: block;
    }
    button {
      padding: 12px 20px;
      font-size: 16px;
      background-color: #1e3a8a;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #3b82f6;
    }
    .footer {
      margin-top: 25px;
      font-size: 12px;
      color: #475569;
    }
    .watermark {
      position: absolute;
      bottom: 12px;
      left: 12px;
      font-size: 10px;
      opacity: 0.3;
    }
  </style>
</head>
<body>
  <!-- Success transition overlay -->
  <div class="success-overlay" id="successOverlay"></div>
  
  <div class="container">
    <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" class="logo" id="loginLogo" alt="Logo" />
    <h1>×™×¨×•×Ÿ ×›×™×•×£ - ×©×××•×ª ×•×™×™×¢×•×¥</h1>
    <h2>×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</h2>
    <form id="loginForm" onsubmit="login(event); return false;">
      <div class="error-message" id="errorMessage"></div>
      <input type="email" id="email" placeholder="××™××™×™×œ" autocomplete="email" required />
      <input type="password" id="password" placeholder="×¡×™×¡××”" autocomplete="current-password" required />
      <button type="submit">×›× ×™×¡×”</button>
      <div class="forgot-password">
        <a onclick="showForgotPassword()">×©×›×—×ª×™ ×¡×™×¡××”</a>
      </div>
    </form>
    <div class="footer">@2025 Carmel Cayouf. All rights reserved. SmartVal Pro System by Eval Â©</div>
    <div class="watermark">×™×¨×•×Ÿ ×›×™×•×£ - ×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</div>
  </div>

  <script type="module">
  console.log("ğŸš€ Loading index.html script...");
  
  // Import Supabase Auth Service
  import { authService } from './services/authService.js';
  
  async function initPush() {
    try {
      console.log("ğŸ“± Initializing OneSignal push notifications...");
      
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      
      return new Promise((resolve, reject) => {
        OneSignalDeferred.push(async function(OneSignal) {
          try {
            await OneSignal.init({
              appId: "3b924b99-c302-4919-a97e-baf909394696",
            });
            
            console.log("ğŸ“± OneSignal initialized successfully");
            
            // Show subscription prompt after successful login
            try {
              await OneSignal.showSlidedownPrompt();
              console.log("ğŸ“± Push notification prompt shown");
            } catch(promptError) {
              console.log("ğŸ“± Push prompt already shown or blocked:", promptError.message);
            }
            
            resolve();
          } catch(error) {
            console.error("ğŸ“± OneSignal init error:", error);
            reject(error);
          }
        });
      });
    } catch(error) {
      console.error("ğŸ“± Push notification setup error:", error);
      throw error;
    }
  }

  // Car ignition and driving away sounds
  let carIgnitionSound = null;
  let carDrivingAwaySound = null;
  
  // Initialize car ignition sound for successful login
  try {
    carIgnitionSound = new Audio('./assets/car ignition.mp3');
    carIgnitionSound.volume = 0.6; // Set volume to 60%
    carIgnitionSound.addEventListener('canplaythrough', () => {
      console.log('ğŸš— Car ignition sound loaded successfully');
    });
    carIgnitionSound.addEventListener('error', (e) => {
      console.log('ğŸ”Š Car ignition sound failed to load:', e);
    });
  } catch(e) {
    console.log('ğŸ”Š Failed to initialize car ignition sound:', e.message);
  }
  
  // Initialize car driving away sound for logout
  try {
    carDrivingAwaySound = new Audio('./assets/car_driving_away.mp3');
    carDrivingAwaySound.volume = 0.5; // Set volume to 50%
    carDrivingAwaySound.addEventListener('canplaythrough', () => {
      console.log('ğŸš— Car driving away sound loaded successfully');
    });
    carDrivingAwaySound.addEventListener('error', (e) => {
      console.log('ğŸ”Š Car driving away sound failed to load:', e);
    });
  } catch(e) {
    console.log('ğŸ”Š Failed to initialize car driving away sound:', e.message);
  }
  
  // Global logout function with driving away sound
  window.logoutWithSound = function() {
    console.log('ğŸš— Logout initiated with driving away sound');
    
    // Play driving away sound
    if (carDrivingAwaySound) {
      carDrivingAwaySound.play().catch(e => 
        console.log('ğŸ”Š Driving away sound skipped:', e.message)
      );
    }
    
    // Clear session data
    sessionStorage.clear();
    localStorage.clear();
    
    // Show logout message briefly
    const container = document.querySelector('.container');
    if (container) {
      container.innerHTML = `
        <div style="text-align: center; color: #1e3a8a; padding: 20px;">
          <h2>ğŸš— ×œ×”×ª×¨××•×ª!</h2>
          <p>××¢×‘×™×¨ ×—×–×¨×” ×œ×“×£ ×”×›× ×™×¡×”...</p>
        </div>
      `;
    }
    
    // Redirect after sound duration (approximately 2 seconds)
    setTimeout(() => {
      window.location.href = 'index.html';
    }, 2500);
  };

  // Success animation function
  function startSuccessAnimation() {
    console.log('ğŸ¬ Starting success animation...');
    
    const logo = document.getElementById('loginLogo');
    const overlay = document.getElementById('successOverlay');
    
    if (!logo || !overlay) {
      console.log('ğŸ¬ Animation elements not found, skipping animation');
      return;
    }
    
    // Start overlay fade-in
    overlay.classList.add('active');
    
    // Start logo animation after a brief delay
    setTimeout(() => {
      logo.classList.add('success-animation');
    }, 200);
    
    // Log animation progress
    setTimeout(() => {
      console.log('ğŸ¬ Animation halfway complete...');
    }, 750);
  }

  async function login(event) {
    if (event) event.preventDefault();
    console.log("ğŸ”¥ LOGIN FUNCTION CALLED!");
    
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    const errorMessage = document.getElementById("errorMessage");
    
    // Hide previous errors
    errorMessage.classList.remove("show");
    
    if (!email || !password) {
      showError("× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª");
      return;
    }

    const submitBtn = document.querySelector("#loginForm button");
    const originalText = submitBtn.textContent;
    submitBtn.textContent = "××ª×—×‘×¨...";
    submitBtn.disabled = true;

    console.log("ğŸ” Starting Supabase Auth login process...");

    try {
      // Login with Supabase Auth
      const result = await authService.login(email, password);
      
      if (!result.success) {
        console.log("âŒ Authentication failed:", result.error);
        showError(result.error);
        return;
      }

      console.log("âœ… Authentication successful!", {
        name: result.profile.name,
        role: result.profile.role
      });

      // Check if user must change password
      if (result.mustChangePassword) {
        console.log("âš ï¸ User must change password");
        // Store email for password change page
        sessionStorage.setItem('pendingEmail', email);
        // Redirect to password change page
        window.location.href = 'change-password.html';
        return;
      }

      // Update UI to show success immediately
      submitBtn.textContent = "ğŸš— ××¦×œ×™×—! ××¢×‘×™×¨...";
      submitBtn.style.background = "#28a745";
      
      // Play car ignition sound (non-blocking)
      if (carIgnitionSound) {
        carIgnitionSound.play().catch(e => console.log("ğŸ”Š Car ignition audio skipped:", e.message));
      }
      
      // Start logo animation and smooth transition
      startSuccessAnimation();
      
      // Start session monitoring
      authService.startSessionMonitoring(() => {
        alert("×”×¤×’×™×©×” ×”×¡×ª×™×™××” ×¢×§×‘ ×—×•×¡×¨ ×¤×¢×™×œ×•×ª.");
        window.location.href = "index.html";
      });

      // Trigger OneSignal initialization in background (non-blocking)
      window.dispatchEvent(new Event('auth-success'));

      // Navigate after animation completes
      setTimeout(() => {
        console.log("âœ… Navigating to selection page...");
        window.location.href = 'selection.html';
      }, 1500); // Wait for animation to complete
      
    } catch (err) {
      console.error("ğŸš¨ Login error:", err);
      showError("×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª - × ×¡×” ×©×•×‘");
    } finally {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    }
  }

  // Show error message helper
  function showError(message) {
    const errorMessage = document.getElementById("errorMessage");
    errorMessage.textContent = message;
    errorMessage.classList.add("show");
  }

  // Forgot password handler
  window.showForgotPassword = async function() {
    const email = document.getElementById("email").value.trim();
    
    if (!email) {
      showError("× × ×œ×”×–×™×Ÿ ×›×ª×•×‘×ª ××™××™×™×œ ×ª×—×™×œ×”");
      return;
    }

    const confirmed = confirm(`×”×× ×œ×©×œ×•×— ×§×™×©×•×¨ ×œ××™×¤×•×¡ ×¡×™×¡××” ×œ×›×ª×•×‘×ª:\n${email}?`);
    if (!confirmed) return;

    try {
      const result = await authService.resetPassword(email);
      
      if (result.success) {
        alert("× ×©×œ×— ××™××™×™×œ ×œ××™×¤×•×¡ ×¡×™×¡××”.\n×‘×“×•×§ ××ª ×ª×™×‘×ª ×”×“×•××¨ ×©×œ×š.");
      } else {
        showError(result.error);
      }
    } catch (error) {
      showError("×©×’×™××” ×‘×©×œ×™×—×ª ××™××™×™×œ");
    }
  }
  
  // Make login function global immediately
  window.login = login;
  console.log("âœ… Login function assigned to window.login");
  
  // Initialize when DOM is ready
  document.addEventListener('DOMContentLoaded', async function() {
    console.log("DOM ready, setting up login handlers");
    
    // Check for email link tokens (signup, invite, magic link, email change)
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    const accessToken = hashParams.get('access_token');
    const refreshToken = hashParams.get('refresh_token');
    const type = hashParams.get('type');
    
    if (accessToken && type) {
      console.log(`ğŸ“§ Email link detected: type=${type}`);
      
      try {
        // Set the session using the token
        const { data, error } = await supabase.auth.setSession({
          access_token: accessToken,
          refresh_token: refreshToken
        });
        
        if (error) throw error;
        
        console.log('âœ… Session established from email link');
        
        // Handle different types
        if (type === 'signup') {
          alert('××™××™×™×œ ××•××ª ×‘×”×¦×œ×—×”! × × ×œ×”×ª×—×‘×¨.');
          window.location.href = 'index.html'; // Clear hash and show login
        } else if (type === 'invite') {
          alert('×”×–×× ×” ×”×ª×§×‘×œ×”! × × ×œ×”×’×“×™×¨ ×¡×™×¡××”.');
          window.location.href = 'change-password.html';
        } else if (type === 'magiclink') {
          // Auto-login from magic link
          const authData = {
            user: data.user,
            session: data.session,
            profile: await authService.getProfile(data.user.id)
          };
          sessionStorage.setItem('auth', JSON.stringify(authData));
          window.location.href = 'selection.html';
        } else if (type === 'email_change') {
          alert('×›×ª×•×‘×ª ×”××™××™×™×œ ×©×•× ×ª×” ×‘×”×¦×œ×—×”!');
          window.location.href = 'index.html';
        }
        
        return; // Don't continue with normal login flow
        
      } catch (error) {
        console.error('âŒ Email link error:', error);
        alert('×©×’×™××” ×‘××™××•×ª ×§×™×©×•×¨ ×”××™××™×™×œ');
      }
    }
    
    const emailField = document.getElementById("email");
    if (emailField) {
      // Focus on email field
      emailField.focus();
    }
    
    // Show current URL for debugging
    console.log("ğŸŒ Current URL:", window.location.href);
    console.log("ğŸŒ Current origin:", window.location.origin);
  });
  </script>

  <!-- OneSignal SDK for push notifications -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script type="module">
    // Initialize OneSignal after successful login
    import { supabase } from './lib/supabaseClient.js';

    const ONESIGNAL_APP_ID = '3b924b99-c302-4919-a97e-baf909394696';
    let oneSignalInitialized = false;

    async function initOneSignalOnLogin() {
      try {
        console.log('ğŸ”” Login: Starting OneSignal initialization...');

        // Wait for OneSignal SDK to load
        let attempts = 0;
        while (!window.OneSignal && attempts < 20) {
          await new Promise(resolve => setTimeout(resolve, 500));
          attempts++;
        }

        if (!window.OneSignal) {
          console.log('ğŸ”” Login: OneSignal SDK not available, skipping');
          return;
        }

        // Initialize OneSignal
        await OneSignal.init({
          appId: ONESIGNAL_APP_ID,
          allowLocalhostAsSecureOrigin: true,
          notifyButton: {
            enable: false
          }
        });

        console.log('ğŸ”” Login: OneSignal initialized');
        oneSignalInitialized = true;

        // Get auth data
        const auth = sessionStorage.getItem('auth');
        if (!auth) {
          console.log('ğŸ”” Login: No auth data, skipping ID save');
          return;
        }

        const authData = JSON.parse(auth);
        const userId = authData.profile?.user_id || authData.user?.id;

        if (!userId) {
          console.log('ğŸ”” Login: No user ID, skipping ID save');
          return;
        }

        // Wait a bit for OneSignal User API to be ready
        attempts = 0;
        while ((!window.OneSignal.User) && attempts < 10) {
          await new Promise(resolve => setTimeout(resolve, 500));
          attempts++;
        }

        // Try to get OneSignal ID (non-blocking)
        setTimeout(async () => {
          try {
            const onesignalId = await OneSignal.User.getOnesignalId();

            if (onesignalId) {
              console.log('ğŸ”” Login: OneSignal ID obtained:', onesignalId);

              // Save to Supabase
              const { error } = await supabase
                .from('profiles')
                .update({ onesignal_id: onesignalId })
                .eq('user_id', userId);

              if (error) {
                console.error('ğŸ”” Login: Error saving OneSignal ID:', error);
              } else {
                console.log('ğŸ”” Login: OneSignal ID saved successfully');
                sessionStorage.setItem('onesignalId', onesignalId);
              }
            } else {
              console.log('ğŸ”” Login: OneSignal ID not available yet');
            }
          } catch (error) {
            console.log('ğŸ”” Login: Could not get OneSignal ID (non-fatal):', error.message);
          }
        }, 2000);

      } catch (error) {
        console.log('ğŸ”” Login: OneSignal init error (non-fatal):', error.message);
      }
    }

    // Listen for successful login and initialize OneSignal
    window.addEventListener('auth-success', () => {
      console.log('ğŸ”” Login: Auth success event received');
      initOneSignalOnLogin();
    });

    // Also check if already logged in on page load
    window.addEventListener('load', () => {
      const auth = sessionStorage.getItem('auth');
      if (auth) {
        console.log('ğŸ”” Login: User already authenticated, initializing OneSignal');
        initOneSignalOnLogin();
      }
    });
  </script>
</body>
</html>