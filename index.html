<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×¤×•×¨×˜×œ</title>

  <!-- Favicon -->
  <link rel="icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" type="image/webp" />
  <link rel="shortcut icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" />
  <link rel="apple-touch-icon" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" />
  
  <!-- OneSignal Push -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- OneSignal Push SDK -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

  <style>
    body {
      font-family: sans-serif;
      background: linear-gradient(to bottom right, #1e3a8a, #3b82f6);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      background: white;
      padding: 40px 30px;
      border-radius: 16px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.15);
      max-width: 400px;
      width: 90%;
      text-align: center;
      position: relative;
    }
    .logo {
      width: 120px;
      margin-bottom: 20px;
      opacity: 0.8;
    }
    h1 {
      font-size: 22px;
      margin: 10px 0;
      color: #1e3a8a;
    }
    h2 {
      font-size: 16px;
      margin-bottom: 20px;
      color: #64748b;
    }
    input[type="password"] {
      padding: 12px;
      font-size: 16px;
      width: 100%;
      border: 1px solid #64748b;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    button {
      padding: 12px 20px;
      font-size: 16px;
      background-color: #1e3a8a;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #3b82f6;
    }
    .footer {
      margin-top: 25px;
      font-size: 12px;
      color: #475569;
    }
    .watermark {
      position: absolute;
      bottom: 12px;
      left: 12px;
      font-size: 10px;
      opacity: 0.3;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" class="logo" alt="Logo" />
    <h1>×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª - ×¤×•×¨×˜×œ</h1>
    <h2>×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</h2>
    <input type="password" id="password" placeholder="×”×–×Ÿ ×¡×™×¡××”" />
    <button onclick="login()">×›× ×™×¡×”</button>
    <div class="footer">All rights reserved Â© Carmel Cayouf</div>
    <div class="watermark">×™×¨×•×Ÿ ×›×™×•×£ - ×©×××•×ª ×•×”×¢×¨×›×ª × ×–×§×™ ×¨×›×‘ ×•×¨×›×•×©</div>
  </div>

  <script type="module">
  import { encryptPassword } from './auth.js';
  import { WEBHOOKS } from './webhook.js';
  
  async function initPush() {
    try {
      console.log("ğŸ“± Initializing OneSignal push notifications...");
      
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      
      return new Promise((resolve, reject) => {
        OneSignalDeferred.push(async function(OneSignal) {
          try {
            await OneSignal.init({
              appId: "3b924b99-c302-4919-a97e-baf909394696",
            });
            
            console.log("ğŸ“± OneSignal initialized successfully");
            
            // Show subscription prompt after successful login
            try {
              await OneSignal.showSlidedownPrompt();
              console.log("ğŸ“± Push notification prompt shown");
            } catch(promptError) {
              console.log("ğŸ“± Push prompt already shown or blocked:", promptError.message);
            }
            
            resolve();
          } catch(error) {
            console.error("ğŸ“± OneSignal init error:", error);
            reject(error);
          }
        });
      });
    } catch(error) {
      console.error("ğŸ“± Push notification setup error:", error);
      throw error;
    }
  }

  // Use a simpler success sound or skip audio
  let successSound = null;
  try {
    successSound = new Audio("data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMcBzuZ3fPHdSYE");
  } catch(e) {
    console.log("ğŸ”Š Audio skipped due to browser restrictions");
  }

  async function login() {
    const pass = document.getElementById("password").value.trim();
    if (!pass) {
      alert("× × ×œ×”×–×™×Ÿ ×¡×™×¡××”");
      return;
    }

    const submitBtn = document.querySelector("button");
    const originalText = submitBtn.textContent;
    submitBtn.textContent = "××ª×—×‘×¨...";
    submitBtn.disabled = true;

    console.log("ğŸ” Starting login process with password:", pass.substring(0, 3) + "***");

    try {
      console.log("ğŸ“¡ Sending webhook request to Make.com...");
      const response = await fetch(WEBHOOKS.PASSWORD_PAGE, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify({ password: pass })
      });
      
      console.log("ğŸ“© Response status:", response.status);
      console.log("ğŸ“© Response headers:", Object.fromEntries(response.headers.entries()));
      
      const text = await response.text();
      console.log("ğŸ“© Response text:", text);
      
      // Check for success in multiple ways
      const isSuccess = response.status === 200 || 
                       response.ok || 
                       text.toLowerCase().includes("success") ||
                       text.toLowerCase().includes("approved") ||
                       text.toLowerCase().includes("valid");
      
      console.log("âœ… Login success check:", isSuccess);

      if (isSuccess) {
        console.log("ğŸ”‘ Authentication successful, encrypting password...");
        
        try {
          const encryptedPass = await encryptPassword(pass);
          console.log("ğŸ”’ Password encrypted successfully");
          
          // Clear any existing session data first
          sessionStorage.clear();
          
          // Set new session data
          sessionStorage.setItem("auth", encryptedPass);
          sessionStorage.setItem("sessionStart", Date.now().toString());
          sessionStorage.setItem("loginSuccess", "true");
          sessionStorage.setItem("originalPassword", pass); // For debugging
          
          console.log("ğŸ’¾ Session data saved to sessionStorage");
          console.log("ğŸ’¾ Auth token:", encryptedPass.substring(0, 50) + "...");
          
          // Test sessionStorage immediately
          const testAuth = sessionStorage.getItem("auth");
          if (!testAuth) {
            throw new Error("Failed to save auth to sessionStorage");
          }
          console.log("âœ… SessionStorage verification passed");
          
          // Success sound and push notifications (non-blocking)
          try { 
            if (successSound) {
              await successSound.play(); 
            }
          } catch(e) { 
            console.log("ğŸ”Š Audio playback skipped:", e.message); 
          }
          
          try {
            await initPush();
          } catch(e) {
            console.log("ğŸ“± Push notifications skipped:", e.message);
          }
          
          console.log("ğŸš€ Attempting navigation to selection.html...");
          
          // Update UI to show success
          submitBtn.textContent = "××¦×œ×™×—! ××¢×‘×™×¨...";
          submitBtn.style.background = "#28a745";
          
          // Wait a moment to ensure sessionStorage is fully written
          await new Promise(resolve => setTimeout(resolve, 50));
          
          // Verify sessionStorage before navigation
          const finalAuthCheck = sessionStorage.getItem("auth");
          if (!finalAuthCheck) {
            throw new Error("SessionStorage failed to persist auth token");
          }
          
          console.log("âœ… Final auth verification passed, navigating...");
          
          // Navigate using absolute path to avoid relative path issues
          window.location.href = `${window.location.origin}/selection.html`;
          
        } catch (encryptError) {
          console.error("ğŸ” Encryption failed:", encryptError);
          alert("×©×’×™××” ×‘×”×¦×¤× ×ª ×”×¡×™×¡××”: " + encryptError.message);
        }
        
      } else {
        console.log("âŒ Authentication failed");
        alert("×¡×™×¡××” ×œ× ×××•××ª×ª âŒ\nResponse: " + text);
      }
    } catch (err) {
      console.error("ğŸš¨ Login error:", err);
      console.error("ğŸš¨ Error details:", {
        name: err.name,
        message: err.message,
        stack: err.stack
      });
      alert("×©×’×™××ª ×—×™×‘×•×¨ ××•×œ Make.com âŒ\n" + err.message);
    } finally {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    }
  }
  
  // Initialize when DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM ready, setting up login handlers");
    
    // Make login function global
    window.login = login;
    
    // Add Enter key functionality to password field
    const passwordField = document.getElementById("password");
    if (passwordField) {
      passwordField.addEventListener("keydown", function(event) {
        if (event.key === "Enter") {
          event.preventDefault();
          login();
        }
      });
      
      // Focus on password field
      passwordField.focus();
    }
    
    // Show current URL for debugging
    console.log("ğŸŒ Current URL:", window.location.href);
    console.log("ğŸŒ Current origin:", window.location.origin);
  });

  // Idle logout timer (10 min)
  let logoutTimer;
  function resetTimer() {
    clearTimeout(logoutTimer);
    logoutTimer = setTimeout(() => {
      sessionStorage.clear();
      alert("×”×¤×’×™×©×” ×”×¡×ª×™×™××” ×¢×§×‘ ×—×•×¡×¨ ×¤×¢×™×œ×•×ª.");
      window.location.href = "index.html";
    }, 10 * 60 * 1000);
  }
  ["click", "mousemove", "keydown", "scroll"].forEach(evt => {
    document.addEventListener(evt, resetTimer, true);
  });
  resetTimer();
  </script>
</body>
</html>