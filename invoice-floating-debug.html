<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Floating Screen Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
            direction: rtl;
        }
        
        .debug-panel {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .debug-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #fbbf24;
            padding-bottom: 5px;
        }
        
        .test-button {
            background: #fbbf24;
            color: #78350f;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            font-size: 14px;
        }
        
        .test-button:hover {
            background: #f59e0b;
        }
        
        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            direction: ltr;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 8px;
        }
        
        .status-ok { background: #10b981; }
        .status-error { background: #ef4444; }
        .status-warning { background: #f59e0b; }
        
        .floating-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #3b82f6;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 10000;
        }
        
        .data-display {
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            font-size: 13px;
        }
        
        .error-display {
            background: #fef2f2;
            border: 1px solid #fca5a5;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            color: #dc2626;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <h1>ğŸ› Invoice Floating Screen Debug Tool</h1>
    
    <!-- Floating Test Button -->
    <button class="floating-button" onclick="testFloatingScreen()" title="Test Floating Screen">ğŸ§¾</button>
    
    <!-- Environment Check -->
    <div class="debug-panel">
        <div class="debug-title">ğŸ” Environment Check</div>
        <div id="env-status">
            <div>Supabase Client: <span id="supabase-status">â“</span></div>
            <div>Window Helper: <span id="helper-status">â“</span></div>
            <div>Session Storage: <span id="session-status">â“</span></div>
            <div>Invoice Functions: <span id="functions-status">â“</span></div>
        </div>
        <button class="test-button" onclick="checkEnvironment()">×‘×“×•×§ ×¡×‘×™×‘×”</button>
    </div>

    <!-- Case ID Detection -->
    <div class="debug-panel">
        <div class="debug-title">ğŸ¯ Case ID Detection</div>
        <div id="case-id-results"></div>
        <button class="test-button" onclick="testCaseIdDetection()">×‘×“×•×§ ×–×™×”×•×™ ×ª×™×§</button>
        <button class="test-button" onclick="mockCaseId()">×¦×•×¨ ××–×”×” ×ª×™×§ ×“×•×’××”</button>
    </div>

    <!-- Database Queries -->
    <div class="debug-panel">
        <div class="debug-title">ğŸ—„ï¸ Database Query Tests</div>
        <div id="db-query-results"></div>
        <button class="test-button" onclick="testInvoiceDocumentsQuery()">×‘×“×•×§ ×©××™×œ×ª×ª ××¡××›×™×</button>
        <button class="test-button" onclick="testMappingsQuery()">×‘×“×•×§ ×©××™×œ×ª×ª ×”×§×¦××•×ª</button>
        <button class="test-button" onclick="testWithMockData()">×‘×“×•×§ ×¢× × ×ª×•× ×™ ×“×•×’××”</button>
    </div>

    <!-- Floating Screen Tests -->
    <div class="debug-panel">
        <div class="debug-title">ğŸ­ Floating Screen Tests</div>
        <div id="floating-screen-results"></div>
        <button class="test-button" onclick="testFloatingScreen()">×¤×ª×— ××¡×š ×¦×£</button>
        <button class="test-button" onclick="testTabSwitching()">×‘×“×•×§ ××¢×‘×¨ ×œ×©×•× ×™×•×ª</button>
        <button class="test-button" onclick="forceReloadTabs()">××œ×¥ ×¨×¢× ×•×Ÿ ×œ×©×•× ×™×•×ª</button>
    </div>

    <!-- Console Log Output -->
    <div class="debug-panel">
        <div class="debug-title">ğŸ“ Console Output</div>
        <div id="console-output" class="log-output">Waiting for tests...\n</div>
        <button class="test-button" onclick="clearConsole()">× ×§×” ×œ×•×’</button>
        <button class="test-button" onclick="exportLogs()">×™×™×¦× ×œ×•×’×™×</button>
    </div>

    <!-- Include Required Scripts -->
    <script src="services/supabaseClient.js"></script>
    <script src="invoice-details-floating.js"></script>

    <script>
        // Debug logging system
        let debugLogs = [];
        
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('he-IL');
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            debugLogs.push(logEntry);
            
            const output = document.getElementById('console-output');
            output.textContent += logEntry + '\n';
            output.scrollTop = output.scrollHeight;
            
            // Also log to browser console
            if (type === 'error') {
                console.error(message);
            } else if (type === 'warn') {
                console.warn(message);
            } else {
                console.log(message);
            }
        }

        // Environment Check
        function checkEnvironment() {
            debugLog('ğŸ” Starting environment check...');
            
            // Check Supabase
            const supabaseStatus = document.getElementById('supabase-status');
            if (window.supabase) {
                supabaseStatus.innerHTML = 'âœ… ×–××™×Ÿ';
                supabaseStatus.className = 'status-ok';
                debugLog('âœ… Supabase client is available');
            } else {
                supabaseStatus.innerHTML = 'âŒ ×œ× ×–××™×Ÿ';
                supabaseStatus.className = 'status-error';
                debugLog('âŒ Supabase client is NOT available', 'error');
            }

            // Check Helper
            const helperStatus = document.getElementById('helper-status');
            if (window.helper) {
                helperStatus.innerHTML = 'âœ… ×–××™×Ÿ';
                helperStatus.className = 'status-ok';
                debugLog('âœ… Window.helper is available: ' + JSON.stringify(Object.keys(window.helper)));
            } else {
                helperStatus.innerHTML = 'âŒ ×œ× ×–××™×Ÿ';
                helperStatus.className = 'status-warning';
                debugLog('âš ï¸ Window.helper is NOT available', 'warn');
            }

            // Check Session Storage
            const sessionStatus = document.getElementById('session-status');
            const currentCaseId = sessionStorage.getItem('currentCaseId');
            if (currentCaseId) {
                sessionStatus.innerHTML = 'âœ… ×™×© ××–×”×” ×ª×™×§';
                sessionStatus.className = 'status-ok';
                debugLog('âœ… Found currentCaseId in sessionStorage: ' + currentCaseId);
            } else {
                sessionStatus.innerHTML = 'âš ï¸ ××™×Ÿ ××–×”×” ×ª×™×§';
                sessionStatus.className = 'status-warning';
                debugLog('âš ï¸ No currentCaseId in sessionStorage', 'warn');
            }

            // Check Invoice Functions
            const functionsStatus = document.getElementById('functions-status');
            if (window.toggleInvoiceDetails && window.setInvoiceTab) {
                functionsStatus.innerHTML = 'âœ… ×¤×•× ×§×¦×™×•×ª ×–××™× ×•×ª';
                functionsStatus.className = 'status-ok';
                debugLog('âœ… Invoice functions are available');
            } else {
                functionsStatus.innerHTML = 'âŒ ×¤×•× ×§×¦×™×•×ª ×—×¡×¨×•×ª';
                functionsStatus.className = 'status-error';
                debugLog('âŒ Invoice functions are NOT available', 'error');
            }
        }

        // Test Case ID Detection
        function testCaseIdDetection() {
            debugLog('ğŸ¯ Testing case ID detection...');
            
            const resultsDiv = document.getElementById('case-id-results');
            let results = '<div class="data-display">';
            
            // Test multiple sources
            const sources = [
                { name: 'window.helper?.cases?.id', value: window.helper?.cases?.id },
                { name: 'window.helper?.meta?.case_id', value: window.helper?.meta?.case_id },
                { name: 'sessionStorage.currentCaseId', value: sessionStorage.getItem('currentCaseId') },
                { name: 'window.helper?.damage_assessment?.case_id', value: window.helper?.damage_assessment?.case_id },
                { name: 'window.helper?.meta?.plate', value: window.helper?.meta?.plate }
            ];

            sources.forEach(source => {
                const status = source.value ? 'âœ…' : 'âŒ';
                results += `<div>${status} ${source.name}: ${source.value || '×œ× × ××¦×'}</div>`;
                debugLog(`${status} ${source.name}: ${source.value || 'Not found'}`);
            });
            
            results += '</div>';
            resultsDiv.innerHTML = results;
        }

        // Mock Case ID for testing
        function mockCaseId() {
            const mockId = 'test-case-' + Date.now();
            sessionStorage.setItem('currentCaseId', mockId);
            
            // Also create mock helper if it doesn't exist
            if (!window.helper) {
                window.helper = {
                    meta: { case_id: mockId, plate: '123-45-678' },
                    cases: { id: mockId }
                };
            }
            
            debugLog('âœ… Created mock case ID: ' + mockId);
            testCaseIdDetection();
        }

        // Test Database Queries
        async function testInvoiceDocumentsQuery() {
            debugLog('ğŸ—„ï¸ Testing invoice documents query...');
            
            if (!window.supabase) {
                debugLog('âŒ Cannot test query - Supabase not available', 'error');
                return;
            }

            const caseId = sessionStorage.getItem('currentCaseId') || 'test-case';
            debugLog('ğŸ” Using case ID: ' + caseId);

            try {
                const { data, error } = await window.supabase
                    .from('invoice_documents')
                    .select(`
                        *,
                        invoice:invoices(
                            id,
                            invoice_number,
                            supplier_name,
                            total_amount,
                            status
                        )
                    `)
                    .eq('case_id', caseId)
                    .order('created_at', { ascending: false });

                const resultsDiv = document.getElementById('db-query-results');
                
                if (error) {
                    debugLog('âŒ Query error: ' + error.message, 'error');
                    resultsDiv.innerHTML = `<div class="error-display">×©×’×™××”: ${error.message}</div>`;
                } else {
                    debugLog('âœ… Query successful, found ' + (data?.length || 0) + ' records');
                    resultsDiv.innerHTML = `<div class="data-display">× ××¦××• ${data?.length || 0} ××¡××›×™ ×—×©×‘×•× ×™×ª<br>× ×ª×•× ×™×: ${JSON.stringify(data, null, 2)}</div>`;
                }
            } catch (err) {
                debugLog('âŒ Query exception: ' + err.message, 'error');
                const resultsDiv = document.getElementById('db-query-results');
                resultsDiv.innerHTML = `<div class="error-display">×—×¨×™×’×”: ${err.message}</div>`;
            }
        }

        async function testMappingsQuery() {
            debugLog('ğŸ—„ï¸ Testing mappings query...');
            
            if (!window.supabase) {
                debugLog('âŒ Cannot test query - Supabase not available', 'error');
                return;
            }

            const caseId = sessionStorage.getItem('currentCaseId') || 'test-case';
            debugLog('ğŸ” Using case ID: ' + caseId);

            try {
                const { data, error } = await window.supabase
                    .from('invoice_damage_center_mappings')
                    .select(`
                        *,
                        invoice:invoices(
                            invoice_number,
                            supplier_name,
                            total_amount
                        ),
                        invoice_line:invoice_lines(
                            description,
                            quantity,
                            unit_price,
                            line_total
                        )
                    `)
                    .eq('case_id', caseId)
                    .eq('mapping_status', 'active')
                    .order('damage_center_id')
                    .order('created_at', { ascending: false });

                const resultsDiv = document.getElementById('db-query-results');
                
                if (error) {
                    debugLog('âŒ Mappings query error: ' + error.message, 'error');
                    resultsDiv.innerHTML += `<div class="error-display">×©×’×™××ª ×”×§×¦××•×ª: ${error.message}</div>`;
                } else {
                    debugLog('âœ… Mappings query successful, found ' + (data?.length || 0) + ' records');
                    resultsDiv.innerHTML += `<div class="data-display">× ××¦××• ${data?.length || 0} ×”×§×¦××•×ª<br>× ×ª×•× ×™×: ${JSON.stringify(data, null, 2)}</div>`;
                }
            } catch (err) {
                debugLog('âŒ Mappings query exception: ' + err.message, 'error');
                const resultsDiv = document.getElementById('db-query-results');
                resultsDiv.innerHTML += `<div class="error-display">×—×¨×™×’×ª ×”×§×¦××•×ª: ${err.message}</div>`;
            }
        }

        function testWithMockData() {
            debugLog('ğŸ“ Creating mock data for testing...');
            
            // Mock invoice documents data
            const mockInvoiceDocuments = [
                {
                    id: 'mock-doc-1',
                    filename: 'invoice-test-1.pdf',
                    storage_path: 'invoices/test-1.pdf',
                    storage_bucket: 'docs',
                    ocr_status: 'completed',
                    ocr_confidence: 95,
                    language_detected: 'he',
                    created_at: new Date().toISOString(),
                    ocr_structured_data: {
                        invoice_details: {
                            '××¡×¤×¨ ×—×©×‘×•× ×™×ª': 'INV-001',
                            '×¡×¤×§': '××•×¡×š ×‘×“×™×§×”',
                            '×ª××¨×™×š': '2025-11-04'
                        },
                        items: [
                            { description: '×—×œ×§ ×‘×“×™×§×” 1', quantity: 1, unit_price: 100, total_price: 100 },
                            { description: '×¢×‘×•×“×” ×‘×“×™×§×”', quantity: 2, unit_price: 50, total_price: 100 }
                        ]
                    }
                }
            ];

            // Mock mappings data  
            const mockMappings = [
                {
                    id: 'mock-mapping-1',
                    damage_center_id: 'center_1',
                    damage_center_name: '××•×§×“ × ×–×§ ×§×“××™',
                    field_type: 'part',
                    mapped_data: {
                        name: '×¤× ×¡ ×§×“××™',
                        description: '×¤× ×¡ ×§×“××™ ×™×× ×™',
                        quantity: 1,
                        costWithoutVat: 500
                    },
                    mapping_status: 'active',
                    created_at: new Date().toISOString(),
                    invoice: {
                        invoice_number: 'INV-001',
                        supplier_name: '××•×¡×š ×‘×“×™×§×”'
                    }
                }
            ];

            // Simulate successful data load
            debugLog('âœ… Mock data created successfully');
            
            const resultsDiv = document.getElementById('db-query-results');
            resultsDiv.innerHTML = `
                <div class="data-display">
                    <strong>× ×ª×•× ×™ ×“×•×’××” × ×•×¦×¨×•:</strong><br>
                    ğŸ“„ ${mockInvoiceDocuments.length} ××¡××›×™ ×—×©×‘×•× ×™×ª<br>
                    ğŸ”— ${mockMappings.length} ×”×§×¦××•×ª<br>
                    <button onclick="loadMockDataToModal()" class="test-button">×˜×¢×Ÿ ×œ×—×œ×•×Ÿ ×¦×£</button>
                </div>
            `;
        }

        // Test Floating Screen
        function testFloatingScreen() {
            debugLog('ğŸ­ Testing floating screen...');
            
            const resultsDiv = document.getElementById('floating-screen-results');
            
            // Check if modal exists
            const modal = document.getElementById('invoiceDetailsModal');
            if (!modal) {
                debugLog('âŒ Modal element not found', 'error');
                resultsDiv.innerHTML = '<div class="error-display">âŒ Modal element not found</div>';
                return;
            }

            // Check if toggle function exists
            if (typeof window.toggleInvoiceDetails !== 'function') {
                debugLog('âŒ toggleInvoiceDetails function not found', 'error');
                resultsDiv.innerHTML = '<div class="error-display">âŒ toggleInvoiceDetails function not found</div>';
                return;
            }

            // Try to open the modal
            try {
                window.toggleInvoiceDetails();
                debugLog('âœ… Floating screen opened successfully');
                resultsDiv.innerHTML = '<div class="data-display">âœ… Floating screen opened</div>';
                
                // Check if content is loading
                setTimeout(() => {
                    const contentDiv = document.getElementById('documentsContent');
                    if (contentDiv) {
                        debugLog('ğŸ“„ Documents content div found: ' + contentDiv.innerHTML.substring(0, 100) + '...');
                    } else {
                        debugLog('âŒ Documents content div not found', 'error');
                    }
                }, 1000);
                
            } catch (err) {
                debugLog('âŒ Error opening floating screen: ' + err.message, 'error');
                resultsDiv.innerHTML = `<div class="error-display">âŒ Error: ${err.message}</div>`;
            }
        }

        function testTabSwitching() {
            debugLog('ğŸ”„ Testing tab switching...');
            
            if (typeof window.setInvoiceTab !== 'function') {
                debugLog('âŒ setInvoiceTab function not found', 'error');
                return;
            }

            // Test both tabs
            window.setInvoiceTab('documents');
            debugLog('âœ… Switched to documents tab');
            
            setTimeout(() => {
                window.setInvoiceTab('mappings');
                debugLog('âœ… Switched to mappings tab');
                
                setTimeout(() => {
                    window.setInvoiceTab('documents');
                    debugLog('âœ… Switched back to documents tab');
                }, 1000);
            }, 1000);
        }

        function forceReloadTabs() {
            debugLog('ğŸ”„ Force reloading tabs...');
            
            if (window.refreshInvoiceData) {
                window.refreshInvoiceData();
                debugLog('âœ… Called refreshInvoiceData()');
            } else {
                debugLog('âŒ refreshInvoiceData function not found', 'error');
            }
        }

        // Utility functions
        function clearConsole() {
            debugLogs = [];
            document.getElementById('console-output').textContent = '';
            debugLog('ğŸ§¹ Console cleared');
        }

        function exportLogs() {
            const logsText = debugLogs.join('\n');
            const blob = new Blob([logsText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `invoice-debug-logs-${new Date().toISOString().slice(0,19)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            debugLog('ğŸ’¾ Logs exported');
        }

        // Auto-run environment check on load
        window.addEventListener('load', () => {
            debugLog('ğŸš€ Debug tool loaded');
            setTimeout(checkEnvironment, 500);
        });

        // Console command helper
        window.debugInvoiceScreen = {
            checkEnv: checkEnvironment,
            testCaseId: testCaseIdDetection,
            mockCase: mockCaseId,
            testDocs: testInvoiceDocumentsQuery,
            testMappings: testMappingsQuery,
            openScreen: testFloatingScreen,
            switchTabs: testTabSwitching,
            reload: forceReloadTabs,
            logs: () => debugLogs,
            help: () => {
                console.log(`
Debug Invoice Screen Commands:
- debugInvoiceScreen.checkEnv() - Check environment
- debugInvoiceScreen.testCaseId() - Test case ID detection  
- debugInvoiceScreen.mockCase() - Create mock case ID
- debugInvoiceScreen.testDocs() - Test documents query
- debugInvoiceScreen.testMappings() - Test mappings query
- debugInvoiceScreen.openScreen() - Open floating screen
- debugInvoiceScreen.switchTabs() - Test tab switching
- debugInvoiceScreen.reload() - Force reload tabs
- debugInvoiceScreen.logs() - Get debug logs
                `);
            }
        };

        debugLog('ğŸ’¡ Console commands available: debugInvoiceScreen.help()');
    </script>
</body>
</html>