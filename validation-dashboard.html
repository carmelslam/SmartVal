<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×œ×•×— ×‘×§×¨×ª ××™××•×ª - ×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª</title>
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link rel="shortcut icon" href="https://carmelcayouf.com/wp-content/uploads/2025/04/logo-yaron.webp">
  <link rel="apple-touch-icon" href="https://carmelcayouf.com/wp-content/uploads/2025/04/logo-yaron.webp">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      direction: rtl;
      padding: 20px;
    }
    
    .dashboard-container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 30px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    
    .logo {
      width: 120px;
      height: auto;
      margin-bottom: 20px;
    }
    
    .header h1 {
      color: #333;
      font-size: 32px;
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .header p {
      color: #666;
      font-size: 18px;
    }

    .session-info {
      background: #f0f9ff;
      border: 2px solid #3b82f6;
      border-radius: 15px;
      padding: 20px;
      margin-top: 25px;
      text-align: right;
    }

    .session-info h3 {
      color: #1e40af;
      font-size: 18px;
      margin-bottom: 15px;
      border-bottom: 1px solid #3b82f6;
      padding-bottom: 8px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    .info-item {
      background: white;
      padding: 10px 15px;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
      font-size: 14px;
    }

    .current-session {
      background: white;
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
    }

    .current-session h4 {
      color: #1f2937;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .session-details {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      font-size: 14px;
    }

    .session-details span {
      background: #f3f4f6;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }
    
    .card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    }
    
    .card h3 {
      color: #333;
      font-size: 20px;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 3px solid #667eea;
    }
    
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-left: 10px;
    }
    
    .status-valid { background: #28a745; }
    .status-invalid { background: #dc3545; }
    .status-warning { background: #ffc107; }
    .status-pending { background: #6c757d; }
    
    .metric {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }
    
    .metric:last-child {
      border-bottom: none;
    }
    
    .metric-label {
      color: #666;
      font-size: 14px;
    }
    
    .metric-value {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    
    .metric-value.error { color: #dc3545; }
    .metric-value.warning { color: #ffc107; }
    .metric-value.success { color: #28a745; }
    
    .validation-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 10px;
      background: #f9f9f9;
    }
    
    .validation-item {
      padding: 8px 12px;
      margin: 5px 0;
      border-radius: 6px;
      font-size: 14px;
      line-height: 1.4;
    }
    
    .validation-item.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .validation-item.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .validation-item.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
    }
    
    .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-info {
      background: #17a2b8;
      color: white;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .floating-access {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin: 25px 0;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    .floating-access h3 {
      color: #333;
      font-size: 20px;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 3px solid #17a2b8;
      text-align: center;
    }

    .floating-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .clickable-metric {
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      border-radius: 8px;
      padding: 8px 12px;
      margin: -8px -12px;
    }

    .clickable-metric:hover {
      background-color: #f0f9ff;
      transform: translateX(-5px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .drill-down-icon {
      font-size: 14px;
      opacity: 0.6;
      margin-right: 10px;
      transition: opacity 0.3s;
    }

    .clickable-metric:hover .drill-down-icon {
      opacity: 1;
    }

    .drill-down-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 15px;
      padding: 30px;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      z-index: 10000;
      direction: rtl;
    }

    .drill-down-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
    }

    .drill-down-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #667eea;
    }

    .drill-down-close {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-size: 18px;
    }
    
    .progress-bar {
      width: 100%;
      height: 20px;
      background: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
      transition: width 0.3s;
      border-radius: 10px;
    }
    
    .progress-fill.warning {
      background: linear-gradient(90deg, #ffc107 0%, #fd7e14 100%);
    }
    
    .progress-fill.error {
      background: linear-gradient(90deg, #dc3545 0%, #e83e8c 100%);
    }
    
    .navigation {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 15px 25px;
      border-radius: 25px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      display: flex;
      gap: 15px;
      z-index: 1000;
    }
    
    .nav-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
    }
    
    .nav-btn.primary {
      background: #667eea;
      color: white;
    }
    
    .nav-btn.secondary {
      background: #6c757d;
      color: white;
    }
    
    .nav-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .auto-refresh {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 15px;
      font-size: 14px;
      color: #666;
    }
    
    .auto-refresh input[type="checkbox"] {
      transform: scale(1.2);
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .header h1 {
        font-size: 28px;
      }
      
      .actions {
        flex-direction: column;
        align-items: center;
      }
      
      .btn {
        width: 100%;
        max-width: 300px;
      }
      
      .navigation {
        bottom: 10px;
        left: 10px;
        right: 10px;
        transform: none;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <!-- Header -->
    <div class="header">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/04/logo-yaron.webp" alt="×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª" class="logo">
      <h1>ğŸ›¡ï¸ ×œ×•×— ×‘×§×¨×ª ××™××•×ª</h1>
      <p>××¢×¨×›×ª ××™××•×ª × ×ª×•× ×™× ×•×‘×§×¨×ª ××™×›×•×ª</p>
      
      <!-- Session Info -->
      <div class="session-info">
        <h3>â„¹ï¸ ××™×“×¢ ×¢×œ ×”××•×“×•×œ</h3>
        <div class="info-grid">
          <div class="info-item">
            <strong>×¡×•×’ ××™××•×ª:</strong> × ×ª×•× ×™ ×”×”×¤×¢×œ×” ×”× ×•×›×—×™×ª ×‘×œ×‘×“
          </div>
          <div class="info-item">
            <strong>××§×•×¨ × ×ª×•× ×™×:</strong> ×”×ª×™×§ ×”×¤×¢×™×œ ×›×¨×’×¢ ×‘××¢×¨×›×ª
          </div>
          <div class="info-item">
            <strong>××˜×¨×”:</strong> ×‘×§×¨×ª ××™×›×•×ª ×œ×¤× ×™ ×”×¤×§×ª ×“×•×—×•×ª
          </div>
          <div class="info-item">
            <strong>×’×™×©×”:</strong> ×× ×”×œ×™ ××¢×¨×›×ª ×‘×œ×‘×“
          </div>
        </div>
        
        <!-- Current Session Status -->
        <div class="current-session">
          <h4>ğŸ“‹ ×ª×™×§ ×¤×¢×™×œ ×›×¨×’×¢:</h4>
          <div class="session-details">
            <span><strong>××¡×¤×¨ ×¨×›×‘:</strong> <span id="current-plate">×˜×•×¢×Ÿ...</span></span>
            <span><strong>×¡×˜×˜×•×¡ ×”×¤×¢×œ×”:</strong> <span id="session-status">×‘×•×“×§...</span></span>
            <span><strong>×–××Ÿ ×˜×¢×™× ×”:</strong> <span id="session-time">×˜×•×¢×Ÿ...</span></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
      <!-- Overall Status Card -->
      <div class="card">
        <h3>ğŸ¯ ×¡×˜×˜×•×¡ ×›×œ×œ×™ <span class="status-indicator" id="overall-status"></span></h3>
        <div class="metric">
          <span class="metric-label">×¡×˜×˜×•×¡ ××™××•×ª:</span>
          <span class="metric-value" id="validation-status">×‘×“×™×§×”...</span>
        </div>
        <div class="metric">
          <span class="metric-label">××—×•×– ×”×©×œ××”:</span>
          <span class="metric-value" id="completion-percentage">0%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="completion-progress" style="width: 0%"></div>
        </div>
        <div class="metric">
          <span class="metric-label">×‘×“×™×§×” ××—×¨×•× ×”:</span>
          <span class="metric-value" id="last-check">×˜×¨× ×‘×•×¦×¢×”</span>
        </div>
      </div>

      <!-- Errors Card -->
      <div class="card">
        <h3>âŒ ×©×’×™××•×ª <span class="status-indicator status-invalid" id="errors-indicator"></span></h3>
        <div class="metric">
          <span class="metric-label">×¡×”"×› ×©×’×™××•×ª:</span>
          <span class="metric-value error" id="total-errors">0</span>
        </div>
        <div class="validation-list" id="errors-list">
          <div class="validation-item">×˜×•×¢×Ÿ ×©×’×™××•×ª...</div>
        </div>
      </div>

      <!-- Warnings Card -->
      <div class="card">
        <h3>âš ï¸ ××–×”×¨×•×ª <span class="status-indicator status-warning" id="warnings-indicator"></span></h3>
        <div class="metric">
          <span class="metric-label">×¡×”"×› ××–×”×¨×•×ª:</span>
          <span class="metric-value warning" id="total-warnings">0</span>
        </div>
        <div class="validation-list" id="warnings-list">
          <div class="validation-item">×˜×•×¢×Ÿ ××–×”×¨×•×ª...</div>
        </div>
      </div>

      <!-- Vehicle Data Card -->
      <div class="card">
        <h3>ğŸš— ×¤×¨×˜×™ ×¨×›×‘ <span class="status-indicator" id="vehicle-status"></span></h3>
        <div class="metric">
          <span class="metric-label">××¡×¤×¨ ×¨×™×©×•×™:</span>
          <span class="metric-value" id="vehicle-plate">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">×™×¦×¨×Ÿ ×•×“×’×:</span>
          <span class="metric-value" id="vehicle-model">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">×©× ×ª ×™×™×¦×•×¨:</span>
          <span class="metric-value" id="vehicle-year">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">×¡×˜×˜×•×¡ ××™××•×ª:</span>
          <span class="metric-value" id="vehicle-validation">×‘×“×™×§×”...</span>
        </div>
      </div>

      <!-- Damage Data Card -->
      <div class="card">
        <h3>ğŸ§± × ×ª×•× ×™ × ×–×§ <span class="status-indicator" id="damage-status"></span></h3>
        <div class="metric clickable-metric" onclick="drillDownDamage('centers')">
          <span class="metric-label">××¡×¤×¨ ××•×§×“×™ × ×–×§:</span>
          <span class="metric-value" id="damage-centers-count">0</span>
          <span class="drill-down-icon">ğŸ”</span>
        </div>
        <div class="metric clickable-metric" onclick="drillDownDamage('parts')">
          <span class="metric-label">×¡×”"×› ×—×œ×§×™×:</span>
          <span class="metric-value" id="total-parts">0</span>
          <span class="drill-down-icon">ğŸ”</span>
        </div>
        <div class="metric clickable-metric" onclick="drillDownDamage('repairs')">
          <span class="metric-label">×¡×”"×› ×ª×™×§×•× ×™×:</span>
          <span class="metric-value" id="total-repairs">0</span>
          <span class="drill-down-icon">ğŸ”</span>
        </div>
        <div class="metric">
          <span class="metric-label">×¡×˜×˜×•×¡ ××™××•×ª:</span>
          <span class="metric-value" id="damage-validation">×‘×“×™×§×”...</span>
        </div>
      </div>

      <!-- Invoice Status Card -->
      <div class="card">
        <h3>ğŸ§¾ ×¡×˜×˜×•×¡ ×—×©×‘×•× ×™×•×ª <span class="status-indicator" id="invoice-status"></span></h3>
        <div class="metric">
          <span class="metric-label">×“×¨×•×© ×—×©×‘×•× ×™×ª:</span>
          <span class="metric-value" id="invoice-required">×‘×•×“×§...</span>
        </div>
        <div class="metric">
          <span class="metric-label">×—×©×‘×•× ×™×ª ×”×ª×§×‘×œ×”:</span>
          <span class="metric-value" id="invoice-received">×œ×</span>
        </div>
        <div class="metric">
          <span class="metric-label">×¡×”"×› ××—×©×‘×•× ×™×ª:</span>
          <span class="metric-value" id="invoice-total">â‚ª0</span>
        </div>
        <div class="metric">
          <span class="metric-label">×¡×˜×˜×•×¡ ××™××•×ª:</span>
          <span class="metric-value" id="invoice-validation">×‘×“×™×§×”...</span>
        </div>
      </div>

      <!-- Levi Adjustments Card -->
      <div class="card">
        <h3>ğŸ“ˆ ×”×ª×××•×ª ×œ×•×™ ×™×¦×—×§ <span class="status-indicator" id="levi-status"></span></h3>
        <div class="metric">
          <span class="metric-label">×“×•×— ×œ×•×™ ×§×™×™×:</span>
          <span class="metric-value" id="levi-exists">×œ×</span>
        </div>
        <div class="metric">
          <span class="metric-label">×©×•×•×™ ×©×•×§:</span>
          <span class="metric-value" id="market-value">â‚ª0</span>
        </div>
        <div class="metric">
          <span class="metric-label">×”×ª×××•×ª ××—×™×¨:</span>
          <span class="metric-value" id="price-adjustments">0</span>
        </div>
        <div class="metric">
          <span class="metric-label">×¡×˜×˜×•×¡ ××™××•×ª:</span>
          <span class="metric-value" id="levi-validation">×‘×“×™×§×”...</span>
        </div>
      </div>

      <!-- Depreciation Card -->
      <div class="card">
        <h3>ğŸ“‰ ×™×¨×™×“×ª ×¢×¨×š <span class="status-indicator" id="depreciation-status"></span></h3>
        <div class="metric">
          <span class="metric-label">×™×¨×™×“×ª ×¢×¨×š ×”×•×’×“×¨×”:</span>
          <span class="metric-value" id="depreciation-defined">×œ×</span>
        </div>
        <div class="metric">
          <span class="metric-label">×¡×›×•× ×™×¨×™×“×ª ×¢×¨×š:</span>
          <span class="metric-value" id="depreciation-amount">â‚ª0</span>
        </div>
        <div class="metric">
          <span class="metric-label">××—×•×– ×™×¨×™×“×ª ×¢×¨×š:</span>
          <span class="metric-value" id="depreciation-percentage">0%</span>
        </div>
        <div class="metric">
          <span class="metric-label">×¡×˜×˜×•×¡ ××™××•×ª:</span>
          <span class="metric-value" id="depreciation-validation">×‘×“×™×§×”...</span>
        </div>
      </div>

      <!-- Professional Standards Card -->
      <div class="card">
        <h3>âš–ï¸ ×ª×§× ×™× ××§×¦×•×¢×™×™× <span class="status-indicator" id="professional-status"></span></h3>
        <div class="metric clickable-metric" onclick="drillDownProfessional('timeline')">
          <span class="metric-label">×™××™× ××™×¦×™×¨×ª ××§×¡×¤×¨×˜×™×–×”:</span>
          <span class="metric-value" id="case-age">0</span>
          <span class="drill-down-icon">ğŸ”</span>
        </div>
        <div class="metric clickable-metric" onclick="drillDownProfessional('completeness')">
          <span class="metric-label">××—×•×– ×”×©×œ××ª ×ª×™×¢×•×“:</span>
          <span class="metric-value" id="documentation-completeness">0%</span>
          <span class="drill-down-icon">ğŸ”</span>
        </div>
        <div class="metric clickable-metric" onclick="drillDownProfessional('readiness')">
          <span class="metric-label">××•×›× ×•×ª ×œ×“×•×— ×¡×•×¤×™:</span>
          <span class="metric-value" id="report-readiness">×œ× ××•×›×Ÿ</span>
          <span class="drill-down-icon">ğŸ”</span>
        </div>
        <div class="metric">
          <span class="metric-label">×¡×˜×˜×•×¡ ××§×¦×•×¢×™:</span>
          <span class="metric-value" id="professional-validation">×‘×“×™×§×”...</span>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="actions">
      <button class="btn btn-primary" onclick="refreshValidation()">ğŸ”„ ×¨×¢× ×Ÿ ××™××•×ª</button>
      <button class="btn btn-secondary" onclick="exportValidationReport()">ğŸ“Š ×™×™×¦× ×“×•×—</button>
      <button class="btn btn-success" onclick="fixAllErrors()" id="fix-errors-btn" disabled>ğŸ”§ ×ª×§×Ÿ ×©×’×™××•×ª</button>
      <button class="btn btn-danger" onclick="clearValidationData()">ğŸ—‘ï¸ × ×§×” × ×ª×•× ×™×</button>
    </div>

    <!-- Floating Screen Access -->
    <div class="floating-access">
      <h3>ğŸªŸ ××¡×›×™ ××™×“×¢ ××¨×—×¤×™×</h3>
      <div class="floating-buttons">
        <button class="btn btn-info" onclick="openCarDetailsFloating()">ğŸš— ×¤×¨×˜×™ ×¨×›×‘</button>
        <button class="btn btn-info" onclick="openLeviFloating()">ğŸ“Š ×“×•×— ×œ×•×™ ×™×¦×—×§</button>
        <button class="btn btn-info" onclick="openPartsFloating()">ğŸ”§ ×—×™×¤×•×© ×—×œ×§×™×</button>
        <button class="btn btn-info" onclick="openInvoiceFloating()">ğŸ§¾ ×¤×¨×˜×™ ×—×©×‘×•× ×™×ª</button>
      </div>
    </div>

    <!-- Auto-refresh control -->
    <div class="card">
      <div class="auto-refresh">
        <input type="checkbox" id="auto-refresh-checkbox" onchange="toggleAutoRefresh()">
        <label for="auto-refresh-checkbox">×¨×¢× ×•×Ÿ ××•×˜×•××˜×™ ×›×œ 30 ×©× ×™×•×ª</label>
        <span id="refresh-countdown"></span>
      </div>
    </div>

    <!-- Navigation -->
    <div class="navigation">
      <a href="selection.html" class="nav-btn secondary">ğŸ  ×¢××•×“ ×”×‘×™×ª</a>
      <a href="car-details.html" class="nav-btn secondary">ğŸš— ×¤×¨×˜×™ ×¨×›×‘</a>
      <a href="enhanced-damage-centers.html" class="nav-btn primary">ğŸ§± ××•×§×“×™ × ×–×§</a>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    // Import validation system with fallback
    let validationSystem = null;
    let helper = null;
    
    try {
      const validationModule = await import('./validation-system.js');
      validationSystem = validationModule.validationSystem;
      console.log('âœ… Validation system imported successfully');
    } catch (error) {
      console.warn('âš ï¸ Could not import validation-system.js:', error);
    }
    
    try {
      const helperModule = await import('./helper.js');
      helper = helperModule.helper;
      console.log('âœ… Helper imported successfully');
    } catch (error) {
      console.warn('âš ï¸ Could not import helper.js:', error);
    }

    let autoRefreshInterval = null;
    let refreshCountdown = 30;
    let countdownInterval = null;

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', () => {
      // Check authentication
      const auth = sessionStorage.getItem("auth");
      if (!auth) {
        alert("×”×’×™×©×” ×—×¡×•××” - ×× × ×”×ª×—×‘×¨ ×“×¨×š ×“×£ ×”×‘×™×ª");
        window.location.href = "index.html";
        return;
      }

      // Load initial session info
      updateSessionInfo();

      // Load initial validation data
      setTimeout(() => {
        refreshValidation();
      }, 500); // Add small delay to ensure modules are loaded
      
      // Setup keyboard shortcuts
      setupKeyboardShortcuts();
      
      console.log('ğŸ›¡ï¸ Validation Dashboard initialized');
    });

    // Update session information display
    function updateSessionInfo() {
      try {
        // Get current plate from various sources
        const currentPlate = helper?.vehicle?.plate || 
                           helper?.vehicle?.plate_number || 
                           helper?.car_details?.plate ||
                           sessionStorage.getItem('plate') ||
                           '××™×Ÿ ×ª×™×§ ×¤×¢×™×œ';

        // Get session status
        const caseLoaded = sessionStorage.getItem('caseLoaded');
        const sessionStatus = caseLoaded ? '×ª×™×§ ×¤×¢×™×œ' : '××™×Ÿ ×ª×™×§ ×¤×¢×™×œ';

        // Get session time
        const loginTime = sessionStorage.getItem('loginTime');
        const sessionTime = loginTime ? 
          new Date(loginTime).toLocaleString('he-IL') : 
          '×œ× ×–××™×Ÿ';

        // Update UI elements
        document.getElementById('current-plate').textContent = currentPlate;
        document.getElementById('session-status').textContent = sessionStatus;
        document.getElementById('session-time').textContent = sessionTime;

        // Update status styling
        const statusElement = document.getElementById('session-status');
        if (caseLoaded && currentPlate !== '××™×Ÿ ×ª×™×§ ×¤×¢×™×œ') {
          statusElement.style.color = '#059669';
          statusElement.style.fontWeight = 'bold';
        } else {
          statusElement.style.color = '#dc2626';
          statusElement.style.fontWeight = 'bold';
        }

        console.log('ğŸ“‹ Session info updated:', { currentPlate, sessionStatus, sessionTime });

      } catch (error) {
        console.error('âŒ Error updating session info:', error);
        document.getElementById('current-plate').textContent = '×©×’×™××” ×‘×˜×¢×™× ×”';
        document.getElementById('session-status').textContent = '×œ× ×–××™×Ÿ';
        document.getElementById('session-time').textContent = '×œ× ×–××™×Ÿ';
      }
    }

    function refreshValidation() {
      console.log('ğŸ”„ Refreshing validation data...');
      
      try {
        // Get validation summary with fallback logic
        let summary = null;
        
        if (validationSystem && typeof validationSystem.getValidationSummary === 'function') {
          summary = validationSystem.getValidationSummary();
          console.log('ğŸ“Š Using validation system data:', summary);
        } else {
          // Fallback: create summary from helper data directly
          summary = createValidationSummaryFromHelper();
          console.log('ğŸ“Š Using fallback validation data:', summary);
        }
        
        // Update all dashboard sections
        updateOverallStatus(summary);
        updateErrors(summary);
        updateWarnings(summary);
        updateVehicleData(summary);
        updateDamageData(summary);
        updateInvoiceStatus(summary);
        updateLeviData(summary);
        updateDepreciationData(summary);
        updateProfessionalStandards(summary);
        
        // Update last check time
        document.getElementById('last-check').textContent = new Date().toLocaleTimeString('he-IL');
        
        // Update session info
        updateSessionInfo();
        
        console.log('âœ… Validation data refreshed successfully');
        
      } catch (error) {
        console.error('âŒ Error refreshing validation data:', error);
        showError('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”××™××•×ª: ' + error.message);
        
        // Show fallback data even on error
        try {
          const fallbackSummary = createEmptyValidationSummary();
          updateOverallStatus(fallbackSummary);
          updateErrors(fallbackSummary);
          updateWarnings(fallbackSummary);
          updateVehicleData(fallbackSummary);
          updateDamageData(fallbackSummary);
          updateInvoiceStatus(fallbackSummary);
          updateLeviData(fallbackSummary);
          updateDepreciationData(fallbackSummary);
          updateProfessionalStandards(fallbackSummary);
        } catch (fallbackError) {
          console.error('âŒ Fallback also failed:', fallbackError);
        }
      }
    }

    // Create validation summary from helper data
    function createValidationSummaryFromHelper() {
      const helperData = helper || {};
      const errors = [];
      const warnings = [];
      
      // Check vehicle data
      const vehicleErrors = [];
      const vehicleWarnings = [];
      const vehicle = helperData.vehicle || helperData.car_details || {};
      
      if (!vehicle.plate && !vehicle.plate_number) vehicleErrors.push('××¡×¤×¨ ×¨×›×‘ ×—×¡×¨');
      if (!vehicle.manufacturer) vehicleErrors.push('×™×¦×¨×Ÿ ×—×¡×¨');
      if (!vehicle.model) vehicleErrors.push('×“×’× ×—×¡×¨');
      if (!vehicle.year) vehicleErrors.push('×©× ×ª ×™×™×¦×•×¨ ×—×¡×¨×”');
      
      // Check damage data
      const damageErrors = [];
      const damageWarnings = [];
      const damage = helperData.damage || {};
      const centers = damage.centers || helperData.damage_sections || [];
      
      if (centers.length === 0) {
        damageErrors.push('×œ× ×”×•×’×“×¨×• ××•×§×“×™ × ×–×§');
      }
      
      // Check invoice requirements (conditional based on report type)
      const invoiceErrors = [];
      const invoiceWarnings = [];
      const reportType = helperData.meta?.report_type || '';
      const finalReportTypes = ['final', 'Final_Private', 'Final_Global', 'Final_Total', 'Final_Sale'];
      const invoiceRequired = finalReportTypes.some(type => reportType.includes(type));
      
      if (invoiceRequired && !helperData.invoice_uploaded && !helperData.invoice_summary) {
        invoiceErrors.push('×“×•×— ×¡×•×¤×™ ×“×•×¨×© ×—×©×‘×•× ×™×ª');
      }

      // Check Levi report
      const leviErrors = [];
      const leviWarnings = [];
      
      if (!helperData.levi_report && !helperData.car_details?.market_value) {
        leviWarnings.push('×—×¡×¨ ×“×•×— ×œ×•×™ ×™×¦×—×§ ××• ×©×•×•×™ ×©×•×§');
      }

      // Check depreciation
      const depreciationErrors = [];
      const depreciationWarnings = [];
      
      if (!helperData.expertise?.depreciation && !helperData.depreciation) {
        depreciationWarnings.push('×œ× ×”×•×’×“×¨×” ×™×¨×™×“×ª ×¢×¨×š');
      }

      // Check professional standards
      const professionalErrors = [];
      const professionalWarnings = [];
      
      // Calculate case age
      const expertiseDate = helperData.meta?.submission_date || helperData.meta?.inspection_date;
      if (expertiseDate) {
        const daysSinceExpertise = Math.floor((new Date() - new Date(expertiseDate)) / (1000 * 60 * 60 * 24));
        if (daysSinceExpertise > 30) {
          professionalWarnings.push('×”×ª×™×§ ×¤×ª×•×— ×™×•×ª×¨ ×-30 ×™××™×');
        }
      }
      
      const totalErrors = vehicleErrors.length + damageErrors.length + invoiceErrors.length + 
                         leviErrors.length + depreciationErrors.length + professionalErrors.length;
      const totalWarnings = vehicleWarnings.length + damageWarnings.length + invoiceWarnings.length + 
                           leviWarnings.length + depreciationWarnings.length + professionalWarnings.length;
      
      return {
        isValid: totalErrors === 0,
        totalErrors,
        totalWarnings,
        lastValidation: new Date(),
        details: {
          vehicle: {
            isValid: vehicleErrors.length === 0,
            errors: vehicleErrors,
            warnings: vehicleWarnings
          },
          damage: {
            isValid: damageErrors.length === 0,
            errors: damageErrors,
            warnings: damageWarnings
          },
          invoice: {
            isValid: invoiceErrors.length === 0,
            errors: invoiceErrors,
            warnings: invoiceWarnings,
            required: invoiceRequired
          },
          levi: {
            isValid: leviErrors.length === 0,
            errors: leviErrors,
            warnings: leviWarnings
          },
          depreciation: {
            isValid: depreciationErrors.length === 0,
            errors: depreciationErrors,
            warnings: depreciationWarnings
          },
          professional: {
            isValid: professionalErrors.length === 0,
            errors: professionalErrors,
            warnings: professionalWarnings
          }
        }
      };
    }

    // Create empty validation summary for fallback
    function createEmptyValidationSummary() {
      return {
        isValid: false,
        totalErrors: 0,
        totalWarnings: 0,
        lastValidation: new Date(),
        details: {
          vehicle: { isValid: false, errors: ['× ×ª×•× ×™× ×œ× ×–××™× ×™×'], warnings: [] },
          damage: { isValid: false, errors: ['× ×ª×•× ×™× ×œ× ×–××™× ×™×'], warnings: [] },
          invoice: { isValid: false, errors: ['× ×ª×•× ×™× ×œ× ×–××™× ×™×'], warnings: [] },
          levi: { isValid: false, errors: ['× ×ª×•× ×™× ×œ× ×–××™× ×™×'], warnings: [] },
          depreciation: { isValid: false, errors: ['× ×ª×•× ×™× ×œ× ×–××™× ×™×'], warnings: [] },
          professional: { isValid: false, errors: ['× ×ª×•× ×™× ×œ× ×–××™× ×™×'], warnings: [] }
        }
      };
    }

    function updateOverallStatus(summary) {
      const statusIndicator = document.getElementById('overall-status');
      const statusText = document.getElementById('validation-status');
      const completionPercentage = document.getElementById('completion-percentage');
      const completionProgress = document.getElementById('completion-progress');
      
      if (summary.isValid) {
        statusIndicator.className = 'status-indicator status-valid';
        statusText.textContent = '×ª×§×™×Ÿ';
        statusText.className = 'metric-value success';
        completionPercentage.textContent = '100%';
        completionProgress.style.width = '100%';
        completionProgress.className = 'progress-fill';
      } else {
        statusIndicator.className = 'status-indicator status-invalid';
        statusText.textContent = '×“×•×¨×© ×ª×™×§×•×Ÿ';
        statusText.className = 'metric-value error';
        
        // Calculate completion percentage based on errors
        const totalItems = 10; // Assume 10 validation items
        const errorItems = Math.min(summary.totalErrors, totalItems);
        const percentage = Math.max(0, Math.round((totalItems - errorItems) / totalItems * 100));
        
        completionPercentage.textContent = `${percentage}%`;
        completionProgress.style.width = `${percentage}%`;
        completionProgress.className = percentage > 50 ? 'progress-fill warning' : 'progress-fill error';
      }
    }

    function updateErrors(summary) {
      const errorsIndicator = document.getElementById('errors-indicator');
      const totalErrors = document.getElementById('total-errors');
      const errorsList = document.getElementById('errors-list');
      
      totalErrors.textContent = summary.totalErrors;
      
      if (summary.totalErrors > 0) {
        errorsIndicator.className = 'status-indicator status-invalid';
        
        const errorItems = [];
        if (summary.details.vehicle && !summary.details.vehicle.isValid) {
          errorItems.push(...summary.details.vehicle.errors.map(e => `×¤×¨×˜×™ ×¨×›×‘: ${e}`));
        }
        if (summary.details.damage && !summary.details.damage.isValid) {
          errorItems.push(...summary.details.damage.errors.map(e => `× ×ª×•× ×™ × ×–×§: ${e}`));
        }
        if (summary.details.invoice && !summary.details.invoice.isValid) {
          errorItems.push(...summary.details.invoice.errors.map(e => `×—×©×‘×•× ×™×•×ª: ${e}`));
        }
        if (summary.details.levi && !summary.details.levi.isValid) {
          errorItems.push(...summary.details.levi.errors.map(e => `×œ×•×™ ×™×¦×—×§: ${e}`));
        }
        if (summary.details.depreciation && !summary.details.depreciation.isValid) {
          errorItems.push(...summary.details.depreciation.errors.map(e => `×™×¨×™×“×ª ×¢×¨×š: ${e}`));
        }
        if (summary.details.professional && !summary.details.professional.isValid) {
          errorItems.push(...summary.details.professional.errors.map(e => `×ª×§× ×™× ××§×¦×•×¢×™×™×: ${e}`));
        }
        
        errorsList.innerHTML = errorItems.length > 0 
          ? errorItems.map(error => `<div class="validation-item error">${error}</div>`).join('')
          : '<div class="validation-item">×œ× × ××¦××• ×©×’×™××•×ª ×¡×¤×¦×™×¤×™×•×ª</div>';
          
        document.getElementById('fix-errors-btn').disabled = false;
      } else {
        errorsIndicator.className = 'status-indicator status-valid';
        errorsList.innerHTML = '<div class="validation-item success">âœ… ××™×Ÿ ×©×’×™××•×ª</div>';
        document.getElementById('fix-errors-btn').disabled = true;
      }
    }

    function updateWarnings(summary) {
      const warningsIndicator = document.getElementById('warnings-indicator');
      const totalWarnings = document.getElementById('total-warnings');
      const warningsList = document.getElementById('warnings-list');
      
      totalWarnings.textContent = summary.totalWarnings;
      
      if (summary.totalWarnings > 0) {
        warningsIndicator.className = 'status-indicator status-warning';
        
        const warningItems = [];
        if (summary.details.vehicle && summary.details.vehicle.warnings.length > 0) {
          warningItems.push(...summary.details.vehicle.warnings.map(w => `×¤×¨×˜×™ ×¨×›×‘: ${w}`));
        }
        if (summary.details.damage && summary.details.damage.warnings.length > 0) {
          warningItems.push(...summary.details.damage.warnings.map(w => `× ×ª×•× ×™ × ×–×§: ${w}`));
        }
        if (summary.details.invoice && summary.details.invoice.warnings.length > 0) {
          warningItems.push(...summary.details.invoice.warnings.map(w => `×—×©×‘×•× ×™×•×ª: ${w}`));
        }
        if (summary.details.levi && summary.details.levi.warnings.length > 0) {
          warningItems.push(...summary.details.levi.warnings.map(w => `×œ×•×™ ×™×¦×—×§: ${w}`));
        }
        if (summary.details.depreciation && summary.details.depreciation.warnings.length > 0) {
          warningItems.push(...summary.details.depreciation.warnings.map(w => `×™×¨×™×“×ª ×¢×¨×š: ${w}`));
        }
        if (summary.details.professional && summary.details.professional.warnings.length > 0) {
          warningItems.push(...summary.details.professional.warnings.map(w => `×ª×§× ×™× ××§×¦×•×¢×™×™×: ${w}`));
        }
        
        warningsList.innerHTML = warningItems.length > 0 
          ? warningItems.map(warning => `<div class="validation-item warning">${warning}</div>`).join('')
          : '<div class="validation-item">×œ× × ××¦××• ××–×”×¨×•×ª ×¡×¤×¦×™×¤×™×•×ª</div>';
      } else {
        warningsIndicator.className = 'status-indicator status-valid';
        warningsList.innerHTML = '<div class="validation-item success">âœ… ××™×Ÿ ××–×”×¨×•×ª</div>';
      }
    }

    function updateVehicleData(summary) {
      const vehicleStatus = document.getElementById('vehicle-status');
      const vehiclePlate = document.getElementById('vehicle-plate');
      const vehicleModel = document.getElementById('vehicle-model');
      const vehicleYear = document.getElementById('vehicle-year');
      const vehicleValidation = document.getElementById('vehicle-validation');
      
      const vehicleData = helper.vehicle || {};
      
      vehiclePlate.textContent = vehicleData.plate || '×œ× ×”×•×–×Ÿ';
      vehicleModel.textContent = `${vehicleData.manufacturer || ''} ${vehicleData.model || ''}`.trim() || '×œ× ×”×•×–×Ÿ';
      vehicleYear.textContent = vehicleData.year || '×œ× ×”×•×–×Ÿ';
      
      if (summary.details.vehicle) {
        if (summary.details.vehicle.isValid) {
          vehicleStatus.className = 'status-indicator status-valid';
          vehicleValidation.textContent = '×ª×§×™×Ÿ';
          vehicleValidation.className = 'metric-value success';
        } else {
          vehicleStatus.className = 'status-indicator status-invalid';
          vehicleValidation.textContent = '×“×•×¨×© ×ª×™×§×•×Ÿ';
          vehicleValidation.className = 'metric-value error';
        }
      } else {
        vehicleStatus.className = 'status-indicator status-pending';
        vehicleValidation.textContent = '×œ× × ×‘×“×§';
        vehicleValidation.className = 'metric-value';
      }
    }

    function updateDamageData(summary) {
      const damageStatus = document.getElementById('damage-status');
      const centersCount = document.getElementById('damage-centers-count');
      const totalParts = document.getElementById('total-parts');
      const totalRepairs = document.getElementById('total-repairs');
      const damageValidation = document.getElementById('damage-validation');
      
      const damageData = helper.damage || {};
      const centers = damageData.centers || [];
      
      centersCount.textContent = centers.length;
      
      let partsCount = 0;
      let repairsCount = 0;
      
      centers.forEach(center => {
        if (center.parts) partsCount += center.parts.length;
        if (center.repairs) repairsCount += center.repairs.length;
      });
      
      totalParts.textContent = partsCount;
      totalRepairs.textContent = repairsCount;
      
      if (summary.details.damage) {
        if (summary.details.damage.isValid) {
          damageStatus.className = 'status-indicator status-valid';
          damageValidation.textContent = '×ª×§×™×Ÿ';
          damageValidation.className = 'metric-value success';
        } else {
          damageStatus.className = 'status-indicator status-invalid';
          damageValidation.textContent = '×“×•×¨×© ×ª×™×§×•×Ÿ';
          damageValidation.className = 'metric-value error';
        }
      } else {
        damageStatus.className = 'status-indicator status-pending';
        damageValidation.textContent = '×œ× × ×‘×“×§';
        damageValidation.className = 'metric-value';
      }
    }

    function updateInvoiceStatus(summary) {
      const invoiceStatus = document.getElementById('invoice-status');
      const invoiceRequired = document.getElementById('invoice-required');
      const invoiceReceived = document.getElementById('invoice-received');
      const invoiceTotal = document.getElementById('invoice-total');
      const invoiceValidation = document.getElementById('invoice-validation');
      
      const helperData = helper || {};
      const reportType = helperData.meta?.report_type || '';
      const finalReportTypes = ['final', 'Final_Private', 'Final_Global', 'Final_Total', 'Final_Sale'];
      const isInvoiceRequired = finalReportTypes.some(type => reportType.includes(type));
      
      // Update invoice requirement
      invoiceRequired.textContent = isInvoiceRequired ? '×›×Ÿ' : '×œ×';
      invoiceRequired.className = isInvoiceRequired ? 'metric-value warning' : 'metric-value success';
      
      // Check if invoice was received
      const invoiceExists = helperData.invoice_uploaded || helperData.invoice_summary || helperData.invoice_data;
      invoiceReceived.textContent = invoiceExists ? '×›×Ÿ' : '×œ×';
      invoiceReceived.className = invoiceExists ? 'metric-value success' : 'metric-value error';
      
      // Calculate invoice total
      const invoiceAmount = helperData.invoice_summary?.total || 
                           helperData.invoice_data?.total || 
                           helperData.invoice_total || 0;
      invoiceTotal.textContent = `â‚ª${parseFloat(invoiceAmount).toLocaleString('he-IL')}`;
      
      // Update validation status
      const hasValidationData = summary.details && summary.details.invoice;
      if (hasValidationData) {
        if (summary.details.invoice.isValid) {
          invoiceStatus.className = 'status-indicator status-valid';
          invoiceValidation.textContent = '×ª×§×™×Ÿ';
          invoiceValidation.className = 'metric-value success';
        } else {
          invoiceStatus.className = 'status-indicator status-invalid';
          invoiceValidation.textContent = '×“×•×¨×© ×ª×™×§×•×Ÿ';
          invoiceValidation.className = 'metric-value error';
        }
      } else {
        invoiceStatus.className = 'status-indicator status-pending';
        invoiceValidation.textContent = '×œ× × ×‘×“×§';
        invoiceValidation.className = 'metric-value';
      }
    }

    function updateLeviData(summary) {
      const leviStatus = document.getElementById('levi-status');
      const leviExists = document.getElementById('levi-exists');
      const marketValue = document.getElementById('market-value');
      const priceAdjustments = document.getElementById('price-adjustments');
      const leviValidation = document.getElementById('levi-validation');
      
      const helperData = helper || {};
      const leviData = helperData.levi_report || helperData.levi_data || {};
      const carDetails = helperData.car_details || {};
      
      // Check if Levi report exists
      const hasLeviReport = leviData && Object.keys(leviData).length > 0;
      leviExists.textContent = hasLeviReport ? '×›×Ÿ' : '×œ×';
      leviExists.className = hasLeviReport ? 'metric-value success' : 'metric-value warning';
      
      // Update market value
      const marketVal = leviData.market_value || carDetails.market_value || leviData.×©×•×•×™_×©×•×§ || 0;
      marketValue.textContent = `â‚ª${parseFloat(marketVal).toLocaleString('he-IL')}`;
      
      // Calculate price adjustments
      const adjustments = leviData.adjustments || leviData.price_adjustments || leviData.×”×ª×××•×ª_××—×™×¨ || [];
      const adjustmentsCount = Array.isArray(adjustments) ? adjustments.length : 0;
      priceAdjustments.textContent = adjustmentsCount;
      
      // Update validation status
      const hasValidationData = summary.details && summary.details.levi;
      if (hasValidationData) {
        if (summary.details.levi.isValid) {
          leviStatus.className = 'status-indicator status-valid';
          leviValidation.textContent = '×ª×§×™×Ÿ';
          leviValidation.className = 'metric-value success';
        } else {
          leviStatus.className = 'status-indicator status-invalid';
          leviValidation.textContent = '×“×•×¨×© ×‘×“×™×§×”';
          leviValidation.className = 'metric-value error';
        }
      } else {
        leviStatus.className = 'status-indicator status-pending';
        leviValidation.textContent = '×œ× × ×‘×“×§';
        leviValidation.className = 'metric-value';
      }
    }

    function updateDepreciationData(summary) {
      const depreciationStatus = document.getElementById('depreciation-status');
      const depreciationDefined = document.getElementById('depreciation-defined');
      const depreciationAmount = document.getElementById('depreciation-amount');
      const depreciationPercentage = document.getElementById('depreciation-percentage');
      const depreciationValidation = document.getElementById('depreciation-validation');
      
      const helperData = helper || {};
      const depreciationData = helperData.depreciation || helperData.expertise?.depreciation || {};
      
      // Check if depreciation is defined
      const hasDepreciation = depreciationData && Object.keys(depreciationData).length > 0;
      depreciationDefined.textContent = hasDepreciation ? '×›×Ÿ' : '×œ×';
      depreciationDefined.className = hasDepreciation ? 'metric-value success' : 'metric-value warning';
      
      // Update depreciation amount
      const depAmount = depreciationData.amount || depreciationData.depreciation_amount || 0;
      depreciationAmount.textContent = `â‚ª${parseFloat(depAmount).toLocaleString('he-IL')}`;
      
      // Update depreciation percentage
      const depPercent = depreciationData.percentage || depreciationData.depreciation_percentage || 0;
      depreciationPercentage.textContent = `${depPercent}%`;
      
      // Update validation status
      const hasValidationData = summary.details && summary.details.depreciation;
      if (hasValidationData) {
        if (summary.details.depreciation.isValid) {
          depreciationStatus.className = 'status-indicator status-valid';
          depreciationValidation.textContent = '×ª×§×™×Ÿ';
          depreciationValidation.className = 'metric-value success';
        } else {
          depreciationStatus.className = 'status-indicator status-invalid';
          depreciationValidation.textContent = '×“×•×¨×© ×”×’×“×¨×”';
          depreciationValidation.className = 'metric-value error';
        }
      } else {
        depreciationStatus.className = 'status-indicator status-pending';
        depreciationValidation.textContent = '×œ× × ×‘×“×§';
        depreciationValidation.className = 'metric-value';
      }
    }

    function updateProfessionalStandards(summary) {
      const professionalStatus = document.getElementById('professional-status');
      const caseAge = document.getElementById('case-age');
      const documentationCompleteness = document.getElementById('documentation-completeness');
      const reportReadiness = document.getElementById('report-readiness');
      const professionalValidation = document.getElementById('professional-validation');
      
      const helperData = helper || {};
      const meta = helperData.meta || {};
      
      // Calculate case age
      const expertiseDate = meta.submission_date || meta.inspection_date || meta.date_created;
      let daysSinceExpertise = 0;
      if (expertiseDate) {
        daysSinceExpertise = Math.floor((new Date() - new Date(expertiseDate)) / (1000 * 60 * 60 * 24));
      }
      caseAge.textContent = daysSinceExpertise;
      
      // Calculate documentation completeness
      const requiredFields = ['vehicle', 'damage', 'car_details'];
      const completedFields = requiredFields.filter(field => 
        helperData[field] && Object.keys(helperData[field]).length > 0
      );
      const completeness = Math.round((completedFields.length / requiredFields.length) * 100);
      documentationCompleteness.textContent = `${completeness}%`;
      
      // Check report readiness
      const hasVehicleData = helperData.vehicle && Object.keys(helperData.vehicle).length > 0;
      const hasDamageData = helperData.damage && helperData.damage.centers && helperData.damage.centers.length > 0;
      const hasCarDetails = helperData.car_details && Object.keys(helperData.car_details).length > 0;
      
      const isReady = hasVehicleData && hasDamageData && hasCarDetails;
      reportReadiness.textContent = isReady ? '××•×›×Ÿ' : '×œ× ××•×›×Ÿ';
      reportReadiness.className = isReady ? 'metric-value success' : 'metric-value warning';
      
      // Update validation status
      const hasValidationData = summary.details && summary.details.professional;
      if (hasValidationData) {
        if (summary.details.professional.isValid) {
          professionalStatus.className = 'status-indicator status-valid';
          professionalValidation.textContent = '×ª×§×™×Ÿ';
          professionalValidation.className = 'metric-value success';
        } else {
          professionalStatus.className = 'status-indicator status-invalid';
          professionalValidation.textContent = '×“×•×¨×© ×©×™×¤×•×¨';
          professionalValidation.className = 'metric-value error';
        }
      } else {
        professionalStatus.className = 'status-indicator status-pending';
        professionalValidation.textContent = '×œ× × ×‘×“×§';
        professionalValidation.className = 'metric-value';
      }
    }

    function updateBusinessRules(summary) {
      const businessStatus = document.getElementById('business-status');
      const costRatio = document.getElementById('cost-ratio');
      const totalEstimate = document.getElementById('total-estimate');
      const businessValidation = document.getElementById('business-validation');
      
      // Calculate cost ratio and total estimate
      const damageData = helper.damage || {};
      const centers = damageData.centers || [];
      
      let totalPartsCost = 0;
      let totalRepairsCost = 0;
      
      centers.forEach(center => {
        if (center.parts) {
          center.parts.forEach(part => {
            totalPartsCost += parseFloat(part.price || 0);
          });
        }
        if (center.repairs) {
          center.repairs.forEach(repair => {
            totalRepairsCost += parseFloat(repair.cost || 0);
          });
        }
      });
      
      const ratio = totalRepairsCost > 0 ? (totalPartsCost / totalRepairsCost).toFixed(2) : 'N/A';
      costRatio.textContent = ratio;
      
      const total = totalPartsCost + totalRepairsCost;
      totalEstimate.textContent = `â‚ª${total.toLocaleString('he-IL')}`;
      
      if (summary.details.business) {
        if (summary.details.business.isValid) {
          businessStatus.className = 'status-indicator status-valid';
          businessValidation.textContent = '×ª×§×™×Ÿ';
          businessValidation.className = 'metric-value success';
        } else {
          businessStatus.className = 'status-indicator status-invalid';
          businessValidation.textContent = '×“×•×¨×© ×‘×“×™×§×”';
          businessValidation.className = 'metric-value error';
        }
      } else {
        businessStatus.className = 'status-indicator status-pending';
        businessValidation.textContent = '×œ× × ×‘×“×§';
        businessValidation.className = 'metric-value';
      }
    }

    function toggleAutoRefresh() {
      const checkbox = document.getElementById('auto-refresh-checkbox');
      const countdown = document.getElementById('refresh-countdown');
      
      if (checkbox.checked) {
        autoRefreshInterval = setInterval(() => {
          refreshValidation();
          refreshCountdown = 30;
        }, 30000);
        
        refreshCountdown = 30;
        countdownInterval = setInterval(() => {
          refreshCountdown--;
          countdown.textContent = `(${refreshCountdown}s)`;
          
          if (refreshCountdown <= 0) {
            refreshCountdown = 30;
          }
        }, 1000);
        
        console.log('ğŸ”„ Auto-refresh enabled');
      } else {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
        }
        if (countdownInterval) {
          clearInterval(countdownInterval);
          countdownInterval = null;
        }
        countdown.textContent = '';
        console.log('â¸ï¸ Auto-refresh disabled');
      }
    }

    function exportValidationReport() {
      console.log('ğŸ“Š Exporting validation report...');
      
      try {
        let report = null;
        
        // Try to get report from validation system
        if (validationSystem && typeof validationSystem.generateValidationReport === 'function') {
          report = validationSystem.generateValidationReport();
        } else {
          // Generate report from current validation summary
          const summary = createValidationSummaryFromHelper();
          report = {
            timestamp: new Date().toISOString(),
            summary: summary,
            helperData: helper || {},
            recommendations: generateRecommendations(summary)
          };
        }
        
        // Create comprehensive report
        const exportReport = {
          reportInfo: {
            title: '×“×•×— ××™××•×ª × ×ª×•× ×™× - ××¢×¨×›×ª ×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª',
            generated: new Date().toISOString(),
            generatedBy: '×œ×•×— ×‘×§×¨×ª ××™××•×ª',
            plateNumber: helper?.vehicle?.plate || helper?.vehicle?.plate_number || helper?.car_details?.plate || '×œ× ×–××™×Ÿ'
          },
          validationSummary: report.summary || summary,
          systemData: {
            helper: helper || {},
            validationSystemAvailable: !!validationSystem
          },
          recommendations: report.recommendations || []
        };
        
        const reportJson = JSON.stringify(exportReport, null, 2);
        
        // Create downloadable file
        const blob = new Blob([reportJson], { type: 'application/json', charset: 'utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        const plateNumber = exportReport.reportInfo.plateNumber !== '×œ× ×–××™×Ÿ' ? 
          `_${exportReport.reportInfo.plateNumber}` : '';
        const filename = `validation-report${plateNumber}_${new Date().toISOString().split('T')[0]}.json`;
        
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        console.log('âœ… Validation report exported successfully');
        showSuccess(`×“×•×— ×”××™××•×ª ×™×•×¦× ×‘×”×¦×œ×—×”: ${filename}`);
        
      } catch (error) {
        console.error('âŒ Error exporting validation report:', error);
        showError('×©×’×™××” ×‘×™×™×¦×•× ×“×•×— ×”××™××•×ª: ' + error.message);
      }
    }

    function generateRecommendations(summary) {
      const recommendations = [];

      if (!summary.isValid) {
        recommendations.push('×™×© ×œ×ª×§×Ÿ ××ª ×”×©×’×™××•×ª ×”×‘××•×ª ×œ×¤× ×™ ×”××©×š');
      }

      if (summary.totalWarnings > 0) {
        recommendations.push('×™×© ×œ×‘×“×•×§ ××ª ×”××–×”×¨×•×ª ×•×œ×•×•×“× ×©×”× ×ª×•× ×™× × ×›×•× ×™×');
      }

      if (summary.details.vehicle && !summary.details.vehicle.isValid) {
        recommendations.push('×™×© ×œ×‘×“×•×§ ×•×œ×ª×§×Ÿ ××ª ×¤×¨×˜×™ ×”×¨×›×‘');
      }

      if (summary.details.damage && !summary.details.damage.isValid) {
        recommendations.push('×™×© ×œ×‘×“×•×§ ×•×œ×ª×§×Ÿ ××ª × ×ª×•× ×™ ×”× ×–×§');
      }

      if (summary.details.invoice && !summary.details.invoice.isValid) {
        recommendations.push('×™×© ×œ×‘×“×•×§ ××ª × ×•×©× ×”×—×©×‘×•× ×™×•×ª ×”× ×“×¨×©×•×ª');
      }

      if (summary.details.levi && !summary.details.levi.isValid) {
        recommendations.push('×™×© ×œ×‘×“×•×§ ××ª × ×ª×•× ×™ ×“×•×— ×œ×•×™ ×™×¦×—×§ ×•×©×•×•×™ ×”×©×•×§');
      }

      if (summary.details.depreciation && !summary.details.depreciation.isValid) {
        recommendations.push('×™×© ×œ×”×’×“×™×¨ ×•×œ×‘×“×•×§ ××ª × ×ª×•× ×™ ×™×¨×™×“×ª ×”×¢×¨×š');
      }

      if (summary.details.professional && !summary.details.professional.isValid) {
        recommendations.push('×™×© ×œ×©×¤×¨ ××ª ×”×ª×§× ×™× ×”××§×¦×•×¢×™×™× ×•×”×©×œ××ª ×”×ª×™×¢×•×“');
      }

      return recommendations;
    }

    function fixAllErrors() {
      console.log('ğŸ”§ Attempting to fix validation errors...');
      
      if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×ª×§×Ÿ ×‘××•×¤×Ÿ ××•×˜×•××˜×™ ××ª ×”×©×’×™××•×ª ×©× ××¦××•?')) {
        try {
          let fixesApplied = 0;
          const summary = createValidationSummaryFromHelper();
          
          // Auto-fix vehicle data errors
          if (summary.details.vehicle && !summary.details.vehicle.isValid) {
            if (helper && helper.vehicle) {
              // Fix empty plate number
              if (!helper.vehicle.plate && !helper.vehicle.plate_number) {
                helper.vehicle.plate_number = '×œ× ×”×•×–×Ÿ';
                fixesApplied++;
              }
              // Fix empty manufacturer
              if (!helper.vehicle.manufacturer) {
                helper.vehicle.manufacturer = '×œ× ×”×•×–×Ÿ';
                fixesApplied++;
              }
              // Fix empty model
              if (!helper.vehicle.model) {
                helper.vehicle.model = '×œ× ×”×•×–×Ÿ';
                fixesApplied++;
              }
              // Fix empty year
              if (!helper.vehicle.year) {
                helper.vehicle.year = new Date().getFullYear();
                fixesApplied++;
              }
            }
          }
          
          // Auto-fix damage data errors
          if (summary.details.damage && !summary.details.damage.isValid) {
            if (helper && (!helper.damage || !helper.damage.centers)) {
              // Initialize empty damage structure
              if (!helper.damage) helper.damage = {};
              if (!helper.damage.centers) helper.damage.centers = [];
              fixesApplied++;
            }
          }
          
          // Save changes if any fixes were applied
          if (fixesApplied > 0) {
            console.log(`ğŸ”§ Applied ${fixesApplied} automatic fixes`);
            showSuccess(`×ª×™×§×•×Ÿ ××•×˜×•××˜×™ ×”×•×©×œ× - ${fixesApplied} ×©×’×™××•×ª ×ª×•×§× ×•`);
          } else {
            console.log('ğŸ”§ No automatic fixes available');
            showSuccess('×œ× × ××¦××• ×©×’×™××•×ª ×©× ×™×ª×Ÿ ×œ×ª×§×Ÿ ×‘××•×¤×Ÿ ××•×˜×•××˜×™');
          }
          
          // Refresh validation to show updated data
          setTimeout(() => {
            refreshValidation();
          }, 1000);
          
        } catch (error) {
          console.error('âŒ Error during auto-fix:', error);
          showError('×©×’×™××” ×‘×ª×™×§×•×Ÿ ××•×˜×•××˜×™: ' + error.message);
        }
      }
    }

    function clearValidationData() {
      if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ× ×§×•×ª ××ª ×›×œ × ×ª×•× ×™ ×”××™××•×ª?\n\n×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×”×™×¡×˜×•×¨×™×™×ª ×”××™××•×ª ×•×ª××¤×¡ ××ª ×”××˜××•×Ÿ.')) {
        try {
          // Clear validation system data if available
          if (validationSystem) {
            if (validationSystem.validationHistory) {
              validationSystem.validationHistory = [];
            }
            if (validationSystem.errors && typeof validationSystem.errors.clear === 'function') {
              validationSystem.errors.clear();
            }
            if (validationSystem.warnings && typeof validationSystem.warnings.clear === 'function') {
              validationSystem.warnings.clear();
            }
          }
          
          // Clear any cached validation data from sessionStorage
          Object.keys(sessionStorage).forEach(key => {
            if (key.includes('validation') || key.includes('cache')) {
              sessionStorage.removeItem(key);
            }
          });
          
          // Reset UI elements to show clean state
          document.getElementById('validation-status').textContent = '× ×•×§×”';
          document.getElementById('completion-percentage').textContent = '0%';
          document.getElementById('completion-progress').style.width = '0%';
          document.getElementById('total-errors').textContent = '0';
          document.getElementById('total-warnings').textContent = '0';
          document.getElementById('last-check').textContent = '× ×•×§×”';
          
          console.log('ğŸ—‘ï¸ Validation data cleared successfully');
          showSuccess('× ×ª×•× ×™ ×”××™××•×ª × ×•×§×• ×‘×”×¦×œ×—×”');
          
          // Refresh validation after clearing
          setTimeout(() => {
            refreshValidation();
          }, 2000);
          
        } catch (error) {
          console.error('âŒ Error clearing validation data:', error);
          showError('×©×’×™××” ×‘× ×™×§×•×™ × ×ª×•× ×™ ×”××™××•×ª: ' + error.message);
        }
      }
    }

    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', (event) => {
        if (event.ctrlKey || event.metaKey) {
          switch (event.key) {
            case 'r':
              event.preventDefault();
              refreshValidation();
              break;
            case 'e':
              event.preventDefault();
              exportValidationReport();
              break;
            case 'f':
              event.preventDefault();
              if (!document.getElementById('fix-errors-btn').disabled) {
                fixAllErrors();
              }
              break;
          }
        }
      });
    }

    function showSuccess(message) {
      // Simple success notification
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        z-index: 10000;
        font-weight: bold;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 3000);
    }

    function showError(message) {
      // Simple error notification
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #dc3545;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        z-index: 10000;
        font-weight: bold;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 4000);
    }

    // Floating screen functions
    function openCarDetailsFloating() {
      try {
        if (typeof window.openCarDetailsModal === 'function') {
          window.openCarDetailsModal();
        } else {
          console.log('ğŸš— Car details floating screen not available, loading...');
          loadFloatingScreen('car-details-floating.js', () => {
            if (typeof window.openCarDetailsModal === 'function') {
              window.openCarDetailsModal();
            } else {
              showError('×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××ª ××¡×š ×¤×¨×˜×™ ×”×¨×›×‘');
            }
          });
        }
      } catch (error) {
        console.error('Error opening car details floating:', error);
        showError('×©×’×™××” ×‘×¤×ª×™×—×ª ××¡×š ×¤×¨×˜×™ ×¨×›×‘');
      }
    }

    function openLeviFloating() {
      try {
        if (typeof window.openLeviModal === 'function') {
          window.openLeviModal();
        } else {
          console.log('ğŸ“Š Levi floating screen not available, loading...');
          loadFloatingScreen('levi-floating.js', () => {
            if (typeof window.openLeviModal === 'function') {
              window.openLeviModal();
            } else {
              showError('×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××ª ××¡×š ×“×•×— ×œ×•×™ ×™×¦×—×§');
            }
          });
        }
      } catch (error) {
        console.error('Error opening Levi floating:', error);
        showError('×©×’×™××” ×‘×¤×ª×™×—×ª ××¡×š ×“×•×— ×œ×•×™ ×™×¦×—×§');
      }
    }

    function openPartsFloating() {
      try {
        if (typeof window.openPartsModal === 'function') {
          window.openPartsModal();
        } else {
          console.log('ğŸ”§ Parts floating screen not available, loading...');
          loadFloatingScreen('parts-floating.js', () => {
            if (typeof window.openPartsModal === 'function') {
              window.openPartsModal();
            } else {
              showError('×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××ª ××¡×š ×—×™×¤×•×© ×—×œ×§×™×');
            }
          });
        }
      } catch (error) {
        console.error('Error opening parts floating:', error);
        showError('×©×’×™××” ×‘×¤×ª×™×—×ª ××¡×š ×—×™×¤×•×© ×—×œ×§×™×');
      }
    }

    function openInvoiceFloating() {
      try {
        if (typeof window.openInvoiceModal === 'function') {
          window.openInvoiceModal();
        } else {
          console.log('ğŸ§¾ Invoice floating screen not available, loading...');
          loadFloatingScreen('invoice-details-floating.js', () => {
            if (typeof window.openInvoiceModal === 'function') {
              window.openInvoiceModal();
            } else {
              showError('×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××ª ××¡×š ×¤×¨×˜×™ ×—×©×‘×•× ×™×ª');
            }
          });
        }
      } catch (error) {
        console.error('Error opening invoice floating:', error);
        showError('×©×’×™××” ×‘×¤×ª×™×—×ª ××¡×š ×¤×¨×˜×™ ×—×©×‘×•× ×™×ª');
      }
    }

    function loadFloatingScreen(scriptName, callback) {
      const script = document.createElement('script');
      script.src = scriptName;
      script.onload = callback;
      script.onerror = () => {
        console.error(`Failed to load ${scriptName}`);
        showError(`×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××ª ×”×¡×§×¨×™×¤×˜ ${scriptName}`);
      };
      document.head.appendChild(script);
    }

    // Drill-down analysis functions
    function drillDownDamage(type) {
      console.log(`ğŸ” Drilling down into damage data: ${type}`);
      
      try {
        const damageData = helper?.damage || {};
        const centers = damageData.centers || helper?.damage_sections || [];
        
        let content = '';
        let title = '';
        
        switch (type) {
          case 'centers':
            title = '×¤×™×¨×•×˜ ××•×§×“×™ × ×–×§';
            if (centers.length === 0) {
              content = '<p style="text-align: center; color: #666;">×œ× × ××¦××• ××•×§×“×™ × ×–×§</p>';
            } else {
              content = centers.map((center, index) => `
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px 0;">
                  <h4 style="color: #667eea; margin-bottom: 10px;">××•×§×“ × ×–×§ ${index + 1}</h4>
                  <p><strong>××™×§×•×:</strong> ${center.location || center.area || '×œ× ×”×•×–×Ÿ'}</p>
                  <p><strong>×ª×™××•×¨:</strong> ${center.description || center.damage_description || '×œ× ×”×•×–×Ÿ'}</p>
                  <p><strong>×—×œ×§×™×:</strong> ${center.parts?.length || 0}</p>
                  <p><strong>×ª×™×§×•× ×™×:</strong> ${center.repairs?.length || center.works?.length || 0}</p>
                </div>
              `).join('');
            }
            break;
            
          case 'parts':
            title = '×¤×™×¨×•×˜ ×—×œ×§×™×';
            let allParts = [];
            centers.forEach((center, centerIndex) => {
              if (center.parts) {
                center.parts.forEach(part => {
                  allParts.push({...part, centerIndex: centerIndex + 1});
                });
              }
            });
            
            if (allParts.length === 0) {
              content = '<p style="text-align: center; color: #666;">×œ× × ××¦××• ×—×œ×§×™×</p>';
            } else {
              content = allParts.map(part => `
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px 0;">
                  <h5 style="color: #28a745; margin-bottom: 8px;">${part.name || part.description || '×—×œ×§ ×œ×œ× ×©×'}</h5>
                  <p><strong>××•×§×“:</strong> ${part.centerIndex}</p>
                  <p><strong>××—×™×¨:</strong> â‚ª${parseFloat(part.price || part.cost || 0).toLocaleString('he-IL')}</p>
                  <p><strong>×›××•×ª:</strong> ${part.quantity || 1}</p>
                  ${part.partNumber ? `<p><strong>××§"×˜:</strong> ${part.partNumber}</p>` : ''}
                </div>
              `).join('');
            }
            break;
            
          case 'repairs':
            title = '×¤×™×¨×•×˜ ×ª×™×§×•× ×™×';
            let allRepairs = [];
            centers.forEach((center, centerIndex) => {
              const repairs = center.repairs || center.works || [];
              repairs.forEach(repair => {
                allRepairs.push({...repair, centerIndex: centerIndex + 1});
              });
            });
            
            if (allRepairs.length === 0) {
              content = '<p style="text-align: center; color: #666;">×œ× × ××¦××• ×ª×™×§×•× ×™×</p>';
            } else {
              content = allRepairs.map(repair => `
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px 0;">
                  <h5 style="color: #dc3545; margin-bottom: 8px;">${repair.description || repair.work_description || '×ª×™×§×•×Ÿ ×œ×œ× ×ª×™××•×¨'}</h5>
                  <p><strong>××•×§×“:</strong> ${repair.centerIndex}</p>
                  <p><strong>×¢×œ×•×ª:</strong> â‚ª${parseFloat(repair.cost || repair.price || 0).toLocaleString('he-IL')}</p>
                  <p><strong>×©×¢×•×ª ×¢×‘×•×“×”:</strong> ${repair.hours || repair.work_hours || '×œ× ×”×•×–×Ÿ'}</p>
                  ${repair.type ? `<p><strong>×¡×•×’:</strong> ${repair.type}</p>` : ''}
                </div>
              `).join('');
            }
            break;
        }
        
        showDrillDownModal(title, content);
        
      } catch (error) {
        console.error('Error in drill-down analysis:', error);
        showError('×©×’×™××” ×‘× ×™×ª×•×— × ×ª×•× ×™× ××¤×•×¨×˜');
      }
    }

    function drillDownProfessional(type) {
      console.log(`ğŸ” Drilling down into professional standards: ${type}`);
      
      try {
        const helperData = helper || {};
        const meta = helperData.meta || {};
        
        let content = '';
        let title = '';
        
        switch (type) {
          case 'timeline':
            title = '×¤×™×¨×•×˜ ×–××Ÿ ×”×ª×™×§';
            const expertiseDate = meta.submission_date || meta.inspection_date || meta.date_created;
            const currentDate = new Date();
            
            if (expertiseDate) {
              const creationDate = new Date(expertiseDate);
              const daysSinceCreation = Math.floor((currentDate - creationDate) / (1000 * 60 * 60 * 24));
              
              content = `
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin: 10px 0;">
                  <h4 style="color: #667eea; margin-bottom: 15px;">×–×× ×™ ×”×ª×™×§</h4>
                  <p><strong>×ª××¨×™×š ×™×¦×™×¨×ª ××§×¡×¤×¨×˜×™×–×”:</strong> ${creationDate.toLocaleDateString('he-IL')}</p>
                  <p><strong>×ª××¨×™×š × ×•×›×—×™:</strong> ${currentDate.toLocaleDateString('he-IL')}</p>
                  <p><strong>×™××™× ×©×¢×‘×¨×•:</strong> ${daysSinceCreation}</p>
                  <p><strong>××¦×‘ ×–××Ÿ:</strong> ${daysSinceCreation > 30 ? 
                    '<span style="color: #dc3545;">×—×¨×™×’×” ×-30 ×™××™×</span>' : 
                    '<span style="color: #28a745;">×‘×–××Ÿ ×ª×§×™×Ÿ</span>'}</p>
                  <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <strong>×”××œ×¦×•×ª:</strong><br>
                    ${daysSinceCreation > 30 ? 
                      'â€¢ ××•××œ×¥ ×œ×–×¨×– ××ª ×”×ª×™×§<br>â€¢ ×‘×“×•×§ ×× × ×“×¨×©×™× × ×ª×•× ×™× × ×•×¡×¤×™×<br>â€¢ ×©×§×•×œ ×™×¦×™×¨×ª ×§×©×¨ ×¢× ×”×œ×§×•×—' :
                      'â€¢ ×”×ª×™×§ ×‘×–××Ÿ ×ª×§×™×Ÿ<br>â€¢ ×”××©×š ×‘×ª×”×œ×™×š ×”×¨×’×™×œ'}
                  </div>
                </div>
              `;
            } else {
              content = '<p style="text-align: center; color: #666;">×ª××¨×™×š ×™×¦×™×¨×ª ×”×ª×™×§ ×œ× ×–××™×Ÿ</p>';
            }
            break;
            
          case 'completeness':
            title = '×¤×™×¨×•×˜ ×”×©×œ××ª ×ª×™×¢×•×“';
            const requiredSections = {
              '×¤×¨×˜×™ ×¨×›×‘': helperData.vehicle && Object.keys(helperData.vehicle).length > 0,
              '× ×ª×•× ×™ × ×–×§': helperData.damage && helperData.damage.centers && helperData.damage.centers.length > 0,
              '×¤×¨×˜×™ ×œ×§×•×—': helperData.car_details && Object.keys(helperData.car_details).length > 0,
              '×ª××•× ×•×ª': helperData.images && helperData.images.length > 0,
              '×—×œ×§×™×': helperData.damage?.centers?.some(center => center.parts && center.parts.length > 0) || false,
              '×¢×‘×•×“×•×ª': helperData.damage?.centers?.some(center => center.repairs && center.repairs.length > 0) || false
            };
            
            const completedSections = Object.values(requiredSections).filter(Boolean).length;
            const totalSections = Object.keys(requiredSections).length;
            const completionPercentage = Math.round((completedSections / totalSections) * 100);
            
            content = `
              <div style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin: 10px 0;">
                <h4 style="color: #667eea; margin-bottom: 15px;">××¦×‘ ×”×©×œ××ª ×”×ª×™×¢×•×“</h4>
                <div style="margin-bottom: 15px;">
                  <strong>××—×•×– ×”×©×œ××” ×›×•×œ×œ: ${completionPercentage}%</strong>
                  <div style="width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; margin: 10px 0;">
                    <div style="width: ${completionPercentage}%; height: 100%; background: ${completionPercentage > 70 ? '#28a745' : completionPercentage > 40 ? '#ffc107' : '#dc3545'}; border-radius: 10px;"></div>
                  </div>
                </div>
                ${Object.entries(requiredSections).map(([section, completed]) => `
                  <p>
                    <span style="color: ${completed ? '#28a745' : '#dc3545'};">
                      ${completed ? 'âœ…' : 'âŒ'}
                    </span>
                    <strong>${section}:</strong> ${completed ? '×”×•×©×œ×' : '×—×¡×¨'}
                  </p>
                `).join('')}
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                  <strong>×”××œ×¦×•×ª ×œ×©×™×¤×•×¨:</strong><br>
                  ${completionPercentage < 100 ? 
                    Object.entries(requiredSections)
                      .filter(([_, completed]) => !completed)
                      .map(([section, _]) => `â€¢ ×”×©×œ× ${section}`)
                      .join('<br>') :
                    'â€¢ ×›×œ ×”×¡×¢×™×¤×™× ×”×•×©×œ××• - ××¦×•×™×Ÿ!'}
                </div>
              </div>
            `;
            break;
            
          case 'readiness':
            title = '××•×›× ×•×ª ×œ×“×•×— ×¡×•×¤×™';
            const readinessChecks = {
              '×¤×¨×˜×™ ×¨×›×‘ ××œ××™×': helperData.vehicle && helperData.vehicle.manufacturer && helperData.vehicle.model,
              '××•×§×“×™ × ×–×§ ×”×•×’×“×¨×•': helperData.damage && helperData.damage.centers && helperData.damage.centers.length > 0,
              '×—×œ×§×™× × ×•×¡×¤×•': helperData.damage?.centers?.some(center => center.parts && center.parts.length > 0),
              '×¢×‘×•×“×•×ª ×”×•×’×“×¨×•': helperData.damage?.centers?.some(center => center.repairs && center.repairs.length > 0),
              '×ª××•× ×•×ª ×”×•×¢×œ×•': helperData.images && helperData.images.length > 0,
              '×¤×¨×˜×™ ×œ×§×•×—': helperData.car_details && helperData.car_details.owner
            };
            
            const passedChecks = Object.values(readinessChecks).filter(Boolean).length;
            const totalChecks = Object.keys(readinessChecks).length;
            const readinessScore = Math.round((passedChecks / totalChecks) * 100);
            
            content = `
              <div style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin: 10px 0;">
                <h4 style="color: #667eea; margin-bottom: 15px;">×‘×“×™×§×ª ××•×›× ×•×ª ×œ×“×•×— ×¡×•×¤×™</h4>
                <div style="margin-bottom: 15px;">
                  <strong>×¦×™×•×Ÿ ××•×›× ×•×ª: ${readinessScore}%</strong>
                  <div style="width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; margin: 10px 0;">
                    <div style="width: ${readinessScore}%; height: 100%; background: ${readinessScore > 80 ? '#28a745' : readinessScore > 60 ? '#ffc107' : '#dc3545'}; border-radius: 10px;"></div>
                  </div>
                  <p style="color: ${readinessScore > 80 ? '#28a745' : readinessScore > 60 ? '#ffc107' : '#dc3545'};">
                    ${readinessScore > 80 ? 'ğŸŸ¢ ××•×›×Ÿ ×œ×”×¤×§×ª ×“×•×— ×¡×•×¤×™' : 
                      readinessScore > 60 ? 'ğŸŸ¡ ×›××¢×˜ ××•×›×Ÿ - ×™×© ×¤×¢×¨×™× ×§×˜× ×™×' : 
                      'ğŸ”´ ×œ× ××•×›×Ÿ - × ×“×¨×©×™× ×©×™×¤×•×¨×™×'}
                  </p>
                </div>
                ${Object.entries(readinessChecks).map(([check, passed]) => `
                  <p>
                    <span style="color: ${passed ? '#28a745' : '#dc3545'};">
                      ${passed ? 'âœ…' : 'âŒ'}
                    </span>
                    <strong>${check}</strong>
                  </p>
                `).join('')}
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                  <strong>×”×©×œ×‘×™× ×”×‘××™×:</strong><br>
                  ${readinessScore > 80 ? 
                    'â€¢ × ×™×ª×Ÿ ×œ×”××©×™×š ×œ×”×¤×§×ª ×“×•×— ×¡×•×¤×™<br>â€¢ ×‘×—×¨ ××ª ×¡×•×’ ×”×“×•×— ×”××ª××™×<br>â€¢ ×•×“× ×¤×¢× × ×•×¡×¤×ª ××ª ×›×œ ×”× ×ª×•× ×™×' :
                    Object.entries(readinessChecks)
                      .filter(([_, passed]) => !passed)
                      .map(([check, _]) => `â€¢ ×”×©×œ×: ${check}`)
                      .join('<br>')}
                </div>
              </div>
            `;
            break;
        }
        
        showDrillDownModal(title, content);
        
      } catch (error) {
        console.error('Error in professional drill-down analysis:', error);
        showError('×©×’×™××” ×‘× ×™×ª×•×— ×ª×§× ×™× ××§×¦×•×¢×™×™×');
      }
    }

    function showDrillDownModal(title, content) {
      // Remove existing modal if any
      const existingModal = document.querySelector('.drill-down-overlay');
      if (existingModal) {
        existingModal.remove();
      }
      
      // Create overlay
      const overlay = document.createElement('div');
      overlay.className = 'drill-down-overlay';
      overlay.onclick = closeDrillDownModal;
      
      // Create modal
      const modal = document.createElement('div');
      modal.className = 'drill-down-modal';
      modal.innerHTML = `
        <div class="drill-down-header">
          <h3 style="margin: 0; color: #667eea;">${title}</h3>
          <button class="drill-down-close" onclick="closeDrillDownModal()">Ã—</button>
        </div>
        <div class="drill-down-content">
          ${content}
        </div>
      `;
      
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      
      // Prevent modal from closing when clicking inside it
      modal.onclick = (e) => e.stopPropagation();
    }

    function closeDrillDownModal() {
      const overlay = document.querySelector('.drill-down-overlay');
      if (overlay) {
        overlay.remove();
      }
    }

    // Export functions to global scope
    window.refreshValidation = refreshValidation;
    window.exportValidationReport = exportValidationReport;
    window.fixAllErrors = fixAllErrors;
    window.clearValidationData = clearValidationData;
    window.toggleAutoRefresh = toggleAutoRefresh;
    window.openCarDetailsFloating = openCarDetailsFloating;
    window.openLeviFloating = openLeviFloating;
    window.openPartsFloating = openPartsFloating;
    window.openInvoiceFloating = openInvoiceFloating;
    window.drillDownDamage = drillDownDamage;
    window.drillDownProfessional = drillDownProfessional;
    window.closeDrillDownModal = closeDrillDownModal;
    
    // Initialize keyboard shortcuts info
    setTimeout(() => {
      console.log('ğŸ”§ Validation Dashboard - Keyboard shortcuts:');
      console.log('Ctrl+R: Refresh validation');
      console.log('Ctrl+E: Export report');
      console.log('Ctrl+F: Fix errors');
    }, 1000);
  </script>

  <!-- Analytics and monitoring -->
  <script>
    // Basic usage analytics
    if (typeof gtag !== 'undefined') {
      gtag('event', 'page_view', {
        page_title: 'Validation Dashboard',
        page_location: window.location.href
      });
    }
    
    // Performance monitoring
    window.addEventListener('load', () => {
      const loadTime = performance.now();
      console.log(`ğŸ“Š Validation Dashboard loaded in ${loadTime.toFixed(2)}ms`);
    });
  </script>

  <!-- Floating Screen Scripts -->
  <script src="car-details-floating.js"></script>
  <script src="levi-floating.js"></script>
  <script src="parts-floating.js"></script>
  <script src="invoice-details-floating.js"></script>
  <script src="assistant-floating.js"></script>
</body>
</html>