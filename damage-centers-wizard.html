<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××©×£ ××•×§×“×™ × ×–×§ - ×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª</title>
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link rel="shortcut icon" href="https://carmelcayouf.com/wp-content/uploads/2025/04/logo-yaron.webp">
  <link rel="apple-touch-icon" href="https://carmelcayouf.com/wp-content/uploads/2025/04/logo-yaron.webp">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      direction: rtl;
      padding: 20px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .logo {
      width: 100px;
      height: auto;
      margin-bottom: 15px;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    
    .header p {
      font-size: 16px;
      opacity: 0.9;
    }
    
    .progress-bar {
      background: rgba(255,255,255,0.2);
      height: 8px;
      border-radius: 4px;
      margin-top: 20px;
      overflow: hidden;
    }
    
    .progress-fill {
      background: #10b981;
      height: 100%;
      transition: width 0.3s ease;
      width: 16.67%; /* Start with first step */
    }
    
    .wizard-content {
      padding: 40px;
    }
    
    .step {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .step.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .step-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .step-number {
      display: inline-block;
      width: 40px;
      height: 40px;
      background: #3b82f6;
      color: white;
      border-radius: 50%;
      line-height: 40px;
      font-weight: bold;
      margin-bottom: 15px;
    }
    
    .step-title {
      font-size: 24px;
      color: #1e3a8a;
      margin-bottom: 10px;
    }
    
    .step-description {
      color: #64748b;
      font-size: 16px;
    }
    
    .form-group {
      margin-bottom: 25px;
    }
    
    .form-label {
      display: block;
      font-weight: bold;
      color: #374151;
      margin-bottom: 8px;
      font-size: 16px;
    }
    
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .module-embed {
      border: 2px dashed #e5e7eb;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      background: #f9fafb;
      text-align: center;
    }
    
    .module-embed.loaded {
      border: 2px solid #10b981;
      background: white;
      padding: 0;
    }
    
    .subtotal-display {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border: 1px solid #10b981;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }
    
    .subtotal-title {
      font-size: 18px;
      font-weight: bold;
      color: #059669;
      margin-bottom: 10px;
    }
    
    .subtotal-amount {
      font-size: 24px;
      font-weight: bold;
      color: #047857;
    }
    
    .vat-info {
      font-size: 14px;
      color: #065f46;
      margin-top: 5px;
    }
    
    .navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 40px;
      padding-top: 30px;
      border-top: 1px solid #e5e7eb;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: #3b82f6;
      color: white;
    }
    
    .btn-primary:hover {
      background: #2563eb;
    }
    
    .btn-secondary {
      background: #6b7280;
    }
    
    .btn-success {
      background: #10b981;
      color: white;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    .btn-secondary:hover {
      background: #4b5563;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    
    .damage-center-summary {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .summary-title {
      font-size: 18px;
      font-weight: bold;
      color: #1e3a8a;
    }
    
    .summary-actions {
      display: flex;
      gap: 10px;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 14px;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 18px;
      color: #333;
      font-weight: bold;
    }
    
    /* âœ… ENHANCED: Official cost breakdown styling */
    .official-cost-breakdown {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin: 20px 0;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      border: 1px solid #e5e7eb;
    }
    
    .cost-category-section {
      margin-bottom: 25px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 10px;
      border-right: 4px solid #059669;
    }
    
    .cost-category-section:nth-child(3) {
      border-right-color: #dc2626;
    }
    
    .cost-category-section:nth-child(4) {
      border-right-color: #7c3aed;
    }
    
    .items-breakdown {
      margin-bottom: 15px;
    }
    
    .breakdown-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      margin: 8px 0;
      background: white;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      transition: all 0.2s ease;
    }
    
    .breakdown-item:hover {
      background: #f1f5f9;
      border-color: #3b82f6;
    }
    
    .breakdown-item-details {
      flex: 1;
    }
    
    .breakdown-item-name {
      font-weight: 600;
      color: #1f2937;
      font-size: 16px;
      margin-bottom: 4px;
    }
    
    .breakdown-item-description {
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .breakdown-item-meta {
      color: #9ca3af;
      font-size: 12px;
    }
    
    .breakdown-item-cost {
      font-weight: bold;
      font-size: 18px;
      color: #059669;
      margin-right: 15px;
    }
    
    .category-total {
      text-align: left;
      padding: 15px;
      background: linear-gradient(135deg, #e6fffa 0%, #ccfdf7 100%);
      border-radius: 8px;
      border: 1px solid #10b981;
      font-size: 18px;
      color: #047857;
    }
    
    .official-total-summary {
      text-align: center;
    }

    /* âœ… NEW: Collapsible damage center styles */
    .damage-center-card {
      background: white;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      overflow: hidden;
      border: 2px solid #e5e7eb;
      transition: all 0.3s ease;
    }

    .damage-center-card:hover {
      border-color: #3b82f6;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .damage-center-header {
      padding: 20px;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-bottom: 2px solid #e5e7eb;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s ease;
    }

    .damage-center-header:hover {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    }

    .damage-center-title {
      font-size: 20px;
      font-weight: bold;
      color: #1e40af;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .damage-center-location {
      font-size: 16px;
      color: #6b7280;
      margin-right: 10px;
    }

    .damage-center-total {
      font-size: 18px;
      font-weight: bold;
      color: #059669;
    }

    .collapse-icon {
      font-size: 24px;
      color: #3b82f6;
      transition: transform 0.3s ease;
    }

    .collapse-icon.expanded {
      transform: rotate(180deg);
    }

    .damage-center-content {
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: all 0.4s ease;
    }

    .damage-center-content.expanded {
      max-height: 1000px;
      padding: 20px;
    }

    .cost-breakdown-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f3f4f6;
    }

    .cost-breakdown-row:last-child {
      border-bottom: none;
      border-top: 2px solid #e5e7eb;
      margin-top: 10px;
      padding-top: 15px;
      font-weight: bold;
    }

    .cost-category-name {
      font-size: 16px;
      color: #374151;
    }

    .cost-amount {
      font-size: 16px;
      font-weight: 600;
      color: #059669;
    }
    
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        border-radius: 10px;
      }
      
      .wizard-content {
        padding: 20px;
      }
      
      .location-grid {
        grid-template-columns: 1fr;
      }
      
      .navigation {
        flex-direction: column;
        gap: 15px;
      }
      
      .btn {
        width: 100%;
      }
    }
    
    /* System-standard nav-button styling */
    .nav-button {
      background: #3b82f6;
      color: white;
      padding: 14px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      transition: all 0.3s ease;
      font-family: inherit;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .nav-button:hover {
      background: #1e3a8a;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .nav-button:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Navigation area styling */
    .navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 30px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 10px;
      border-top: 1px solid #e2e8f0;
    }
    
    #stepInfo {
      font-weight: bold;
      color: #64748b;
      font-size: 14px;
      flex: 1;
      text-align: center;
      min-width: 120px;
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .container {
        margin: 0;
        border-radius: 10px;
      }
      
      .header {
        padding: 20px 15px;
      }
      
      .header h1 {
        font-size: 22px;
      }
      
      .header p {
        font-size: 14px;
      }
      
      .logo {
        width: 80px;
      }
      
      .wizard-content {
        padding: 20px 15px;
      }
      
      .step-title {
        font-size: 20px;
      }
      
      .step-description {
        font-size: 14px;
      }
      
      .form-group {
        margin-bottom: 20px;
      }
      
      .form-label {
        font-size: 14px;
        margin-bottom: 8px;
      }
      
      .form-input, .form-select, .form-textarea {
        padding: 12px;
        font-size: 16px; /* Prevent zoom on iOS */
      }
      
      .navigation {
        flex-direction: column;
        gap: 15px;
        padding: 15px;
      }
      
      .nav-button {
        width: 100%;
        max-width: 200px;
        padding: 12px 16px;
        font-size: 14px;
      }
      
      #stepInfo {
        order: -1; /* Show step info at top on mobile */
        text-align: center;
        width: 100%;
        margin-bottom: 10px;
      }
      
      /* Module iframe mobile styling */
      .module-container iframe {
        height: 500px !important;
        border-radius: 8px !important;
      }
      
      /* Step number mobile adjustment */
      .step-number {
        width: 35px;
        height: 35px;
        line-height: 35px;
        font-size: 14px;
      }
    }
    
    @media (max-width: 480px) {
      .header {
        padding: 15px 10px;
      }
      
      .wizard-content {
        padding: 15px 10px;
      }
      
      .nav-button {
        font-size: 13px;
        padding: 10px 14px;
      }
      
      .module-container iframe {
        height: 450px !important;
      }
    }
    
    /* Enhanced damage centers mobile features */
    @media (max-width: 768px) {
      /* Better form styling for damage centers */
      .damage-center-form {
        background: #f8fafc;
        padding: 15px;
        border-radius: 12px;
        margin: 15px 0;
      }
      
      .damage-location-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 8px;
        margin: 15px 0;
      }
      
      .location-option {
        padding: 12px 8px;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
      }
      
      .location-option:hover,
      .location-option.selected {
        border-color: #3b82f6;
        background: #dbeafe;
        color: #1e40af;
      }
      
      /* Parts search enhancements */
      .parts-search-mobile {
        position: relative;
        margin: 15px 0;
      }
      
      .parts-suggestions {
        position: absolute !important;
        top: 100% !important;
        left: 0 !important;
        right: 0 !important;
        z-index: 1000 !important;
        max-height: 200px !important;
        overflow-y: auto !important;
        background: white !important;
        border: 1px solid #d1d5db !important;
        border-radius: 8px !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
      }
      
      .suggestion-item {
        padding: 12px !important;
        border-bottom: 1px solid #f3f4f6 !important;
        cursor: pointer !important;
        font-size: 14px !important;
        line-height: 1.4 !important;
      }
      
      .suggestion-item:hover {
        background: #f3f4f6 !important;
      }
      
      /* Calculation summary mobile styling */
      .calculation-summary {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 15px;
        border-radius: 12px;
        margin: 20px 0;
        text-align: center;
      }
      
      .calculation-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255,255,255,0.2);
      }
      
      .calculation-row:last-child {
        border-bottom: none;
        font-weight: bold;
        font-size: 18px;
        margin-top: 8px;
        padding-top: 12px;
        border-top: 1px solid rgba(255,255,255,0.3);
      }
      
      /* Touch-friendly buttons */
      .mobile-action-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin: 20px 0;
      }
      
      .mobile-btn {
        padding: 15px 12px;
        border: none;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
        min-height: 48px; /* Apple's minimum touch target */
      }
      
      .mobile-btn-primary {
        background: #3b82f6;
        color: white;
      }
      
      .mobile-btn-secondary {
        background: #f1f5f9;
        color: #475569;
        border: 1px solid #e2e8f0;
      }
      
      .mobile-btn:active {
        transform: scale(0.98);
      }
      
      /* Floating action button for quick actions */
      .floating-actions {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 100;
      }
      
      .fab {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: #3b82f6;
        color: white;
        border: none;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        transition: all 0.2s;
      }
      
      .fab:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
      }
      
      /* âœ… ENHANCED: Responsive inline work and repair components */
      .work-row, .repair-row {
        display: flex !important;
        flex-direction: column !important;
        gap: 15px !important;
        margin-bottom: 20px !important;
        padding: 20px 15px !important;
        background: #ffffff !important;
        border-radius: 12px !important;
        border: 2px solid #e5e7eb !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05) !important;
      }
      
      .work-row .work-type,
      .work-row .work-cost,
      .work-row .work-comments,
      .repair-row .repair-name,
      .repair-row .repair-cost,
      .repair-row .repair-desc {
        width: 100% !important;
        padding: 15px !important;
        font-size: 16px !important;
        border: 2px solid #e5e7eb !important;
        border-radius: 10px !important;
        background: #f8fafc !important;
        box-sizing: border-box !important;
        margin: 0 !important;
      }
      
      .work-row .work-type:focus,
      .work-row .work-cost:focus,
      .work-row .work-comments:focus,
      .repair-row .repair-name:focus,
      .repair-row .repair-cost:focus,
      .repair-row .repair-desc:focus {
        border-color: #3b82f6 !important;
        outline: none !important;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        background: #ffffff !important;
      }
      
      .work-row .work-comments,
      .repair-row .repair-desc {
        min-height: 100px !important;
        resize: vertical !important;
        font-family: inherit !important;
      }
      
      .work-row button,
      .repair-row button {
        width: 100% !important;
        padding: 15px !important;
        font-size: 16px !important;
        font-weight: bold !important;
        border-radius: 10px !important;
        min-height: 50px !important;
        touch-action: manipulation !important;
      }
      
      .work-row button:active,
      .repair-row button:active {
        transform: scale(0.98) !important;
      }
      
      /* Mobile-friendly notification positioning */
      .user-notification {
        position: fixed !important;
        top: 10px !important;
        right: 10px !important;
        left: 10px !important;
        max-width: none !important;
        margin: 0 !important;
        z-index: 10000 !important;
      }
      
      /* Loading state mobile improvements */
      .loading-state {
        padding: 20px !important;
      }
      
      .loading-state div:last-child {
        font-size: 14px !important;
        text-align: center !important;
      }
      
      /* Validation error mobile styling */
      .validation-error {
        margin-top: 8px !important;
        padding: 12px 15px !important;
        font-size: 15px !important;
        border-radius: 10px !important;
      }
      
      /* Step navigation mobile improvements */
      .step-nav {
        position: sticky !important;
        bottom: 0 !important;
        background: white !important;
        padding: 15px 10px !important;
        border-top: 1px solid #e5e7eb !important;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1) !important;
      }
      
      .step-nav button {
        width: 100% !important;
        margin: 5px 0 !important;
        min-height: 50px !important;
        font-size: 16px !important;
        font-weight: 600 !important;
      }
      
      /* Module container mobile styling */
      .module-embed {
        margin: 15px 0 !important;
      }
      
      .module-embed iframe {
        height: 70vh !important;
        min-height: 500px !important;
        border-radius: 12px !important;
      }
      
      /* Subtotal display mobile styling */
      .subtotal-display {
        margin: 20px 0 !important;
        padding: 20px 15px !important;
        border-radius: 12px !important;
        text-align: center !important;
      }
      
      .subtotal-title {
        font-size: 16px !important;
        margin-bottom: 8px !important;
      }
      
      .subtotal-amount {
        font-size: 22px !important;
        margin-bottom: 5px !important;
      }
      
      .vat-info {
        font-size: 13px !important;
        line-height: 1.4 !important;
      }
    }
    
    @media (max-width: 480px) {
      /* âœ… ENHANCED: Extra small screen optimizations */
      .work-row, .repair-row {
        padding: 15px 10px !important;
        margin-bottom: 15px !important;
        gap: 12px !important;
      }
      
      .work-row .work-type,
      .work-row .work-cost,
      .work-row .work-comments,
      .repair-row .repair-name,
      .repair-row .repair-cost,
      .repair-row .repair-desc {
        padding: 12px !important;
        font-size: 16px !important;
      }
      
      .work-row button,
      .repair-row button {
        padding: 12px !important;
        min-height: 45px !important;
        font-size: 15px !important;
      }
      
      .subtotal-amount {
        font-size: 20px !important;
      }
      
      .module-embed iframe {
        height: 60vh !important;
        min-height: 400px !important;
      }
      
      .user-notification {
        top: 5px !important;
        right: 5px !important;
        left: 5px !important;
        padding: 12px 15px !important;
        font-size: 15px !important;
      }
    }
    
    /* Internal browser integration fixes */
    .internal-browser-container {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .parts-search-browser {
      width: 100%;
      min-height: 500px;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      background: white;
    }
    
    /* Ensure all external links open in internal browser */
    .force-internal-browser {
      cursor: pointer;
      color: #3b82f6;
      text-decoration: underline;
    }
    
    .force-internal-browser:hover {
      color: #1e40af;
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">×˜×•×¢×Ÿ ××©×£ ××•×§×“×™ × ×–×§...</div>
  </div>
  
  <div class="container">
    <div class="header">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª" class="logo">
      <h1>××©×£ ××•×§×“×™ × ×–×§</h1>
      <p>××¢×¨×›×ª ××ª×§×“××ª ×œ× ×™×”×•×œ ×•× ×™×ª×•×— ××•×§×“×™ × ×–×§</p>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>
    
    <div class="wizard-content">
      
      <!-- Step 1: Damage Center Number & Location -->
      <div class="step active" id="step1">
        <div class="step-header">
          <div class="step-number">1</div>
          <h2 class="step-title">××¡×¤×¨ ×•××™×§×•× ××•×§×“ ×”× ×–×§</h2>
          <p class="step-description">×”×’×“×¨×ª ××¡×¤×¨ ××•×§×“ ×”× ×–×§ ×•×‘×—×™×¨×ª ××™×§×•× ×”× ×–×§ ×‘×¨×›×‘</p>
        </div>

        <!-- âœ… ENHANCED: Comprehensive Damage Center Management -->
        <div class="damage-center-management-section" style="margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 12px; border: 2px solid #0369a1; box-shadow: 0 4px 12px rgba(3, 105, 161, 0.1);">
          <div style="margin-bottom: 20px;">
            <h4 style="color: #0c4a6e; margin: 0 0 8px 0; font-size: 18px; font-weight: bold;">ğŸ”§ × ×™×”×•×œ ××•×§×“×™ × ×–×§</h4>
            <p style="color: #075985; margin: 0; font-size: 14px;">×¦×•×¨ ××•×§×“ × ×–×§ ×—×“×© ××• ×¢×¨×•×š ××•×§×“ ×§×™×™×</p>
          </div>
          
          <!-- Existing Centers Display -->
          <div id="existingCentersDisplay" style="margin-bottom: 20px; display: none;">
            <div style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #bae6fd;">
              <h5 style="color: #0369a1; margin: 0 0 12px 0; font-size: 16px;">ğŸ“‹ ××•×§×“×™ × ×–×§ ×§×™×™××™×</h5>
              <div id="existingCentersList" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center; justify-content: center;">
            
            <select id="existingDamageCenterSelect" style="
              padding: 10px 14px; 
              border: 2px solid #0369a1; 
              border-radius: 8px; 
              background: white;
              color: #0c4a6e;
              font-size: 14px;
              min-width: 180px;
              cursor: pointer;
            " onchange="handleExistingCenterSelection()">
              <option value="">×‘×—×¨ ××•×§×“ ×§×™×™× ×œ×¢×¨×™×›×”</option>
            </select>
            
            <button type="button" onclick="editSelectedDamageCenter()" style="
              background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); 
              color: white; 
              border: none; 
              padding: 10px 16px; 
              border-radius: 8px; 
              cursor: pointer; 
              font-weight: bold;
              font-size: 14px;
              transition: all 0.3s ease;
            ">
              âœï¸ ×¢×¨×•×š
            </button>
            
            <button type="button" onclick="clearDamageCenterData()" style="
              background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); 
              color: white; 
              border: none; 
              padding: 10px 16px; 
              border-radius: 8px; 
              cursor: pointer; 
              font-weight: bold;
              font-size: 14px;
              transition: all 0.3s ease;
            ">
              ğŸ—‘ï¸ ××—×§
            </button>
          </div>
          
          <!-- Status Display -->
          <div id="damageCenterStatus" style="margin-top: 15px; padding: 12px; background: #dcfce7; border-radius: 8px; border: 1px solid #16a34a; display: none;">
            <div style="color: #15803d; font-weight: bold; text-align: center;" id="statusMessage">
              âœ… ××•×›×Ÿ ×œ×™×¦×™×¨×ª ××•×§×“ × ×–×§ ×—×“×©
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">××¡×¤×¨ ××•×§×“ × ×–×§</label>
          <input type="text" class="form-input" id="damageCenterNumber" readonly>
        </div>
        
        <div class="form-group">
          <label class="form-label">×‘×—×¨ ××™×§×•× ×”× ×–×§</label>
          <select class="form-select" id="locationSelect" onchange="handleLocationChange()">
            <option value="">×‘×—×¨ ××™×§×•× × ×–×§</option>
            <!-- Location options will be populated dynamically -->
          </select>
        </div>
        
        <div class="form-group" id="otherLocationGroup" style="display: none;">
          <label class="form-label">×¤×¨×˜ ××™×§×•× ××—×¨</label>
          <input type="text" class="form-input" id="otherLocationInput" placeholder="×”×›× ×¡ ××™×§×•× × ×–×§ ××•×ª×× ××™×©×™×ª..." onchange="updateOtherLocation()">
        </div>

        <!-- âœ… NEW: Quick access to summary button -->
        <div style="margin-top: 25px; padding: 15px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 10px; border: 2px solid #3b82f6; text-align: center;">
          <h4 style="color: #1e40af; margin: 0 0 10px 0; font-size: 16px;">×¦×¤×” ×‘×¡×™×›×•× ×›×œ ××•×§×“×™ ×”× ×–×§</h4>
          <button type="button" onclick="goToSummary()" style="
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
          " 
          onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'" 
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.3)'">
            ğŸ“Š ×¢×‘×•×¨ ×œ×¡×™×›×•× ××•×§×“×™ ×”× ×–×§
          </button>
        </div>
      </div>
      
      <!-- Step 2: Damage Description -->
      <div class="step" id="step2">
        <div class="step-header">
          <div class="step-number">2</div>
          <h2 class="step-title">×ª×™××•×¨ ×”× ×–×§</h2>
          <p class="step-description">×ª×™××•×¨ ××¤×•×¨×˜ ×©×œ ×”× ×–×§ ×‘××•×§×“ ×©× ×‘×—×¨</p>
        </div>
        
        <div class="form-group">
          <label class="form-label">×ª×™××•×¨ ×”× ×–×§</label>
          <textarea class="form-textarea" id="damageDescription" placeholder="×ª××¨ ××ª ×”× ×–×§ ×‘×¤×™×¨×•×˜..." rows="6" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; font-size: 16px; resize: vertical;"></textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label">××”×•×ª ×”×ª×™×§×•×Ÿ</label>
          <textarea class="form-textarea" id="repairNature" placeholder="×ª××¨ ××ª ××”×•×ª ×”×ª×™×§×•×Ÿ ×”× ×“×¨×©..." rows="4" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; font-size: 16px; resize: vertical;" onchange="updateRepairNature()" oninput="updateRepairNature()"></textarea>
        </div>
      </div>
      
      <!-- Step 3: Work Needed -->
      <div class="step" id="step3">
        <div class="step-header">
          <div class="step-number">3</div>
          <h2 class="step-title">×¢×‘×•×“×•×ª × ×“×¨×©×•×ª</h2>
          <p class="step-description">×”×’×“×¨×ª ×”×¢×‘×•×“×•×ª ×”× ×“×¨×©×•×ª ×œ×ª×™×§×•×Ÿ ×”× ×–×§</p>
        </div>
        
        <div class="module-embed" id="workModule">
          <p>×˜×•×¢×Ÿ ××•×“×•×œ ×¢×‘×•×“×•×ª...</p>
        </div>
        
        <div class="subtotal-display" id="workSubtotal" style="display:none;">
          <div class="subtotal-title">×¡×™×›×•× ×¢×‘×•×“×•×ª</div>
          <div class="subtotal-amount" id="workAmount">â‚ª0</div>
          <div class="vat-info">×œ×œ× ××¢"× | ×›×•×œ×œ ××¢"×: <span id="workAmountWithVat">â‚ª0</span></div>
        </div>
        
        <!-- Local Refresh Button for Works -->
        <div style="text-align: center; margin-top: 15px;">
          <button type="button" onclick="refreshWorksModule()" style="
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
          " 
          onmouseover="this.style.background='linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%)'" 
          onmouseout="this.style.background='linear-gradient(135deg, #3b82f6 0%, #1e40af 100%)'">
            ğŸ”„ ×¨×¢× ×Ÿ ×¢×‘×•×“×•×ª
          </button>
        </div>
      </div>
      
      <!-- Step 4: Parts Search -->
      <div class="step" id="step4">
        <div class="step-header">
          <div class="step-number">4</div>
          <h2 class="step-title">×—×™×¤×•×© ×—×œ×¤×™×</h2>
          <p class="step-description">×—×™×¤×•×© ××¢×¨×›×ª/car-part  ×—×™×¤×•×© ×—×œ×¤×™× : ××ª×¨</p>
        </div>
        
        <div class="module-embed" id="partsSearchModule">
          <p>×˜×•×¢×Ÿ ××•×“×•×œ ×—×™×¤×•×© ×—×œ×¤×™×...</p>
        </div>
        
        <div class="subtotal-display" id="searchResultsInfo" style="display:none;">
          <div class="subtotal-title">×ª×•×¦××•×ª ×—×™×¤×•×©</div>
          <div class="subtotal-amount" id="searchResultsCount">0 ×—×œ×¤×™× × ××¦××•</div>
          <div class="vat-info">×”×ª×•×¦××•×ª × ×©××¨×• ×œ××¢×¨×›×ª ×œ×‘×—×™×¨×” ×‘×©×œ×‘ ×”×‘×</div>
        </div>
        
        <!-- Local Refresh Button for Parts Search -->
        <div style="text-align: center; margin-top: 15px;">
          <button type="button" onclick="refreshPartsSearchModule()" style="
            background: linear-gradient(135deg, #059669 0%, #047857 100%); 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
          " 
          onmouseover="this.style.background='linear-gradient(135deg, #047857 0%, #065f46 100%)'" 
          onmouseout="this.style.background='linear-gradient(135deg, #059669 0%, #047857 100%)'">
            ğŸ”„ ×¨×¢× ×Ÿ ×—×™×¤×•×© ×—×œ×¤×™×
          </button>
        </div>
      </div>
      
      <!-- Step 5: Parts Selection -->
      <div class="step" id="step5">
        <div class="step-header">
          <div class="step-number">5</div>
          <h2 class="step-title">×‘×—×™×¨×ª ×—×œ×¤×™×</h2>
          <p class="step-description">×‘×—×™×¨×ª ×”×—×œ×¤×™× ×”× ×“×¨×©×™× ××ª×•×¦××•×ª ×”×—×™×¤×•×©</p>
        </div>
        
        <div class="module-embed" id="partsModule">
          <p>×˜×•×¢×Ÿ ××•×“×•×œ ×‘×—×™×¨×ª ×—×œ×¤×™×...</p>
        </div>
        
        <div class="subtotal-display" id="partsSubtotal" style="display:none;">
          <div class="subtotal-title">×¡×™×›×•× ×—×œ×¤×™×</div>
          <div class="subtotal-amount" id="partsAmount">â‚ª0</div>
          <div class="vat-info">×œ×œ× ××¢"× | ×›×•×œ×œ ××¢"×: <span id="partsAmountWithVat">â‚ª0</span></div>
        </div>
        
        <!-- Local Refresh Button for Parts Selection -->
        <div style="text-align: center; margin-top: 15px;">
          <button type="button" onclick="refreshPartsModule()" style="
            background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
          " 
          onmouseover="this.style.background='linear-gradient(135deg, #5b21b6 0%, #4c1d95 100%)'" 
          onmouseout="this.style.background='linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%)'">
            ğŸ”„ ×¨×¢× ×Ÿ ×‘×—×™×¨×ª ×—×œ×¤×™×
          </button>
        </div>
      </div>
      
      <!-- Step 6: Required Repairs -->
      <div class="step" id="step6">
        <div class="step-header">
          <div class="step-number">6</div>
          <h2 class="step-title">×ª×™×§×•× ×™× × ×“×¨×©×™×</h2>
          <p class="step-description">×”×’×“×¨×ª ×”×ª×™×§×•× ×™× ×”× ×“×¨×©×™× ×•×¢×œ×•×™×•×ª×™×”×</p>
        </div>
        
        <div class="module-embed" id="repairsModule">
          <p>×˜×•×¢×Ÿ ××•×“×•×œ ×ª×™×§×•× ×™×...</p>
        </div>
        
        <div class="subtotal-display" id="repairsSubtotal" style="display:none;">
          <div class="subtotal-title">×¡×™×›×•× ×ª×™×§×•× ×™×</div>
          <div class="subtotal-amount" id="repairsAmount">â‚ª0</div>
          <div class="vat-info">×œ×œ× ××¢"× | ×›×•×œ×œ ××¢"×: <span id="repairsAmountWithVat">â‚ª0</span></div>
        </div>
        
        <!-- Local Refresh Button for Repairs -->
        <div style="text-align: center; margin-top: 15px;">
          <button type="button" onclick="refreshRepairsModule()" style="
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
          " 
          onmouseover="this.style.background='linear-gradient(135deg, #b91c1c 0%, #991b1b 100%)'" 
          onmouseout="this.style.background='linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)'">
            ğŸ”„ ×¨×¢× ×Ÿ ×ª×™×§×•× ×™×
          </button>
        </div>
      </div>
      
      <!-- Step 7: Summary -->
      <div class="step" id="step7">
        <div class="step-header">
          <div class="step-number">7</div>
          <h2 class="step-title">×¡×™×›×•× ××•×§×“×™ ×”× ×–×§</h2>
          <p class="step-description">×¡×™×›×•× ×›×•×œ×œ ×©×œ ×›×œ ××•×§×“×™ ×”× ×–×§ ×•×”×¢×œ×•×™×•×ª</p>
          
          <!-- âœ… LOCAL REFRESH BUTTON -->
          <div style="margin-top: 15px; text-align: center;">
            <button type="button" onclick="refreshStep7Summary()" style="
              background: linear-gradient(135deg, #10b981 0%, #059669 100%);
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 8px;
              cursor: pointer;
              font-weight: bold;
              font-size: 14px;
              transition: all 0.3s ease;
              box-shadow: 0 3px 10px rgba(16, 185, 129, 0.3);
            "
            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 5px 15px rgba(16, 185, 129, 0.4)'"
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(16, 185, 129, 0.3)'">
              ğŸ”„ ×¨×¢× ×Ÿ ×¨×©×™××ª ××•×§×“×™ × ×–×§
            </button>
          </div>
        </div>
        
        <!-- âœ… NEW: Container for all damage centers -->
        <div id="damageCentersContainer">
          <!-- Dynamic content will be populated here -->
        </div>
        
        <!-- âœ… NEW: Final totals summary -->
        <div class="final-totals-summary" style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; border-radius: 15px; box-shadow: 0 8px 25px rgba(30, 58, 138, 0.3);">
          <h3 style="text-align: center; margin-bottom: 25px; font-size: 24px; color: white;">×¡×™×›×•× ×¡×•×¤×™ - ×›×œ ××•×§×“×™ ×”× ×–×§</h3>
          
          <div id="centersTotalsByLocation" style="margin-bottom: 20px;">
            <!-- Individual center totals will be populated here -->
          </div>
          
          <div style="border-top: 2px solid rgba(255,255,255,0.3); padding-top: 20px; text-align: center;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 18px;">
              <span>×¡×”"×› ×œ×œ× ××¢"×:</span>
              <strong id="grandTotalWithoutVAT">â‚ª0</strong>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 16px; color: rgba(255,255,255,0.8);">
              <span>××¢"× (<span id="vatPercentageDisplay">18</span>%):</span>
              <strong id="grandTotalVATAmount">â‚ª0</strong>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 22px; font-weight: bold;">
              <span>×¡×”"×› ×›×•×œ×œ ××¢"×:</span>
              <strong id="grandTotalWithVAT">â‚ª0</strong>
            </div>
          </div>
        </div>
        
        <!-- âœ… Save Current Damage Center Before Actions -->
        <div style="margin-top: 25px; text-align: center; padding: 15px; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-radius: 10px; border: 1px solid #10b981;">
          <button type="button" id="saveBtn" onclick="saveCurrentStep()" style="
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(22, 163, 74, 0.3);
          " 
          onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 5px 15px rgba(22, 163, 74, 0.4)'" 
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(22, 163, 74, 0.3)'">
            ğŸ’¾ ×©××•×¨ ××•×§×“ × ×–×§ × ×•×›×—×™
          </button>
        </div>
          
          <!-- Add New Damage Center Option at End of Flow -->
          <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); border-radius: 12px; border: 2px dashed #10b981;">
            <div style="text-align: center; margin-bottom: 15px;">
              <h4 style="color: #374151; margin: 0 0 8px 0;">×”×× ×ª×¨×¦×” ×œ×™×¦×•×¨ ××•×§×“ × ×–×§ × ×•×¡×£?</h4>
              <p style="color: #6b7280; margin: 0; font-size: 14px;">×œ×—×¥ ×›×“×™ ×œ×™×¦×•×¨ ××•×§×“ × ×–×§ ×—×“×© ××• ×¡×™×™× ×œ×”×©×œ××ª ×”××§×¡×¤×¨×˜×™×–×”</p>
            </div>
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
              <button type="button" onclick="createNewDamageCenter()" style="
                background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
                color: white; 
                border: none; 
                padding: 12px 24px; 
                border-radius: 8px; 
                cursor: pointer; 
                font-weight: bold;
                font-size: 16px;
                transition: all 0.3s ease;
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
              " 
              onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(16, 185, 129, 0.4)'" 
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'">
                â• ×¦×•×¨ ××•×§×“ × ×–×§ ×—×“×©
              </button>
              <button type="button" onclick="finishAndGoToSummary()" style="
                background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); 
                color: white; 
                border: none; 
                padding: 12px 24px; 
                border-radius: 8px; 
                cursor: pointer; 
                font-weight: bold;
                font-size: 16px;
                transition: all 0.3s ease;
                box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
              " 
              onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(30, 64, 175, 0.4)'" 
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(30, 64, 175, 0.3)'">
                âœ… ×¡×™×™× ×•×¢×‘×•×¨ ×œ×¡×™×›×•× ×”××§×¡×¤×¨×˜×™×–×”
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="navigation">
        <button class="nav-button" onclick="window.location.href='selection.html'" style="background-color: #6c757d;">×—×–×•×¨ ×œ×‘×—×™×¨×”</button>
        <button class="nav-button" id="prevBtn" onclick="previousStep()" style="display:none; background-color: #6c757d;">×”×§×•×“×</button>
        <button class="nav-button" id="navSaveBtn" onclick="saveCurrentStep()" style="background-color: #28a745;">×©××•×¨ × ×ª×•× ×™×</button>
        <div id="stepInfo">×©×œ×‘ 1 ××ª×•×š 7</div>
        <button class="nav-button" id="nextBtn" onclick="nextStep()">×”×‘×</button>
      </div>
    </div>
  </div>
  
  <script src="helper.js" type="module"></script>
  <script type="module" src="parts.js"></script>
  <script>
    // Global wizard state and module data storage
    let moduleData = {
      works: [],
      parts: [],
      repairs: [],
      takana389: '',
      location: '',
      description: ''
    };
    
    // Listen for data from iframe modules
    window.addEventListener('message', function(event) {
      console.log('ğŸ“¨ Wizard received message:', event.data);
      
      // âœ… CRITICAL FIX: Handle parts search webhook results from parts search module
      if (event.data.type === 'partsSearchResults') {
        console.log('ğŸ” Parts search results received from webhook:', event.data);
        
        try {
          // Store webhook results in helper for parts-required to use as suggestions
          let helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
          helper.parts_search = helper.parts_search || {};
          
          // Store the webhook results in helper.parts_search
          helper.parts_search.all_results = event.data.results || [];
          helper.parts_search.current_session = {
            results: event.data.results || [],
            plate: event.data.plate,
            search_date: event.data.date,
            source: event.data.source || 'parts_search_webhook',
            timestamp: new Date().toISOString()
          };
          
          // Save updated helper
          sessionStorage.setItem('helper', JSON.stringify(helper));
          window.helper = helper;
          
          console.log(`âœ… Stored ${event.data.results?.length || 0} parts search results in helper.parts_search`);
          
          // Show user notification
          showUserNotification(`× ××¦××• ${event.data.results?.length || 0} ×§×‘×•×¦×•×ª ×—×œ×§×™× ×-webhook!`, 'success', 3000);
          
        } catch (error) {
          console.error('âŒ Error storing parts search results:', error);
          showUserNotification('×©×’×™××” ×‘×©××™×¨×ª ×ª×•×¦××•×ª ×—×™×¤×•×© ×—×œ×§×™×', 'error');
        }
        
        return;
      }
      
      if (event.data.type === 'moduleData') {
        const { module, data } = event.data;
        
        switch(module) {
          case 'work':
            moduleData.works = data.works || [];
            moduleData.takana389 = data.takana389 || '';
            console.log('âœ… Work data received in wizard:', moduleData.works);
            break;
            
          case 'parts':
            moduleData.parts = data.parts || [];
            console.log('âœ… Parts data received in wizard:', moduleData.parts);
            break;
            
          case 'repairs':
            moduleData.repairs = data.repairs || [];
            console.log('âœ… Repairs data received in wizard:', moduleData.repairs);
            break;
        }
        
        // Update helper with collected data
        updateHelperWithModuleData();
        
        // Recalculate totals whenever module data changes
        calculateTotals();
      }
    });
    
    function updateHelperWithModuleData() {
      // âœ… REMOVED: This function used to save to damage_assessment.work/parts/repairs
      // Now all data is only saved within the damage center itself
      // Keeping function empty for backward compatibility
    }

    // âœ… NEW: Function to update damage assessment according to documentation structure
    function updateDamageAssessment(helper) {
      console.log('ğŸ”„ Updating damage assessment structure...');
      
      if (!helper.centers || !Array.isArray(helper.centers)) {
        console.warn('âš ï¸ No centers data found, skipping assessment update');
        return;
      }
      
      // Initialize assessment structure per documentation
      helper.damage_assessment = {
        damage_centers_summary: {},
        totals: {}
      };
      
      let totalWithoutVAT = 0;
      let totalWithVAT = 0;
      
      // Process each damage center
      helper.centers.forEach((center, index) => {
        const centerNumber = center["Damage center Number"] || (index + 1).toString();
        const centerKey = `Damage center ${centerNumber}`;
        
        // Calculate costs per category
        const worksTotal = center.Works?.works_meta?.total_cost || 0;
        const partsTotal = center.Parts?.parts_meta?.total_cost || 0;
        const repairsTotal = center.Repairs?.repairs_meta?.total_cost || 0;
        
        const centerSubtotal = worksTotal + partsTotal + repairsTotal;
        const vatRate = (helper.calculations && helper.calculations.vat_rate) ? helper.calculations.vat_rate : 18;
        const centerVAT = centerSubtotal * (vatRate / 100);
        const centerTotal = centerSubtotal + centerVAT;
        
        // Add to damage_centers_summary
        helper.damage_assessment.damage_centers_summary[centerKey] = {
          "Works": worksTotal,
          "Parts": partsTotal,
          "Repairs": repairsTotal,
          "Total without VAT": centerSubtotal,
          "Total with VAT": centerTotal
        };
        
        // Add to totals section
        helper.damage_assessment.totals[centerKey] = centerTotal;
        
        // Accumulate grand totals
        totalWithoutVAT += centerSubtotal;
        totalWithVAT += centerTotal;
        
        console.log(`âœ… Processed ${centerKey}:`, {
          works: worksTotal,
          parts: partsTotal,
          repairs: repairsTotal,
          subtotal: centerSubtotal,
          total: centerTotal
        });
      });
      
      // Add grand totals
      helper.damage_assessment.totals["Total without VAT"] = totalWithoutVAT;
      helper.damage_assessment.totals["Total with VAT"] = totalWithVAT;
      
      console.log('âœ… Damage assessment updated:', {
        centersProcessed: helper.centers.length,
        totalWithoutVAT,
        totalWithVAT
      });
    }
    
    // Global wizard state
    let currentStep = 1;
    const totalSteps = 7; // Added one more step for parts search
    let damageCenterData = {};
    let vatPercentage = 18; // Will be loaded from system settings
    
    // Damage center locations (from advanced damage center module)
    const damageLocations = [
      '×§×“××ª ×”×¨×›×‘', '××—×•×¨×™ ×”×¨×›×‘', '×¦×“ ×™××™×Ÿ ×§×“××™', '×¦×“ ×™××™×Ÿ ××—×•×¨×™',
      '×¦×“ ×©×××œ ×§×“××™', '×¦×“ ×©×××œ ××—×•×¨×™', '×’×’ ×”×¨×›×‘', '×ª×—×ª×™×ª ×”×¨×›×‘',
      '×¤× ×™× ×§×“××™', '×¤× ×™× ××—×•×¨×™', '×× ×•×¢', '×ª× ××˜×¢×Ÿ', '×“×œ×ª×•×ª', '×—×œ×•× ×•×ª'
    ];
    
    // Initialize wizard on page load
    document.addEventListener('DOMContentLoaded', function() {
      initializeWizard();
    });
    
    function initializeWizard() {
      // Show loading
      document.getElementById('loadingOverlay').style.display = 'flex';
      
      // âœ… CRITICAL: Initialize helper with correct structure per documentation
      let helper = {};
      try {
        helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      } catch (e) {
        console.error('Failed to parse helper:', e);
      }
      
      // Ensure correct structure exists per documentation
      if (!helper.centers) {
        helper.centers = [];
        console.log('âœ… Initialized empty centers array');
      }
      
      if (!helper.current_damage_center) {
        helper.current_damage_center = {};
        console.log('âœ… Initialized empty current_damage_center');
      }
      
      // Sync to window.helper
      if (!window.helper) {
        window.helper = helper;
      } else {
        if (!window.helper.centers) {
          window.helper.centers = [];
        }
        if (!window.helper.current_damage_center) {
          window.helper.current_damage_center = {};
        }
      }
      
      // Save back to sessionStorage
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      // âœ… FIXED: Check for previous wizard session and restore
      const previousSession = checkForPreviousWizardSession();
      if (previousSession) {
        restorePreviousWizardSession(previousSession);
      } else {
        // Generate new damage center number
        generateDamageCenterNumber();
      }
      
      // Populate location dropdown
      populateLocationDropdown();
      
      // Initialize helper system
      if (typeof window.helper !== 'undefined') {
        // Load VAT percentage from helper calculations (centralized source)
        if (window.helper.calculations && window.helper.calculations.vat_rate) {
          vatPercentage = window.helper.calculations.vat_rate;
        }
      }
      
      // Hide loading after initialization
      setTimeout(() => {
        document.getElementById('loadingOverlay').style.display = 'none';
      }, 1000);
    }
    
    function checkForPreviousWizardSession() {
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        const activeCenterId = sessionStorage.getItem('active_damage_center_id');
        
        // âœ… FIXED: Check for active damage center in damage_centers array
        if (activeCenterId && helper.damage_centers) {
          const activeCenter = helper.damage_centers.find(c => c.id === activeCenterId);
          if (activeCenter) {
            console.log('ğŸ”„ Found active damage center to restore:', activeCenter);
            return {
              id: activeCenter.id,
              number: activeCenter.number,
              mode: 'edit',
              last_step: activeCenter.meta?.last_step || 1,
              location: activeCenter.location,
              description: activeCenter.description
            };
          }
        }
        
        // Fallback to wizard_temp
        return helper.wizard_temp?.current_damage_center || null;
      } catch (e) {
        console.warn('Failed to check for previous wizard session');
        return null;
      }
    }
    
    function restorePreviousWizardSession(previousSession) {
      console.log('ğŸ”„ Restoring previous wizard session:', previousSession);
      
      // âœ… FIXED: Restore full damage center data
      if (previousSession.mode === 'edit' && previousSession.id) {
        // Restore damage center data
        damageCenterData = {
          id: previousSession.id,
          number: previousSession.number,
          location: previousSession.location || '',
          description: previousSession.description || ''
        };
        
        // Restore to appropriate step
        currentStep = previousSession.last_step || 1;
        console.log('ğŸ“ Restored edit mode to step:', currentStep);
      } else if (previousSession.session_active && previousSession.last_step) {
        // âœ… FIX: Restore regular wizard session (non-edit mode)
        currentStep = previousSession.last_step;
        console.log(`ğŸ”„ Restored wizard session to step: ${currentStep}`);
      } else {
        // Always start new centers at step 1
        currentStep = 1;
        damageCenterData.number = previousSession.number;
        console.log('âœ¨ Starting new damage center at step 1');
      }
      
      // Update number display
      const numberInput = document.getElementById('damageCenterNumber');
      if (numberInput) {
        numberInput.value = damageCenterData.number;
      }
      
      // Show appropriate step
      showStep(currentStep);
      updateProgress();
      
      // Restore form data for current step
      setTimeout(() => {
        restoreStepData(currentStep);
      }, 100);
      
      // Load module for current step if needed
      loadStepModule(currentStep);
      
      console.log(`âœ… Wizard session restored to step ${currentStep}`);
    }
    
    // âœ… FIX: Save current step for page refresh recovery
    function saveCurrentStepToSession() {
      try {
        let helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        if (!helper.current_damage_center) {
          helper.current_damage_center = {};
        }
        
        // Save current step and other session info
        helper.current_damage_center.last_step = currentStep;
        helper.current_damage_center.session_active = true;
        helper.current_damage_center.last_updated = new Date().toISOString();
        
        sessionStorage.setItem('helper', JSON.stringify(helper));
        console.log(`ğŸ’¾ Saved current step ${currentStep} to session`);
      } catch (error) {
        console.error('âŒ Failed to save current step to session:', error);
      }
    }
    
    function generateDamageCenterNumber() {
      // Use the new helper API for proper damage center numbering
      let nextNumber = 1;
      
      if (typeof window.getNextDamageCenterNumber === 'function') {
        nextNumber = window.getNextDamageCenterNumber();
        console.log(`ğŸ”¢ Generated damage center number using helper API: ${nextNumber}`);
      } else {
        // Fallback to legacy method if helper API not available
        const existingCenters = getDamageCentersFromHelper();
        
        // âœ… FIXED: Use correct field name per documentation
        let highestNumber = 0;
        existingCenters.forEach(center => {
          const centerNumber = parseInt(center["Damage center Number"] || center.number || 0);
          if (centerNumber > highestNumber) {
            highestNumber = centerNumber;
          }
        });
        
        nextNumber = highestNumber + 1;
        console.log(`ğŸ”¢ Generated damage center number (fallback): ${nextNumber} (existing centers: ${existingCenters.length}, highest: ${highestNumber})`);
      }
      
      document.getElementById('damageCenterNumber').value = nextNumber;
      damageCenterData.number = nextNumber;
      
      // FIXED: Generate and set active center ID to prevent orphaned data
      const newCenterId = `center_${Date.now()}_${nextNumber}`;
      damageCenterData.id = newCenterId;
      
      // Set active center for modules
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      helper.damage_assessment = helper.damage_assessment || {};
      helper.damage_assessment.current_center_id = newCenterId;
      sessionStorage.setItem('active_damage_center_id', newCenterId);
      
      // ARCHITECTURAL FIX: Clear orphaned global assessment data when starting new center
      console.log('ğŸ§¹ Clearing orphaned global assessment data...');
      if (helper.damage_assessment.works) {
        console.log('âš ï¸ Removing orphaned works data:', helper.damage_assessment.works);
        delete helper.damage_assessment.works;
      }
      if (helper.damage_assessment.parts) {
        console.log('âš ï¸ Removing orphaned parts data:', helper.damage_assessment.parts);
        delete helper.damage_assessment.parts;
      }
      if (helper.damage_assessment.repairs) {
        console.log('âš ï¸ Removing orphaned repairs data:', helper.damage_assessment.repairs);
        delete helper.damage_assessment.repairs;
      }
      if (helper.damage_assessment.totals) {
        console.log('âš ï¸ Removing orphaned totals data:', helper.damage_assessment.totals);
        delete helper.damage_assessment.totals;
      }
      
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      console.log('ğŸ¯ Set active damage center ID for new center:', newCenterId);
      console.log('âœ… Cleared orphaned data, modules will now save to specific centers only');
    }
    
    function populateLocationDropdown() {
      const select = document.getElementById('locationSelect');
      select.innerHTML = '<option value="">×‘×—×¨ ××™×§×•× × ×–×§</option>';
      
      damageLocations.forEach(location => {
        const option = document.createElement('option');
        option.value = location;
        option.textContent = location;
        select.appendChild(option);
      });
      
      // Add "other" option
      const otherOption = document.createElement('option');
      otherOption.value = 'other';
      otherOption.textContent = '××—×¨ (×¤×¨×˜ ×‘××§×•× ×”×‘×)';
      select.appendChild(otherOption);
    }
    
    window.handleLocationChange = function() {
      const select = document.getElementById('locationSelect');
      const otherGroup = document.getElementById('otherLocationGroup');
      const otherInput = document.getElementById('otherLocationInput');
      
      if (select.value === 'other') {
        otherGroup.style.display = 'block';
        otherInput.focus();
        damageCenterData.location = 'other';
        damageCenterData.customLocation = '';
      } else {
        otherGroup.style.display = 'none';
        otherInput.value = '';
        damageCenterData.location = select.value;
        damageCenterData.customLocation = '';
      }
    };
    
    window.updateOtherLocation = function() {
      const otherInput = document.getElementById('otherLocationInput');
      damageCenterData.customLocation = otherInput.value.trim();
    };
    
    function nextStep() {
      console.log('ğŸ” === NEXT STEP BUTTON CLICKED ===');
      console.log('ğŸ” Current step:', currentStep);
      console.log('ğŸ” Total steps:', totalSteps);
      
      // âœ… CRITICAL DEBUG: Check validation first
      console.log('ğŸ” Checking validation for current step...');
      const isValid = validateCurrentStep();
      console.log('ğŸ” Validation result:', isValid);
      
      if (isValid) {
        console.log('âœ… Validation passed, proceeding...');
        
        if (currentStep < totalSteps) {
          console.log('ğŸ” Not final step, saving current step data...');
          
          // Save current step data (now includes damage center creation/update)
          console.log('ğŸ” About to call saveCurrentStepData()...');
          saveCurrentStepData();
          console.log('âœ… saveCurrentStepData() completed');
          
          // Move to next step
          console.log('ğŸ” Moving to next step...');
          currentStep++;
          
          // âœ… FIX: Save current step to session for page refresh recovery
          saveCurrentStepToSession();
          
          showStep(currentStep);
          updateProgress();
          
          // Load module if needed
          loadStepModule(currentStep);
          console.log('âœ… Step transition completed');
        } else {
          console.log('ğŸ” Final step, updating final damage center data...');
          // Final step - save final data to existing damage center
          updateFinalDamageCenterData();
        }
      } else {
        console.log('âŒ Validation failed, step not advanced');
      }
    }
    
    function previousStep() {
      if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
        updateProgress();
      }
    }
    
    function saveCurrentStep() {
      console.log('ğŸ’¾ === SAVE BUTTON CLICKED (saveCurrentStep) ===');
      console.log('ğŸ” Current step:', currentStep);
      console.log('ğŸ” Total steps:', totalSteps);
      console.log('ğŸ” damageCenterData:', damageCenterData);
      
      // âœ… Show visual feedback immediately
      const saveBtn = document.getElementById('saveBtn');
      const originalText = saveBtn.textContent;
      saveBtn.textContent = 'ğŸ”„ ×©×•××¨...';
      saveBtn.disabled = true;
      
      try {
        // âœ… STEP 7 SPECIAL HANDLING: Transfer current_damage_center to centers array
        if (currentStep === 7) {
          console.log('ğŸ Step 7 save - Moving current_damage_center to centers array...');
          
          // Get the helper data
          let helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
          
          // Check if damage center was already saved (current_damage_center is empty)
          if (!helper.current_damage_center || Object.keys(helper.current_damage_center).length === 0) {
            console.log('âœ… Damage center already saved - no action needed');
            saveBtn.textContent = 'âœ… ×›×‘×¨ × ×©××¨';
            setTimeout(() => {
              saveBtn.textContent = originalText;
              saveBtn.disabled = false;
            }, 2000);
            return;
          }
          
          if (helper.current_damage_center && (helper.current_damage_center.Id || Object.keys(helper.current_damage_center).length > 0)) {
            // Update the Summary with current totals
            const worksTotal = helper.current_damage_center.Works?.works_meta?.total_cost || 0;
            const partsTotal = helper.current_damage_center.Parts?.parts_meta?.total_cost || 0;
            const repairsTotal = helper.current_damage_center.Repairs?.repairs_meta?.total_cost || 0;
            const subtotal = worksTotal + partsTotal + repairsTotal;
            const vatPercentage = (helper.calculations && helper.calculations.vat_rate) ? helper.calculations.vat_rate : 18;
            const vatAmount = subtotal * (vatPercentage / 100);
            const totalWithVat = subtotal + vatAmount;
            
            helper.current_damage_center.Summary = {
              "Total works": worksTotal,
              "Total parts": partsTotal,
              "Total repairs": repairsTotal,
              "Subtotal": subtotal,
              "VAT percentage": vatPercentage,
              "VAT amount": vatAmount,
              "Total with VAT": totalWithVat
            };
            
            // Handle edit mode vs create mode
            if (!helper.centers) {
              helper.centers = [];
            }
            
            // Check if this is edit mode - update existing center instead of creating new
            if (damageCenterData.mode === 'edit_existing' && damageCenterData.original_id) {
              console.log('ğŸ” Edit mode detected - looking for existing center to update');
              console.log('ğŸ” Looking for center with ID:', damageCenterData.original_id);
              console.log('ğŸ” Or damage center number:', damageCenterData.number);
              console.log('ğŸ” Current centers:', helper.centers.map(c => ({id: c.Id || c.id, number: c["Damage center Number"] || c.number})));
              
              // Find and update existing center
              const existingIndex = helper.centers.findIndex(center => 
                center.Id === damageCenterData.original_id || 
                center.id === damageCenterData.original_id ||
                center["Damage center Number"] === damageCenterData.number
              );
              
              if (existingIndex !== -1) {
                // CRITICAL: Preserve the original damage center number when updating
                const originalNumber = helper.centers[existingIndex]["Damage center Number"] || helper.centers[existingIndex].number;
                helper.current_damage_center["Damage center Number"] = originalNumber;
                if (helper.current_damage_center.number) {
                  helper.current_damage_center.number = originalNumber;
                }
                
                // Update existing center
                helper.centers[existingIndex] = helper.current_damage_center;
                console.log('âœ… Updated existing damage center at index:', existingIndex, 'preserved number:', originalNumber);
              } else {
                // Fallback: add as new if not found
                helper.centers.push(helper.current_damage_center);
                console.log('âš ï¸ Could not find existing center to update, added as new');
                console.log('âš ï¸ Search criteria - ID:', damageCenterData.original_id, 'Number:', damageCenterData.number);
              }
            } else {
              // Create new center
              helper.centers.push(helper.current_damage_center);
              console.log('âœ… Added new damage center');
            }
            
            console.log('âœ… Damage center moved to centers array:', {
              id: helper.current_damage_center.Id,
              number: helper.current_damage_center["Damage center Number"],
              location: helper.current_damage_center.Location,
              description: helper.current_damage_center.Description
            });
            
            // Clear current damage center for next one
            helper.current_damage_center = {};
            
            // CRITICAL: Always sync centers to expertise.damage_blocks (wizard is part of expertise workflow)
            if (!helper.expertise) {
              helper.expertise = {};
            }
            helper.expertise.damage_blocks = helper.centers.slice(); // Always update damage_blocks from wizard
            console.log('âœ… Synced centers to expertise.damage_blocks:', helper.expertise.damage_blocks.length, 'centers');
            
            // Save back to sessionStorage AND window.helper
            sessionStorage.setItem('helper', JSON.stringify(helper));
            window.helper = helper; // Ensure window.helper is also updated
            console.log('âœ… Updated window.helper with expertise.damage_blocks:', window.helper.expertise?.damage_blocks?.length);
            
            // Refresh the summary display
            updateSummary();
            
            // CRITICAL: Update the existing centers display in the initial view
            updateExistingCentersDisplay(helper.centers || []);
            
            // Update existing damage centers dropdown
            populateExistingDamageCenters(true);
            
            // Generate next damage center number for immediate use
            generateDamageCenterNumber();
            
            console.log('âœ… Step 7 damage center transfer completed successfully');
          } else {
            throw new Error('No current damage center found to transfer');
          }
          
        } else {
          // For other steps, use the original save logic
          console.log('ğŸ”„ Calling saveCurrentStepData() from save button...');
          saveCurrentStepData();
          console.log('âœ… saveCurrentStepData() completed from save button');
        }
        
        // âœ… Show success feedback
        saveBtn.textContent = 'âœ… × ×©××¨';
        saveBtn.style.background = '#28a745';
        
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.style.background = '#16a34a';
          saveBtn.disabled = false;
        }, 2000);
        
      } catch (error) {
        console.error('âŒ Save failed:', error);
        saveBtn.textContent = 'âŒ ×©×’×™××”';
        saveBtn.style.background = '#dc3545';
        
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.style.background = '#16a34a';
          saveBtn.disabled = false;
        }, 3000);
      }
      
      return;
      
      // OLD CODE BELOW (now bypassed)
      try {
        // Get current helper data
        let helper = {};
        try {
          helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        } catch (e) {
          console.warn('Failed to parse helper from sessionStorage, using empty object');
          helper = {};
        }
        
        // FIXED: Use unified damage_assessment.centers structure - remove duplicate damage_centers
        helper.damage_assessment = helper.damage_assessment || {};
        helper.damage_assessment.centers = helper.damage_assessment.centers || [];
        
        // Initialize totals structure in the correct location
        helper.damage_assessment.totals = helper.damage_assessment.totals || {
          all_centers_subtotal: 0, 
          all_centers_vat: 0, 
          all_centers_total: 0
        };
        
        // Save current step data based on which step we're on
        const stepData = {};
        
        switch(currentStep) {
          case 1:
            // Location and number
            const locationSelect = document.getElementById('locationSelect');
            const otherLocationInput = document.getElementById('otherLocationInput');
            stepData.location = locationSelect?.value;
            stepData.customLocation = otherLocationInput?.value;
            stepData.number = damageCenterData.number;
            break;
            
          case 2:
            // Description
            const description = document.getElementById('damageDescription');
            stepData.description = description?.value;
            break;
            
          case 3:
            // Work module - inline component (not iframe)
            // Data is already saved via updateWorkData() calls, so just mark as saved
            stepData.work_saved = true;
            stepData.work_saved_at = new Date().toISOString();
            console.log('âœ… Work step data already captured via inline component');
            stepData.stepName = 'work';
            break;
            
          case 5:
            // Parts required module - trigger actual save function in iframe
            try {
              const partsIframe = document.getElementById('partsModuleFrame');
              if (partsIframe && partsIframe.contentWindow && partsIframe.contentWindow.savePartsData) {
                partsIframe.contentWindow.savePartsData();
                stepData.parts_saved = true;
                stepData.parts_saved_at = new Date().toISOString();
              } else {
                console.warn('Parts iframe or savePartsData function not found');
                stepData.parts_saved = false;
              }
            } catch (error) {
              console.error('Error saving parts data from wizard:', error);
              stepData.parts_saved = false;
            }
            stepData.stepName = 'parts_required';
            break;
            
          case 6:
            // Repairs module - inline component (like work module)
            // Data is already saved via updateRepairData() calls, so just mark as saved
            stepData.repairs_saved = true;
            stepData.repairs_saved_at = new Date().toISOString();
            console.log('âœ… Repairs step data already captured via inline component');
            stepData.stepName = 'repairs';
            break;
            
          default:
            // Other steps or parts search
            stepData.currentStep = currentStep;
            stepData.stepName = ['', 'location', 'description', 'work', 'parts_search', 'parts_required', 'repairs'][currentStep];
            break;
        }
        
        // FIXED: Set active damage center for modules to prevent orphaned data
        const activeCenterId = damageCenterData.id || `center_${Date.now()}`;
        
        // Set active center in multiple places for maximum compatibility
        helper.damage_assessment.current_center_id = activeCenterId;
        sessionStorage.setItem('active_damage_center_id', activeCenterId);
        
        console.log('ğŸ¯ Set active damage center ID:', activeCenterId);
        console.log('ğŸ’¾ This ensures modules save data to specific center instead of global assessment');
        
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        console.log('âœ… Step data saved to helper:', stepData);
        
        // Show save confirmation
        const saveBtn = document.getElementById('saveBtn');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = 'âœ… × ×©××¨';
        saveBtn.style.background = '#059669';
        
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.style.background = '#10b981';
        }, 2000);
        
        // Trigger helper update broadcast if available
        if (typeof window.broadcastHelperUpdate === 'function') {
          window.broadcastHelperUpdate(['damage_centers'], 'damage_center_wizard');
        }
        
      } catch (error) {
        console.error('âŒ Failed to save step data to helper:', error);
        
        // Show error state
        const saveBtn = document.getElementById('saveBtn');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = 'âŒ ×©×’×™××”';
        saveBtn.style.background = '#dc2626';
        
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.style.background = '#10b981';
        }, 3000);
        
        showUserNotification('×©×’×™××” ×‘×©××™×¨×ª × ×ª×•× ×™ ×”×©×œ×‘. ×× × × ×¡×” ×©×•×‘.', 'error');
      }
    }
    
    function showStep(step) {
      // Hide all steps
      document.querySelectorAll('.step').forEach(stepEl => {
        stepEl.classList.remove('active');
      });
      
      // Show current step
      document.getElementById(`step${step}`).classList.add('active');
      
      // âœ… RESTORE step data when navigating
      restoreStepData(step);
      
      // Update navigation
      updateNavigation();
      
      // Update step info
      document.getElementById('stepInfo').textContent = `×©×œ×‘ ${step} ××ª×•×š ${totalSteps}`;
    }
    
    function restoreStepData(step) {
      console.log('ğŸ”„ Restoring data for step:', step);
      
      try {
        // Get current helper data
        let helper = {};
        try {
          helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        } catch (e) {
          console.warn('Failed to parse helper from sessionStorage');
          return;
        }
        
        // Restore data based on step
        switch(step) {
          case 1:
            // Restore location selection
            restoreLocationData(helper);
            break;
            
          case 2:
            // Restore description data
            restoreDescriptionData(helper);
            break;
            
          case 3:
          case 4:
          case 5:
          case 6:
            // Module steps - data is handled by individual modules
            console.log(`âœ… Step ${step} - data restored by module`);
            break;
            
          case 7:
            // Summary step - update with current data
            updateSummary();
            break;
        }
        
      } catch (error) {
        console.error('âŒ Failed to restore step data:', error);
      }
    }
    
    function restoreLocationData(helper) {
      // âœ… FIXED: Check for active damage center first, then wizard temp
      let currentCenterData = null;
      
      // First check if we have an active damage center ID
      const activeCenterId = sessionStorage.getItem('active_damage_center_id');
      
      if (activeCenterId) {
        // Check in helper.centers array (where data is actually stored)
        if (helper.centers && Array.isArray(helper.centers)) {
          currentCenterData = helper.centers.find(c => c.Id === activeCenterId || c.id === activeCenterId);
        }
        
        // Also check helper.damage_centers for backward compatibility
        if (!currentCenterData && helper.damage_centers) {
          currentCenterData = helper.damage_centers.find(c => c.id === activeCenterId);
        }
      }
      
      // âœ… DAMAGE CENTERS FIX: Check multiple fallback locations  
      if (!currentCenterData) {
        currentCenterData = helper.current_damage_center || helper.wizard_temp?.current_damage_center;
      }
      
      if (!currentCenterData) {
        console.log('âŒ LOCATION NOT RESTORED - No center data found. Active ID:', activeCenterId);
        return;
      }
      
      const locationSelect = document.getElementById('locationSelect');
      const otherLocationInput = document.getElementById('otherLocationInput');
      
      // âœ… DAMAGE CENTERS FIX: Check both lowercase and uppercase property names
      const location = currentCenterData.location || currentCenterData.Location;
      
      if (location && locationSelect) {
        // Check if location is in standard options
        const option = Array.from(locationSelect.options).find(opt => opt.value === location);
        
        if (option) {
          locationSelect.value = location;
        } else {
          // Custom location
          locationSelect.value = 'other';
          if (otherLocationInput) {
            otherLocationInput.value = location;
            otherLocationInput.style.display = 'block';
          }
        }
        
        // Update location card selection
        document.querySelectorAll('.location-card').forEach(card => {
          card.classList.remove('selected');
          if (card.dataset.location === location) {
            card.classList.add('selected');
          }
        });
        
        console.log('âœ… LOCATION RESTORED:', location, 'from center:', currentCenterData.Id || currentCenterData.id);
      }
    }
    
    function restoreDescriptionData(helper) {
      // âœ… FIXED: Check for active damage center first, then wizard temp
      let currentCenterData = null;
      
      // First check if we have an active damage center ID
      const activeCenterId = sessionStorage.getItem('active_damage_center_id');
      
      if (activeCenterId) {
        // Check in helper.centers array (where data is actually stored)
        if (helper.centers && Array.isArray(helper.centers)) {
          currentCenterData = helper.centers.find(c => c.Id === activeCenterId || c.id === activeCenterId);
        }
        
        // Also check helper.damage_centers for backward compatibility
        if (!currentCenterData && helper.damage_centers) {
          currentCenterData = helper.damage_centers.find(c => c.id === activeCenterId);
        }
      }
      
      // âœ… DAMAGE CENTERS FIX: Check multiple fallback locations  
      if (!currentCenterData) {
        currentCenterData = helper.current_damage_center || helper.wizard_temp?.current_damage_center;
      }
      
      if (!currentCenterData) {
        console.log('âŒ DESCRIPTION NOT RESTORED - No center data found. Active ID:', activeCenterId);
        return;
      }
      
      const descriptionTextarea = document.getElementById('damageDescription');
      const repairNatureTextarea = document.getElementById('repairNature');
      
      // âœ… DAMAGE CENTERS FIX: Check both lowercase and uppercase property names
      const description = currentCenterData.description || currentCenterData.Description;
      const repairNature = currentCenterData.repairNature || currentCenterData.RepairNature;
      
      if (description && descriptionTextarea) {
        descriptionTextarea.value = description;
        console.log('âœ… DESCRIPTION RESTORED:', description, 'from center:', currentCenterData.Id || currentCenterData.id);
      } else {
        console.log('âŒ DESCRIPTION NOT RESTORED - description:', description, 'textarea:', !!descriptionTextarea, 'center:', currentCenterData?.Id || currentCenterData?.id);
      }
      
      if (repairNature && repairNatureTextarea) {
        repairNatureTextarea.value = repairNature;
        console.log('âœ… REPAIR NATURE RESTORED:', repairNature, 'from center:', currentCenterData.Id || currentCenterData.id);
      } else {
        console.log('âŒ REPAIR NATURE NOT RESTORED - repairNature:', repairNature, 'textarea:', !!repairNatureTextarea, 'center:', currentCenterData?.Id || currentCenterData?.id);
      }
    }
    
    function updateNavigation() {
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      
      // Show/hide previous button
      prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
      
      // Update next button text
      if (currentStep === totalSteps) {
        nextBtn.textContent = '×¡×™×™× ××•×§×“ × ×–×§';
        nextBtn.className = 'btn btn-success';
      } else {
        nextBtn.textContent = '×”×‘×';
        nextBtn.className = 'btn btn-primary';
      }
    }
    
    function updateProgress() {
      const progressFill = document.getElementById('progressFill');
      const percentage = (currentStep / totalSteps) * 100;
      progressFill.style.width = `${percentage}%`;
      
      // Update step info
      document.getElementById('stepInfo').textContent = `×©×œ×‘ ${currentStep} ××ª×•×š ${totalSteps}`;
      
      // Update navigation buttons
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      
      // Show/hide previous button
      if (currentStep === 1) {
        prevBtn.style.display = 'none';
      } else {
        prevBtn.style.display = 'inline-block';
      }
      
      // Hide next button in final step since we have action buttons in step 7
      if (currentStep === totalSteps) {
        nextBtn.style.display = 'none';
      } else {
        nextBtn.textContent = '×”×‘×';
        nextBtn.style.background = '#3b82f6'; // Default blue
        nextBtn.style.display = 'inline-block';
      }
    }
    
    function loadStepModule(step) {
      // âœ… ENHANCED: Loading states and error handling for module loading
      console.log(`ğŸ“¦ Loading module for step ${step}...`);
      
      try {
        switch(step) {
          case 3:
            showLoadingState('×˜×•×¢×Ÿ ××•×“×•×œ ×¢×‘×•×“×•×ª...', 'workModule');
            setTimeout(() => {
              try {
                loadWorkModule();
                hideLoadingState('workModule');
                showUserNotification('××•×“×•×œ ×¢×‘×•×“×•×ª × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”', 'success', 2000);
              } catch (error) {
                hideLoadingState('workModule');
                console.error('âŒ Failed to load work module:', error);
                showUserNotification('×©×’×™××” ×‘×˜×¢×™× ×ª ××•×“×•×œ ×¢×‘×•×“×•×ª', 'error');
              }
            }, 500);
            break;
            
          case 4:
            showLoadingState('×˜×•×¢×Ÿ ××•×“×•×œ ×—×™×¤×•×© ×—×œ×¤×™×...', 'partsSearchModule');
            setTimeout(() => {
              try {
                loadPartsSearchModule();
                hideLoadingState('partsSearchModule');
                showUserNotification('××•×“×•×œ ×—×™×¤×•×© ×—×œ×¤×™× × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”', 'success', 2000);
              } catch (error) {
                hideLoadingState('partsSearchModule');
                console.error('âŒ Failed to load parts search module:', error);
                showUserNotification('×©×’×™××” ×‘×˜×¢×™× ×ª ××•×“×•×œ ×—×™×¤×•×© ×—×œ×¤×™×', 'error');
              }
            }, 500);
            break;
            
          case 5:
            showLoadingState('×˜×•×¢×Ÿ ××•×“×•×œ ×‘×—×™×¨×ª ×—×œ×¤×™×...', 'partsModule');
            setTimeout(() => {
              try {
                loadPartsModule();
                hideLoadingState('partsModule');
                showUserNotification('××•×“×•×œ ×‘×—×™×¨×ª ×—×œ×¤×™× × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”', 'success', 2000);
              } catch (error) {
                hideLoadingState('partsModule');
                console.error('âŒ Failed to load parts module:', error);
                showUserNotification('×©×’×™××” ×‘×˜×¢×™× ×ª ××•×“×•×œ ×‘×—×™×¨×ª ×—×œ×¤×™×', 'error');
              }
            }, 500);
            break;
            
          case 6:
            showLoadingState('×˜×•×¢×Ÿ ××•×“×•×œ ×ª×™×§×•× ×™×...', 'repairsModule');
            setTimeout(() => {
              try {
                loadRepairsModule();
                hideLoadingState('repairsModule');
                showUserNotification('××•×“×•×œ ×ª×™×§×•× ×™× × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”', 'success', 2000);
              } catch (error) {
                hideLoadingState('repairsModule');
                console.error('âŒ Failed to load repairs module:', error);
                showUserNotification('×©×’×™××” ×‘×˜×¢×™× ×ª ××•×“×•×œ ×ª×™×§×•× ×™×', 'error');
              }
            }, 500);
            break;
            
          case 7:
            showLoadingState('××›×™×Ÿ ×¡×™×›×•×...', 'summaryStep');
            setTimeout(() => {
              try {
                updateSummary();
                hideLoadingState('summaryStep');
                showUserNotification('×¡×™×›×•× ××•×›×Ÿ ×œ×‘×“×™×§×”', 'info', 2000);
              } catch (error) {
                hideLoadingState('summaryStep');
                console.error('âŒ Failed to update summary:', error);
                showUserNotification('×©×’×™××” ×‘×™×¦×™×¨×ª ×”×¡×™×›×•×', 'error');
              }
            }, 500);
            break;
        }
      } catch (error) {
        console.error('âŒ Error loading step module:', error);
        showUserNotification(`×©×’×™××” ×‘×˜×¢×™× ×ª ××•×“×•×œ ×©×œ×‘ ${step}`, 'error');
      }
    }
    
    function loadPartsSearchModule() {
      const moduleContainer = document.getElementById('partsSearchModule');
      
      // âœ… CRITICAL: Set active damage center ID for webhook capture
      if (damageCenterData.id) {
        sessionStorage.setItem('active_damage_center_id', damageCenterData.id);
        console.log('ğŸ¯ Set active damage center ID for parts search webhook:', damageCenterData.id);
      }
      
      // Use existing parts search module with enhanced parameters
      const timestamp = new Date().getTime();
      moduleContainer.innerHTML = `<iframe src="parts search.html?wizard=true&step=4&t=${timestamp}" style="width:100%; height:600px; border:none; border-radius:10px;" id="partsSearchModuleFrame" onload="console.log('âœ… Parts search module iframe loaded');" onerror="console.error('âŒ Parts search module failed to load');"></iframe>`;
      moduleContainer.classList.add('loaded');
      
      // Show search results info
      document.getElementById('searchResultsInfo').style.display = 'block';
      
      // Set up enhanced communication with parts search module
      setupModuleCommunication('partsSearch');
      
      // Also send initial data immediately when iframe loads
      setTimeout(() => {
        const iframe = document.getElementById('partsSearchModuleFrame');
        if (iframe && iframe.contentWindow) {
          // Send ready signal to check if module is responsive
          iframe.contentWindow.postMessage({
            type: 'wizardReady',
            wizardStep: 4,
            source: 'damage-centers-wizard'
          }, '*');
        }
      }, 2000);
    }
    
    function validateCurrentStep() {
      console.log('ğŸ” === VALIDATION DEBUG ===');
      console.log('ğŸ” Validating step:', currentStep);
      
      // âœ… ENHANCED: Improved validation with better user feedback
      switch(currentStep) {
        case 1:
          console.log('ğŸ” Validating step 1 (location)...');
          const locationSelect = document.getElementById('locationSelect');
          const otherLocationInput = document.getElementById('otherLocationInput');
          
          console.log('ğŸ” locationSelect element:', !!locationSelect);
          console.log('ğŸ” locationSelect value:', locationSelect?.value);
          console.log('ğŸ” otherLocationInput element:', !!otherLocationInput);
          console.log('ğŸ” otherLocationInput value:', otherLocationInput?.value);
          
          if (!locationSelect || !locationSelect.value) {
            console.log('âŒ No location selected');
            showValidationError('locationSelect', '×× × ×‘×—×¨ ××™×§×•× × ×–×§ ××”×¨×©×™××”');
            return false;
          }
          
          if (locationSelect.value === 'other' && (!otherLocationInput || !otherLocationInput.value.trim())) {
            console.log('âŒ Other location selected but no custom input');
            showValidationError('otherLocationInput', '×× × ×”×–×Ÿ ××™×§×•× × ×–×§ ××•×ª×× ××™×©×™×ª');
            otherLocationInput?.focus();
            return false;
          }
          
          console.log('âœ… Step 1 validation passed');
          clearValidationError('locationSelect');
          clearValidationError('otherLocationInput');
          break;
          
        case 2:
          const description = document.getElementById('damageDescription');
          const descValue = description.value.trim();
          const repairNature = document.getElementById('repairNature');
          const repairValue = repairNature.value.trim();
          
          if (!descValue) {
            showValidationError('damageDescription', '×× × ×”×–×Ÿ ×ª×™××•×¨ ××¤×•×¨×˜ ×©×œ ×”× ×–×§');
            description.focus();
            return false;
          }
          
          if (descValue.length < 10) {
            showValidationError('damageDescription', '×ª×™××•×¨ ×”× ×–×§ ×—×™×™×‘ ×œ×”×›×™×œ ×œ×¤×—×•×ª 10 ×ª×•×•×™×');
            description.focus();
            return false;
          }
          
          if (!repairValue) {
            showValidationError('repairNature', '×× × ×”×–×Ÿ ×ª×™××•×¨ ××”×•×ª ×”×ª×™×§×•×Ÿ');
            repairNature.focus();
            return false;
          }
          
          if (repairValue.length < 5) {
            showValidationError('repairNature', '××”×•×ª ×”×ª×™×§×•×Ÿ ×—×™×™×‘ ×œ×”×›×™×œ ×œ×¤×—×•×ª 5 ×ª×•×•×™×');
            repairNature.focus();
            return false;
          }
          
          clearValidationError('damageDescription');
          clearValidationError('repairNature');
          break;
          
        case 3:
          // Validate work data
          if (!validateWorkData()) {
            return false;
          }
          break;
          
        case 5:
          // Validate parts data  
          if (!validatePartsData()) {
            return false;
          }
          break;
          
        case 6:
          // Validate repairs data
          if (!validateRepairsData()) {
            return false;
          }
          break;
      }
      return true;
    }
    
    function showValidationError(fieldId, message) {
      // Remove existing error messages
      clearValidationError(fieldId);
      
      const field = document.getElementById(fieldId);
      if (!field) return;
      
      // Add error styling to field
      field.style.borderColor = '#ef4444';
      field.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
      
      // Create error message element
      const errorDiv = document.createElement('div');
      errorDiv.className = 'validation-error';
      errorDiv.id = `error-${fieldId}`;
      errorDiv.style.cssText = `
        color: #ef4444;
        font-size: 14px;
        margin-top: 5px;
        padding: 8px 12px;
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 6px;
        display: flex;
        align-items: center;
        gap: 8px;
      `;
      errorDiv.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
        </svg>
        ${message}
      `;
      
      // Insert error message after the field
      field.parentNode.insertBefore(errorDiv, field.nextSibling);
      
      console.log(`âš ï¸ Validation error: ${message} (field: ${fieldId})`);
    }
    
    function clearValidationError(fieldId) {
      const field = document.getElementById(fieldId);
      if (field) {
        // Reset field styling
        field.style.borderColor = '';
        field.style.boxShadow = '';
      }
      
      // Remove error message
      const errorDiv = document.getElementById(`error-${fieldId}`);
      if (errorDiv) {
        errorDiv.remove();
      }
    }
    
    function validateWorkData() {
      const takana = document.getElementById('takana389Work')?.value;
      const workRows = document.querySelectorAll('.work-row');
      
      // âœ… FIX: Remove required validation for ×ª×§× ×” 389 field
      // if (!takana) {
      //   showUserNotification('×× × ×‘×—×¨ ×”×× ×ª×§× ×” 389 ×—×œ×”', 'warning');
      //   return false;
      // }
      
      // âœ… REMOVED: No longer require at least one work - allow 0 works
      // Allow proceeding with 0 works - user can create damage center with only parts/repairs
      
      // Only validate existing work rows for data completeness (if any exist)
      let hasIncompleteWork = false;
      workRows.forEach(row => {
        const type = row.querySelector('.work-type')?.value;
        const cost = parseFloat(row.querySelector('.work-cost')?.value) || 0;
        // If user started filling work but didn't complete it
        if ((type && cost === 0) || (!type && cost > 0)) {
          hasIncompleteWork = true;
        }
      });
      
      if (hasIncompleteWork) {
        showUserNotification('×× × ×”×©×œ× ××ª ×¤×¨×˜×™ ×”×¢×‘×•×“×•×ª ×©×”×ª×—×œ×ª ××• ×”×¡×¨ ××•×ª×Ÿ', 'warning');
        return false;
      }
      
      return true;
    }
    
    function validatePartsData() {
      // Check if user has interacted with parts search/selection
      if (moduleData.parts.length === 0) {
        const confirm = window.confirm('×œ× × ×‘×—×¨×• ×—×œ×¤×™×. ×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”××©×™×š ×‘×œ×™ ×—×œ×¤×™×?');
        return confirm;
      }
      return true;
    }
    
    function validateRepairsData() {
      const repairRows = document.querySelectorAll('.repair-row');
      
      // âœ… REMOVED: No longer require at least one repair - allow 0 repairs
      // Allow proceeding with 0 repairs - user can create damage center with only works/parts
      
      // Only validate existing repair rows for data completeness (if any exist)
      let hasIncompleteRepair = false;
      repairRows.forEach(row => {
        const name = row.querySelector('.repair-name')?.value.trim();
        const cost = parseFloat(row.querySelector('.repair-cost')?.value) || 0;
        const desc = row.querySelector('.repair-desc')?.value.trim();
        
        // If user started filling repair but didn't complete all required fields
        const hasAnyData = name || cost > 0 || desc;
        const isComplete = name && cost > 0 && desc;
        
        if (hasAnyData && !isComplete) {
          hasIncompleteRepair = true;
        }
      });
      
      if (hasIncompleteRepair) {
        showUserNotification('×× × ×”×©×œ× ××ª ×¤×¨×˜×™ ×”×ª×™×§×•× ×™× ×©×”×ª×—×œ×ª ××• ×”×¡×¨ ××•×ª×', 'warning');
        return false;
      }
      
      return true;
    }
    
    // âœ… NEW: Enhanced user notification system
    function showUserNotification(message, type = 'info', duration = 5000) {
      // Remove existing notifications
      const existingNotifications = document.querySelectorAll('.user-notification');
      existingNotifications.forEach(notification => notification.remove());
      
      // Create notification element
      const notification = document.createElement('div');
      notification.className = 'user-notification';
      
      // Set styling based on type
      const styles = {
        info: {
          background: '#dbeafe',
          border: '#3b82f6',
          color: '#1e40af',
          icon: `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z"/>
          </svg>`
        },
        success: {
          background: '#dcfce7',
          border: '#22c55e',
          color: '#15803d',
          icon: `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z"/>
          </svg>`
        },
        warning: {
          background: '#fef3c7',
          border: '#f59e0b',
          color: '#92400e',
          icon: `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12,2L13.09,8.26L22,9L13.09,9.74L12,16L10.91,9.74L2,9L10.91,8.26L12,2Z"/>
          </svg>`
        },
        error: {
          background: '#fee2e2',
          border: '#ef4444',
          color: '#dc2626',
          icon: `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z"/>
          </svg>`
        }
      };
      
      const style = styles[type] || styles.info;
      
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        padding: 16px 20px;
        background: ${style.background};
        border: 2px solid ${style.border};
        border-radius: 12px;
        color: ${style.color};
        font-size: 16px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 12px;
        max-width: 400px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        animation: slideInRight 0.3s ease-out;
        direction: rtl;
      `;
      
      notification.innerHTML = `
        ${style.icon}
        <span style="flex: 1;">${message}</span>
        <button onclick="this.parentElement.remove()" style="
          background: none;
          border: none;
          color: currentColor;
          font-size: 20px;
          cursor: pointer;
          padding: 0;
          margin: 0 0 0 8px;
          opacity: 0.6;
        ">Ã—</button>
      `;
      
      // Add CSS animation if not already present
      if (!document.getElementById('notification-styles')) {
        const styleSheet = document.createElement('style');
        styleSheet.id = 'notification-styles';
        styleSheet.textContent = `
          @keyframes slideInRight {
            from {
              transform: translateX(100%);
              opacity: 0;
            }
            to {
              transform: translateX(0);
              opacity: 1;
            }
          }
          
          @keyframes slideOutRight {
            from {
              transform: translateX(0);
              opacity: 1;
            }
            to {
              transform: translateX(100%);
              opacity: 0;
            }
          }
        `;
        document.head.appendChild(styleSheet);
      }
      
      // Add to page
      document.body.appendChild(notification);
      
      // Auto-remove after duration
      if (duration > 0) {
        setTimeout(() => {
          if (notification.parentElement) {
            notification.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
          }
        }, duration);
      }
      
      console.log(`ğŸ“¢ User notification (${type}): ${message}`);
    }
    
    // âœ… NEW: Enhanced loading state management
    function showLoadingState(message = '×˜×•×¢×Ÿ...', elementId = null) {
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'loading-state';
      loadingDiv.id = elementId ? `loading-${elementId}` : 'loading-overlay';
      
      loadingDiv.style.cssText = `
        position: ${elementId ? 'absolute' : 'fixed'};
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        backdrop-filter: blur(2px);
      `;
      
      loadingDiv.innerHTML = `
        <div style="
          width: 48px;
          height: 48px;
          border: 4px solid #e5e7eb;
          border-top: 4px solid #3b82f6;
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin-bottom: 16px;
        "></div>
        <div style="
          color: #6b7280;
          font-size: 16px;
          font-weight: 500;
        ">${message}</div>
      `;
      
      // Add spin animation if not already present
      if (!document.getElementById('loading-styles')) {
        const styleSheet = document.createElement('style');
        styleSheet.id = 'loading-styles';
        styleSheet.textContent = `
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        `;
        document.head.appendChild(styleSheet);
      }
      
      if (elementId) {
        const target = document.getElementById(elementId);
        if (target) {
          target.style.position = 'relative';
          target.appendChild(loadingDiv);
        }
      } else {
        document.body.appendChild(loadingDiv);
      }
      
      console.log(`â³ Loading state shown: ${message}`);
      return loadingDiv;
    }
    
    function hideLoadingState(elementId = null) {
      const loadingId = elementId ? `loading-${elementId}` : 'loading-overlay';
      const loadingDiv = document.getElementById(loadingId);
      if (loadingDiv) {
        loadingDiv.remove();
        console.log(`âœ… Loading state hidden: ${elementId || 'global'}`);
      }
    }
    
    function saveCurrentStepData() {
      console.log('ğŸ’¾ Saving step data for step:', currentStep);
      
      // Get current helper data
      let helper = {};
      try {
        helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      } catch (e) {
        helper = {};
      }
      
      // âœ… REMOVED: No more wizard_temp - using current_damage_center directly per documentation
      
      switch(currentStep) {
        case 1:
          // Save location to current_damage_center per documentation
          const locationSelect = document.getElementById('locationSelect');
          const otherLocationInput = document.getElementById('otherLocationInput');
          let location = locationSelect?.value || '××™×§×•× ×œ× ×¦×•×™×Ÿ';
          
          // Handle "other" location properly
          if (location === 'other' || location === '××—×¨') {
            location = otherLocationInput?.value?.trim() || '××™×§×•× ××—×¨ ×œ× ×¦×•×™×Ÿ';
          }
          
          // Get next damage center number based on existing centers
          const existingCenters = getDamageCentersFromHelper();
          const nextNumber = existingCenters.length + 1;
          
          // âœ… FIXED: Initialize or update current_damage_center while preserving existing data
          const centerId = helper.current_damage_center?.Id || `dc_${Date.now()}_${nextNumber}`;
          const existingDescription = helper.current_damage_center?.Description || "";
          const existingRepairNature = helper.current_damage_center?.RepairNature || "";
          
          helper.current_damage_center = {
            "Id": centerId,
            "Damage center Number": nextNumber.toString(),
            "Location": location,
            "Description": existingDescription, // Preserve existing description
            "RepairNature": existingRepairNature, // Preserve existing repair nature
            "Works": helper.current_damage_center?.Works || {
              "takana389": "",
              "works": [],
              "works_meta": {
                "total_items": 0,
                "total_cost": 0,
                "takana389_status": "",
                "timestamp": new Date().toISOString()
              }
            },
            "Parts": helper.current_damage_center?.Parts || {
              "parts_meta": {
                "total_items": 0,
                "total_cost": 0,
                "timestamp": new Date().toISOString()
              },
              "parts_required": [],
              "parts_search": {
                "results": [],
                "search_meta": {
                  "total_results": 0,
                  "timestamp": new Date().toISOString(),
                  "search_session": `search_${Date.now()}`
                }
              },
              "takana389": ""
            },
            "Repairs": helper.current_damage_center?.Repairs || {
              "repairs": [],
              "repairs_meta": {
                "total_items": 0,
                "total_cost": 0,
                "timestamp": new Date().toISOString()
              }
            },
            "Summary": helper.current_damage_center?.Summary || {
              "Total works": 0,
              "Total parts": 0,
              "Total repairs": 0,
              "Total without VAT": 0,
              "Total with VAT": 0
            }
          };
          // Update tracking variables
          damageCenterData.id = centerId;
          damageCenterData.number = nextNumber;
          damageCenterData.location = location;
          moduleData.location = location;
          
          console.log('âœ… Current damage center initialized:', {
            id: centerId,
            number: nextNumber,
            location: location
          });
          
          showUserNotification(`××•×§×“ × ×–×§ ${nextNumber} × ×•×¦×¨ ×‘×”×¦×œ×—×”!`, 'success', 2000);
          
          console.log('âœ… Step 1 - Damage center created and saved to helper:', location);
          break;
          
        case 2:
          // âœ… FIXED: Save description and repair nature to current_damage_center per documentation
          const damageDescriptionInput = document.getElementById('damageDescription');
          const description = damageDescriptionInput?.value?.trim() || '×ª×™××•×¨ ×œ× ×¦×•×™×Ÿ';
          
          const repairNatureInput = document.getElementById('repairNature');
          const repairNature = repairNatureInput?.value?.trim() || '';
          
          console.log('ğŸ” === STEP 2 DESCRIPTION & REPAIR NATURE SAVE ===');
          console.log('ğŸ” Description value:', description);
          console.log('ğŸ” Repair Nature value:', repairNature);
          
          // Save to current_damage_center.Description and RepairNature
          if (helper.current_damage_center) {
            helper.current_damage_center.Description = description;
            helper.current_damage_center.RepairNature = repairNature;
            
            // Update tracking variables
            damageCenterData.description = description;
            damageCenterData.repairNature = repairNature;
            moduleData.description = description;
            moduleData.repairNature = repairNature;
            
            console.log('âœ… Description saved to current_damage_center.Description:', description);
            console.log('âœ… Repair Nature saved to current_damage_center.RepairNature:', repairNature);
            showUserNotification(`×ª×™××•×¨ × ×–×§ ×•××”×•×ª ×”×ª×™×§×•×Ÿ × ×•×¡×¤×• ×œ××•×§×“ ${damageCenterData.number}`, 'success', 2000);
          } else {
            console.error('âŒ current_damage_center not found!');
            showUserNotification('×©×’×™××” ×‘×©××™×¨×ª ×ª×™××•×¨ ×•××”×•×ª ×”×ª×™×§×•×Ÿ', 'error', 2000);
          }
          
          console.log('âœ… Step 2 - Description and Repair Nature saved to current_damage_center');
          break;
          
        case 3:
          // Save works data to current_damage_center per documentation
          const takana389 = document.getElementById('takana389Work')?.value || '';
          const worksData = moduleData.works || [];
          
          if (helper.current_damage_center) {
            helper.current_damage_center.Works.takana389 = takana389;
            helper.current_damage_center.Works.works = worksData.map(work => ({
              category: work.category || '',
              cost: parseFloat(work.cost) || 0,
              comments: work.comments || '',
              added_at: new Date().toISOString(),
              source: 'wizard_inline_component'
            }));
            helper.current_damage_center.Works.works_meta = {
              total_items: worksData.length,
              total_cost: worksData.reduce((sum, work) => sum + (parseFloat(work.cost) || 0), 0),
              takana389_status: takana389,
              timestamp: new Date().toISOString()
            };
            
            console.log('âœ… Step 3 - Works data saved to current_damage_center.Works');
            showUserNotification(`×¢×‘×•×“×•×ª × ×“×¨×©×•×ª × ×•×¡×¤×• ×œ××•×§×“ ${damageCenterData.number}`, 'success', 2000);
          }
          break;
          
        case 4:
          // Save parts search data to current_damage_center
          const searchResults = moduleData.searchResults || [];
          
          if (helper.current_damage_center) {
            helper.current_damage_center.Parts.parts_search = {
              results: searchResults,
              search_meta: {
                total_results: searchResults.length,
                timestamp: new Date().toISOString(),
                search_session: `search_${Date.now()}`
              }
            };
            
            console.log('âœ… Step 4 - Parts search data saved to current_damage_center.Parts');
            showUserNotification(`×—×™×¤×•×© ×—×œ×§×™× × ×•×¡×£ ×œ××•×§×“ ${damageCenterData.number}`, 'success', 2000);
          }
          break;
          
        case 5:
          // Save parts required data to current_damage_center
          const partsData = moduleData.parts || [];
          
          if (helper.current_damage_center) {
            helper.current_damage_center.Parts.parts_required = partsData.map(part => ({
              name: part.name || part.part || '',
              ×ª×™××•×¨: part.description || part.×ª×™××•×¨ || '',
              ×›××•×ª: parseInt(part.quantity || part.×›××•×ª) || 1,
              ××—×™×¨: part.price ? `â‚ª${part.price}` : 'â‚ª0',
              price: parseFloat(part.price) || 0,
              quantity: parseInt(part.quantity || part.×›××•×ª) || 1,
              source: part.source || 'manual',
              '×¡×•×’ ×—×œ×§': part.source || '×—×œ×™×¤×™/××§×•×¨×™',
              ×¡×¤×§: part.supplier || '',
              '××¡×¤×¨ OEM': part.part_number || '',
              ××™×§×•×: part.location || '×™×©×¨××œ',
              ×”×¢×¨×•×ª: part.notes || '',
              ×–××™× ×•×ª: part.availability || '×–××™×Ÿ'
            }));
            helper.current_damage_center.Parts.parts_meta = {
              total_items: partsData.length,
              total_cost: partsData.reduce((sum, part) => sum + (parseFloat(part.price) || 0), 0),
              timestamp: new Date().toISOString()
            };
            
            console.log('âœ… Step 5 - Parts required data saved to current_damage_center.Parts');
            showUserNotification(`×—×œ×§×™× × ×“×¨×©×™× × ×•×¡×¤×• ×œ××•×§×“ ${damageCenterData.number}`, 'success', 2000);
          }
          break;
          
        case 6:
          // Save repairs data to current_damage_center
          const repairsData = moduleData.repairs || [];
          
          if (helper.current_damage_center) {
            // âœ… FIXED: Initialize Repairs structure if missing
            if (!helper.current_damage_center.Repairs) {
              helper.current_damage_center.Repairs = {
                "repairs": [],
                "repairs_meta": {
                  "total_items": 0,
                  "total_cost": 0,
                  "timestamp": new Date().toISOString()
                }
              };
            }
            
            helper.current_damage_center.Repairs.repairs = repairsData.map(repair => ({
              name: repair.name || '',
              cost: parseFloat(repair.cost) || 0,
              description: repair.description || '',
              added_at: new Date().toISOString(),
              source: 'wizard_inline_component'
            }));
            helper.current_damage_center.Repairs.repairs_meta = {
              total_items: repairsData.length,
              total_cost: repairsData.reduce((sum, repair) => sum + (parseFloat(repair.cost) || 0), 0),
              timestamp: new Date().toISOString()
            };
            
            console.log('âœ… Step 6 - Repairs data saved to current_damage_center.Repairs');
            showUserNotification(`×ª×™×§×•× ×™× × ×•×¡×¤×• ×œ××•×§×“ ${damageCenterData.number}`, 'success', 2000);
          }
          break;
          
        case 7:
          // âœ… FINAL STEP - Move current_damage_center to centers array
          console.log('ğŸ Step 7 - Moving current_damage_center to centers array...');
          
          if (helper.current_damage_center && helper.current_damage_center.Id) {
            // Update the Summary with current totals
            const worksTotal = helper.current_damage_center.Works?.works_meta?.total_cost || 0;
            const partsTotal = helper.current_damage_center.Parts?.parts_meta?.total_cost || 0;
            const repairsTotal = helper.current_damage_center.Repairs?.repairs_meta?.total_cost || 0;
            const subtotal = worksTotal + partsTotal + repairsTotal;
            const vatAmount = subtotal * (vatPercentage / 100);
            const totalWithVat = subtotal + vatAmount;
            
            helper.current_damage_center.Summary = {
              "Total works": worksTotal,
              "Total parts": partsTotal,
              "Total repairs": repairsTotal,
              "Total without VAT": subtotal,
              "Total with VAT": totalWithVat
            };
            
            // Move to centers array
            if (!helper.centers) {
              helper.centers = [];
            }
            
            helper.centers.push(helper.current_damage_center);
            
            console.log('âœ… Damage center moved to centers array:', {
              id: helper.current_damage_center.Id,
              number: helper.current_damage_center["Damage center Number"],
              location: helper.current_damage_center.Location,
              description: helper.current_damage_center.Description
            });
            
            // âœ… NEW: Update damage assessment with proper structure per documentation
            updateDamageAssessment(helper);
            
            // Clear current_damage_center for next use
            helper.current_damage_center = {};
            
            showUserNotification(`××•×§×“ × ×–×§ ${damageCenterData.number} × ×©××¨ ×‘×”×¦×œ×—×”!`, 'success', 3000);
            
            // âœ… PERFORMANCE FIX: Auto-refresh to prevent wizard from becoming heavy
            setTimeout(() => {
              showUserNotification('××¨×¢× ×Ÿ ×“×£ ×œ×©×™×¤×•×¨ ×‘×™×¦×•×¢×™×...', 'info', 1000);
              location.reload();
            }, 2000);
            
          } else {
            console.error('âŒ No current_damage_center to save!');
            showUserNotification('×©×’×™××” ×‘×©××™×¨×ª ××•×§×“ ×”× ×–×§', 'error', 3000);
          }
          break;
      }
      
      // âœ… CRITICAL: Save to both session storage AND sync window.helper
      console.log('ğŸ”„ Saving step data to session storage and syncing window.helper...');
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      // âœ… FIXED: Also sync to window.helper for API functions
      if (typeof window !== 'undefined') {
        window.helper = helper;
        console.log('âœ… Synced to window.helper, damage_centers count:', window.helper.damage_centers?.length || 0);
      }
      window.helper = helper; // âœ… CRITICAL: Sync window.helper
      console.log('âœ… Step data saved and window.helper synced for step:', currentStep);
    }
    
    // âœ… CONVERTED: Inline work component (no more iframe needed)
    function loadWorkModule() {
      const moduleContainer = document.getElementById('workModule');
      
      // Create inline work component HTML
      moduleContainer.innerHTML = `
        <div class="work-component" style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #e5e7eb;">
          <div style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: bold;">
            ğŸ”§ ×¢×‘×•×“×•×ª × ×“×¨×©×•×ª - ××•×§×“ × ×–×§ ${damageCenterData.number || '×—×“×©'}
          </div>
          
          <div style="margin-bottom: 20px;">
            <label for="takana389Work" style="display: block; font-weight: bold; color: #374151; margin-bottom: 8px;">
              <strong>×”×× ×ª×§× ×” 389 ×—×œ×”?</strong>
            </label>
            <select id="takana389Work" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;" onchange="updateWorkData()">
              <option value="">×‘×—×¨</option>
              <option value="×›×Ÿ">×›×Ÿ</option>
              <option value="×œ×">×œ×</option>
              <option value="×œ× ×¨×œ×•×•× ×˜×™">×œ× ×¨×œ×•×•× ×˜×™</option>
            </select>
          </div>

          <div id="worksList" style="margin-bottom: 20px;"></div>

          <button type="button" onclick="addWorkRow()" style="
            width: 100%; 
            padding: 12px; 
            background: #10b981; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer;
            margin-bottom: 20px;
          ">
            â• ×”×•×¡×£ ×¢×‘×•×“×”
          </button>
          
          <div id="workTotalDisplay" style="
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            display: none;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
          ">
            <div style="font-size: 18px; color: #059669; margin-bottom: 10px; font-weight: 600;">×¡×™×›×•× ×¢×‘×•×“×•×ª</div>
            <div style="font-size: 32px; font-weight: bold; color: #047857; margin-bottom: 8px;" id="workTotalAmount">â‚ª0</div>
            <div style="font-size: 14px; color: #065f46; opacity: 0.8;" id="workVatBreakdown">×œ×œ× ××¢"× | ×›×•×œ×œ ××¢"×</div>
          </div>
        </div>
      `;
      
      moduleContainer.classList.add('loaded');
      
      // Initialize work component
      initializeWorkComponent();
      
      // âœ… FIXED: Add automatic calculation triggers for work component
      setTimeout(() => {
        const workContainer = document.getElementById('workContainer');
        if (workContainer) {
          workContainer.addEventListener('change', updateWorkData);
          workContainer.addEventListener('input', updateWorkData);
          console.log('ğŸ“Š Added automatic calculation triggers for work component');
        }
      }, 100);
      
      // Show subtotal
      document.getElementById('workSubtotal').style.display = 'block';
      
      console.log('âœ… Work component loaded inline (no iframe)');
    }
    
    // âœ… NEW: Initialize work component
    function initializeWorkComponent() {
      // Work options array
      window.workOptions = [
        "×›×œ ×¢×‘×•×“×•×ª ×”×¤×—×—×•×ª ×›×•×œ×œ ×¤×™×¨×•×§×™× ×•×”×¨×›×‘×•×ª",
        "×¢×‘×•×“×•×ª ×¦×‘×¢",
        "×¢×‘×•×“×•×ª ×—×©××œ", 
        "×¢×‘×•×“×•×ª ××›×•× ××•×ª",
        "×¢×‘×•×“×•×ª ××–×’×Ÿ",
        "×¢×‘×•×“×•×ª ×¨×™×¤×•×“",
        "×¢×‘×•×“×•×ª ×–×’×’×•×ª",
        "××™×˜×•× ×•×–×™×¤×•×ª",
        "×‘×“×™×§×ª ××ª×œ×”",
        "×›×™×•×œ ×¨×“××¨",
        "×”×¢×‘×¨×ª ×—×™×™×©× ×™×",
        "××—×¨"
      ];
      
      // Pre-load existing work data if any
      if (moduleData.works && moduleData.works.length > 0) {
        moduleData.works.forEach(work => {
          addWorkRowWithData(work);
        });
        updateWorkData();
      } else {
        // Add initial empty row
        addWorkRow();
      }
    }
    
    // âœ… NEW: Add work row function  
    window.addWorkRow = function(workData = null) {
      const worksList = document.getElementById('worksList');
      const row = document.createElement('div');
      row.className = 'work-row';
      // âœ… FIXED: Use responsive layout instead of fixed grid
      row.style.cssText = `
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 15px;
        padding: 15px;
        background: #f9fafb;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      `;
      
      const workTypeValue = workData ? workData.category : '';
      const workCostValue = workData ? workData.cost : '';
      const workCommentsValue = workData ? workData.comments : '';
      
      // âœ… ENHANCED: Mobile-optimized work row with better labels and accessibility
      row.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <label style="font-weight: 600; color: #374151; font-size: 14px;">×¡×•×’ ×¢×‘×•×“×” *</label>
          <select class="work-type" onchange="updateWorkData()" oninput="updateWorkData()" style="
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e5e7eb; 
            border-radius: 8px; 
            font-size: 16px;
            background: #ffffff;
            box-sizing: border-box;
          ">
            <option value="">×‘×—×¨ ×¡×•×’ ×¢×‘×•×“×”</option>
            ${window.workOptions.map(opt => `<option value="${opt}" ${opt === workTypeValue ? 'selected' : ''}>${opt}</option>`).join('')}
          </select>
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <label style="font-weight: 600; color: #374151; font-size: 14px;">×¢×œ×•×ª ××©×•×¢×¨×ª *</label>
          <input type="number" class="work-cost" placeholder="0" value="${workCostValue}" onchange="updateWorkData()" oninput="updateWorkData()" style="
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e5e7eb; 
            border-radius: 8px; 
            font-size: 16px;
            background: #ffffff;
            box-sizing: border-box;
          ">
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <label style="font-weight: 600; color: #374151; font-size: 14px;">×”×¢×¨×•×ª ×•×”×‘×”×¨×•×ª</label>
          <textarea class="work-comments" placeholder="×¤×¨×˜×™× × ×•×¡×¤×™× ×¢×œ ×”×¢×‘×•×“×”..." onchange="updateWorkData()" oninput="updateWorkData()" style="
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e5e7eb; 
            border-radius: 8px; 
            resize: vertical; 
            font-family: inherit;
            min-height: 80px;
            font-size: 16px;
            background: #ffffff;
            box-sizing: border-box;
          ">${workCommentsValue}</textarea>
        </div>
        
        <button type="button" onclick="removeWorkRow(this)" style="
          background: #dc2626; 
          color: white; 
          border: none; 
          border-radius: 8px; 
          cursor: pointer;
          padding: 12px;
          font-size: 14px;
          font-weight: 600;
          min-height: 48px;
          touch-action: manipulation;
        ">ğŸ—‘ï¸ ×”×¡×¨ ×¢×‘×•×“×” ×–×•</button>
      `;
      
      worksList.appendChild(row);
      
      // âœ… DAMAGE CENTERS FIX: Add additional event listeners for better responsiveness
      const workType = row.querySelector('.work-type');
      const workCost = row.querySelector('.work-cost');
      const workComments = row.querySelector('.work-comments');
      
      if (workType) {
        workType.addEventListener('change', updateWorkData);
        workType.addEventListener('input', updateWorkData);
      }
      if (workCost) {
        workCost.addEventListener('change', updateWorkData);
        workCost.addEventListener('input', updateWorkData);
        workCost.addEventListener('keyup', updateWorkData);
      }
      if (workComments) {
        workComments.addEventListener('change', updateWorkData);
        workComments.addEventListener('input', updateWorkData);
      }
      
      updateWorkData();
    };
    
    // âœ… NEW: Add work row with existing data
    function addWorkRowWithData(workData) {
      addWorkRow(workData);
    }
    
    // âœ… NEW: Remove work row
    window.removeWorkRow = function(button) {
      button.closest('.work-row').remove();
      updateWorkData();
    };
    
    // âœ… NEW: Update work data and send to wizard
    window.updateWorkData = function() {
      const workRows = document.querySelectorAll('.work-row');
      const works = [];
      let total = 0;
      
      workRows.forEach((row, index) => {
        const typeElement = row.querySelector('.work-type');
        const costElement = row.querySelector('.work-cost');
        const commentsElement = row.querySelector('.work-comments');
        
        const type = typeElement ? typeElement.value : '';
        const cost = costElement ? (parseFloat(costElement.value) || 0) : 0;
        const comments = commentsElement ? commentsElement.value.trim() : '';
        
        if (type || cost > 0) {
          works.push({
            category: type,
            cost: cost,
            comments: comments,
            added_at: new Date().toISOString(),
            source: 'wizard_inline_component'
          });
          total += cost;
        }
      });
      
      // Update module data
      moduleData.works = works;
      moduleData.takana389 = document.getElementById('takana389Work')?.value || '';
      
      // âœ… FIXED: Update both internal display and wizard subtotal consistently
      const totalDisplay = document.getElementById('workTotalDisplay');
      const totalAmount = document.getElementById('workTotalAmount');
      
      if (totalDisplay && totalAmount) {
        if (total > 0) {
          const vatAmount = total * (vatPercentage / 100);
          const totalWithVat = total + vatAmount;
          
          // âœ… ENHANCED: Rich display like parts module
          totalAmount.textContent = `â‚ª${totalWithVat.toLocaleString()}`;
          
          const vatBreakdown = document.getElementById('workVatBreakdown');
          if (vatBreakdown) {
            vatBreakdown.textContent = `×œ×œ× ××¢"×: â‚ª${total.toLocaleString()} | ×›×•×œ×œ ××¢"×: â‚ª${totalWithVat.toLocaleString()}`;
          }
          
          totalDisplay.style.display = 'block';
        } else {
          totalDisplay.style.display = 'none';
        }
      }
      
      // Update wizard subtotal and recalculate main totals
      updateWorkSubtotal(total);
      calculateTotals();
    };
    
    // Update repair nature in real-time
    window.updateRepairNature = function() {
      const repairNatureElement = document.getElementById('repairNature');
      if (!repairNatureElement) return;
      
      const repairNatureValue = repairNatureElement.value.trim();
      
      // Save to current_damage_center
      if (helper.current_damage_center) {
        helper.current_damage_center.RepairNature = repairNatureValue;
        
        // Save to sessionStorage
        sessionStorage.setItem('helper', JSON.stringify(helper));
        window.helper = helper;
        
        console.log('ğŸ’¾ Repair nature saved to current_damage_center:', repairNatureValue);
      }
    };
    
    function loadPartsModule() {
      const moduleContainer = document.getElementById('partsModule');
      
      // âœ… CRITICAL: Set active damage center ID for webhook capture
      if (damageCenterData.id) {
        sessionStorage.setItem('active_damage_center_id', damageCenterData.id);
        console.log('ğŸ¯ Set active damage center ID for parts search:', damageCenterData.id);
      }
      
      // Use existing parts-required.html module
      moduleContainer.innerHTML = `<iframe src="parts-required.html" style="width:100%; height:600px; border:none; border-radius:10px;" id="partsModuleFrame"></iframe>`;
      moduleContainer.classList.add('loaded');
      
      // Show subtotal
      document.getElementById('partsSubtotal').style.display = 'block';
      
      // Set up communication with parts module
      setupModuleCommunication('parts');
    }
    
    // âœ… CONVERTED: Inline repairs component (no more iframe needed)  
    function loadRepairsModule() {
      const moduleContainer = document.getElementById('repairsModule');
      
      // Create inline repairs component HTML
      moduleContainer.innerHTML = `
        <div class="repairs-component" style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #e5e7eb;">
          <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: bold;">
            ğŸ”¨ ×ª×™×§×•× ×™× × ×“×¨×©×™× - ××•×§×“ × ×–×§ ${damageCenterData.number || '×—×“×©'}
          </div>
          
          <div style="background: #fef2f2; border: 1px solid #fca5a5; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <div style="color: #dc2626; font-weight: bold; font-size: 14px;">
              ğŸ’¡ ×”×¢×¨×” ×—×©×•×‘×”: ×¨×©×•× ×›××Ÿ ×ª×™×§×•× ×™× × ×“×¨×©×™× ×©××™× × ×—×œ×¤×™× ××• ×¢×‘×•×“×•×ª - ×œ××©×œ: ×™×™×©×•×¨, ×”×œ×—××”, ×ª×™×§×•×Ÿ ×¤×’×™×¢×•×ª ×§×œ×•×ª
            </div>
          </div>
          
          <div id="repairsList" style="margin-bottom: 20px;"></div>

          <button type="button" onclick="addRepairRow()" style="
            width: 100%; 
            padding: 12px; 
            background: #ef4444; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer;
            margin-bottom: 10px;
          ">
            â• ×”×•×¡×£ ×ª×™×§×•×Ÿ
          </button>
          
          <div id="repairTotalDisplay" style="
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            border: 1px solid #ef4444;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            display: none;
          ">
            <div style="font-size: 16px; color: #dc2626; margin-bottom: 5px;">×¡×”×´×› ×ª×™×§×•× ×™×</div>
            <div style="font-size: 24px; font-weight: bold; color: #b91c1c;" id="repairTotalAmount">â‚ª0</div>
          </div>
        </div>
      `;
      
      moduleContainer.classList.add('loaded');
      
      // Initialize repairs component
      initializeRepairsComponent();
      
      // âœ… FIXED: Add automatic calculation triggers for repairs component
      setTimeout(() => {
        const repairContainer = document.getElementById('repairContainer');
        if (repairContainer) {
          repairContainer.addEventListener('change', updateRepairsData);
          repairContainer.addEventListener('input', updateRepairsData);
          console.log('ğŸ“Š Added automatic calculation triggers for repairs component');
        }
      }, 100);
      
      // Show subtotal
      document.getElementById('repairsSubtotal').style.display = 'block';
      
      console.log('âœ… Repairs component loaded inline (no iframe)');
    }
    
    // âœ… NEW: Initialize repairs component
    function initializeRepairsComponent() {
      // Pre-load existing repair data if any
      if (moduleData.repairs && moduleData.repairs.length > 0) {
        moduleData.repairs.forEach(repair => {
          addRepairRowWithData(repair);
        });
        updateRepairData();
      } else {
        // Add initial empty row
        addRepairRow();
      }
    }
    
    // âœ… NEW: Add repair row function
    window.addRepairRow = function(repairData = null) {
      const repairsList = document.getElementById('repairsList');
      const row = document.createElement('div');
      row.className = 'repair-row';
      // âœ… FIXED: Use responsive layout instead of fixed grid
      row.style.cssText = `
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 15px;
        padding: 15px;
        background: #f9fafb;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      `;
      
      const repairName = repairData ? repairData.name : '';
      const repairCost = repairData ? repairData.cost : '';
      const repairDesc = repairData ? repairData.description : '';
      
      // âœ… ENHANCED: Mobile-optimized repair row with better labels and accessibility
      row.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <label style="font-weight: 600; color: #374151; font-size: 14px;">×©× ×”×ª×™×§×•×Ÿ *</label>
          <input type="text" class="repair-name" placeholder="×œ××©×œ: ×”×—×œ×¤×ª ×¤× ×¡ ×§×“××™" value="${repairName}" onchange="updateRepairData()" style="
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e5e7eb; 
            border-radius: 8px; 
            font-size: 16px;
            background: #ffffff;
            box-sizing: border-box;
          ">
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <label style="font-weight: 600; color: #374151; font-size: 14px;">×¢×œ×•×ª ××©×•×¢×¨×ª *</label>
          <input type="number" class="repair-cost" placeholder="0" value="${repairCost}" onchange="updateRepairData()" style="
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e5e7eb; 
            border-radius: 8px; 
            font-size: 16px;
            background: #ffffff;
            box-sizing: border-box;
          ">
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <label style="font-weight: 600; color: #374151; font-size: 14px;">×ª×™××•×¨ ××¤×•×¨×˜ ×©×œ ×”×ª×™×§×•×Ÿ *</label>
          <textarea class="repair-desc" placeholder="×ª××¨ ×‘×¤×™×¨×•×˜ ××ª ×”×ª×™×§×•×Ÿ ×”× ×“×¨×©..." onchange="updateRepairData()" style="
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e5e7eb; 
            border-radius: 8px; 
            resize: vertical; 
            font-family: inherit;
            min-height: 100px;
            font-size: 16px;
            background: #ffffff;
            box-sizing: border-box;
          ">${repairDesc}</textarea>
        </div>
        
        <button type="button" onclick="removeRepairRow(this)" style="
          background: #dc2626; 
          color: white; 
          border: none; 
          border-radius: 8px; 
          cursor: pointer;
          padding: 12px;
          font-size: 14px;
          font-weight: 600;
          min-height: 48px;
          touch-action: manipulation;
        ">ğŸ—‘ï¸ ×”×¡×¨ ×ª×™×§×•×Ÿ ×–×”</button>
      `;
      
      repairsList.appendChild(row);
      updateRepairData();
    };
    
    // âœ… NEW: Add repair row with existing data
    function addRepairRowWithData(repairData) {
      addRepairRow(repairData);
    }
    
    // âœ… NEW: Remove repair row
    window.removeRepairRow = function(button) {
      button.closest('.repair-row').remove();
      updateRepairData();
    };
    
    // âœ… NEW: Update repair data and send to wizard
    window.updateRepairData = function() {
      const repairRows = document.querySelectorAll('.repair-row');
      const repairs = [];
      let total = 0;
      
      repairRows.forEach(row => {
        const name = row.querySelector('.repair-name').value.trim();
        const cost = parseFloat(row.querySelector('.repair-cost').value) || 0;
        const description = row.querySelector('.repair-desc').value.trim();
        
        if (name || cost > 0) {
          repairs.push({
            name: name,
            cost: cost,
            description: description,
            added_at: new Date().toISOString(),
            source: 'wizard_inline_component'
          });
          total += cost;
        }
      });
      
      // Update module data
      moduleData.repairs = repairs;
      
      // âœ… REMOVED: Don't save to damage_assessment.repairs - only save to damage center
      // All repairs data should be stored within the damage center itself
      
      // âœ… FIXED: Update both internal display and wizard subtotal consistently
      const totalDisplay = document.getElementById('repairTotalDisplay');
      const totalAmount = document.getElementById('repairTotalAmount');
      
      if (totalDisplay && totalAmount) {
        if (total > 0) {
          const vatAmount = total * (vatPercentage / 100);
          const totalWithVat = total + vatAmount;
          totalAmount.textContent = `â‚ª${total.toLocaleString()} (×›×•×œ×œ ××¢"×: â‚ª${totalWithVat.toLocaleString()})`;
          totalDisplay.style.display = 'block';
        } else {
          totalDisplay.style.display = 'none';
        }
      }
      
      // Update wizard subtotal and recalculate main totals
      updateRepairsSubtotal(total);
      calculateTotals();
      
      console.log(`ğŸ”¨ Repair data updated: ${repairs.length} items, total: â‚ª${total}`);
    };
    
    function updateSummary() {
      console.log('ğŸ“‹ === UPDATE SUMMARY CALLED ===');
      
      try {
        // Get all damage centers from helper - check multiple possible locations
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        // âœ… FIX: Check all possible damage center storage locations
        let damageCenters = [];
        if (helper.centers && Array.isArray(helper.centers)) {
          damageCenters = helper.centers;
          console.log('ğŸ“Š Found damage centers in helper.centers:', damageCenters.length);
        } else if (helper.damage_centers && Array.isArray(helper.damage_centers)) {
          damageCenters = helper.damage_centers;
          console.log('ğŸ“Š Found damage centers in helper.damage_centers:', damageCenters.length);
        } else if (helper.damage_assessment?.centers && Array.isArray(helper.damage_assessment.centers)) {
          damageCenters = helper.damage_assessment.centers;
          console.log('ğŸ“Š Found damage centers in helper.damage_assessment.centers:', damageCenters.length);
        }
        
        console.log('ğŸ“Š Helper data keys:', Object.keys(helper));
        console.log(`ğŸ“Š Final damage centers count: ${damageCenters.length}`, damageCenters);
        
        const container = document.getElementById('damageCentersContainer');
        console.log('ğŸ¯ Container element:', container);
        
        if (!container) {
          console.error('âŒ damageCentersContainer element not found!');
          return;
        }
        
        if (damageCenters.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #6b7280;">
              <h3>×œ× × ××¦××• ××•×§×“×™ × ×–×§</h3>
              <p>×¢×œ×™×š ×œ×”×©×œ×™× ×œ×¤×—×•×ª ××•×§×“ × ×–×§ ××—×“ ×œ×¦×¤×™×™×” ×‘×¡×™×›×•×</p>
            </div>
          `;
          return;
        }
        
        // Build collapsible damage centers
        console.log('ğŸ”¨ Building collapsible damage centers...');
        buildCollapsibleDamageCenters(damageCenters);
        
        // Build final totals summary
        console.log('ğŸ“Š Building final totals summary...');
        buildFinalTotalsSummary(damageCenters);
        
        console.log('âœ… Summary update completed');
        
      } catch (error) {
        console.error('âŒ Error in updateSummary:', error);
        const container = document.getElementById('damageCentersContainer');
        if (container) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #dc2626;">
              <h3>×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¡×™×›×•×</h3>
              <p>×× × × ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£</p>
            </div>
          `;
        }
      }
    }

    // âœ… NEW: Build collapsible damage centers display
    function buildCollapsibleDamageCenters(damageCenters) {
      
      const container = document.getElementById('damageCentersContainer');
      if (!container) {
        return;
      }
      
      let html = '';
      
      damageCenters.forEach((center, index) => {
        const centerNumber = center["Damage center Number"] || (index + 1).toString();
        const location = center.Location || '××™×§×•× ×œ× ×¦×•×™×Ÿ';
        const description = center.Description || '××™×Ÿ ×ª×™××•×¨';
        
        
        // Calculate costs
        let worksTotal = center.Works?.works_meta?.total_cost || center.Summary?.["Total works"] || 0;
        let partsTotal = center.Parts?.parts_meta?.total_cost || center.Summary?.["Total parts"] || 0;
        let repairsTotal = center.Repairs?.repairs_meta?.total_cost || center.Summary?.["Total repairs"] || 0;
        
        
        // If meta costs are 0, calculate from actual items
        if (worksTotal === 0 && center.Works?.works) {
          worksTotal = center.Works.works.reduce((sum, work) => sum + (parseFloat(work.cost) || 0), 0);
        }
        
        if (partsTotal === 0 && center.Parts?.parts_required) {
          partsTotal = center.Parts.parts_required.reduce((sum, part) => sum + (parseFloat(part.price) || 0), 0);
        }
        
        if (repairsTotal === 0 && center.Repairs?.repairs) {
          repairsTotal = center.Repairs.repairs.reduce((sum, repair) => sum + (parseFloat(repair.cost) || 0), 0);
        }
        
        const subtotal = worksTotal + partsTotal + repairsTotal;
        const vatRate = (helper.calculations && helper.calculations.vat_rate) ? helper.calculations.vat_rate : 18;
        const vatAmount = subtotal * (vatRate / 100);
        
        const totalWithVat = center.Summary?.["Total with VAT"] || (subtotal + vatAmount);
        
        
        html += `
          <div class="damage-center-card">
            <div class="damage-center-header" onclick="toggleDamageCenter(${index})">
              <div>
                <div class="damage-center-title">
                  <span>ğŸ¯ ××•×§×“ ${centerNumber}</span>
                  <span class="damage-center-location">${location}</span>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 15px;">
                <div class="damage-center-total">${totalWithVat > 0 ? `â‚ª${totalWithVat.toLocaleString()}` : '×œ×œ× ×¢×œ×•×ª ××—×•×‘×¨×ª'}</div>
                <div class="collapse-icon" id="icon-${index}">â–¼</div>
              </div>
            </div>
            
            <div class="damage-center-content" id="content-${index}">
              <div style="margin-bottom: 15px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                <div style="margin-bottom: 10px;">
                  <strong>×ª×™××•×¨ ×”× ×–×§:</strong> ${description}
                </div>
                ${center.RepairNature ? `<div style="margin-bottom: 10px;">
                  <strong>××”×•×ª ×”×ª×™×§×•×Ÿ:</strong> ${center.RepairNature}
                </div>` : ''}
              </div>
              
              <div class="cost-breakdown-row">
                <div class="cost-category-name">ğŸ”¨ ×¢×‘×•×“×•×ª</div>
                <div class="cost-amount">â‚ª${worksTotal.toLocaleString()}</div>
              </div>
              
              <div class="cost-breakdown-row">
                <div class="cost-category-name">ğŸ”§ ×—×œ×§×™×</div>
                <div class="cost-amount">â‚ª${partsTotal.toLocaleString()}</div>
              </div>
              
              <div class="cost-breakdown-row">
                <div class="cost-category-name">âš™ï¸ ×ª×™×§×•× ×™×</div>
                <div class="cost-amount">â‚ª${repairsTotal.toLocaleString()}</div>
              </div>
              
              <div class="cost-breakdown-row">
                <div class="cost-category-name">×¡×”"×› ×œ×œ× ××¢"×</div>
                <div class="cost-amount">â‚ª${subtotal.toLocaleString()}</div>
              </div>
              
              <div class="cost-breakdown-row">
                <div class="cost-category-name">×¡×”"×› ×›×•×œ×œ ××¢"× (18%)</div>
                <div class="cost-amount" style="color: #dc2626; font-size: 18px;">â‚ª${totalWithVat.toLocaleString()}</div>
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // âœ… NEW: Build final totals summary
    function buildFinalTotalsSummary(damageCenters) {
      const centersTotalsContainer = document.getElementById('centersTotalsByLocation');
      let centersTotalsHtml = '';
      let grandTotalWithoutVAT = 0;
      let grandTotalWithVAT = 0;
      
      damageCenters.forEach((center, index) => {
        const centerNumber = center["Damage center Number"] || (index + 1).toString();
        const location = center.Location || '××™×§×•× ×œ× ×¦×•×™×Ÿ';
        
        let worksTotal = center.Works?.works_meta?.total_cost || center.Summary?.["Total works"] || 0;
        let partsTotal = center.Parts?.parts_meta?.total_cost || center.Summary?.["Total parts"] || 0;
        let repairsTotal = center.Repairs?.repairs_meta?.total_cost || center.Summary?.["Total repairs"] || 0;
        
        // Calculate from actual items if meta is empty
        if (worksTotal === 0 && center.Works?.works) {
          worksTotal = center.Works.works.reduce((sum, work) => sum + (parseFloat(work.cost) || 0), 0);
        }
        
        if (partsTotal === 0 && center.Parts?.parts_required) {
          partsTotal = center.Parts.parts_required.reduce((sum, part) => sum + (parseFloat(part.price) || 0), 0);
        }
        
        if (repairsTotal === 0 && center.Repairs?.repairs) {
          repairsTotal = center.Repairs.repairs.reduce((sum, repair) => sum + (parseFloat(repair.cost) || 0), 0);
        }
        
        const subtotal = worksTotal + partsTotal + repairsTotal;
        const vatRate = (helper.calculations && helper.calculations.vat_rate) ? helper.calculations.vat_rate : 18;
        const totalWithVat = center.Summary?.["Total with VAT"] || (subtotal * (1 + vatRate / 100));
        
        centersTotalsHtml += `
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 16px;">
            <span>××•×§×“ ${centerNumber} - ${location}:</span>
            <strong>â‚ª${totalWithVat.toLocaleString()}</strong>
          </div>
        `;
        
        grandTotalWithoutVAT += subtotal;
        grandTotalWithVAT += totalWithVat;
      });
      
      centersTotalsContainer.innerHTML = centersTotalsHtml;
      
      // Calculate and display VAT breakdown
      const vatRate = (helper.calculations && helper.calculations.vat_rate) ? helper.calculations.vat_rate : 18;
      const grandTotalVATAmount = grandTotalWithVAT - grandTotalWithoutVAT;
      
      document.getElementById('grandTotalWithoutVAT').textContent = `â‚ª${grandTotalWithoutVAT.toLocaleString()}`;
      document.getElementById('vatPercentageDisplay').textContent = vatRate;
      document.getElementById('grandTotalVATAmount').textContent = `â‚ª${grandTotalVATAmount.toLocaleString()}`;
      document.getElementById('grandTotalWithVAT').textContent = `â‚ª${grandTotalWithVAT.toLocaleString()}`;
    }

    // âœ… NEW: Toggle damage center collapse/expand
    function toggleDamageCenter(index) {
      const content = document.getElementById(`content-${index}`);
      const icon = document.getElementById(`icon-${index}`);
      
      if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        icon.classList.remove('expanded');
        icon.textContent = 'â–¼';
      } else {
        content.classList.add('expanded');
        icon.classList.add('expanded');
        icon.textContent = 'â–²';
      }
    }

    // âœ… FIX: Navigate to step 7 (wizard summary) instead of separate page
    function goToSummary() {
      console.log('ğŸ“Š Quick navigation to wizard step 7 summary requested');
      
      // Check if there are any damage centers to show
      const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      const damageCenters = helper.damage_assessment?.centers || helper.centers || [];
      
      if (damageCenters.length === 0) {
        showUserNotification('××™×Ÿ ××•×§×“×™ × ×–×§ ×œ×™×¦×•×¨ ×¡×™×›×•×. ×¦×•×¨ ××•×§×“ × ×–×§ ×¨××©×•×Ÿ.', 'warning', 3000);
        return;
      }
      
      // Navigate to step 7 within the wizard (not external page)
      currentStep = 7;
      showStep(7);
      updateProgress(); // âœ… FIX: Update progress bar to show step 7
      updateSummary();
      
      showUserNotification(`××¦×™×’ ×¡×™×›×•× ×©×œ ${damageCenters.length} ××•×§×“×™ × ×–×§`, 'info', 2000);
      console.log(`âœ… Navigated to wizard step 7 with ${damageCenters.length} damage centers`);
    }
    
    // âœ… NEW: Generate detailed cost breakdowns for official form
    function generateDetailedBreakdowns() {
      console.log('ğŸ“‹ Generating detailed cost breakdowns...');
      
      // Parts breakdown
      generatePartsBreakdown();
      
      // Works breakdown  
      generateWorksBreakdown();
      
      // Repairs breakdown
      generateRepairsBreakdown();
    }
    
    function generatePartsBreakdown() {
      const partsContainer = document.getElementById('partsBreakdown');
      const partsTotalDisplay = document.getElementById('partsTotalDisplay');
      
      const parts = moduleData.parts || [];
      let total = 0;
      
      if (parts.length === 0) {
        partsContainer.innerHTML = '<div style="color: #6b7280; font-style: italic; text-align: center; padding: 20px;">×œ× × ××¦××• ×—×œ×§×™× × ×“×¨×©×™×</div>';
        partsTotalDisplay.textContent = 'â‚ª0';
        return;
      }
      
      let html = '';
      parts.forEach((part, index) => {
        const cost = parseFloat(part.price || part.cost || 0);
        total += cost;
        
        html += `
          <div class="breakdown-item">
            <div class="breakdown-item-details">
              <div class="breakdown-item-name">${part.part || part.name || `×—×œ×§ ${index + 1}`}</div>
              <div class="breakdown-item-description">${part.desc || part.description || '×œ×œ× ×ª×™××•×¨'}</div>
              <div class="breakdown-item-meta">
                ${part.supplier ? `×¡×¤×§: ${part.supplier}` : ''}
                ${part.source ? `â€¢ ××§×•×¨: ${part.source}` : ''}
                ${part.location ? `â€¢ ××™×§×•×: ${part.location}` : ''}
              </div>
            </div>
            <div class="breakdown-item-cost">â‚ª${cost.toLocaleString()}</div>
          </div>
        `;
      });
      
      partsContainer.innerHTML = html;
      partsTotalDisplay.textContent = `â‚ª${total.toLocaleString()}`;
      
      console.log(`âœ… Parts breakdown: ${parts.length} items, total: â‚ª${total}`);
    }
    
    function generateWorksBreakdown() {
      const worksContainer = document.getElementById('worksBreakdown');
      const worksTotalDisplay = document.getElementById('worksTotalDisplay');
      
      const works = moduleData.works || [];
      let total = 0;
      
      if (works.length === 0) {
        worksContainer.innerHTML = '<div style="color: #6b7280; font-style: italic; text-align: center; padding: 20px;">×œ× × ××¦××• ×¢×‘×•×“×•×ª × ×“×¨×©×•×ª</div>';
        worksTotalDisplay.textContent = 'â‚ª0';
        return;
      }
      
      let html = '';
      works.forEach((work, index) => {
        const cost = parseFloat(work.cost || 0);
        total += cost;
        
        html += `
          <div class="breakdown-item">
            <div class="breakdown-item-details">
              <div class="breakdown-item-name">${work.category || `×¢×‘×•×“×” ${index + 1}`}</div>
              <div class="breakdown-item-description">${work.comments || work.description || '×œ×œ× ×ª×™××•×¨'}</div>
              <div class="breakdown-item-meta">
                ${work.hours ? `×©×¢×•×ª: ${work.hours}` : ''}
                ${work.hourly_rate ? `â€¢ ×ª×¢×¨×™×£: â‚ª${work.hourly_rate}/×©×¢×”` : ''}
                ${work.priority ? `â€¢ ×¢×“×™×¤×•×ª: ${work.priority}` : ''}
              </div>
            </div>
            <div class="breakdown-item-cost">â‚ª${cost.toLocaleString()}</div>
          </div>
        `;
      });
      
      worksContainer.innerHTML = html;
      worksTotalDisplay.textContent = `â‚ª${total.toLocaleString()}`;
      
      console.log(`âœ… Works breakdown: ${works.length} items, total: â‚ª${total}`);
    }
    
    function generateRepairsBreakdown() {
      const repairsContainer = document.getElementById('repairsBreakdown');
      const repairsTotalDisplay = document.getElementById('repairsTotalDisplay');
      
      const repairs = moduleData.repairs || [];
      let total = 0;
      
      if (repairs.length === 0) {
        repairsContainer.innerHTML = '<div style="color: #6b7280; font-style: italic; text-align: center; padding: 20px;">×œ× × ××¦××• ×ª×™×§×•× ×™× × ×“×¨×©×™×</div>';
        repairsTotalDisplay.textContent = 'â‚ª0';
        return;
      }
      
      let html = '';
      repairs.forEach((repair, index) => {
        const cost = parseFloat(repair.cost || 0);
        total += cost;
        
        html += `
          <div class="breakdown-item">
            <div class="breakdown-item-details">
              <div class="breakdown-item-name">${repair.name || `×ª×™×§×•×Ÿ ${index + 1}`}</div>
              <div class="breakdown-item-description">${repair.description || '×œ×œ× ×ª×™××•×¨'}</div>
              <div class="breakdown-item-meta">
                ${repair.priority ? `×¢×“×™×¤×•×ª: ${repair.priority}` : ''}
                ${repair.estimated_hours ? `â€¢ ×–××Ÿ ××©×•×¢×¨: ${repair.estimated_hours} ×©×¢×•×ª` : ''}
                ${repair.complexity ? `â€¢ ××•×¨×›×‘×•×ª: ${repair.complexity}` : ''}
              </div>
            </div>
            <div class="breakdown-item-cost">â‚ª${cost.toLocaleString()}</div>
          </div>
        `;
      });
      
      repairsContainer.innerHTML = html;
      repairsTotalDisplay.textContent = `â‚ª${total.toLocaleString()}`;
      
      console.log(`âœ… Repairs breakdown: ${repairs.length} items, total: â‚ª${total}`);
    }
    
    function calculateTotals() {
      console.log('ğŸ§® === CALCULATE TOTALS START ===');
      console.log('ğŸ” Current damage center data:', damageCenterData);
      console.log('ğŸ” Current module data:', moduleData);
      
      // âœ… CRITICAL FIX: Ensure we're only calculating for CURRENT damage center data
      const currentWorkTotal = moduleData.works.reduce((sum, work) => sum + (parseFloat(work.cost) || 0), 0);
      const currentPartsTotal = moduleData.parts.reduce((sum, part) => sum + (parseFloat(part.price) || 0), 0);
      const currentRepairsTotal = moduleData.repairs.reduce((sum, repair) => sum + (parseFloat(repair.cost) || 0), 0);
      
      console.log('ğŸ§® CURRENT CENTER ONLY totals:', {
        works: currentWorkTotal,
        parts: currentPartsTotal, 
        repairs: currentRepairsTotal
      });
      
      // Use helper API for calculation if available
      if (typeof window.calculateDamageCenterTotals === 'function' && damageCenterData.id) {
        const totals = window.calculateDamageCenterTotals(damageCenterData.id);
        if (totals) {
          // Update display with helper API results (with null checks)
          const totalAmountEl = document.getElementById('totalAmount');
          const totalWithoutVatEl = document.getElementById('totalWithoutVat');
          const totalWithVatEl = document.getElementById('totalWithVat');
          
          if (totalAmountEl) totalAmountEl.textContent = `â‚ª${totals.subtotal.toLocaleString()}`;
          if (totalWithoutVatEl) totalWithoutVatEl.textContent = `â‚ª${totals.subtotal.toLocaleString()}`;
          if (totalWithVatEl) totalWithVatEl.textContent = `â‚ª${totals.totalWithVat.toLocaleString()}`;
          
          // âœ… DAMAGE CENTERS FIX: Use correct property names from helper API
          const workTotal = totals.works_subtotal || totals.workTotal || 0;
          const partsTotal = totals.parts_subtotal || totals.partsTotal || 0; 
          const repairsTotal = totals.repairs_subtotal || totals.repairsTotal || 0;
          
          console.log('ğŸ”§ DEBUG: Extracted totals for updateModuleSubtotals:', {workTotal, partsTotal, repairsTotal});
          
          // Update individual subtotals
          updateModuleSubtotals(workTotal, partsTotal, repairsTotal);
          
          console.log('ğŸ§® Calculated totals using helper API:', totals);
          return;
        }
      }
      
      // âœ… FIXED: Use current center calculated totals (not accumulated)
      const workTotal = currentWorkTotal;
      const partsTotal = currentPartsTotal;
      const repairsTotal = currentRepairsTotal;
      
      const subtotal = workTotal + partsTotal + repairsTotal;
      const vatAmount = subtotal * (vatPercentage / 100);
      const totalWithVat = subtotal + vatAmount;
      
      console.log('ğŸ§® FINAL CALCULATED totals (current center only):', {
        workTotal, partsTotal, repairsTotal, subtotal, totalWithVat
      });
      
      // Update display (with null checks)
      const totalAmountEl = document.getElementById('totalAmount');
      const totalWithoutVatEl = document.getElementById('totalWithoutVat');
      const totalWithVatEl = document.getElementById('totalWithVat');
      
      if (totalAmountEl) totalAmountEl.textContent = `â‚ª${subtotal.toLocaleString()}`;
      if (totalWithoutVatEl) totalWithoutVatEl.textContent = `â‚ª${subtotal.toLocaleString()}`;
      if (totalWithVatEl) totalWithVatEl.textContent = `â‚ª${totalWithVat.toLocaleString()}`;
      
      // Update individual subtotals in wizard
      updateModuleSubtotals(workTotal, partsTotal, repairsTotal);
      
      // Save to damage center data
      damageCenterData.workTotal = workTotal;
      damageCenterData.partsTotal = partsTotal;
      damageCenterData.repairsTotal = repairsTotal;
      damageCenterData.subtotal = subtotal;
      damageCenterData.vatAmount = vatAmount;
      damageCenterData.totalWithVat = totalWithVat;
      
      // âœ… FIXED: Also save totals to helper.damage_assessment.totals for CURRENT center only
      try {
        let helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        helper.damage_assessment = helper.damage_assessment || {};
        helper.damage_assessment.current_center_totals = {
          work_total: workTotal,
          parts_total: partsTotal,
          repairs_total: repairsTotal,
          subtotal_without_vat: subtotal,
          vat_amount: vatAmount,
          total_with_vat: totalWithVat,
          vat_percentage: vatPercentage,
          calculated_at: new Date().toISOString(),
          damage_center_id: damageCenterData.id || `center_${Date.now()}`,
          center_number: damageCenterData.number
        };
        sessionStorage.setItem('helper', JSON.stringify(helper));
        console.log('âœ… Saved CURRENT CENTER cost totals to helper.damage_assessment.current_center_totals');
      } catch (error) {
        console.error('âŒ Failed to save totals to helper:', error);
      }
      
      console.log('ğŸ§® === CALCULATE TOTALS END ===');
    }
    
    function updateModuleSubtotals(workTotal, partsTotal, repairsTotal) {
      // âœ… DAMAGE CENTERS FIX: Only validate parameters if they are actually undefined (preserve calculated values)
      if (workTotal === undefined || workTotal === null) workTotal = 0;
      if (partsTotal === undefined || partsTotal === null) partsTotal = 0;  
      if (repairsTotal === undefined || repairsTotal === null) repairsTotal = 0;
      
      // Ensure they are numbers for calculations
      workTotal = Number(workTotal) || 0;
      partsTotal = Number(partsTotal) || 0;
      repairsTotal = Number(repairsTotal) || 0;
      
      // âœ… FIXED: Use proper VAT percentage instead of hardcoded 1.17
      const vatMultiplier = 1 + (vatPercentage / 100);
      
      // Update work subtotal display
      const workSubtotal = document.getElementById('workSubtotal');
      if (workSubtotal) {
        const workAmount = document.getElementById('workAmount');
        const workAmountWithVat = document.getElementById('workAmountWithVat');
        if (workAmount) workAmount.textContent = `â‚ª${workTotal.toLocaleString()}`;
        if (workAmountWithVat) workAmountWithVat.textContent = `â‚ª${(workTotal * vatMultiplier).toLocaleString()}`;
        workSubtotal.style.display = workTotal > 0 ? 'block' : 'none';
      }
      
      // âœ… FIXED: Also update inline work component display
      const workTotalDisplay = document.getElementById('workTotalDisplay');
      const workTotalAmount = document.getElementById('workTotalAmount');
      if (workTotalDisplay && workTotalAmount) {
        if (workTotal > 0) {
          workTotalAmount.textContent = `â‚ª${workTotal.toLocaleString()}`;
          workTotalDisplay.style.display = 'block';
        } else {
          workTotalDisplay.style.display = 'none';
        }
      }
      
      // Update parts subtotal display  
      const partsSubtotal = document.getElementById('partsSubtotal');
      if (partsSubtotal) {
        const partsAmount = document.getElementById('partsAmount');
        const partsAmountWithVat = document.getElementById('partsAmountWithVat');
        if (partsAmount) partsAmount.textContent = `â‚ª${partsTotal.toLocaleString()}`;
        if (partsAmountWithVat) partsAmountWithVat.textContent = `â‚ª${(partsTotal * vatMultiplier).toLocaleString()}`;
        partsSubtotal.style.display = partsTotal > 0 ? 'block' : 'none';
      }
      
      // Update repairs subtotal display
      const repairsSubtotal = document.getElementById('repairsSubtotal');
      if (repairsSubtotal) {
        const repairsAmount = document.getElementById('repairsAmount');
        const repairsAmountWithVat = document.getElementById('repairsAmountWithVat');
        if (repairsAmount) repairsAmount.textContent = `â‚ª${repairsTotal.toLocaleString()}`;
        if (repairsAmountWithVat) repairsAmountWithVat.textContent = `â‚ª${(repairsTotal * vatMultiplier).toLocaleString()}`;
        repairsSubtotal.style.display = repairsTotal > 0 ? 'block' : 'none';
      }
      
      // âœ… FIXED: Also update inline repairs component display  
      const repairsTotalDisplay = document.getElementById('repairsTotalDisplay');
      const repairsTotalAmount = document.getElementById('repairsTotalAmount');
      if (repairsTotalDisplay && repairsTotalAmount) {
        if (repairsTotal > 0) {
          repairsTotalAmount.textContent = `â‚ª${repairsTotal.toLocaleString()}`;
          repairsTotalDisplay.style.display = 'block';
        } else {
          repairsTotalDisplay.style.display = 'none';
        }
      }
      
      console.log('ğŸ“Š Updated module subtotals:', { workTotal, partsTotal, repairsTotal, vatPercentage });
    }
    
    // Create damage center immediately after step 1 (location + description)
    function createInitialDamageCenter() {
      console.log('ğŸš€ Creating initial damage center after step 1...');
      
      try {
        // Get location from step 1 (description will be added in step 2)
        const locationSelect = document.getElementById('locationSelect');
        const otherLocationInput = document.getElementById('otherLocationInput');
        
        let location = locationSelect?.value || '××™×§×•× ×œ× ×¦×•×™×Ÿ';
        if (location === 'other' && otherLocationInput?.value) {
          location = otherLocationInput.value.trim();
        }
        
        const description = '×ª×™××•×¨ ×™×ª×•×•×¡×£ ×‘×©×œ×‘ ×”×‘×'; // Placeholder until step 2
        
        // Get next damage center number
        const nextNumber = typeof window.getNextDamageCenterNumber === 'function' 
          ? window.getNextDamageCenterNumber() 
          : 1;
        
        // Create initial damage center structure
        const initialDamageCenter = {
          id: `center_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          number: nextNumber,
          location: location,
          description: description,
          area_code: 'GENERAL',
          side: 'N/A',
          severity: 3,
          damage_types: ['GENERAL'],
          notes: description,
          photos: [],
          works: [],
          parts_required: [],
          repairs: [],
          created_at: new Date().toISOString(),
          created_by: 'wizard_step_1',
          status: 'in_progress'
        };
        
        // Save using helper API
        if (typeof window.createDamageCenter === 'function') {
          const centerId = window.createDamageCenter(initialDamageCenter);
          if (centerId) {
            console.log('âœ… Initial damage center created:', centerId);
            damageCenterData.id = centerId;
            damageCenterData.number = nextNumber;
            damageCenterData.location = location;
            damageCenterData.description = description;
            
            // Build comprehensive assessment
            if (typeof window.buildComprehensiveDamageAssessment === 'function') {
              window.buildComprehensiveDamageAssessment();
            }
            
            showUserNotification(`××•×§×“ × ×–×§ ${nextNumber} × ×•×¦×¨ ×‘×”×¦×œ×—×”!`, 'success', 2000);
          } else {
            console.error('âŒ Failed to create initial damage center');
          }
        } else {
          console.error('âŒ Helper API not available');
        }
        
      } catch (error) {
        console.error('âŒ Error creating initial damage center:', error);
      }
    }
    
    // Update existing damage center after each step
    function updateExistingDamageCenter() {
      console.log('ğŸ“ Updating existing damage center with step data...');
      
      if (!damageCenterData.id) {
        console.error('âŒ No damage center ID to update');
        return;
      }
      
      try {
        // Prepare update data based on current step
        const updateData = {
          works: moduleData.works || [],
          parts_required: moduleData.parts || [],
          repairs: moduleData.repairs || [],
          updated_at: new Date().toISOString(),
          updated_by: `wizard_step_${currentStep}`,
          meta: {
            last_step: currentStep
          }
        };
        
        // Update using helper API
        if (typeof window.updateDamageCenter === 'function') {
          const success = window.updateDamageCenter(damageCenterData.id, updateData);
          if (success) {
            console.log(`âœ… Updated damage center ${damageCenterData.id} with step ${currentStep} data`);
            
            // Recalculate totals
            if (typeof window.calculateDamageCenterTotals === 'function') {
              window.calculateDamageCenterTotals(damageCenterData.id);
            }
            
            // Rebuild comprehensive assessment
            if (typeof window.buildComprehensiveDamageAssessment === 'function') {
              window.buildComprehensiveDamageAssessment();
            }
          }
        }
        
      } catch (error) {
        console.error('âŒ Error updating damage center:', error);
      }
    }
    
    // Final update for completed damage center
    function updateFinalDamageCenterData() {
      console.log('ğŸ Finalizing damage center data...');
      
      if (!damageCenterData.id) {
        console.error('âŒ No damage center to finalize');
        return;
      }
      
      try {
        // Mark as completed
        const finalData = {
          status: 'completed',
          completed_at: new Date().toISOString(),
          wizard_steps_completed: 7,
          works: moduleData.works || [],
          parts_required: moduleData.parts || [],
          repairs: moduleData.repairs || []
        };
        
        // Update using helper API
        if (typeof window.updateDamageCenter === 'function') {
          const success = window.updateDamageCenter(damageCenterData.id, finalData);
          if (success) {
            console.log(`âœ… Finalized damage center ${damageCenterData.id}`);
            
            // Final calculations
            if (typeof window.calculateDamageCenterTotals === 'function') {
              window.calculateDamageCenterTotals(damageCenterData.id);
            }
            
            // Final comprehensive assessment
            if (typeof window.buildComprehensiveDamageAssessment === 'function') {
              window.buildComprehensiveDamageAssessment();
            }
            
            // âœ… FIXED: Sync damage centers to assessment
            if (typeof window.syncDamageAssessmentCenters === 'function') {
              window.syncDamageAssessmentCenters();
              console.log('âœ… Synced damage centers to assessment');
            }
            
            showUserNotification(`××•×§×“ × ×–×§ ${damageCenterData.number} ×”×•×©×œ× ×‘×”×¦×œ×—×”!`, 'success', 3000);
            
            // âœ… FIXED: Clear current damage center and prepare for next
            clearCurrentDamageCenter();
          }
        }
        
      } catch (error) {
        console.error('âŒ Error finalizing damage center:', error);
      }
    }
    
    function clearCurrentDamageCenter() {
      console.log('ğŸ§¹ Clearing current damage center and preparing for next...');
      
      // Clear active damage center ID
      sessionStorage.removeItem('active_damage_center_id');
      
      // Clear wizard temp data
      let helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      if (helper.wizard_temp) {
        delete helper.wizard_temp.current_damage_center;
      }
      
      // Clear damage_assessment.current_center_id
      if (helper.damage_assessment) {
        delete helper.damage_assessment.current_center_id;
      }
      
      sessionStorage.setItem('helper', JSON.stringify(helper));
      
      // âœ… FIXED: Force save to ensure damage center is in storage before reset
      if (typeof window.saveHelperToStorage === 'function') {
        window.saveHelperToStorage();
        console.log('âœ… Forced helper save to storage');
      }
      
      // Reset wizard for next damage center with extra delay
      setTimeout(() => {
        // Double-check that damage centers are properly saved
        const savedHelper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        console.log('ğŸ“Š Damage centers count before reset:', savedHelper.damage_centers?.length || 0);
        
        resetWizard();
        
        // âœ… FIXED: Set proper number after reset
        const nextNumber = (typeof window.getNextDamageCenterNumber === 'function') 
          ? window.getNextDamageCenterNumber() 
          : (getDamageCentersFromHelper().length + 1);
        damageCenterData.number = nextNumber;
        document.getElementById('damageCenterNumber').value = nextNumber;
      }, 3000);
    }
    
    function saveDamageCenter() {
      // âœ… LEGACY FUNCTION - replaced by updateFinalDamageCenterData
      updateFinalDamageCenterData();
    }
    
    // New function for finishing and going to expertise summary
    function finishAndGoToSummary() {
      showUserNotification('×©×•××¨ × ×ª×•× ×™× ×•××¦×™×’ ×¡×™×›×•× ×¡×•×¤×™...', 'info', 2000);
      
      // âœ… FIX: Check if there's a current damage center to save before calling saveCurrentStep
      try {
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        // Only save if there's a current damage center with data to transfer
        if (helper.current_damage_center && helper.current_damage_center.Id) {
          console.log('ğŸ“¦ Current damage center found, saving before finishing...');
          saveCurrentStep();
        } else {
          console.log('â„¹ï¸ No current damage center to save, proceeding to summary...');
        }
      } catch (error) {
        console.warn('âš ï¸ Could not check current damage center, proceeding to summary:', error);
      }
      
      // Generate and display final summary
      setTimeout(() => {
        generateFinalSummary();
        showUserNotification('×¡×™×›×•× ×”××§×¡×¤×¨×˜×™×–×” ××•×›×Ÿ!', 'success', 3000);
      }, 1500);
    }
    
    function generateFinalSummary() {
      console.log('ğŸ“‹ Generating final damage centers summary...');
      
      // Update the damage centers container in step 7
      updateSummary();
      
      // Add options to continue to next phase
      const summaryContainer = document.getElementById('damageCentersContainer');
      if (summaryContainer) {
        // Add completion actions at the end
        const completionActions = document.createElement('div');
        completionActions.style.cssText = `
          margin-top: 30px; 
          padding: 25px; 
          background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); 
          color: white; 
          border-radius: 15px; 
          text-align: center;
          box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
        `;
        
        completionActions.innerHTML = `
          <h3 style="margin-bottom: 20px; color: white;">ğŸ‰ ××•×§×“×™ ×”× ×–×§ ×”×•×©×œ××• ×‘×”×¦×œ×—×”!</h3>
          <p style="margin-bottom: 25px; font-size: 16px; opacity: 0.9;">
            ×›×œ ××•×§×“×™ ×”× ×–×§ × ×©××¨×• ×‘××¢×¨×›×ª. ××ª×” ×™×›×•×œ ×œ×”××©×™×š ×œ×©×œ×‘×™× ×”×‘××™× ×‘××§×¡×¤×¨×˜×™×–×”.
          </p>
          
          <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
            <button type="button" onclick="window.location.href='expertise-summary.html'" style="
              background: rgba(255,255,255,0.2); 
              color: white; 
              border: 2px solid white; 
              padding: 12px 24px; 
              border-radius: 8px; 
              cursor: pointer; 
              font-weight: bold;
              font-size: 16px;
              transition: all 0.3s ease;
            " 
            onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
            onmouseout="this.style.background='rgba(255,255,255,0.2)'">
              ğŸ“‹ ×¢×‘×•×¨ ×œ×¡×™×›×•× ×”××§×¡×¤×¨×˜×™×–×”
            </button>
            <button type="button" onclick="window.location.href='selection.html'" style="
              background: white; 
              color: #16a34a; 
              border: none; 
              padding: 12px 24px; 
              border-radius: 8px; 
              cursor: pointer; 
              font-weight: bold;
              font-size: 16px;
              transition: all 0.3s ease;
            " 
            onmouseover="this.style.background='#f9fafb'" 
            onmouseout="this.style.background='white'">
              ğŸ  ×—×–×•×¨ ×œ×ª×¤×¨×™×˜ ×”×¨××©×™
            </button>
          </div>
        `;
        
        summaryContainer.appendChild(completionActions);
      }
      
      console.log('âœ… Final summary generated successfully');
    }
    
    function saveDamageCenterToHelper() {
      console.log('ğŸ’¾ Saving damage center using helper API...');
      
      try {
        // Prepare damage center data
        const location = moduleData.location || document.getElementById('locationSelect')?.value || '××™×§×•× ×œ× ×¦×•×™×Ÿ';
        const description = moduleData.description || document.getElementById('damageDescription')?.value || '×ª×™××•×¨ ×œ× ×¦×•×™×Ÿ';
        
        // Get actual data from modules
        const workData = moduleData.works || [];
        const partsData = moduleData.parts || [];
        const repairsData = moduleData.repairs || [];
        
        // Create damage center draft
        const damageCenterDraft = {
          id: damageCenterData.id || `center_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          number: damageCenterData.number || 1,
          location: location,
          description: description,
          area_code: 'GENERAL', // Default area code, can be enhanced later
          side: 'N/A',
          severity: 3, // Default severity, can be enhanced later
          damage_types: ['GENERAL'], // Default damage type, can be enhanced later
          notes: description,
          photos: [],
          works: workData.map(work => ({
            id: `wk_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
            category: work.category || '×¢×‘×•×“×” ×›×œ×œ×™×ª',
            cost: parseFloat(work.cost) || 0,
            comments: work.comments || '',
            hours: parseFloat(work.hours) || 0,
            hourly_rate: parseFloat(work.hourly_rate) || 0,
            qty: 1
          })),
          parts_required: partsData.map(part => ({
            id: `pr_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
            part_id: part.part_id || part.code || 'UNKNOWN',
            name: part.name || part.description || '×—×œ×§ ×œ× ××–×•×”×”',
            price: parseFloat(part.price) || 0,
            qty: parseInt(part.quantity) || 1,
            source: part.source || 'MANUAL'
          }))
        };
        
        // Use the new helper API if available
        if (typeof window.createDamageCenter === 'function') {
          const centerId = window.createDamageCenter(damageCenterDraft);
          if (centerId) {
            console.log('âœ… Damage center saved successfully using helper API:', centerId);
            
            // Update the current damage center data
            damageCenterData.id = centerId;
            
            // Calculate totals using helper API if available
            if (typeof window.calculateDamageCenterTotals === 'function') {
              window.calculateDamageCenterTotals(centerId);
            }
            
            // Build comprehensive damage assessment with ALL details
            if (typeof window.buildComprehensiveDamageAssessment === 'function') {
              const assessment = window.buildComprehensiveDamageAssessment();
              if (assessment) {
                console.log('âœ… Built comprehensive damage assessment:', assessment);
              }
            }
            
            showUserNotification('××•×§×“ ×”× ×–×§ × ×©××¨ ×‘×”×¦×œ×—×”!', 'success');
            
            // âœ… FIX: Refresh step 7 summary list when damage center is saved
            if (currentStep === 7 || document.getElementById('step7')?.classList.contains('active')) {
              console.log('ğŸ”„ Refreshing step 7 summary after saving damage center');
              updateSummary();
            }
            
            return true;
          } else {
            console.error('âŒ Failed to save damage center using helper API');
            showUserNotification('×©×’×™××” ×‘×©××™×¨×ª ××•×§×“ ×”× ×–×§', 'error');
            return false;
          }
        }
        
        // Fallback to legacy method if helper API not available
        console.log('ğŸ”„ Using fallback save method');
        let helper = {};
        try {
          helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        } catch (e) {
          console.warn('Failed to parse helper from sessionStorage, using empty object');
          helper = {};
        }
        
        // Initialize damage centers structure if missing
        if (!helper.damage_centers) {
          helper.damage_centers = [];
        }
        
        // Get damage center data for fallback method
        const fallbackLocation = moduleData.location || '××™×§×•× ×œ× ×¦×•×™×Ÿ';
        const fallbackDescription = moduleData.description || '×ª×™××•×¨ ×œ× ×¦×•×™×Ÿ';
        
        // Get actual data from modules for fallback
        const fallbackWorkData = moduleData.works.length > 0 ? moduleData.works : (helper.damage_assessment?.work?.work_items || []);
        const fallbackPartsData = moduleData.parts.length > 0 ? moduleData.parts : (helper.damage_assessment?.parts?.parts_items || []);
        const fallbackRepairsData = moduleData.repairs.length > 0 ? moduleData.repairs : (helper.damage_assessment?.repairs?.repairs_items || []);
        
        // Calculate totals for fallback method
        const workTotal = fallbackWorkData.reduce((sum, item) => sum + (parseFloat(item.cost) || 0), 0);
        const partsTotal = fallbackPartsData.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0);
        const repairsTotal = fallbackRepairsData.reduce((sum, item) => sum + (parseFloat(item.cost) || 0), 0);
        const total = workTotal + partsTotal + repairsTotal;
        
        // âœ… FIXED: Create damage center directly without missing function dependencies  
        const centerNumber = damageCenterData.number || 1;
        // âœ… FIXED: Use existing ID if available, otherwise create new
        const centerId = damageCenterData.id || `center_${centerNumber}_${Date.now()}`;
        
        const newCenter = {
          id: centerId,
          number: centerNumber,
          location: fallbackLocation,
          description: fallbackDescription,
          work_items: [],
          parts_items: [],
          repairs_items: [],
          totals: {
            work_total: 0,
            parts_total: 0,
            repairs_total: 0,
            subtotal: 0,
            vat_amount: 0,
            total_with_vat: 0
          },
          metadata: {
            created_by: 'damage_centers_wizard',
            creation_method: 'wizard',
            created_at: new Date().toISOString(),
            wizard_step_completed: 7
          }
        };
        
        // Add all work items with comprehensive data
        fallbackWorkData.forEach(work => {
          const workItem = {
            category: work.category,
            cost: parseFloat(work.cost) || 0,
            comments: work.comments || '',
            hours: parseFloat(work.hours) || 0,
            hourly_rate: parseFloat(work.hourly_rate) || 0,
            source: 'wizard_input',
            added_at: new Date().toISOString(),
            validated: true
          };
          newCenter.work_items.push(workItem);
        });
        
        // Add all parts items with comprehensive data including webhook results
        fallbackPartsData.forEach(part => {
          const partItem = {
            name: part.part || part.name || '',
            description: part.desc || part.description || '',
            price: parseFloat(part.price) || 0,
            cost: parseFloat(part.price) || 0,
            supplier: part.supplier || '',
            location: part.location || '',
            part_number: part.part_number || '',
            brand: part.brand || '',
            condition: part.condition || '××©×•××©',
            availability: part.availability || '',
            source: part.source || 'manual',
            
            // Advanced tracking
            search_session: part.search_session || '',
            webhook_data: part.webhook_data || {},
            ocr_extracted: part.ocr_extracted || false,
            verified: part.verified || false,
            added_at: new Date().toISOString(),
            
            // Integration data
            linked_search_id: part.linked_search_id || '',
            confidence_score: part.confidence_score || 0
          };
          newCenter.parts_items.push(partItem);
        });
        
        // Add all repair items with comprehensive data
        fallbackRepairsData.forEach(repair => {
          const repairItem = {
            name: repair.name || '',
            description: repair.description || '',
            cost: parseFloat(repair.cost) || 0,
            priority: repair.priority || 'normal',
            estimated_hours: parseFloat(repair.estimated_hours) || 0,
            complexity: repair.complexity || 'medium',
            source: 'wizard_input',
            added_at: new Date().toISOString(),
            validated: true
          };
          newCenter.repairs_items.push(repairItem);
        });
        
        // âœ… FIXED: Calculate totals directly
        newCenter.totals.work_total = workTotal;
        newCenter.totals.parts_total = partsTotal;  
        newCenter.totals.repairs_total = repairsTotal;
        newCenter.totals.subtotal = total;
        newCenter.totals.vat_amount = total * (vatPercentage / 100);
        newCenter.totals.total_with_vat = total + newCenter.totals.vat_amount;
        
        // FIXED: Also create subtotals structure expected by summary page
        newCenter.subtotals = {
          works: workTotal,
          parts: partsTotal,
          repairs: repairsTotal,
          subtotal: total,
          vat_amount: total * (vatPercentage / 100),
          total_with_vat: total + (total * (vatPercentage / 100))
        };
        
        // FIXED: Also create calculations structure expected by summary page  
        newCenter.calculations = {
          works_subtotal: workTotal,
          parts_subtotal: partsTotal,
          repairs_subtotal: repairsTotal,
          subtotal_before_vat: total,
          vat_percentage: vatPercentage,
          vat_amount: total * (vatPercentage / 100),
          total_with_vat: total + (total * (vatPercentage / 100))
        };
        
        // âœ… FIXED: Save to proper helper structure - damage_centers is the canonical location
        if (!helper.damage_centers) {
          helper.damage_centers = [];
        }
        
        // âœ… FIXED: Check if damage center already exists and update it, or add new
        const existingIndex = helper.damage_centers.findIndex(c => c.id === damageCenterData.id);
        if (existingIndex >= 0) {
          // Update existing damage center
          helper.damage_centers[existingIndex] = newCenter;
          console.log('âœ… Updated existing damage center at index:', existingIndex);
        } else {
          // Add new damage center
          helper.damage_centers.push(newCenter);
          console.log('âœ… Added new damage center to array');
        }
        
        // Update helper meta
        helper.meta = helper.meta || {};
        helper.meta.last_updated = new Date().toISOString();
        helper.meta.damage_centers_count = helper.damage_centers.length;
        
        // Save to session storage
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        console.log('âœ… Damage center saved to helper:', {
          id: newCenter.id,
          number: newCenter.number,
          location: newCenter.location,
          totals: newCenter.totals,
          items: {
            work: newCenter.work_items.length,
            parts: newCenter.parts_items.length,
            repairs: newCenter.repairs_items.length
          }
        });
        console.log('âœ… Total damage centers:', helper.damage_centers.length);
        
        // âœ… FIXED: Also sync to damage_assessment.centers for backward compatibility
        if (!helper.damage_assessment) {
          helper.damage_assessment = { centers: [] };
        }
        helper.damage_assessment.centers = [...helper.damage_centers];
        
        // âœ… FIXED: Clear wizard temp data for next center
        // Note: We don't store work, parts, or repairs in damage_assessment anymore
        // Everything is stored directly in the damage center
        
        // Clear wizard temporary data since damage center is completed
        if (helper.wizard_temp) {
          delete helper.wizard_temp.current_damage_center;
          console.log('ğŸ§¹ Wizard temporary data cleared - damage center completed');
        }
        
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        // âœ… FIXED: Update the damage centers dropdown immediately
        setTimeout(() => {
          populateExistingDamageCenters(true);
          console.log('ğŸ”„ Updated damage centers dropdown after completion');
          
          // âœ… FIX: Also refresh step 7 summary list when damage center is saved (fallback method)
          if (currentStep === 7 || document.getElementById('step7')?.classList.contains('active')) {
            console.log('ğŸ”„ Refreshing step 7 summary after saving damage center (fallback)');
            updateSummary();
          }
        }, 100);
        
      } catch (error) {
        console.error('âŒ Failed to save organized damage center to helper:', error);
        showUserNotification('×©×’×™××” ×‘×©××™×¨×ª ××•×§×“ ×”× ×–×§. ×× × ×‘×“×•×§ ××ª ×”× ×ª×•× ×™× ×•× ×¡×” ×©×•×‘.', 'error');
      }
    }
    
    function getDamageCentersFromHelper() {
      // Get helper data
      let helper;
      
      // Try window.helper first, then sessionStorage
      if (typeof window.helper !== 'undefined' && window.helper) {
        helper = window.helper;
      } else {
        try {
          helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        } catch (e) {
          console.error('âŒ Failed to parse helper from sessionStorage:', e);
          return [];
        }
      }
      
      // âœ… FIXED: Use correct structure per documentation - helper.centers
      if (helper.centers && Array.isArray(helper.centers)) {
        console.log('âœ… Found damage centers in helper.centers:', helper.centers.length);
        return helper.centers;
      }
      
      console.log('âŒ No damage centers found in helper.centers');
      return [];
    }
    
    function resetWizard() {
      currentStep = 1;
      damageCenterData = {};
      
      // âœ… CRITICAL: Clear ALL module data for new damage center
      moduleData = {
        works: [],
        parts: [],
        repairs: [],
        location: '',
        description: '',
        searchResults: []
      };
      
      // âœ… FIXED: Clear wizard temporary data
      clearWizardTempData();
      
      showStep(1);
      updateProgress();
      // âœ… FIXED: Don't generate number here - let calling function handle it
      
      // Clear form fields
      const descField = document.getElementById('damageDescription');
      if (descField) descField.value = '';
      
      const locationSelect = document.getElementById('locationSelect');
      if (locationSelect) locationSelect.value = '';
      
      const otherLocationInput = document.getElementById('otherLocationInput');
      if (otherLocationInput) {
        otherLocationInput.value = '';
        otherLocationInput.style.display = 'none';
      }
      
      document.querySelectorAll('.location-card').forEach(card => {
        card.classList.remove('selected');
      });
      
      // âœ… CRITICAL: Clear all module displays and subtotals
      clearAllModuleDisplays();
      
      console.log('ğŸ”„ Wizard completely reset to initial state');
    }
    
    function clearWizardTempData() {
      try {
        let helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        if (helper.wizard_temp) {
          delete helper.wizard_temp.current_damage_center;
          console.log('ğŸ§¹ Wizard temporary data cleared');
        }
        
        // âœ… FIX: Also clear current_damage_center to prevent parts carryover
        if (helper.current_damage_center) {
          delete helper.current_damage_center;
          console.log('ğŸ§¹ Current damage center data cleared to prevent parts carryover');
        }
        
        // âœ… FIX: Clear parts search data to prevent parts aggregation across damage centers
        if (helper.parts_search) {
          delete helper.parts_search.selected_parts;
          delete helper.parts_search.unselected_parts;
          delete helper.parts_search.current_session;
          console.log('ğŸ§¹ Parts search data cleared to prevent parts carryover');
        }
        
        sessionStorage.setItem('helper', JSON.stringify(helper));
      } catch (error) {
        console.warn('Failed to clear wizard temp data:', error);
      }
    }
    
    function clearAllModuleDisplays() {
      // Clear work module displays
      const worksList = document.getElementById('worksList');
      if (worksList) worksList.innerHTML = '';
      
      const workTotalDisplay = document.getElementById('workTotalDisplay');
      if (workTotalDisplay) workTotalDisplay.style.display = 'none';
      
      const workSubtotal = document.getElementById('workSubtotal');
      if (workSubtotal) workSubtotal.style.display = 'none';
      
      // Clear parts module - reset iframe
      const partsModuleFrame = document.getElementById('partsModuleFrame');
      if (partsModuleFrame) {
        partsModuleFrame.src = partsModuleFrame.src; // Reload iframe to clear it
      }
      
      const partsSubtotal = document.getElementById('partsSubtotal');
      if (partsSubtotal) partsSubtotal.style.display = 'none';
      
      // Clear repairs module displays
      const repairsList = document.getElementById('repairsList');
      if (repairsList) repairsList.innerHTML = '';
      
      const repairTotalDisplay = document.getElementById('repairTotalDisplay');
      if (repairTotalDisplay) repairTotalDisplay.style.display = 'none';
      
      const repairsSubtotal = document.getElementById('repairsSubtotal');
      if (repairsSubtotal) repairsSubtotal.style.display = 'none';
      
      // Clear total displays
      const totalAmount = document.getElementById('totalAmount');
      if (totalAmount) totalAmount.textContent = 'â‚ª0';
      
      const totalWithoutVat = document.getElementById('totalWithoutVat');
      if (totalWithoutVat) totalWithoutVat.textContent = 'â‚ª0';
      
      const totalWithVat = document.getElementById('totalWithVat');
      if (totalWithVat) totalWithVat.textContent = 'â‚ª0';
      
      // Reset takana389 field
      const takana389Work = document.getElementById('takana389Work');
      if (takana389Work) takana389Work.value = '';
      
      console.log('âœ… All module displays cleared');
    }
    
    // âœ… ENHANCED: Set up communication with embedded modules
    function setupModuleCommunication(moduleType) {
      console.log(`ğŸ”— Setting up communication with ${moduleType} module`);
      
      // Wait for iframe to load then send comprehensive context
      setTimeout(() => {
        const iframe = document.getElementById(`${moduleType}ModuleFrame`);
        if (iframe && iframe.contentWindow) {
          const currentCenterId = damageCenterData.id || `center_${Date.now()}`;
          
          // Get current helper data
          let helper = {};
          try {
            helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
          } catch (e) {
            console.warn('Failed to parse helper data');
          }
          
          // Prepare comprehensive context based on module type
          let contextData = {
            type: 'damageCenterContext',
            damageCenterId: currentCenterId,
            damageCenter: damageCenterData,
            moduleType: moduleType,
            wizardStep: currentStep,
            helper: helper
          };
          
          // Add specific data for each module type
          switch(moduleType) {
            case 'partsSearch':
              contextData.vehicleData = helper.vehicle || {};
              contextData.existingSearches = helper.parts_search?.search_history || [];
              break;
              
            case 'parts':
              contextData.searchResults = helper.parts_search?.current_session?.results || [];
              // âœ… FIX: Only send parts from CURRENT damage center, not all centers
              const currentCenter = helper.damage_assessment?.centers?.find(center => 
                center.id === currentCenterId || center.current_center_id === currentCenterId
              );
              // âœ… FIX: Filter out empty/invalid parts and ensure proper field mapping
              const rawParts = currentCenter?.parts_items || moduleData.parts || [];
              contextData.selectedParts = rawParts
                .filter(part => 
                  part && 
                  (part.name || part.description || part.part_number || part.price > 0)
                )
                .map(part => ({
                  // âœ… Map to expected field names for parts-required iframe
                  name: part.name || part.description || part.part_name || '',
                  description: part.description || part.name || '',
                  part_number: part.part_number || part.partNumber || '',
                  price: parseFloat(part.price) || 0,
                  quantity: parseInt(part.quantity) || 1,
                  source: part.source || '',
                  // Keep original data
                  ...part
                }));
              
              // âœ… NEW: Add flag to prevent auto-adding empty fields in parts iframe
              contextData.preventAutoAddField = true;
              contextData.isEditMode = !!damageCenterData.mode;
              contextData.partsBank = window.PARTS_BANK || {};
              console.log(`ğŸ¯ Sending ${contextData.selectedParts.length} valid parts for current center ${currentCenterId} (edit mode: ${!!damageCenterData.mode})`);
              break;
              
            case 'work':
              contextData.existingWorks = moduleData.works || [];
              contextData.vehicleData = helper.vehicle || {};
              break;
              
            case 'repairs':
              contextData.existingRepairs = moduleData.repairs || [];
              contextData.damageDescription = moduleData.description || '';
              break;
          }
          
          // âœ… NEW: Add edit mode flag to inform iframes they should recalculate totals
          if (damageCenterData.mode === 'edit_existing') {
            contextData.editMode = true;
            contextData.shouldRecalculateTotals = true;
            console.log(`ğŸ“ Informing ${moduleType} iframe that it's in EDIT MODE and should recalculate totals`);
          }
          
          // Send enhanced context to the module
          iframe.contentWindow.postMessage(contextData, '*');
          
          console.log(`ğŸ“¤ Sent enhanced context to ${moduleType} module:`, {
            centerId: currentCenterId,
            step: currentStep,
            dataKeys: Object.keys(contextData),
            editMode: contextData.editMode
          });
          
          // âœ… NEW: In edit mode, request immediate totals recalculation from iframe
          if (contextData.editMode) {
            setTimeout(() => {
              iframe.contentWindow.postMessage({
                type: 'requestTotalsRecalculation',
                reason: 'edit_mode_load',
                respondWithTotals: true,
                moduleType: moduleType
              }, '*');
              console.log(`ğŸ§® Requested totals recalculation from ${moduleType} iframe in edit mode`);
            }, 500);
            
            // âœ… Also request current totals immediately
            setTimeout(() => {
              iframe.contentWindow.postMessage({
                type: 'requestCurrentTotals',
                moduleType: moduleType,
                reason: 'wizard_sync'
              }, '*');
              console.log(`ğŸ“Š Requested current totals from ${moduleType} iframe for wizard sync`);
            }, 1000);
            
            // âœ… SPECIFIC FIX: Tell parts-required iframe not to auto-add empty fields
            if (moduleType === 'parts') {
              setTimeout(() => {
                iframe.contentWindow.postMessage({
                  type: 'preventAutoAddField',
                  reason: 'edit_mode_with_existing_data',
                  hasExistingData: contextData.selectedParts && contextData.selectedParts.length > 0
                }, '*');
                console.log(`ğŸš« Told parts iframe to prevent auto-adding empty fields (has ${contextData.selectedParts.length} existing parts)`);
              }, 300);
            }
          }
        }
      }, 1500); // Increased timeout for better reliability
    }
    
    // Enhanced communication with embedded modules
    window.addEventListener('message', function(event) {
      console.log('ğŸ“¨ Received message from module:', event.data);
      
      switch(event.data.type) {
        case 'moduleUpdate':
          handleModuleUpdate(event.data);
          break;
        case 'moduleReady':
          handleModuleReady(event.data);
          break;
        case 'dataUpdate':
          handleDataUpdate(event.data);
          break;
        case 'partsSearchResults':
          handlePartsSearchResults(event.data);
          break;
        case 'partsSelectionUpdate':
          handlePartsSelectionUpdate(event.data);
          break;
        case 'moduleError':
          handleModuleError(event.data);
          break;
        case 'totalsUpdate':
          handleTotalsUpdate(event.data);
          break;
        case 'iframeTotalsCalculated':
          handleIframeTotalsCalculated(event.data);
          break;
      }
    });
    
    function handleModuleReady(data) {
      console.log(`âœ… Module ${data.module} is ready`);
      
      // Send current damage center data to the module
      const currentCenterId = damageCenterData.id || window.helper?.damage_centers?.current_center_id;
      const iframe = document.getElementById(`${data.module}ModuleFrame`);
      
      if (iframe && iframe.contentWindow) {
        iframe.contentWindow.postMessage({
          type: 'damageCenterData',
          damageCenterId: currentCenterId,
          damageCenter: damageCenterData
        }, '*');
      }
    }
    
    function handleModuleUpdate(data) {
      console.log(`ğŸ”„ Updating ${data.module} subtotal:`, data.total);
      
      switch(data.module) {
        case 'work':
          updateWorkSubtotal(data.total);
          // Save work items to damage center
          if (data.items && currentDamageCenterId) {
            data.items.forEach(item => {
              window.addWorkToDamageCenter(currentDamageCenterId, item);
            });
          }
          break;
        case 'parts':
          updatePartsSubtotal(data.total);
          // Save parts items to damage center
          if (data.items && currentDamageCenterId) {
            data.items.forEach(item => {
              window.addPartToDamageCenter(currentDamageCenterId, item);
            });
          }
          break;
        case 'repairs':
          updateRepairsSubtotal(data.total);
          // Save repair items to damage center
          if (data.items && currentDamageCenterId) {
            data.items.forEach(item => {
              window.addRepairToDamageCenter(currentDamageCenterId, item);
            });
          }
          break;
      }
      
      // Recalculate damage center totals
      if (typeof window.calculateDamageCenterTotals === 'function' && currentDamageCenterId) {
        window.calculateDamageCenterTotals(currentDamageCenterId);
      }
    }
    
    function handleDataUpdate(data) {
      console.log(`ğŸ’¾ Saving ${data.module} data:`, data);
      
      // Update damage center data based on module updates
      if (data.damageCenterId && data.items) {
        const center = window.getDamageCenter(data.damageCenterId);
        if (center) {
          switch(data.module) {
            case 'work':
              center.work_items = data.items;
              break;
            case 'parts':
              center.parts_items = data.items;
              break;
            case 'repairs':
              center.repairs_items = data.items;
              break;
          }
          
          // Recalculate totals
          window.calculateDamageCenterTotals(data.damageCenterId);
        }
      }
    }
    
    function updateWorkSubtotal(total) {
      console.log(`ğŸ’° DEBUG: updateWorkSubtotal called with total: ${total}`);
      
      // âœ… DAMAGE CENTERS FIX: Ensure total is a valid number
      const validTotal = (typeof total === 'number' && !isNaN(total)) ? total : 0;
      console.log(`ğŸ’° DEBUG: Valid total after validation: ${validTotal}`);
      
      // âœ… FIXED: Consistent VAT calculation and display updates
      const vatAmount = validTotal * (vatPercentage / 100);
      const totalWithVat = validTotal + vatAmount;
      
      const workAmount = document.getElementById('workAmount');
      const workAmountWithVat = document.getElementById('workAmountWithVat');
      
      console.log(`ğŸ’° DEBUG: workAmount element:`, workAmount);
      console.log(`ğŸ’° DEBUG: workAmountWithVat element:`, workAmountWithVat);
      
      if (workAmount) {
        workAmount.textContent = `â‚ª${validTotal.toLocaleString()}`;
        console.log(`ğŸ’° DEBUG: Set workAmount text to: â‚ª${validTotal.toLocaleString()}`);
      }
      if (workAmountWithVat) {
        workAmountWithVat.textContent = `â‚ª${totalWithVat.toLocaleString()}`;
        console.log(`ğŸ’° DEBUG: Set workAmountWithVat text to: â‚ª${totalWithVat.toLocaleString()}`);
      }
      
      // âœ… DAMAGE CENTERS FIX: Always make subtotal visible when called (it means calculation happened)
      const workSubtotal = document.getElementById('workSubtotal');
      console.log(`ğŸ’° DEBUG: workSubtotal element:`, workSubtotal);
      
      if (workSubtotal) {
        // Show if there's any valid calculation (even if 0, it means fields were processed)
        workSubtotal.style.display = 'block';
        console.log(`ğŸ’° DEBUG: Set workSubtotal display to: block (always show when calculation happens)`);
      }
      
      console.log(`ğŸ’° Work subtotal updated: â‚ª${validTotal} (with VAT: â‚ª${totalWithVat})`);
    }
    
    function updatePartsSubtotal(total) {
      // âœ… FIXED: Consistent VAT calculation and display updates
      const vatAmount = total * (vatPercentage / 100);
      const totalWithVat = total + vatAmount;
      
      const partsAmount = document.getElementById('partsAmount');
      const partsAmountWithVat = document.getElementById('partsAmountWithVat');
      
      if (partsAmount) partsAmount.textContent = `â‚ª${total.toLocaleString()}`;
      if (partsAmountWithVat) partsAmountWithVat.textContent = `â‚ª${totalWithVat.toLocaleString()}`;
      
      // Show/hide subtotal display based on amount
      const partsSubtotal = document.getElementById('partsSubtotal');
      if (partsSubtotal) {
        partsSubtotal.style.display = total > 0 ? 'block' : 'none';
      }
      
      console.log(`ğŸ”§ Parts subtotal updated: â‚ª${total} (with VAT: â‚ª${totalWithVat})`);
    }
    
    function updateRepairsSubtotal(total) {
      // âœ… FIXED: Consistent VAT calculation and display updates
      const vatAmount = total * (vatPercentage / 100);
      const totalWithVat = total + vatAmount;
      
      const repairsAmount = document.getElementById('repairsAmount');
      const repairsAmountWithVat = document.getElementById('repairsAmountWithVat');
      
      if (repairsAmount) repairsAmount.textContent = `â‚ª${total.toLocaleString()}`;
      if (repairsAmountWithVat) repairsAmountWithVat.textContent = `â‚ª${totalWithVat.toLocaleString()}`;
      
      // Show/hide subtotal display based on amount
      const repairsSubtotal = document.getElementById('repairsSubtotal');
      if (repairsSubtotal) {
        repairsSubtotal.style.display = total > 0 ? 'block' : 'none';
      }
      
      console.log(`ğŸ”¨ Repairs subtotal updated: â‚ª${total} (with VAT: â‚ª${totalWithVat})`);
    }
    
    // âœ… NEW: Handle parts search results from Step 4
    function handlePartsSearchResults(data) {
      console.log('ğŸ” Received parts search results:', data);
      
      try {
        // Store results in helper for Step 5 suggestions
        let helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        if (!helper.parts_search) {
          helper.parts_search = {
            selected_parts: [],
            unselected_parts: [],
            current_session: { results: [] },
            search_history: []
          };
        }
        
        // Store search results
        helper.parts_search.current_session = {
          results: data.results || [],
          search_query: data.query || '',
          timestamp: new Date().toISOString(),
          search_count: data.results?.length || 0
        };
        
        // Add to search history
        helper.parts_search.search_history.push({
          timestamp: new Date().toISOString(),
          query: data.query || '',
          results_count: data.results?.length || 0,
          damage_center_context: damageCenterData.number
        });
        
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        // Update search results info display
        const searchResultsInfo = document.getElementById('searchResultsInfo');
        const searchResultsCount = document.getElementById('searchResultsCount');
        
        if (searchResultsInfo && searchResultsCount) {
          const resultCount = data.results?.length || 0;
          searchResultsCount.textContent = `${resultCount} ×—×œ×¤×™× × ××¦××•`;
          searchResultsInfo.style.display = 'block';
        }
        
        console.log(`âœ… Stored ${data.results?.length || 0} parts search results in helper`);
        
      } catch (error) {
        console.error('âŒ Failed to store parts search results:', error);
      }
    }
    
    // âœ… NEW: Handle parts selection updates from Step 5  
    function handlePartsSelectionUpdate(data) {
      console.log('ğŸ”§ Received parts selection update:', data);
      
      try {
        // Update moduleData with selected parts
        moduleData.parts = data.selectedParts || [];
        
        // Store in helper
        let helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        if (helper.parts_search) {
          helper.parts_search.selected_parts = data.selectedParts || [];
          helper.parts_search.unselected_parts = data.unselectedParts || [];
        }
        
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        // âœ… CRITICAL FIX: Update current damage center with selected parts
        if (damageCenterData.id && typeof window.updateDamageCenter === 'function') {
          const selectedPartsData = {
            selected_parts: data.selectedParts || [],
            unselected_parts: data.unselectedParts || [],
            parts_selection_timestamp: new Date().toISOString(),
            parts_selection_total: data.total || 0,
            parts_source: 'wizard_step_5_selection',
            meta: {
              last_step: 5
            }
          };
          
          window.updateDamageCenter(damageCenterData.id, selectedPartsData);
          console.log(`âœ… Updated damage center ${damageCenterData.id} with ${data.selectedParts?.length || 0} selected parts`);
        } else {
          console.warn('âš ï¸ Cannot update damage center: missing ID or updateDamageCenter function');
        }
        
        // Update wizard totals
        calculateTotals();
        
        console.log(`âœ… Updated parts selection: ${data.selectedParts?.length || 0} selected, ${data.unselectedParts?.length || 0} unselected`);
        
      } catch (error) {
        console.error('âŒ Failed to update parts selection:', error);
      }
    }
    
    // âœ… NEW: Handle iframe totals updates
    function handleTotalsUpdate(data) {
      console.log('ğŸ§® Received totals update from iframe:', data);
      
      try {
        // Update moduleData with the iframe's calculated totals
        if (data.moduleType === 'parts' && data.total !== undefined) {
          console.log(`ğŸ”§ Updating parts total from iframe: â‚ª${data.total}`);
          // Update parts total in wizard display
          const partsAmount = document.getElementById('partsAmount');
          const partsAmountWithVat = document.getElementById('partsAmountWithVat');
          if (partsAmount) partsAmount.textContent = `â‚ª${data.total.toLocaleString()}`;
          const vatRate = (helper.calculations && helper.calculations.vat_rate) ? helper.calculations.vat_rate : 18;
          if (partsAmountWithVat) partsAmountWithVat.textContent = `â‚ª${(data.total * (1 + vatRate / 100)).toLocaleString()}`;
          
          // Update parts display visibility
          const partsSubtotal = document.getElementById('partsSubtotal');
          if (partsSubtotal) partsSubtotal.style.display = data.total > 0 ? 'block' : 'none';
        }
        
        if (data.moduleType === 'repairs' && data.total !== undefined) {
          console.log(`âš™ï¸ Updating repairs total from iframe: â‚ª${data.total}`);
          // Update repairs total in wizard display
          const repairsAmount = document.getElementById('repairsAmount');
          const repairsAmountWithVat = document.getElementById('repairsAmountWithVat');
          if (repairsAmount) repairsAmount.textContent = `â‚ª${data.total.toLocaleString()}`;
          const vatRate = (helper.calculations && helper.calculations.vat_rate) ? helper.calculations.vat_rate : 18;
          if (repairsAmountWithVat) repairsAmountWithVat.textContent = `â‚ª${(data.total * (1 + vatRate / 100)).toLocaleString()}`;
          
          // Update repairs display visibility
          const repairsSubtotal = document.getElementById('repairsSubtotal');
          if (repairsSubtotal) repairsSubtotal.style.display = data.total > 0 ? 'block' : 'none';
        }
        
        if (data.moduleType === 'works' && data.total !== undefined) {
          console.log(`ğŸ”¨ Updating works total from iframe: â‚ª${data.total}`);
          // Update works total in wizard display
          const worksAmount = document.getElementById('worksAmount');
          const worksAmountWithVat = document.getElementById('worksAmountWithVat');
          if (worksAmount) worksAmount.textContent = `â‚ª${data.total.toLocaleString()}`;
          const vatRate = (helper.calculations && helper.calculations.vat_rate) ? helper.calculations.vat_rate : 18;
          if (worksAmountWithVat) worksAmountWithVat.textContent = `â‚ª${(data.total * (1 + vatRate / 100)).toLocaleString()}`;
          
          // Update works display visibility
          const worksSubtotal = document.getElementById('worksSubtotal');
          if (worksSubtotal) worksSubtotal.style.display = data.total > 0 ? 'block' : 'none';
        }
        
        // Trigger main totals recalculation
        setTimeout(() => {
          calculateTotals();
        }, 100);
        
      } catch (error) {
        console.error('âŒ Failed to handle totals update:', error);
      }
    }
    
    // âœ… NEW: Handle iframe totals calculated event
    function handleIframeTotalsCalculated(data) {
      console.log('ğŸ§® Iframe finished calculating totals:', data);
      
      if (data.parts && data.parts.total !== undefined) {
        // Update moduleData.parts with actual total
        moduleData.parts = moduleData.parts || [];
        console.log(`ğŸ”§ Parts iframe calculated total: â‚ª${data.parts.total}`);
      }
      
      if (data.repairs && data.repairs.total !== undefined) {
        // Update moduleData.repairs with actual total
        moduleData.repairs = moduleData.repairs || [];
        console.log(`âš™ï¸ Repairs iframe calculated total: â‚ª${data.repairs.total}`);
      }
      
      if (data.works && data.works.total !== undefined) {
        // Update moduleData.works with actual total
        moduleData.works = moduleData.works || [];
        console.log(`ğŸ”¨ Works iframe calculated total: â‚ª${data.works.total}`);
      }
      
      // Force wizard totals recalculation with iframe data
      setTimeout(() => {
        calculateTotals();
      }, 200);
    }
    
    // âœ… ENHANCED: Handle module errors with better user feedback
    function handleModuleError(data) {
      console.error(`âŒ Module error in ${data.module}:`, data.error);
      
      // Map module names to Hebrew
      const moduleNames = {
        work: '×¢×‘×•×“×•×ª',
        parts: '×—×œ×¤×™×',
        parts_search: '×—×™×¤×•×© ×—×œ×¤×™×',
        repairs: '×ª×™×§×•× ×™×'
      };
      
      const moduleName = moduleNames[data.module] || data.module;
      const errorMsg = data.userMessage || `×©×’×™××” ×‘××•×“×•×œ ${moduleName}`;
      
      // Show enhanced error notification with recovery suggestions
      showUserNotification(`${errorMsg}. ×× × ×¨×¢× ×Ÿ ××ª ×”×“×£ ×•× ×¡×” ×©×•×‘.`, 'error', 8000);
      
      // Hide any loading states for this module
      hideLoadingState(data.module + 'Module');
      
      // Log detailed error for debugging
      if (data.error && typeof data.error === 'object') {
        console.error('Detailed error:', {
          module: data.module,
          message: data.error.message,
          stack: data.error.stack,
          timestamp: new Date().toISOString()
        });
      }
    }

    // âœ… NEW: Clear helper data functionality
    function populateExistingDamageCenters(forceRefresh = false) {
      console.log(`ğŸ” Populating existing damage centers dropdown (forceRefresh: ${forceRefresh})`);
      
      const select = document.getElementById('existingDamageCenterSelect');
      if (!select) {
        console.log('âŒ existingDamageCenterSelect element not found');
        return;
      }
      
      // Clear existing options except the first one
      select.innerHTML = '<option value="">×‘×—×¨ ××•×§×“ ×§×™×™× ×œ×¢×¨×™×›×”</option>';
      
      try {
        // âœ… ENHANCED: Try multiple sources for helper data
        let helperString = sessionStorage.getItem('helper');
        
        // If no data in sessionStorage, try localStorage
        if (!helperString) {
          helperString = localStorage.getItem('helper');
          console.log('ğŸ’¾ Trying localStorage for helper data');
        }
        
        // Try global helper if available
        if (!helperString && typeof window.helper === 'object') {
          helperString = JSON.stringify(window.helper);
          console.log('ğŸŒ Using global window.helper');
        }
        
        if (!helperString) {
          console.log('âŒ No helper data found in any storage location');
          return;
        }
        
        const helper = JSON.parse(helperString);
        console.log('ğŸ“Š Helper data parsed successfully, keys:', Object.keys(helper));
        let damageCenters = [];
        let dataSource = '';
        
        // âœ… FIXED: Use unified getDamageCentersFromHelper function instead of duplicating logic
        console.log('ğŸ” Using getDamageCentersFromHelper to find damage centers...');
        
        damageCenters = getDamageCentersFromHelper();
        if (damageCenters.length > 0) {
          dataSource = 'getDamageCentersFromHelper';
          console.log('âœ… Found damage centers via getDamageCentersFromHelper:', damageCenters.length);
        } else {
          console.log('âŒ No damage centers found via getDamageCentersFromHelper');
        }
        
        console.log(`ğŸ“Š Found ${damageCenters.length} damage centers in ${dataSource}`);
        
        if (damageCenters.length === 0) {
          // Add option to indicate no damage centers
          const option = document.createElement('option');
          option.value = '';
          option.textContent = '××™×Ÿ ××•×§×“×™ × ×–×§ ×§×™×™××™×';
          option.disabled = true;
          select.appendChild(option);
          console.log('âŒ No damage centers found in helper data');
          return;
        }
        
        // âœ… ENHANCED: Robust option creation for damage centers
        damageCenters.forEach((center, index) => {
          
          const option = document.createElement('option');
          // FIXED: Use damage center number as value since it's more reliable
          const centerNumber = center["Damage center Number"] || (index + 1).toString();
          option.value = centerNumber;
          
          
          // âœ… IMPROVED: More flexible property detection for option text
          let optionText = '';
          
          // âœ… FIXED: Use correct field name per documentation  
          optionText = `××•×§×“ ${centerNumber}`;
          
          // âœ… FIXED: Use correct field name per documentation
          const centerLocation = center.Location || center.location;
          if (centerLocation && centerLocation !== '××™×§×•× ×œ× ×¦×•×™×Ÿ') {
            optionText += ` - ${centerLocation}`;
          }
          
          // Add description preview if available
          const description = center.Description || center.description || center.damage_description;
          if (description && description !== '×ª×™××•×¨ ×œ× ×¦×•×™×Ÿ') {
            const preview = description.substring(0, 30);
            optionText += ` (${preview}${description.length > 30 ? '...' : ''})`;
          }
          
          // Add work/parts/repairs count summary - FIXED: Use correct field names per documentation
          const workCount = center.Works?.works?.length || center.work_items?.length || 0;
          const partsCount = center.Parts?.parts_required?.length || center.parts_items?.length || 0;
          const repairsCount = center.Repairs?.repairs?.length || center.repairs_items?.length || 0;
          const totalItems = workCount + partsCount + repairsCount;
          
          if (totalItems > 0) {
            optionText += ` [${totalItems} ×¤×¨×™×˜×™×]`;
          }
          
          // Add total cost if available - FIXED: Use correct field names per documentation
          const totalCost = center.Summary?.["Total with VAT"] || center.calculations?.total_with_vat || center.totals?.total || 0;
          if (totalCost > 0) {
            optionText += ` - â‚ª${totalCost.toLocaleString()}`;
          }
          
          option.textContent = optionText;
          select.appendChild(option);
          
        });
        
        // âœ… NEW: Also populate the visual existing centers display
        updateExistingCentersDisplay(damageCenters);
        
      } catch (error) {
        console.error('âŒ Error populating damage centers:', error);
        
        // Add error option
        const option = document.createElement('option');
        option.value = '';
        option.textContent = '×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×';
        option.disabled = true;
        select.appendChild(option);
      }
    }
    
    function clearDamageCenterData() {
      console.log('ğŸ—‘ï¸ Starting damage center deletion process');
      
      const select = document.getElementById('existingDamageCenterSelect');
      const selectedValue = select.value;
      
      console.log('ğŸ—‘ï¸ Delete damage center requested, selectedValue:', selectedValue, typeof selectedValue);
      
      if (!selectedValue) {
        alert('×× × ×‘×—×¨ ××•×§×“ × ×–×§ ×œ××—×™×§×”');
        return;
      }
      
      if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ××•×§×“ ×”× ×–×§ ×”×–×”? ×¤×¢×•×œ×” ×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ.')) {
        return;
      }
      
      try {
        // Use the new helper API if available
        if (typeof window.deleteDamageCenter === 'function') {
          console.log('ğŸ”§ Attempting to delete damage center using helper API:', selectedValue);
          const success = window.deleteDamageCenter(selectedValue);
          console.log('ğŸ”§ Helper API delete result:', success);
          
          if (success) {
            console.log('âœ… Damage center deleted successfully using helper API');
            
            // Rebuild comprehensive damage assessment after deletion
            if (typeof window.buildComprehensiveDamageAssessment === 'function') {
              const assessment = window.buildComprehensiveDamageAssessment();
              if (assessment) {
                console.log('âœ… Rebuilt damage assessment after deletion:', assessment);
              }
            }
            
            // Get remaining centers count for user notification
            const remainingCenters = getDamageCentersFromHelper();
            const remainingCount = remainingCenters.length;
            
            alert(`âœ… ××•×§×“ ×”× ×–×§ × ××—×§ ×‘×”×¦×œ×—×”!\n\n××•×§×“×™ ×”× ×–×§ × ×•×ª×¨×• ×•×¨×•××¡×¨×• ××—×“×© ×‘×¨×¦×£: ${remainingCount} ××•×§×“×™×`);
            
            // Reset dropdown selection and refresh
            select.value = '';
            populateExistingDamageCenters(true);
            
            // Also refresh step 7 summary if we're currently viewing it
            if (currentStep === 7) {
              updateSummary();
            }
            
            // Clear wizard data if this center was being edited
            if (damageCenterData && damageCenterData.id === selectedValue) {
              resetWizard();
              
              // âœ… FIXED: Set proper number after reset
              const nextNumber = (typeof window.getNextDamageCenterNumber === 'function') 
                ? window.getNextDamageCenterNumber() 
                : (getDamageCentersFromHelper().length + 1);
              damageCenterData.number = nextNumber;
              document.getElementById('damageCenterNumber').value = nextNumber;
            }
            
            return;
          } else {
            console.log('âŒ Helper API delete failed, falling back to legacy method');
            // Don't return here - fall through to legacy method
          }
        } else {
          console.log('ğŸ”§ Helper API deleteDamageCenter not available, using legacy method');
        }
        
        // Fallback to legacy deletion method
        console.log('ğŸ”„ Using fallback deletion method');
        const helperString = sessionStorage.getItem('helper');
        if (!helperString) {
          alert('×œ× × ××¦××• × ×ª×•× ×™× ×œ××—×™×§×”');
          return;
        }
        
        const helper = JSON.parse(helperString);
        let damageCenters = [];
        try {
          damageCenters = getDamageCentersFromHelper();
          console.log('ğŸ” Available centers for deletion:', damageCenters);
        } catch (helperError) {
          console.error('âŒ Error calling getDamageCentersFromHelper for deletion:', helperError);
          throw new Error(`Failed to load damage centers for deletion: ${helperError.message}`);
        }
        
        if (damageCenters.length === 0) {
          alert('×œ× × ××¦××• ××•×§×“×™ × ×–×§ ×œ××—×™×§×”');
          return;
        }
        
        // Find the damage center to delete - FIXED: Search by number with type conversion
        const centerIndex = damageCenters.findIndex(center => {
          const centerNum = center["Damage center Number"] || center.number || center.center_number;
          console.log('ğŸ” Delete comparing center:', {
            centerNum,
            centerNumString: String(centerNum),
            selectedValue,
            selectedValueString: String(selectedValue),
            match: String(centerNum) === String(selectedValue)
          });
          return String(centerNum) === String(selectedValue);
        });
        
        if (centerIndex === -1) {
          alert('××•×§×“ ×”× ×–×§ ×”× ×‘×—×¨ ×œ× × ××¦×');
          return;
        }
        
        const centerToRemove = damageCenters[centerIndex];
        const centerNumber = centerToRemove.number || centerToRemove.center_number || (centerIndex + 1);
        const centerDescription = `××•×§×“ ${centerNumber}${centerToRemove.location ? ` - ${centerToRemove.location}` : ''}`;
        
        // Confirm deletion
        const confirmMessage = `×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”× ×ª×•× ×™× ×©×œ ${centerDescription}?\n\n×¤×¢×•×œ×” ×–×• ×ª××—×§:\nâ€¢ ×¤×¨×˜×™ ×”××•×§×“ ×•×”××™×§×•×\nâ€¢ ×ª×™××•×¨ ×”× ×–×§\nâ€¢ ×¨×©×™××ª ×¢×‘×•×“×•×ª\nâ€¢ ×¨×©×™××ª ×—×œ×¤×™×\nâ€¢ ×¨×©×™××ª ×ª×™×§×•× ×™×\nâ€¢ ×—×™×©×•×‘×™ ×¢×œ×•×™×•×ª\n\n×œ× × ×™×ª×Ÿ ×œ×‘×˜×œ ×¤×¢×•×œ×” ×–×•!`;
        
        if (!confirm(confirmMessage)) {
          return;
        }
        
        console.log(`ğŸ—‘ï¸ Removing damage center: ${centerDescription}`, centerToRemove);
        
        // Remove the damage center from the array
        damageCenters.splice(centerIndex, 1);
        
        // âœ… SEQUENTIAL RENUMBERING: Renumber remaining centers to maintain sequential order
        console.log('ğŸ”¢ Renumbering remaining damage centers sequentially (fallback method)...');
        damageCenters.forEach((center, index) => {
          const newNumber = (index + 1).toString();
          const oldNumber = center["Damage center Number"] || center.number;
          
          if (oldNumber !== newNumber) {
            console.log(`ğŸ“ Renumbering center: ${oldNumber} â†’ ${newNumber}`);
            
            // Update the damage center number field (both possible field names)
            if (center["Damage center Number"]) {
              center["Damage center Number"] = newNumber;
            }
            if (center.number) {
              center.number = newNumber;
            }
            
            // Also update any ID that includes the number (optional)
            if (center.Id && center.Id.includes(`_${oldNumber}`)) {
              center.Id = center.Id.replace(`_${oldNumber}`, `_${newNumber}`);
              console.log(`ğŸ“ Updated center ID: ${center.Id}`);
            } else if (center.id && center.id.includes(`_${oldNumber}`)) {
              center.id = center.id.replace(`_${oldNumber}`, `_${newNumber}`);
              console.log(`ğŸ“ Updated center ID: ${center.id}`);
            }
          }
        });
        
        // Update the helper with the modified array
        // Save to canonical location if it exists
        if (helper.damage_centers && Array.isArray(helper.damage_centers)) {
          helper.damage_centers = damageCenters;
        }
        // Also update legacy locations
        if (helper.damage_assessment && helper.damage_assessment.centers) {
          helper.damage_assessment.centers = damageCenters;
        }
        
        // Recalculate totals if function is available
        if (typeof window.calculateDamageCenterTotals === 'function') {
          // Recalculate total damage cost
          let totalDamage = 0;
          damageCenters.forEach(center => {
            if (center.totals && center.totals.final_total) {
              totalDamage += parseFloat(center.totals.final_total) || 0;
            } else if (center.final_total) {
              totalDamage += parseFloat(center.final_total) || 0;
            }
          });
          
          helper.damage_total = totalDamage;
        }
        
        // Update meta information
        helper.meta = helper.meta || {};
        helper.meta.last_updated = new Date().toISOString();
        helper.meta.damage_centers_count = damageCenters.length;
        helper.meta.last_data_clear = {
          timestamp: new Date().toISOString(),
          cleared_center: centerDescription,
          remaining_centers: damageCenters.length
        };
        
        // Save updated helper data
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        console.log(`âœ… Successfully removed damage center: ${centerDescription}`);
        console.log(`ğŸ“Š Remaining damage centers: ${damageCenters.length}`);
        
        // Update UI
        populateExistingDamageCenters(true);
        select.value = '';
        
        // Show success message
        alert(`âœ… × ×ª×•× ×™ ${centerDescription} × ××—×§×• ×‘×”×¦×œ×—×”!\n\n××•×§×“×™ ×”× ×–×§ × ×•×ª×¨×• ×•×¨×•××¡×¨×• ××—×“×© ×‘×¨×¦×£: ${damageCenters.length} ××•×§×“×™×`);
        
        // âœ… FIXED: Reset wizard state after deletion
        resetWizard();
        
        // âœ… FIXED: Set proper number after reset
        const nextNumber = (typeof window.getNextDamageCenterNumber === 'function') 
          ? window.getNextDamageCenterNumber() 
          : (getDamageCentersFromHelper().length + 1);
        damageCenterData.number = nextNumber;
        document.getElementById('damageCenterNumber').value = nextNumber;
        
        // Trigger helper update broadcast if available
        if (typeof window.broadcastHelperUpdate === 'function') {
          window.broadcastHelperUpdate(['damage_centers', 'damage_blocks', 'damage_assessment'], 'damage_center_cleared');
        }
        
      } catch (error) {
        console.error('âŒ Error clearing damage center data:', error);
        console.error('âŒ Delete error details:', {
          message: error.message,
          stack: error.stack,
          selectedValue,
          helperAPIAvailable: typeof window.deleteDamageCenter === 'function',
          existingCentersCount: getDamageCentersFromHelper().length
        });
        alert(`×©×’×™××” ×‘××—×™×§×ª × ×ª×•× ×™ ××•×§×“ ×”× ×–×§: ${error.message}`);
      }
    }
    
    // âœ… Initialize existing damage centers dropdown on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸš€ Damage centers wizard loaded, populating existing centers...');
      
      // Wait a bit for helper data to be available
      setTimeout(() => {
        populateExistingDamageCenters(true);
      }, 500);
      
      // Also update when helper data changes
      window.addEventListener('storage', function(e) {
        if (e.key === 'helper') {
          console.log('ğŸ”„ Helper data updated, refreshing damage centers dropdown...');
          setTimeout(() => {
            populateExistingDamageCenters(true);
          }, 100);
        }
      });
    });
    
    // âœ… NEW: Update existing centers visual display
    function updateExistingCentersDisplay(damageCenters) {
      const displayDiv = document.getElementById('existingCentersDisplay');
      const listDiv = document.getElementById('existingCentersList');
      
      if (damageCenters.length === 0) {
        displayDiv.style.display = 'none';
        return;
      }
      
      // Show the display section
      displayDiv.style.display = 'block';
      
      // Create HTML for each center
      const centersHTML = damageCenters.map((center, index) => {
        const centerNumber = center["Damage center Number"] || center.number || center.center_number || (index + 1);
        const location = center.Location || center.location || '××™×§×•× ×œ× ×¦×•×™×Ÿ';
        const description = (center.Description || center.description || center.damage_description || '').substring(0, 100);
        // Calculate cost from available data sources
        let totalCost = center.calculations?.total_with_vat || center.totals?.total || center.Summary?.["Total with VAT"] || 0;
        
        // If no precalculated total, calculate from components
        if (totalCost === 0) {
          const worksTotal = center.Works?.works_meta?.total_cost || center.Summary?.["Total works"] || 0;
          const partsTotal = center.Parts?.parts_meta?.total_cost || center.Summary?.["Total parts"] || 0;
          const repairsTotal = center.Repairs?.repairs_meta?.total_cost || center.Summary?.["Total repairs"] || 0;
          const subtotal = worksTotal + partsTotal + repairsTotal;
          const vatRate = (helper.calculations && helper.calculations.vat_rate) ? helper.calculations.vat_rate : 18;
          totalCost = subtotal > 0 ? subtotal * (1 + vatRate / 100) : 0; // Add VAT if we have costs
        }
        
        return `
          <div style="
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 12px; 
            background: #f8fafc; 
            border-radius: 8px; 
            border: 1px solid #e2e8f0;
          ">
            <div style="flex: 1;">
              <div style="font-weight: bold; color: #1e40af; margin-bottom: 4px;">
                ××•×§×“ ${centerNumber} - ${location}
              </div>
              ${description ? `<div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">${description}${description.length >= 100 ? '...' : ''}</div>` : ''}
              ${center.RepairNature ? `<div style="font-size: 12px; color: #7c3aed; margin-bottom: 4px;"><strong>××”×•×ª ×”×ª×™×§×•×Ÿ:</strong> ${center.RepairNature.length >= 80 ? center.RepairNature.substring(0, 80) + '...' : center.RepairNature}</div>` : ''}
              <div style="font-size: 12px; color: #059669; font-weight: bold;">
                ${totalCost > 0 ? `â‚ª${totalCost.toLocaleString()}` : '×œ×œ× ×¢×œ×•×ª ××ª×•×¢×“×ª'}
              </div>
            </div>
            <div style="color: #6b7280; font-size: 12px;">
              ${center.created_at || center.timestamp ? new Date(center.created_at || center.timestamp).toLocaleDateString('he-IL') : '× ×•×¦×¨ ×”×™×•×'}
            </div>
          </div>
        `;
      }).join('');
      
      listDiv.innerHTML = centersHTML;
      
      console.log(`âœ… Updated existing centers display with ${damageCenters.length} centers`);
    }
    
    // âœ… NEW: Create new damage center with sequential numbering
    function createNewDamageCenter() {
      console.log('â• Creating new damage center...');
      
      try {
        // Use the new helper API for numbering if available
        let nextNumber = 1;
        
        if (typeof window.getNextDamageCenterNumber === 'function') {
          nextNumber = window.getNextDamageCenterNumber();
          console.log('âœ… Got next damage center number using helper API:', nextNumber);
        } else {
          // Fallback to legacy method
          const existingCenters = getDamageCentersFromHelper();
          
          let highestNumber = 0;
          existingCenters.forEach(center => {
            const centerNumber = parseInt(center["Damage center Number"] || center.number || 0);
            if (centerNumber > highestNumber) {
              highestNumber = centerNumber;
            }
          });
          nextNumber = highestNumber + 1;
          console.log('âœ… Got next damage center number using fallback method:', nextNumber);
        }
        
        // âœ… FIXED: Use resetWizard to properly clear everything
        resetWizard();
        
        // Update damage center data with correct number after reset
        damageCenterData = {
          id: `center_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          number: nextNumber,
          created_at: new Date().toISOString(),
          mode: 'create_new'
        };
        
        // âœ… CRITICAL FIX: Set the number AFTER showStep(1) to prevent overwriting
        setTimeout(() => {
          document.getElementById('damageCenterNumber').value = nextNumber;
          console.log('âœ… Set damage center number in UI:', nextNumber);
        }, 100);
        
        // Show status with correct number
        updateStatusMessage(`××•×›×Ÿ ×œ×™×¦×™×¨×ª ××•×§×“ × ×–×§ ${nextNumber}`, 'success');
        
        console.log(`âœ… Ready to create damage center ${nextNumber}`);
        
      } catch (error) {
        console.error('âŒ Error creating new damage center:', error);
        alert('×©×’×™××” ×‘×™×¦×™×¨×ª ××•×§×“ × ×–×§ ×—×“×©');
      }
    }
    
    // âœ… NEW: Handle existing center selection change
    function handleExistingCenterSelection() {
      const select = document.getElementById('existingDamageCenterSelect');
      const selectedValue = select.value;
      
      if (selectedValue) {
        console.log('ğŸ” Selected existing center for edit:', selectedValue);
        updateStatusMessage('××•×§×“ × ×–×§ × ×‘×—×¨ - ×œ×—×¥ "×¢×¨×•×š" ×œ×¢×¨×™×›×”', 'info');
      } else {
        updateStatusMessage('', 'hidden');
      }
    }
    
    // âœ… NEW: Edit selected damage center
    function editSelectedDamageCenter() {
      const select = document.getElementById('existingDamageCenterSelect');
      const selectedValue = select.value;
      
      console.log('ğŸ”§ Edit damage center requested, selectedValue:', selectedValue, typeof selectedValue);
      
      if (!selectedValue) {
        alert('×× × ×‘×—×¨ ××•×§×“ × ×–×§ ×œ×¢×¨×™×›×”');
        return;
      }
      
      console.log('âœï¸ Loading damage center for editing:', selectedValue);
      
      try {
        // First, let's see what we have in helper
        const helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        console.log('ğŸ“Š EDIT DEBUG - Helper centers:', helper.centers);
        console.log('ğŸ“Š EDIT DEBUG - Looking for damage center number:', selectedValue);
        
        // Use the new helper API if available
        let centerToEdit = null;
        
        if (typeof window.getDamageCenterById === 'function') {
          // First try with the selected value (damage center number)
          centerToEdit = window.getDamageCenterById(selectedValue);
          console.log('ğŸ” Helper API result for damage center number:', selectedValue, '->', centerToEdit);
          
          // âœ… NEW: If not found by number, try to find by actual ID
          if (!centerToEdit) {
            console.log('ğŸ” Helper API returned null for number, trying to find by actual ID...');
            
            // Get all centers and find the one with matching number, then use its actual ID
            const allCenters = getDamageCentersFromHelper();
            console.log('ğŸ” All available centers for ID lookup:', allCenters);
            
            const centerWithMatchingNumber = allCenters.find(center => {
              const centerNum = center["Damage center Number"] || center.number || center.center_number;
              const match = String(centerNum) === String(selectedValue);
              console.log('ğŸ” Checking center for ID lookup:', {
                centerNum,
                selectedValue,
                actualId: center.Id || center.id,
                match
              });
              return match;
            });
            
            if (centerWithMatchingNumber) {
              const actualId = centerWithMatchingNumber.Id || centerWithMatchingNumber.id || centerWithMatchingNumber.center_id;
              console.log('ğŸ” Found center with matching number, trying helper API with actual ID:', actualId);
              
              if (actualId) {
                centerToEdit = window.getDamageCenterById(actualId);
                console.log('ğŸ” Helper API result with actual ID:', actualId, '->', centerToEdit);
              }
            }
          }
          
          // âœ… IMPROVED: Only show error if still null after trying both approaches
          if (!centerToEdit) {
            console.log('âŒ Helper API failed with both number and ID approaches, falling back to legacy method');
            // Fall through to legacy method instead of returning
          }
        }
        
        // âœ… If helper API didn't work, use fallback method 
        if (!centerToEdit) {
          console.log('ğŸ” Using fallback method - calling getDamageCentersFromHelper');
          let existingCenters = [];
          try {
            existingCenters = getDamageCentersFromHelper();
            console.log('ğŸ” Available centers for editing:', existingCenters);
          } catch (helperError) {
            console.error('âŒ Error calling getDamageCentersFromHelper:', helperError);
            throw new Error(`Failed to load damage centers: ${helperError.message}`);
          }
          
          // FIXED: Search by damage center number with type conversion
          centerToEdit = existingCenters.find(center => {
            const centerNum = center["Damage center Number"] || center.number || center.center_number;
            console.log('ğŸ” Comparing center:', {
              centerNum,
              centerNumString: String(centerNum),
              selectedValue,
              selectedValueString: String(selectedValue),
              match: String(centerNum) === String(selectedValue)
            });
            return centerNum && (String(centerNum) === String(selectedValue));
          });
          
          if (!centerToEdit) {
            console.log('ğŸ” SEARCH FAILED - selectedValue:', selectedValue);
            console.log('ğŸ” SEARCH FAILED - available centers:', existingCenters.map(c => ({
              index: existingCenters.indexOf(c),
              damageNumber: c["Damage center Number"],
              id: c.Id,
              centerNumber: c.number,
              centerNum: c.center_number
            })));
            alert('××•×§×“ ×”× ×–×§ ×”× ×‘×—×¨ ×œ× × ××¦×');
            return;
          }
        }
        
        // âœ… ADDITIONAL SAFETY CHECK: Final validation before using centerToEdit
        if (!centerToEdit) {
          console.error('âŒ CRITICAL: centerToEdit is null after all search methods');
          alert('×©×’×™××”: ×œ× × ×™×ª×Ÿ ×œ××¦×•× ××ª ××•×§×“ ×”× ×–×§ ×”× ×‘×—×¨');
          return;
        }
        
        // Load center data into wizard
        damageCenterData = {
          ...centerToEdit,
          mode: 'edit_existing',
          original_id: centerToEdit.Id || centerToEdit.id || centerToEdit.center_id || centerToEdit.block_id
        };
        
        // Load module data from proper structure
        moduleData = {
          location: centerToEdit.Location || centerToEdit.location,
          description: centerToEdit.Description || centerToEdit.description,
          repairNature: centerToEdit.RepairNature || centerToEdit.repairNature,
          works: centerToEdit.Works?.works || [],
          parts: centerToEdit.Parts?.parts_required || [],
          repairs: centerToEdit.Repairs?.repairs || []
        };
        
        // Fill form fields with proper field names
        document.getElementById('damageCenterNumber').value = centerToEdit["Damage center Number"] || centerToEdit.number || '';
        document.getElementById('locationSelect').value = centerToEdit.Location || centerToEdit.location || '';
        
        // Fill description and repair nature fields
        const descField = document.getElementById('damageDescription');
        if (descField) {
          descField.value = centerToEdit.Description || centerToEdit.description || '';
        }
        
        const repairField = document.getElementById('repairNature');
        if (repairField) {
          repairField.value = centerToEdit.RepairNature || centerToEdit.repairNature || '';
          console.log('âœ… Set repair nature field:', centerToEdit.RepairNature || centerToEdit.repairNature);
        }
        
        // Handle custom location
        if (centerToEdit.location === 'other' && centerToEdit.customLocation) {
          document.getElementById('otherLocationInput').value = centerToEdit.customLocation;
          document.getElementById('otherLocationGroup').style.display = 'block';
        }
        
        // Show status and start wizard
        const centerNumber = centerToEdit["Damage center Number"] || centerToEdit.number || centerToEdit.center_number || '×œ× ×–×•×”×”';
        const centerLocation = centerToEdit.Location || centerToEdit.location || '××™×§×•× ×œ× ×¦×•×™×Ÿ';
        updateStatusMessage(`×¢×•×¨×š ××•×§×“ × ×–×§ ${centerNumber} - ${centerLocation}`, 'edit');
        currentStep = 1;
        showStep(1);
        updateProgress(); // âœ… FIX: Update progress bar when loading center for editing
        
        console.log('âœ… Damage center loaded for editing:', centerToEdit);
        
        // âœ… CRITICAL FIX: Trigger total calculations after loading all data
        // This ensures that both iframe totals AND wizard page totals are calculated and displayed
        setTimeout(() => {
          console.log('ğŸ§® Recalculating totals after edit data load...');
          calculateTotals();
          
          // Also update individual module subtotals to ensure wizard displays are in sync
          const workTotal = moduleData.works.reduce((sum, work) => sum + (parseFloat(work.cost) || 0), 0);
          const partsTotal = moduleData.parts.reduce((sum, part) => sum + (parseFloat(part.price) || 0), 0);
          const repairsTotal = moduleData.repairs.reduce((sum, repair) => sum + (parseFloat(repair.cost) || 0), 0);
          
          updateModuleSubtotals(workTotal, partsTotal, repairsTotal);
          console.log('âœ… Edit mode: totals recalculated and wizard displays updated');
        }, 300);
        
      } catch (error) {
        console.error('âŒ Error loading damage center for editing:', error);
        console.error('âŒ Error details:', {
          message: error.message,
          stack: error.stack,
          selectedValue,
          helperAPIAvailable: typeof window.getDamageCenterById === 'function',
          existingCentersCount: getDamageCentersFromHelper().length
        });
        alert(`×©×’×™××” ×‘×˜×¢×™× ×ª ××•×§×“ ×”× ×–×§ ×œ×¢×¨×™×›×”: ${error.message}`);
      }
    }
    
    // âœ… NEW: Update status message
    function updateStatusMessage(message, type = 'info') {
      const statusDiv = document.getElementById('damageCenterStatus');
      const messageDiv = document.getElementById('statusMessage');
      
      if (type === 'hidden' || !message) {
        statusDiv.style.display = 'none';
        return;
      }
      
      const styles = {
        success: { bg: '#dcfce7', border: '#16a34a', color: '#15803d', icon: 'âœ…' },
        info: { bg: '#dbeafe', border: '#3b82f6', color: '#1e40af', icon: 'ğŸ’¡' },
        edit: { bg: '#fef3c7', border: '#f59e0b', color: '#92400e', icon: 'âœï¸' },
        error: { bg: '#fecaca', border: '#dc2626', color: '#991b1b', icon: 'âŒ' }
      };
      
      const style = styles[type] || styles.info;
      
      statusDiv.style.background = style.bg;
      statusDiv.style.borderColor = style.border;
      statusDiv.style.display = 'block';
      
      messageDiv.style.color = style.color;
      messageDiv.textContent = `${style.icon} ${message}`;
    }
    
    // Make functions globally available
    window.populateExistingDamageCenters = populateExistingDamageCenters;
    window.clearDamageCenterData = clearDamageCenterData;
    window.createNewDamageCenter = createNewDamageCenter;
    window.handleExistingCenterSelection = handleExistingCenterSelection;
    window.editSelectedDamageCenter = editSelectedDamageCenter;
    // âœ… LOCAL REFRESH: Function to refresh only step 7 content
    function refreshStep7Summary() {
      console.log('ğŸ”„ Manual refresh of step 7 summary requested');
      
      try {
        // Show loading indication
        const container = document.getElementById('damageCentersContainer');
        if (container) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #3b82f6;">
              <div style="display: inline-block; width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
              <p style="margin-top: 15px;">××¨×¢× ×Ÿ ×¨×©×™××ª ××•×§×“×™ × ×–×§...</p>
            </div>
          `;
        }
        
        // Force refresh from sessionStorage and update display
        setTimeout(() => {
          updateSummary();
          showUserNotification('×¨×©×™××ª ××•×§×“×™ ×”× ×–×§ ×¢×•×“×›× ×”!', 'success', 2000);
          console.log('âœ… Step 7 summary refreshed successfully');
        }, 500);
        
      } catch (error) {
        console.error('âŒ Failed to refresh step 7 summary:', error);
        showUserNotification('×©×’×™××” ×‘×¨×¢× ×•×Ÿ ×”×¨×©×™××”', 'error', 2000);
      }
    }
    
    // âœ… NEW: Local refresh functions for iframe modules
    function refreshWorksModule() {
      console.log('ğŸ”„ Refreshing works module...');
      try {
        showUserNotification('××¨×¢× ×Ÿ ××•×“×•×œ ×¢×‘×•×“×•×ª...', 'info', 1000);
        
        // Get current iframe
        const iframe = document.getElementById('workModuleFrame');
        if (iframe) {
          // Send refresh command to iframe
          iframe.contentWindow.postMessage({
            type: 'refreshModule',
            reason: 'user_request',
            moduleType: 'works'
          }, '*');
          
          // Also request current totals after refresh
          setTimeout(() => {
            iframe.contentWindow.postMessage({
              type: 'requestCurrentTotals',
              moduleType: 'works',
              reason: 'refresh_sync'
            }, '*');
          }, 500);
        }
        
        // Force display of totals (don't recalculate, just show existing)
        setTimeout(() => {
          const workTotal = moduleData.works.reduce((sum, work) => sum + (parseFloat(work.cost) || 0), 0);
          updateModuleSubtotals(workTotal, null, null);
          
          // Show the subtotal display
          const worksSubtotal = document.getElementById('workSubtotal');
          if (worksSubtotal && workTotal > 0) {
            worksSubtotal.style.display = 'block';
          }
          
          showUserNotification('××•×“×•×œ ×¢×‘×•×“×•×ª ×¢×•×“×›×Ÿ!', 'success', 2000);
        }, 1000);
        
      } catch (error) {
        console.error('âŒ Failed to refresh works module:', error);
        showUserNotification('×©×’×™××” ×‘×¨×¢× ×•×Ÿ ××•×“×•×œ ×¢×‘×•×“×•×ª', 'error', 2000);
      }
    }
    
    function refreshPartsSearchModule() {
      console.log('ğŸ”„ Refreshing parts search module...');
      try {
        showUserNotification('××¨×¢× ×Ÿ ×—×™×¤×•×© ×—×œ×¤×™×...', 'info', 1000);
        
        // Get current iframe
        const iframe = document.getElementById('partsSearchModuleFrame');
        if (iframe) {
          // Send refresh command to iframe
          iframe.contentWindow.postMessage({
            type: 'refreshModule',
            reason: 'user_request',
            moduleType: 'partsSearch'
          }, '*');
        }
        
        setTimeout(() => {
          showUserNotification('×—×™×¤×•×© ×—×œ×¤×™× ×¢×•×“×›×Ÿ!', 'success', 2000);
        }, 1000);
        
      } catch (error) {
        console.error('âŒ Failed to refresh parts search module:', error);
        showUserNotification('×©×’×™××” ×‘×¨×¢× ×•×Ÿ ×—×™×¤×•×© ×—×œ×¤×™×', 'error', 2000);
      }
    }
    
    function refreshPartsModule() {
      console.log('ğŸ”„ Refreshing parts selection module...');
      try {
        showUserNotification('××¨×¢× ×Ÿ ×‘×—×™×¨×ª ×—×œ×¤×™×...', 'info', 1000);
        
        // Get current iframe
        const iframe = document.getElementById('partsModuleFrame');
        if (iframe) {
          // Send refresh command to iframe
          iframe.contentWindow.postMessage({
            type: 'refreshModule',
            reason: 'user_request',
            moduleType: 'parts'
          }, '*');
          
          // Also request current totals and selected parts after refresh
          setTimeout(() => {
            iframe.contentWindow.postMessage({
              type: 'requestCurrentTotals',
              moduleType: 'parts',
              reason: 'refresh_sync'
            }, '*');
            iframe.contentWindow.postMessage({
              type: 'requestCurrentSelection',
              moduleType: 'parts',
              reason: 'refresh_sync'
            }, '*');
          }, 500);
        }
        
        // Force display of totals (don't recalculate, just show existing)
        setTimeout(() => {
          const partsTotal = moduleData.parts.reduce((sum, part) => sum + (parseFloat(part.price) || 0), 0);
          updateModuleSubtotals(null, partsTotal, null);
          
          // Show the subtotal display
          const partsSubtotal = document.getElementById('partsSubtotal');
          if (partsSubtotal && partsTotal > 0) {
            partsSubtotal.style.display = 'block';
          }
          
          showUserNotification('×‘×—×™×¨×ª ×—×œ×¤×™× ×¢×•×“×›× ×”!', 'success', 2000);
        }, 1000);
        
      } catch (error) {
        console.error('âŒ Failed to refresh parts module:', error);
        showUserNotification('×©×’×™××” ×‘×¨×¢× ×•×Ÿ ×‘×—×™×¨×ª ×—×œ×¤×™×', 'error', 2000);
      }
    }
    
    function refreshRepairsModule() {
      console.log('ğŸ”„ Refreshing repairs module...');
      try {
        showUserNotification('××¨×¢× ×Ÿ ××•×“×•×œ ×ª×™×§×•× ×™×...', 'info', 1000);
        
        // Get current iframe
        const iframe = document.getElementById('repairsModuleFrame');
        if (iframe) {
          // Send refresh command to iframe
          iframe.contentWindow.postMessage({
            type: 'refreshModule',
            reason: 'user_request',
            moduleType: 'repairs'
          }, '*');
          
          // Also request current totals after refresh
          setTimeout(() => {
            iframe.contentWindow.postMessage({
              type: 'requestCurrentTotals',
              moduleType: 'repairs',
              reason: 'refresh_sync'
            }, '*');
          }, 500);
        }
        
        // Force display of totals (don't recalculate, just show existing)
        setTimeout(() => {
          const repairsTotal = moduleData.repairs.reduce((sum, repair) => sum + (parseFloat(repair.cost) || 0), 0);
          updateModuleSubtotals(null, null, repairsTotal);
          
          // Show the subtotal display
          const repairsSubtotal = document.getElementById('repairsSubtotal');
          if (repairsSubtotal && repairsTotal > 0) {
            repairsSubtotal.style.display = 'block';
          }
          
          showUserNotification('××•×“×•×œ ×ª×™×§×•× ×™× ×¢×•×“×›×Ÿ!', 'success', 2000);
        }, 1000);
        
      } catch (error) {
        console.error('âŒ Failed to refresh repairs module:', error);
        showUserNotification('×©×’×™××” ×‘×¨×¢× ×•×Ÿ ××•×“×•×œ ×ª×™×§×•× ×™×', 'error', 2000);
      }
    }
    
    // Make refresh functions available globally
    window.refreshStep7Summary = refreshStep7Summary;
    window.finishAndGoToSummary = finishAndGoToSummary;
    window.refreshWorksModule = refreshWorksModule;
    window.refreshPartsSearchModule = refreshPartsSearchModule;
    window.refreshPartsModule = refreshPartsModule;
    window.refreshRepairsModule = refreshRepairsModule;
  </script>
</body>
</html>