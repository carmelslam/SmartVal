<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××©×£ ××•×§×“×™ × ×–×§ - ×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª</title>
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link rel="shortcut icon" href="https://carmelcayouf.com/wp-content/uploads/2025/04/logo-yaron.webp">
  <link rel="apple-touch-icon" href="https://carmelcayouf.com/wp-content/uploads/2025/04/logo-yaron.webp">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      direction: rtl;
      padding: 20px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .logo {
      width: 100px;
      height: auto;
      margin-bottom: 15px;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    
    .header p {
      font-size: 16px;
      opacity: 0.9;
    }
    
    .progress-bar {
      background: rgba(255,255,255,0.2);
      height: 8px;
      border-radius: 4px;
      margin-top: 20px;
      overflow: hidden;
    }
    
    .progress-fill {
      background: #10b981;
      height: 100%;
      transition: width 0.3s ease;
      width: 16.67%; /* Start with first step */
    }
    
    .wizard-content {
      padding: 40px;
    }
    
    .step {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .step.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .step-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .step-number {
      display: inline-block;
      width: 40px;
      height: 40px;
      background: #3b82f6;
      color: white;
      border-radius: 50%;
      line-height: 40px;
      font-weight: bold;
      margin-bottom: 15px;
    }
    
    .step-title {
      font-size: 24px;
      color: #1e3a8a;
      margin-bottom: 10px;
    }
    
    .step-description {
      color: #64748b;
      font-size: 16px;
    }
    
    .form-group {
      margin-bottom: 25px;
    }
    
    .form-label {
      display: block;
      font-weight: bold;
      color: #374151;
      margin-bottom: 8px;
      font-size: 16px;
    }
    
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .module-embed {
      border: 2px dashed #e5e7eb;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      background: #f9fafb;
      text-align: center;
    }
    
    .module-embed.loaded {
      border: 2px solid #10b981;
      background: white;
      padding: 0;
    }
    
    .subtotal-display {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border: 1px solid #10b981;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }
    
    .subtotal-title {
      font-size: 18px;
      font-weight: bold;
      color: #059669;
      margin-bottom: 10px;
    }
    
    .subtotal-amount {
      font-size: 24px;
      font-weight: bold;
      color: #047857;
    }
    
    .vat-info {
      font-size: 14px;
      color: #065f46;
      margin-top: 5px;
    }
    
    .navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 40px;
      padding-top: 30px;
      border-top: 1px solid #e5e7eb;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: #3b82f6;
      color: white;
    }
    
    .btn-primary:hover {
      background: #2563eb;
    }
    
    .btn-secondary {
      background: #6b7280;
    }
    
    .btn-success {
      background: #10b981;
      color: white;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    .btn-secondary:hover {
      background: #4b5563;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    
    .damage-center-summary {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .summary-title {
      font-size: 18px;
      font-weight: bold;
      color: #1e3a8a;
    }
    
    .summary-actions {
      display: flex;
      gap: 10px;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 14px;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 18px;
      color: #333;
      font-weight: bold;
    }
    
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        border-radius: 10px;
      }
      
      .wizard-content {
        padding: 20px;
      }
      
      .location-grid {
        grid-template-columns: 1fr;
      }
      
      .navigation {
        flex-direction: column;
        gap: 15px;
      }
      
      .btn {
        width: 100%;
      }
    }
    
    /* System-standard nav-button styling */
    .nav-button {
      background: #3b82f6;
      color: white;
      padding: 14px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      transition: all 0.3s ease;
      font-family: inherit;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .nav-button:hover {
      background: #1e3a8a;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .nav-button:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Navigation area styling */
    .navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 30px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 10px;
      border-top: 1px solid #e2e8f0;
    }
    
    #stepInfo {
      font-weight: bold;
      color: #64748b;
      font-size: 14px;
      flex: 1;
      text-align: center;
      min-width: 120px;
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .container {
        margin: 0;
        border-radius: 10px;
      }
      
      .header {
        padding: 20px 15px;
      }
      
      .header h1 {
        font-size: 22px;
      }
      
      .header p {
        font-size: 14px;
      }
      
      .logo {
        width: 80px;
      }
      
      .wizard-content {
        padding: 20px 15px;
      }
      
      .step-title {
        font-size: 20px;
      }
      
      .step-description {
        font-size: 14px;
      }
      
      .form-group {
        margin-bottom: 20px;
      }
      
      .form-label {
        font-size: 14px;
        margin-bottom: 8px;
      }
      
      .form-input, .form-select, .form-textarea {
        padding: 12px;
        font-size: 16px; /* Prevent zoom on iOS */
      }
      
      .navigation {
        flex-direction: column;
        gap: 15px;
        padding: 15px;
      }
      
      .nav-button {
        width: 100%;
        max-width: 200px;
        padding: 12px 16px;
        font-size: 14px;
      }
      
      #stepInfo {
        order: -1; /* Show step info at top on mobile */
        text-align: center;
        width: 100%;
        margin-bottom: 10px;
      }
      
      /* Module iframe mobile styling */
      .module-container iframe {
        height: 500px !important;
        border-radius: 8px !important;
      }
      
      /* Step number mobile adjustment */
      .step-number {
        width: 35px;
        height: 35px;
        line-height: 35px;
        font-size: 14px;
      }
    }
    
    @media (max-width: 480px) {
      .header {
        padding: 15px 10px;
      }
      
      .wizard-content {
        padding: 15px 10px;
      }
      
      .nav-button {
        font-size: 13px;
        padding: 10px 14px;
      }
      
      .module-container iframe {
        height: 450px !important;
      }
    }
    
    /* Enhanced damage centers mobile features */
    @media (max-width: 768px) {
      /* Better form styling for damage centers */
      .damage-center-form {
        background: #f8fafc;
        padding: 15px;
        border-radius: 12px;
        margin: 15px 0;
      }
      
      .damage-location-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 8px;
        margin: 15px 0;
      }
      
      .location-option {
        padding: 12px 8px;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
      }
      
      .location-option:hover,
      .location-option.selected {
        border-color: #3b82f6;
        background: #dbeafe;
        color: #1e40af;
      }
      
      /* Parts search enhancements */
      .parts-search-mobile {
        position: relative;
        margin: 15px 0;
      }
      
      .parts-suggestions {
        position: absolute !important;
        top: 100% !important;
        left: 0 !important;
        right: 0 !important;
        z-index: 1000 !important;
        max-height: 200px !important;
        overflow-y: auto !important;
        background: white !important;
        border: 1px solid #d1d5db !important;
        border-radius: 8px !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
      }
      
      .suggestion-item {
        padding: 12px !important;
        border-bottom: 1px solid #f3f4f6 !important;
        cursor: pointer !important;
        font-size: 14px !important;
        line-height: 1.4 !important;
      }
      
      .suggestion-item:hover {
        background: #f3f4f6 !important;
      }
      
      /* Calculation summary mobile styling */
      .calculation-summary {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 15px;
        border-radius: 12px;
        margin: 20px 0;
        text-align: center;
      }
      
      .calculation-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255,255,255,0.2);
      }
      
      .calculation-row:last-child {
        border-bottom: none;
        font-weight: bold;
        font-size: 18px;
        margin-top: 8px;
        padding-top: 12px;
        border-top: 1px solid rgba(255,255,255,0.3);
      }
      
      /* Touch-friendly buttons */
      .mobile-action-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin: 20px 0;
      }
      
      .mobile-btn {
        padding: 15px 12px;
        border: none;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
        min-height: 48px; /* Apple's minimum touch target */
      }
      
      .mobile-btn-primary {
        background: #3b82f6;
        color: white;
      }
      
      .mobile-btn-secondary {
        background: #f1f5f9;
        color: #475569;
        border: 1px solid #e2e8f0;
      }
      
      .mobile-btn:active {
        transform: scale(0.98);
      }
      
      /* Floating action button for quick actions */
      .floating-actions {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 100;
      }
      
      .fab {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: #3b82f6;
        color: white;
        border: none;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        transition: all 0.2s;
      }
      
      .fab:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
      }
    }
    
    /* Internal browser integration fixes */
    .internal-browser-container {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .parts-search-browser {
      width: 100%;
      min-height: 500px;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      background: white;
    }
    
    /* Ensure all external links open in internal browser */
    .force-internal-browser {
      cursor: pointer;
      color: #3b82f6;
      text-decoration: underline;
    }
    
    .force-internal-browser:hover {
      color: #1e40af;
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">×˜×•×¢×Ÿ ××©×£ ××•×§×“×™ × ×–×§...</div>
  </div>
  
  <div class="container">
    <div class="header">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª" class="logo">
      <h1>××©×£ ××•×§×“×™ × ×–×§</h1>
      <p>××¢×¨×›×ª ××ª×§×“××ª ×œ× ×™×”×•×œ ×•× ×™×ª×•×— ××•×§×“×™ × ×–×§</p>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>
    
    <div class="wizard-content">
      
      <!-- Step 1: Damage Center Number & Location -->
      <div class="step active" id="step1">
        <div class="step-header">
          <div class="step-number">1</div>
          <h2 class="step-title">××¡×¤×¨ ×•××™×§×•× ××•×§×“ ×”× ×–×§</h2>
          <p class="step-description">×”×’×“×¨×ª ××¡×¤×¨ ××•×§×“ ×”× ×–×§ ×•×‘×—×™×¨×ª ××™×§×•× ×”× ×–×§ ×‘×¨×›×‘</p>
        </div>

        <!-- âœ… NEW: Clear Helper Data Option -->
        <div class="data-management-section" style="margin-bottom: 25px; padding: 15px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 10px; border: 1px solid #f59e0b;">
          <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
            <div style="flex: 1; min-width: 200px;">
              <h4 style="color: #92400e; margin: 0 0 5px 0; font-size: 16px;">ğŸ—‚ï¸ × ×™×”×•×œ × ×ª×•× ×™ ××•×§×“×™ × ×–×§ ×§×™×™××™×</h4>
              <p style="color: #a16207; margin: 0; font-size: 14px;">× ×™×ª×Ÿ ×œ× ×§×•×ª × ×ª×•× ×™× ×©×œ ××•×§×“ × ×–×§ ×§×™×™× ×›×“×™ ×œ×”×ª×—×™×œ ××—×“×©</p>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
              <select id="existingDamageCenterSelect" style="
                padding: 8px 12px; 
                border: 1px solid #d97706; 
                border-radius: 6px; 
                background: white;
                color: #92400e;
                font-size: 14px;
                min-width: 150px;
              ">
                <option value="">×‘×—×¨ ××•×§×“ × ×–×§ ×œ× ×™×§×•×™</option>
              </select>
              <button type="button" onclick="clearDamageCenterData()" style="
                background: #dc2626; 
                color: white; 
                border: none; 
                padding: 8px 16px; 
                border-radius: 6px; 
                cursor: pointer; 
                font-weight: bold;
                font-size: 14px;
                transition: background 0.3s ease;
              " 
              onmouseover="this.style.background='#b91c1c'" 
              onmouseout="this.style.background='#dc2626'">
                ğŸ—‘ï¸ × ×§×” × ×ª×•× ×™×
              </button>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">××¡×¤×¨ ××•×§×“ × ×–×§</label>
          <input type="text" class="form-input" id="damageCenterNumber" readonly>
        </div>
        
        <div class="form-group">
          <label class="form-label">×‘×—×¨ ××™×§×•× ×”× ×–×§</label>
          <select class="form-select" id="locationSelect" onchange="handleLocationChange()">
            <option value="">×‘×—×¨ ××™×§×•× × ×–×§</option>
            <!-- Location options will be populated dynamically -->
          </select>
        </div>
        
        <div class="form-group" id="otherLocationGroup" style="display: none;">
          <label class="form-label">×¤×¨×˜ ××™×§×•× ××—×¨</label>
          <input type="text" class="form-input" id="otherLocationInput" placeholder="×”×›× ×¡ ××™×§×•× × ×–×§ ××•×ª×× ××™×©×™×ª..." onchange="updateOtherLocation()">
        </div>
      </div>
      
      <!-- Step 2: Damage Description -->
      <div class="step" id="step2">
        <div class="step-header">
          <div class="step-number">2</div>
          <h2 class="step-title">×ª×™××•×¨ ×”× ×–×§</h2>
          <p class="step-description">×ª×™××•×¨ ××¤×•×¨×˜ ×©×œ ×”× ×–×§ ×‘××•×§×“ ×©× ×‘×—×¨</p>
        </div>
        
        <div class="form-group">
          <label class="form-label">×ª×™××•×¨ ×”× ×–×§</label>
          <textarea class="form-textarea" id="damageDescription" placeholder="×ª××¨ ××ª ×”× ×–×§ ×‘×¤×™×¨×•×˜..."></textarea>
        </div>
      </div>
      
      <!-- Step 3: Work Needed -->
      <div class="step" id="step3">
        <div class="step-header">
          <div class="step-number">3</div>
          <h2 class="step-title">×¢×‘×•×“×•×ª × ×“×¨×©×•×ª</h2>
          <p class="step-description">×”×’×“×¨×ª ×”×¢×‘×•×“×•×ª ×”× ×“×¨×©×•×ª ×œ×ª×™×§×•×Ÿ ×”× ×–×§</p>
        </div>
        
        <div class="module-embed" id="workModule">
          <p>×˜×•×¢×Ÿ ××•×“×•×œ ×¢×‘×•×“×•×ª...</p>
        </div>
        
        <div class="subtotal-display" id="workSubtotal" style="display:none;">
          <div class="subtotal-title">×¡×™×›×•× ×¢×‘×•×“×•×ª</div>
          <div class="subtotal-amount" id="workAmount">â‚ª0</div>
          <div class="vat-info">×œ×œ× ××¢"× | ×›×•×œ×œ ××¢"×: <span id="workAmountWithVat">â‚ª0</span></div>
        </div>
      </div>
      
      <!-- Step 4: Parts Search -->
      <div class="step" id="step4">
        <div class="step-header">
          <div class="step-number">4</div>
          <h2 class="step-title">×—×™×¤×•×© ×—×œ×¤×™×</h2>
          <p class="step-description">×—×™×¤×•×© ××¢×¨×›×ª/car-part  ×—×™×¤×•×© ×—×œ×¤×™× : ××ª×¨</p>
        </div>
        
        <div class="module-embed" id="partsSearchModule">
          <p>×˜×•×¢×Ÿ ××•×“×•×œ ×—×™×¤×•×© ×—×œ×¤×™×...</p>
        </div>
        
        <div class="subtotal-display" id="searchResultsInfo" style="display:none;">
          <div class="subtotal-title">×ª×•×¦××•×ª ×—×™×¤×•×©</div>
          <div class="subtotal-amount" id="searchResultsCount">0 ×—×œ×¤×™× × ××¦××•</div>
          <div class="vat-info">×”×ª×•×¦××•×ª × ×©××¨×• ×œ××¢×¨×›×ª ×œ×‘×—×™×¨×” ×‘×©×œ×‘ ×”×‘×</div>
        </div>
      </div>
      
      <!-- Step 5: Parts Selection -->
      <div class="step" id="step5">
        <div class="step-header">
          <div class="step-number">5</div>
          <h2 class="step-title">×‘×—×™×¨×ª ×—×œ×¤×™×</h2>
          <p class="step-description">×‘×—×™×¨×ª ×”×—×œ×¤×™× ×”× ×“×¨×©×™× ××ª×•×¦××•×ª ×”×—×™×¤×•×©</p>
        </div>
        
        <div class="module-embed" id="partsModule">
          <p>×˜×•×¢×Ÿ ××•×“×•×œ ×‘×—×™×¨×ª ×—×œ×¤×™×...</p>
        </div>
        
        <div class="subtotal-display" id="partsSubtotal" style="display:none;">
          <div class="subtotal-title">×¡×™×›×•× ×—×œ×¤×™×</div>
          <div class="subtotal-amount" id="partsAmount">â‚ª0</div>
          <div class="vat-info">×œ×œ× ××¢"× | ×›×•×œ×œ ××¢"×: <span id="partsAmountWithVat">â‚ª0</span></div>
        </div>
      </div>
      
      <!-- Step 6: Required Repairs -->
      <div class="step" id="step6">
        <div class="step-header">
          <div class="step-number">6</div>
          <h2 class="step-title">×ª×™×§×•× ×™× × ×“×¨×©×™×</h2>
          <p class="step-description">×”×’×“×¨×ª ×”×ª×™×§×•× ×™× ×”× ×“×¨×©×™× ×•×¢×œ×•×™×•×ª×™×”×</p>
        </div>
        
        <div class="module-embed" id="repairsModule">
          <p>×˜×•×¢×Ÿ ××•×“×•×œ ×ª×™×§×•× ×™×...</p>
        </div>
        
        <div class="subtotal-display" id="repairsSubtotal" style="display:none;">
          <div class="subtotal-title">×¡×™×›×•× ×ª×™×§×•× ×™×</div>
          <div class="subtotal-amount" id="repairsAmount">â‚ª0</div>
          <div class="vat-info">×œ×œ× ××¢"× | ×›×•×œ×œ ××¢"×: <span id="repairsAmountWithVat">â‚ª0</span></div>
        </div>
      </div>
      
      <!-- Step 7: Summary -->
      <div class="step" id="step7">
        <div class="step-header">
          <div class="step-number">7</div>
          <h2 class="step-title">×¡×™×›×•× ××•×§×“ ×”× ×–×§</h2>
          <p class="step-description">×¡×™×›×•× ×›×•×œ×œ ×©×œ ×›×œ ×”×¤×¨×˜×™× ×•×”×¢×œ×•×™×•×ª</p>
        </div>
        
        <div class="damage-center-summary">
          <div class="summary-header">
            <div class="summary-title">××•×§×“ × ×–×§ ××¡×¤×¨ <span id="summaryNumber"></span></div>
          </div>
          
          <div class="form-group">
            <label class="form-label">××™×§×•×</label>
            <div id="summaryLocation"></div>
          </div>
          
          <div class="form-group">
            <label class="form-label">×ª×™××•×¨ ×”× ×–×§</label>
            <div id="summaryDescription"></div>
          </div>
          
          <div class="subtotal-display">
            <div class="subtotal-title">×¡×”"×› ××•×§×“ × ×–×§</div>
            <div class="subtotal-amount" id="totalAmount">â‚ª0</div>
            <div class="vat-info">
              ×œ×œ× ××¢"×: <span id="totalWithoutVat">â‚ª0</span> | 
              ×›×•×œ×œ ××¢"×: <span id="totalWithVat">â‚ª0</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="navigation">
        <button class="nav-button" onclick="window.location.href='selection.html'" style="background-color: #6c757d;">×—×–×•×¨ ×œ×‘×—×™×¨×”</button>
        <button class="nav-button" id="prevBtn" onclick="previousStep()" style="display:none; background-color: #6c757d;">×”×§×•×“×</button>
        <button class="nav-button" id="saveBtn" onclick="saveCurrentStep()" style="background-color: #28a745;">×©××•×¨ × ×ª×•× ×™×</button>
        <div id="stepInfo">×©×œ×‘ 1 ××ª×•×š 7</div>
        <button class="nav-button" id="nextBtn" onclick="nextStep()">×”×‘×</button>
      </div>
    </div>
  </div>
  
  <script src="helper.js"></script>
  <script type="module" src="parts.js"></script>
  <script>
    // Global wizard state and module data storage
    let moduleData = {
      works: [],
      parts: [],
      repairs: [],
      takana389: '',
      location: '',
      description: ''
    };
    
    // Listen for data from iframe modules
    window.addEventListener('message', function(event) {
      console.log('ğŸ“¨ Wizard received message:', event.data);
      
      if (event.data.type === 'moduleData') {
        const { module, data } = event.data;
        
        switch(module) {
          case 'work':
            moduleData.works = data.works || [];
            moduleData.takana389 = data.takana389 || '';
            console.log('âœ… Work data received in wizard:', moduleData.works);
            break;
            
          case 'parts':
            moduleData.parts = data.parts || [];
            console.log('âœ… Parts data received in wizard:', moduleData.parts);
            break;
            
          case 'repairs':
            moduleData.repairs = data.repairs || [];
            console.log('âœ… Repairs data received in wizard:', moduleData.repairs);
            break;
        }
        
        // Update helper with collected data
        updateHelperWithModuleData();
        
        // Recalculate totals whenever module data changes
        calculateTotals();
      }
    });
    
    function updateHelperWithModuleData() {
      try {
        let helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        // Update damage_assessment with current module data
        helper.damage_assessment = helper.damage_assessment || {};
        
        if (moduleData.works.length > 0) {
          helper.damage_assessment.works = {
            takana389: moduleData.takana389,
            work_items: moduleData.works,
            updated_at: new Date().toISOString(),
            updated_by: 'wizard_collection'
          };
        }
        
        if (moduleData.parts.length > 0) {
          helper.damage_assessment.parts = {
            parts_items: moduleData.parts,
            updated_at: new Date().toISOString(),
            updated_by: 'wizard_collection'
          };
        }
        
        if (moduleData.repairs.length > 0) {
          helper.damage_assessment.repairs = {
            repairs_items: moduleData.repairs,
            updated_at: new Date().toISOString(),
            updated_by: 'wizard_collection'
          };
        }
        
        helper.meta = helper.meta || {};
        helper.meta.last_updated = new Date().toISOString();
        
        sessionStorage.setItem('helper', JSON.stringify(helper));
        console.log('âœ… Helper updated with module data');
        
      } catch (error) {
        console.error('âŒ Failed to update helper with module data:', error);
      }
    }
    
    // Global wizard state
    let currentStep = 1;
    const totalSteps = 7; // Added one more step for parts search
    let damageCenterData = {};
    let vatPercentage = 18; // Will be loaded from system settings
    
    // Damage center locations (from advanced damage center module)
    const damageLocations = [
      '×§×“××ª ×”×¨×›×‘', '××—×•×¨×™ ×”×¨×›×‘', '×¦×“ ×™××™×Ÿ ×§×“××™', '×¦×“ ×™××™×Ÿ ××—×•×¨×™',
      '×¦×“ ×©×××œ ×§×“××™', '×¦×“ ×©×××œ ××—×•×¨×™', '×’×’ ×”×¨×›×‘', '×ª×—×ª×™×ª ×”×¨×›×‘',
      '×¤× ×™× ×§×“××™', '×¤× ×™× ××—×•×¨×™', '×× ×•×¢', '×ª× ××˜×¢×Ÿ', '×“×œ×ª×•×ª', '×—×œ×•× ×•×ª'
    ];
    
    // Initialize wizard on page load
    document.addEventListener('DOMContentLoaded', function() {
      initializeWizard();
    });
    
    function initializeWizard() {
      // Show loading
      document.getElementById('loadingOverlay').style.display = 'flex';
      
      // Generate damage center number
      generateDamageCenterNumber();
      
      // Populate location dropdown
      populateLocationDropdown();
      
      // Initialize helper system
      if (typeof window.helper !== 'undefined') {
        // Load VAT percentage from system settings
        if (window.helper.system && window.helper.system.vat_percentage) {
          vatPercentage = window.helper.system.vat_percentage;
        }
      }
      
      // Hide loading after initialization
      setTimeout(() => {
        document.getElementById('loadingOverlay').style.display = 'none';
      }, 1000);
    }
    
    function generateDamageCenterNumber() {
      // Auto-generate damage center number
      const existingCenters = getDamageCentersFromHelper();
      const nextNumber = existingCenters.length + 1;
      document.getElementById('damageCenterNumber').value = nextNumber;
      damageCenterData.number = nextNumber;
    }
    
    function populateLocationDropdown() {
      const select = document.getElementById('locationSelect');
      select.innerHTML = '<option value="">×‘×—×¨ ××™×§×•× × ×–×§</option>';
      
      damageLocations.forEach(location => {
        const option = document.createElement('option');
        option.value = location;
        option.textContent = location;
        select.appendChild(option);
      });
      
      // Add "other" option
      const otherOption = document.createElement('option');
      otherOption.value = 'other';
      otherOption.textContent = '××—×¨ (×¤×¨×˜ ×‘××§×•× ×”×‘×)';
      select.appendChild(otherOption);
    }
    
    window.handleLocationChange = function() {
      const select = document.getElementById('locationSelect');
      const otherGroup = document.getElementById('otherLocationGroup');
      const otherInput = document.getElementById('otherLocationInput');
      
      if (select.value === 'other') {
        otherGroup.style.display = 'block';
        otherInput.focus();
        damageCenterData.location = 'other';
        damageCenterData.customLocation = '';
      } else {
        otherGroup.style.display = 'none';
        otherInput.value = '';
        damageCenterData.location = select.value;
        damageCenterData.customLocation = '';
      }
    };
    
    window.updateOtherLocation = function() {
      const otherInput = document.getElementById('otherLocationInput');
      damageCenterData.customLocation = otherInput.value.trim();
    };
    
    function nextStep() {
      if (validateCurrentStep()) {
        if (currentStep < totalSteps) {
          // Save current step data
          saveCurrentStepData();
          
          // Move to next step
          currentStep++;
          showStep(currentStep);
          updateProgress();
          
          // Load module if needed
          loadStepModule(currentStep);
        } else {
          // Final step - complete damage center
          completeDamageCenter();
        }
      }
    }
    
    function previousStep() {
      if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
        updateProgress();
      }
    }
    
    function saveCurrentStep() {
      console.log('ğŸ’¾ Saving current step data to helper...');
      
      try {
        // Get current helper data
        let helper = {};
        try {
          helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        } catch (e) {
          console.warn('Failed to parse helper from sessionStorage, using empty object');
          helper = {};
        }
        
        // Initialize damage_centers structure if needed
        helper.damage_centers = helper.damage_centers || {
          centers: [],
          current_center_id: null,
          active_center_count: 0,
          totals: { all_centers_subtotal: 0, all_centers_vat: 0, all_centers_total: 0 }
        };
        
        // Save current step data based on which step we're on
        const stepData = {};
        
        switch(currentStep) {
          case 1:
            // Location and number
            const locationSelect = document.getElementById('locationSelect');
            const otherLocationInput = document.getElementById('otherLocationInput');
            stepData.location = locationSelect?.value;
            stepData.customLocation = otherLocationInput?.value;
            stepData.number = damageCenterData.number;
            break;
            
          case 2:
            // Description
            const description = document.getElementById('damageDescription');
            stepData.description = description?.value;
            break;
            
          case 3:
            // Work module - trigger actual save function in iframe
            try {
              const workIframe = document.getElementById('workModuleFrame');
              if (workIframe && workIframe.contentWindow && workIframe.contentWindow.saveWorkData) {
                workIframe.contentWindow.saveWorkData();
                stepData.work_saved = true;
                stepData.work_saved_at = new Date().toISOString();
              } else {
                console.warn('Work iframe or saveWorkData function not found');
                stepData.work_saved = false;
              }
            } catch (error) {
              console.error('Error saving work data from wizard:', error);
              stepData.work_saved = false;
            }
            stepData.stepName = 'work';
            break;
            
          case 5:
            // Parts required module - trigger actual save function in iframe
            try {
              const partsIframe = document.getElementById('partsModuleFrame');
              if (partsIframe && partsIframe.contentWindow && partsIframe.contentWindow.savePartsData) {
                partsIframe.contentWindow.savePartsData();
                stepData.parts_saved = true;
                stepData.parts_saved_at = new Date().toISOString();
              } else {
                console.warn('Parts iframe or savePartsData function not found');
                stepData.parts_saved = false;
              }
            } catch (error) {
              console.error('Error saving parts data from wizard:', error);
              stepData.parts_saved = false;
            }
            stepData.stepName = 'parts_required';
            break;
            
          case 6:
            // Repairs module - trigger actual save function in iframe
            try {
              const repairsIframe = document.getElementById('repairsModuleFrame');
              if (repairsIframe && repairsIframe.contentWindow && repairsIframe.contentWindow.saveRepairsData) {
                repairsIframe.contentWindow.saveRepairsData();
                stepData.repairs_saved = true;
                stepData.repairs_saved_at = new Date().toISOString();
              } else {
                console.warn('Repairs iframe or saveRepairsData function not found');
                stepData.repairs_saved = false;
              }
            } catch (error) {
              console.error('Error saving repairs data from wizard:', error);
              stepData.repairs_saved = false;
            }
            stepData.stepName = 'repairs';
            break;
            
          default:
            // Other steps or parts search
            stepData.currentStep = currentStep;
            stepData.stepName = ['', 'location', 'description', 'work', 'parts_search', 'parts_required', 'repairs'][currentStep];
            break;
        }
        
        // Update damage center data in helper
        if (!helper.damage_centers.current_center_id) {
          helper.damage_centers.current_center_id = damageCenterData.id || `center_${Date.now()}`;
        }
        
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        console.log('âœ… Step data saved to helper:', stepData);
        
        // Show save confirmation
        const saveBtn = document.getElementById('saveBtn');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = 'âœ… × ×©××¨';
        saveBtn.style.background = '#059669';
        
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.style.background = '#10b981';
        }, 2000);
        
        // Trigger helper update broadcast if available
        if (typeof window.broadcastHelperUpdate === 'function') {
          window.broadcastHelperUpdate(['damage_centers'], 'damage_center_wizard');
        }
        
      } catch (error) {
        console.error('âŒ Failed to save step data to helper:', error);
        
        // Show error state
        const saveBtn = document.getElementById('saveBtn');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = 'âŒ ×©×’×™××”';
        saveBtn.style.background = '#dc2626';
        
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.style.background = '#10b981';
        }, 3000);
        
        alert('×©×’×™××” ×‘×©××™×¨×ª ×”× ×ª×•× ×™×');
      }
    }
    
    function showStep(step) {
      // Hide all steps
      document.querySelectorAll('.step').forEach(stepEl => {
        stepEl.classList.remove('active');
      });
      
      // Show current step
      document.getElementById(`step${step}`).classList.add('active');
      
      // Update navigation
      updateNavigation();
      
      // Update step info
      document.getElementById('stepInfo').textContent = `×©×œ×‘ ${step} ××ª×•×š ${totalSteps}`;
    }
    
    function updateNavigation() {
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      
      // Show/hide previous button
      prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
      
      // Update next button text
      if (currentStep === totalSteps) {
        nextBtn.textContent = '×¡×™×™× ××•×§×“ × ×–×§';
        nextBtn.className = 'btn btn-success';
      } else {
        nextBtn.textContent = '×”×‘×';
        nextBtn.className = 'btn btn-primary';
      }
    }
    
    function updateProgress() {
      const progressFill = document.getElementById('progressFill');
      const percentage = (currentStep / totalSteps) * 100;
      progressFill.style.width = `${percentage}%`;
      
      // Update step info
      document.getElementById('stepInfo').textContent = `×©×œ×‘ ${currentStep} ××ª×•×š ${totalSteps}`;
      
      // Update navigation buttons
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      
      // Show/hide previous button
      if (currentStep === 1) {
        prevBtn.style.display = 'none';
      } else {
        prevBtn.style.display = 'inline-block';
      }
      
      // Update next button text for final step
      if (currentStep === totalSteps) {
        nextBtn.textContent = '×¡×™×•× ×•××¢×‘×¨ ×œ×¡×™×›×•× ××§×¡×¤×¨×˜×™×–×”';
        nextBtn.style.background = '#059669'; // Green for completion
      } else {
        nextBtn.textContent = '×”×‘×';
        nextBtn.style.background = '#3b82f6'; // Default blue
      }
    }
    
    function loadStepModule(step) {
      switch(step) {
        case 3:
          loadWorkModule();
          break;
        case 4:
          loadPartsSearchModule();
          break;
        case 5:
          loadPartsModule();
          break;
        case 6:
          loadRepairsModule();
          break;
        case 7:
          updateSummary();
          break;
      }
    }
    
    function loadPartsSearchModule() {
      const moduleContainer = document.getElementById('partsSearchModule');
      
      // Use existing parts search module
      moduleContainer.innerHTML = `<iframe src="parts search.html" style="width:100%; height:600px; border:none; border-radius:10px;" id="partsSearchModuleFrame"></iframe>`;
      moduleContainer.classList.add('loaded');
      
      // Show search results info
      document.getElementById('searchResultsInfo').style.display = 'block';
      
      // Set up communication with parts search module
      setupModuleCommunication('partsSearch');
    }
    
    function validateCurrentStep() {
      switch(currentStep) {
        case 1:
          const locationSelect = document.getElementById('locationSelect');
          const otherLocationInput = document.getElementById('otherLocationInput');
          
          if (!locationSelect.value) {
            alert('×× × ×‘×—×¨ ××™×§×•× × ×–×§');
            return false;
          }
          
          if (locationSelect.value === 'other' && !otherLocationInput.value.trim()) {
            alert('×× × ×”×–×Ÿ ××™×§×•× × ×–×§ ××•×ª×× ××™×©×™×ª');
            return false;
          }
          break;
        case 2:
          const description = document.getElementById('damageDescription').value.trim();
          if (!description) {
            alert('×× × ×”×–×Ÿ ×ª×™××•×¨ × ×–×§');
            return false;
          }
          break;
      }
      return true;
    }
    
    function saveCurrentStepData() {
      console.log('ğŸ’¾ Saving step data for step:', currentStep);
      
      // Get current helper data
      let helper = {};
      try {
        helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      } catch (e) {
        helper = {};
      }
      
      // No need for wizard temporary data - using simple damage_blocks structure
      
      switch(currentStep) {
        case 1:
          // Save location data
          const locationSelect = document.getElementById('locationSelect');
          const otherLocationInput = document.getElementById('otherLocationInput');
          const location = locationSelect?.value === '××—×¨' ? otherLocationInput?.value : locationSelect?.value;
          
          // Location saved directly to moduleData
          moduleData.location = location;
          damageCenterData.location = location;
          console.log('âœ… Location saved:', location);
          break;
          
        case 2:
          // Save description
          const description = document.getElementById('damageDescription')?.value?.trim();
          // Description saved directly to moduleData
          moduleData.description = description;
          damageCenterData.description = description;
          console.log('âœ… Description saved:', description);
          break;
          
        case 3:
          // Work data is handled by work.html module
          console.log('âœ… Work step - data handled by work module');
          break;
          
        case 4:
          // Parts search data is handled by parts search module
          console.log('âœ… Parts search step - data handled by parts search module');
          break;
          
        case 5:
          // Parts required data is handled by parts-required.html module
          console.log('âœ… Parts required step - data handled by parts required module');
          break;
          
        case 6:
          // Repairs data is handled by repairs-required.html module
          console.log('âœ… Repairs step - data handled by repairs module');
          break;
      }
      
      // Update helper meta info only
      sessionStorage.setItem('helper', JSON.stringify(helper));
    }
    
    function loadWorkModule() {
      const moduleContainer = document.getElementById('workModule');
      
      // Load work module with cache busting to prevent browser cache issues
      const timestamp = new Date().getTime();
      moduleContainer.innerHTML = `<iframe src="work.html?v=${timestamp}" style="width:100%; height:600px; border:none; border-radius:10px;" id="workModuleFrame" onload="console.log('âœ… Work module iframe loaded successfully');" onerror="console.error('âŒ Work module iframe failed to load');"></iframe>`;
      moduleContainer.classList.add('loaded');
      
      // Show subtotal
      document.getElementById('workSubtotal').style.display = 'block';
      
      // Set up communication with work module
      setupModuleCommunication('work');
    }
    
    function loadPartsModule() {
      const moduleContainer = document.getElementById('partsModule');
      
      // Use existing parts-required.html module
      moduleContainer.innerHTML = `<iframe src="parts-required.html" style="width:100%; height:600px; border:none; border-radius:10px;" id="partsModuleFrame"></iframe>`;
      moduleContainer.classList.add('loaded');
      
      // Show subtotal
      document.getElementById('partsSubtotal').style.display = 'block';
      
      // Set up communication with parts module
      setupModuleCommunication('parts');
    }
    
    function loadRepairsModule() {
      const moduleContainer = document.getElementById('repairsModule');
      
      // Use existing repairs-required.html module
      moduleContainer.innerHTML = `<iframe src="repairs-required.html" style="width:100%; height:600px; border:none; border-radius:10px;" id="repairsModuleFrame"></iframe>`;
      moduleContainer.classList.add('loaded');
      
      // Show subtotal
      document.getElementById('repairsSubtotal').style.display = 'block';
      
      // Set up communication with repairs module
      setupModuleCommunication('repairs');
    }
    
    function updateSummary() {
      document.getElementById('summaryNumber').textContent = damageCenterData.number;
      
      // Display location (either selected or custom)
      let locationText = damageCenterData.location;
      if (damageCenterData.location === 'other' && damageCenterData.customLocation) {
        locationText = damageCenterData.customLocation;
      }
      document.getElementById('summaryLocation').textContent = locationText;
      
      document.getElementById('summaryDescription').textContent = damageCenterData.description;
      
      // Calculate totals
      calculateTotals();
    }
    
    function calculateTotals() {
      // Get actual totals from module data
      const workTotal = moduleData.works.reduce((sum, work) => sum + (parseFloat(work.cost) || 0), 0);
      const partsTotal = moduleData.parts.reduce((sum, part) => sum + (parseFloat(part.price) || 0), 0);
      const repairsTotal = moduleData.repairs.reduce((sum, repair) => sum + (parseFloat(repair.cost) || 0), 0);
      
      const subtotal = workTotal + partsTotal + repairsTotal;
      const vatAmount = subtotal * (vatPercentage / 100);
      const totalWithVat = subtotal + vatAmount;
      
      // Update display
      document.getElementById('totalAmount').textContent = `â‚ª${subtotal.toLocaleString()}`;
      document.getElementById('totalWithoutVat').textContent = `â‚ª${subtotal.toLocaleString()}`;
      document.getElementById('totalWithVat').textContent = `â‚ª${totalWithVat.toLocaleString()}`;
      
      // Update individual subtotals in wizard
      updateModuleSubtotals(workTotal, partsTotal, repairsTotal);
      
      // Save to damage center data
      damageCenterData.workTotal = workTotal;
      damageCenterData.partsTotal = partsTotal;
      damageCenterData.repairsTotal = repairsTotal;
      damageCenterData.subtotal = subtotal;
      damageCenterData.vatAmount = vatAmount;
      damageCenterData.totalWithVat = totalWithVat;
      
      console.log('ğŸ§® Calculated totals:', { workTotal, partsTotal, repairsTotal, subtotal, totalWithVat });
    }
    
    function updateModuleSubtotals(workTotal, partsTotal, repairsTotal) {
      // Update work subtotal display
      const workSubtotal = document.getElementById('workSubtotal');
      if (workSubtotal) {
        const workAmount = document.getElementById('workAmount');
        const workAmountWithVat = document.getElementById('workAmountWithVat');
        if (workAmount) workAmount.textContent = `â‚ª${workTotal.toLocaleString()}`;
        if (workAmountWithVat) workAmountWithVat.textContent = `â‚ª${(workTotal * 1.17).toLocaleString()}`;
        workSubtotal.style.display = workTotal > 0 ? 'block' : 'none';
      }
      
      // Update parts subtotal display  
      const partsSubtotal = document.getElementById('partsSubtotal');
      if (partsSubtotal) {
        const partsAmount = document.getElementById('partsAmount');
        const partsAmountWithVat = document.getElementById('partsAmountWithVat');
        if (partsAmount) partsAmount.textContent = `â‚ª${partsTotal.toLocaleString()}`;
        if (partsAmountWithVat) partsAmountWithVat.textContent = `â‚ª${(partsTotal * 1.17).toLocaleString()}`;
        partsSubtotal.style.display = partsTotal > 0 ? 'block' : 'none';
      }
      
      // Update repairs subtotal display
      const repairsSubtotal = document.getElementById('repairsSubtotal');
      if (repairsSubtotal) {
        const repairsAmount = document.getElementById('repairsAmount');
        const repairsAmountWithVat = document.getElementById('repairsAmountWithVat');
        if (repairsAmount) repairsAmount.textContent = `â‚ª${repairsTotal.toLocaleString()}`;
        if (repairsAmountWithVat) repairsAmountWithVat.textContent = `â‚ª${(repairsTotal * 1.17).toLocaleString()}`;
        repairsSubtotal.style.display = repairsTotal > 0 ? 'block' : 'none';
      }
    }
    
    function completeDamageCenter() {
      // Save damage center to helper
      saveDamageCenterToHelper();
      
      // Show completion message and navigate to expertise summary
      alert('××•×§×“ ×”× ×–×§ × ×•×¦×¨ ×•× ×©××¨ ×‘×”×¦×œ×—×”!');
      
      // Navigate to expertise summary as the next step in the workflow
      window.location.href = "expertise-summary.html";
    }
    
    function saveDamageCenterToHelper() {
      console.log('ğŸ’¾ Creating organized damage center structure...');
      
      try {
        // Get current helper data
        let helper = {};
        try {
          helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        } catch (e) {
          console.warn('Failed to parse helper from sessionStorage, using empty object');
          helper = {};
        }
        
        // Initialize comprehensive damage centers structure
        if (!helper.damage_centers) {
          console.error('âŒ Damage centers structure not found in helper');
          return false;
        }
        
        // Get damage center data
        const location = moduleData.location || '××™×§×•× ×œ× ×¦×•×™×Ÿ';
        const description = moduleData.description || '×ª×™××•×¨ ×œ× ×¦×•×™×Ÿ';
        
        // Get actual data from modules
        const workData = moduleData.works.length > 0 ? moduleData.works : (helper.damage_assessment?.works?.work_items || []);
        const partsData = moduleData.parts.length > 0 ? moduleData.parts : (helper.damage_assessment?.parts?.parts_items || []);
        const repairsData = moduleData.repairs.length > 0 ? moduleData.repairs : (helper.damage_assessment?.repairs?.repairs_items || []);
        
        // Calculate totals
        const workTotal = workData.reduce((sum, item) => sum + (parseFloat(item.cost) || 0), 0);
        const partsTotal = partsData.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0);
        const repairsTotal = repairsData.reduce((sum, item) => sum + (parseFloat(item.cost) || 0), 0);
        const total = workTotal + partsTotal + repairsTotal;
        
        // Create comprehensive damage center using the advanced system
        const newCenter = window.createDamageCenter(location, description, {
          created_by: 'damage_centers_wizard',
          creation_method: 'wizard'
        });
        
        if (!newCenter) {
          console.error('âŒ Failed to create damage center');
          return false;
        }
        
        // Add all work items with comprehensive data
        workData.forEach(work => {
          const workItem = {
            category: work.category,
            cost: parseFloat(work.cost) || 0,
            comments: work.comments || '',
            hours: parseFloat(work.hours) || 0,
            hourly_rate: parseFloat(work.hourly_rate) || 0,
            source: 'wizard_input',
            added_at: new Date().toISOString(),
            validated: true
          };
          newCenter.work_items.push(workItem);
        });
        
        // Add all parts items with comprehensive data including webhook results
        partsData.forEach(part => {
          const partItem = {
            name: part.part || part.name || '',
            description: part.desc || part.description || '',
            price: parseFloat(part.price) || 0,
            cost: parseFloat(part.price) || 0,
            supplier: part.supplier || '',
            location: part.location || '',
            part_number: part.part_number || '',
            brand: part.brand || '',
            condition: part.condition || '××©×•××©',
            availability: part.availability || '',
            source: part.source || 'manual',
            
            // Advanced tracking
            search_session: part.search_session || '',
            webhook_data: part.webhook_data || {},
            ocr_extracted: part.ocr_extracted || false,
            verified: part.verified || false,
            added_at: new Date().toISOString(),
            
            // Integration data
            linked_search_id: part.linked_search_id || '',
            confidence_score: part.confidence_score || 0
          };
          newCenter.parts_items.push(partItem);
        });
        
        // Add all repair items with comprehensive data
        repairsData.forEach(repair => {
          const repairItem = {
            name: repair.name || '',
            description: repair.description || '',
            cost: parseFloat(repair.cost) || 0,
            priority: repair.priority || 'normal',
            estimated_hours: parseFloat(repair.estimated_hours) || 0,
            complexity: repair.complexity || 'medium',
            source: 'wizard_input',
            added_at: new Date().toISOString(),
            validated: true
          };
          newCenter.repairs_items.push(repairItem);
        });
        
        // Calculate comprehensive totals
        window.calculateDamageCenterTotals(newCenter.id);
        
        // Update center workflow status
        window.updateDamageCenter(newCenter.id, {
          'workflow.status': 'completed',
          'workflow.completed_steps': [1, 2, 3, 4, 5, 6, 7],
          'timestamps.completed_at': new Date().toISOString(),
          'validation.is_complete': true,
          'validation.is_valid': true
        });
        
        // Update meta
        helper.meta = helper.meta || {};
        helper.meta.last_updated = new Date().toISOString();
        helper.meta.damage_centers_count = helper.damage_blocks.length;
        
        // Save to session storage
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        console.log('âœ… Simple damage center saved:', damageBlock);
        console.log('âœ… Total damage centers:', helper.damage_blocks.length);
        console.log('âœ… Total damage cost:', helper.damage_total);
        
        // Clear current damage assessment data for next center
        if (helper.damage_assessment) {
          helper.damage_assessment.works = {};
          helper.damage_assessment.parts = {};
          helper.damage_assessment.repairs = {};
          sessionStorage.setItem('helper', JSON.stringify(helper));
        }
        
      } catch (error) {
        console.error('âŒ Failed to save organized damage center to helper:', error);
        alert('×©×’×™××” ×‘×©××™×¨×ª ××•×§×“ ×”× ×–×§');
      }
    }
    
    function getDamageCentersFromHelper() {
      if (typeof window.helper !== 'undefined' && window.helper.damage_centers) {
        return window.helper.damage_centers;
      }
      return [];
    }
    
    function resetWizard() {
      currentStep = 1;
      damageCenterData = {};
      
      showStep(1);
      updateProgress();
      generateDamageCenterNumber();
      
      // Clear form fields
      document.getElementById('damageDescription').value = '';
      document.querySelectorAll('.location-card').forEach(card => {
        card.classList.remove('selected');
      });
    }
    
    // Set up communication with embedded modules
    function setupModuleCommunication(moduleType) {
      console.log(`ğŸ”— Setting up communication with ${moduleType} module`);
      
      // Wait for iframe to load then send damage center ID
      setTimeout(() => {
        const iframe = document.getElementById(`${moduleType}ModuleFrame`);
        if (iframe && iframe.contentWindow) {
          const currentCenterId = damageCenterData.id || window.helper?.damage_centers?.current_center_id;
          
          // Send damage center context to the module
          iframe.contentWindow.postMessage({
            type: 'damageCenterContext',
            damageCenterId: currentCenterId,
            damageCenter: damageCenterData,
            moduleType: moduleType
          }, '*');
          
          console.log(`ğŸ“¤ Sent damage center context to ${moduleType} module:`, currentCenterId);
        }
      }, 1000);
    }
    
    // Communication with embedded modules
    window.addEventListener('message', function(event) {
      console.log('ğŸ“¨ Received message from module:', event.data);
      
      switch(event.data.type) {
        case 'moduleUpdate':
          handleModuleUpdate(event.data);
          break;
        case 'moduleReady':
          handleModuleReady(event.data);
          break;
        case 'dataUpdate':
          handleDataUpdate(event.data);
          break;
      }
    });
    
    function handleModuleReady(data) {
      console.log(`âœ… Module ${data.module} is ready`);
      
      // Send current damage center data to the module
      const currentCenterId = damageCenterData.id || window.helper?.damage_centers?.current_center_id;
      const iframe = document.getElementById(`${data.module}ModuleFrame`);
      
      if (iframe && iframe.contentWindow) {
        iframe.contentWindow.postMessage({
          type: 'damageCenterData',
          damageCenterId: currentCenterId,
          damageCenter: damageCenterData
        }, '*');
      }
    }
    
    function handleModuleUpdate(data) {
      console.log(`ğŸ”„ Updating ${data.module} subtotal:`, data.total);
      
      switch(data.module) {
        case 'work':
          updateWorkSubtotal(data.total);
          // Save work items to damage center
          if (data.items && currentDamageCenterId) {
            data.items.forEach(item => {
              window.addWorkToDamageCenter(currentDamageCenterId, item);
            });
          }
          break;
        case 'parts':
          updatePartsSubtotal(data.total);
          // Save parts items to damage center
          if (data.items && currentDamageCenterId) {
            data.items.forEach(item => {
              window.addPartToDamageCenter(currentDamageCenterId, item);
            });
          }
          break;
        case 'repairs':
          updateRepairsSubtotal(data.total);
          // Save repair items to damage center
          if (data.items && currentDamageCenterId) {
            data.items.forEach(item => {
              window.addRepairToDamageCenter(currentDamageCenterId, item);
            });
          }
          break;
      }
      
      // Recalculate damage center totals
      if (typeof window.calculateDamageCenterTotals === 'function' && currentDamageCenterId) {
        window.calculateDamageCenterTotals(currentDamageCenterId);
      }
    }
    
    function handleDataUpdate(data) {
      console.log(`ğŸ’¾ Saving ${data.module} data:`, data);
      
      // Update damage center data based on module updates
      if (data.damageCenterId && data.items) {
        const center = window.getDamageCenter(data.damageCenterId);
        if (center) {
          switch(data.module) {
            case 'work':
              center.work_items = data.items;
              break;
            case 'parts':
              center.parts_items = data.items;
              break;
            case 'repairs':
              center.repairs_items = data.items;
              break;
          }
          
          // Recalculate totals
          window.calculateDamageCenterTotals(data.damageCenterId);
        }
      }
    }
    
    function updateWorkSubtotal(total) {
      const vatAmount = total * (vatPercentage / 100);
      document.getElementById('workAmount').textContent = `â‚ª${total.toLocaleString()}`;
      document.getElementById('workAmountWithVat').textContent = `â‚ª${(total + vatAmount).toLocaleString()}`;
    }
    
    function updatePartsSubtotal(total) {
      const vatAmount = total * (vatPercentage / 100);
      document.getElementById('partsAmount').textContent = `â‚ª${total.toLocaleString()}`;
      document.getElementById('partsAmountWithVat').textContent = `â‚ª${(total + vatAmount).toLocaleString()}`;
    }
    
    function updateRepairsSubtotal(total) {
      const vatAmount = total * (vatPercentage / 100);
      document.getElementById('repairsAmount').textContent = `â‚ª${total.toLocaleString()}`;
      document.getElementById('repairsAmountWithVat').textContent = `â‚ª${(total + vatAmount).toLocaleString()}`;
    }

    // âœ… NEW: Clear helper data functionality
    function populateExistingDamageCenters() {
      console.log('ğŸ” Populating existing damage centers dropdown');
      
      const select = document.getElementById('existingDamageCenterSelect');
      if (!select) return;
      
      // Clear existing options except the first one
      select.innerHTML = '<option value="">×‘×—×¨ ××•×§×“ × ×–×§ ×œ× ×™×§×•×™</option>';
      
      try {
        // Get helper data from sessionStorage
        const helperString = sessionStorage.getItem('helper');
        if (!helperString) {
          console.log('â„¹ï¸ No helper data found');
          return;
        }
        
        const helper = JSON.parse(helperString);
        let damageCenters = [];
        
        // Check multiple possible locations for damage centers
        if (helper.damage_centers && Array.isArray(helper.damage_centers)) {
          damageCenters = helper.damage_centers;
        } else if (helper.damage_blocks && Array.isArray(helper.damage_blocks)) {
          damageCenters = helper.damage_blocks;
        } else if (helper.damage_assessment && helper.damage_assessment.centers && Array.isArray(helper.damage_assessment.centers)) {
          damageCenters = helper.damage_assessment.centers;
        }
        
        console.log(`ğŸ“Š Found ${damageCenters.length} damage centers in helper data`);
        
        if (damageCenters.length === 0) {
          // Add option to indicate no damage centers
          const option = document.createElement('option');
          option.value = '';
          option.textContent = '××™×Ÿ ××•×§×“×™ × ×–×§ ×§×™×™××™×';
          option.disabled = true;
          select.appendChild(option);
          return;
        }
        
        // Populate dropdown with existing damage centers
        damageCenters.forEach((center, index) => {
          const option = document.createElement('option');
          option.value = center.id || `center_${index}`;
          
          // Create descriptive text for the option
          let optionText = '';
          if (center.number) {
            optionText = `××•×§×“ ${center.number}`;
          } else if (center.center_number) {
            optionText = `××•×§×“ ${center.center_number}`;
          } else {
            optionText = `××•×§×“ ${index + 1}`;
          }
          
          // Add location if available
          if (center.location) {
            optionText += ` - ${center.location}`;
          } else if (center.selected_location) {
            optionText += ` - ${center.selected_location}`;
          }
          
          // Add damage description preview if available
          if (center.damage_description) {
            const preview = center.damage_description.substring(0, 30);
            optionText += ` (${preview}${center.damage_description.length > 30 ? '...' : ''})`;
          } else if (center.description) {
            const preview = center.description.substring(0, 30);
            optionText += ` (${preview}${center.description.length > 30 ? '...' : ''})`;
          }
          
          option.textContent = optionText;
          select.appendChild(option);
        });
        
        console.log('âœ… Populated damage centers dropdown');
        
      } catch (error) {
        console.error('âŒ Error populating damage centers:', error);
        
        // Add error option
        const option = document.createElement('option');
        option.value = '';
        option.textContent = '×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×';
        option.disabled = true;
        select.appendChild(option);
      }
    }
    
    function clearDamageCenterData() {
      console.log('ğŸ—‘ï¸ Starting damage center data clear process');
      
      const select = document.getElementById('existingDamageCenterSelect');
      const selectedValue = select.value;
      
      if (!selectedValue) {
        alert('×× × ×‘×—×¨ ××•×§×“ × ×–×§ ×œ× ×™×§×•×™');
        return;
      }
      
      try {
        // Get helper data
        const helperString = sessionStorage.getItem('helper');
        if (!helperString) {
          alert('×œ× × ××¦××• × ×ª×•× ×™× ×œ× ×™×§×•×™');
          return;
        }
        
        const helper = JSON.parse(helperString);
        let damageCenters = [];
        let dataLocation = '';
        
        // Find the damage centers array
        if (helper.damage_centers && Array.isArray(helper.damage_centers)) {
          damageCenters = helper.damage_centers;
          dataLocation = 'damage_centers';
        } else if (helper.damage_blocks && Array.isArray(helper.damage_blocks)) {
          damageCenters = helper.damage_blocks;
          dataLocation = 'damage_blocks';
        } else if (helper.damage_assessment && helper.damage_assessment.centers && Array.isArray(helper.damage_assessment.centers)) {
          damageCenters = helper.damage_assessment.centers;
          dataLocation = 'damage_assessment.centers';
        }
        
        if (damageCenters.length === 0) {
          alert('×œ× × ××¦××• ××•×§×“×™ × ×–×§ ×œ× ×™×§×•×™');
          return;
        }
        
        // Find the damage center to remove
        const centerIndex = damageCenters.findIndex(center => 
          (center.id === selectedValue) || 
          (center.center_id === selectedValue) ||
          (`center_${damageCenters.indexOf(center)}` === selectedValue)
        );
        
        if (centerIndex === -1) {
          alert('××•×§×“ ×”× ×–×§ ×”× ×‘×—×¨ ×œ× × ××¦×');
          return;
        }
        
        const centerToRemove = damageCenters[centerIndex];
        const centerDescription = centerToRemove.number || centerToRemove.center_number || `××•×§×“ ${centerIndex + 1}`;
        
        // Confirm deletion
        const confirmMessage = `×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”× ×ª×•× ×™× ×©×œ ${centerDescription}?\n\n×¤×¢×•×œ×” ×–×• ×ª××—×§:\nâ€¢ ×¤×¨×˜×™ ×”××•×§×“ ×•×”××™×§×•×\nâ€¢ ×ª×™××•×¨ ×”× ×–×§\nâ€¢ ×¨×©×™××ª ×¢×‘×•×“×•×ª\nâ€¢ ×¨×©×™××ª ×—×œ×¤×™×\nâ€¢ ×¨×©×™××ª ×ª×™×§×•× ×™×\nâ€¢ ×—×™×©×•×‘×™ ×¢×œ×•×™×•×ª\n\n×œ× × ×™×ª×Ÿ ×œ×‘×˜×œ ×¤×¢×•×œ×” ×–×•!`;
        
        if (!confirm(confirmMessage)) {
          return;
        }
        
        console.log(`ğŸ—‘ï¸ Removing damage center: ${centerDescription}`, centerToRemove);
        
        // Remove the damage center from the array
        damageCenters.splice(centerIndex, 1);
        
        // Update the helper object based on data location
        if (dataLocation === 'damage_centers') {
          helper.damage_centers = damageCenters;
        } else if (dataLocation === 'damage_blocks') {
          helper.damage_blocks = damageCenters;
        } else if (dataLocation === 'damage_assessment.centers') {
          helper.damage_assessment.centers = damageCenters;
        }
        
        // Recalculate totals if function is available
        if (typeof window.calculateDamageCenterTotals === 'function') {
          // Recalculate total damage cost
          let totalDamage = 0;
          damageCenters.forEach(center => {
            if (center.totals && center.totals.final_total) {
              totalDamage += parseFloat(center.totals.final_total) || 0;
            } else if (center.final_total) {
              totalDamage += parseFloat(center.final_total) || 0;
            }
          });
          
          helper.damage_total = totalDamage;
        }
        
        // Update meta information
        helper.meta = helper.meta || {};
        helper.meta.last_updated = new Date().toISOString();
        helper.meta.damage_centers_count = damageCenters.length;
        helper.meta.last_data_clear = {
          timestamp: new Date().toISOString(),
          cleared_center: centerDescription,
          remaining_centers: damageCenters.length
        };
        
        // Save updated helper data
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        console.log(`âœ… Successfully removed damage center: ${centerDescription}`);
        console.log(`ğŸ“Š Remaining damage centers: ${damageCenters.length}`);
        
        // Update UI
        populateExistingDamageCenters();
        select.value = '';
        
        // Show success message
        alert(`âœ… × ×ª×•× ×™ ${centerDescription} × ××—×§×• ×‘×”×¦×œ×—×”!\n\n× ×•×ª×¨×• ${damageCenters.length} ××•×§×“×™ × ×–×§ ×‘××¢×¨×›×ª.`);
        
        // Trigger helper update broadcast if available
        if (typeof window.broadcastHelperUpdate === 'function') {
          window.broadcastHelperUpdate(['damage_centers', 'damage_blocks', 'damage_assessment'], 'damage_center_cleared');
        }
        
      } catch (error) {
        console.error('âŒ Error clearing damage center data:', error);
        alert('×©×’×™××” ×‘××—×™×§×ª × ×ª×•× ×™ ××•×§×“ ×”× ×–×§');
      }
    }
    
    // âœ… Initialize existing damage centers dropdown on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸš€ Damage centers wizard loaded, populating existing centers...');
      
      // Wait a bit for helper data to be available
      setTimeout(() => {
        populateExistingDamageCenters();
      }, 500);
      
      // Also update when helper data changes
      window.addEventListener('storage', function(e) {
        if (e.key === 'helper') {
          console.log('ğŸ”„ Helper data updated, refreshing damage centers dropdown...');
          setTimeout(() => {
            populateExistingDamageCenters();
          }, 100);
        }
      });
    });
    
    // Make functions globally available
    window.populateExistingDamageCenters = populateExistingDamageCenters;
    window.clearDamageCenterData = clearDamageCenterData;
  </script>
</body>
</html>