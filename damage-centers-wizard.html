<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××©×£ ××•×§×“×™ × ×–×§ - ×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª</title>
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link rel="shortcut icon" href="https://carmelcayouf.com/wp-content/uploads/2025/04/logo-yaron.webp">
  <link rel="apple-touch-icon" href="https://carmelcayouf.com/wp-content/uploads/2025/04/logo-yaron.webp">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      direction: rtl;
      padding: 20px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .logo {
      width: 100px;
      height: auto;
      margin-bottom: 15px;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    
    .header p {
      font-size: 16px;
      opacity: 0.9;
    }
    
    .progress-bar {
      background: rgba(255,255,255,0.2);
      height: 8px;
      border-radius: 4px;
      margin-top: 20px;
      overflow: hidden;
    }
    
    .progress-fill {
      background: #10b981;
      height: 100%;
      transition: width 0.3s ease;
      width: 16.67%; /* Start with first step */
    }
    
    .wizard-content {
      padding: 40px;
    }
    
    .step {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .step.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .step-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .step-number {
      display: inline-block;
      width: 40px;
      height: 40px;
      background: #3b82f6;
      color: white;
      border-radius: 50%;
      line-height: 40px;
      font-weight: bold;
      margin-bottom: 15px;
    }
    
    .step-title {
      font-size: 24px;
      color: #1e3a8a;
      margin-bottom: 10px;
    }
    
    .step-description {
      color: #64748b;
      font-size: 16px;
    }
    
    .form-group {
      margin-bottom: 25px;
    }
    
    .form-label {
      display: block;
      font-weight: bold;
      color: #374151;
      margin-bottom: 8px;
      font-size: 16px;
    }
    
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .module-embed {
      border: 2px dashed #e5e7eb;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      background: #f9fafb;
      text-align: center;
    }
    
    .module-embed.loaded {
      border: 2px solid #10b981;
      background: white;
      padding: 0;
    }
    
    .subtotal-display {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border: 1px solid #10b981;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }
    
    .subtotal-title {
      font-size: 18px;
      font-weight: bold;
      color: #059669;
      margin-bottom: 10px;
    }
    
    .subtotal-amount {
      font-size: 24px;
      font-weight: bold;
      color: #047857;
    }
    
    .vat-info {
      font-size: 14px;
      color: #065f46;
      margin-top: 5px;
    }
    
    .navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 40px;
      padding-top: 30px;
      border-top: 1px solid #e5e7eb;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: #3b82f6;
      color: white;
    }
    
    .btn-primary:hover {
      background: #2563eb;
    }
    
    .btn-secondary {
      background: #6b7280;
    }
    
    .btn-success {
      background: #10b981;
      color: white;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    .btn-secondary:hover {
      background: #4b5563;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    
    .damage-center-summary {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .summary-title {
      font-size: 18px;
      font-weight: bold;
      color: #1e3a8a;
    }
    
    .summary-actions {
      display: flex;
      gap: 10px;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 14px;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 18px;
      color: #333;
      font-weight: bold;
    }
    
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        border-radius: 10px;
      }
      
      .wizard-content {
        padding: 20px;
      }
      
      .location-grid {
        grid-template-columns: 1fr;
      }
      
      .navigation {
        flex-direction: column;
        gap: 15px;
      }
      
      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">×˜×•×¢×Ÿ ××©×£ ××•×§×“×™ × ×–×§...</div>
  </div>
  
  <div class="container">
    <div class="header">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/04/logo-yaron.webp" alt="×™×¨×•×Ÿ ×›×™×•×£ ×©×××•×ª" class="logo">
      <h1>××©×£ ××•×§×“×™ × ×–×§</h1>
      <p>××¢×¨×›×ª ××ª×§×“××ª ×œ× ×™×”×•×œ ×•× ×™×ª×•×— ××•×§×“×™ × ×–×§</p>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>
    
    <div class="wizard-content">
      
      <!-- Step 1: Damage Center Number & Location -->
      <div class="step active" id="step1">
        <div class="step-header">
          <div class="step-number">1</div>
          <h2 class="step-title">××¡×¤×¨ ×•××™×§×•× ××•×§×“ ×”× ×–×§</h2>
          <p class="step-description">×”×’×“×¨×ª ××¡×¤×¨ ××•×§×“ ×”× ×–×§ ×•×‘×—×™×¨×ª ××™×§×•× ×”× ×–×§ ×‘×¨×›×‘</p>
        </div>
        
        <div class="form-group">
          <label class="form-label">××¡×¤×¨ ××•×§×“ × ×–×§</label>
          <input type="text" class="form-input" id="damageCenterNumber" readonly>
        </div>
        
        <div class="form-group">
          <label class="form-label">×‘×—×¨ ××™×§×•× ×”× ×–×§</label>
          <select class="form-select" id="locationSelect" onchange="handleLocationChange()">
            <option value="">×‘×—×¨ ××™×§×•× × ×–×§</option>
            <!-- Location options will be populated dynamically -->
          </select>
        </div>
        
        <div class="form-group" id="otherLocationGroup" style="display: none;">
          <label class="form-label">×¤×¨×˜ ××™×§×•× ××—×¨</label>
          <input type="text" class="form-input" id="otherLocationInput" placeholder="×”×›× ×¡ ××™×§×•× × ×–×§ ××•×ª×× ××™×©×™×ª..." onchange="updateOtherLocation()">
        </div>
      </div>
      
      <!-- Step 2: Damage Description -->
      <div class="step" id="step2">
        <div class="step-header">
          <div class="step-number">2</div>
          <h2 class="step-title">×ª×™××•×¨ ×”× ×–×§</h2>
          <p class="step-description">×ª×™××•×¨ ××¤×•×¨×˜ ×©×œ ×”× ×–×§ ×‘××•×§×“ ×©× ×‘×—×¨</p>
        </div>
        
        <div class="form-group">
          <label class="form-label">×ª×™××•×¨ ×”× ×–×§</label>
          <textarea class="form-textarea" id="damageDescription" placeholder="×ª××¨ ××ª ×”× ×–×§ ×‘×¤×™×¨×•×˜..."></textarea>
        </div>
      </div>
      
      <!-- Step 3: Work Needed -->
      <div class="step" id="step3">
        <div class="step-header">
          <div class="step-number">3</div>
          <h2 class="step-title">×¢×‘×•×“×•×ª × ×“×¨×©×•×ª</h2>
          <p class="step-description">×”×’×“×¨×ª ×”×¢×‘×•×“×•×ª ×”× ×“×¨×©×•×ª ×œ×ª×™×§×•×Ÿ ×”× ×–×§</p>
        </div>
        
        <div class="module-embed" id="workModule">
          <p>×˜×•×¢×Ÿ ××•×“×•×œ ×¢×‘×•×“×•×ª...</p>
        </div>
        
        <div class="subtotal-display" id="workSubtotal" style="display:none;">
          <div class="subtotal-title">×¡×™×›×•× ×¢×‘×•×“×•×ª</div>
          <div class="subtotal-amount" id="workAmount">â‚ª0</div>
          <div class="vat-info">×œ×œ× ××¢"× | ×›×•×œ×œ ××¢"×: <span id="workAmountWithVat">â‚ª0</span></div>
        </div>
      </div>
      
      <!-- Step 4: Parts Search -->
      <div class="step" id="step4">
        <div class="step-header">
          <div class="step-number">4</div>
          <h2 class="step-title">×—×™×¤×•×© ×—×œ×¤×™×</h2>
          <p class="step-description">×—×™×¤×•×© ×—×œ×¤×™× ×‘×××¦×¢×•×ª ×”×©×™×˜×•×ª ×”×©×•× ×•×ª</p>
        </div>
        
        <div class="module-embed" id="partsSearchModule">
          <p>×˜×•×¢×Ÿ ××•×“×•×œ ×—×™×¤×•×© ×—×œ×¤×™×...</p>
        </div>
        
        <div class="subtotal-display" id="searchResultsInfo" style="display:none;">
          <div class="subtotal-title">×ª×•×¦××•×ª ×—×™×¤×•×©</div>
          <div class="subtotal-amount" id="searchResultsCount">0 ×—×œ×¤×™× × ××¦××•</div>
          <div class="vat-info">×”×ª×•×¦××•×ª × ×©××¨×• ×œ××¢×¨×›×ª ×œ×‘×—×™×¨×” ×‘×©×œ×‘ ×”×‘×</div>
        </div>
      </div>
      
      <!-- Step 5: Parts Selection -->
      <div class="step" id="step5">
        <div class="step-header">
          <div class="step-number">5</div>
          <h2 class="step-title">×‘×—×™×¨×ª ×—×œ×¤×™×</h2>
          <p class="step-description">×‘×—×™×¨×ª ×”×—×œ×¤×™× ×”× ×“×¨×©×™× ××ª×•×¦××•×ª ×”×—×™×¤×•×©</p>
        </div>
        
        <div class="module-embed" id="partsModule">
          <p>×˜×•×¢×Ÿ ××•×“×•×œ ×‘×—×™×¨×ª ×—×œ×¤×™×...</p>
        </div>
        
        <div class="subtotal-display" id="partsSubtotal" style="display:none;">
          <div class="subtotal-title">×¡×™×›×•× ×—×œ×¤×™×</div>
          <div class="subtotal-amount" id="partsAmount">â‚ª0</div>
          <div class="vat-info">×œ×œ× ××¢"× | ×›×•×œ×œ ××¢"×: <span id="partsAmountWithVat">â‚ª0</span></div>
        </div>
      </div>
      
      <!-- Step 6: Required Repairs -->
      <div class="step" id="step6">
        <div class="step-header">
          <div class="step-number">6</div>
          <h2 class="step-title">×ª×™×§×•× ×™× × ×“×¨×©×™×</h2>
          <p class="step-description">×”×’×“×¨×ª ×”×ª×™×§×•× ×™× ×”× ×“×¨×©×™× ×•×¢×œ×•×™×•×ª×™×”×</p>
        </div>
        
        <div class="module-embed" id="repairsModule">
          <p>×˜×•×¢×Ÿ ××•×“×•×œ ×ª×™×§×•× ×™×...</p>
        </div>
        
        <div class="subtotal-display" id="repairsSubtotal" style="display:none;">
          <div class="subtotal-title">×¡×™×›×•× ×ª×™×§×•× ×™×</div>
          <div class="subtotal-amount" id="repairsAmount">â‚ª0</div>
          <div class="vat-info">×œ×œ× ××¢"× | ×›×•×œ×œ ××¢"×: <span id="repairsAmountWithVat">â‚ª0</span></div>
        </div>
      </div>
      
      <!-- Step 7: Summary -->
      <div class="step" id="step7">
        <div class="step-header">
          <div class="step-number">7</div>
          <h2 class="step-title">×¡×™×›×•× ××•×§×“ ×”× ×–×§</h2>
          <p class="step-description">×¡×™×›×•× ×›×•×œ×œ ×©×œ ×›×œ ×”×¤×¨×˜×™× ×•×”×¢×œ×•×™×•×ª</p>
        </div>
        
        <div class="damage-center-summary">
          <div class="summary-header">
            <div class="summary-title">××•×§×“ × ×–×§ ××¡×¤×¨ <span id="summaryNumber"></span></div>
          </div>
          
          <div class="form-group">
            <label class="form-label">××™×§×•×</label>
            <div id="summaryLocation"></div>
          </div>
          
          <div class="form-group">
            <label class="form-label">×ª×™××•×¨ ×”× ×–×§</label>
            <div id="summaryDescription"></div>
          </div>
          
          <div class="subtotal-display">
            <div class="subtotal-title">×¡×”"×› ××•×§×“ × ×–×§</div>
            <div class="subtotal-amount" id="totalAmount">â‚ª0</div>
            <div class="vat-info">
              ×œ×œ× ××¢"×: <span id="totalWithoutVat">â‚ª0</span> | 
              ×›×•×œ×œ ××¢"×: <span id="totalWithVat">â‚ª0</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="navigation">
        <button class="btn btn-secondary" id="prevBtn" onclick="previousStep()" style="display:none;">×”×§×•×“×</button>
        <button class="btn btn-success" id="saveBtn" onclick="saveCurrentStep()">×©××•×¨ × ×ª×•× ×™×</button>
        <div id="stepInfo">×©×œ×‘ 1 ××ª×•×š 6</div>
        <button class="btn btn-primary" id="nextBtn" onclick="nextStep()">×”×‘×</button>
      </div>
    </div>
  </div>
  
  <script src="helper.js"></script>
  <script type="module" src="parts.js"></script>
  <script>
    // Global wizard state
    let currentStep = 1;
    const totalSteps = 7; // Added one more step for parts search
    let damageCenterData = {};
    let vatPercentage = 18; // Will be loaded from system settings
    
    // Damage center locations (from advanced damage center module)
    const damageLocations = [
      '×§×“××ª ×”×¨×›×‘', '××—×•×¨×™ ×”×¨×›×‘', '×¦×“ ×™××™×Ÿ ×§×“××™', '×¦×“ ×™××™×Ÿ ××—×•×¨×™',
      '×¦×“ ×©×××œ ×§×“××™', '×¦×“ ×©×××œ ××—×•×¨×™', '×’×’ ×”×¨×›×‘', '×ª×—×ª×™×ª ×”×¨×›×‘',
      '×¤× ×™× ×§×“××™', '×¤× ×™× ××—×•×¨×™', '×× ×•×¢', '×ª× ××˜×¢×Ÿ', '×“×œ×ª×•×ª', '×—×œ×•× ×•×ª'
    ];
    
    // Initialize wizard on page load
    document.addEventListener('DOMContentLoaded', function() {
      initializeWizard();
    });
    
    function initializeWizard() {
      // Show loading
      document.getElementById('loadingOverlay').style.display = 'flex';
      
      // Generate damage center number
      generateDamageCenterNumber();
      
      // Populate location dropdown
      populateLocationDropdown();
      
      // Initialize helper system
      if (typeof window.helper !== 'undefined') {
        // Load VAT percentage from system settings
        if (window.helper.system && window.helper.system.vat_percentage) {
          vatPercentage = window.helper.system.vat_percentage;
        }
      }
      
      // Hide loading after initialization
      setTimeout(() => {
        document.getElementById('loadingOverlay').style.display = 'none';
      }, 1000);
    }
    
    function generateDamageCenterNumber() {
      // Auto-generate damage center number
      const existingCenters = getDamageCentersFromHelper();
      const nextNumber = existingCenters.length + 1;
      document.getElementById('damageCenterNumber').value = nextNumber;
      damageCenterData.number = nextNumber;
    }
    
    function populateLocationDropdown() {
      const select = document.getElementById('locationSelect');
      select.innerHTML = '<option value="">×‘×—×¨ ××™×§×•× × ×–×§</option>';
      
      damageLocations.forEach(location => {
        const option = document.createElement('option');
        option.value = location;
        option.textContent = location;
        select.appendChild(option);
      });
      
      // Add "other" option
      const otherOption = document.createElement('option');
      otherOption.value = 'other';
      otherOption.textContent = '××—×¨ (×¤×¨×˜ ×‘××§×•× ×”×‘×)';
      select.appendChild(otherOption);
    }
    
    window.handleLocationChange = function() {
      const select = document.getElementById('locationSelect');
      const otherGroup = document.getElementById('otherLocationGroup');
      const otherInput = document.getElementById('otherLocationInput');
      
      if (select.value === 'other') {
        otherGroup.style.display = 'block';
        otherInput.focus();
        damageCenterData.location = 'other';
        damageCenterData.customLocation = '';
      } else {
        otherGroup.style.display = 'none';
        otherInput.value = '';
        damageCenterData.location = select.value;
        damageCenterData.customLocation = '';
      }
    };
    
    window.updateOtherLocation = function() {
      const otherInput = document.getElementById('otherLocationInput');
      damageCenterData.customLocation = otherInput.value.trim();
    };
    
    function nextStep() {
      if (validateCurrentStep()) {
        if (currentStep < totalSteps) {
          // Save current step data
          saveCurrentStepData();
          
          // Move to next step
          currentStep++;
          showStep(currentStep);
          updateProgress();
          
          // Load module if needed
          loadStepModule(currentStep);
        } else {
          // Final step - complete damage center
          completeDamageCenter();
        }
      }
    }
    
    function previousStep() {
      if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
        updateProgress();
      }
    }
    
    function saveCurrentStep() {
      console.log('ğŸ’¾ Saving current step data to helper...');
      
      try {
        // Get current helper data
        let helper = {};
        try {
          helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        } catch (e) {
          console.warn('Failed to parse helper from sessionStorage, using empty object');
          helper = {};
        }
        
        // Initialize damage_centers structure if needed
        helper.damage_centers = helper.damage_centers || {
          centers: [],
          current_center_id: null,
          active_center_count: 0,
          totals: { all_centers_subtotal: 0, all_centers_vat: 0, all_centers_total: 0 }
        };
        
        // Save current step data based on which step we're on
        const stepData = {};
        
        switch(currentStep) {
          case 1:
            // Location and number
            const locationSelect = document.getElementById('locationSelect');
            const otherLocationInput = document.getElementById('otherLocationInput');
            stepData.location = locationSelect?.value;
            stepData.customLocation = otherLocationInput?.value;
            stepData.number = damageCenterData.number;
            break;
            
          case 2:
            // Description
            const description = document.getElementById('damageDescription');
            stepData.description = description?.value;
            break;
            
          default:
            // For module steps (3-6), modules handle their own saving
            stepData.currentStep = currentStep;
            stepData.stepName = ['', 'location', 'description', 'work', 'parts_search', 'parts_required', 'repairs'][currentStep];
            break;
        }
        
        // Update damage center data in helper
        if (!helper.damage_centers.current_center_id) {
          helper.damage_centers.current_center_id = damageCenterData.id || `center_${Date.now()}`;
        }
        
        // Find or create current center
        let currentCenter = helper.damage_centers.centers.find(c => c.id === helper.damage_centers.current_center_id);
        if (!currentCenter) {
          currentCenter = {
            id: helper.damage_centers.current_center_id,
            number: damageCenterData.number || helper.damage_centers.centers.length + 1,
            steps: {}
          };
          helper.damage_centers.centers.push(currentCenter);
        }
        
        // Save step data
        Object.assign(currentCenter.steps, stepData);
        currentCenter.last_updated = new Date().toISOString();
        currentCenter.current_step = currentStep;
        
        // Update meta
        helper.meta = helper.meta || {};
        helper.meta.last_updated = new Date().toISOString();
        
        // Save to session storage
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        console.log('âœ… Step data saved to helper:', stepData);
        
        // Show save confirmation
        const saveBtn = document.getElementById('saveBtn');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = 'âœ… × ×©××¨';
        saveBtn.style.background = '#059669';
        
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.style.background = '#10b981';
        }, 2000);
        
        // Trigger helper update broadcast if available
        if (typeof window.broadcastHelperUpdate === 'function') {
          window.broadcastHelperUpdate(['damage_centers'], 'damage_center_wizard');
        }
        
      } catch (error) {
        console.error('âŒ Failed to save step data to helper:', error);
        
        // Show error state
        const saveBtn = document.getElementById('saveBtn');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = 'âŒ ×©×’×™××”';
        saveBtn.style.background = '#dc2626';
        
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.style.background = '#10b981';
        }, 3000);
        
        alert('×©×’×™××” ×‘×©××™×¨×ª ×”× ×ª×•× ×™×');
      }
    }
    
    function showStep(step) {
      // Hide all steps
      document.querySelectorAll('.step').forEach(stepEl => {
        stepEl.classList.remove('active');
      });
      
      // Show current step
      document.getElementById(`step${step}`).classList.add('active');
      
      // Update navigation
      updateNavigation();
      
      // Update step info
      document.getElementById('stepInfo').textContent = `×©×œ×‘ ${step} ××ª×•×š ${totalSteps}`;
    }
    
    function updateNavigation() {
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      
      // Show/hide previous button
      prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
      
      // Update next button text
      if (currentStep === totalSteps) {
        nextBtn.textContent = '×¡×™×™× ××•×§×“ × ×–×§';
        nextBtn.className = 'btn btn-success';
      } else {
        nextBtn.textContent = '×”×‘×';
        nextBtn.className = 'btn btn-primary';
      }
    }
    
    function updateProgress() {
      const progressFill = document.getElementById('progressFill');
      const percentage = (currentStep / totalSteps) * 100;
      progressFill.style.width = `${percentage}%`;
    }
    
    function loadStepModule(step) {
      switch(step) {
        case 3:
          loadWorkModule();
          break;
        case 4:
          loadPartsSearchModule();
          break;
        case 5:
          loadPartsModule();
          break;
        case 6:
          loadRepairsModule();
          break;
        case 7:
          updateSummary();
          break;
      }
    }
    
    function loadPartsSearchModule() {
      const moduleContainer = document.getElementById('partsSearchModule');
      
      // Use existing parts search module
      moduleContainer.innerHTML = `<iframe src="parts search.html" style="width:100%; height:600px; border:none; border-radius:10px;" id="partsSearchModuleFrame"></iframe>`;
      moduleContainer.classList.add('loaded');
      
      // Show search results info
      document.getElementById('searchResultsInfo').style.display = 'block';
      
      // Set up communication with parts search module
      setupModuleCommunication('partsSearch');
    }
    
    function validateCurrentStep() {
      switch(currentStep) {
        case 1:
          const locationSelect = document.getElementById('locationSelect');
          const otherLocationInput = document.getElementById('otherLocationInput');
          
          if (!locationSelect.value) {
            alert('×× × ×‘×—×¨ ××™×§×•× × ×–×§');
            return false;
          }
          
          if (locationSelect.value === 'other' && !otherLocationInput.value.trim()) {
            alert('×× × ×”×–×Ÿ ××™×§×•× × ×–×§ ××•×ª×× ××™×©×™×ª');
            return false;
          }
          break;
        case 2:
          const description = document.getElementById('damageDescription').value.trim();
          if (!description) {
            alert('×× × ×”×–×Ÿ ×ª×™××•×¨ × ×–×§');
            return false;
          }
          break;
      }
      return true;
    }
    
    function saveCurrentStepData() {
      switch(currentStep) {
        case 2:
          damageCenterData.description = document.getElementById('damageDescription').value.trim();
          break;
      }
    }
    
    function loadWorkModule() {
      const moduleContainer = document.getElementById('workModule');
      
      // Load work module without URL parameters (work.html handles data via helper.js)
      moduleContainer.innerHTML = `<iframe src="work.html" style="width:100%; height:600px; border:none; border-radius:10px;" id="workModuleFrame"></iframe>`;
      moduleContainer.classList.add('loaded');
      
      // Show subtotal
      document.getElementById('workSubtotal').style.display = 'block';
      
      // Set up communication with work module
      setupModuleCommunication('work');
    }
    
    function loadPartsModule() {
      const moduleContainer = document.getElementById('partsModule');
      
      // Use existing parts-required.html module
      moduleContainer.innerHTML = `<iframe src="parts-required.html" style="width:100%; height:600px; border:none; border-radius:10px;" id="partsModuleFrame"></iframe>`;
      moduleContainer.classList.add('loaded');
      
      // Show subtotal
      document.getElementById('partsSubtotal').style.display = 'block';
      
      // Set up communication with parts module
      setupModuleCommunication('parts');
    }
    
    function loadRepairsModule() {
      const moduleContainer = document.getElementById('repairsModule');
      
      // Use existing repairs-required.html module
      moduleContainer.innerHTML = `<iframe src="repairs-required.html" style="width:100%; height:600px; border:none; border-radius:10px;" id="repairsModuleFrame"></iframe>`;
      moduleContainer.classList.add('loaded');
      
      // Show subtotal
      document.getElementById('repairsSubtotal').style.display = 'block';
      
      // Set up communication with repairs module
      setupModuleCommunication('repairs');
    }
    
    function updateSummary() {
      document.getElementById('summaryNumber').textContent = damageCenterData.number;
      
      // Display location (either selected or custom)
      let locationText = damageCenterData.location;
      if (damageCenterData.location === 'other' && damageCenterData.customLocation) {
        locationText = damageCenterData.customLocation;
      }
      document.getElementById('summaryLocation').textContent = locationText;
      
      document.getElementById('summaryDescription').textContent = damageCenterData.description;
      
      // Calculate totals
      calculateTotals();
    }
    
    function calculateTotals() {
      // This will be enhanced with actual data from modules
      const workTotal = 0; // Get from work module
      const partsTotal = 0; // Get from parts module
      const repairsTotal = 0; // Get from repairs module
      
      const subtotal = workTotal + partsTotal + repairsTotal;
      const vatAmount = subtotal * (vatPercentage / 100);
      const totalWithVat = subtotal + vatAmount;
      
      // Update display
      document.getElementById('totalAmount').textContent = `â‚ª${subtotal.toLocaleString()}`;
      document.getElementById('totalWithoutVat').textContent = `â‚ª${subtotal.toLocaleString()}`;
      document.getElementById('totalWithVat').textContent = `â‚ª${totalWithVat.toLocaleString()}`;
      
      // Save to damage center data
      damageCenterData.workTotal = workTotal;
      damageCenterData.partsTotal = partsTotal;
      damageCenterData.repairsTotal = repairsTotal;
      damageCenterData.subtotal = subtotal;
      damageCenterData.vatAmount = vatAmount;
      damageCenterData.totalWithVat = totalWithVat;
    }
    
    function completeDamageCenter() {
      // Save damage center to helper
      saveDamageCenterToHelper();
      
      // Show completion message
      if (confirm('××•×§×“ ×”× ×–×§ × ×•×¦×¨ ×‘×”×¦×œ×—×”!\n\n×”×× ×ª×¨×¦×” ×œ×™×¦×•×¨ ××•×§×“ × ×–×§ × ×•×¡×£?')) {
        // Reset wizard for new damage center
        resetWizard();
      } else {
        // Navigate to summary or next part of workflow
        alert('××•×§×“ ×”× ×–×§ × ×©××¨ ×‘×”×¦×œ×—×”!');
        // Could redirect to expertise builder or main menu
      }
    }
    
    function saveDamageCenterToHelper() {
      if (typeof window.helper !== 'undefined') {
        if (!window.helper.damage_centers) {
          window.helper.damage_centers = [];
        }
        
        // Add timestamp
        damageCenterData.created_at = new Date().toISOString();
        damageCenterData.id = `damage_center_${Date.now()}`;
        
        // Save to helper
        window.helper.damage_centers.push(damageCenterData);
        
        console.log('ğŸ’¾ Damage center saved to helper:', damageCenterData);
      }
    }
    
    function getDamageCentersFromHelper() {
      if (typeof window.helper !== 'undefined' && window.helper.damage_centers) {
        return window.helper.damage_centers;
      }
      return [];
    }
    
    function resetWizard() {
      currentStep = 1;
      damageCenterData = {};
      
      showStep(1);
      updateProgress();
      generateDamageCenterNumber();
      
      // Clear form fields
      document.getElementById('damageDescription').value = '';
      document.querySelectorAll('.location-card').forEach(card => {
        card.classList.remove('selected');
      });
    }
    
    // Set up communication with embedded modules
    function setupModuleCommunication(moduleType) {
      console.log(`ğŸ”— Setting up communication with ${moduleType} module`);
      
      // Wait for iframe to load then send damage center ID
      setTimeout(() => {
        const iframe = document.getElementById(`${moduleType}ModuleFrame`);
        if (iframe && iframe.contentWindow) {
          const currentCenterId = damageCenterData.id || window.helper?.damage_centers?.current_center_id;
          
          // Send damage center context to the module
          iframe.contentWindow.postMessage({
            type: 'damageCenterContext',
            damageCenterId: currentCenterId,
            damageCenter: damageCenterData,
            moduleType: moduleType
          }, '*');
          
          console.log(`ğŸ“¤ Sent damage center context to ${moduleType} module:`, currentCenterId);
        }
      }, 1000);
    }
    
    // Communication with embedded modules
    window.addEventListener('message', function(event) {
      console.log('ğŸ“¨ Received message from module:', event.data);
      
      switch(event.data.type) {
        case 'moduleUpdate':
          handleModuleUpdate(event.data);
          break;
        case 'moduleReady':
          handleModuleReady(event.data);
          break;
        case 'dataUpdate':
          handleDataUpdate(event.data);
          break;
      }
    });
    
    function handleModuleReady(data) {
      console.log(`âœ… Module ${data.module} is ready`);
      
      // Send current damage center data to the module
      const currentCenterId = damageCenterData.id || window.helper?.damage_centers?.current_center_id;
      const iframe = document.getElementById(`${data.module}ModuleFrame`);
      
      if (iframe && iframe.contentWindow) {
        iframe.contentWindow.postMessage({
          type: 'damageCenterData',
          damageCenterId: currentCenterId,
          damageCenter: damageCenterData
        }, '*');
      }
    }
    
    function handleModuleUpdate(data) {
      console.log(`ğŸ”„ Updating ${data.module} subtotal:`, data.total);
      
      switch(data.module) {
        case 'work':
          updateWorkSubtotal(data.total);
          // Save work items to damage center
          if (data.items && currentDamageCenterId) {
            data.items.forEach(item => {
              window.addWorkToDamageCenter(currentDamageCenterId, item);
            });
          }
          break;
        case 'parts':
          updatePartsSubtotal(data.total);
          // Save parts items to damage center
          if (data.items && currentDamageCenterId) {
            data.items.forEach(item => {
              window.addPartToDamageCenter(currentDamageCenterId, item);
            });
          }
          break;
        case 'repairs':
          updateRepairsSubtotal(data.total);
          // Save repair items to damage center
          if (data.items && currentDamageCenterId) {
            data.items.forEach(item => {
              window.addRepairToDamageCenter(currentDamageCenterId, item);
            });
          }
          break;
      }
      
      // Recalculate damage center totals
      if (typeof window.calculateDamageCenterTotals === 'function' && currentDamageCenterId) {
        window.calculateDamageCenterTotals(currentDamageCenterId);
      }
    }
    
    function handleDataUpdate(data) {
      console.log(`ğŸ’¾ Saving ${data.module} data:`, data);
      
      // Update damage center data based on module updates
      if (data.damageCenterId && data.items) {
        const center = window.getDamageCenter(data.damageCenterId);
        if (center) {
          switch(data.module) {
            case 'work':
              center.work_items = data.items;
              break;
            case 'parts':
              center.parts_items = data.items;
              break;
            case 'repairs':
              center.repairs_items = data.items;
              break;
          }
          
          // Recalculate totals
          window.calculateDamageCenterTotals(data.damageCenterId);
        }
      }
    }
    
    function updateWorkSubtotal(total) {
      const vatAmount = total * (vatPercentage / 100);
      document.getElementById('workAmount').textContent = `â‚ª${total.toLocaleString()}`;
      document.getElementById('workAmountWithVat').textContent = `â‚ª${(total + vatAmount).toLocaleString()}`;
    }
    
    function updatePartsSubtotal(total) {
      const vatAmount = total * (vatPercentage / 100);
      document.getElementById('partsAmount').textContent = `â‚ª${total.toLocaleString()}`;
      document.getElementById('partsAmountWithVat').textContent = `â‚ª${(total + vatAmount).toLocaleString()}`;
    }
    
    function updateRepairsSubtotal(total) {
      const vatAmount = total * (vatPercentage / 100);
      document.getElementById('repairsAmount').textContent = `â‚ª${total.toLocaleString()}`;
      document.getElementById('repairsAmountWithVat').textContent = `â‚ª${(total + vatAmount).toLocaleString()}`;
    }
  </script>
</body>
</html>