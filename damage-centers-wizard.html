<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>אשף מוקדי נזק - ירון כיוף שמאות</title>
  <link rel="icon" type="image/webp" href="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp">
  <link rel="shortcut icon" href="https://carmelcayouf.com/wp-content/uploads/2025/04/logo-yaron.webp">
  <link rel="apple-touch-icon" href="https://carmelcayouf.com/wp-content/uploads/2025/04/logo-yaron.webp">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      direction: rtl;
      padding: 20px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .logo {
      width: 100px;
      height: auto;
      margin-bottom: 15px;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    
    .header p {
      font-size: 16px;
      opacity: 0.9;
    }
    
    .progress-bar {
      background: rgba(255,255,255,0.2);
      height: 8px;
      border-radius: 4px;
      margin-top: 20px;
      overflow: hidden;
    }
    
    .progress-fill {
      background: #10b981;
      height: 100%;
      transition: width 0.3s ease;
      width: 16.67%; /* Start with first step */
    }
    
    .wizard-content {
      padding: 40px;
    }
    
    .step {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .step.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .step-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .step-number {
      display: inline-block;
      width: 40px;
      height: 40px;
      background: #3b82f6;
      color: white;
      border-radius: 50%;
      line-height: 40px;
      font-weight: bold;
      margin-bottom: 15px;
    }
    
    .step-title {
      font-size: 24px;
      color: #1e3a8a;
      margin-bottom: 10px;
    }
    
    .step-description {
      color: #64748b;
      font-size: 16px;
    }
    
    .form-group {
      margin-bottom: 25px;
    }
    
    .form-label {
      display: block;
      font-weight: bold;
      color: #374151;
      margin-bottom: 8px;
      font-size: 16px;
    }
    
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .module-embed {
      border: 2px dashed #e5e7eb;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      background: #f9fafb;
      text-align: center;
    }
    
    .module-embed.loaded {
      border: 2px solid #10b981;
      background: white;
      padding: 0;
    }
    
    .subtotal-display {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border: 1px solid #10b981;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }
    
    .subtotal-title {
      font-size: 18px;
      font-weight: bold;
      color: #059669;
      margin-bottom: 10px;
    }
    
    .subtotal-amount {
      font-size: 24px;
      font-weight: bold;
      color: #047857;
    }
    
    .vat-info {
      font-size: 14px;
      color: #065f46;
      margin-top: 5px;
    }
    
    .navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 40px;
      padding-top: 30px;
      border-top: 1px solid #e5e7eb;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: #3b82f6;
      color: white;
    }
    
    .btn-primary:hover {
      background: #2563eb;
    }
    
    .btn-secondary {
      background: #6b7280;
    }
    
    .btn-success {
      background: #10b981;
      color: white;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    .btn-secondary:hover {
      background: #4b5563;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    
    .damage-center-summary {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .summary-title {
      font-size: 18px;
      font-weight: bold;
      color: #1e3a8a;
    }
    
    .summary-actions {
      display: flex;
      gap: 10px;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 14px;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 18px;
      color: #333;
      font-weight: bold;
    }
    
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        border-radius: 10px;
      }
      
      .wizard-content {
        padding: 20px;
      }
      
      .location-grid {
        grid-template-columns: 1fr;
      }
      
      .navigation {
        flex-direction: column;
        gap: 15px;
      }
      
      .btn {
        width: 100%;
      }
    }
    
    /* System-standard nav-button styling */
    .nav-button {
      background: #3b82f6;
      color: white;
      padding: 14px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      transition: all 0.3s ease;
      font-family: inherit;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .nav-button:hover {
      background: #1e3a8a;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .nav-button:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Navigation area styling */
    .navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 30px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 10px;
      border-top: 1px solid #e2e8f0;
    }
    
    #stepInfo {
      font-weight: bold;
      color: #64748b;
      font-size: 14px;
      flex: 1;
      text-align: center;
      min-width: 120px;
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .container {
        margin: 0;
        border-radius: 10px;
      }
      
      .header {
        padding: 20px 15px;
      }
      
      .header h1 {
        font-size: 22px;
      }
      
      .header p {
        font-size: 14px;
      }
      
      .logo {
        width: 80px;
      }
      
      .wizard-content {
        padding: 20px 15px;
      }
      
      .step-title {
        font-size: 20px;
      }
      
      .step-description {
        font-size: 14px;
      }
      
      .form-group {
        margin-bottom: 20px;
      }
      
      .form-label {
        font-size: 14px;
        margin-bottom: 8px;
      }
      
      .form-input, .form-select, .form-textarea {
        padding: 12px;
        font-size: 16px; /* Prevent zoom on iOS */
      }
      
      .navigation {
        flex-direction: column;
        gap: 15px;
        padding: 15px;
      }
      
      .nav-button {
        width: 100%;
        max-width: 200px;
        padding: 12px 16px;
        font-size: 14px;
      }
      
      #stepInfo {
        order: -1; /* Show step info at top on mobile */
        text-align: center;
        width: 100%;
        margin-bottom: 10px;
      }
      
      /* Module iframe mobile styling */
      .module-container iframe {
        height: 500px !important;
        border-radius: 8px !important;
      }
      
      /* Step number mobile adjustment */
      .step-number {
        width: 35px;
        height: 35px;
        line-height: 35px;
        font-size: 14px;
      }
    }
    
    @media (max-width: 480px) {
      .header {
        padding: 15px 10px;
      }
      
      .wizard-content {
        padding: 15px 10px;
      }
      
      .nav-button {
        font-size: 13px;
        padding: 10px 14px;
      }
      
      .module-container iframe {
        height: 450px !important;
      }
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">טוען אשף מוקדי נזק...</div>
  </div>
  
  <div class="container">
    <div class="header">
      <img src="https://carmelcayouf.com/wp-content/uploads/2025/06/g.webp" alt="ירון כיוף שמאות" class="logo">
      <h1>אשף מוקדי נזק</h1>
      <p>מערכת מתקדמת לניהול וניתוח מוקדי נזק</p>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>
    
    <div class="wizard-content">
      
      <!-- Step 1: Damage Center Number & Location -->
      <div class="step active" id="step1">
        <div class="step-header">
          <div class="step-number">1</div>
          <h2 class="step-title">מספר ומיקום מוקד הנזק</h2>
          <p class="step-description">הגדרת מספר מוקד הנזק ובחירת מיקום הנזק ברכב</p>
        </div>
        
        <div class="form-group">
          <label class="form-label">מספר מוקד נזק</label>
          <input type="text" class="form-input" id="damageCenterNumber" readonly>
        </div>
        
        <div class="form-group">
          <label class="form-label">בחר מיקום הנזק</label>
          <select class="form-select" id="locationSelect" onchange="handleLocationChange()">
            <option value="">בחר מיקום נזק</option>
            <!-- Location options will be populated dynamically -->
          </select>
        </div>
        
        <div class="form-group" id="otherLocationGroup" style="display: none;">
          <label class="form-label">פרט מיקום אחר</label>
          <input type="text" class="form-input" id="otherLocationInput" placeholder="הכנס מיקום נזק מותאם אישית..." onchange="updateOtherLocation()">
        </div>
      </div>
      
      <!-- Step 2: Damage Description -->
      <div class="step" id="step2">
        <div class="step-header">
          <div class="step-number">2</div>
          <h2 class="step-title">תיאור הנזק</h2>
          <p class="step-description">תיאור מפורט של הנזק במוקד שנבחר</p>
        </div>
        
        <div class="form-group">
          <label class="form-label">תיאור הנזק</label>
          <textarea class="form-textarea" id="damageDescription" placeholder="תאר את הנזק בפירוט..."></textarea>
        </div>
      </div>
      
      <!-- Step 3: Work Needed -->
      <div class="step" id="step3">
        <div class="step-header">
          <div class="step-number">3</div>
          <h2 class="step-title">עבודות נדרשות</h2>
          <p class="step-description">הגדרת העבודות הנדרשות לתיקון הנזק</p>
        </div>
        
        <div class="module-embed" id="workModule">
          <p>טוען מודול עבודות...</p>
        </div>
        
        <div class="subtotal-display" id="workSubtotal" style="display:none;">
          <div class="subtotal-title">סיכום עבודות</div>
          <div class="subtotal-amount" id="workAmount">₪0</div>
          <div class="vat-info">ללא מע"מ | כולל מע"מ: <span id="workAmountWithVat">₪0</span></div>
        </div>
      </div>
      
      <!-- Step 4: Parts Search -->
      <div class="step" id="step4">
        <div class="step-header">
          <div class="step-number">4</div>
          <h2 class="step-title">חיפוש חלפים</h2>
          <p class="step-description">חיפוש מערכת/car-part  חיפוש חלפים : אתר</p>
        </div>
        
        <div class="module-embed" id="partsSearchModule">
          <p>טוען מודול חיפוש חלפים...</p>
        </div>
        
        <div class="subtotal-display" id="searchResultsInfo" style="display:none;">
          <div class="subtotal-title">תוצאות חיפוש</div>
          <div class="subtotal-amount" id="searchResultsCount">0 חלפים נמצאו</div>
          <div class="vat-info">התוצאות נשמרו למערכת לבחירה בשלב הבא</div>
        </div>
      </div>
      
      <!-- Step 5: Parts Selection -->
      <div class="step" id="step5">
        <div class="step-header">
          <div class="step-number">5</div>
          <h2 class="step-title">בחירת חלפים</h2>
          <p class="step-description">בחירת החלפים הנדרשים מתוצאות החיפוש</p>
        </div>
        
        <div class="module-embed" id="partsModule">
          <p>טוען מודול בחירת חלפים...</p>
        </div>
        
        <div class="subtotal-display" id="partsSubtotal" style="display:none;">
          <div class="subtotal-title">סיכום חלפים</div>
          <div class="subtotal-amount" id="partsAmount">₪0</div>
          <div class="vat-info">ללא מע"מ | כולל מע"מ: <span id="partsAmountWithVat">₪0</span></div>
        </div>
      </div>
      
      <!-- Step 6: Required Repairs -->
      <div class="step" id="step6">
        <div class="step-header">
          <div class="step-number">6</div>
          <h2 class="step-title">תיקונים נדרשים</h2>
          <p class="step-description">הגדרת התיקונים הנדרשים ועלויותיהם</p>
        </div>
        
        <div class="module-embed" id="repairsModule">
          <p>טוען מודול תיקונים...</p>
        </div>
        
        <div class="subtotal-display" id="repairsSubtotal" style="display:none;">
          <div class="subtotal-title">סיכום תיקונים</div>
          <div class="subtotal-amount" id="repairsAmount">₪0</div>
          <div class="vat-info">ללא מע"מ | כולל מע"מ: <span id="repairsAmountWithVat">₪0</span></div>
        </div>
      </div>
      
      <!-- Step 7: Summary -->
      <div class="step" id="step7">
        <div class="step-header">
          <div class="step-number">7</div>
          <h2 class="step-title">סיכום מוקד הנזק</h2>
          <p class="step-description">סיכום כולל של כל הפרטים והעלויות</p>
        </div>
        
        <div class="damage-center-summary">
          <div class="summary-header">
            <div class="summary-title">מוקד נזק מספר <span id="summaryNumber"></span></div>
          </div>
          
          <div class="form-group">
            <label class="form-label">מיקום</label>
            <div id="summaryLocation"></div>
          </div>
          
          <div class="form-group">
            <label class="form-label">תיאור הנזק</label>
            <div id="summaryDescription"></div>
          </div>
          
          <div class="subtotal-display">
            <div class="subtotal-title">סה"כ מוקד נזק</div>
            <div class="subtotal-amount" id="totalAmount">₪0</div>
            <div class="vat-info">
              ללא מע"מ: <span id="totalWithoutVat">₪0</span> | 
              כולל מע"מ: <span id="totalWithVat">₪0</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="navigation">
        <button class="nav-button" onclick="window.location.href='selection.html'" style="background-color: #6c757d;">חזור לבחירה</button>
        <button class="nav-button" id="prevBtn" onclick="previousStep()" style="display:none; background-color: #6c757d;">הקודם</button>
        <button class="nav-button" id="saveBtn" onclick="saveCurrentStep()" style="background-color: #28a745;">שמור נתונים</button>
        <div id="stepInfo">שלב 1 מתוך 7</div>
        <button class="nav-button" id="nextBtn" onclick="nextStep()">הבא</button>
      </div>
    </div>
  </div>
  
  <script src="helper.js"></script>
  <script type="module" src="parts.js"></script>
  <script>
    // Global wizard state and module data storage
    let moduleData = {
      works: [],
      parts: [],
      repairs: [],
      takana389: '',
      location: '',
      description: ''
    };
    
    // Listen for data from iframe modules
    window.addEventListener('message', function(event) {
      console.log('📨 Wizard received message:', event.data);
      
      if (event.data.type === 'moduleData') {
        const { module, data } = event.data;
        
        switch(module) {
          case 'work':
            moduleData.works = data.works || [];
            moduleData.takana389 = data.takana389 || '';
            console.log('✅ Work data received in wizard:', moduleData.works);
            break;
            
          case 'parts':
            moduleData.parts = data.parts || [];
            console.log('✅ Parts data received in wizard:', moduleData.parts);
            break;
            
          case 'repairs':
            moduleData.repairs = data.repairs || [];
            console.log('✅ Repairs data received in wizard:', moduleData.repairs);
            break;
        }
        
        // Update helper with collected data
        updateHelperWithModuleData();
        
        // Recalculate totals whenever module data changes
        calculateTotals();
      }
    });
    
    function updateHelperWithModuleData() {
      try {
        let helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        
        // Update damage_assessment with current module data
        helper.damage_assessment = helper.damage_assessment || {};
        
        if (moduleData.works.length > 0) {
          helper.damage_assessment.works = {
            takana389: moduleData.takana389,
            work_items: moduleData.works,
            updated_at: new Date().toISOString(),
            updated_by: 'wizard_collection'
          };
        }
        
        if (moduleData.parts.length > 0) {
          helper.damage_assessment.parts = {
            parts_items: moduleData.parts,
            updated_at: new Date().toISOString(),
            updated_by: 'wizard_collection'
          };
        }
        
        if (moduleData.repairs.length > 0) {
          helper.damage_assessment.repairs = {
            repairs_items: moduleData.repairs,
            updated_at: new Date().toISOString(),
            updated_by: 'wizard_collection'
          };
        }
        
        helper.meta = helper.meta || {};
        helper.meta.last_updated = new Date().toISOString();
        
        sessionStorage.setItem('helper', JSON.stringify(helper));
        console.log('✅ Helper updated with module data');
        
      } catch (error) {
        console.error('❌ Failed to update helper with module data:', error);
      }
    }
    
    // Global wizard state
    let currentStep = 1;
    const totalSteps = 7; // Added one more step for parts search
    let damageCenterData = {};
    let vatPercentage = 18; // Will be loaded from system settings
    
    // Damage center locations (from advanced damage center module)
    const damageLocations = [
      'קדמת הרכב', 'אחורי הרכב', 'צד ימין קדמי', 'צד ימין אחורי',
      'צד שמאל קדמי', 'צד שמאל אחורי', 'גג הרכב', 'תחתית הרכב',
      'פנים קדמי', 'פנים אחורי', 'מנוע', 'תא מטען', 'דלתות', 'חלונות'
    ];
    
    // Initialize wizard on page load
    document.addEventListener('DOMContentLoaded', function() {
      initializeWizard();
    });
    
    function initializeWizard() {
      // Show loading
      document.getElementById('loadingOverlay').style.display = 'flex';
      
      // Generate damage center number
      generateDamageCenterNumber();
      
      // Populate location dropdown
      populateLocationDropdown();
      
      // Initialize helper system
      if (typeof window.helper !== 'undefined') {
        // Load VAT percentage from system settings
        if (window.helper.system && window.helper.system.vat_percentage) {
          vatPercentage = window.helper.system.vat_percentage;
        }
      }
      
      // Hide loading after initialization
      setTimeout(() => {
        document.getElementById('loadingOverlay').style.display = 'none';
      }, 1000);
    }
    
    function generateDamageCenterNumber() {
      // Auto-generate damage center number
      const existingCenters = getDamageCentersFromHelper();
      const nextNumber = existingCenters.length + 1;
      document.getElementById('damageCenterNumber').value = nextNumber;
      damageCenterData.number = nextNumber;
    }
    
    function populateLocationDropdown() {
      const select = document.getElementById('locationSelect');
      select.innerHTML = '<option value="">בחר מיקום נזק</option>';
      
      damageLocations.forEach(location => {
        const option = document.createElement('option');
        option.value = location;
        option.textContent = location;
        select.appendChild(option);
      });
      
      // Add "other" option
      const otherOption = document.createElement('option');
      otherOption.value = 'other';
      otherOption.textContent = 'אחר (פרט במקום הבא)';
      select.appendChild(otherOption);
    }
    
    window.handleLocationChange = function() {
      const select = document.getElementById('locationSelect');
      const otherGroup = document.getElementById('otherLocationGroup');
      const otherInput = document.getElementById('otherLocationInput');
      
      if (select.value === 'other') {
        otherGroup.style.display = 'block';
        otherInput.focus();
        damageCenterData.location = 'other';
        damageCenterData.customLocation = '';
      } else {
        otherGroup.style.display = 'none';
        otherInput.value = '';
        damageCenterData.location = select.value;
        damageCenterData.customLocation = '';
      }
    };
    
    window.updateOtherLocation = function() {
      const otherInput = document.getElementById('otherLocationInput');
      damageCenterData.customLocation = otherInput.value.trim();
    };
    
    function nextStep() {
      if (validateCurrentStep()) {
        if (currentStep < totalSteps) {
          // Save current step data
          saveCurrentStepData();
          
          // Move to next step
          currentStep++;
          showStep(currentStep);
          updateProgress();
          
          // Load module if needed
          loadStepModule(currentStep);
        } else {
          // Final step - complete damage center
          completeDamageCenter();
        }
      }
    }
    
    function previousStep() {
      if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
        updateProgress();
      }
    }
    
    function saveCurrentStep() {
      console.log('💾 Saving current step data to helper...');
      
      try {
        // Get current helper data
        let helper = {};
        try {
          helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        } catch (e) {
          console.warn('Failed to parse helper from sessionStorage, using empty object');
          helper = {};
        }
        
        // Initialize damage_centers structure if needed
        helper.damage_centers = helper.damage_centers || {
          centers: [],
          current_center_id: null,
          active_center_count: 0,
          totals: { all_centers_subtotal: 0, all_centers_vat: 0, all_centers_total: 0 }
        };
        
        // Save current step data based on which step we're on
        const stepData = {};
        
        switch(currentStep) {
          case 1:
            // Location and number
            const locationSelect = document.getElementById('locationSelect');
            const otherLocationInput = document.getElementById('otherLocationInput');
            stepData.location = locationSelect?.value;
            stepData.customLocation = otherLocationInput?.value;
            stepData.number = damageCenterData.number;
            break;
            
          case 2:
            // Description
            const description = document.getElementById('damageDescription');
            stepData.description = description?.value;
            break;
            
          case 3:
            // Work module - trigger actual save function in iframe
            try {
              const workIframe = document.getElementById('workModuleFrame');
              if (workIframe && workIframe.contentWindow && workIframe.contentWindow.saveWorkData) {
                workIframe.contentWindow.saveWorkData();
                stepData.work_saved = true;
                stepData.work_saved_at = new Date().toISOString();
              } else {
                console.warn('Work iframe or saveWorkData function not found');
                stepData.work_saved = false;
              }
            } catch (error) {
              console.error('Error saving work data from wizard:', error);
              stepData.work_saved = false;
            }
            stepData.stepName = 'work';
            break;
            
          case 5:
            // Parts required module - trigger actual save function in iframe
            try {
              const partsIframe = document.getElementById('partsModuleFrame');
              if (partsIframe && partsIframe.contentWindow && partsIframe.contentWindow.savePartsData) {
                partsIframe.contentWindow.savePartsData();
                stepData.parts_saved = true;
                stepData.parts_saved_at = new Date().toISOString();
              } else {
                console.warn('Parts iframe or savePartsData function not found');
                stepData.parts_saved = false;
              }
            } catch (error) {
              console.error('Error saving parts data from wizard:', error);
              stepData.parts_saved = false;
            }
            stepData.stepName = 'parts_required';
            break;
            
          case 6:
            // Repairs module - trigger actual save function in iframe
            try {
              const repairsIframe = document.getElementById('repairsModuleFrame');
              if (repairsIframe && repairsIframe.contentWindow && repairsIframe.contentWindow.saveRepairsData) {
                repairsIframe.contentWindow.saveRepairsData();
                stepData.repairs_saved = true;
                stepData.repairs_saved_at = new Date().toISOString();
              } else {
                console.warn('Repairs iframe or saveRepairsData function not found');
                stepData.repairs_saved = false;
              }
            } catch (error) {
              console.error('Error saving repairs data from wizard:', error);
              stepData.repairs_saved = false;
            }
            stepData.stepName = 'repairs';
            break;
            
          default:
            // Other steps or parts search
            stepData.currentStep = currentStep;
            stepData.stepName = ['', 'location', 'description', 'work', 'parts_search', 'parts_required', 'repairs'][currentStep];
            break;
        }
        
        // Update damage center data in helper
        if (!helper.damage_centers.current_center_id) {
          helper.damage_centers.current_center_id = damageCenterData.id || `center_${Date.now()}`;
        }
        
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        console.log('✅ Step data saved to helper:', stepData);
        
        // Show save confirmation
        const saveBtn = document.getElementById('saveBtn');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = '✅ נשמר';
        saveBtn.style.background = '#059669';
        
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.style.background = '#10b981';
        }, 2000);
        
        // Trigger helper update broadcast if available
        if (typeof window.broadcastHelperUpdate === 'function') {
          window.broadcastHelperUpdate(['damage_centers'], 'damage_center_wizard');
        }
        
      } catch (error) {
        console.error('❌ Failed to save step data to helper:', error);
        
        // Show error state
        const saveBtn = document.getElementById('saveBtn');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = '❌ שגיאה';
        saveBtn.style.background = '#dc2626';
        
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.style.background = '#10b981';
        }, 3000);
        
        alert('שגיאה בשמירת הנתונים');
      }
    }
    
    function showStep(step) {
      // Hide all steps
      document.querySelectorAll('.step').forEach(stepEl => {
        stepEl.classList.remove('active');
      });
      
      // Show current step
      document.getElementById(`step${step}`).classList.add('active');
      
      // Update navigation
      updateNavigation();
      
      // Update step info
      document.getElementById('stepInfo').textContent = `שלב ${step} מתוך ${totalSteps}`;
    }
    
    function updateNavigation() {
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      
      // Show/hide previous button
      prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
      
      // Update next button text
      if (currentStep === totalSteps) {
        nextBtn.textContent = 'סיים מוקד נזק';
        nextBtn.className = 'btn btn-success';
      } else {
        nextBtn.textContent = 'הבא';
        nextBtn.className = 'btn btn-primary';
      }
    }
    
    function updateProgress() {
      const progressFill = document.getElementById('progressFill');
      const percentage = (currentStep / totalSteps) * 100;
      progressFill.style.width = `${percentage}%`;
      
      // Update step info
      document.getElementById('stepInfo').textContent = `שלב ${currentStep} מתוך ${totalSteps}`;
      
      // Update navigation buttons
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      
      // Show/hide previous button
      if (currentStep === 1) {
        prevBtn.style.display = 'none';
      } else {
        prevBtn.style.display = 'inline-block';
      }
      
      // Update next button text for final step
      if (currentStep === totalSteps) {
        nextBtn.textContent = 'סיום ומעבר לסיכום אקספרטיזה';
        nextBtn.style.background = '#059669'; // Green for completion
      } else {
        nextBtn.textContent = 'הבא';
        nextBtn.style.background = '#3b82f6'; // Default blue
      }
    }
    
    function loadStepModule(step) {
      switch(step) {
        case 3:
          loadWorkModule();
          break;
        case 4:
          loadPartsSearchModule();
          break;
        case 5:
          loadPartsModule();
          break;
        case 6:
          loadRepairsModule();
          break;
        case 7:
          updateSummary();
          break;
      }
    }
    
    function loadPartsSearchModule() {
      const moduleContainer = document.getElementById('partsSearchModule');
      
      // Use existing parts search module
      moduleContainer.innerHTML = `<iframe src="parts search.html" style="width:100%; height:600px; border:none; border-radius:10px;" id="partsSearchModuleFrame"></iframe>`;
      moduleContainer.classList.add('loaded');
      
      // Show search results info
      document.getElementById('searchResultsInfo').style.display = 'block';
      
      // Set up communication with parts search module
      setupModuleCommunication('partsSearch');
    }
    
    function validateCurrentStep() {
      switch(currentStep) {
        case 1:
          const locationSelect = document.getElementById('locationSelect');
          const otherLocationInput = document.getElementById('otherLocationInput');
          
          if (!locationSelect.value) {
            alert('אנא בחר מיקום נזק');
            return false;
          }
          
          if (locationSelect.value === 'other' && !otherLocationInput.value.trim()) {
            alert('אנא הזן מיקום נזק מותאם אישית');
            return false;
          }
          break;
        case 2:
          const description = document.getElementById('damageDescription').value.trim();
          if (!description) {
            alert('אנא הזן תיאור נזק');
            return false;
          }
          break;
      }
      return true;
    }
    
    function saveCurrentStepData() {
      console.log('💾 Saving step data for step:', currentStep);
      
      // Get current helper data
      let helper = {};
      try {
        helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
      } catch (e) {
        helper = {};
      }
      
      // No need for wizard temporary data - using simple damage_blocks structure
      
      switch(currentStep) {
        case 1:
          // Save location data
          const locationSelect = document.getElementById('locationSelect');
          const otherLocationInput = document.getElementById('otherLocationInput');
          const location = locationSelect?.value === 'אחר' ? otherLocationInput?.value : locationSelect?.value;
          
          // Location saved directly to moduleData
          moduleData.location = location;
          damageCenterData.location = location;
          console.log('✅ Location saved:', location);
          break;
          
        case 2:
          // Save description
          const description = document.getElementById('damageDescription')?.value?.trim();
          // Description saved directly to moduleData
          moduleData.description = description;
          damageCenterData.description = description;
          console.log('✅ Description saved:', description);
          break;
          
        case 3:
          // Work data is handled by work.html module
          console.log('✅ Work step - data handled by work module');
          break;
          
        case 4:
          // Parts search data is handled by parts search module
          console.log('✅ Parts search step - data handled by parts search module');
          break;
          
        case 5:
          // Parts required data is handled by parts-required.html module
          console.log('✅ Parts required step - data handled by parts required module');
          break;
          
        case 6:
          // Repairs data is handled by repairs-required.html module
          console.log('✅ Repairs step - data handled by repairs module');
          break;
      }
      
      // Update helper meta info only
      sessionStorage.setItem('helper', JSON.stringify(helper));
    }
    
    function loadWorkModule() {
      const moduleContainer = document.getElementById('workModule');
      
      // Load work module with cache busting to prevent browser cache issues
      const timestamp = new Date().getTime();
      moduleContainer.innerHTML = `<iframe src="work.html?v=${timestamp}" style="width:100%; height:600px; border:none; border-radius:10px;" id="workModuleFrame" onload="console.log('✅ Work module iframe loaded successfully');" onerror="console.error('❌ Work module iframe failed to load');"></iframe>`;
      moduleContainer.classList.add('loaded');
      
      // Show subtotal
      document.getElementById('workSubtotal').style.display = 'block';
      
      // Set up communication with work module
      setupModuleCommunication('work');
    }
    
    function loadPartsModule() {
      const moduleContainer = document.getElementById('partsModule');
      
      // Use existing parts-required.html module
      moduleContainer.innerHTML = `<iframe src="parts-required.html" style="width:100%; height:600px; border:none; border-radius:10px;" id="partsModuleFrame"></iframe>`;
      moduleContainer.classList.add('loaded');
      
      // Show subtotal
      document.getElementById('partsSubtotal').style.display = 'block';
      
      // Set up communication with parts module
      setupModuleCommunication('parts');
    }
    
    function loadRepairsModule() {
      const moduleContainer = document.getElementById('repairsModule');
      
      // Use existing repairs-required.html module
      moduleContainer.innerHTML = `<iframe src="repairs-required.html" style="width:100%; height:600px; border:none; border-radius:10px;" id="repairsModuleFrame"></iframe>`;
      moduleContainer.classList.add('loaded');
      
      // Show subtotal
      document.getElementById('repairsSubtotal').style.display = 'block';
      
      // Set up communication with repairs module
      setupModuleCommunication('repairs');
    }
    
    function updateSummary() {
      document.getElementById('summaryNumber').textContent = damageCenterData.number;
      
      // Display location (either selected or custom)
      let locationText = damageCenterData.location;
      if (damageCenterData.location === 'other' && damageCenterData.customLocation) {
        locationText = damageCenterData.customLocation;
      }
      document.getElementById('summaryLocation').textContent = locationText;
      
      document.getElementById('summaryDescription').textContent = damageCenterData.description;
      
      // Calculate totals
      calculateTotals();
    }
    
    function calculateTotals() {
      // Get actual totals from module data
      const workTotal = moduleData.works.reduce((sum, work) => sum + (parseFloat(work.cost) || 0), 0);
      const partsTotal = moduleData.parts.reduce((sum, part) => sum + (parseFloat(part.price) || 0), 0);
      const repairsTotal = moduleData.repairs.reduce((sum, repair) => sum + (parseFloat(repair.cost) || 0), 0);
      
      const subtotal = workTotal + partsTotal + repairsTotal;
      const vatAmount = subtotal * (vatPercentage / 100);
      const totalWithVat = subtotal + vatAmount;
      
      // Update display
      document.getElementById('totalAmount').textContent = `₪${subtotal.toLocaleString()}`;
      document.getElementById('totalWithoutVat').textContent = `₪${subtotal.toLocaleString()}`;
      document.getElementById('totalWithVat').textContent = `₪${totalWithVat.toLocaleString()}`;
      
      // Update individual subtotals in wizard
      updateModuleSubtotals(workTotal, partsTotal, repairsTotal);
      
      // Save to damage center data
      damageCenterData.workTotal = workTotal;
      damageCenterData.partsTotal = partsTotal;
      damageCenterData.repairsTotal = repairsTotal;
      damageCenterData.subtotal = subtotal;
      damageCenterData.vatAmount = vatAmount;
      damageCenterData.totalWithVat = totalWithVat;
      
      console.log('🧮 Calculated totals:', { workTotal, partsTotal, repairsTotal, subtotal, totalWithVat });
    }
    
    function updateModuleSubtotals(workTotal, partsTotal, repairsTotal) {
      // Update work subtotal display
      const workSubtotal = document.getElementById('workSubtotal');
      if (workSubtotal) {
        const workAmount = document.getElementById('workAmount');
        const workAmountWithVat = document.getElementById('workAmountWithVat');
        if (workAmount) workAmount.textContent = `₪${workTotal.toLocaleString()}`;
        if (workAmountWithVat) workAmountWithVat.textContent = `₪${(workTotal * 1.17).toLocaleString()}`;
        workSubtotal.style.display = workTotal > 0 ? 'block' : 'none';
      }
      
      // Update parts subtotal display  
      const partsSubtotal = document.getElementById('partsSubtotal');
      if (partsSubtotal) {
        const partsAmount = document.getElementById('partsAmount');
        const partsAmountWithVat = document.getElementById('partsAmountWithVat');
        if (partsAmount) partsAmount.textContent = `₪${partsTotal.toLocaleString()}`;
        if (partsAmountWithVat) partsAmountWithVat.textContent = `₪${(partsTotal * 1.17).toLocaleString()}`;
        partsSubtotal.style.display = partsTotal > 0 ? 'block' : 'none';
      }
      
      // Update repairs subtotal display
      const repairsSubtotal = document.getElementById('repairsSubtotal');
      if (repairsSubtotal) {
        const repairsAmount = document.getElementById('repairsAmount');
        const repairsAmountWithVat = document.getElementById('repairsAmountWithVat');
        if (repairsAmount) repairsAmount.textContent = `₪${repairsTotal.toLocaleString()}`;
        if (repairsAmountWithVat) repairsAmountWithVat.textContent = `₪${(repairsTotal * 1.17).toLocaleString()}`;
        repairsSubtotal.style.display = repairsTotal > 0 ? 'block' : 'none';
      }
    }
    
    function completeDamageCenter() {
      // Save damage center to helper
      saveDamageCenterToHelper();
      
      // Show completion message and navigate to expertise summary
      alert('מוקד הנזק נוצר ונשמר בהצלחה!');
      
      // Navigate to expertise summary as the next step in the workflow
      window.location.href = "expertise-summary.html";
    }
    
    function saveDamageCenterToHelper() {
      console.log('💾 Creating organized damage center structure...');
      
      try {
        // Get current helper data
        let helper = {};
        try {
          helper = JSON.parse(sessionStorage.getItem('helper') || '{}');
        } catch (e) {
          console.warn('Failed to parse helper from sessionStorage, using empty object');
          helper = {};
        }
        
        // Initialize simple damage centers structure (your original concept)
        if (!helper.damage_blocks) {
          helper.damage_blocks = [];
        }
        
        // Get damage center data
        const location = moduleData.location || 'מיקום לא צוין';
        const description = moduleData.description || 'תיאור לא צוין';
        
        // Get actual data from modules
        const workData = moduleData.works.length > 0 ? moduleData.works : (helper.damage_assessment?.works?.work_items || []);
        const partsData = moduleData.parts.length > 0 ? moduleData.parts : (helper.damage_assessment?.parts?.parts_items || []);
        const repairsData = moduleData.repairs.length > 0 ? moduleData.repairs : (helper.damage_assessment?.repairs?.repairs_items || []);
        
        // Calculate totals
        const workTotal = workData.reduce((sum, item) => sum + (parseFloat(item.cost) || 0), 0);
        const partsTotal = partsData.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0);
        const repairsTotal = repairsData.reduce((sum, item) => sum + (parseFloat(item.cost) || 0), 0);
        const total = workTotal + partsTotal + repairsTotal;
        
        // Create simple damage center block (your original concept)
        const damageBlock = {
          "damage center number": helper.damage_blocks.length + 1,
          "damage center description": description,
          "location": location,
          "works needed": {},
          "parts needed": {},
          "repairs needed": {},
          "total cost": total
        };
        
        // Add works with costs and comments
        workData.forEach(work => {
          damageBlock["works needed"][work.category] = {
            "cost": parseFloat(work.cost) || 0,
            "comments": work.comments || ""
          };
        });
        
        // Add parts with full search result data
        partsData.forEach(part => {
          damageBlock["parts needed"][part.part || part.name] = {
            "description": part.desc || part.description || "",
            "cost": parseFloat(part.price) || 0,
            "source": part.source || "",
            "supplier": part.supplier || "",
            "location": part.location || "",
            "availability": part.availability || "",
            "part_number": part.part_number || "",
            "brand": part.brand || "",
            "condition": part.condition || ""
          };
        });
        
        // Add repairs with costs
        repairsData.forEach(repair => {
          damageBlock["repairs needed"][repair.name] = {
            "description": repair.description || "",
            "cost": parseFloat(repair.cost) || 0,
            "priority": repair.priority || "רגיל"
          };
        });
        
        // Add to damage blocks array
        helper.damage_blocks.push(damageBlock);
        
        // Create simple damage summary (your original concept)
        helper.damage_summary = helper.damage_blocks.map(block => ({
          "label": block.location,
          "total": block["total cost"]
        }));
        
        // Calculate total damage cost
        helper.damage_total = helper.damage_blocks.reduce((sum, block) => sum + block["total cost"], 0);
        
        // Update meta
        helper.meta = helper.meta || {};
        helper.meta.last_updated = new Date().toISOString();
        helper.meta.damage_centers_count = helper.damage_blocks.length;
        
        // Save to session storage
        sessionStorage.setItem('helper', JSON.stringify(helper));
        
        console.log('✅ Simple damage center saved:', damageBlock);
        console.log('✅ Total damage centers:', helper.damage_blocks.length);
        console.log('✅ Total damage cost:', helper.damage_total);
        
        // Clear current damage assessment data for next center
        if (helper.damage_assessment) {
          helper.damage_assessment.works = {};
          helper.damage_assessment.parts = {};
          helper.damage_assessment.repairs = {};
          sessionStorage.setItem('helper', JSON.stringify(helper));
        }
        
      } catch (error) {
        console.error('❌ Failed to save organized damage center to helper:', error);
        alert('שגיאה בשמירת מוקד הנזק');
      }
    }
    
    function getDamageCentersFromHelper() {
      if (typeof window.helper !== 'undefined' && window.helper.damage_centers) {
        return window.helper.damage_centers;
      }
      return [];
    }
    
    function resetWizard() {
      currentStep = 1;
      damageCenterData = {};
      
      showStep(1);
      updateProgress();
      generateDamageCenterNumber();
      
      // Clear form fields
      document.getElementById('damageDescription').value = '';
      document.querySelectorAll('.location-card').forEach(card => {
        card.classList.remove('selected');
      });
    }
    
    // Set up communication with embedded modules
    function setupModuleCommunication(moduleType) {
      console.log(`🔗 Setting up communication with ${moduleType} module`);
      
      // Wait for iframe to load then send damage center ID
      setTimeout(() => {
        const iframe = document.getElementById(`${moduleType}ModuleFrame`);
        if (iframe && iframe.contentWindow) {
          const currentCenterId = damageCenterData.id || window.helper?.damage_centers?.current_center_id;
          
          // Send damage center context to the module
          iframe.contentWindow.postMessage({
            type: 'damageCenterContext',
            damageCenterId: currentCenterId,
            damageCenter: damageCenterData,
            moduleType: moduleType
          }, '*');
          
          console.log(`📤 Sent damage center context to ${moduleType} module:`, currentCenterId);
        }
      }, 1000);
    }
    
    // Communication with embedded modules
    window.addEventListener('message', function(event) {
      console.log('📨 Received message from module:', event.data);
      
      switch(event.data.type) {
        case 'moduleUpdate':
          handleModuleUpdate(event.data);
          break;
        case 'moduleReady':
          handleModuleReady(event.data);
          break;
        case 'dataUpdate':
          handleDataUpdate(event.data);
          break;
      }
    });
    
    function handleModuleReady(data) {
      console.log(`✅ Module ${data.module} is ready`);
      
      // Send current damage center data to the module
      const currentCenterId = damageCenterData.id || window.helper?.damage_centers?.current_center_id;
      const iframe = document.getElementById(`${data.module}ModuleFrame`);
      
      if (iframe && iframe.contentWindow) {
        iframe.contentWindow.postMessage({
          type: 'damageCenterData',
          damageCenterId: currentCenterId,
          damageCenter: damageCenterData
        }, '*');
      }
    }
    
    function handleModuleUpdate(data) {
      console.log(`🔄 Updating ${data.module} subtotal:`, data.total);
      
      switch(data.module) {
        case 'work':
          updateWorkSubtotal(data.total);
          // Save work items to damage center
          if (data.items && currentDamageCenterId) {
            data.items.forEach(item => {
              window.addWorkToDamageCenter(currentDamageCenterId, item);
            });
          }
          break;
        case 'parts':
          updatePartsSubtotal(data.total);
          // Save parts items to damage center
          if (data.items && currentDamageCenterId) {
            data.items.forEach(item => {
              window.addPartToDamageCenter(currentDamageCenterId, item);
            });
          }
          break;
        case 'repairs':
          updateRepairsSubtotal(data.total);
          // Save repair items to damage center
          if (data.items && currentDamageCenterId) {
            data.items.forEach(item => {
              window.addRepairToDamageCenter(currentDamageCenterId, item);
            });
          }
          break;
      }
      
      // Recalculate damage center totals
      if (typeof window.calculateDamageCenterTotals === 'function' && currentDamageCenterId) {
        window.calculateDamageCenterTotals(currentDamageCenterId);
      }
    }
    
    function handleDataUpdate(data) {
      console.log(`💾 Saving ${data.module} data:`, data);
      
      // Update damage center data based on module updates
      if (data.damageCenterId && data.items) {
        const center = window.getDamageCenter(data.damageCenterId);
        if (center) {
          switch(data.module) {
            case 'work':
              center.work_items = data.items;
              break;
            case 'parts':
              center.parts_items = data.items;
              break;
            case 'repairs':
              center.repairs_items = data.items;
              break;
          }
          
          // Recalculate totals
          window.calculateDamageCenterTotals(data.damageCenterId);
        }
      }
    }
    
    function updateWorkSubtotal(total) {
      const vatAmount = total * (vatPercentage / 100);
      document.getElementById('workAmount').textContent = `₪${total.toLocaleString()}`;
      document.getElementById('workAmountWithVat').textContent = `₪${(total + vatAmount).toLocaleString()}`;
    }
    
    function updatePartsSubtotal(total) {
      const vatAmount = total * (vatPercentage / 100);
      document.getElementById('partsAmount').textContent = `₪${total.toLocaleString()}`;
      document.getElementById('partsAmountWithVat').textContent = `₪${(total + vatAmount).toLocaleString()}`;
    }
    
    function updateRepairsSubtotal(total) {
      const vatAmount = total * (vatPercentage / 100);
      document.getElementById('repairsAmount').textContent = `₪${total.toLocaleString()}`;
      document.getElementById('repairsAmountWithVat').textContent = `₪${(total + vatAmount).toLocaleString()}`;
    }
  </script>
</body>
</html>